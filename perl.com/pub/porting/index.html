<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" id="sixapart-standard">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="generator" content="Movable Type Pro 5.02" />
<link rel="stylesheet" href="/pub/styles.css" type="text/css" />
<link rel="start" href="/pub/" title="Home" />
<link rel="alternate" type="application/atom+xml" title="Recent Entries" href="/pub/atom.xml" />
<script type="text/javascript" src="/pub/mt.js"></script>

<script type="text/javascript">

 var _gaq = _gaq || [];
 _gaq.push(['_setAccount', 'UA-50555-22']);
 _gaq.push(['_trackPageview']);

 (function() {
   var ga = document.createElement('script'); ga.type =
   'text/javascript'; ga.async = true;
   ga.src = ('https:' == document.location.protocol ? 'https://ssl' :
   'http://www') + '.google-analytics.com/ga.js';
   var s = document.getElementsByTagName('script')[0];
   s.parentNode.insertBefore(ga, s);
 })();

</script>
    <title>Perl.com: Porting Archives</title>


</head>
<body id="perl-com" class="mt-archive-listing mt-category-archive layout-wt">
    <div id="container">
        <div id="container-inner">


            <div id="header">
    <div id="header-inner">
        <div id="header-content">
        <div id="top_advert"> 
<!-- Put any landscape advert in here -->
<a href="http://www.perlfoundation.org/" target="_new">
<img src="/i/tpf_banner.png" width="468" height="60" /></a>
        </div> 



            <div id="header-name"><a href="/pub/" accesskey="1">Perl.com</a></div>
            <div id="header-description"></div>




        </div>
    </div>
</div>



            <div id="content">
                <div id="content-inner">


                    <div id="alpha">
                        <div id="alpha-inner">

                            
                            <h1 id="page-title" class="archive-title">Recently in <em>Porting</em> Category</h1>






                            
                            <div id="entry-802" class="entry-asset asset hentry">
    <div class="asset-header">
        <h2 class="asset-name entry-title"><a href="/pub/2005/07/test-builder-p6.html" rel="bookmark">Porting Test::Builder to Perl 6</a></h2>
        <div class="asset-meta">
            <span class="byline">
    
                By <span class="vcard author">chromatic</span> on <abbr class="published" title="2005-07-28T00:00:00-08:00">July 28, 2005 12:00 AM</abbr>
    
            </span>

            
            

        </div>
    </div>
    <div class="asset-content entry-content">

        <div class="asset-body">
            
<!-- sidebar begins -->
<!-- don't move sidebars-->
<!-- sidebar ends -->
<br clear="all" />
<p>Perl 6 development now proceeds in two directions. The first is from the
bottom up, with the creation and evolution of <a
href="http://www.parrotcode.org/">Parrot</a> and underlying code, including
the Parrot Grammar Engine. The goal there is to build the structure Perl 6
will need. The second direction is from the top down, with the <a
href="http://www.pugscode.org/">Pugs</a> project implementing Perl 6 initially
separate from Parrot, though recent additions allow an embedded Parrot to run
the parsed code and to emit valid Parrot PIR code.</p>

<p>Both projects are important and both help the design of Perl 6 and its
implementation. Parrot is valuable in that it demonstrates a solid
foundation for Perl 6 (and other similar languages); a far better
foundation than the internals of Perl 5 have become. Pugs is important
because it allows people to use Perl 6 productively now, with more features
every day.</p>

<!-- sidebar begins -->
 <csperl file="grab" domain="on" record="b/1796" template="b/article_sidebar.view">
<!-- sidebar ends -->

<h3>Motivation and Design</h3>

<p>Perl culture values testing very highly. Several years ago, at the
suggestion of Michael Schwern, I extracted the code that would become <a
href="http://search.cpan.org/perldoc/Test::Builder">Test::Builder</a> from <a
href="http://search.cpan.org/perldoc/Test::More">Test::More</a> and unified <a
href="http://search.cpan.org/perldoc/Test::Simple">Test::Simple</a> and
Test::More to share that back end. Now dozens of other testing modules, built upon Test::Builder, work
together seamlessly.</p>

<p>Pugs culture also values testing. However, there was no corresponding
Test::Builder for Perl 6 yet--there was only a single <a
href="http://svn.openfoundry.org/pugs/ext/Test/lib/Test.pm"><i>Test.pm</i></a> module
that did most of what the early version of Test::More did in Perl 5.</p>

<p>Schwern and I have discussed updates and refactorings of Test::Builder
for the past couple of years. We made some mistakes in the initial design.
As Perl 6 offers the chance to clean up Perl 5, so does a port of
Test::Builder to Perl 6 offer the chance to clean up some of the design
decisions we would make differently now.</p>

<p>Internally, Test::Builder provides a few testing and reporting functions
and keeps track of some test information. Most importantly, it contains a plan
consisting of the number of tests expected to run. It also holds a list of
details of every test it has seen. The testing and reporting functions add
information to this list of test details. Finally, the module contains
functions to report the test details in the standard <a
href="http://search.cpan.org/dist/Test-Harness/lib/Test/Harness/TAP.pod">TAP</a> format, so
that tools such as <a
href="http://search.cpan.org/perldoc/Test::Harness">Test::Harness</a> can
interpret the results correctly.</p>

<p>Test::Builder needs to do all of these things, but there are several
ways to design the module's internals. Some ways are better than
others.</p>

<p>The original Perl 5 version mashed all of this behavior together into
one object-oriented module. To allow the use of multiple testing modules
without confusing the count or the test details,
<code>Test::Builder::new()</code> always returns a singleton. All test
modules call the constructor to receive the singleton object and call the
test reporting methods to add details of the tests they handle.</p>

<p>This works, but it's a little inelegant. In particular, modules that test
test modules have to go to a lot of trouble to work around the design.  A more
flexible design would make things like <a
href="http://search.cpan.org/perldoc/Test::Builder::Tester">Test::Builder::Tester</a>
much easier to write.</p>

<p>The biggest change that Schwern and I have discussed is to separate the
varying responsibilities into separate modules. The <a
href="http://svn.openfoundry.org/pugs/ext/Test-Builder/lib/Test/Builder.pm">new
Test::Builder object in Perl 6</a> itself contains a <a
href="http://svn.openfoundry.org/pugs/ext/Test-Builder/lib/Test/Builder/TestPlan.pm">Test::Builder::TestPlan</a>
object that represents the plan (the number of tests to run), a <a
href="http://svn.openfoundry.org/pugs/ext/Test-Builder/lib/Test/Builder/Output.pm">Test::Builder::Output</a>
object that contains the filehandles to which to write TAP and diagnostic
output, and an array of tests' results (all <a
href="http://svn.openfoundry.org/pugs/ext/Test-Builder/lib/Test/Builder/Test.pm">Test::Builder::Test</a>
instances).</p>

<p>The default constructor, <code>new()</code>, still returns a singleton
by default. However, modules that use Test::Builder can create their own
objects, which perform the Test::Builder::TestPlan or Test::Builder::Output
roles and pass them to the constructor to override the default objects
created internally for the singleton. If a test module really needs a
separate Test::Builder object, the alternate <code>create()</code> method
creates a new object that no other module will share.</p>

<p>This strategy allows the Perl 6 version of <a
href="http://svn.openfoundry.org/pugs/ext/Test-Builder/lib/Test/Builder/Tester.pm">Test::Builder::Tester</a>
to create its own Test::Builder object that reports tests as normal and then
creates the shared singleton with output going to filehandles it can read
instead of <code>STDOUT</code> and <code>STDERR</code>.  The design appears to be sound; it took less
than two hours to go from the idea of T::B::T to a fully working
implementation--counting a break to eat ice cream.</p>

<h3>First Attempts</h3>

<p>Translating Perl 5 OO code into Perl 6 OO code was mostly straightforward,
despite my never having written any runnable Perl 6 OO code. (Also, Pugs
was not far enough along that objects worked.)</p>

<h4>What Went Right</h4>

<p>One nice revelation is that opaque objects are actually easier to work
with than blessed references. Even better, Perl 6's improved function
signatures reduce the necessity to write lots of boring boilerplate
code.</p>

<p>Breaking Test::Builder into separate pieces gave the opportunity for
several other refactorings. One of my favorite is &quot;Replace Condititional with
Polymorphism&quot;. There are four different types of tests that have different
reporting styles: <code>pass</code>, <code>fail</code>, <code>SKIP</code>, and <code>TODO</code>. It made sense to create separate
classes for each of those, giving each the responsibility and knowledge to
produce the correct TAP output. Thus I wrote Test::Builder::Test, a
fa&ccedil;ade factory class with a very smart constructor that creates and
returns the correct test object based on the given arguments. When
Test::Builder receives one of these test objects, it asks it to return the TAP
string, passes that message to its contained Test::Builder::TestOutput object,
and stores the test object in the list of run tests.</p>
<div align="center">
<a href="http://conferences.oreillynet.com/os2005/"><img src="http://conferences.oreillynet.com/images/os2005/banners/468x60.gif" width="468" height="60" hspace="10" vspace="10" border="0" alt="O'Reilly Open Source Convention 2005." /></a>
</div>












<h4>What Went Wrong</h4>

<p>Writing the base for all (or at least many) possible test modules is
tricky. In this case, it was trebly so. Not only was this the first bit of
practical OO Perl 6 code I'd written, but I had no way to test it, either
by hand (how I tested the Perl 5 version, before Schwern and I worked out a
way to write automated tests for it), or with automated tests. Pugs didn't
even have object support when I wrote this, though checking in this code
pushed OO support higher on the schedule.</p>

<h5>Infinite Loops in Construction</h5>

<p>Originally, I thought all test classes would inherit from
Test::Builder::Test. As Damian Conway pointed out, my technique created an
infinite loop. (He suggested that &quot;Don't make a fa&ccedil;ade factory class an
ancestor of the instantiable classes&quot; is a design mistake akin to &quot;Don't get
involved in a land war in Asia&quot; and mumbled something else about battles of
wits and Sicilians.) The code looked something like:</p>

<pre><code>  class Test::Builder::Test
  {
      my Test::Builder::Test $:singleton is rw;

      has Bool $.passed;
      has Int  $.number;
      has Str  $.diagnostic;
      has Str  $.description;

      method new (Test::Builder::Test $class, *@args)
      {
          return $:singleton if $:singleton;
          $:singleton = $class.create( @args );
          return $:singleton;
      }

      method create(
          $number, 
          $passed       =  1,
          ?$skip        =  0,
          ?$todo        =  0,
          ?$reason      = '',
          ?$description = '',
      )
      {
          return Test::Builder::Test::TODO.new(
              description =&gt; $description, reason =&gt; $reason, passed =&gt; $passed,
          ) if $todo;

          return Test::Builder::Test::Skip.new(
              description =&gt; $description, reason =&gt; $reason, passed =&gt; 1,
          ) if $skip;

          return Test::Builder::Test::Pass.new(
              description =&gt; $description, passed =&gt; 1,
          ) if $passed;

          return Test::Builder::Test::TODO.new(
              description =&gt; $description, passed =&gt; 0,
          ) if $todo;
      }
  }

  class Test::Builder::Test::Pass is Test::Builder::Test {}
  class Test::Builder::Test::Fail is Test::Builder::Test {}
  class Test::Builder::Test::Skip is Test::Builder::Test { ... }
  class Test::Builder::Test::TODO is Test::Builder::Test { ... }

  # ...</code></pre>

<p>Why is this a singleton? I have no idea; I typed that code into the
<em>wrong</em> module and continued writing code a few minutes later, thinking
that I knew what I was doing. The infinite loop stands out in my mind very
clearly now. Because all of the concrete test classes inherit from
Test::Builder::Test, they inherit its <code>new()</code> method; none of them
override it. Thus, they'll all call <code>create()</code> again (and none of
them override <em>that</em> either).</p>

<h5>Confusing Initialization</h5>

<p>I also struggled with the various bits and pieces of creating and
building objects in Perl 6. There are a lot of hooks and overrides
available, making the object system very flexible. However, without any
experience or examples or guidance, choosing between <code>new()</code>,
<code>BUILD()</code>, and <code>BUILDALL()</code> is difficult.</p>

<p>I realized I had no idea how to handle the singleton in Test::Builder.
At least, when I realized that (for now) Test::Builder could remain a
singleton, I didn't know how or where to create it.</p>

<p>I finally settled on putting it in <code>new()</code>, with code much
like that in the broken version of Test::Builder::Test previously.
<code>new()</code> eventually allocates space for, creates, and returns an
opaque object. <code>BUILD()</code> initializes it. This led me to write
code something like:</p>

<pre><code>  class Test::Builder;

  # ...

  has Test::Builder::Output   $.output;
  has Test::Builder::TestPlan $.plan;

  has @:results;

  submethod BUILD ( Test::Builder::Output ?$output, ?$TestPlan )
  {
      $.plan   = $TestPlan if $TestPlan;
      $.output = $output ?? $output :: Test::Builder::Output.new();
  }</code></pre>
<p>There's a difference here because most uses of Test::Builder set the
test plan explicitly later, after receiving the Test::Builder object. I
added a <code>plan()</code> method, too:</p>

<pre><code>  method plan ( $self:, Str ?$explanation, Int ?$num )
  {
      die &quot;Plan already set!&quot; if $self.plan;

      if ($num)
      {
          $self.plan = Test::Builder::TestPlan.new( expect =&gt; $num );
      }
      elsif $explanation ~~ 'no_plan'
      {
          $self.plan = Test::Builder::NullPlan.new();
      }
      else
      {
          die &quot;Unknown plan&quot;;
      }

      $self.output.write( $self.plan.header() );
  }</code></pre>
<p>There are some stylistic errors in the previous code. First, when
declaring an invocant, there's a colon but no comma. Second,
<code>fail</code> is much better than <code>die</code> (an assertion Damian
made that I take on faith, having researched more serious issues instead).
Third, the parenthesization of the cases in the <code>if</code> statement
is inconsistent.</p>













<h3>Final (Ha!) Version</h3>

<p>Shortly after I checked in the example code, Stevan Little began work on a
test suite (using <em>Test.pm</em>). I knew that Pugs didn't support many of
the necessary language constructs, but this allowed Pugs hackers to identify
necessary features and me to identify legitimate bugs and mistakes in the
code. (It's tricky to bootstrap test-driven development.)</p>

<p>After filling out the test suite, fixing all of the known bugs in my code,
talking other Pugs hackers into adding features I needed, and implementing
those I couldn't pawn off on others, Test::Builder works completely in Pugs
right now.  There is one remaining nice feature: splatty args in method calls.
But I'm ready to port <em>Test.pm</em> to the new back end and then write many,
many more useful testing modules--starting with a port of Mark Fowler's
Test::Builder::Tester written the night before this article went public!</p>

<p>The singleton creation in <code>Test::Builder</code> now looks like:</p>

<pre><code>  class Test::Builder-0.2.0;
  
  use Test::Builder::Test;
  use Test::Builder::Output;
  use Test::Builder::TestPlan;
  
  my  Test::Builder           $:singleton;
  has Test::Builder::Output   $.output handles 'diag';
  has Test::Builder::TestPlan $.testplan;
  has                         @:results;
  
  method new ( Test::Builder $Class: ?$plan, ?$output )
  {
      return $:singleton //= $Class.SUPER::new(
          testplan =&gt; $plan, output =&gt; $output
      );
  }
  
  method create ( Test::Builder $Class: ?$plan, ?$output )
  {
      return $Class.new( testplan =&gt; $plan, output =&gt; $output );
  }
  
  submethod BUILD
  (
      Test::Builder::TestPlan ?$.testplan,
      Test::Builder::Output   ?$.output = Test::Builder::Output.new()
  )
  {}</code></pre>
<p>Those test modules that want to use the default <code>$Test</code>
object directly can call <code>Test::Builder::new()</code> to return the
singleton, creating it if necessary. Test modules that need different
output or plan objects should call <code>Test::Builder::create()</code>.
(The test suite actually does this.)</p>

<p>Having removed the <code>Test::Builder</code> code from
<code>Test::Builder::Test</code>, I revised the latter, as well:</p>

<pre><code>  class Test::Builder::Test-0.2.0
  {
      method new (
          $number,     
          ?$passed      = 1,
          ?$skip        = 0,
          ?$todo        = 0,
          ?$reason      = '', 
          ?$description = '',
      )
      {
          return ::Test::Builder::Test::TODO.new(
              description =&gt; $description, passed =&gt; $passed, reason =&gt; $reason
          ) if $todo;

          return ::Test::Builder::Test::Skip.new(
              description =&gt; $description, passed =&gt;       1, reason =&gt; $reason
          ) if $skip;

          return ::Test::Builder::Test::Pass.new(
              description =&gt; $description, passed =&gt;       1,
          ) if $passed;

          return ::Test::Builder::Test::Fail.new(
              description =&gt; $description, passed =&gt;       0,
          );
      }
  }</code></pre>
<p>That's it. I moved the object attributes into roles.
<code>Test::Builder::Test::Base</code> is the basis for all tests,
encapsulating all of the attributes that tests share and providing the
important methods:</p>

<pre><code>  role Test::Builder::Test::Base
  {
      has Bool $.passed;
      has Int  $.number;
      has Str  $.diagnostic;
      has Str  $.description;

      submethod BUILD (
          $.description,
          $.passed,
          ?$.number     =     0,
          ?$.diagnostic = '???',
      ) {}

      method status returns Hash
      {
          return
          {
              passed      =&gt; $.passed,
              description =&gt; $.description,
          };
      }

      method report returns Str
      {
          my $ok          = $.passed ?? 'ok' :: 'not ok';
          my $description = &quot;- $.description&quot;;
          return join( ' ', $ok, $.number, $description );
      }

  }

  class Test::Builder::Test::Pass does Test::Builder::Test::Base {}
  class Test::Builder::Test::Fail does Test::Builder::Test::Base {}</code></pre>
<p><code>Test::Builder::Test::WithReason</code> forms the basis for <code>TODO</code>
and <code>SKIP</code> tests, adding the reason why the developer marked the test as
either:</p>


<pre><code>  role Test::Builder::Test::WithReason does Test::Builder::Test::Base
  {
      has Str $.reason;

      submethod BUILD ( $.reason ) {}

      method status returns Hash ( $self: )
      {
          my $status        = $self.SUPER::status();
          $status{&quot;reason&quot;} = $.reason;
          return $status;
      }
  }

  class Test::Builder::Test::Skip does Test::Builder::Test::WithReason { ... }
  class Test::Builder::Test::TODO does Test::Builder::Test::WithReason { ... }</code></pre>


<h4>What's Hard</h4>

<p>The two greatest difficulties I encountered in this porting effort were
in mapping my design to the new Perl 6 way of thinking and in working
around Pugs bugs and unsupported features. The former is interesting; it
may suggest places where other people will run into difficulties.</p>

<p>One of the trickiest parts of Perl 6's OO model to understand is the
interaction of the <code>new()</code>, <code>BUILD()</code>, and
<code>BUILDALL()</code> methods. Perl 5 provides very little in the way of
object support beyond <code>bless</code>. Though having finer-grained
control over object creation, initialization, and initializer dispatch will
be very useful, remembering the purposes of each method is very important,
lest you override the wrong one and end up with an infinite loop or
partially initialized object.</p>

<p>From rereading the design documents, experimenting, picking the brains
of other @Larry members, and thinking hard, my rules are:</p>

<ul>

<li><p>Leave <code>new()</code> alone.</p>

<p>This method creates the opaque object. Override it when you don't want
to return a new object of this class every time. Don't do initialization
here. Don't forget to call <code>SUPER::new()</code> if you actually want
an object.</p></li>

<li><p>Override <code>BUILD()</code> to add initialize attributes for objects
of <em>this</em> class.</p>

<p>Think of this as an initializer, not a constructor.</p></li>

<li><p>Override <code>BUILDALL()</code> when you want to change the order of
initialization.</p>

<p>I haven't needed this yet and don't expect to.</p></li>

</ul>

<p>Pugs-wise, find a good Haskell tutorial, find a really fast machine that
can run GHC 6.4, and look for lambdacamel mentors on <i>#pugs</i>. (My productivity
increased when Autrijus told me about Haskell's <code>trace</code> function.
He called it a refreshing desert in the oasis of referential
transparency.)</p>

<h4>What's Easy</h4>

<p>Was this exercise valuable? Absolutely! It reinforced my belief that
Perl 6 is not only Perlish, but that it's a fantastic revolution of Perl 5
in several ways:</p>

<ul>

<li>The object system is much better. Attributes and accessors require
almost no syntax, and that only in their declarations. Using attributes
feels Perlish, even if it's not manipulating hash keys.</li>

<li>Function signatures eliminate a lot of code. My initializers do a lot
of work, but they don't take much code. Some even have empty method bodies.
This is a big win, except for the poor souls who had to implement the
underlying binding code in Pugs. (That took a while.)</li>

<li>Roles are fantastic. Sure, I believed in them already, but being able
to use them without the hacks required in Perl 5 was even better.</li>

</ul>

<h4>Final Thoughts</h4>

<p>Schwern and I did put a lot of thought into the Perl 5 redesign we never
really did, and my code here really benefits from the lessons I learned from
the previous version. Still, even though I wrote code to a moving project that
didn't yet support all of the features I wanted, it was a great exercise.
<code>Test::Builder</code> is simpler, shorter, cleaner, and more flexible;
it's ready for everything the Perl 6 QA group can throw at it.</p>

<p><code>Test::Builder</code> isn't the only Perl 5 module being ported to
Perl 6. Other modules include ports of HTTP::Server::Simple,
Net::IRC, LWP, and <code>CGI</code>. There are even ports
underway for Catalyst and Maypole.</p>

<p>Perl 6 isn't ready yet, but it's closer every day. Now's a great time to
port some of your code to see how Perl 6 is still Perlish, but a
revolutionary step in refreshing new directions.</p>

<div align="center">
<a href="http://conferences.oreillynet.com/os2005/"><img src="http://conferences.oreillynet.com/images/os2005/banners/468x60.gif" width="468" height="60" hspace="10" vspace="10" border="0" alt="O'Reilly Open Source Convention 2005." /></a>
</div>



        </div>



    </div>
    <div class="asset-footer"></div>
</div>




                            <div class="content-nav">
                                <a href="/pub/perl-internals/">&laquo; Perl Internals</a> |
                                <a href="/pub/">Main Index</a> |
                                <a href="/pub/archives.html">Archives</a>
                                | <a href="/pub/programming/">Programming &raquo;</a>
                            </div>


                        </div>
                    </div>


                    <div id="beta">
    <div id="beta-inner">


    
    <div class="widget-what-is-perl widget">
    <div class="widget-content widget-content-what-is-perl">
       Visit the home of the  Perl programming language: <a href="http://www.perl.org/">Perl.org</a
    </div>
</div>
<div class="widget-find-out-more widget-archives widget">
    <div class="widget-content">
        <ul>
            <li><a href="http://www.perl.org/get.html">Download</a></li>
            <li><a href="http://perldoc.perl.org/">Documentation</a></li>
            <li><a href="http://blogs.perl.org/">Perl Bloggers</a></li>
            <li><a href="http://news.perlfoundation.org/">Foundation News</a></li>
        </ul>
    </div>
</div><div class="widget-tcpc widget">
<h3 class="widget-header">Sponsored by</h3>
    <div class="widget-content">
        <a href="http://training.perl.com/" alt="Perl Training" target="_blank"><img src="/i/tcpc.png" width="150" height="50"></a>
    </div>
</div>

<div class="widget-syndication widget">
    <div class="widget-content">
        <ul>
            <li><img src="/mt-static/images/status_icons/feed.gif" alt="Subscribe to feed" width="9" height="9" /> <a href="/pub/atom.xml">Subscribe to this website's feed</a></li>

        </ul>
    </div>
</div>
<div class="widget-powered widget">
    <div class="widget-content">
        <a href="http://www.movabletype.com/"><img src="/mt-static/images/bug-pbmt-white.png" alt="Powered by Movable Type 5.02" width="120" height="75" /></a>
    </div>
</div>



    </div>
</div>






                </div>
            </div>


            <div id="footer">
    <div id="footer-inner">
        <div id="footer-content">
            <div class="widget-powered widget">
                <div class="widget-content">
                    Powered by <a href="http://www.movabletype.com/" rel="generator">Movable Type Pro</a>
                </div>
            </div>

        </div>
    </div>
</div>



        </div>
    </div>
</body>
</html>
