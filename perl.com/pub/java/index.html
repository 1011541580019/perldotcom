<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" id="sixapart-standard">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="generator" content="Movable Type Pro 5.02" />
<link rel="stylesheet" href="/pub/styles.css" type="text/css" />
<link rel="start" href="/pub/" title="Home" />
<link rel="alternate" type="application/atom+xml" title="Recent Entries" href="/pub/atom.xml" />
<script type="text/javascript" src="/pub/mt.js"></script>

<script type="text/javascript">

 var _gaq = _gaq || [];
 _gaq.push(['_setAccount', 'UA-50555-22']);
 _gaq.push(['_trackPageview']);

 (function() {
   var ga = document.createElement('script'); ga.type =
   'text/javascript'; ga.async = true;
   ga.src = ('https:' == document.location.protocol ? 'https://ssl' :
   'http://www') + '.google-analytics.com/ga.js';
   var s = document.getElementsByTagName('script')[0];
   s.parentNode.insertBefore(ga, s);
 })();

</script>
    <title>Perl.com: Java Archives</title>


</head>
<body id="perl-com" class="mt-archive-listing mt-category-archive layout-wt">
    <div id="container">
        <div id="container-inner">


            <div id="header">
    <div id="header-inner">
        <div id="header-content">
        <div id="top_advert"> 
<!-- Put any landscape advert in here -->
<a href="http://www.perlfoundation.org/" target="_new">
<img src="/i/tpf_banner.png" width="468" height="60" /></a>
        </div> 



            <div id="header-name"><a href="/pub/" accesskey="1">Perl.com</a></div>
            <div id="header-description"></div>




        </div>
    </div>
</div>



            <div id="content">
                <div id="content-inner">


                    <div id="alpha">
                        <div id="alpha-inner">

                            
                            <h1 id="page-title" class="archive-title">Recently in <em>Java</em> Category</h1>






                            
                            <div id="entry-708" class="entry-asset asset hentry">
    <div class="asset-header">
        <h2 class="asset-name entry-title"><a href="/pub/2006/12/using-java-classes.html" rel="bookmark">Using Java Classes in Perl</a></h2>
        <div class="asset-meta">
            <span class="byline">
    
                By <span class="vcard author">Andrew Hanenkamp</span> on <abbr class="published" title="2006-12-21T00:00:00-08:00">December 21, 2006 12:00 AM</abbr>
    
            </span>

            
            

        </div>
    </div>
    <div class="asset-content entry-content">

        <div class="asset-body">
            
<!-- sidebar begins -->
<!-- don't move sidebars-->
<!-- sidebar ends -->
<p>I started a new job recently to refocus my career from systems administration to web development. Part of that move meant using Java as my primary language at work and using a relatively new technology from the <a href="http://www.jcp.org/">Java Community Process</a> (JCP), the <a href="http://jcp.org/en/jsr/detail?id=170">Content Repository API for Java</a> (JCR), which is a hierarchical database standard for storing content. However, not wanting to let the skills in my favorite language waste away, I've been toying with similar technologies at home using Perl. I decided to make a direct port of the JCR to Perl and did so by making Perl use an existing Java implementation via <a href="http://search.cpan.org/~patl/Inline-Java/">Inline::Java</a>. While I ran into some snags along the way, I was happily surprised to find the process of using Java classes from Perl was fabulously easy.</p>

<h3>Bringing the JCR to Perl</h3>

<p>The key to using JCR from Perl is <code>Inline::Java</code>. This library allows a Perl program to call Java methods with very little effort. For an introduction to Inline::Java, I suggest starting where I did, Phil Crow's 2003 <a href="/pub/a/2003/11/07/java.html">Bringing Java into Perl</a> article on <a href="http://Perl.com">Perl.com</a> about Inline::Java. I also relied heavily upon the documentation for <a href="http://search.cpan.org/dist/Inline-Java/Java.pod">Inline::Java</a>, which is very complete, if not exhaustive.</p>

<p>To get started on using the JCR, I used the reference implementation, <a href="http://jackrabbit.apache.org/">Jackrabbit</a>. I downloaded the Jackrabbit JAR file, along with all the prerequisites, which I found on the Jackrabbit website under <a href="http://jackrabbit.apache.org/doc/firststeps.html">First Hops</a>. Then, I wrote a small script using <code>Inline::Java</code> to load the Java classes from Jackrabbit, create a repository, and then quit. I was able to take the First Hop with Jackrabbit in Perl as fast or faster than in Java:</p>

<pre><code>#!/usr/bin/perl
use strict; 
use warnings;
use Inline
    Java =&gt; 'STUDY',
    STUDY =&gt; [ qw(
        org.apache.jackrabbit.core.TransientRepository
        javax.jcr.Repository
    ) ],
    AUTOSTUDY =&gt; 1;

my $repository = org::apache::jackrabbit::core::TransientRepository-&gt;new;
my $session = $repository-&gt;login;
eval {
    my $user = $session-&gt;getUserID;
    my $name = $repository
        -&gt;getDescriptor($javax::jcr::Repository::REP_NAME_DESC);
    print "Logged in as $user to a $name repository.\n";
};

if ($@) {
    print STDERR "Exception: ", $@-&gt;getMessage, "n";
}

$session-&gt;logout;</code></pre>

<p>This code is a direct Perl port of the first tutorial on the Jackrabbit website. To run the code, you must make sure your class path is correct. Because I initially dropped the JCR files into my working directory, I just ran these commands to get it to work:</p>

<pre><code>% <strong>export CLASSPATH=$CLASSPATH:`echo *.jar | tr ' ' ':'`</strong>
% <strong>perl firsthop.pl</strong></code></pre>

<p>Within five minutes, I had a Perl script that could access the Jackrabbit libraries, create a repository, and login as anonymous. This answered my first question: Can I port the JCR to Perl? <em>Yes.</em></p>

<h3>First Snags</h3>

<p>After proceeding to the "Second Hop" in the Jackrabbit tutorial, I ran into my first snag. To create nodes and properties with Jackrabbit, you must log in using a username and password. However, the JCR uses an array of characters for the password argument. Because <code>Inline::Java</code> helpfully translates Java string objects into Perl scalars, I could not determine a way to do so.</p>

<p>I also realized that I did not want to use lengthy Java namespaces in my Perl code. Writing out <code>org::apache::jackrabbit::core::TransientRepository</code> or <code>javax::jcr::Repository</code> is not a very productive use of my time and makes for odd-looking Perl code.</p>

<p>In addition, I didn't want a library that depended on Jackrabbit. There are several other JCR implementations either already written or on the way. Day has <a href="http://www.day.com/crx">CRX</a>, there's another Open Source implementation named <a href="http://www.jeceira.com/">Jaceira</a> in the works, and <a href="http://docs.exoplatform.org/exo-documents/exo-jcr.site/index.html">eXo</a> has also created a JCR implementation, to name a few.</p>

<p>Given these difficulties and the potential for other problems that I knew would come up, it was time to build this project as a Perl module.</p>

<h3>Creating the Wrappers</h3>

<p>To create the abstraction I desired, it quickly became apparent that I needed a way to build wrappers around the stubs generated by <code>Inline::Java</code>. Therefore, I set about writing a script that could generate a Perl package for each library in the JCR. Each wrapper package would, in addition to helping wrap special cases, clean up the Java namespace using naming conventions that are more common to Perl code (particularly my Perl code, which is similar to Conway's conventions from <a href="http://www.oreilly.com/catalog/perlbp/"><cite>Perl Best Practices</cite></a>).</p>

<h3>Using Java Reflection</h3>

<p>I first needed to discover the classes, methods, and fields to wrap. There are more than 50 classes, interfaces, and exceptions in the JCR specification--I'm too lazy to type all that. Furthermore, the JCR is currently under revision via <a href="http://jcp.org/en/jsr/detail?id=283">JSR 283</a>, I don't want to update the class list again later. Finally, I want my wrappers to handle each method specifically because the use of <code>AUTOLOAD()</code> is evil (sometimes useful, but still evil).</p>

<p>I wrote a Java program to find all the classes in the JCR JAR file and write those class names out with additional information about methods, constructors, and fields. I used a <a href="http://www.yaml.org/">YAML</a>-formatted file to store the information. I made heavy use of the <a href="http://java.sun.com/docs/books/tutorial/reflect/index.html">Java Reflection API</a> to make this happen. You can see the <a href="http://search.cpan.org/src/HANENKAMP/Java-JCR-0.07/inc/JCRPackageGenerator.java">full source of JCR package generator</a> in the <a href="http://search.cpan.org/perldoc?Java::JCR">Java::JCR</a> distribution. Here's one entry in the <a href="http://search.cpan.org/src/HANENKAMP/Java-JCR-0.07/inc/packages.yml">YAML JCR package output file</a>:</p>

<pre><code>javax.jcr.SimpleCredentials:
  isa:
   - java.lang.Object
   - javax.jcr.Credentials
  has_constructors: 1
  methods:
    instance:
      getAttributeNames: Array:java.lang.String
      getUserID: java.lang.String
      toString: java.lang.String
      getPassword: Array:char
      getAttribute: java.lang.Object
      setAttribute: void
      removeAttribute: void</code></pre>

<p>The information I chose to place in the YAML file is mostly the outcome of experimentation with the Perl generator script. Because I wrote a generic handler to perform the required unwrapping that can handle any set of arguments, I didn't bother to remember them here. On the other hand, knowing the return type, recorded after each method name, is helpful to my implementation.</p>













<h3>Code Generation with Perl</h3>

<p>Next, I wrote a Perl script to load the information in the YAML file and generate the packages. You can see the full source for <a href="http://search.cpan.org/src/HANENKAMP/Java-JCR-0.07/inc/package-generator.pl">package-generator.pl</a> as well. This script is pretty ugly. I do all the work of generating the information in Perl with embedded here-documents. A much better way to do this would be to use a templating tool like Andy Wardley's <a href="http://www.template-toolkit.org/">Template Toolkit</a>, which is what I'd ultimately like to do.</p>

<p>Basically, this program iterates over all the entries loaded from the YAML file and generates a package for each class. It creates a Perl package name from the Java package name and a Perl package file at the appropriate location in the distribution.</p>

<p>For example, <code>javax.jcr.nodetype.ItemDefinition</code> gets a Perl package name of <code>Java::JCR::Nodetype::ItemDefinition</code> and a file location of <em>lib/Java/JCR/Nodetype/ItemDefinition.pm</em>.</p>

<p>The code injects a stock header and footer into the package file. All the real magic happens in between these.</p>

<h3>Handling Static Fields</h3>

<p>The code adds static fields by modifying the symbol table so that the wrappers point to the automatically generated stubs. For example, <code>Java::JCR::PropertyType</code> gets several entries like:</p>

<pre><code>*STRING = *Java::JCR::javax::jcr::PropertyType::STRING;
*BINARY = *Java::JCR::javax::jcr::PropertyType::BINARY;
*LONG = *Java::JCR::javax::jcr::PropertyType::LONG;</code></pre>

<p>For those who may not know, the first line makes the name <code>Java::JCR::PropertyType::STRING</code> exactly identical to using the longer name, <code>Java::JCR::javax::jcr::Property::STRING</code> by modifying the <a href="http://perldoc.perl.org/perlmod.html#Symbol-Tables-symbol-table-stash-%25%3a%3a-%25main%3a%3a-typeglob-glob-alias">symbol table</a> directly.</p>

<p>OK, looking at that, you probably want to know why all the <code>Inline::Java</code> stubs now have <code>Java::JCR</code> on the front of them. The reason is that in the generated code, I use the <code>study_classes()</code> routine to import the Java code and specify that the base package for the import should be <code>Java::JCR</code>:</p>

<pre><code>study_classes(['javax.jcr.PropertyType'], 'Java::JCR');</code></pre>

<p>Why? It's really not that critical, but I figured that because the name of the package I was putting on CPAN was <code>Java::JCR</code>, I really didn't want to drop packages into an external namespace while I was at it. Because the wrappers hide all the long names, the actual length of the internal names doesn't matter anyway.</p>

<h3>Dealing with Constructors and Methods</h3>

<p>After fields, the code checks whether the Java class provides a constructor (that is, if it's a class rather than an interface). As it turns out, I never actually use the code for dealing with constructors for two reasons:</p>

<ul>
<li><em>Exceptions</em>. For reasons I'll explain later, I don't generate the exception classes. Therefore, these constructors go unused.</li>

<li><em><code>SimpleCredentials</code></em>. The only remaining class that has a constructor is <code>java.jcr.SimpleCredentials</code>, which is the special case I've already mentioned. Therefore, I only need to cope with constructors as a special case. I'll cover the special cases later as well.</li>
</ul>

<p>After the constructor, the program runs through each method and generates both the static and instance method wrappers. Here's a typical method wrapper from <code>Java::JCR::Repository</code>:</p>

<pre><code>sub login {
    my $self = shift;
    my @args = Java::JCR::Base::_process_args(@_);

    my $result = eval { $self-&gt;{obj}-&gt;login(@args) };
    if ($@) { my $e = Java::JCR::Exception-&gt;new($@); croak $e }

    return Java::JCR::Base::_process_return($result, "javax.jcr.Session", "Java::JCR::Session");
}</code></pre>

<h3>Camel Case</h3>

<p>This particular example doesn't show it, but I also changed the camel-case Java names of every method to all lowercase with underscores, which is a much more common way of naming methods in Perl. I may add aliases using the Java names in the future, but I don't care for Java-style naming conventions in Perl code. The most interesting part of this process was handing names that include all-caps abbreviations. That required two lines of Perl:</p>

<pre><code>my $perl_method_name = $method_name;
$perl_method_name =~ s/(p{IsLu}+)/_L$1E/g;</code></pre>

<p>The <code>/(\p{IsLu}+)/</code> matches any uppercase letter or string of uppercase letters. The replacement applies the <code>\L</code> modifier to the regular expression to convert the matched snippet to all lowercase. I prepend an underscore to complete the conversion. Thus, the method named <code>getDescriptor</code> becomes <code>get_descriptor</code> and the method named <code>getNodeByUUID</code> becomes <code>get_node_by_uuid</code>. This won't work very well, by the way, if there are any names that have abbreviations before the end (for example, if there had been a <code>getUUIDNode</code>, which would become <code>get_uuidnode</code>) Fortunately, this case never shows up in the JCR API.</p>

<h3>Method Wrappers</h3>

<p><code>Java::JCR::Base::_process_arg()</code> processes the arguments passed to each method. This function looks for any of the generated wrapper objects (anything that <code>isa</code> <code>Java::JCR::Base</code>) in the list of arguments and unwraps the generated stub by pulling the <code>obj</code> key out of the blessed hash.</p>

<pre><code>sub _process_args {
    my @args;
    for my $arg (@_) {
        if (UNIVERSAL::isa($arg, 'Java::JCR::Base')) {
            push @args, $arg-&gt;{obj};
        }
        else {
            push @args, $arg;
        }
    }

    return @args; 
}</code></pre>

<p>The wrapper then executes the wrapped method on the generated stub by passing it the unwrapped arguments (as if the wrappers weren't there).</p>

<p>I make sure to wrap every call in an <code>eval</code> because <code>Inline::Java</code> passes Java exceptions as Perl exception objects. If an exception is thrown, I wrap it in a custom class named <code>Java::JCR::Exception</code>, which I wrote by hand.</p>

<p>Finally, the code returns the result. If the return type has a wrapper, as is the case in <code>login()</code>), I use <code>Java::JCR::Base::_process_return()</code> to cast the class and wrap it.</p>

<pre><code>sub _process_return {
    my $result = shift;
    my $java_package = shift;
    my $perl_package = shift;

    # Null is null
    if (!defined $result) {
        return $result;
    }

    # Process array results
    elsif ($java_package =~ /^Array:(.*)$/) {
        my $real_package = $1;
        return [
            map { bless { obj =&gt; cast($real_package, $_) }, $perl_package }
                @{ $result }
        ];
    }

    # Process scalar results
    else {
        return bless {
            obj =&gt; cast($java_package, $result),
        }, $perl_package;
    }
}</code></pre>

<p>This brings up two considerations: Why the custom exception class? Why do I need to cast the object? In both cases, I do this to handle minor issues in <code>Inline::Java</code>.</p>

<p>In the case of exceptions, the generated exception objects don't handle Perl stringification very well. Because a lot of exception handlers assume that exceptions are strings or properly stringified, this can be (and has been for me) a problem. My exception class makes sure stringification works the right way.</p>

<p>As for the cast, <code>Inline::Java</code> works on the assumption that you want to use the class in its most specific form, but if it hasn't studied that form, you get a generic object on which you cannot call any methods. Rather than engage the potentially costly <code>AUTOSTUDY</code> option to make sure <code>Inline::Java</code> studies everything and then smarten up the wrappers more, I've chosen to cast the objects into the expected return type. This does limit some of the flexibility.</p>

<h3>Loading Packages</h3>

<p>Other than the custom pieces, I needed some additional helpers to get the job done. I didn't want to write out a lot of <code>use</code> statements to use this library. As a JAPH, I like to keep things simple. Therefore, if I need to use the JCR and Jackrabbit, I just want to say:</p>

<pre><code>use Java::JCR;
use Java::JCR::Jackrabbit;</code></pre>

<p>I included a package loader in the main package, <a href="http://search.cpan.org/~hanenkamp/Java-JCR/lib/Java/JCR.pm">Java::JCR</a>, that will take care of these details and then created a package for each of the subpackages in the JCR. The loader looks like:</p>

<pre><code>sub import_my_packages {
    my ($package_name, $package_file) = caller;
    my %excludes = map { $_ =&gt; 1 } @_;

    my $package_dir = $package_file;
    $package_dir =~ s/.pm$//;
    my $package_glob = File::Spec-&gt;catfile($package_dir, '*.pm');

    for my $package (glob $package_glob) {
        $package =~ s/^$package_dir///;
        $package =~ s/.pm$//;
        $package =~ s///::/g;

        next if $excludes{$package};

        eval "use ${package_name}::$package;";
        if ($@) { carp "Error loading $package: $@" }
    }
}</code></pre>

<p>I make sure to call that method once the package has finished loading and pass in exclusions to keep it from loading all the subpackages. This needs further enhancement to allow for future extensions under the <code>Java::JCR</code> namespace, so as not to load them automatically, but this is a good starting point. I built one class for each subpackage, then, that inherits from Java::JCR and then calls this method to load each of those classes.</p>

<h3>Connecting to Jackrabbit</h3>

<p>Obviously, the next step was to create the code to connect to Jackrabbit. This was done in <a href="http://search.cpan.org/~hanenkamp/Java-JCR/lib/Java/JCR/Jackrabbit.pm">Java::JCR::Jackrabbit</a>. The initial implementation is very simple:</p>

<pre><code>use base qw( Java::JCR::Base Java::JCR::Repository );

use Inline (
    Java =&gt; 'STUDY',
    STUDY =&gt; [],
);
use Inline::Java qw( study_classes );

study_classes(['org.apache.jackrabbit.core.TransientRepository'], 'Java::JCR');

sub new {
    my $class = shift;

    return bless {
        obj =&gt; Java::JCR::org::apache::jackrabbit::core::TransientRepository
                -&gt;new(@_),
    }, $class;
}</code></pre>

<p>I extended <a href="http://search.cpan.org/~hanenkamp/Java-JCR/lib/Java/JCR/Repository.pm">Java::JCR::Repository</a> to add a constructor that calls the Jackrabbit constructor. Done.</p>













<h3>Handling Special Cases</h3>

<p>With all that work, I still couldn't make the second hop because I still hadn't resolved the whole problem of passing an array of characters. However, with the infrastructure I had in place, this was now solvable.</p>

<p>I created an additional YAML configuration file named <a href="http://search.cpan.org/src/HANENKAMP/Java-JCR-0.07/inc/specials.yml">specials.yml</a>. This file contains hand-coded alternatives to use where appropriate. I then wrote an alternative for the new constructor:</p>

<pre><code>javax.jcr.SimpleCredentials:
  new: |-
    sub new {
        my $class = shift;
        my $user = shift;
        my $password = shift;

        my $charArray = Java::JCR::PerlUtils-&gt;charArray($password);

        return bless {
            obj =&gt; Java::JCR::javax::jcr::SimpleCredentials-&gt;new($user, $charArray),
        }, $class;
    }</code></pre>

<p>Then, I reran the generator script. Fortunately, I had already improved it to use any implemented method or constructor rather than generating one automatically.</p>

<p>To perform the conversion, I also needed to embed a little extra Java code. I wrote a very small Java class called <code>PerlUtils</code> for handling the conversion:</p>

<pre><code>use Inline (
    Java =&gt; &lt;&lt;'END_OF_JAVA',

class PerlUtils {
    public static char[] charArray(String str) {
        return str.toCharArray();
    }
}

END_OF_JAVA
);</code></pre>

<p>Given a string, it returns an array of characters to pass back into the <code>SimpleCredentials</code> constructor. No other work is necessary. I could now perform the <a href="http://search.cpan.org/src/HANENKAMP/Java-JCR-0.07/ex/secondhop.pl">JCR second hop in Perl</a>. That script attaches to a Jackrabbit repository, logs in as "username" with password "password" and then creates a node.</p>

<h3>Using Handles as InputStreams</h3>

<p>The third (and final) hop of the Jackrabbit tutorial demonstrates node import using an XML file. However, in order to perform the import shown, you must pass an <code>InputStream</code> off to the <code>importXML()</code> method. While <code>Inline::Java</code> provides the ability to use Java <code>InputStream</code>s as Perl file handles, it doesn't provide the mapping in the opposite direction. Thus I needed another special handler and an additional set of helper methods.</p>

<p>The special code configuration looks like:</p>

<pre><code>javax.jcr.Session:
  import_xml: |-
    sub import_xml {
        my $self = shift;
        my $path = shift;
        my $handle = shift;
        my $behavior = shift;

        my $input_stream = Java::JCR::JavaUtils::input_stream($handle);

        $self-&gt;{obj}-&gt;importXML($path, $input_stream, $behavior);
    }</code></pre>

<p>This calls the <code>input_stream()</code> method, which is a Perl subroutine.</p>

<pre><code>sub input_stream {
    my $glob = shift;
    my $glob_val = $$glob;
    $glob_val =~ s/^\*//;
    my $glob_caller = Java::JCR::GlobCaller-&gt;new($glob_val);
    return Java::JCR::GlobInputStream-&gt;new($glob_caller);
}</code></pre>

<p>As you can see, this subroutine uses two separate Java classes to provide the interface from a Perl file handle to Java <code>InputStream</code>. The first class, <code>Java::JCR::GlobCaller</code>, performs most of the real work using the callback features provided by <code>Inline::Java</code>. It gets passed to the <code>Java::JCR::GlobInputStream</code>, which calls <code>read()</code> whenever the JCR reads from the stream:</p>

<pre><code>public int read() throws InlineJavaException, InlineJavaPerlException {
    String ch = (String) CallPerlSub(
            "Java::JCR::JavaUtils::read_one_byte", new Object[] {
                this.glob
           });
    return ch != null ? ch.charAt(0) : -1;
}</code></pre>

<p>The <code>read_one_byte()</code> function is a very basic wrapper for the Perl built-in <code>getc</code>.</p>

<pre><code>sub read_one_byte {
    my $glob = shift;
    my $c = getc $glob;
    return $c;
}</code></pre>

<p>With this in place, you can now perform the <a href="http://search.cpan.org/src/HANENKAMP/Java-JCR-0.07/ex/thirdhop.pl">third JCR hop in Perl</a>. By executing this script, you will connect to a repository, log in, and then create nodes and properties from an XML file.</p>

<h3>Getting Ready to Distribute</h3>

<p>The implementation is now, more or less, complete. You can use <code>Java::JCR</code> to connect to a Jackrabbit repository, log in, create nodes and properties, and import data from XML. There's a lot left untested, but the essentials are now present. With this done, I was ready to begin getting ready for the distribution. However, because some Java libraries are requirements to use the library, the library has some special needs to build and install easily. You should be able to install it by just running:</p>

<pre><code>% <strong>cpan Java::JCR</strong></code></pre>

<p>I needed a way to build this library. My preferred build tool is Ken Williams' <a href="http://search.cpan.org/perldoc?Module::Build">Module::Build</a>. It's in common use, compatible with the CPAN installer, and cooperates well with <em>g-cpan.pl</em>, which is a packaging tool for my favorite Linux distribution, <a href="http://www.gentoo.org/">Gentoo</a>. Finally, it's easy to extend.</p>

<p>When customizing <code>Module::Build</code>, I prefer to create a custom build module rather than by placing the extension directly inline with the <em>Build.PL</em> file. In this case, I've called the module <a href="http://search.cpan.org/src/HANENKAMP/Java-JCR-0.07/inc/Java/JCR/Build.pm">Java::JCR::Build</a>. I placed it inside a directory named <em>inc/</em> with the rest of the tools I built for generating the package.</p>

<p>After creating the basic module that extends <code>Module::Build</code>, I added a custom action to fetch the JAR files called <code>get_jars</code>. I also added the code to execute this action on build by extending the <code>code</code> ACTION:</p>

<pre><code>sub ACTION_get_jars {
    my $self = shift;

    eval "require LWP::UserAgent"
        or die "Failed to load LWP::UserAgent: $@";

    my $mirror_dir
        = File::Spec-&gt;catdir($self-&gt;blib, 'lib', 'Java', 'JCR');
    mkpath( $mirror_dir, 1);

    my $ua = LWP::UserAgent-&gt;new;

    print "Checking for needed jar files...n";
    while (my ($file, $url) = each %jars) {
        my $path = File::Spec-&gt;catfile($mirror_dir, $file);
        $self-&gt;add_to_cleanup($path);

        next if -f $path;

        my $response = $ua-&gt;mirror($url, $path);
        if ($response-&gt;is_success) {
            print "Mirroring $url to $file.n";
        }

        elsif ($response-&gt;is_error) {
            die "An error occurred fetching $url to $file: ",
                $response-&gt;status_line, "n";
        }
    }
}

sub ACTION_code {
    my $self = shift;

    $self-&gt;ACTION_get_jars;
    $self-&gt;SUPER::ACTION_code;
}</code></pre>

<p>I use Gisle Aas's <a href="http://search.cpan.org/perldoc?LWP::UserAgent">LWP::UserAgent</a> to fetch the JAR files from the public Maven repositories and drop them into the build library folder, <em>blib</em>. <code>Module::Build</code> will take care of the rest by copying those JAR files to the appropriate location during the install process.</p>

<p>I also needed some code in <code>Java::JCR</code> to set the <code>CLASSPATH</code> correctly ahead of time:</p>

<pre><code>my $classpath;
BEGIN {
    my @classpath;
    my $this_path = $INC{'Java/JCR.pm'};
    $this_path =~ s/.pm$//;
    my $jar_glob = File::Spec-&gt;catfile($this_path, "*.jar");
    for my $jar_file (glob $jar_glob) {
        push @classpath, $jar_file;
    }
    $classpath = join ':', @classpath, ($ENV{'CLASSPATH'} || '');
    $ENV{'CLASSPATH'} = $classpath;
}</code></pre>

<p>This bit of code asks Perl for the path to the location of this library, which I assume is the installed location of the JAR files. Then, I find each file ending with <em>.jar</em> in that directory and put them into the <code>CLASSPATH</code>. Unfortunately, my code assumes a Unix environment when it uses the colon as the path separator. A future revision could make sure that this works on other systems as well, but because I use only Unix-based operating systems, my motivation is lacking.</p>

<p>With all that, you can now deploy this by downloading the tarball and running:</p>

<pre><code>% <strong>perl Build.PL</strong>
% <strong>./Build</strong>
% <strong>./Build test</strong>
% <strong>./Build install</strong></code></pre>

<p>It works!</p>

<h3>Testing</h3>

<p>I haven't mentioned this yet, but during the whole process of building this library, I also built a series of test cases. You can find these in the <a href="http://search.cpan.org/src/HANENKAMP/Java-JCR-0.07/t/"><em>t</em>/</a> directory of the distribution. The first few tests are actually just variations on the Jackrabbit tutorial, as well as a test to make sure the POD documentation contains no errors (every module author should use this test; you can just copy and paste it into any project).</p>

<h3>Final Thoughts</h3>

<p>I love Perl. This port from Java to Perl was easier than I would have thought possible. I wanted to share my success in the hopes of spurring on others. Kudos go to Ken Williams and Patrick LeBoutillier and the others that have assisted them to build the tools that made this possible.</p>

<p>Cheers.</p>


        </div>



    </div>
    <div class="asset-footer"></div>
</div>


                            
                            <div id="entry-698" class="entry-asset asset hentry">
    <div class="asset-header">
        <h2 class="asset-name entry-title"><a href="/pub/2006/08/sequence-diagrams.html" rel="bookmark">Generating UML and Sequence Diagrams</a></h2>
        <div class="asset-meta">
            <span class="byline">
    
                By <span class="vcard author">Phil Crow</span> on <abbr class="published" title="2006-08-03T00:00:00-08:00">August  3, 2006 12:00 AM</abbr>
    
            </span>

            
            

        </div>
    </div>
    <div class="asset-content entry-content">

        <div class="asset-body">
            
<!-- sidebar begins -->
<!-- don't move sidebars-->
<!-- sidebar ends -->
<p>Imagine yourself in a meeting with management. You're about to begin your third attempt to explain how to process online credit card payments. After a couple of sentences, you see some eyes glazing over. Someone says, "Perhaps you could draw us a picture."</p>

<p>Imagine me handling a recent request from my boss. He came in to the bat cave and said (in summary), "We want customers to sign up for email accounts without calling customer service. All the account creation code is in the customer care app." It didn't take long to find the relevant web screen, where the CSR presses Save to kick off the account creation, but there sure were a lot of layers between there and the final result. Keeping them in mind is hard enough when I'm deep in the problem. Three months from now, when an odd bug surfaces, it'll be nearly impossible without the right memory aid.</p>

<p>In both of these cases, the right diagram is the sequence diagram. (I'd show you mine for the situations above, but they're secret.) Sequence diagrams clearly show the time flow of method or function calls between modules. For complex systems, these diagrams can save a lot of time--like the time you and your fellow programmers spend during initial design, the time spent explaining what's possible to management, the time you spend remembering how things work when you revisit an old system that needs a new feature, and especially the time it takes a new programmer in your shop to get up to speed.</p>

<p>In short, sequence diagrams help with complex call stacks just as data model diagrams help with complex database schema.</p>

<p>While the sequence diagram is useful to me, I don't like on-screen drawing tools. Therefore, I wrote the original <a href="http://search.cpan.org/perldoc?UML::Sequence"><code>UML::Sequence</code></a> to make the drawings for me. With recent help from Dean Arnold, the current version has many nice features and is closer to standards compliance (but, both Dean and I prefer a useful diagram to a compliant one). Using <code>UML::Sequence</code>, you can quickly make proposed diagrams of systems not yet built. You can even run it against existing programs to have it diagram what they actually do.</p>

<h3>Reading a Sequence Diagram</h3>

<p>If you already know how to read sequence diagrams, you can skip to the next section.</p>

<p>Because most uses of UML involve object-oriented projects, that's where I've drawn my examples. Don't think that objects are necessary for sequence diagrams. I've diagrammed many non-OO programs with it (including some in COBOL).</p>

<p>A simple example will work best for a first look at UML sequence diagrams, so consider rolling two dice. My over-engineered solution gives a nice diagram to discuss. In it, I made each die an object of the <code>Die</code> class and the pair of dice an object of the <code>DiePair</code> class. To roll the dice, I wrote a little script. Here are these pieces:</p>

<pre><code>    package Die;
    use strict;

    sub new {
        my $class = shift;
        my $sides = shift || 6;
        return bless { SIDES =&gt; $sides }, $class;
    }

    sub roll {
        my $self       = shift;
        $self-&gt;{VALUE} = int( rand * $self-&gt;{SIDES} ) + 1;

        return $self-&gt;{VALUE};
    }

    1;</code></pre>

<p>The <code>Die</code> constructor takes an optional number of sides for the new die object, but supplies six as a default. It bundles that number of sides into a hash reference, blesses, and returns it.</p>

<p>The <code>roll()</code> method makes a random number and uses it to pick a new value for the die, which it returns.</p>

<p><code>DiePair</code> is equally scintillating:</p>

<pre><code>    package DiePair;
    use strict;

    use Die;

    sub new {
        my $class     = shift;
        my $self      = {};
        $self-&gt;{DIE1} = Die-&gt;new( shift );
        $self-&gt;{DIE2} = Die-&gt;new( shift );

        return bless $self, $class;
    }

    sub roll {
        my $self   = shift;
        my $value1 = $self-&gt;{DIE1}-&gt;roll();
        my $value2 = $self-&gt;{DIE2}-&gt;roll();

        $self-&gt;{TOTAL}   = $value1 + $value2;
        $self-&gt;{DOUBLES} = ( $value1 == $value2 ) ? 1 : 0;

        return $self-&gt;{TOTAL}, $self-&gt;{DOUBLES};
    }

    1;</code></pre>

<p>The constructor makes two die objects and stores them in a hash reference, which it blesses and returns.</p>

<p>The <code>roll()</code> method rolls each die, storing the value, then totals them and decides whether the roll was doubles. It returns both total and doubles, saving the driver from having to call back for them.</p>

<p>Rather than modeling a real game like craps, I use a small driver, which will simplify the resulting diagram.</p>

<pre><code>    #!/usr/bin/perl
    use strict;

    use DiePair;

    my $die_pair          = DiePair-&gt;new(6, 6);
    my ($total, $doubles) = $die_pair-&gt;roll();

    print "Your total is $total ";
    print "it was doubles" if $doubles;
    print "\n";</code></pre>

<p>Figure 1 shows the sequence diagram for this driver.</p>

<p><img src="/pub/2006/08/03/graphics/roller.gif" alt="the sequence diagram for the die roller" /><br />
<em>Figure 1. The sequence diagram for the die roller</em></p>

<p>Each package has a box at the top of the diagram. The script is in the <code>main</code> package (which is always Perl's default). Time flows from top to bottom. Arrows represent method (or function) calls.</p>

<p>The vertical boxes, or <em>activations</em>, represent the life of a call. Between the activations are dashed lines called the <em>life lines</em> of the objects.</p>

<p>You can see that <code>main</code> begins first (because its first activation is higher than the others). It calls <code>new()</code> on the <code>DiePair</code> class. That call lasts long enough for <code>DiePair</code>'s constructor to call <code>new()</code> on the <code>Die</code> class twice.</p>

<p>After making the objects, the script calls <code>roll()</code> on the <code>DiePar</code>, which forwards the request to the individual dice.</p>

<p>This diagram is unorthodox. The boxes at the top <em>should</em> represent individual instances, not classes. Sometimes I prefer this style because it compacts the diagram horizontally. Figure 2 shows a more orthodox diagram (divergent only in the lack of name underlining).</p>

<p><img src="/pub/2006/08/03/graphics/rollerinst.gif" alt="a more orthodox UML diagram" /><br />
<em>Figure 2. A more orthodox UML diagram</em></p>

<p>You can see the individual <code>Die</code> objects that the <code>DiePair</code> instance aggregates, because there is now a box at the top for each object (use your imagination when thinking about the driver as an instance). The names do not come from the code; they are sequentially assigned from the class name.</p>

<p>Diagrams like this are especially helpful when many classes interact. For instance, many of them start with a user event (like a button press on a GUI application) and show how the view communicates with the controller and how the controller in turn communicates with the data model.</p>

<p>Another particularly useful application is for programs communicating via network sockets. In their diagrams, each program has a box, and the arrows represent writing on a socket. Note that UML sequence diagrams may also have dashed arrows, which show return values going back to callers. Unless there is something unusual about that value, there is no use to waste space on the diagram for those returns. However, in a network situation, showing the back and forth can be quite helpful. <code>UML::Sequence</code> now has support for return arrows.</p>

<!-- sidebar begins -->
 <csperl file="grab" domain="on" record="b/2403" template="b/article_sidebar2.view">
<!-- sidebar ends -->













<h3>Using UML::Sequence</h3>

<p>Now that you understand how to read a sequence diagram, I can show you how to make them without mouse-driven drawing tools.</p>

<p>Making diagrams with <code>UML::Sequence</code> is a three-step process:</p>

<ol>
<li>Create a program or a text file.</li>

<li>Use <em>genericseq.pl</em> to create an XML description of the diagram.</li>

<li>Use a rendering script to turn the XML into an image file.</li>
</ol>

<p>If the image is in the wrong format for your purposes, you might need an extra step to convert to another format.</p>

<h4>Running Perl Programs</h4>

<p>Here is how I generated Figure 1 above by running the driver program. If your program is in Perl, you can use this approach (see the next subsection for Java programs).</p>

<p>First, create a file listing the subs you want to see in the diagram:</p>

<pre><code>    DiePair::new
    DiePair::roll
    Die::new
    Die::roll</code></pre>

<p>I called this file <em>roller.methods</em> to correspond to the script's name, <em>roller</em>. When you make your method list, remember that sequence diagrams are visual space hogs, so pick a short list of the most important methods.</p>

<p>Then, run the program through the <code>genericseq.pl</code> script:</p>

<pre><code>$ <strong>genericseq.pl UML::Sequence::PerlSeq roller.methods roller &gt; roller.xml</strong></code></pre>

<p><a href="http://search.cpan.org/perldoc?UML::Sequence::PerlSeq"><code>UML::Sequence::PerlSeq</code></a> uses the Perl debugger's hooks to profile the code as it runs, watching for the methods listed in <em>roller.methods</em>. The result is an XML file describing the calls that actually happened during this run.</p>

<p>To turn this into a picture, use one of the image scripts:</p>

<pre><code>$ <strong>seq2svg.pl roller.xml &gt; roller.svg</strong></code></pre>

<p>Obviously, <code>seq2svg.pl</code> makes SVG images. If you have no way to view those, get Firefox 1.5, use a tool like the batik rasterizer, or use <code>seq2rast.pl</code>, which makes PNG images directly using the <a href="http://search.cpan.org/perldoc?GD"><code>GD</code></a> module.</p>

<p>If you want diagrams like Figure 2, use <a href="http://search.cpan.org/perldoc?UML::Sequence::PerlOOSeq"><code>UML::Sequence::PerlOOSeq</code></a> in place of <code>UML::Sequence::PerlSeq</code> when you run <code>genericseq.pl</code>.</p>

<h4>Running Java Programs</h4>

<p>I wrote <code>UML::Sequence</code> while working as a Java programmer, so I made it work on Java (at least sometimes it works). The process is similar to the above. First, make a methods file:</p>

<pre><code>    ALL
    Roller
    DiePair
    Die</code></pre>

<p>Here I use <code>ALL</code> to mean all methods from the following classes. You can also list full signatures (but they have to be full, valid, and expressed in the internal signature format as if generated by <code>javap</code>).</p>

<p>Then run <code>genericseq.pl</code> with <a href="http://search.cpan.org/perldoc?UML::Sequence::JavaSeq">UML::Sequence::JavaSeq</a> in place of <code>UML::Sequence::PerlSeq</code>. Of course, this requires you to have a Java development environment on your machine. In particular, it must be able to find <em>tools.jar</em>, which provides the debugger hooks necessary to watch the calls.</p>

<p>Produce the image from the resulting XML file as shown earlier for Perl programs.</p>

<h4>Text File Input</h4>

<p>While I pat myself on the back every time I make a sequence diagram of a running program, that's not always (or even usually) practical. For instance, you might want to show the boss what you have planned for code you haven't written yet. Alternately, you might have a program that is so complex that no amount of tweaking the methods file will restrict the diagram enough to make it useful.</p>

<p>In these cases, there is a small text language you can use to specify the diagram. It is based on indentation and uses dot notation for method names. Here is a sample:</p>

<pre><code>At Home.Wash Car
    Garage.retrieve bucket
    Kitchen.prepare bucket
        Kitchen.pour soap in bucket
        Kitchen.fill bucket
    Garage.get sponge
    Garage.open door
    Driveway.apply soapy water
    Driveway.rinse
    Driveway.empty bucket
    Garage.close door
    Garage.replace sponge
    Garage.replace bucket</code></pre>

<p>Each line will become an arrow in the final diagram (except the first line). Indentation indicates the call depth. The "class" name comes before the dot and the "method" name after it.</p>

<p>There is no need for a methods file in this case, because presumably you didn't bother to type things you didn't care about. You may go directly to running <code>genericseq.pl</code>:</p>

<pre><code>$ <strong>genericseq.pl UML::Sequence::SimpleSeq inputfile &gt; wash.xml</strong></code></pre>

<p>Once you have the XML file, render it as before.</p>

<h3>Getting Fancy</h3>

<p>As I mentioned earlier, Dean Arnold recently added lots of cool features to amaze and impress your bosses and/or clients. In particular, he expanded the legal syntax for text outlines. Here is his sample of car washing with the new features:</p>

<pre><code>AtHome.Wash Car
        /* the bucket is in the garage */
    Garage.retrieve bucket
    Kitchen.prepare bucket
        Kitchen.pour soap in bucket
        Kitchen.fill bucket
    Garage.get sponge
    Garage.checkDoor
            -&gt; clickDoorOpener
        [ ifDoorClosed ] Garage.open door
    * Driveway.apply soapy water
    ! Driveway.rinse
    Driveway.empty bucket
    Garage.close door
    Garage.replace sponge
    Garage.replace bucket</code></pre>

<p>There are several new features here:</p>

<ul>
<li>You can include UML annotations by using C-style comments, as shown on the second line of the example. Each annotation attaches to the following line as a footnote (or tooltip, if you install a third-party open source library).</li>

<li>There is a <code>-&gt;</code> in front of <code>clickDoorOpener</code>. This becomes an asynchronous message arrow. When <code>-&gt;</code> comes between a method and additional text, it indicates that a regular method is returning the value on the righthand side of the arrow. The return appears as a dashed arrow from the called activation back to the caller.</li>

<li><code>ifDoorClosed</code> is in brackets, which mark a conditional in UML. These appear in the diagram in front of the method name.</li>

<li>There is a star in front of <code>Driveway.apply</code>, which indicates a loop construct in UML. (UML people call this <em>iteration</em>.)</li>

<li>There is an exclamation point in front of <code>Driveway.rinse</code>, indicating urgency.</li>
</ul>

<p>In addition to these changes to the outline syntax, both <code>seq2svg.pl</code> and <code>seq2rast.pl</code> now support options to control appearance (including colors) and to generate HTML imagemaps for raster versions of the diagrams. The imagemaps hyperlink diagram elements--columns header and method call names--to supporting documents. For example, clicking on the <code>Garage</code> header will open <em>Garage.html</em>, while clicking on <code>checkDoor</code> will also open <em>Garage.html</em>, but at the <code>#checkDoor</code> anchor.</p>

<h3>Summary</h3>

<p>UML Sequence diagrams are a great way to see how function or method calls (or network messages) flow through a multi-module application, whether it is object-oriented or not. Using <code>UML::Sequence</code> and its helper scripts, you can make those diagrams without having to point and click in a drawing program.</p>

<h3>References</h3>

<p><a href="http://www.presicient.com/umlseq/deluxewash.html">The imagemapped HTML version of car washing</a> is viewable online.</p>

<p>To read more about UML diagrams, check out the aptly named <em>UML Distilled</em>, by Martin Fowler, available from your favorite bookseller.</p>

<p>I recommend Walter Zorn's <a href="http://www.walterzorn.com/tooltip/tooltip_e.htm">JavaScript, DHTML tooltips</a> package to display embedded annotations.</p>

<p><a href="http://xml.apache.org/batik/">Batik</a> is an Apache project for managing and viewing SVG.</p>




        </div>



    </div>
    <div class="asset-footer"></div>
</div>


                            
                            <div id="entry-696" class="entry-asset asset hentry">
    <div class="asset-header">
        <h2 class="asset-name entry-title"><a href="/pub/2006/07/lightning-articles.html" rel="bookmark">Still More Perl Lightning Articles</a></h2>
        <div class="asset-meta">
            <span class="byline">
    
                By <span class="vcard author">chromatic</span> on <abbr class="published" title="2006-07-13T00:00:00-08:00">July 13, 2006 12:00 AM</abbr>
    
            </span>

            
            

        </div>
    </div>
    <div class="asset-content entry-content">

        <div class="asset-body">
            
<!-- sidebar begins -->
<!-- don't move sidebars-->
<!-- sidebar ends -->
<p>It has been common practice within the Perl community for ages to ship distributions with a <em>Makefile.PL</em> so that the user will be able to install the packages when he retrieves them, either via the shell which the <code>CPAN/CPANPLUS</code> modules offer or via manual CPAN download.</p>

<p>The <em>Makefile.PL</em> consists of meta-information, which in the case of the distribution <a href="http://search.cpan.org/perldoc?HTML::Tagset"><code>HTML::Tagset</code></a> is:</p>

<pre><code> # This -*-perl-*- program writes the Makefile for installing this distribution.
 #
 # See "perldoc perlmodinstall" or "perldoc ExtUtils::MakeMaker" for
 # info on how to control how the installation goes.

 require 5.004;
 use strict;
 use ExtUtils::MakeMaker;

 WriteMakefile(
     NAME            =&gt; 'HTML::Tagset',
     AUTHOR          =&gt; 'Andy Lester &lt;andy@petdance.com&gt;',
     VERSION_FROM    =&gt; 'Tagset.pm', # finds $VERSION
     ABSTRACT_FROM   =&gt; 'Tagset.pm', # retrieve abstract from module
     PMLIBDIRS       =&gt; [qw(lib/)],
     dist            =&gt; { COMPRESS =&gt; 'gzip -9f', SUFFIX =&gt; 'gz', },
     clean           =&gt; { FILES =&gt; 'HTML-Tagset-*' },
 );</code></pre>

<p>Of interest are the arguments to <code>WriteMakefile()</code>, because they influence the <em>Makefile</em> written by <code>ExtUtils::MakeMaker</code> after the user has invoked the usual build and install procedure:</p>

<pre><code> % perl Makefile.PL
 % make
 % make test
 # make install</code></pre>

<h3><code>Module::Build</code>, Successor of <code>ExtUtils::MakeMaker</code>?</h3>

<p>As Ken Williams grew tired of <a href="http://search.cpan.org/perldoc?ExtUtils::MakeMaker"><code>ExtUtils::MakeMaker</code></a> and its portability issues, he invented <a href="http://search.cpan.org/perldoc?Module::Build"><code>Module::Build</code></a>, a successor of <code>ExtUtils::MakeMaker</code>. One goal of <code>Module::Build</code> is to run smoothly on most operating systems, because it takes advantage of creating Perl-valid syntax files only and does not rely upon crufty <em>Makefiles</em>, which are often subject to misinterpretation, because so many incompatible flavors of <code>make</code> exist in the wild.</p>

<p>The current maintainer of <code>ExtUtils::MakeMaker</code>, Michael G. Schwern, elaborated about this problem in his talk reachable via "<a href="http://mungus.schwern.org/~schwern/talks/MakeMaker_Is_DOOMED/slides/">MakeMaker is DOOMED</a>."</p>

<h3><code>Module::Build</code> Distribution "Skeleton"</h3>

<p>If you take in consideration the distribution <code>HTML::Tagset</code> again, the rough skeleton suitable for <code>Module::Build</code> having converted the <em>Makefile.PL</em> by <a href="http://search.cpan.org/perldoc?Module::Build::Convert"><code>Module::Build::Convert</code></a> into a <em>Build.PL</em>, the output would be:</p>

<pre><code> # This -*-perl-*- program writes the Makefile for installing this distribution.
 #
 # See "perldoc perlmodinstall" or "perldoc ExtUtils::MakeMaker" for
 # info on how to control how the installation goes.
 # Note: this file has been initially generated by Module::Build::Convert 0.24_01

 require 5.004;
 use strict;
 use warnings;

 use Module::Build;

 my $build = Module::Build-&gt;new
   (
    module_name =&gt; 'HTML::Tagset',
    dist_author =&gt; 'Andy Lester &lt;andy@petdance.com&gt;',
    dist_version_from =&gt; 'Tagset.pm',
    add_to_cleanup =&gt; [
                        'HTML-Tagset-*'
                      ],
    license =&gt; 'unknown',
    create_readme =&gt; 1,
    create_makefile_pl =&gt; 'traditional',
   );
  
 $build-&gt;create_build_script;</code></pre>

<p>As you can see, while <code>ExtUtils::MakeMaker</code> prefers uppercased arguments, <code>Module::Build</code> goes by entirely lowercased arguments, which obey the rule of least surprise by being as intuitive as a description can be.</p>

<p>The build and installation procedure for a <code>Module::Build</code> distribution is:</p>

<pre><code> % perl Build.PL
 % perl Build
 % perl Build test
 # perl Build install</code></pre>

<h3><code>Module::Build::Convert</code>'s State of Operation</h3>

<p><code>Module::Build::Convert</code> actually does all of the background work and can be safely considered the back end, whereas <code>make2build</code> is the practical front-end utility. <code>Module::Build::Convert</code> currently exposes two kinds of operation: static approach and dynamic execution. The static approach parses the arguments contained within the <em>Makefile.PL's</em> <code>WriteMakefile()</code> call, whereas dynamic execution runs the <em>Makefile.PL</em> and captures the arguments provided to <code>WriteMakefile()</code>.</p>

<p><code>Module::Build::Convert</code> parses statically by default, because the dynamic execution has the downside that code will be interpreted and the interpreted output will be written to the <em>Build.PL</em>, so you have to conclude that the user of the distribution will end up with predefined values computed on the author's system. This is something to avoid, whenever possible! If the parsing approach fails, perhaps looping endlessly on input, <code>Module::Build::Convert</code> will reinitialize to perform dynamic execution of the <em>Makefile.PL</em> instead.</p>

<!-- sidebar begins -->
 <csperl file="grab" domain="on" record="b/1748" template="b/article_sidebar2.view">
<!-- sidebar ends -->













<h3><a id="data_section" name="data_section">Data Section</a>
</h3>

<p><code>Module::Build::Convert</code> comes with a rather huge data section containing the argument conversion table, default arguments, sorting order, and begin and end code. If you wish to change this data, consider making a <em>~/.make2buildrc</em> file by launching <code>make2build</code> with the <code>-rc</code> switch. <em>Do not</em> edit the <code>Data</code> section within <code>Module::Build::Convert</code> directly, unless you are sure you want to submit a patch.</p>

<h4>Argument Conversion</h4>

<p>On the left-hand side is the <code>MakeMaker</code>'s argument name, and on the right-hand side the <code>Module::Build</code>'s equivalent.</p>

<pre><code> NAME                  module_name
 DISTNAME              dist_name
 ABSTRACT              dist_abstract
 AUTHOR                dist_author
 VERSION               dist_version
 VERSION_FROM          dist_version_from
 PREREQ_PM             requires
 PL_FILES              PL_files
 PM                    pm_files
 MAN1PODS              pod_files
 XS                    xs_files
 INC                   include_dirs
 INSTALLDIRS           installdirs
 DESTDIR               destdir
 CCFLAGS               extra_compiler_flags
 EXTRA_META            meta_add
 SIGN                  sign
 LICENSE               license
 clean.FILES           @add_to_cleanup</code></pre>

<h4>Default Arguments</h4>

<p>These are default <code>Module::Build</code> arguments to added. Arguments with a leading <code>#</code> are ignored.</p>

<pre><code> #build_requires       HASH
 #recommends           HASH
 #conflicts            HASH
 license               unknown
 create_readme         1
 create_makefile_pl    traditional</code></pre>

<h4>Sorting Order</h4>

<p>This is the sorting order for <code>Module::Build</code> arguments.</p>

<pre><code> module_name
 dist_name
 dist_abstract
 dist_author
 dist_version
 dist_version_from
 requires
 build_requires
 recommends
 conflicts
 PL_files
 pm_files
 pod_files
 xs_files
 include_dirs
 installdirs
 destdir
 add_to_cleanup
 extra_compiler_flags
 meta_add
 sign
 license
 create_readme
 create_makefile_pl</code></pre>

<h4>Begin Code</h4>

<p>Code that precedes converted <code>Module::Build</code> arguments. <code>$(UPPERCASE)</code> are stubs being substituted by <code>Module::Build</code> code.</p>

<pre><code> use strict;
 use warnings;

 use Module::Build;

 $MAKECODE

 my $b = Module::Build-&gt;new
 $INDENT(</code></pre>

<h4>End Code</h4>

<p>Code that follows converted <code>Module::Build</code> arguments. <code>$(UPPERCASE)</code> are stubs being substituted by <code>Module::Build</code> code.</p>

<pre><code> $INDENT);

 $b-&gt;create_build_script;

 $MAKECODE</code></pre>

<h3><code>make2build</code> Basic Usage</h3>

<p>Using <code>make2build</code> is as easy as launching it in the directory of the distribution of which <em>Makefile.PL</em> you wish to convert.</p>

<p>For example:</p>

<pre><code>% make2build</code></pre>

<p>You may also provide the full path to the distribution, assuming, for example, you didn't <code>cd</code> directly into the distribution directory.</p>

<pre><code>% make2build /path/to/HTML-Tagset*</code></pre>

<p>In both cases, the command will convert any found <em>Makefile.PL</em> files and will generate no output because <code>make2build</code> acts quiet by default.</p>

<h3><code>make2build</code> Switches</h3>

<p>As <code>make2build</code> aims to be a proper script, it of course, provides both the <code>-h</code> (help screen) and <code>-V</code> (version) switches.</p>

<pre><code> % make2build -h
 % make2build -V</code></pre>

<p>In case you end up with a mangled <em>Build.PL</em> written, you can examine the parsing process by launching <code>make2build</code> with the <code>-d</code> switch, enabling the pseudo-interactive debugging mode.</p>

<pre><code> % make2build -d</code></pre>

<p>Should you not like the indentation length or judge it to be too small, increase it via the <code>-l</code> switch followed by an integer.</p>

<pre><code> % make2build -l length</code></pre>

<p>If you don't agree with the sorting order predefined in <code>Module::Build::Convert</code>, you may enforce the native sorting order, which strives to arrange standard arguments with those seen available in the <code>Makefile.PL</code>.</p>

<pre><code> % make2build -n</code></pre>

<p>The argument conversion table, default arguments to add, the sorting order of the arguments, and the begin and end code aren't absolute, either. Change them by invoking <code>make2build</code> with the <code>-rc</code> switch to create a resource configuration file in the home directory of the current user; that is likely <em>~/.make2build.rc</em>.</p>

<pre><code> % make2build -rc</code></pre>

<p>While <code>make2build</code> is quiet by default, there are two verbosity levels. To enforce verbosity level 1, launch <code>make2build</code> with <code>-v</code>. To enforce verbosity level 2, use <code>-vv</code>.</p>

<p>With <code>-v</code>, the code will warn about <em>Makefile.PL</em> options it does not understand or skips. With <code>-vv</code>, it will accumulate <code>-v</code> output and the entire generated <em>Build.PL</em>.</p>

<pre><code> % make2build -v
 % make2build -vv</code></pre>

<p>You may execute the <em>Makefile.PL</em> in first place, but such usage is deprecated because <code>Module::Build::Convert</code> downgrades automatically when needed.</p>

<pre><code> % make2build -x (deprecated)</code></pre>













<h3>Swinging with Perl</h3>

<p>Phil Crow</p>

<p>Perl does not have a native graphical user interface (GUI) toolkit. So we use all manner of existing GUI tools in front of our Perl applications. Often we use a web browser. We have long had Perl/Tk and other libraries based on C/C++. Now we can also use Java's Swing toolkit with similar ease.</p>

<p>In my sample application, when the user presses a button, Perl evaluates an arithmetic expression from the input text box. The result appears in another text box. I'll show the code for this application a piece at a time with a discussion after each piece. To see the whole thing, look in the examples directory of the <a href="http://search.cpan.org/perldoc?Java::Swing"><code>Java::Swing</code></a> distribution.</p>

<pre><code>    #!/usr/bin/perl
    use strict; use warnings;

    BEGIN {
        $ENV{CLASSPATH} .= ':/path/to/Java/Swing/java'
    }</code></pre>

<p><code>Java::Swing</code> needs certain Java classes to be in the class path before it loads, so I've appended a path to those classes in a <code>BEGIN</code> block (this block must come before using <code>Java::Swing</code>).</p>

<pre><code>    use Java::Swing;</code></pre>

<p>This innocuous statement magically sets up namespaces for each Java Swing component, among other things.</p>

<pre><code>    my $expression  = JTextField-&gt;new();
    my $answer      = JTextField-&gt;new( { columns =&gt; 10 } );
    my $submit      = JButton   -&gt;new("Evaluate");
    my $frame       = JFrame    -&gt;new();
    my $root_pane   = $frame-&gt;getContentPane();
    my $south_panel = JPanel-&gt;new();</code></pre>

<p>After using <code>Java::Swing</code>, you can refer to Swing components as Perl classes. You can even pass named parameters to their constructors, as shown for the second <code>JTextField</code>.</p>

<pre><code>    $south_panel-&gt;add(JLabel-&gt;new("Answer:"), "West");
    $south_panel-&gt;add($answer,                "Center");
    $south_panel-&gt;add($submit,                "East");

    $root_pane-&gt;add($expression,  "North");
    $root_pane-&gt;add($south_panel, "South");

    $frame-&gt;setSize(300, 100);
    $frame-&gt;show();</code></pre>

<p>Most work with the components is the same as in any Java program. If you don't understand the above code, consult a good book on Swing (like the one from O'Reilly).</p>

<pre><code>    my $swinger = Java::Swing-&gt;new();</code></pre>

<p>This creates a <code>Java::Swing</code> instance to connect event listeners and to control the event loop.</p>

<pre><code>    $swinger-&gt;connect(
        "ActionListener", $submit, { actionPerformed =&gt; \&amp;evaluate }
    );

    $swinger-&gt;connect(
        "WindowListener", $frame, { windowClosing =&gt; \&amp;ending }
    );</code></pre>

<p>Connection is simple. Pass the listener type, the object to listen to, and a hash of code references to call back as events arrive.</p>

<pre><code>    $swinger-&gt;start();</code></pre>

<p>Start the event loop. After this, the program passively waits for event callbacks. It stops when one of the callbacks stops the event loop.</p>

<pre><code>    sub evaluate {
        my $sender_name = shift;
        my $event       = shift;

        $answer-&gt;setText(eval $expression-&gt;getText());
    }</code></pre>

<p>My evaluation is simple. I retrieve the text from the expression <code>JTextField</code>, <code>eval</code> it, and pass the result to <code>setText</code> on the answer <code>JTextField</code>. Using <code>eval</code> raises possible security concerns, so use it wisely.</p>

<pre><code>    sub ending {
        $swinger-&gt;stop();
    }</code></pre>

<p>When the user closes the window, I stop the event loop by calling <code>stop</code> on the <code>Java::Swing</code> instance gained earlier. This kills the program.</p>

<p>With <code>Java::Swing</code>, you can build Swing apps in Perl with some important bits of syntactic sugar. First, you don't need to have separate Java files or inline sections. Second, you can pass named arguments to constructors. Finally, you can easily connect event listeners to Perl callback code.</p>













<h3>Scriptify Your Module</h3>

<p>Josh McAdams</p>

<p>Recently during an MJD talk at Chicago.pm, I saw a little Perl trick that was so amazingly simple and yet so useful that it was hard to believe that more mongers in the crowd hadn't heard of it. The trick involved taking your module and adding a driver routine to it so the module could run as a script.</p>

<p>To illustrate, start with an example module that contains two utility subroutines that convert weights between pounds and kilograms. The subroutines accept some number and multiplies it by a conversion factor.</p>

<pre><code>  package WeightConverter;
  
  use strict;
  use warnings;
  use constant LB_PER_KG =&gt; 2.20462262;
  use constant KG_PER_LB =&gt; 1/LB_PER_KG;
  
  sub kilograms_to_pounds { $_[0] * LB_PER_KG; }
  
  sub pounds_to_kilograms { $_[0] * KG_PER_LB; }</code></pre>

<p>Assuming that the real module has a little error checking and POD, this module would serve you just fine. However, what if you decided that we needed to be able to easily do weight conversions from the command line? One option would be to write a Perl script that used <code>WeightConverter</code>. If that seems like too much effort, there is a one-liner that would do conversions.</p>

<pre><code>  perl -MWeightConverter -e 'print WeightConverter::kilograms_to_pounds(1),"\n"'</code></pre>

<p>This would do the trick, but it is a lot to remember and isn't very fun to type. There is a lot of benefit available from saving some form of script, and believe it or not, the module can hold that script. All that you have to do is write some driver subroutine and then call that subroutine if the module is not being used by another script. Here is an example driver for <code>WeightConverter</code>.</p>

<p>This example driver script just loops through the command-line arguments and tries to find instances where the argument contains either a <code>k</code> or <code>p</code> equal to some value. Based on whether or not you are starting with pounds or kilograms, it calls the appropriate subroutine and prints the results.</p>

<pre><code>  sub run {
    for (@ARGV) {
      if(/^[-]{0,2}(k|p)\w*=(.+)$/) {
        $1 eq 'k' ?
          print "$2 kilograms is ", kilograms_to_pounds($2), " pounds\n" :
          print "$2 pounds is ", pounds_to_kilograms($2), " kilograms\n" ;
      }
    }
  }</code></pre>

<p>Now all that is left is to tell the module to run the <code>run</code> subroutine if someone has run the module on its own. This is as easy as adding one line somewhere in the main body of the module.</p>

<pre><code>  run unless caller;</code></pre>

<p>All this statement does is execute the <code>run</code> subroutine unless the <code>caller</code> function returns a value. <code>caller</code> will only return true if <code>WeightConverter</code> is being used in another script. Now, this module is usable in other scripts as well as on the command line.</p>

<pre><code>  $&gt; perl WeightConverter.pm -kilos=2 -pounds=145 -k=.345
  2 kilograms is 4.40924524 pounds
  145 pounds is 65.7708937051548 kilograms
  .345 kilograms is 0.7605948039 pounds</code></pre>

<h3>Mocks in Your Test Fixtures</h3>

<p>by chromatic</p>

<p>Since writing <code><a
href="http://search.cpan.org/perldoc?Test::MockObject">Test::MockObject</a></code>,
I've used it in nearly every complex test file I've written. It makes my life
much easier to be able to control only what I need for the current group of
tests.</p>

<p>I wish I'd written <code><a
href="http://search.cpan.org/perldoc?Test::MockObject::Extends">Test::MockObject::Extends</a></code>
earlier than I did; that module allows you to decorate an existing object with
a mockable wrapper. It works just as the wrapped object does, but if you add
any mocked methods, it will work like a regular mock object.</p>

<p>This is very useful when you don't want to go through all of the overhead of
setting up your own mock object but do want to override one or two methods.
(It's almost always the right thing to do instead of using
<code>Test::MockObject.</code>.)</p>

<p>Another very useful test module is <code><a
href="http://search.cpan.org/perldoc?Test::Class">Test::Class</a></code>. It
takes more work to understand and to use than <code><a
href="http://search.cpan.org/perldoc?Test::More">Test::More</a></code>, but
it pays back that investment by allowing you to group, reuse, and organize
tests in the same way you would group, reuse, and organize objects in your
code. Instead of writing your tests procedurally, from the start to the end of
a test file, you organize them into classes.</p>

<p>This is most useful when you've organized your code along similar lines.
If you have a base class with a lot of behavior and a handful of subclasses
that add and override a little bit of behavior, write a
<code>Test::Class</code>-based test for the base class and smaller tests
that inherit from the base test for the subclasses.</p>

<p>Goodbye, duplicate code.</p>

<h4>Fixtures</h4>

<p><code>Test::Class</code> encourages you to group related tests into test
methods. This allows you to override and extend those groups of tests in
test subclasses. (Good OO design principles apply here; tests are still
just code, after all.) One of the benefits of grouping tests in this way is
that you can use test fixtures.</p>

<p>A test fixture is another method that runs before every test method. You
can use them to set up the test environment--creating a new object to
test, resetting test data, and generally making sure that tests don't
interfere with each other.</p>

<p>A standard test fixture might resemble:</p>

<pre><code>  sub make_fixture :Test( setup )
  {
      my $self        = shift;
      $self-&gt;{object} = $self-&gt;test_class()-&gt;new();
  }</code></pre>

<p>Assuming that there's a <code>test_class()</code> method that returns
the name of the class being tested, this fixture creates a new instance
before every test method and stores it as the <code>object</code>
attribute. The test methods can then fetch this as normal.</p>

<h4>Putting Them Together</h4>

<p>I recently built some tests for a large system using
<code>Test::Class</code>. Some of the tests had mockable features--they
dealt with file or database errors, for example. I found myself creating a
lot of little <code>Test::MockObject::Extends</code> instances within most
of the tests.</p>

<p>Then inspiration struck. Duplication is bad. Repetition is bad. Factor
it out into one place.</p>

<p>The insight was quick and sudden. If
<code>Test::MockObject::Extends</code> is transparent (and if it isn't,
please file a bug--I'll fix it), I can use it in the test fixture all the
time and then be able to mock whenever I want without doing any setup. I
changed my fixture to:</p>

<pre><code>  sub make_fixture :Test( setup )
  {
      my $self        = shift;
          my $object      = $self-&gt;test_class()-&gt;new();
      $self-&gt;{object} = Test::MockObject::Extends-&gt;new( $object );
  }</code></pre>

<p>The rest of my code remained unchanged, except that now I could delete
several identical lines from several test methods.</p>

<p>Do note that, for this to work, you must adhere to good OO design
principles in the code being tested. Don't assume that <code>ref</code> is
always what you think it should be (and use the <code>isa()</code> method
instead).</p>

<p>Sure, this is a one-line trick, but it removed a lot of busy work from
my life and it illustrates two interesting techniques for managing tests.
If you need simpler, more precise mocks, use
<code>Test::MockObject::Extends</code>. If you need better organization and
less duplication in your test files, use <code>Test::Class</code>. Like all
good test modules, they work together almost flawlessly.</p>


        </div>



    </div>
    <div class="asset-footer"></div>
</div>




                            <div class="content-nav">
                                <a href="/pub/installation/">&laquo; Installation</a> |
                                <a href="/pub/">Main Index</a> |
                                <a href="/pub/archives.html">Archives</a>
                                | <a href="/pub/language-development/">Language Development &raquo;</a>
                            </div>


                        </div>
                    </div>


                    <div id="beta">
    <div id="beta-inner">


    
    <div class="widget-what-is-perl widget">
    <div class="widget-content widget-content-what-is-perl">
       Visit the home of the  Perl programming language: <a href="http://www.perl.org/">Perl.org</a
    </div>
</div>
<div class="widget-find-out-more widget-archives widget">
    <div class="widget-content">
        <ul>
            <li><a href="http://www.perl.org/get.html">Download</a></li>
            <li><a href="http://perldoc.perl.org/">Documentation</a></li>
            <li><a href="http://blogs.perl.org/">Perl Bloggers</a></li>
            <li><a href="http://news.perlfoundation.org/">Foundation News</a></li>
        </ul>
    </div>
</div><div class="widget-tcpc widget">
<h3 class="widget-header">Sponsored by</h3>
    <div class="widget-content">
        <a href="http://training.perl.com/" alt="Perl Training" target="_blank"><img src="/i/tcpc.png" width="150" height="50"></a>
    </div>
</div>

<div class="widget-syndication widget">
    <div class="widget-content">
        <ul>
            <li><img src="/mt-static/images/status_icons/feed.gif" alt="Subscribe to feed" width="9" height="9" /> <a href="/pub/atom.xml">Subscribe to this website's feed</a></li>

        </ul>
    </div>
</div>
<div class="widget-powered widget">
    <div class="widget-content">
        <a href="http://www.movabletype.com/"><img src="/mt-static/images/bug-pbmt-white.png" alt="Powered by Movable Type 5.02" width="120" height="75" /></a>
    </div>
</div>



    </div>
</div>






                </div>
            </div>


            <div id="footer">
    <div id="footer-inner">
        <div id="footer-content">
            <div class="widget-powered widget">
                <div class="widget-content">
                    Powered by <a href="http://www.movabletype.com/" rel="generator">Movable Type Pro</a>
                </div>
            </div>

        </div>
    </div>
</div>



        </div>
    </div>
</body>
</html>
