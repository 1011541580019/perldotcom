<html>
<head><title>This Week on P5P: 10--17 October 1999</title></head>
<body bgcolor="white">

<img src="./7.jpg" align=right>
<h1>This Week on perl5-porters<br>(11--17 October 1999)</h1>

<ul>
<li><a href="#introduction">Introduction</a>
<li><a href="#devel500506">New Development Release 5.005_62</a>
<li><a href="#charclasses">Unicode Character Classes</a>
<li><a href="#bundling">Module Bundling and the proposed <tt>import</tt> pragma</a>
<li><a href="#fields"><tt>use fields</tt> allows overlapping member names</a>
<li><a href="#prepare"><tt>PREPARE</tt> functions and <tt>my Class $foo</tt> delcarations</a>
<li><a href="#goto"><tt>goto</tt> Out of Conditional Bug</a>
<li><a href="#range">Regex Range Bug</a>
<li><a href="#lib"><tt>use lib</tt> change</a>
<li><a href="#pack">More discussion about documentation for <tt>pack</tt></a>
<li><a href="#microperl">MicroPerl</a>
<li><a href="#various">Various</a>
</ul>

<hr>

<h2><a name="introduction">Introduction</a></h2>

<p>This is intended to be a short summary of the major and important
threads of discussion on the perl5-porters mailing list this week.</p>

<p>I am trying to add value to the summary by omitting threads that I
perceive as uninteresting.  For example, you often see threads of this
type:</p>

<dl>
  <dt><b>Person A</b><dd>Here is a problem with Perl when you try to do X. I propose solution S.
  <dt><b>Person B</b><dd>Solution S is unnecessary because you can do Y instead.
  <dt><b>Person A</b><dd>No, that does not work, because of Z.
  <dt><b>Person B</b><dd>Oh, I totally misunderstood what you were doing.
  <dt><b>Person C</b><dd>But solution S will break existing code.
  <dt><b>Person A</b><dd>No, it won't.
  <dt><b>Person C</b><dd>Oh, you're right.  I thought you meant something else.
  <dt><b>Person A</b><dd>Here is a patch to implement solution S.
</dl>

<p>I am going to try to omit these blind alleys. I will also try to
omit some other types of messages:</p>

<dl>
  <dt><b>Person D</b><dd>Why are submitting a patch for S when we know it
  will break old code and anyway you could be doing Y instead?
  <dt><b>Person E</b><dd>Fortran has adopted solution S.  Perl is not
  Fortran; therefore solution S is no good.  If you want Fortran, you
  know where to find it.
  <dt><b>Person F</b><dd>You shut up.
  <dt><b>Person G</b><dd>No, you shut up.
  <dt><b>Person H</b><dd>Your formatting style offends me profoundly.
  Can't you get a real mailer?
  <dt><b>Person I</b><dd>How can I develop CGI scripts offline on my
  W98 machine?
  <dt><b>Person J</b><dd>P5P is not a help desk.
  <dt><b>Person K</b><dd>I am writing to report a bug in the <tt>localtime</tt> function.  It returns the wrong month.
  <dt><b>Person L</b><dd>WORK FROM HOME!!!!
</dl>  

<p>A lot of the stuff I omitted is on topic and has real value, but
isn't particularly interesting.  For example I have omitted a bunch of
cases where someone submitted a minor patch that was accepted with no
discsusion.  I omitted some discussions that did not seem to be of
general interest.  For example, Brad Appleton and Ilya Zakharevich had
an exchange about the pod-formatting features of cperl-mode.</p>

<p>It is hard to keep track of everything, and I may occasionally omit
  something you think is important, or I might misunderstand some
  important issue.  Your additions and emendations are welcome.
  Please send any corrections, suggestions, additions, or
  embellishments to <tt>mjd-perl-thisweek-YYYYMM@plover.com</tt> where <tt>YYYYMM</tt>
  is the current year and month.  For a more complete view of
  perl5-porters, either subscribe to the mailing list or <a
  href="http://www.xray.mpe.mpg.de/mailing-lists/perl5-porters/">check
  the archive</a>.</p>

<p>I wanted to include hot links t othe relevant messages in the
archive,  but the archive was down and I could not get the URLs.
This will be corrected in a future issue, even if we have to start our
own archive.</p>

<h2><a name="devel500506">New Development Release 5.005_62</a></h2>

<p>Sarathy announced the release of development version 5.005_62.  It
is available from <a
href="http://www.perl.com/CPAN/src/perl5.005_62.tar.gz">CPAN</a>.</p>

<p>Changes since 5.005_61 include:</p>

<ul>
<li> more 64-bit enhancements: 64-bit <tt>vec()</tt>, lfs fixes (Jarkko Hietaniemi)
<li> <tt>our</tt> declarations (Larry Wall)
<li> <tt>sub foo : attrs</tt>, <tt>use attrs</tt> deprecated (Spider Boardman)
<li> Configure: new flag <tt>-Accflags=stuff</tt> (Jarkko Hietaniemi)
<li> lvalue subroutines <font color="red">breaks <tt>\(Foo->bar())</tt></font> (Ilya Zakharevich and Tuomas Lukka)
<li> added <tt>File::Glob</tt> (was <tt>File::BSDGlob</tt> from Greg Bacon)
<li> building perl with <tt>-DPERL_INTERNAL_GLOB</tt> will do implicit
    <tt>use File::Glob 'globally'</tt>
<li> <tt>use strict</tt> generates true errors, not fatal warnings
<li> new <tt>-DPERL_Y2KWARN</tt> option for <tt>"19$yr"</tt> and <tt>sprintf "19%d", $yr</tt>
    (Ulrich Pfeifer)
<li> <tt>exists()</tt> works better on pseudo-hashes (Michael Schwern)
<li> warnings on invalid escapes in char ranges (Jarkko Hietaniemi)
<li> comments in <tt>pack</tt> templates allowed (Ilya Zakharevich)
<li> subroutine context could be popped too soon, leading to Tk
    coredumps (Russel O'Connor)
<li> 64bit-safe macros for <tt>int->ptr</tt> and <tt>ptr->int</tt> typecasts (Robin Barker)
<li> fix for <tt>POPSTACK</tt> panics
<li> fixes for memory leaks when is <tt>@_</tt> modified
<li> <tt>%@</tt> "leaks", gone
<li> <tt>END</tt> blocks not run under <tt>-c</tt> switch
<li> <tt>die</tt>/<tt>warn</tt> go to <tt>STDERR</tt>, not <tt>PerlIO_stderr()</tt>
<li> <tt>\C{foo}</tt> has been renamed to <tt>\N{foo}</tt>
<li> <tt>pack</tt> template <tt>Z</tt> always packs a null byte
<li> <tt>POSIX::strftime()</tt> bugs (Spider Boardman and Jan Dubois)
<li> <tt>xsubpp</tt> understands function pointers, undocumented (Ilya Zakharevich)
<li> <tt>h2xs</tt> more selective, and works with opaque types (Ilya Zakharevich)
<li> <tt>use lib</tt> doesn't keep dups
<li> <tt>MakeMaker</tt> support for uninstalled perl, undocumented (Ilya Zakharevich)
<li> <tt>Benchmark</tt> enhancements (Barrie Slaymaker)
<li> warning on <tt>join(/foo/,...)</tt> (Mark-Jason Dominus)
<li> <tt>perlcc</tt> supports other backends (Tom Hughes)
<li> more descriptive diagnostics about opcodes (Michael Schwern)
<li> Unicode database updated to 3.0-ish (unicode.org)
<li> EPOC updates (Olaf Flebbe)
<li> DOS updates (Laszlo Molnar)
<li> VMS updates (Charles Bailey and others)
<li> Win32 updates: Windows 95 support, faster <tt>opendir()</tt>, <tt>use Shell</tt>    support (Benjamin Stuhl, Jochen Wiedmann, Jenda Krynicky and others)
<li> cygwin updates (Eric Fifer and others)
<li> JPL updates (Brian Jepson)
<li> Compiler updates (Vishal Bhatia)
<li> <tt>DB_File</tt> update to 1.71 (Paul Marquess)
<li> <tt>PodParser</tt> update to 1.085 (Brad Appleton)
<li> <tt>pod2text</tt>, <tt>pod2man</tt> replaced by <tt>podlators-0.08</tt> (Russ Allbery)
<li> <tt>Getopt::Long</tt> 2.20 (Johan Vromans)
<li> <tt>perlcompile.pod</tt>, <tt>perlhack.pod</tt> (Nathan Torkington)
<li> lots of pod adjustments
<li> lots of other bug fixes
</ul>

<p>Sarathy also said that he was moving into beta mode for the
upcoming version 5.6.</p>

<h2><a name="charclasses">Unicode Character Classes</a></h2>

<p>Jarkko realized that since Perl was moving into beta mode for 5.6,
this was his last chance to propose a new feature.  He wants Perl
regexes to support the `equivalence class' feature of POSIX 1003.2.
What this means is that certain characters in the character set may be
deemed `equivalent', and the notation <tt>[=<var>c</var>=]</tt>
denotes a character class containing all the characters equivalent to
<tt><var>c</var></tt>.</p>

<p>How do you decide which characters are considered `equivalent'?
Unicode provides a definition that allows you to understand a
character like <tt>&eacute</tt>; as an <tt>e</tt> with an acute
accent; we could have Perl understand this to be equivalent to a plain
<tt>e</tt>.  Then the notation <tt>[=e=]</tt> would match any of
<tt>e</tt>, <tt>&eacute;</tt>, <tt>&egrave;</tt>, <tt>&euml;</tt>, or
<tt>&ecirc;</tt>.  This might be useful.<p>

<p> Jarkko also wants people to be able to define their own
equivalence relations, and he wants the <tt>m//</tt> and <tt>s///</tt>
operators to support a new option, analogous<!-- thanks, Jon --> to
<tt>/i</tt>, which would say to ignore all diacritical marks, again
using the Unicode tables to decide what a diacritical mark is.</p>

<p>People brought up a number of potential problems; for example, in
Danish, the character <tt>&aring;</tt> (U00E5) is considered to be an
entirely different letter from <tt>a</tt> and not equivalent to it at
all.  But according to Unicode, <tt>&aring;</tt> is indeed an
<tt>a</tt> with a diacritical mark.</p>

<p>Discussion continues; I will deliver an update next week if there
is anything to report.  By the way, the <a
href=""http://charts.unicode.org/>Unicode code charts</a> are great
browsing.  <a href="ftp://ftp.unicode.org/Public/UNIDATA/">The
databases that say which characters are composed from which others</a>
are interesting too.</p>

<h2><a name="bundling">Module Bundling and the proposed <tt>import</tt> pragma</a></h2>

<p>Tim Bunce forwarded a message that Michael King had sent to the
<tt>modules@perl.com</tt> mailing list.  Michael had written a new
module, which he named <tt>import</tt>.  The idea of <tt>import</tt> is
this: Suppose you have a bunch of modules that are for internal use at
your company only.  You are worried about namespace collisions with
CPAN modules.  You can name your internal-use modules with names that
all begin with <tt>com::yourcompany</tt> and then use</p>

<pre>
	use import 'com::yourcompany';
</pre>

<p>This does two things.  First, it locates <em>all</em> modules in
the <tt>com::yourcompany</tt> space on the local machine and imports
them all.  But second, it imports each <tt>com::yourcompany::Foo</tt>
module with the <tt>com::yourcompany</tt> part stripped off.  This
means that if, for example, you have a
<tt>com::yourcompany::Template</tt> module, you can now call
<tt>Template->new()</tt> instead of
<tt>com::yourcompany::Template->new()</tt>.   

<p>Michael says that this is like the <tt>import</tt> keyword in
Java.</p>

<p>This touched off a number of interesting discussions:</p>

<ol>
  <li><p>Andreas K&ouml;nig suggested that Perl should support a 
<pre>
	package "www.foo.org";
</pre>

      directive which would be equivalent to <tt>package
      org::foo::www;</tt>.  But Chip Salzenberg said that this was
      usually understood to have been a bad idea, because
      organizations often change URLs for various reasons.  For
      example, <tt>foo.com</tt> and <tt>bar.com</tt> might merge to
      become <tt>foobar.com</tt>.  Says Chip:  <em>One of the best
      things about CPAN is that it is the de facto root namespace for
      all shared Perl modules.  Let's not throw that 
      away!</em> </p>

  <li><p>This led to a general discussion about how entire module
      namespaces might be reserved.</p>

      <p>Damian Conway pointed out that we could
      simply establish the convention that if you have a PAUSE id,
      that module space is reserved for you.  For example, Damian's
      PAUSE id is DCONWAY; under this convention, all modules
      beginning with <tt>DCONWAY::*</tt> would belong to him.</p>

      <p>Problems with this scheme: Uri Guttman would now own the
      <tt>URI::*</tt> space, including the <tt>URI::URL</tt> module.
      Nick Ing-Simmons's PAUSE id is <tt>NI-S</tt>, which is not a
      valid package identifier. </p>

  <li><p>John Redford suggested a module that lets you
      bundle many modules into one.  He says:

<blockquote>Then you could
write a bundling module, like this:

<pre>
                package MyCompany::CGIBundle;
                use MyCompany::CGI::BobsCode::Foo;
                use MyCompany::CGI::Test::Bar;
                use MyCompany::CGI::BobsBetterCode::Foo2;
                ....
                use NameSpace::Transitive;
</pre>

And then people could just write:

<pre>
                use MyCompany::CGIBundle;
</pre>

to get all the symbols that were exported into
<tt>MyCompany::CGIBundle</tt> re-exported into their own namespace.


</blockquote></p>

      <p>I had written a module something like this back in
      February, so I decided that put it on CPAN.  It is now available at <a
      href="http://www.perl.com/CPAN/authors/id/MJD/ModuleBundle-0.01.tar.gz">ModuleBundle-0.01d</a>.
      Nick Ing-Simmons also pointed out that his <tt>Tk::widgets</tt>
      module does something similar:  <tt>use TK::widgets qw(Text
      Entry Canvas)</tt> is equivalent to:</p>

<pre>
	use Tk::Text ();
	use Tk::Entry ();
	use Tk::Canvas();
</pre>

     <p>Nick's message: &lt;199910160922.KAA15935@bactrian.ni-s.u-net.com&gt;</p>

  <li><p>A couple of people wanted the two functions of this module to
  be separated. They liked the idea of being able to alias namespaces,
  so that the objects in <tt>com::yourcompany::Template</tt> could be
  referred to as if they were in <tt>Template</tt>, but they were
  worried about the other function, which is to locate and import a
  whole lot of stuff indiscriminately.  There was some discussion of a
  namespace aliasing pragma, or of adding this functionality to the
  existing <tt>Alias</tt> module.</p>

</ol>

<p>There were also a number of uninteresting discussions: Someone
wanted to know what would happen if you said <tt>use import
'CGI'</tt>.  Michael's answer to that was that that was not what
<tt>import</tt> was for and that whoever did that would get the
bizarre behavior that they deserved.  That did not stop a lot of
people from making a big fuss about it, however.  One person even said
``If you want that functionality, why don't you write a module to do
that?'' apparently having forgotten that the way the discussion
started was that Michael had written a module to do that, notified the
modules list, and then Tim Bunce forwarded his note to P5P.</p>

<p>It appears that Michael is now pursuing a name in the
<tt>Import</tt> namespace, and may make some changes to the module's
calling interface to better seprate the two functions of his
module.</p>

<h2><a name="fields"><tt>use fields</tt> allows overlapping member names</a></h2>

<p>Tuomas Lukka discovered a gotcha in <tt>field.pm</tt>.  The gotcha
is this: Suppose you have a base and a derived class, and both contain
a field with the same name, say <tt>f</tt>.  Suppose the method
<tt>m</tt> is defined in the base class and inherited by the derived
class. Now create an object of the derived class, and call <tt>m</tt>
on the object.  Suppose <tt>m</tt> contains code to modify field
<tt>f</tt>.  There are two fields named <tt>f</tt>.  Which one will be
modified?  </p>

<p>You would expect that, because <tt>m</tt> is defined in the base
class, it should modify the base class's <tt>f</tt>.  And so it does,
if <tt>m</tt> is written correctly:</p>

<pre>
	package Base;

	sub m {
	  my Base $self = shift;
	  $self->{f} = 'newvalue';   # Modifies base class field f
	}
</pre>	

<p>But if you accidentally write <tt>my $self</tt> instead of <tt>my
Base $self</tt>, it modifies the wrong member:</p>

<pre>
	package Base;

	sub m {
	  my $self = shift;
	  $self->{f} = 'newvalue';   # Modifies DERIVED class field f
	}
</pre>	

<p>Tuomas points out that the declaration and use of <tt>$self</tt>
might be very far apart, and that a mistake in a far-away declaration
could introduce a bug in the program that was difficult to find.
Worse, suppose the object was stored inside some other object, so that
instead of <tt>$self->{f}</tt> you had
<tt>$object->{subobject}->{f}</tt>; in this case no declaration at all
applies and you get the same problem.</p>

<p>Tuomas' solution is to simply forbid conflicting field names.  
<tt>fields.pm</tt> and <tt>base.pm</tt> will detect this and throw a
fatal exception if they detect that a derived class is using a member
with the same name as one of its parent classes.</p>

<p>Tuomas's rationale: It is very dangerous at present, and is `action
at a distance', which means that two apparently unrelated delcarations
far away, even in entirely different files, might drastially alter the
behavior of a subroutine in a third location.  The prohibition can be
lifted later if a way is found to make it safer, and nobody appears to
be using it now.  (Someone thought they were, but realized they were
mistaken.)</p>

<p>Sarathy appeared to be persuaded that the situation required at
least a warning.  Tuomas is pushing for a fatal compile-time error.</p>

<h2><a name="prepare"><tt>PREPARE</tt> functions and <tt>my Class $foo</a></tt>
delcarations</h2>

<p>Ilya had submitted a patch which would have made <tt>my Class
$foo;</tt> behave as if you had also written
<tt>Class-&gt;PREPARE($foo)</tt>, if there was such a method.  If you
had <tt>my Class $foo = 'bar'</tt> instead, the assignment would occur
after the <tt>PREPARE</tt> call.
</p>

<p>Sarathy did not like the implementation, for reasons I did not
completely understand.  Sarathy did not like that an <tt>AUTOLOAD</tt>
call would be made at compile time if <tt>PREPARE</tt> was not found
where it was supposed to be.  Ilya did this by analogy with
<tt>DESTROY</tt>, but the compile-time call to <tt>AUTOLOAD</tt> is
peculiar.  (Sarathy: ``Yikes!'')  Sarathy also objected to the way
that the check for <tt>PREPARE</tt> was done at compile time, rather
than at run time; Ilya said he did it that way for efficiency so that
the check would not have to be done every time the declaration was
executed.</p>

<p>Sarathy also complained that even though most uses of <tt>my Class
$foo</tt> would not involve <tt>PREPARE</tt>, the compiler would have
to make an <tt>AUTOLOAD</tt> call for each one of them.  Ilya appeared
to agree that this was a problem.  Sarathy suggested a pragma that
declares the <tt>PREPARE</tt> method for a class.  Ilya pointed out
that if the autloading part was removed from his patch, then the
definition of the <tt>PREPARE</tt> subroutine itself would serve as
exactly such a pragma.</p>


<p>An interesting sidetrack developed: Chip said it would be simpler
in Topaz if the argument to <tt>PREPARE</tt> were <tt>\$foo</tt> rather
than just <tt>$foo</tt>.  Ilya said he did not want to do that because
constructing a reference costs as much as 21 `simple' operations.
What this means is: Perl takes a certain amount of time to dispatch
each operation.  For some `simple' operations, such as performing a
scalar assignment, the time to actually perform the operation is
dominated by the opcode dispatch time, so they all take about the same
amount of time.  Constructing a scalar reference, according to Ilya,
takes 21 times as long as one of these `simple' operations, and
constructing an array reference takes 50 times as long.  Chip was
surprised, and so am I.</p>

<h2><a name="goto"><tt>goto</tt> Out of Conditional Bug</a></h2>

<p>Damien Neil reported a bug in 5.005_03 that is triggered when you
use <tt>goto</tt> out of a conditional block.  He also supplied a
patch.  Watch out for Damien---newcomers who provide core patches are
people to pay attention to.</p>

<p> Sarathy said that this was already fixed in the development
version.  His solution is a little different.  Damien's patch wraps up
each branch of the <tt>if</tt> as a separate block; Sarathy's wraps up
the entire <tt>if</tt> as one block.  Sarathy wants to keep his patch
because it makes the op tree smaller and so the code is faster at run
time.  But he notes that Damien's approach might be better if the
peephole optimizer could be instructed to remove the extra
instructions for blocks that do not contain <tt>goto</tt>.  </p>

<h2><a name="range">Regex Range Bug</a></h2>

<p>Faisal Nasim had trouble with a regex that included <tt>[\w-]</tt>
and <tt>[\w-.]</tt>.  Different versions of Perl behaved differently
for this, depending on whether the <tt>-</tt> was seen as indicating a
range or not.  5.005_03 interpreted it as if you had written
<tt>[\w\-.]</tt>; 5.005_62 generated a syntax error.  (``Invalid
range''.)  This was Jarkko's doing.  Opinions varied about what
behavior was best, especially since the documentation seemed to
support the latter view---but the changed behavior broke old code, as
Faisal pointed out.</p>

<p>Larry suggested making it a warning.  Jarkko thought this was
peachy and put in the patch.  While on the subject, he put in a
warning for use of <tt>\A</tt> etc. in character classes.</p>

<h2><a name="lib"><tt>use lib</tt> change</a></h2>

<p>Tod Irwin wants <tt>use lib 'foo'</tt> to append <tt>foo</tt> to
the front of <tt>@INC</tt> (which it does already) and to also remove
any <em>other</em> appearances of <tt>foo</tt> that happen to be in
<tt>@INC</tt> already.  His motivation:  <tt>mod_perl</tt> scripts
that have <tt>use lib</tt> have <tt>@INC</tt> lists that get longer
and longer and longer.</p>

<p>There were some objections, but the change is in.</p>

<blockquote>
Modules which inject things into <tt>@INC</tt> are highly suspect
beasts - its like lacing the fruit juice with vodka.  (Nick Ing-Simmons)
</blockquote>

<h2><a name="pack">More discussion about documentation for <tt>pack</tt></a></h2>

<p>A discussion about the documentation for <tt>pack</tt> finished
up.  I wouldn't have mentioned this, except:</p>

<blockquote>
<p><b>Sarathy:</b> What would you suggest [the format specifier] <tt>@*</tt> should mean?</p>

<p><b>Ilya:</b> Call the cops.</p>
</blockquote>

<h2><a name="microperl">MicroPerl</a></h2>

<p>This almost slipped by me, but I wrote to ask Ilya what it was
about.  Here's what he said:</p>

<blockquote>
<p>Build Perl without Configure support.  First you build a
bastardized version (nanoperl), use it to build a correctly working
version with some functionality missing (microperl), then use this to
run <tt>Configure.PL</tt> which will make an analogue of
<tt>config.sh</tt>, then you continue with miniperl and perl as
before.</p>

<p>The supplied target crazyperl is <em>very</em> close to become nanoperl of
the above classification.  Minor changes to supplied <tt>micro0/config.sh</tt>
should (when bugs are ironed out) produce a microperl.</p>

<p>Currently crazyperl passes a lot of tests.  This should be improved
yet more (apparently the code <em>is</em> there to support the situation when
no non-portable services are found, but it has some bugs).</p>
</blockquote>

<p>Aren't you glad I asked? I sure am.</p>

<h2><a name="various">Various</a></h2>

<p>Also a large collection of bug reports, bug fixes, questions,
answers, and a small amount of flamage and spam.</p>




<p>Until next week I remain, your humble and obedient servant,<br>

<hr>

<a href="mailto:mjd-perl-thisweek-199910+@plover.com">Mark-Jason Dominus</a>

</body>
</html>