<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" id="sixapart-standard">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="generator" content="Movable Type Pro 5.13-en" />
<link rel="stylesheet" href="/pub/styles.css" type="text/css" />
<link rel="start" href="/pub/" title="Home" />
<link rel="alternate" type="application/atom+xml" title="Recent Entries" href="/pub/atom.xml" />
<script type="text/javascript" src="/pub/mt.js"></script>
<!--
<rdf:RDF xmlns="http://web.resource.org/cc/"
         xmlns:dc="http://purl.org/dc/elements/1.1/"
         xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#">
<Work rdf:about="/pub/2002/09/24/axkit.html">
<dc:title>An AxKit Image Gallery</dc:title>
<dc:description> AxKit is not limited to working with pure XML data. Starting with this article, we&apos;ll work with and around non-XML data by developing an image browser that works with two types of non-XML data: a directory listing built from...</dc:description>
<dc:creator>Barrie Slaymaker</dc:creator>
<dc:date>2002-09-24T00:00:00-08:00</dc:date>
<license rdf:resource="http://creativecommons.org/licenses/by-nc-nd/3.0/" />
</Work>
<License rdf:about="http://creativecommons.org/licenses/by-nc-nd/3.0/">
</License>
</rdf:RDF>
-->

<script type="text/javascript">

 var _gaq = _gaq || [];
 _gaq.push(['_setAccount', 'UA-50555-22']);
 _gaq.push(['_trackPageview']);

 (function() {
   var ga = document.createElement('script'); ga.type =
   'text/javascript'; ga.async = true;
   ga.src = ('https:' == document.location.protocol ? 'https://ssl' :
   'http://www') + '.google-analytics.com/ga.js';
   var s = document.getElementsByTagName('script')[0];
   s.parentNode.insertBefore(ga, s);
 })();

</script>
<script type='text/javascript' src='http://partner.googleadservices.com/gampad/google_service.js'></script>
<script type='text/javascript'>
GS_googleAddAdSenseService("ca-pub-4136420132070439");
GS_googleEnableAllServices();
</script>
<script type='text/javascript'>
GA_googleAddSlot("ca-pub-4136420132070439", "Perl_728x90");
</script>
<script type='text/javascript'>GA_googleFetchAds();</script>
    
    <link rel="prev bookmark" href="/pub/2002/09/p6pdigest/20020922.html" title="This week on Perl 6 (9/16 - 9/22, 2002)" />
    <link rel="next bookmark" href="/pub/2002/09/p6pdigest/20020929.html" title="This week on Perl 6 (9/23 - 9/29, 2002)" />
    
    
    <title>An AxKit Image Gallery - Perl.com</title>
</head>
<body id="perl-com" class="mt-entry-archive layout-wt">
    <div id="container">
        <div id="container-inner">


            <div id="header">
    <div id="header-inner">
        <div id="header-content">
        <span id="top_advert"> 
<!-- Put any landscape advert in here -->
<!-- Perl_728x90 -->
<script type='text/javascript'>
GA_googleFillSlot("Perl_728x90");
</script>
        </span> 



            <div id="header-name"><a href="/pub/" accesskey="1">Perl.com</a></div>
            <div id="header-description">news and views of the Perl programming language</div>




        </div>
    </div>
</div>



            <div id="content">
                <div id="content-inner">


                    <div id="alpha">
                        <div id="alpha-inner">


                            <div id="entry-1362" class="entry-asset asset hentry">
                                <div class="asset-header">
                                    <h1 id="page-title" class="asset-name entry-title">An AxKit Image Gallery</h1>
                                    <div class="asset-meta">
                                        <span class="byline">

                                            By <span class="vcard author">Barrie Slaymaker</span> on <abbr class="published" title="2002-09-24T00:00:00-08:00">September 24, 2002 12:00 AM</abbr>

                                        </span>


                                    </div>
                                </div>
                                <div class="asset-content entry-content">

                                    <div class="asset-body">
                                        
<!-- sidebar begins -->
<!-- don't move sidebars -->
<!-- sidebar ends -->
<p>AxKit is not limited to working with pure XML data.  Starting with
this article, we'll work with and around non-XML data by developing
an image browser that works with two types of non-XML data: a directory
listing built from operating system calls (file names and statistics)
and image files. Furthermore, it will be built from small modules that
you can adapt to your needs or use elsewhere, like the <a href="/pub/a/2002/09/24/axkit.html?page=4#My::Thumbnailer">thumbnail generator</a> or the <a href="/pub/a/2002/09/24/axkit.html?page=3#XML::Filter::TableWrapper">HTML table wrapper</a>.</p>

<p>By the time we're done, several articles from now, we'd like an
application that:</p>

<ul>

  <li>provides navigation around a tree of directories containing images,</li>

  <li>displays <a href="/pub/a/2002/09/24/axkit.html?page=1#proofsheet.png">image galleries with
  thumbnails</a>,</li>

  <li>ignores nonimage files,</li>

  <li>allows you to define and present a custom set of information
  ("meta data") about each image,</li>

  <li>allows you to view the complete images with and without
  metadata,</li>

  <li>uses a non-AxKit mod_perl handler to generate thumbnail images on
  the fly, and</li>

  <li>allows you to edit the metadata information in-browser</li>

</ul>

<p>That feature list should allow us to build a "real world" 
application (rather than the weather examples we've
discussed so far), and hopefully a useful one as well.  Here's a
screenshot of the page created by this article and the next:</p>

<p><a name="proofsheet.png"></a><img src="/pub/2002/09/24/graphics/proofsheet.png" alt="Example page." width="472" height="661" border="0"/></p>

<p>That page has four sections:</p>

<ol>
    <li><b>Heading</b>: Tells you where you are and offers navigation
    up the directory tree.</li>
    <li><b>Folders</b>: links to the parent directory and any sub
    folders (Jim and Mary).</li>
    <li><b>Images</b>: offers a thumbnail and caption area for
    each image.  Clicking on an image or image title takes you to
    the full-size variant.</li>
    <li><b>Footer</b>: A breadcrumbs display for getting back up the
    directory tree after scrolling down through a large page of
    images.</li>
</ol>

<p>We'll implement the (most challenging) third section in this article
and the other section in the next article.</p>

<p>If you want to review the basics of AxKit and Apache configuration,
then here are the previous articles in this series:</p>

<ul>
    <li><a href="/pub/a/2002/03/12/axkit.html">Introducing
    AxKit</a></li>
    <li><a href="/pub/a/2002/04/16/axkit.html">XSP,
    Taglibs and Pipelines</a></li>
    <li><a href="/pub/a/2002/07/02/axkit.html">Taglib TMTOWTDI</a></li>
</ul>

<a name="WorkingWithNonXMLDataAsXML"/><h3>Working with non-XML data as XML</h3>

<p>The easiest way to actually work with non-XML data in AxKit is 
to turn it in to XML often and feed it to AxKit.  AxKit itself takes this
approach in its new directory handling feature -- thanks to Matt Sergeant
and J&ouml;rg Walters AxKit can now scan the directory and build an XML
document with all of the data.  This is a lot like what native Apache
does when it serves up an HTML directory listing, but it allows
you to filter it.  The main part of this article is about
filtering this directory listing in order to create a gallery, or
proofsheet, of thumbnail images.</p>

<!--  begin sidebar  -->
<table width="50%" border="0" cellspacing="8" cellpadding="8"  align="right">
<tr><td valign="top" bgcolor="#efefef">
<p class="medlist"><b>In This Series</b></p>
<p class="smalllist"><b>
<a href="/pub/a/2002/03/16/axkit.html">Introducing AxKit</a></b><br />
The first in a series of articles by Barrie Slaymaker on setting up and running
AxKit. AxKit is a mod_perl application for dynamically transforming XML. In this
 first article, we focus on getting started with AxKit.</p>
<p class="smalllist"><b>
<a href="/pub/a/2002/04/16/axkit.html">XSP, Taglibs and Pipelines</a></b><br />
Barrie explains what a "taglib" is, and how to use them to create dynamic pages
inside of AxKit.</p>
<p class="smalllist"><b><a href="/pub/a/2002/07/02/axkit.html">Taglib TMTOWTDI</a></b><br />
Continuing our look at AxKit tag libraries, Barrie explains the use of SimpleTaglib and LogicSheets.</p>
</td></tr>
</table>
<!--  end sidebar  -->

<p>In this case, we'll be using a relatively recent addition to AxKit's
standard toolkit, SAX Machines, integrated in to AxKit thanks to Kip
Hampton. (disclaimer: <a href="http://search.cpan.org/author/RBS/XML-SAX-Machines/lib/XML/SAX/Machines.pm">XML::SAX::Machines</a>
is a module I wrote.) The SAX machine we'll create will be a straight
pipeline with a few filters, a lot like the pipelines that AxKit uses.
This pipeline will dissect directory listings and generate a list of
images segmented into rows for easy display purposes.  We don't get in
to the details of SAX or SAX machines except to bolt together three
building blocks; all of the gory details are handled for us by other
modules.  If you are interested in the gory details, then see <a href="http://xml.com/pub/a/2002/02/13/sax-machines.html">Part One</a>
and <a href="http://xml.com/pub/a/2002/03/20/machines.html">Part Two</a>
of Kip's article "Introducing XML::SAX::Machines" on <a href="http://xml.com/">XML.com</a>.</p>

<p>After the SAX machine builds our list of images, XSLT will be used to
merge in metadata (like image titles and comments) from independant XML
files and format the result for the browser.  The resulting pages look
like:</p>


<a name="ManagingNonXMLData"/><h3>Managing non-XML data (the images)</h3>

<p>On the other hand, it doesn't make sense to XMLify raw image data (though things like <a href="http://www.w3.org/TR/SVG/">SVG</a>--covered in <a href="http://www.xml.com/pub/q/sacresvg">XML.com's Sacre SVG
articles</a>--and <a href="http://www.lysator.liu.se/~alla/dia/">dia</a>
files are a natural fit), so we'll take advantage of AxKit's integration
with Apache and mod_perl to delegate image handlng to these more suitable
tools.</p>

<p>This is done by using a distinctive URL for thumbnail image files and
a custom mod_perl handler, <a href="/pub/a/2002/09/24/axkit.html?page=4#My::Thumbnailer">My::Thumbnailer</a> to convert full-size images
to thumbnails.  Neither AxKit nor mod_perl code will be used to serve
the images, that will be left to Apache.</p>

<p>Thumbnails will be autogenerated in files with the same name as the
main image file with a leading period (".") stuck on the front.  In Unix
land, this indicates a hidden file, and we don't want thumbnails (or other
dotfiles) showing up in our gallery pages.</p>

<p>My::Thumbnailer uses the relatively new <a href="http://search.cpan.org/author/ADDI/Imager/Imager.pm">Imager</a>
module by Arnar M. Hrafnkelsson and Tony Cook.  This is a best-of-breed
module that competes with the likes of the venerable <a href="http://search.cpan.org/author/LDS/GD/GD.pm">GD</a>, the juggernaut
<a href="http://search.cpan.org/author/JCRISTY/PerlMagick/Magick.pm">Image::Magick</a>,
and <a href="http://search.cpan.org/author/JLAPEYRE/libplot-perl/Libplot.pm">Graphics::Libplot</a>).
Imager is gaining a reputation for speed, quality and a full-featured
API.</p>


<csperl file="include_from_orn" record="b/708" template="b/article_sidebar2.view">



<a name="TheMetaFile" /><h3>The <code>.meta</code> file</h3>

<p>Before we delve in to the implementation, let's look at one of the
more subtle points of this design.  Our previous examples have all been
of straight pipelines that successively process a source document into
an HTML page.  In this application, however, we'll be funneling data
from the source document and a collection of related files we'll call
meta files.</p>

<p>This subtlety is not apparent from the <a href="/pub/a/2002/09/24/axkit.html?page=1#proofsheet.png">screenshot</a>, but if you look closely you can
see that the caption for the first image ("A baby picture") contains
more information than the captions for the other eight.  This is because
the first image has a meta file that contains a title and a comment to
be displayed while the others don't (though they could).</p>

<p> The first image ("A baby picture") is from a file named
<code>a-look.jpeg</code>, for which there is a meta file named
<code>a-look.meta</code> in the same directory that looks like
(<b>bold</b> shows the data that ends up getting sent to the
browser):</p>

<a name="a-look.meta"/>
<pre><code>    &lt;meta&gt;
      &lt;title&gt;<b>A baby picture</b>&lt;/title&gt;
      &lt;comment&gt;
        <b>&lt;b&gt;ME!&lt;/b&gt;.  Well, not really.  Actually, it's some
        random image from the 'net.</b>
      &lt;/comment&gt;
    &lt;/meta&gt;</code></pre>

<p>An important feature of this file is that its contents and how they
are presented within the caption area are completely unspecified by the
core image gallery code.  This makes our image gallery highly
customizable: the site designer can determine what meta information
needs to be associated with each image and how that information gets 
presented.  Data can be presented in the thumbnail caption, in the
expanded view, or used for nondisplay purposes.</p>

<p>Here's what's in each caption area:</p>

<ol>

  <li><b>The title</b>.  If a .meta file is found for an image and it
  has a nonempty <code>&lt;title&gt;</code> element, then it is used
  as the name, otherwise the image's filename is stripped of extensions
  and used.</li>

  <li><b>The last modified time of the image file</b> (in server-local
  time, unfortunately).</li>

  <li><b>A comment</b> (optional): if a .meta file has a
  <code>&lt;comment&gt;</code> element, including XHTML markup, it is
  displayed.</li>

</ol>

<p>Why a .meta file per image instead of one huge file? It will
hopefully allow admins to manage images and meta files together and to
allow us to access an image's meta information in a single file, a
natural thing to do in AxKit.  By having a pair of files for each image,
you can use simple filesystem manipulations to move them around, or use
filesystem links to make an image appear in multiple directories,
perhaps with the same meta file, perhaps with different ones.  This way
we don't need to develop a lot of complex features to get a lot of
mileage out of our image gallery (though we could if need be).</p>


<a name="ThePipeline" /><h3>The Pipeline</h3>

<p>No AxKit implementation documentation would be complete without
detailing the pipeline.  Here is the pipeline for the image proofsheet
page shown above (click on any of the boxes to take you to the
discussion about that portion of the pipeline, click on any of the
miniature versions of this diagram to come to this one):</p>

<a name="pipeline.png"></a>
<table width="450" border="0" cellspacing="0" cellpadding="0"><tr><td>
<p class="secondary"><img src="/pub/2002/09/24/graphics/pipeline.png" alt="The AxKit pipeline for the image gallery application, take 1" width="450" height="385" border="0" USEMAP="pipeline_png_map" /><br />
<MAP name="pipeline_png_map" id="pipeline_png_map">
<!-- #$-:Image Map file created by GIMP Imagemap Plugin -->
<!-- #$-:GIMP Imagemap Plugin by Maurits Rijk -->
<!-- #$-:Please do not edit lines starting with "#$" -->
<!-- #$VERSION:1.3 -->
<!-- #$AUTHOR:barries -->
<AREA SHAPE="RECT" COORDS="0,0,71,100" href="/pub/a/2002/09/24/axkit.html?page=2#filelist" alt="The &lt;filelist&gt; document generated by AxKit">
<AREA SHAPE="RECT" COORDS="87,43,186,69" href="/pub/a/2002/09/24/axkit.html?page=2#My::Filelist2Data" alt="My::Filelist2Data. Converts the <filelist> to a Perl data structure">
<AREA SHAPE="RECT" COORDS="201,43,280,69" href="/pub/a/2002/09/24/axkit.html?page=3#My::ProofSheet" alt="My::ProofSheet.  Takes the Perl data structure and generates a list of images with some metadata">
<AREA SHAPE="RECT" COORDS="297,43,390,70" href="/pub/a/2002/09/24/axkit.html?page=3#XML::Filter::TableWrapper" alt="XML::Filter::TableWrapper.  Segments the list of images in to rows suitable for use in an HTML &lt;table&gt;">
<AREA SHAPE="RECT" COORDS="73,0,408,82" href="/pub/a/2002/09/24/axkit.html?page=2#My::ProofSheetMachine" alt="My::ProofSheetMachine.  A SAX machine containing 3 SAX filters">
<AREA SHAPE="RECT" COORDS="62,219,146,358" href="/pub/a/2002/09/24/axkit.html?page=3#rowsplitter.xsl" alt="rowsplitter.xsl.  Converts each row of thumbnail metadata in to two rows, one for images, the other for captions">
<AREA SHAPE="RECT" COORDS="147,218,221,384" href="/pub/a/2002/09/24/axkit.html?page=3#metamerger.xsl" alt="metamerger.xsl.  Adds in the external .meta files, if they exist">
<AREA SHAPE="RECT" COORDS="105,123,267,199" href="/pub/a/2002/09/24/axkit.html#TheMetaFile" alt=".meta files for the images">
<AREA SHAPE="RECT" COORDS="226,219,302,358" href="/pub/a/2002/09/24/axkit.html?page=4#captionstyler.xsl" alt="captionstyler.xsl.  Converts the captions to XHTML">
<AREA SHAPE="RECT" COORDS="306,218,386,382" href="/pub/a/2002/09/24/axkit.html?page=4#pagestyler.xsl" alt="pagestyler.xsl.  Converts the main part of the page to XHTML">
<AREA SHAPE="RECT" COORDS="391,208,449,292" href="/pub/a/2002/09/24/axkit.html?page=1#proofsheet.png" alt="the final output">
</MAP>
The blue documents are content: the directory listing, the meta files and the generated HTML.  This does not show the image processing, see <a href="/pub/a/2002/09/24/axkit.html?page=4#My::Thumbnailer">My::Thumbnailer</a> for that.</p>

</td></tr></table>

<p>In this case, unlike our previous pipelines, data does not flow in a
purely linear fashion: The directory listing from AxKit (<a href="/pub/a/2002/09/24/axkit.html?page=2#filelist">&lt;filelist&gt;</a>) feeds the pipeline and is
massaged by three SAX filters and then by four XSLT filters.  There are so many
filters because this application is built to be customizable by tweaking
specific filters or by adding other filters to the pipeline.  It also
uses several SAX filters available on CPAN to make life
much easier for us.</p>

<p>In actual use, you may want to add more filters for things like
branding, distinguishing groups of images by giving directory
heirarchies different backgrounds or titles, adding ad banners, etc.</p>
  
<p>Here's a brief description of what each filter does, and why each is
an independant filter:</p>

<ul>

  <li><a href="/pub/a/2002/09/24/axkit.html?page=2#My::ProofSheetMachine">My::ProofSheetMachine</a> is a
  short module that builds a <a href="http://search.cpan.org/author/RBS/XML-SAX-Machines/lib/XML/SAX/Machines.pm#DESCRIPTION">SAX
  Machine Pipeline</a>.  SAX filters are used in this application to
  handle tasks that are more suited to Perl than to XSLT or XSP:

    <ul>

      <li><a href="/pub/a/2002/09/24/axkit.html?page=2#My::Filelist2Data">My::FileList2Data</a> is another
      short module that uses the <a href="http://search.cpan.org/author/GRANTM/XML-Simple/Simple.pm">XML::Simple</a>
      module from CPAN to convert the <code>&lt;filelist&gt;</code> in
      to a Perl data structure that is passed on.  This is its own
      filter because we want to customize XML::Simple and the resulting
      data structure a bit before passing it on.</li>

      <li><a href="/pub/a/2002/09/24/axkit.html?page=3#My::ProofSheet">My::ProofSheet</a> is the heart of
      the gallery page generation.  It builds a list of images from the
      filelist data structure and adds information about the
      thumbnail images and meta files.</li>

      <li><a href="/pub/a/2002/09/24/axkit.html?page=3#XML::Filter::TableWrapper">XML::Filter::TableWrapper</a>
      is a module from CPAN
      that is used to wrap a possibly lengthy list of images into rows
      of no more than five images each.</li>

    </ul>

  </li>

  <li><a href="/pub/a/2002/09/24/axkit.html?page=3#rowsplitter.xsl">rowsplitter.xsl</a> takes each row of images and makes it
  into two table rows: one for the images and one for the captions.
  This is easier to do in XSLT than in SAX, so here is where we shift
  from SAX processing to XSLT processing.</li>

  <li><a href="/pub/a/2002/09/24/axkit.html?page=3#metamerger.xsl">metamerger.xsl</a> examines each caption
  to see if My::ProofSheet put the URL for a meta file in it.  If so, it
  opens the meta file and inserts it in the caption.  This is a separate
  filter because the site admin may prefer to write a custom filter here
  to integrate meta information from some other source, like a single
  master file or a centralized database.</li>

  <li><a href="/pub/a/2002/09/24/axkit.html?page=4#captionstyler.xsl">captionstyler.xsl</a> looks at each
  caption and rewrites it to be XHTML.  This is a separate filter for
  two reasons: it allows the look and feel of the captions to be altered
  without having to mess with the other filters and, because it is the
  only filter that cares about the contents of the meta file, the site
  admin can alter the schema of the meta files and then alter this
  filter to match.</li>

  <li><a href="/pub/a/2002/09/24/axkit.html?page=4#pagestyler.xsl">pagestyler.xsl</a> converts everything
  outside of the caption elements in to HTML.  It is separate so that
  the page look and feel can be altered per-site or per-directory
  without affecting the caption content, etc.</li> </ul>

<p>There are several key things to note about this design.  The first is
that the separation of the process into multiple filters offers the
administrator the ability to modify the site's content and styling.
Second, because AxKit is built on Apache's configuration engine, which
filters are used for a particular directory request can be selected
based on URL, directory path, query string parameters, browser types,
etc.  The third point to note is the use of SAX processors to handle
tasks that are easier (far easier in some cases) to implement in Perl,
while XSLT is used when it is more (programmer and/or processor)
efficient.</p>














<a name="httpd.conf"></a><a name="TheConfiguration"></a><h3>The Configuration</h3>

<p>Here's how we configure AxKit to do all of this:</p>

<pre><code>    ##
    ## Init the httpd to use our "private install" libraries
    ##
    PerlRequire startup.pl

    ##
    ## AxKit Configuration
    ##
    PerlModule AxKit

    &lt;Directory "/home/me/htdocs"&gt;
        Options -All +Indexes +FollowSymLinks

        # Tell mod_dir to translate / to /index.xml or /index.xsp
        DirectoryIndex index.xml index.xsp
        AddHandler axkit .xml .xsp

        AxDebugLevel 10

        AxTraceIntermediate /home/me/axtrace

        AxGzipOutput Off

        AxAddXSPTaglib AxKit::XSP::Util
        AxAddXSPTaglib AxKit::XSP::Param

        AxAddStyleMap text/xsl \
                      Apache::AxKit::Language::LibXSLT

        <b>AxAddStyleMap application/x-saxmachines \
                      Apache::AxKit::Language::SAXMachines</b>

    &lt;/Directory&gt;

    <b>
    &lt;Directory "/home/me/htdocs/04"&gt;
        </b><font color="#000000"># Enable XML directory listings (see <a href="/pub/a/2002/09/24/axkit.html?page=2#filelist">Generating File Lists</a>)</font><b>
        AxHandleDirs On

        </b><font color="#000000">#######################</font><b>
        </b><font color="#000000"># Begin pipeline config</font><b>
        AxAddRootProcessor application/x-saxmachines . \
            {http://axkit.org/2002/filelist}filelist
        PerlSetVar AxSAXMachineClass "<a href="/pub/a/2002/09/24/axkit.html?page=2#My::ProofSheetMachine">My::ProofSheetMachine</a>"

        </b><font color="#000000"># The absolute stylesheet URLs are because</font><b>
        </b><font color="#000000"># I prefer to keep stylesheets out of the</font><b>
        </b><font color="#000000"># htdocs for security reasons.</font><b>
        AxAddRootProcessor text/xsl <a href="/pub/a/2002/09/24/axkit.html?page=3#rowsplitter.xsl">file:///home/me/04/rowsplitter.xsl</a> \
            {http://axkit.org/2002/filelist}filelist

        AxAddRootProcessor text/xsl <a href="/pub/a/2002/09/24/axkit.html?page=3#metamerger.xsl">file:///home/me/04/metamerger.xsl</a> \
            {http://axkit.org/2002/filelist}filelist

        AxAddRootProcessor text/xsl <a href="/pub/a/2002/09/24/axkit.html?page=4#captionstyler.xsl">file:///home/me/04/captionstyler.xsl</a> \
            {http://axkit.org/2002/filelist}filelist

        AxAddRootProcessor text/xsl <a href="/pub/a/2002/09/24/axkit.html?page=4#pagestyler.xsl">file:///home/me/04/pagestyler.xsl</A> \
            {http://axkit.org/2002/filelist}filelist
        </b><font color="#000000"># End pipeline config</font><b>
        </b><font color="#000000">#####################</font><b>

        </b><font color="#000000"># This is read by <a href="/pub/a/2002/09/24/axkit.html?page=2#My::ProofSheetMachine">My::ProofSheetMachine</a></font><b>
        PerlSetVar MyColumns 5

        </b><font color="#000000"># This is read by <a href="/pub/a/2002/09/24/axkit.html?page=3#My::ProofSheet">My::ProofSheet</a></font><b>
        PerlSetVar MyMaxX 100

        </b><font color="#000000"># Send thumbnail image requests to our</font><b>
        </b><font color="#000000"># thumbnail generator</font><b>
        &lt;FilesMatch "^\."&gt;
            SetHandler  perl-script
            PerlHandler My::Thumbnailer
            PerlSetVar  MyMaxX 100
            PerlSetVar  MyMaxY 100
        &lt;/FilesMatch&gt;
        
    &lt;/Directory&gt;</b></code></pre>

<p>The first <code>&lt;Directory&gt;</code> section contains the AxKit
directives we introduced in <a href="/pub/a/2002/07/02/axkit.html?page=2#MixingAndMatching">article
1</a> and a new stylesheet mapping for
<code>application/x-saxmachines</code> that allows us to use a SAX machine in
the pipeline.  Otherwise, all of the configuration directives key to
this example are in the <code>&lt;Directory
"/home/me/htdocs/04"&gt;</code> section.</p>

<blockquote><p>We saw basic examples of how AxKit works with the Apache
configuration engine in <a href="/pub/a/2002/07/02/axkit.html?page=2#MixingAndMatching">article
1</a> and <a href="/pub/a/2002/04/16/axkit.html#httpd.conf">article
2</a> in this series.  We'll use this photo gallery application to
demonstrate many of the more powerful mechanisms in a future article.</p>
</blockquote>

<p>By setting <code>AxHandleDirs On</code>, we tell AxKit to generate
the &lt;filelist&gt; document (<a href="/pub/a/2002/09/24/axkit.html?page=2#GeneratingFileLists">described in the section
Generating File Lists</a>) in the 04
directory and below.</p>

<p>Then it's off to configure the pipeline for the 04 directory
hierarchy.  To do this, we take advantage of the fact that AxKit places
all elements in the filelist document in to the namespace
<code>http://axkit.org/2002/filelist</code>.  The
<code>AxAddRootProcessor</code>'s third parameter causes AxKit to look
at all documents it serves from the 04 directory tree and check to see
whether the root element matches the namespace and element name.</p>

<blockquote>
<p>This is specified in the notation used
by James Clark in his <a href="http://www.jclark.com/xml/xmlns.htm">introduction to XML
namespaces</a>.</p>
</blockquote>

<p>If the document matches, and all AxKit-generated filelists will, then
the MIME type and the stylesheet specified in the first two parameters
are added to the pipeline.  The four <code>AxAddRootProcessor</code>
directives add the SAX machine and the four XSLT filters we described in
<a href="/pub/a/2002/09/24/axkit.html#ThePipeline">the section "The Pipeline"</a>.</p>

<p>When loading a SAX machine into the pipeline, you can give it a
simple list of SAX filters (<a href="http://search.cpan.org/search?mode=module&amp;query=XML%3A%3AFilter">there are many available on
CPAN</a>) and it will build a pipeline of them.  This is done with a
(not shown) <code>PerlSetVar AxSAXMachineFilters "..."</code> directive.
The limitation with this directive is that you cannot pass in any
initialization values to the filters and we want to.</p>

<p>So, instead, we use the <code>PerlSetVar AxSAXMachineClass
"My::ProofSheetMachine"</code> to tell the
Apache::AxKit::Language::SAXMachines module to load the class
<a href="/pub/a/2002/09/24/axkit.html?page=2#My::ProofSheetMachine">My::ProofSheetMachine</a>
and let that class construct the SAX machine.</p>

<p>The final part of the configuration uses a <code>&lt;Files&gt;</code>
section to forward all requests for thumbnail images to the mod_perl
handler in <a href="/pub/a/2002/09/24/axkit.html?page=4#My::Thumbnailer">My::Thumbnailer</a>.</p>

<a name="WalkingThePipeline" /><h3>Walking the Pipeline</h3>

<p>Now that we have our filters in place, let's walk the pipeline and
take a look at each filter and what it emits.</p>

<a name="filelist"/>
<a name="GeneratingFileLists" /><h4>Generating File Lists</h4>

<p><a name="pipeline_filelist.png"  href="/pub/a/2002/09/24/axkit.html#pipeline.png"><img src="/pub/2002/09/24/graphics/pipeline_filelist.png" alt="&lt;filelist&gt; document's position in the processing pipeline" width="110" height="84" border="0" align="right"/></a></p>

<p>First, here's a look at the <code>&lt;filelist&gt;</code> document that
feeds the chain.  This is created by AxKit when it serves a directory
request in much the same way that Apache creates HTML directory
listings.  AxKit only generates these pages when <code>AxHandleDirs
On</code> directive.  This causes AxKit to scan the directory for the
above screenshot and emit XML like (whitespace added, repetitive stuff
elided):</p>

<pre><code>    &lt;?xml version="1.0" encoding="UTF-8"?&gt;
    &lt;!DOCTYPE filelist PUBLIC
      "-//AXKIT/FileList XML V1.0//EN"
      "file:///dev/null"
    &gt;
    &lt;filelist xmlns="http://axkit.org/2002/filelist"&gt;
      &lt;directory
        atime="1032276941"
        mtime="1032276939"
        ctime="1032276939"
        readable="1"
        writable="1"
        executable="1"
        size="4096" &gt;.&lt;/directory&gt;
      &lt;directory ...&gt;<b>..</b>&lt;/directory&gt;
      &lt;directory ...&gt;<b>Mary</b>&lt;/directory&gt;
      &lt;directory ...&gt;<b>Jim</b>&lt;/directory&gt;
      &lt;file <b>mtime="1031160766"</b> ...&gt;a-look.jpeg&lt;/file&gt;
      &lt;file <b>mtime="1031160787"</b> ...&gt;<b>a-lotery</b>.jpeg&lt;/file&gt;
      &lt;file <b>mtime="1031160771"</b> ...&gt;<b>a-lucky</b>.jpeg&lt;/file&gt;
      &lt;file <b>mtime="1032197214"</b> ...&gt;a-look.meta&lt;/file&gt;
      &lt;file <b>mtime="1035239142"</b> ...&gt;foo.html&lt;/file&gt;
      ...
    &lt;/filelist&gt;</code></pre>

<p>The emboldened bits are the pieces of data we want to display: some
filenames and their modification times.  Some things to notice:
</p>
<ul>

<li>All of the elements -- most importantly the root element as we'll see
in a bit -- are in a special namespace,
<code>http://axkit.org/2002/filelist</code>, using the
<code>xmlns=</code> attribute (see <a href="http://www.jclark.com/xml/xmlns.htm">James Clark's
introduction</a> for details).</li>

<li>The entries are in unsorted order.  We might want to allow the
user to sort by different attributes someday, but this means that we at
least need to sort the results somehow.</li>

<li>They contain the complete output from the <code>stat()</code> system
call as attributes, so we can use the <code>mtime</code> attribute to
derive a modification time.</li>

<li>There are
files in there (<code>a-look.meta</code> and <code>foo.html</code>) that
we clearly should not be displayed as images.</li>

<li>The filename for <code>a-look.jpeg</code> is not emboldened: We'll
use the <code>&lt;title&gt;</code> element from the
<code>a-look.meta</code> file instead.</li>

</ul>

<pre><code>    &lt;?xml version="1.0" encoding="UTF-8"?&gt;
    &lt;!DOCTYPE filelist PUBLIC
      "-//AXKIT/FileList XML V1.0//EN"
      "file:///dev/null"
    &gt;
    &lt;filelist xmlns="http://axkit.org/2002/filelist"&gt;
      &lt;directory
        atime="1032276941"
        mtime="1032276939"
        ctime="1032276939"
        readable="1"
        writable="1"
        executable="1"
        size="4096" &gt;.&lt;/directory&gt;
      &lt;directory ...&gt;<b>..</b>&lt;/directory&gt;
      &lt;directory ...&gt;<b>Mary</b>&lt;/directory&gt;
      &lt;directory ...&gt;<b>Jim</b>&lt;/directory&gt;
      &lt;file <b>mtime="1031160766"</b> ...&gt;a-look.jpeg&lt;/file&gt;
      &lt;file <b>mtime="1031160787"</b> ...&gt;<b>a-lotery</b>.jpeg&lt;/file&gt;
      &lt;file <b>mtime="1031160771"</b> ...&gt;<b>a-lucky</b>.jpeg&lt;/file&gt;
      &lt;file <b>mtime="1032197214"</b> ...&gt;a-look.meta&lt;/file&gt;
      &lt;file <b>mtime="1035239142"</b> ...&gt;foo.html&lt;/file&gt;
      ...
    &lt;/filelist&gt;</code></pre>

<a name="My::ProofSheetMachine" /></a><h4>My::ProofSheetMachine</h4>

<p><a name="pipeline_proofsheetmachine_pm.png" href="/pub/a/2002/09/24/axkit.html#pipeline.png"></a>
<img src="/pub/2002/09/24/graphics/pipeline_proofsheetmachine_pm.png" alt="My::ProofSheetMachine's position in the processing pipeline." width="110" height="84" border="0" align="right"/></p>

<p>The processing pipeline is kicked off with a set of three SAX filters built by the My::ProofSheetMachine module:</p>


<pre><code>    package My::ProofSheetMachine;
    
    use strict;
    
    use XML::SAX::Machines qw( Pipeline );
    use My::ProofSheet;
    use XML::Filter::TableWrapper;
    
    sub new {
        my $proto = shift;
        return bless {}, ref $proto || $proto;
    }
    
    sub get_machine {
        my $self = shift;
        my ( $r ) = @_;
    
        my $m = Pipeline(
            <a href="/pub/a/2002/09/24/axkit.html?page=2#My::Filelist2Data">My::Filelist2Data</a>
            => <a href="/pub/a/2002/09/24/axkit.html?page=3#My::ProofSheet">My::ProofSheet</a>->new( Request => $r ),
            => <a href="/pub/a/2002/09/24/axkit.html?page=3#XML::Filter::TableWrapper">XML::Filter::TableWrapper</a>->new(
                ListTags => "{}images",
                Columns  => $r->dir_config( "MyColumns" ) || 3,
            ),
        );
    
        return $m;
    }
    
    1;</code></pre>

<p>This module provides a minimal constructor, <code>new()</code> so it
can be instantiated (this is an Apache::AxKit::Language::SAXMachines
requirement, we don't need that for our sake).  AxKit will call the
<code>get_machine()</code> method once each request to obtain the SAX
machine is used.  SAX machines are not reused from request to request.</p>

<p><code>$r</code> is a reference to the <a href="http://search.cpan.org/author/JIMW/libapreq/Request/Request.pm">Apache
request</a> object (well, actually, to an AxKit subclass of it).  This
is passed into 
<a href="/pub/a/2002/09/24/axkit.html?page=3#My::ProofSheet">My::ProofSheet</a>, which uses to interact
query some <a href="/pub/a/2002/09/24/axkit.html?page=2#httpd.conf">httpd.conf</a> settings, to control
AxKit's cache, and to probe the filesystem through Apache.</p>

<p><code>$r</code> is also queried in this module to see whether there is a
<code>MyColumns</code> setting for this request, with a default
in case, it's not.  The <code>ListTags</code> setting tells <a href="/pub/a/2002/09/24/axkit.html?page=3#XML::Filter::TableWrapper">XML::Filter::TableWrapper</a> to
segment the image list produced by the first two filters into rows of
images (preparing it to be an HTML table, in other words).</p>

<p>The need to pass parameters like this to the SAX filters is the sole
reason we're using a SAX machine factory class like this.  This class is
specified by using <code>PerlSetVar AxSAXMachineClass</code>; if we
didn't need to initialize the filters like this, then we could have listed
them in a <code>PerlSetVar AxSAXMachineFilters</code> directive.  For
more details on how SAX machines are integrated with AxKit, see <a href="http://search.cpan.org/author/MSERGEANT/AxKit/lib/Apache/AxKit/Language/SAXMachines.pm">the
man page</a></p>

<p>Currently, only one SAX machine is allowed in an AxKit pipeline at a
time (though different pipelines can have different machines in them).
This is a limitation of the configuration system more than anything and
may well change if need be.  However, if we need to add SAX processors
to the end of the machine, then the <code>PerlSetVar
AxSAXMachineFilters</code> can be used to insert site-specific filters
after the main machine (and before the XSLT processors).</p>

<a name="My::Filelist2Data"></a><h4>My::Filelist2Data</h4>


<a href="/pub/a/2002/09/24/axkit.html#pipeline.png" name="pipeline_filelist.png2"><p><img src="/pub/2002/09/24/graphics/pipeline_filelist2data_pm.png" alt="My::Filelist2Data's position in the processing pipeline." width="110" height="84" border="0" align="right"/></a></p>

<p>Converting the <code>&lt;filelist&gt;</code> into a proofsheet takes a
bit of detailed data munging.  This is quite easy in Perl, so the first
step in our pipeline is to convert the XML file listing into data.  <a href="http://search.cpan.org/author/GRANTM/XML-Simple/Simple.pm">XML::Simple</a>
provides this functionality for us, and we overload it so we can grab
the resulting data structure and pass it on:</p>

<pre><code>    package My::Filelist2Data;
    
    use XML::Simple;
    @ISA = qw( XML::Simple );
    
    use strict;
    
    sub new {
        my $proto = shift;
        my %opts = @_;
    
        <font color="#000000"># The Handler value is passed in by the Pipeline()</font>
        <font color="#000000"># call in My::ProofSheetMachine.</font>
        my $h = delete $opts{Handler};
    
        <font color="#000000"># Even if there's only one file element present,</font>
        <font color="#000000"># make XML::Simple put it in an ARRAY so that</font>
        <font color="#000000"># the downstream filter can depend on finding an</font>
        <font color="#000000"># array of elements and not a single element.</font>
        <font color="#000000"># This is an XML::Simple option that is almost</font>
        <font color="#000000"># always set in practice.</font>
        $opts{forcearray} = [qw( file )];
    
        <font color="#000000"># Each &lt;file> and &lt;directory> element contains</font>
        <font color="#000000"># the file name as simple text content.  This</font>
        <font color="#000000"># option tells XML::Simple to store it in the</font>
        <font color="#000000"># data member "filename".</font>
        $opts{contentkey} = "filename";
    
        <font color="#000000"># This subroutine gets called when XML::Simple</font>
        <font color="#000000"># has converted the entire document with the</font>
        <font color="#000000"># $data from the document.</font>
        $opts{DataHandler} = sub {
            shift;
            my ( $data ) = @_;
    
            <font color="#000000"># If no files are found, place an array</font>
            <font color="#000000"># reference in the right spot.  This is to</font>
            <font color="#000000"># to simplify downstream filter code.</font>
            $data->{file}      ||= [];
    
            <font color="#000000"># Pass the data structure to the next filter.</font>
            $h->generate( $data );
        } if $h;
    
        <font color="#000000"># Call XML::Simple's constructor.</font>
        return $proto->SUPER::new( %opts );;
    }
    
    1;</code></pre>

<p>Sending a data structure like this between SAX machines using a
non-SAX event is known as "cheating."  But this is Perl, and
allowing you to cheat responsibly and judiciously is one of Perl's great
strengths.  This works and should work for the foreseeable future.  If
you're planning on doing something like this for a general purpose
filter, then it behooves you to also provide <code>set_handler</code> and
<code>get_handler</code> methods so your filter can be repositioned
after instantiation (something XML::SAX::Machines do if need be), but we
don't need to clutter this single-purpose example.</p>

<p>The <code>&lt;filelist&gt;</code> document gets converted to a Perl
data structure where each element is a data member in a HASH or an
array,  like (data elided and rearranged to relate well to the
source XML):</p>

<pre><code>    {
      xmlns => 'http://axkit.org/2002/filelist',
      directory => [
        {
          atime      => '1032276941'
          mtime      => '1032276939',
          ctime      => '1032276939',
          readable   => '1',
          writable   => '1',
          executable => '1',
          size       => '4096',
          content    => '.',
        },
        {
          ...
          content    => '<b>..</b>',
        },
        {
          ...
          content    => '<b>Mary</b>',
        },
        {
          ...
          content    => '<b>Jim</b>',
        }
      ]
      file => [
        {
          <b>mtime      => '1031160766</b>',
          ...
          content    => '<b>a-look.jpeg</b>',
        },
        {
          <b>mtime      => '1031160787</b>',
          ...
          content    => '<b>a-lotery.jpeg</b>',
        },
        {
          <b>mtime      => '1031160771</b>',
          ...
          content    => '<b>a-lucky.jpeg</b>',
        },
        {
          <b>mtime      => '035239142</b>',
          ...
          content    => '<b>foo.html</b>',
        },
        ...
      ],
    }</code></pre>















<a name="My::ProofSheet"></a><h4>My::ProofSheet</h4>

<p><a href="/pub/a/2002/09/24/axkit.html#pipeline.png" name="pipeline_proofsheet_pm.png"><img src="/pub/2002/09/24/graphics/pipeline_proofsheet_pm.png" alt="My::ProofSheet's position in the processing pipeline." width="110" height="84" border="0" align="right"/></a></p>

<p>Once the data is in Perl data structure, it's easy to tweak it (making
<code>mtime</code> fields into something readable, for instance)
and extend it (adding information about thumbnail images and .meta
files, for instance).  This is what My::ProofSheet does:</p>


<pre><code>    package My::ProofSheet;
    
    use XML::SAX::Base;
    @ISA = qw( XML::SAX::Base );
    
    <font color="#000000"># We need to access the Apache request object to</font>
    <font color="#000000"># get the URI of the directory we're presenting,</font>
    <font color="#000000"># its physical location on disk, and to probe</font>
    <font color="#000000"># the files in it to see if they are images.</font>
    use Apache;
    
    <font color="#000000"># My::Thumbnailer is an Apache/mod_perl module that</font>
    <font color="#000000"># creates thumbnail images on the fly.  See below.</font>
    use My::Thumbnailer qw( image_size thumb_limits );
    
    <font color="#000000"># XML::Generator::PerlData lets us take a Perl data</font>
    <font color="#000000"># structure and emit it to the next filter serialized</font>
    <font color="#000000"># as XML.</font>
    use XML::Generator::PerlData;
    
    use strict;
    
    sub generate {
        my $self = shift;
        my ( $data ) = @_;
    
        <font color="#000000"># Get the AxKit request object so we can</font>
        <font color="#000000"># ask it for the URI and use it to test</font>
        <font color="#000000"># whether files are images or not.</font>
        my $r = $self->{Request};
    
        my $dirname = $r->uri;      <font color="#000000"># "/04/Baby_Pictures/Other/"</font>
        my $dirpath = $r->filename; <font color="#000000"># "/home/me/htdocs/...Other/"</font>
    
    
        my @images = map $self->file2image( $_, $dirpath ),
            sort {
                $a->{filename} cmp $b->{filename}
            } @{$data->{file}};
    
        <font color="#000000"># Use a handy SAX module to generate XML from our Perl</font>
        <font color="#000000"># data structures.  The XML will look basically like:</font>
        <font color="#000000"># Write XML that looks like</font>
        <font color="#000000">#</font>
        <font color="#000000"># &lt;proofsheet></font>
        <font color="#000000">#   &lt;images></font>
        <font color="#000000">#     &lt;image>...&lt;/image></font>
        <font color="#000000">#     &lt;image>...&lt;/image></font>
        <font color="#000000">#     ...</font>
        <font color="#000000">#   &lt;/images></font>
        <font color="#000000">#   &lt;title>/04/BabyePictures/Others&lt;/title></font>
        <font color="#000000"># &lt;/proofsheet></font>
        <font color="#000000">#</font>
        XML::Generator::PerlData->new(
            rootname => "proofsheet",
            Handler => $self,
        )->parse( {
            title       => $dirname,
            images      => { image => \@images },
        } );
    }
    
    
    sub file2image {
        my $self = shift;
        my ( $file, $dirpath ) = @_;
    
        <font color="#000000"># Remove the filename from the fields so it won't</font>
        <font color="#000000"># show up in the &lt;image> structure.</font>
        my $fn = $file->{filename};
    
        <font color="#000000"># Ignore hidden files (first char is a ".").</font>
        <font color="#000000"># Thumbnail images are cached as hidden files.</font>
        return () if 0 == index $fn, ".";
    
        <font color="#000000"># Ignore files Apache knows aren't images</font>
        my $type = $self->{Request}->lookup_file( $fn )->content_type;
        return () unless
            defined $type
            &amp;&amp; substr( $type, 0, 6 ) eq "image/";
    
        <font color="#000000"># Strip the extension(s) off.</font>
        ( my $name = $fn ) =~ s/\..*//;
    
        <font color="#000000"># A meta filename is the image filename with a ".meta"</font>
        <font color="#000000"># extension instead of whatever extension it has.</font>
        my $meta_fn   = "$name.meta";
        my $meta_path = "$dirpath/$meta_fn";
    
        <font color="#000000"># The thumbnail file is stored as a hidden file</font>
        <font color="#000000"># named after the image file, but with a leading</font>
        <font color="#000000"># '.' to hide it.</font>
        my $thumb_fn   = ".$fn";
        my $thumb_path = "$dirpath/$thumb_fn";
    
        my $last_modified = localtime $file->{mtime};
    
        my $image = {
            %$file,                  <font color="#000000"># Copy all fields</font>
            type           => $type, <font color="#000000"># and add a few</font>
            name           => $name,
            thumb_uri      => $thumb_fn,
            path           => "$dirpath/$fn",
            last_modified  => $last_modified,
        };
    
        if ( -e $meta_path ) {
            <font color="#000000"># Only add a URI to the meta info, metamerger.xsl will</font>
            <font color="#000000"># slurp it up if and only if &lt;meta_uri> is present.</font>
            $image->{meta_filename} = $meta_fn;
            $image->{meta_uri}      = "file://$meta_path";
        }
    
        <font color="#000000"># If the thumbnail exists, grab its width and height</font>
        <font color="#000000"># so later stages can populate the &lt;img> tag with them.</font>
        <font color="#000000"># The eval {} is in case the image doesn't exist or</font>
        <font color="#000000"># the library can't cope with the image format.</font>
        <font color="#000000"># Disable caching AxKit's output if a failure occurs.</font>
        eval {
            ( $image->{thumb_width}, $image->{thumb_height} )
                = image_size $thumb_path;
        } or $self->{Request}->no_cache( 1 );
    
        return $image;
    }
    
    
    1;</code></pre>

<p>When My::Filelist2Data calls <code>generate()</code>,
<code>generate()</code> sorts and scans the list of files by filename,
converts each to an image and sends a page title and the resulting list
of images to the next filter (<a href="/pub/a/2002/09/24/axkit.html?page=3#XML::Filter::TableWrapper">XML::Filter::TableWrapper</a>).  Kip Hampton's
<a href="http://search.cpan.org./author/KHAMPTON/XML-Generator-PerlData/PerlData.pm">XML::Generator::PerlData</a>
is a Perl data -&gt; XML serialization module.  It's not meant for
generating generic XML; it focuses purely on building an XML
representation of a Perl data structure.  In this case, that's ideal,
because we will be generating the output document with XSLT templates
and we don't care about the exact order of the elements in each
<code>&lt;image&gt;</code> element, each <code>&lt;image&gt;</code>
element is just a hash of key/value pairs.  We do control the order of
the <code>&lt;image&gt;</code> elements, however, by passing an ordered
list of them in to XML::Generator::PerlData as an array.</p>

<p>Sorting by filename may not be the preferred thing to do for all
applications, because users may prefer to sort by the caption title
for the image, but then again they may not, and this allows the site
administrator to control sort order by naming the files appropriately.
We can add always add sorting later.</p>

<p>Another peculiarity of this code is that it doesn't guarantee that
there will be <code>thumb_width</code> and <code>thumb_height</code>
values available.  If you just drop the source images in a directory,
then the first time the server generates this page, there will be no
thumbnails available.  In this case, the call to
<code>no_cache(1)</code> prevents AxKit from caching the output page so
that suboptimal HTML does not get stuck in the cache.  This will give
the server another chance at generating it with proper tags, hoping of
course that by the next time this page is requested, the requisite
thumbnails will be available to measure.</p>

<p>This approach gets the HTML to the browser fast, so the user's
browser window will clear quickly and start filling with the top of ths
page, so the user will see some activity and be less likely to get
impatient.  The thumbnails will be generated when the browser sees all
the <code>&lt;img&gt;</code> tags.  The alternative approach would be to
thumbnail the images inline, which would result in a significant delay
on large listings before the first HTML hits the browser, or
prethumbnailing.</p>

<p>One thing to note about this approach is that many browsers will
request images several at a time, which will cause several server
processes to be thumbnailing several different images at once.  This
should result in lower lag on low-load servers because processes can
interleave CPU time and disk I/O waits, and can take advantage of
multiple processors, if present.  On heavily loaded servers, of course,
this might be a bad thing; pregenerating thumbnails there would be a
good idea.</p>

<p>The output from this filter looks like:</p>

<pre><code>    &lt;?xml version="1.0"?&gt;
    &lt;proofsheet&gt;
      &lt;images&gt;
        &lt;image&gt;
          &lt;path&gt;
		    /home/barries/src/mball/AxKit/www/htdocs/04/Baby_Pictures/Others/a-look.jpeg
		  &lt;/path&gt;
          &lt;writable&gt;1&lt;/writable&gt;
          &lt;filename&gt;<b>a-look.jpeg</b>&lt;/filename&gt;
          &lt;thumb_uri&gt;<b>.a-look.jpeg</b>&lt;/thumb_uri&gt;
          &lt;meta_filename&gt;a-look.meta&lt;/meta_filename&gt;
          &lt;name&gt;a-look&lt;/name&gt;
          &lt;last_modified&gt;<b>Wed Sep  4 13:32:46 2002</b>&lt;/last_modified&gt;
          &lt;ctime&gt;1032552249&lt;/ctime&gt;
          <b>&lt;meta_uri&gt;
            <a href="/pub/a/2002/09/24/axkit.html#TheMetaFile">file:///home/barries/src/mball/AxKit/www/htdocs/04/Baby_Pictures/Others/a-look.meta</a>
          &lt;/meta_uri&gt;</b>
          &lt;mtime&gt;1031160766&lt;/mtime&gt;
          &lt;size&gt;8522&lt;/size&gt;
          &lt;readable&gt;1&lt;/readable&gt;
          &lt;type&gt;image/jpeg&lt;/type&gt;
          &lt;atime&gt;1032553327&lt;/atime&gt;
        &lt;/image&gt;
        &lt;image&gt;
          &lt;path&gt;
            /home/barries/src/mball/AxKit/www/htdocs/04/Baby_Pictures/Others/a-lotery.jpeg
          &lt;/path&gt;
          &lt;writable&gt;1&lt;/writable&gt;
          &lt;filename&gt;<b>a-lotery.jpeg</b>&lt;/filename&gt;
          &lt;thumb_uri&gt;.a-lotery.jpeg&lt;/thumb_uri&gt;
          &lt;name&gt;<b>a-lotery</b>&lt;/name&gt;
          &lt;last_modified&gt;<b>Wed Sep  4 13:33:07 2002</b>&lt;/last_modified&gt;
          &lt;ctime&gt;1032552249&lt;/ctime&gt;
          &lt;mtime&gt;1031160787&lt;/mtime&gt;
          &lt;size&gt;10113&lt;/size&gt;
          &lt;readable&gt;1&lt;/readable&gt;
          &lt;type&gt;image/jpeg&lt;/type&gt;
          &lt;atime&gt;1032553327&lt;/atime&gt;
        &lt;/image&gt;
      &lt;/images&gt;
      ...
      &lt;title&gt;/04/Baby_Pictures/Others&lt;/title&gt;
    &lt;/proofsheet&gt;</code></pre>

<p>All the data from the original <code>&lt;file&gt;</code> elements are
in each <code>&lt;image&gt;</code> element along with the new fields.
Note that the first <code>&lt;image&gt;</code> contains the
<code>&lt;meta_uri&gt;</code> (pointing to <a href="/pub/a/2002/09/24/axkit.html#TheMetaFile">a-look.meta</a>)
while the second doesn't because there is no <code>a-lotery.meta</code>.  As
expected both have the <code>&lt;thumb_uri&gt;</code> tags.  The parts
in <b>bold</b> face are the bits that our presentation happens to want;
yours might want more or different bits.</p>

<p>While there is a lot of extra information in this structure, it's
really just the output from one system call (<code>stat()</code>) and
some possibly useful byproducts of the My::ProofSheet machinations, so
it's very cheap information that some front end somewhere might want.
It's also easier to leave it all in than to emit just what our example
frontend might want and will enable any future upstream filters or
extentions to AxKit's directory scanning to shine through.</p>

<p>No <code>&lt;thumb_width&gt;</code> or
<code>&lt;thumb_height&gt;</code> tags are present because I copied this
file from the axtrace directory (see the
<code>AxTraceIntermediate</code> directive in <a href="/pub/a/2002/09/24/axkit.html?page=2#httpd.conf">our
httpd.conf file</a>) after viewing a newly added directory.  Here's what
the first <code>&lt;image&gt;</code> element looks like when viewing
after my browser had requested all thumbnails:</p>

<pre><code>    &lt;?xml version="1.0"?&gt;
    &lt;proofsheet&gt;
      &lt;images&gt;
        &lt;image&gt;
          <b>&lt;thumb_width&gt;72&lt;/thumb_width&gt;</b>
          &lt;path&gt;
            /home/barries/src/mball/AxKit/www/htdocs/04/Baby_Pictures/Others/a-look.jpeg
          &lt;/path&gt;
          &lt;writable&gt;1&lt;/writable&gt;
          &lt;filename&gt;a-look.jpeg&lt;/filename&gt;
          <b>&lt;thumb_height&gt;100&lt;/thumb_height&gt;</b>
          &lt;thumb_uri&gt;.a-look.jpeg&lt;/thumb_uri&gt;
          &lt;meta_filename&gt;a-look.meta&lt;/meta_filename&gt;
          &lt;name&gt;a-look&lt;/name&gt;
          &lt;last_modified&gt;Wed Sep  4 13:32:46 2002&lt;/last_modified&gt;
          &lt;ctime&gt;1032552249&lt;/ctime&gt;
          &lt;meta_uri&gt;
            file:///home/barries/src/mball/AxKit/www/htdocs/04/Baby_Pictures/Others/a-look.meta
          &lt;/meta_uri&gt;
          &lt;mtime&gt;1031160766&lt;/mtime&gt;
          &lt;size&gt;8522&lt;/size&gt;
          &lt;readable&gt;1&lt;/readable&gt;
          &lt;type&gt;image/jpeg&lt;/type&gt;
          &lt;atime&gt;1032784360&lt;/atime&gt;
        &lt;/image&gt;
        ...
      &lt;/images&gt;
      &lt;title&gt;/04/Baby_Pictures/Others&lt;/title&gt;
    &lt;/proofsheet&gt;</code></pre>

<a name="XML::Filter::TableWrapper" /><h4>XML::Filter::TableWrapper</h4>

<p><a href="/pub/a/2002/09/24/axkit.html#pipeline.png" name="pipeline_tablewrapper_pm.png"><img src="/pub/2002/09/24/graphics/pipeline_tablewrapper_pm.png" alt="My::TableWrapper's position in the processing pipeline" width="110" height="84" border="0" align="right"/></a></p>

<p><a href="http://search.cpan.org/author/RBS/XML-Filter-TableWrapper/lib/XML/Filter/TableWrapper.pm">XML::Filter::TableWrapper</a>
is a CPAN module is used to take the <code>&lt;images&gt;</code> list
and segmenting it by insert <code>&lt;tr&gt;...&lt;/tr&gt;</code> tags
around every (it's configurable) <code>&lt;image&gt;</code>
elements.  This configuration is done by the <a href="/pub/a/2002/09/24/axkit.html?page=2#My::ProofSheetMachine">My::ProofSheetMachine</a> module we showed
earlier:</p>

<pre><code>    XML::Filter::TableWrapper->new(
        ListTags => "{}images",
        Columns  => $r->dir_config( "MyColumns" ) || 3,
    ),</code></pre>

<p>The output, for our list of 9 images, looks like:</p>

<pre><code>    &lt;?xml version="1.0"?&gt;
    &lt;proofsheet&gt;
      &lt;images&gt;
        &lt;tr&gt;
          &lt;image&gt;
            ...
          &lt;/image&gt;
          ... 4 more image elements...
        &lt;/tr&gt;
        &lt;tr&gt;
          &lt;image&gt;
            ...
          &lt;/image&gt;
          ... 3 more image elements...
        &lt;/tr&gt;
      &lt;/images&gt;
      &lt;title&gt;/04/Baby_Pictures/Others&lt;/title&gt;
    &lt;/proofsheet&gt;</code></pre>

<p>Now all the presentation stylesheet (<a href="/pub/a/2002/09/24/axkit.html?page=4#pagestyler.xsl">pagestuler.xsl</a>) can key off the
<code>&lt;tr&gt;</code> tags to build an HTML <code>&lt;table&gt;</code>
or ignore them (and not pass them through) if it wants to display in a
list format.</p>

<p>While I'm sure this is possible in XSLT, I have no idea how to do it easily.</p>

<a name="rowsplitter.xsl" /><h4>rowsplitter.xsl</h4>

<p><a href="/pub/a/2002/09/24/axkit.html#pipeline.png" name="pipeline_rowsplitter_xsl.png"><img src="/pub/2002/09/24/graphics/pipeline_rowsplitter_xsl.png" alt="rowsplitter.xsl's position in the processing pipeline." width="110" height="84" border="0" align="right"/></a></p>

<p>Experimentation with an early version of this application showed that
presenting captions in the same table cell as the thumbnails when the
thumbnails are of differing heights caused the captions to be showed at
varying heights.  This made it hard to scan the captions and added a lot
of visual clutter to the page.</p>

<p>One solution is to add an XSLT filter that splits each table row of
image data in to two rows, one for the thumbnail and another for the
caption:</p>

<pre><code>    &lt;xsl:stylesheet 
      version="1.0"
      xmlns:xsl="http://www.w3.org/1999/XSL/Transform"
    &gt;
    
    &lt;xsl:template match="image" mode="caption"&gt;
      &lt;caption&gt;
        &lt;xsl:copy-of select="@*|*|node()" /&gt;
      &lt;/caption&gt;
    &lt;/xsl:template&gt;
    
    &lt;xsl:template match="images/tr"&gt;
      &lt;xsl:copy-of select="." /&gt;
      &lt;tr>&lt;xsl:apply-templates select="image" mode="caption" /&gt;&lt;/tr&gt;
    &lt;/xsl:template&gt;
    
    &lt;xsl:template match="@*|node()"&gt;
      &lt;xsl:copy&gt;
        &lt;xsl:apply-templates select="@*|node()"/&gt;
      &lt;/xsl:copy&gt;
    &lt;/xsl:template&gt;
    
    &lt;/xsl:stylesheet&gt;</code></pre>

<p>The second template in this stylesheet matches each row
(<code>&lt;tr&gt;</code> element) in the <code>&lt;images&gt;</code>
element and copies it verbatim and then emits a second
<code>&lt;tr&gt;</code> element right after it with a list of
<code>&lt;caption&gt;</code> elements with copies of the content of each
of the <code>&lt;image&gt;</code> tags in the original row.  The first
template is applied only to the <code>&lt;image&gt;</code> tags when
creating this second row due to the <code>mode="caption"</code>
attributes.</p>

<p>The third template is a standard piece of XSLT boilerplate that
passes through all the XML that is not matched by the first two
templates.  This XML would otherwise be mangled (stripped of elements,
to be specific) by the wacky default XSLT rules.</p>

<p>Now, I know several ways to do this in Perl in the AxKit environment
and none are so easy for me as using XSLT.  <a href="http://info.astrian.net/jargon/terms/y.html#YMMV">YMMV</a>.</p>

<p>The output from that stage looks like:</p>


<pre><code>    &lt;?xml version="1.0"?&gt;
    &lt;proofsheet&gt;
      &lt;images&gt;

        &lt;tr&gt;&lt;image&gt;...  &lt;/image&gt;   ...total of 5... &lt;/tr&gt;
        &lt;tr&gt;&lt;caption&gt;...&lt;/caption&gt; ...total of 5... &lt;/tr&gt;

        &lt;tr&gt;&lt;image&gt;...  &lt;/image&gt;   ...total of 4... &lt;/tr&gt;
        &lt;tr&gt;&lt;caption&gt;...&lt;/caption&gt; ...total of 4... &lt;/tr&gt;

      &lt;/images&gt;
      &lt;title&gt;/04/Baby_Pictures/Others&lt;/title&gt;
    &lt;/proofsheet&gt;</code></pre>

<p>The content of each <code>&lt;image&gt;</code> tag and each
<code>&lt;caption&gt;</code> tag is identical.  It's easier to do the
transform this way and allows the frontend stylesheets the flexibility
of doing things like putting the image filename or modification time in
the same cell as the thumbnail.<p>

<a name="metamerger.xsl" /><h4>metamerger.xsl</h4>

<p><a href="/pub/a/2002/09/24/axkit.html#pipeline.png" name="pipeline_metamerger_xsl.png"><img src="/pub/2002/09/24/graphics/pipeline_metamerger_xsl.png" alt="metamerger.xsl's position in the processing pipeline" border="0" align="right"/></a></p>

<p>As with the row splitter, expressing the metamerger in XSLT is an
expedient way of merging in external XML documents, for several reasons.
The first is for efficiency's sake: We're already using XSLT before and
after this filter, and AxKit optimizes XSLT->XSLT handoffs to avoid
reparsing.  Another is that the underlying implementation of AxKit's
XSLT engine is the speedy C of libxslt. A third is that we're not
altering the incoming file at all in this stage, so the XSLT does not
get out of hand (I do not consider XSLT to be a very readable
programming language; its XML syntax makes for very opaque source code).</p>

<p>Another approach would be to go back and tweak <a href="/pub/a/2002/09/24/axkit.html?page=3#My::ProofSheet">My::ProofSheet</a> to inherit from <a href="http://search.cpan.org/author/RBS/XML-SAX-Machines/lib/XML/Filter/Merger.pm">XML::Filter::Merger</a>
and insert it using a SAX parser.  That would be a bit slower, I
suspect, because SAX parsing in general tends to be slower than XSLT's
internal parsing.  It would rob the application of the configurability
that having merging as a separate step engenders.  By factoring this
functionality in to the metamerger.xsl stylesheet, we offer the site
designer the ability to pull data from other sources, or even to fly
without any metadata at all.</p>

<p>Here's what metamerger.xsl looks like:</p>

<pre><code>    &lt;xsl:stylesheet 
      version="1.0"
      xmlns:xsl="http://www.w3.org/1999/XSL/Transform"
    >
    
    &lt;xsl:template match="caption">
      &lt;caption>
        &lt;xsl:copy-of select="*|@*|node()" />
        &lt;xsl:copy-of select="document( meta_uri )" />
      &lt;/caption>
    &lt;/xsl:template>
    
    &lt;xsl:template match="*|@*">
      &lt;xsl:copy>
        &lt;xsl:apply-templates select="*|@*|node()" />
      &lt;/xsl:copy>
    &lt;/xsl:template>
    
    &lt;/xsl:stylesheet></code></pre>

<p>The first template does all the work of matching each
<code>&lt;caption&gt;</code> element and copying its content, then
parsing and inserting the document indicated by the
<code>&lt;meta_uri&gt;</code> element, if present.  The
<code>document()</code> function turns into a noop if
<code>&lt;meta_uri&gt;</code> is not present.  The second template is
that same piece of boilerplate we saw in <a href="/pub/a/2002/09/24/axkit.html?page=3#rowsplitter.xsl">rowsplitter.xsl</a> to copy through everything we don't explicitly match.














<p>And here's what the <code>&lt;caption&gt;</code> for
<code>a-look.jpeg</code> now looks like (all the other
<code>&lt;caption&gt;</code> elements were left untouched because there
are no other .meta files in this directory):</p>

<pre><code>    &lt;caption>
      &lt;thumb_width>72&lt;/thumb_width>
      &lt;path>/home/barries/src/mball/AxKit/www/htdocs/04/Baby_Pictures/Others/a-look.jpeg&lt;/path>
      &lt;writable>1&lt;/writable>
      &lt;filename>a-look.jpeg&lt;/filename>
      &lt;thumb_height>100&lt;/thumb_height>
      &lt;thumb_uri>.a-look.jpeg&lt;/thumb_uri>
      &lt;meta_filename>a-look.meta&lt;/meta_filename>
      &lt;name>a-look&lt;/name>
      &lt;last_modified>Wed Sep  4 13:32:46 2002&lt;/last_modified>
      &lt;ctime>1032552249&lt;/ctime>
      &lt;meta_uri>file:///home/barries/src/mball/AxKit/www/htdocs/04/Baby_Pictures/Others/a-look.meta&lt;/meta_uri>
      &lt;mtime>1031160766&lt;/mtime>
      &lt;size>8522&lt;/size>
      &lt;readable>1&lt;/readable>
      &lt;type>image/jpeg&lt;/type>
      &lt;atime>1032784360&lt;/atime>
      <b>&lt;meta>
        &lt;title>A baby picture&lt;/title>
        &lt;comment>&lt;b>ME!&lt;/b>.  Well, not really.  Actually, it's some random image from the 'net.
&lt;/comment>
      &lt;/meta></b>
    &lt;/caption></code></pre>

<p>As mentioned before, this stylesheet does not care what you put in
the meta file, it just inserts anything in that file from the root
element on down.  So you are free to put any meta information your
application requires in the meta file and adjust the presentation
filters to style it as you will.</p>

<p>The .meta information is not inserted in to the
<code>&lt;image&gt;</code> tags because we know that none of our
presentation will not need any of it there.</p>

<a name="captionstyler.xsl" /><h4>captionstyler.xsl</h4>

<p><a href="/pub/a/2002/09/24/axkit.html#pipeline.png" name="pipeline_captionstyler_xsl.png"><img src="/pub/2002/09/24/graphics/pipeline_captionstyler_xsl.png" alt="captionstyler.xsl's position in the processing pipeline" width="110" height="84" border="0" align="right" /></a></p>

<p>The last two stages of our pipeline turn the data assembled so far into HTML.  This is done in two stages in order to separate general layout and presentation from the presentation of the caption because the
these portions of the presentation might need to vary independently between one collection of images and another.</p>

<p>The caption stylesheet for this example is:</p>


<pre><code>    &lt;xsl:stylesheet 
      version="1.0"
      xmlns:xsl="http://www.w3.org/1999/XSL/Transform"
    >
    
    &lt;xsl:template match="caption">
      &lt;caption width="100" align="left" valign="top">
    
        &lt;a href="{filename}">
          &lt;xsl:choose>
            &lt;xsl:when test="meta/title and string-length( meta/title )">
              &lt;xsl:copy-of select="meta/title/node()" />
            &lt;/xsl:when>
            &lt;xsl:otherwise>
              &lt;xsl:value-of select="name" />
            &lt;/xsl:otherwise>
          &lt;/xsl:choose>
        &lt;/a>&lt;br />
    
        &lt;font size="-1" color="#808080">
          &lt;xsl:copy-of select="last_modified/node()" />
          &lt;br />
        &lt;/font>
    
        &lt;xsl:copy-of select="meta/comment/node()" />
    
      &lt;/caption>
    &lt;/xsl:template>
    
    &lt;xsl:template match="*|@*|node()">
      &lt;xsl:copy>
        &lt;xsl:apply-templates />
      &lt;/xsl:copy>
    &lt;/xsl:template>
    
    &lt;/xsl:stylesheet></code></pre>

<p>The first template replaces all <code>&lt;caption&gt;</code> elements
with new <code>&lt;caption&gt;</code> cells with a default width and
alignment, and then fills these with the name of the image, which is
also a link to the underling image file, and the
<code>&lt;last_modified</code> time string formatted by <a href="/pub/a/2002/09/24/axkit.html?page=3#My::ProofSheet">My::ProofSheet</a> and any
<code>&lt;comment&gt;</code> that might be present in the meta
file.</p>

<p>The <code>&lt;xsl:choose&gt;</code> element is what selects the title
to display for the image.  The first <code>&lt;xsl:when&gt;</code>looks
to see if there is a <code>&lt;title&gt;</code> element in the meta file
and uses it if present.  The
<code>&lt;xsl:otherwise&gt;</code> defaults the name to the
<code>&lt;name&gt;</code> set by My::ProofSheet.</p>

<p>The captions output by this stage look like:</p>

<pre><code>    &lt;caption width="100" align="left" valign="top">
      &lt;a href="a-look.jpeg">A baby picture&lt;/a>
      &lt;br/>
      &lt;font size="-1" color="#808080">Wed Sep
        4 13:32:46 2002&lt;br/>
      &lt;/font>
      &lt;b>ME!&lt;/b>.  Well, not really.  Actually, it's
        some random image from the 'net.
    &lt;/caption>
    &lt;caption width="100" align="left" valign="top">
      &lt;a href="a-lotery.jpeg">a-lotery&lt;/a>
      &lt;br/>
      &lt;font size="-1" color="#808080">Wed Sep
        4 13:33:07 2002&lt;br/>&lt;/font>
    &lt;/caption></code></pre>

<p>The former is what comes out when a .meta file is found, the latter
when it is not.</p>

<a name="pagestyler.xsl"/><h4>pagestyler.xsl</h4>

<p>And now, the final stage.  If you've made it this far,
congratulations; this is the start of a real application and not just a
toy, so it's taken quite some time to get here.</p>

<p><a href="/pub/a/2002/09/24/axkit.html#pipeline.png" name="pipeline_pagestyler_xsl.png"><img src="/pub/2002/09/24/graphics/pipeline_pagestyler_xsl.png" alt="pagestyler.xsl's position in the processing pipeline" width="110" height="84" border="0" align="right"/></a></p>

<p>The final stage of the processing pipeline generates an HTML page from the raw data, except for the attributes and content of <code>&lt;caption&gt;</code> tags, which it passes through as-is:</p>


<pre><code>    &lt;xsl:stylesheet 
      version="1.0"
      xmlns:xsl="http://www.w3.org/1999/XSL/Transform"
    >
    
    &lt;xsl:template match="/*">
      &lt;html>
        &lt;head>
          &lt;title>Images in &lt;xsl:value-of select="title" />&lt;/title>
        &lt;/head>
        &lt;body bgcolor="#ffffff">
          &lt;xsl:apply-templates select="images" />
        &lt;/body>
      &lt;/html>
    &lt;/xsl:template>
    
    
    &lt;xsl:template match="images">
      &lt;table>
        &lt;xsl:apply-templates />
      &lt;/table>
    &lt;/xsl:template>
    
    &lt;xsl:template match="tr">
      &lt;xsl:copy>
        &lt;xsl:apply-templates select="*" />
      &lt;/xsl:copy>
    &lt;/xsl:template>
    
    &lt;xsl:template match="image">
      &lt;td align="left" valign="top">
        &lt;a href="{filename}">
          &lt;img border="0" src="{thumb_uri}">
            &lt;xsl:if test="thumb_width">
              &lt;xsl:attribute name="width">
                &lt;xsl:value-of select="thumb_width" />
              &lt;/xsl:attribute>
            &lt;/xsl:if>
            &lt;xsl:if test="thumb_height">
              &lt;xsl:attribute name="height">
                &lt;xsl:value-of select="thumb_height" />
              &lt;/xsl:attribute>
            &lt;/xsl:if>
          &lt;/img>
        &lt;/a>
      &lt;/td>
    &lt;/xsl:template>
    
    &lt;xsl:template match="@*|node()" mode="caption">
      &lt;xsl:copy>
        &lt;xsl:apply-templates select="@*|node()" mode="caption" />
      &lt;/xsl:copy>
    &lt;/xsl:template>
    
    &lt;xsl:template match="caption">
      &lt;td>
        &lt;xsl:apply-templates select="@*|node()" mode="caption" />
      &lt;/td>
    &lt;/xsl:template>
    
    &lt;/xsl:stylesheet></code></pre>

<p>The first template generates the skeleton of the HTML page, the
second one grabs the <code>&lt;images&gt;</code> list from the source
document, emits a <code>&lt;table&gt;</code>, the third copies the
<code>&lt;tr&gt;</code> tags, the fourth replaces all
<code>&lt;image&gt;</code> tags with <code>&lt;td&gt;</code> tags
containing the thumbnail image as a link to the underlying image
(similar to what <a href="/pub/a/2002/09/24/axkit.html?page=4#captionstyler.xsl">captionstyler.xsl</a> did
with the picture name).  The only subtlety here is that the optional
<code>&lt;thumb_width&gt;</code> and <code>&lt;thumb_height&gt;</code>
elements are used, if present, to inform the browser of the size of the
thumbnail in order to speed up the layout process (as mentioned before, pages
that don't contain this information are not cached so that when the
thumbnails are generated, new HTML will be generated with it).</p>

<p>The fourth template converts the <code>&lt;caption&gt;</code>
elements to <code>&lt;td&gt;</code> elements and copies all their
content through, since <a href="/pub/a/2002/09/24/axkit.html?page=4#captionstyler.xsl">captionstyler.xsl</a> already did the
presentation for them.</p>

<p>Tweaking this stylesheet or replacing it controls the entire page
layout other than thumbnail sizing (which is set by the optional
<code>MyMaxX</code> and <code>MyMaxY</code> <code>PerlSetVar</code>
settings in <a href="/pub/a/2002/09/24/axkit.html?page=2#httpd.conf">httpd.conf</a>).  A different
stylesheet in this point in the chain could choose to ignore the
<code>&lt;tr&gt;</code> tags and present a list style output.  A later
stylesheet could be added to add branding or advertising to the site,
etc., etc.</p>

<a name="My::Thumbnailer"/><h4>My::ThumbNailer</h4>

<p>Here's the apache module that generates thumbnails.  The key thing to
remember is that, unlike all the other code and XML shown in this
article, this is called once per thumbnail image, not once per
directory.  When a browser requests a directory listing, it gets HTML
from the pipeline above with lots of URIs for thumbnail images.  It will
then usually request each of those in turn.  The <a href="/pub/a/2002/09/24/axkit.html?page=2#httpd.conf">httpd.conf</a> file directs all requests for dotfiles
to this module:</p>


<pre><code>    package My::Thumbnailer;
    
    <font color="#000000"># Allow other modules like <a href="/pub/a/2002/09/24/axkit.html?page=3#My::ProofSheet">My::ProofSheet</A> to use some</font>
    <font color="#000000"># of our utility routines.</font>
    use Exporter;
    @ISA = qw( Exporter );
    @EXPORT_OK = qw( image_size thumb_limits );
    
    use strict;
    
    use <a href="http://search.cpan.org/author/DOUGM/mod_perl-1.27/Constants/Constants.pm">Apache::Constants</a> qw( DECLINED );
    use <a href="http://search.cpan.org/author/JIMW/libapreq/Request/Request.pm">Apache::Request</a>;
    use <a href="http://search.cpan.org/author/JHI/perl/lib/File/Copy.pm">File::Copy</a>;
    use <a href="http://search.cpan.org/author/ADDI/Imager/Imager.pm">Imager</a>;
    
    
    sub image_size {
        my $img = shift;
    
        if ( ! ref $img ) {
            my $fn = $img;
            $img = Imager->new;
            $img->open( file => $fn )
                or die $img->errstr(), ": $fn";
        }
    
        ( $img->getwidth, $img->getheight );
    }
    
    
    sub thumb_limits {
        my $r = shift;
    
        <font color="#000000"># See if the site admin has placed MyMaxX and/or</font>
        <font color="#000000"># MyMaxY in the <a href="/pub/a/2002/09/24/axkit.html?page=2#httpd.conf">httpd.conf</a>.</font>
        my ( $max_w, $max_h ) = map
            $r->dir_config( $_ ),
            qw( MyMaxX MyMaxY );
    
        return ( $max_w, $max_h )
            if $max_w || $max_h;
    
        <font color="#000000"># Default to scaling down to fit in a 100 x 100</font>
        <font color="#000000"># pixel area (aspect ration will be maintained).</font>
        return ( 100, 100 );
    }
    
    
    <font color="#000000"># Apache/mod_perl <a href="/pub/a/2002/09/24/axkit.html?page=2#httpd.conf">is configured</a> to call</font>
    <font color="#000000"># this handler for every dotfile</font>
    <font color="#000000"># requested.  All thumbnail images are dotfiles,</font>
    <font color="#000000"># some dotfiles may not be thumbnails.</font>
    sub handler {
        my $r = Apache::Request->new( shift );
    
        <font color="#000000"># We only want to handle images.</font>
        <font color="#000000"># Let Apache handle non-images.</font>
        goto EXIT
            unless substr( $r->content_type, 0, 6 ) eq "image/";
    
        <font color="#000000"># The actual image filename is the thumbnail</font>
        <font color="#000000"># filename without the leading ".".  There's</font>
        ( my $orig_fn = $r->filename ) =~ s{/\.([^/]+)\z}{/$1}
            or die "Can't parse ", $r->filename;
    
        <font color="#000000"># Let Apache serve the thumbnail if it already</font>
        <font color="#000000"># exists and is newer than the original file.</font>
        {
            my $thumb_age = -M $r->finfo;
            my $orig_age  = -M $orig_fn;
            goto EXIT
                if $thumb_age &amp;&amp; $thumb_age &lt;= $orig_age;
        }
    
        <font color="#000000"># Read in the original file</font>
        my $orig = Imager->new;
        unless ( $orig->open( file => $orig_fn ) ) {
            <font color="#000000"># Imager can't hack the format, fall back</font>
            <font color="#000000"># to the original image.  This can happen</font>
            <font color="#000000"># if you forget to install libgif</font>
            <font color="#000000"># (as I have done).</font>
            goto FALLBACK
                if $orig->errstr =~ /format not supported/;
    
            <font color="#000000"># Other errors are probably more serious.</font>
            die $orig->errstr, ": $orig_fn\n";
        }
    
        my ( $w, $h ) = image_size( $orig );
    
        die "!\$w for ", $r->filename, "\n" unless $w;
        die "!\$h for ", $r->filename, "\n" unless $h;
    
        my ( $max_w, $max_h ) = thumb_limits( $r );
    
        <font color="#000000"># Scale down only,  If the image is smaller than</font>
        <font color="#000000"># the thumbnail limits, let Apache serve it as-is.</font>
        <font color="#000000"># thumb_limits() guarantees that either $max_w</font>
        <font color="#000000"># or $max_h will be true.</font>
        goto FALLBACK
            if ( ! $max_w || $w &lt; $max_w )
            &amp;&amp; ( ! $max_h || $h &lt; $max_h );
    
        <font color="#000000"># Scale down to the maximum dimension to the</font>
        <font color="#000000"># requested size.  This can mess up for images</font>
        <font color="#000000"># that are meant to be scaled on each axis</font>
        <font color="#000000"># independantly, like graphic bars for HTML</font>
        <font color="#000000"># page seperators, but that's a very small</font>
        <font color="#000000"># demographic.</font>
        my $thumb = $orig->scale(
            $w > $h
                ? ( xpixels => $max_w )
                : ( ypixels => $max_h )
        );
        $thumb->write( file => $r->filename,)
            or die $thumb->errstr, ": ", $r->filename;
    
        goto BONK;
    
    FALLBACK:
        <font color="#000000"># If we can't or don't want to build the thumbnail,</font>
        <font color="#000000"># just copy the original and let Apache figure it out.</font>
        warn "Falling back to ", $orig_fn, "\n";
        copy( $orig_fn, $r->filename );
    
    BONK:
        <font color="#000000"># Bump apache on the head just hard enough to make it</font>
        <font color="#000000"># forget the thumbnail file's old stat() and</font>
        <font color="#000000"># mime type since we've most likely changed all</font>
        <font color="#000000"># that now.  This is important for the headers</font>
        <font color="#000000"># that control downstream caching, for instance,</font>
        <font color="#000000"># or in case Imager changed mime types on us</font>
        <font color="#000000"># (unlikely, but hey...)</font>
        $r->filename( $r->filename );
    
    EXIT:
        <font color="#000000"># We never serve the image data, Apache is perfectly</font>
        <font color="#000000"># good at doing this without our help.  Returning</font>
        <font color="#000000"># DECLINED causes Apache to use the next handler in</font>
        <font color="#000000"># its list of handlers.  Normally this is the default</font>
        <font color="#000000"># Apache file handler.</font>
        return DECLINED;
    }
    
    1;</code></pre>

<p>There should be enough inline commentary to explain that lot.  The
only thing I'll say is that, to head off the gotophobes, I think the use
of <code>goto</code> makes this routine a lot clearer than the
alternatives; the early versions did not use it and were less
readable/maintainable.  This is because the three normal exit routes
happen to stack nicely up from the bottom so the fallthrough from one
labeled chunk to the next happens nicely.</p>

<p>The most glaring mistake here is that there is no file locking.
We'll add that in next time.</p>

<a name="Summary"/><h3>Summary</h3>

<p>The final result of the code in this article is to build the image
proofsheet section of <a href="/pub/a/2002/09/24/axkit.html?page=1#proofsheet.png">the page we showed at the
beginning of the article</a>.  The next article will complete that page, and
then we'll build the image presentation page and a metadata editor in future
articles.</p>


<a name="help" /><h3>Help and thanks</h3>

<p>In case of trouble, have a look at some of the <a href="/pub/a/2002/03/12/axkit.html?page=3#help">helpful resources we
listed in the first article</a>.</p>


                                    </div>


                                </div>
                                <div class="asset-footer">


                                </div>
                            </div>


                    
                    


                        </div>
                    </div>


                    <div id="beta">
    <div id="beta-inner">


    
    <div class="widget-what-is-perl widget">
    <div class="widget-content widget-content-what-is-perl">
       Visit the home of the  Perl programming language: <a href="http://www.perl.org/">Perl.org</a
    </div>
</div>
<div class="widget-find-out-more widget-archives widget">
    <div class="widget-content">
        <ul>
            <li><a href="http://www.perl.org/get.html">Download</a></li>
            <li><a href="http://perldoc.perl.org/">Documentation</a></li>
            <li><a href="http://blogs.perl.org/">Perl Bloggers</a></li>
            <li><a href="http://news.perlfoundation.org/">Foundation News</a></li>
        </ul>
    </div>
</div><div class="widget-tcpc widget">
<h3 class="widget-header">Sponsored by</h3>
    <div class="widget-content">
        <a href="http://training.perl.com/" alt="Perl Training" target="_blank"><img src="/i/tcpc.png" width="150" height="50"></a>
    </div>
</div>

<div class="widget-syndication widget">
    <div class="widget-content">
        <ul>
            <li><img src="/mt-static/images/status_icons/feed.gif" alt="Subscribe to feed" width="9" height="9" /> <a href="/pub/atom.xml">Subscribe to this website's feed</a></li>

        </ul>
    </div>
</div>
<div class="widget-archive-monthly widget-archive widget">
    <h3 class="widget-header">Monthly <a href="/pub/archives.html">Archives</a></h3>
    <div class="widget-content">
        <ul>
        
            <li><a href="/pub/2014/02/">February 2014 (1)</a></li>
        
    
        
            <li><a href="/pub/2014/01/">January 2014 (1)</a></li>
        
    
        
            <li><a href="/pub/2013/10/">October 2013 (1)</a></li>
        
    
        
            <li><a href="/pub/2013/01/">January 2013 (1)</a></li>
        
    
        
            <li><a href="/pub/2012/12/">December 2012 (1)</a></li>
        
    
        
            <li><a href="/pub/2012/11/">November 2012 (1)</a></li>
        
    
        
            <li><a href="/pub/2012/10/">October 2012 (2)</a></li>
        
    
        
            <li><a href="/pub/2012/08/">August 2012 (2)</a></li>
        
    
        
            <li><a href="/pub/2012/06/">June 2012 (11)</a></li>
        
    
        
            <li><a href="/pub/2012/05/">May 2012 (18)</a></li>
        
    
        
            <li><a href="/pub/2012/04/">April 2012 (17)</a></li>
        
    
        
            <li><a href="/pub/2012/02/">February 2012 (1)</a></li>
        
    
        
            <li><a href="/pub/2011/12/">December 2011 (1)</a></li>
        
    
        
            <li><a href="/pub/2011/09/">September 2011 (1)</a></li>
        
    
        
            <li><a href="/pub/2011/08/">August 2011 (2)</a></li>
        
    
        
            <li><a href="/pub/2011/06/">June 2011 (1)</a></li>
        
    
        
            <li><a href="/pub/2011/05/">May 2011 (3)</a></li>
        
    
        
            <li><a href="/pub/2011/04/">April 2011 (1)</a></li>
        
    
        
            <li><a href="/pub/2011/03/">March 2011 (1)</a></li>
        
    
        
            <li><a href="/pub/2011/02/">February 2011 (1)</a></li>
        
    
        
            <li><a href="/pub/2011/01/">January 2011 (1)</a></li>
        
    
        
            <li><a href="/pub/2010/11/">November 2010 (1)</a></li>
        
    
        
            <li><a href="/pub/2010/10/">October 2010 (2)</a></li>
        
    
        
            <li><a href="/pub/2010/09/">September 2010 (1)</a></li>
        
    
        
            <li><a href="/pub/2010/08/">August 2010 (3)</a></li>
        
    
        
            <li><a href="/pub/2010/07/">July 2010 (2)</a></li>
        
    
        
            <li><a href="/pub/2010/04/">April 2010 (2)</a></li>
        
    
        
            <li><a href="/pub/2010/03/">March 2010 (4)</a></li>
        
    
        
            <li><a href="/pub/2008/05/">May 2008 (1)</a></li>
        
    
        
            <li><a href="/pub/2008/04/">April 2008 (2)</a></li>
        
    
        
            <li><a href="/pub/2008/03/">March 2008 (1)</a></li>
        
    
        
            <li><a href="/pub/2008/02/">February 2008 (1)</a></li>
        
    
        
            <li><a href="/pub/2008/01/">January 2008 (1)</a></li>
        
    
        
            <li><a href="/pub/2007/12/">December 2007 (2)</a></li>
        
    
        
            <li><a href="/pub/2007/09/">September 2007 (1)</a></li>
        
    
        
            <li><a href="/pub/2007/08/">August 2007 (1)</a></li>
        
    
        
            <li><a href="/pub/2007/07/">July 2007 (1)</a></li>
        
    
        
            <li><a href="/pub/2007/06/">June 2007 (1)</a></li>
        
    
        
            <li><a href="/pub/2007/05/">May 2007 (1)</a></li>
        
    
        
            <li><a href="/pub/2007/04/">April 2007 (1)</a></li>
        
    
        
            <li><a href="/pub/2007/03/">March 2007 (1)</a></li>
        
    
        
            <li><a href="/pub/2007/02/">February 2007 (1)</a></li>
        
    
        
            <li><a href="/pub/2007/01/">January 2007 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/12/">December 2006 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/11/">November 2006 (2)</a></li>
        
    
        
            <li><a href="/pub/2006/10/">October 2006 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/09/">September 2006 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/08/">August 2006 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/07/">July 2006 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/06/">June 2006 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/05/">May 2006 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/04/">April 2006 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/03/">March 2006 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/02/">February 2006 (4)</a></li>
        
    
        
            <li><a href="/pub/2006/01/">January 2006 (4)</a></li>
        
    
        
            <li><a href="/pub/2005/12/">December 2005 (4)</a></li>
        
    
        
            <li><a href="/pub/2005/11/">November 2005 (3)</a></li>
        
    
        
            <li><a href="/pub/2005/10/">October 2005 (2)</a></li>
        
    
        
            <li><a href="/pub/2005/09/">September 2005 (2)</a></li>
        
    
        
            <li><a href="/pub/2005/08/">August 2005 (9)</a></li>
        
    
        
            <li><a href="/pub/2005/07/">July 2005 (8)</a></li>
        
    
        
            <li><a href="/pub/2005/06/">June 2005 (9)</a></li>
        
    
        
            <li><a href="/pub/2005/05/">May 2005 (8)</a></li>
        
    
        
            <li><a href="/pub/2005/04/">April 2005 (7)</a></li>
        
    
        
            <li><a href="/pub/2005/03/">March 2005 (6)</a></li>
        
    
        
            <li><a href="/pub/2005/02/">February 2005 (7)</a></li>
        
    
        
            <li><a href="/pub/2005/01/">January 2005 (6)</a></li>
        
    
        
            <li><a href="/pub/2004/12/">December 2004 (8)</a></li>
        
    
        
            <li><a href="/pub/2004/11/">November 2004 (8)</a></li>
        
    
        
            <li><a href="/pub/2004/10/">October 2004 (5)</a></li>
        
    
        
            <li><a href="/pub/2004/09/">September 2004 (9)</a></li>
        
    
        
            <li><a href="/pub/2004/08/">August 2004 (6)</a></li>
        
    
        
            <li><a href="/pub/2004/07/">July 2004 (8)</a></li>
        
    
        
            <li><a href="/pub/2004/06/">June 2004 (6)</a></li>
        
    
        
            <li><a href="/pub/2004/05/">May 2004 (7)</a></li>
        
    
        
            <li><a href="/pub/2004/04/">April 2004 (8)</a></li>
        
    
        
            <li><a href="/pub/2004/03/">March 2004 (8)</a></li>
        
    
        
            <li><a href="/pub/2004/02/">February 2004 (9)</a></li>
        
    
        
            <li><a href="/pub/2004/01/">January 2004 (7)</a></li>
        
    
        
            <li><a href="/pub/2003/12/">December 2003 (4)</a></li>
        
    
        
            <li><a href="/pub/2003/11/">November 2003 (7)</a></li>
        
    
        
            <li><a href="/pub/2003/10/">October 2003 (8)</a></li>
        
    
        
            <li><a href="/pub/2003/09/">September 2003 (6)</a></li>
        
    
        
            <li><a href="/pub/2003/08/">August 2003 (7)</a></li>
        
    
        
            <li><a href="/pub/2003/07/">July 2003 (9)</a></li>
        
    
        
            <li><a href="/pub/2003/06/">June 2003 (9)</a></li>
        
    
        
            <li><a href="/pub/2003/05/">May 2003 (8)</a></li>
        
    
        
            <li><a href="/pub/2003/04/">April 2003 (8)</a></li>
        
    
        
            <li><a href="/pub/2003/03/">March 2003 (10)</a></li>
        
    
        
            <li><a href="/pub/2003/02/">February 2003 (8)</a></li>
        
    
        
            <li><a href="/pub/2003/01/">January 2003 (8)</a></li>
        
    
        
            <li><a href="/pub/2002/12/">December 2002 (5)</a></li>
        
    
        
            <li><a href="/pub/2002/11/">November 2002 (9)</a></li>
        
    
        
            <li><a href="/pub/2002/10/">October 2002 (7)</a></li>
        
    
        
            <li><a href="/pub/2002/09/">September 2002 (11)</a></li>
        
    
        
            <li><a href="/pub/2002/08/">August 2002 (8)</a></li>
        
    
        
            <li><a href="/pub/2002/07/">July 2002 (8)</a></li>
        
    
        
            <li><a href="/pub/2002/06/">June 2002 (4)</a></li>
        
    
        
            <li><a href="/pub/2002/05/">May 2002 (6)</a></li>
        
    
        
            <li><a href="/pub/2002/04/">April 2002 (6)</a></li>
        
    
        
            <li><a href="/pub/2002/03/">March 2002 (7)</a></li>
        
    
        
            <li><a href="/pub/2002/02/">February 2002 (5)</a></li>
        
    
        
            <li><a href="/pub/2002/01/">January 2002 (8)</a></li>
        
    
        
            <li><a href="/pub/2001/12/">December 2001 (7)</a></li>
        
    
        
            <li><a href="/pub/2001/11/">November 2001 (5)</a></li>
        
    
        
            <li><a href="/pub/2001/10/">October 2001 (9)</a></li>
        
    
        
            <li><a href="/pub/2001/09/">September 2001 (7)</a></li>
        
    
        
            <li><a href="/pub/2001/08/">August 2001 (13)</a></li>
        
    
        
            <li><a href="/pub/2001/07/">July 2001 (8)</a></li>
        
    
        
            <li><a href="/pub/2001/06/">June 2001 (13)</a></li>
        
    
        
            <li><a href="/pub/2001/05/">May 2001 (11)</a></li>
        
    
        
            <li><a href="/pub/2001/04/">April 2001 (9)</a></li>
        
    
        
            <li><a href="/pub/2001/03/">March 2001 (8)</a></li>
        
    
        
            <li><a href="/pub/2001/02/">February 2001 (8)</a></li>
        
    
        
            <li><a href="/pub/2001/01/">January 2001 (8)</a></li>
        
    
        
            <li><a href="/pub/2000/12/">December 2000 (6)</a></li>
        
    
        
            <li><a href="/pub/2000/11/">November 2000 (10)</a></li>
        
    
        
            <li><a href="/pub/2000/10/">October 2000 (10)</a></li>
        
    
        
            <li><a href="/pub/2000/09/">September 2000 (2)</a></li>
        
    
        
            <li><a href="/pub/2000/08/">August 2000 (2)</a></li>
        
    
        
            <li><a href="/pub/2000/07/">July 2000 (5)</a></li>
        
    
        
            <li><a href="/pub/2000/06/">June 2000 (7)</a></li>
        
    
        
            <li><a href="/pub/2000/05/">May 2000 (7)</a></li>
        
    
        
            <li><a href="/pub/2000/04/">April 2000 (3)</a></li>
        
    
        
            <li><a href="/pub/2000/03/">March 2000 (2)</a></li>
        
    
        
            <li><a href="/pub/2000/02/">February 2000 (2)</a></li>
        
    
        
            <li><a href="/pub/2000/01/">January 2000 (2)</a></li>
        
    
        
            <li><a href="/pub/1999/12/">December 1999 (6)</a></li>
        
    
        
            <li><a href="/pub/1999/11/">November 1999 (6)</a></li>
        
    
        
            <li><a href="/pub/1999/10/">October 1999 (5)</a></li>
        
    
        
            <li><a href="/pub/1999/09/">September 1999 (4)</a></li>
        
    
        
            <li><a href="/pub/1999/08/">August 1999 (3)</a></li>
        
    
        
            <li><a href="/pub/1999/07/">July 1999 (2)</a></li>
        
    
        
            <li><a href="/pub/1999/06/">June 1999 (3)</a></li>
        
    
        
            <li><a href="/pub/1999/04/">April 1999 (1)</a></li>
        
    
        
            <li><a href="/pub/1999/03/">March 1999 (1)</a></li>
        
    
        
            <li><a href="/pub/1999/01/">January 1999 (1)</a></li>
        
    
        
            <li><a href="/pub/1998/12/">December 1998 (1)</a></li>
        
    
        
            <li><a href="/pub/1998/11/">November 1998 (1)</a></li>
        
    
        
            <li><a href="/pub/1998/07/">July 1998 (2)</a></li>
        
    
        
            <li><a href="/pub/1998/06/">June 1998 (1)</a></li>
        
    
        
            <li><a href="/pub/1998/03/">March 1998 (1)</a></li>
        
        </ul>
    </div>
</div>
        
    

<div class="widget-powered widget">
    <div class="widget-content">
        <a href="http://www.movabletype.com/"><img src="/mt-static/images/bug-pbmt-white.png" alt="Powered by Movable Type 5.13-en" width="120" height="75" /></a>
    </div>
</div>



    </div>
</div>






                </div>
            </div>


            <div id="footer">
    <div id="footer-inner">
        <div id="footer-content">
            <div class="widget-powered widget">
                <div class="widget-content">
                    Powered by <a href="http://www.movabletype.com/" rel="generator">Movable Type Pro</a>
                </div>
            </div>

            <div class="widget-creative-commons widget">
                <div class="widget-content">
                    This blog is licensed under a <a href="http://creativecommons.org/licenses/by-nc-nd/3.0/">Creative Commons License</a>.
                </div>
            </div>

        </div>
    </div>
</div>



        </div>
    </div>
</body>
</html>
