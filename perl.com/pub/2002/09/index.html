<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" id="sixapart-standard">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="generator" content="Movable Type Pro 5.13-en" />
<link rel="stylesheet" href="/pub/styles.css" type="text/css" />
<link rel="start" href="/pub/" title="Home" />
<link rel="alternate" type="application/atom+xml" title="Recent Entries" href="/pub/atom.xml" />
<script type="text/javascript" src="/pub/mt.js"></script>
<!--
<rdf:RDF xmlns="http://web.resource.org/cc/"
         xmlns:dc="http://purl.org/dc/elements/1.1/"
         xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#">
<Work rdf:about="/pub/">
<dc:title>Perl.com</dc:title>
<dc:description>news and views of the Perl programming language</dc:description>
<license rdf:resource="http://creativecommons.org/licenses/by-nc-nd/3.0/" />
</Work>
<License rdf:about="http://creativecommons.org/licenses/by-nc-nd/3.0/">
</License>
</rdf:RDF>
-->

<script type="text/javascript">

 var _gaq = _gaq || [];
 _gaq.push(['_setAccount', 'UA-50555-22']);
 _gaq.push(['_trackPageview']);

 (function() {
   var ga = document.createElement('script'); ga.type =
   'text/javascript'; ga.async = true;
   ga.src = ('https:' == document.location.protocol ? 'https://ssl' :
   'http://www') + '.google-analytics.com/ga.js';
   var s = document.getElementsByTagName('script')[0];
   s.parentNode.insertBefore(ga, s);
 })();

</script>
<script type='text/javascript' src='http://partner.googleadservices.com/gampad/google_service.js'></script>
<script type='text/javascript'>
GS_googleAddAdSenseService("ca-pub-4136420132070439");
GS_googleEnableAllServices();
</script>
<script type='text/javascript'>
GA_googleAddSlot("ca-pub-4136420132070439", "Perl_728x90");
</script>
<script type='text/javascript'>GA_googleFetchAds();</script>
    <title>Perl.com: September 2002 Archives</title>


    <link rel="prev" href="/pub/2002/08/" title="August 2002" />
    <link rel="next" href="/pub/2002/10/" title="October 2002" />

</head>
<body id="perl-com" class="mt-archive-listing mt-datebased-monthly-archive layout-wt">
    <div id="container">
        <div id="container-inner">


            <div id="header">
    <div id="header-inner">
        <div id="header-content">
        <span id="top_advert"> 
<!-- Put any landscape advert in here -->
<!-- Perl_728x90 -->
<script type='text/javascript'>
GA_googleFillSlot("Perl_728x90");
</script>
        </span> 



            <div id="header-name"><a href="/pub/" accesskey="1">Perl.com</a></div>
            <div id="header-description">news and views of the Perl programming language</div>




        </div>
    </div>
</div>



            <div id="content">
                <div id="content-inner">


                    <div id="alpha">
                        <div id="alpha-inner">


                            <h1 id="page-title" class="archive-title">September 2002 Archives</h1>





                            
                            <div id="entry-1372" class="entry-asset asset hentry">
    <div class="asset-header">
        <h2 class="asset-name entry-title"><a href="/pub/2002/09/p6pdigest/20020929.html" rel="bookmark">This week on Perl 6 (9/23 - 9/29, 2002)</a></h2>
        <div class="asset-meta">
            <span class="byline">
    
                By <span class="vcard author">Piers Cawley</span> on <abbr class="published" title="2002-09-29T00:00:00-08:00">September 29, 2002 12:00 AM</abbr>
    
            </span>

            
            

        </div>
    </div>
    <div class="asset-content entry-content">

        <div class="asset-body">
            

<p>Okay, this is my last summary before I take a couple of week's holiday
away from any form of connectivity. Will I cope? Can my system stand
going cold turkey? Can you live without my summaries?</p>
<p>Luckily, Leon Brocard has been volunteered to step into the breach and
produce summaries for the next couple of weeks.</p>
<p>Oh yes, due to my being a lazy swine and not reading release notes,
combined with a new version of Spamassassin no longer delivering mail
by default (now it silently drops mail on the floor in cases where it
had previously just delivered the mail), I may be missing some
messages from this week. Sorry.</p>
<p>We'll kick off, as usual with happenings on the internal list:</p>

<h4><a name="of_variables,_values_and_vtables">Of Variables, Values and Vtables</a></h4>
<p>Dan stopped travelling (for a while at least), and listed the current
short term goals for Parrot. They are:</p>
<ul>
<li><strong><a name="item_finish_up_the_calling_convention_changes">Finish up the calling convention changes</a></strong><br />
</li>
<li><strong><a name="item_spec_the_pmc_changes">Spec the PMC changes</a></strong><br />
</li>
<li><strong><a name="item_spec_the_vtable_changes">Spec the vtable changes</a></strong><br />
</li>
<li><strong><a name="item_get_exceptions_fully_defined_and_a_preliminary_imp">Get exceptions fully defined and a preliminary implementation</a></strong><br />
</li>
</ul>
<p>and promised the variable/vtable stuff in the 'next day or so', with
the calling convention stuff a little earlier or later. Leo Toetsch
offered some his thoughts on vtable methods for _keyed opcodes.</p>
<p><a href="http://groups.google.com/groups?threadm=a05111b06b9b5199ba3f4%40%5B63.120.19.221%5D">http://groups.google.com/groups</a></p>
<p><a href="http://groups.google.com/groups?threadm=3D8FFA9B.50801%40toetsch.at">http://groups.google.com/groups</a></p>

<h4><a name="imcc_0.0.9.2">IMCC 0.0.9.2</a></h4>
<p>Leopold Toetsch provided a patch which 'fixes all currently known
problems [with respect to] IMCC/Perl6'. Andy Dougherty had some
problems with the patch dumping core, possibly because of platform
specific issues, and Steve Fink realised that there was an overlap
between this patch and one he'd been working on. The patch has not yet
been applied, but work continued.</p>
<p><a href="http://rt.perl.org/rt2/Ticket/Display.html?id=17537">http://rt.perl.org/rt2/Ticket/Display.html</a></p>


<h3><a name="fun_with_intlists">Fun with intlists</a></h3>
<p>Leopold Toetsch showed some benchmarks of intlist against PerlArrays,
the difference is stunning. The intlist based test is some ten times
faster than PerlArray, with most of PerlArray's time being spent
allocating memory. Leo suggests using intlist as the PerlArray base
class.</p>
<p>Having got bragging rights for one speed up, Leo sent in a second
patch which gave <em>another</em> ten fold performance boost. Sean O'Rourke
had a few questions about performance in typical usage and wondered
if, we shouldn't look at using borrowing from SGI's STL implementation
of a dequeue (double ended queue). Leo was ahead of him there; his
second patch was already using the trick Sean had suggested.</p>
<p><a href="http://groups.google.com/groups?threadm=3D8EF7B5.7020800%40toetsch.at">http://groups.google.com/groups</a></p>
<p><a href="http://groups.google.com/groups?threadm=rt-17549-38478.11.1914996847459%40bugs6.perl.org">http://groups.google.com/groups</a></p>

<h4><a name="functions_in_scheme">Functions in Scheme</a></h4>
<p>J&uuml;rgen B<code>ouml</code>mmels sent a pre patch which gets Scheme
functions working. It's built on top of an early version of Sean
O'Rourke's <em>scratchpad.pmc</em>, so be careful applying the initial
patch. Sean hoped that it would be be easy to reconcile J&uuml;rgen's
changes to the scratchpad pmc with the changes he'd made since he sent
J&uuml;rgen his early code. Jonathan Sillito asked why the scheme
interpreter maintained its own environment stack rather than use the
<code>pad_stack</code>. Apparently the current pad_stack is very closely tied to
Sub.pmc, which doesn't quite offer the semantics needed for scheme
functions. Also, the pad_stack makes it tricky to implement <code>set!</code>
and <code>define</code> correctly.</p>
<p>Dan chimed in asking everyone to hash out what they needed from
scratchpads and lexical variables; once we have that nailed down it
should be easy to get everything designed and implemented reasonably
quickly, so J&uuml;rgen and Sean came up with a list between them.</p>
<p><a href="http://groups.google.com/groups?threadm=m2fzvzhhuv.fsf%40helium.physik.uni-kl.de">http://groups.google.com/groups</a> -- The patch</p>
<p><a href="http://groups.google.com/groups?threadm=m2znu7cjv2.fsf%40helium.physik.uni-kl.de">http://groups.google.com/groups</a> -- Its description</p>

<h4><a name="perl6_on_hpux_11.00">Perl6 on HP-UX 11.00</a></h4>
<p>H Merijn Brand was having trouble getting Perl 6 to work on HP-UX. It
was initially thought that this was a problem with the version of perl
he was using, but was eventually tracked down to a problem with <code>make
test</code>; the tests passed when Merijn did <code>perl6 --test</code>. However the
thread also covered making sure that the Perl6 build process rebuilt
the Grammar if appropriate. There's also a theory that there's a
problem with IMCC generating .pasm files.</p>
<p>Leopold Toetsch put his hand up for causing the problem, and submitted
a patch to fix things. Applied.</p>
<p><a href="http://groups.google.com/groups?threadm=20020926170219.C871.H.M.BRAND%40hccnet.nl">http://groups.google.com/groups</a></p>
<p><a href="http://groups.google.com/groups?threadm=rt-17615-38723.14.5807354709082%40bugs6.perl.org">http://groups.google.com/groups</a></p>















<h4><a name="the_status_of_leopold_toetsch's_patches">The status of Leopold Toetsch's patches</a></h4>
<p>Leo wondered what's happening with the pile of patches he's submitted
this week. At the time he made the post, he had 15 patches outstanding
(or is that 'outstanding patches'?) and, as a result several of the
patches were applied. Steve Fink voted that Leo should be given commit
access to CVS and Leo was grateful for the vote of confidence.</p>
<p>Leo later sent in yet another patch for intlist, which after a short
quibble from Tom Hughes, and a correction from Leo, was applied.</p>
<p><a href="http://groups.google.com/groups?threadm=3D922E2B.6010507%40toetsch.at">http://groups.google.com/groups</a></p>
<p><a href="http://rt.perl.org/rt2/Ticket/Display.html?id=17621">http://rt.perl.org/rt2/Ticket/Display.html</a></p>

<h4><a name="of_pmcs_buffers_and_memory_management">Of PMCs Buffers and memory management</a></h4>
<p>Worker of the week, Leo Toetsch posted a bunch of questions about
PMCs, Buffers and their associated memory management. Firstly, he
wondered why there was a separation between the two. He commented that
'If PMCs and Buffers are unified, it should be possible to mark
[during a GC run] in one recursive process'. And there's the rub; we
don't like recursion. PMCs are structured in such a way that a PMC
tree can be walked in iterative fashion, which means that GC can be
done in pretty much constant memory. Leo had a bunch of other
questions, that were mostly answered by Mike Lambert, which drew
supplementary questions from Leo. Both Mike and Leo agreed that the
changes needed to Parrot for unification would lead to massive
patches; but that's not a reason for <em>not</em> doing the work.</p>
<p><a href="http://groups.google.com/groups?threadm=3D9408A8.50306%40toetsch.at">http://groups.google.com/groups</a></p>
<p><a href="http://groups.google.com/groups?threadm=Pine.LNX.4.44.0209271641300.5514-100000%40jall.org">http://groups.google.com/groups</a></p>

<h4><a name="add_stone_age_exception_handling">Add Stone Age Exception Handling</a></h4>
<p>This should possibly really go in the 'In Brief' section because there
was only one post in the 'thread'. But it looks like an important
post. Brent Dax sent in a patch which 'adds a very, very rudimentary
form of C-level exception handling' to parrot. Brent Reckons that
brings parrot up to slightly better than 'homo erectus' quality
exception handling.</p>
<p><a href="http://rt.perl.org/rt2/Ticket/Display.html?id=17646">http://rt.perl.org/rt2/Ticket/Display.html</a></p>


<h3><a name="meanwhile,_in_perl_6">Meanwhile, in Perl 6</a></h3>
<p>I can't remember who it was christened this week's monster thread
'Paren Madness', but they weren't wrong. The 'Here, we can build a
list like this...'  thread continued on its merry way. I'm afraid I
pretty much stopped reading once it became apparent that the only
thing that was going to stop the madness was Larry making a
pronouncement. Eventually Dan stepped up and asked if someone could
summarize the discussion, maybe with a few possible conclusions, and
then leave it for a while 'til Larry got back. Luke Palmer wrote it up
and offered a suggestion which looks at first glance to be sane, and
which seemed to be well liked.</p>
<p><a href="http://groups.google.com/groups?threadm=a05111b06b9b678a3ac16%40%5B63.120.19.221%5D">http://groups.google.com/groups</a></p>
<p><a href="http://groups.google.com/groups?threadm=Pine.LNX.4.44.0209241523490.26307-100000%40babylonia.flatirons.org">http://groups.google.com/groups</a></p>

<h4><a name="for_loop_and_streams">For loop and streams</a></h4>
<p>In pretty much the only other substantial thread of the week,
<a href="mailto:'dulfer@widd.de'">'dulfer@widd.de'</a> had some problems with the new <code>for</code> loop using
multiple counters, and wondered if this was because of problems with
the current Perl6 implementation, or because of problems with his
understanding. It turned out that it was a problem with Sean
O'Rourke's understanding when he implemented the Perl 6 grammar; he'd
missed something in the appropriate Apocalypse. There also seems to be
a problem in that the current behaviour is mostly defined with hand
waves, which is great when you're doing the broad brush design, but
less great when you're trying to implement the language.</p>
<p><a href="http://groups.google.com/groups?threadm=200209261254.g8QCs8n09224%40p15100460.pureserver.info">http://groups.google.com/groups</a></p>


<h3><a name="in_brief">In Brief</a></h3>
<p>Leopold Toetsch patched <em>packfile.c</em> to stop monkeying with the
internals of key structures.</p>
<p>Parrot T Shirts, based on Andy Wardley's parrot logo design, are now
available from Cafe Press at
<a href="http://www.cafeshops.com/cp/store.aspx?s=parrotstuff1">http://www.cafeshops.com/cp/store.aspx</a>, any proceeds
go to YAS/TPF.</p>
<p>Simon Cozens found, and patched a problem with IMCC's 'ostat'
structure, which clashed with a structure in Darwin's <em>stat.h</em>.</p>
<p>Leopold Toetsch has been playing with using Doug Lea's memory
allocator (see <a href="http://gee.cs.oswego.edu/dl/html/malloc.html">http://gee.cs.oswego.edu/dl/html/malloc.html</a>) in
Parrot. Apparently it makes 'life' run faster, but appears to double
the memory footprint.</p>
<p>Steve Fink sent in some patches for IMCC, Leopold Toetsch did some
cherry picking and released an integrated patch.</p>
<p>Erik Lechak wondered if there was a getting started guide to parrot,
and if there wasn't, how should he go about writing one? My tip: Do
it, use the tools you prefer to make the kind of guide you would have
welcomed finding when you first came to parrot. Just don't use
proprietary formats. Heck, it's how I started writing these summaries.</p>


<h3><a name="who's_who_in_perl_6">Who's Who in Perl 6</a></h3>
<dl>
<dt><strong><a name="item_who_are_you%3f">Who are you?</a></strong><br />
</dt>
<dd>
Piers Cawley
</dd>
<dt><strong><a name="item_what_do_you_do_for%2fwith_perl_6%3f">What do you do for/with Perl 6?</a></strong><br />
</dt>
<dd>
I write the summaries every week, and try and contribute to
perl6-language and perl6-internals when they're discussing things I
know about.
</dd>
<dt><strong><a name="item_where_are_you_coming_from%3f">Where are you coming from?</a></strong><br />
</dt>
<dd>
I've been a happy Perl user for since around 4.036, initially using it
as a shell and awk replacement for system administration tasks, then
moving over into a programming r&ocirc;le where I got heavily into
OO Perl. As so many others have said, Perl 5 fits my brain better than
anything else I've been paid to do, but Perl 6 offers the chance to
make that fit much closer.
</dd>
<dt><strong><a name="item_when_do_you_think_perl_6_will_be_released%3f">When do you think Perl 6 will be released?</a></strong><br />
</dt>
<dd>
Sooner than we all think. Later than I want.
</dd>
<dt><strong><a name="item_why_are_you_doing_this%3f">Why are you doing this?</a></strong><br />
</dt>
<dd>
Someone had to. I missed Bryan's summaries and decided that, if nobody
else was going to volunteer it might as well be me.
</dd>
<dt><strong><a name="item_you_have_5_words%2e_describe_yourself%2e">You have 5 words. Describe yourself.</a></strong><br />
</dt>
<dd>
Just another opinionated Perl hack.
</dd>

<dt><strong><a name="item_do_you_have_anything_to_declare%3f">Do you have anything to declare?</a></strong><br />
</dt>
<dd>
I've run out of answer sets to this questionnaire. C'mon people, your
summarizer needs you.
</dd>
</dl>

<h3><a name="acknowledgements">Acknowledgements</a></h3>
<p>Thanks to Piers Cawley, for taking time out of his massively busy
schedule to answer the questionnaire; to Leon Brocard, for not
squawking too loudly when he got volunteered to do the next two
summaries; to Leo Toetsch, for a fantastic number of patches this
week; to Simon Cozens, for coming back to Perl 6; to the lovely Gill,
for continuing to put up with me, day in, day out...</p>
<p>Hmm... check out the Oscar speech.</p>
<p>I'm trying an experiment this week, community proofreading. I'll run
the speelchucker over this summary and release it to the ravening
masses. Who knows, maybe it'll make sense. It does at least have the
right date at the top of the page.</p>
<p>Once more, if you think this summary has value send money to the Perl
Foundation <a href="http://donate.perl-foundation.org">http://donate.perl-foundation.org</a> and feed back and/or
T?iBooks to me, <em><a href="mailto:mailto:pdcawley@bofh.org.uk">mailto:pdcawley@bofh.org.uk</a></em>. As usual, the fee paid
for publication of this summary on perl.com has been donated directly
to the Perl Foundation.</p>
        </div>



    </div>
    <div class="asset-footer"></div>
</div>


                            
                            <div id="entry-1362" class="entry-asset asset hentry">
    <div class="asset-header">
        <h2 class="asset-name entry-title"><a href="/pub/2002/09/24/axkit.html" rel="bookmark">An AxKit Image Gallery</a></h2>
        <div class="asset-meta">
            <span class="byline">
    
                By <span class="vcard author">Barrie Slaymaker</span> on <abbr class="published" title="2002-09-24T00:00:00-08:00">September 24, 2002 12:00 AM</abbr>
    
            </span>

            
            

        </div>
    </div>
    <div class="asset-content entry-content">

        <div class="asset-body">
            
<!-- sidebar begins -->
<!-- don't move sidebars -->
<!-- sidebar ends -->
<p>AxKit is not limited to working with pure XML data.  Starting with
this article, we'll work with and around non-XML data by developing
an image browser that works with two types of non-XML data: a directory
listing built from operating system calls (file names and statistics)
and image files. Furthermore, it will be built from small modules that
you can adapt to your needs or use elsewhere, like the <a href="/pub/a/2002/09/24/axkit.html?page=4#My::Thumbnailer">thumbnail generator</a> or the <a href="/pub/a/2002/09/24/axkit.html?page=3#XML::Filter::TableWrapper">HTML table wrapper</a>.</p>

<p>By the time we're done, several articles from now, we'd like an
application that:</p>

<ul>

  <li>provides navigation around a tree of directories containing images,</li>

  <li>displays <a href="/pub/a/2002/09/24/axkit.html?page=1#proofsheet.png">image galleries with
  thumbnails</a>,</li>

  <li>ignores nonimage files,</li>

  <li>allows you to define and present a custom set of information
  ("meta data") about each image,</li>

  <li>allows you to view the complete images with and without
  metadata,</li>

  <li>uses a non-AxKit mod_perl handler to generate thumbnail images on
  the fly, and</li>

  <li>allows you to edit the metadata information in-browser</li>

</ul>

<p>That feature list should allow us to build a "real world" 
application (rather than the weather examples we've
discussed so far), and hopefully a useful one as well.  Here's a
screenshot of the page created by this article and the next:</p>

<p><a name="proofsheet.png"></a><img src="/pub/2002/09/24/graphics/proofsheet.png" alt="Example page." width="472" height="661" border="0"/></p>

<p>That page has four sections:</p>

<ol>
    <li><b>Heading</b>: Tells you where you are and offers navigation
    up the directory tree.</li>
    <li><b>Folders</b>: links to the parent directory and any sub
    folders (Jim and Mary).</li>
    <li><b>Images</b>: offers a thumbnail and caption area for
    each image.  Clicking on an image or image title takes you to
    the full-size variant.</li>
    <li><b>Footer</b>: A breadcrumbs display for getting back up the
    directory tree after scrolling down through a large page of
    images.</li>
</ol>

<p>We'll implement the (most challenging) third section in this article
and the other section in the next article.</p>

<p>If you want to review the basics of AxKit and Apache configuration,
then here are the previous articles in this series:</p>

<ul>
    <li><a href="/pub/a/2002/03/12/axkit.html">Introducing
    AxKit</a></li>
    <li><a href="/pub/a/2002/04/16/axkit.html">XSP,
    Taglibs and Pipelines</a></li>
    <li><a href="/pub/a/2002/07/02/axkit.html">Taglib TMTOWTDI</a></li>
</ul>

<a name="WorkingWithNonXMLDataAsXML"/><h3>Working with non-XML data as XML</h3>

<p>The easiest way to actually work with non-XML data in AxKit is 
to turn it in to XML often and feed it to AxKit.  AxKit itself takes this
approach in its new directory handling feature -- thanks to Matt Sergeant
and J&ouml;rg Walters AxKit can now scan the directory and build an XML
document with all of the data.  This is a lot like what native Apache
does when it serves up an HTML directory listing, but it allows
you to filter it.  The main part of this article is about
filtering this directory listing in order to create a gallery, or
proofsheet, of thumbnail images.</p>

<!--  begin sidebar  -->
<table width="50%" border="0" cellspacing="8" cellpadding="8"  align="right">
<tr><td valign="top" bgcolor="#efefef">
<p class="medlist"><b>In This Series</b></p>
<p class="smalllist"><b>
<a href="/pub/a/2002/03/16/axkit.html">Introducing AxKit</a></b><br />
The first in a series of articles by Barrie Slaymaker on setting up and running
AxKit. AxKit is a mod_perl application for dynamically transforming XML. In this
 first article, we focus on getting started with AxKit.</p>
<p class="smalllist"><b>
<a href="/pub/a/2002/04/16/axkit.html">XSP, Taglibs and Pipelines</a></b><br />
Barrie explains what a "taglib" is, and how to use them to create dynamic pages
inside of AxKit.</p>
<p class="smalllist"><b><a href="/pub/a/2002/07/02/axkit.html">Taglib TMTOWTDI</a></b><br />
Continuing our look at AxKit tag libraries, Barrie explains the use of SimpleTaglib and LogicSheets.</p>
</td></tr>
</table>
<!--  end sidebar  -->

<p>In this case, we'll be using a relatively recent addition to AxKit's
standard toolkit, SAX Machines, integrated in to AxKit thanks to Kip
Hampton. (disclaimer: <a href="http://search.cpan.org/author/RBS/XML-SAX-Machines/lib/XML/SAX/Machines.pm">XML::SAX::Machines</a>
is a module I wrote.) The SAX machine we'll create will be a straight
pipeline with a few filters, a lot like the pipelines that AxKit uses.
This pipeline will dissect directory listings and generate a list of
images segmented into rows for easy display purposes.  We don't get in
to the details of SAX or SAX machines except to bolt together three
building blocks; all of the gory details are handled for us by other
modules.  If you are interested in the gory details, then see <a href="http://xml.com/pub/a/2002/02/13/sax-machines.html">Part One</a>
and <a href="http://xml.com/pub/a/2002/03/20/machines.html">Part Two</a>
of Kip's article "Introducing XML::SAX::Machines" on <a href="http://xml.com/">XML.com</a>.</p>

<p>After the SAX machine builds our list of images, XSLT will be used to
merge in metadata (like image titles and comments) from independant XML
files and format the result for the browser.  The resulting pages look
like:</p>


<a name="ManagingNonXMLData"/><h3>Managing non-XML data (the images)</h3>

<p>On the other hand, it doesn't make sense to XMLify raw image data (though things like <a href="http://www.w3.org/TR/SVG/">SVG</a>--covered in <a href="http://www.xml.com/pub/q/sacresvg">XML.com's Sacre SVG
articles</a>--and <a href="http://www.lysator.liu.se/~alla/dia/">dia</a>
files are a natural fit), so we'll take advantage of AxKit's integration
with Apache and mod_perl to delegate image handlng to these more suitable
tools.</p>

<p>This is done by using a distinctive URL for thumbnail image files and
a custom mod_perl handler, <a href="/pub/a/2002/09/24/axkit.html?page=4#My::Thumbnailer">My::Thumbnailer</a> to convert full-size images
to thumbnails.  Neither AxKit nor mod_perl code will be used to serve
the images, that will be left to Apache.</p>

<p>Thumbnails will be autogenerated in files with the same name as the
main image file with a leading period (".") stuck on the front.  In Unix
land, this indicates a hidden file, and we don't want thumbnails (or other
dotfiles) showing up in our gallery pages.</p>

<p>My::Thumbnailer uses the relatively new <a href="http://search.cpan.org/author/ADDI/Imager/Imager.pm">Imager</a>
module by Arnar M. Hrafnkelsson and Tony Cook.  This is a best-of-breed
module that competes with the likes of the venerable <a href="http://search.cpan.org/author/LDS/GD/GD.pm">GD</a>, the juggernaut
<a href="http://search.cpan.org/author/JCRISTY/PerlMagick/Magick.pm">Image::Magick</a>,
and <a href="http://search.cpan.org/author/JLAPEYRE/libplot-perl/Libplot.pm">Graphics::Libplot</a>).
Imager is gaining a reputation for speed, quality and a full-featured
API.</p>


<csperl file="include_from_orn" record="b/708" template="b/article_sidebar2.view">



<a name="TheMetaFile" /><h3>The <code>.meta</code> file</h3>

<p>Before we delve in to the implementation, let's look at one of the
more subtle points of this design.  Our previous examples have all been
of straight pipelines that successively process a source document into
an HTML page.  In this application, however, we'll be funneling data
from the source document and a collection of related files we'll call
meta files.</p>

<p>This subtlety is not apparent from the <a href="/pub/a/2002/09/24/axkit.html?page=1#proofsheet.png">screenshot</a>, but if you look closely you can
see that the caption for the first image ("A baby picture") contains
more information than the captions for the other eight.  This is because
the first image has a meta file that contains a title and a comment to
be displayed while the others don't (though they could).</p>

<p> The first image ("A baby picture") is from a file named
<code>a-look.jpeg</code>, for which there is a meta file named
<code>a-look.meta</code> in the same directory that looks like
(<b>bold</b> shows the data that ends up getting sent to the
browser):</p>

<a name="a-look.meta"/>
<pre><code>    &lt;meta&gt;
      &lt;title&gt;<b>A baby picture</b>&lt;/title&gt;
      &lt;comment&gt;
        <b>&lt;b&gt;ME!&lt;/b&gt;.  Well, not really.  Actually, it's some
        random image from the 'net.</b>
      &lt;/comment&gt;
    &lt;/meta&gt;</code></pre>

<p>An important feature of this file is that its contents and how they
are presented within the caption area are completely unspecified by the
core image gallery code.  This makes our image gallery highly
customizable: the site designer can determine what meta information
needs to be associated with each image and how that information gets 
presented.  Data can be presented in the thumbnail caption, in the
expanded view, or used for nondisplay purposes.</p>

<p>Here's what's in each caption area:</p>

<ol>

  <li><b>The title</b>.  If a .meta file is found for an image and it
  has a nonempty <code>&lt;title&gt;</code> element, then it is used
  as the name, otherwise the image's filename is stripped of extensions
  and used.</li>

  <li><b>The last modified time of the image file</b> (in server-local
  time, unfortunately).</li>

  <li><b>A comment</b> (optional): if a .meta file has a
  <code>&lt;comment&gt;</code> element, including XHTML markup, it is
  displayed.</li>

</ol>

<p>Why a .meta file per image instead of one huge file? It will
hopefully allow admins to manage images and meta files together and to
allow us to access an image's meta information in a single file, a
natural thing to do in AxKit.  By having a pair of files for each image,
you can use simple filesystem manipulations to move them around, or use
filesystem links to make an image appear in multiple directories,
perhaps with the same meta file, perhaps with different ones.  This way
we don't need to develop a lot of complex features to get a lot of
mileage out of our image gallery (though we could if need be).</p>


<a name="ThePipeline" /><h3>The Pipeline</h3>

<p>No AxKit implementation documentation would be complete without
detailing the pipeline.  Here is the pipeline for the image proofsheet
page shown above (click on any of the boxes to take you to the
discussion about that portion of the pipeline, click on any of the
miniature versions of this diagram to come to this one):</p>

<a name="pipeline.png"></a>
<table width="450" border="0" cellspacing="0" cellpadding="0"><tr><td>
<p class="secondary"><img src="/pub/2002/09/24/graphics/pipeline.png" alt="The AxKit pipeline for the image gallery application, take 1" width="450" height="385" border="0" USEMAP="pipeline_png_map" /><br />
<MAP name="pipeline_png_map" id="pipeline_png_map">
<!-- #$-:Image Map file created by GIMP Imagemap Plugin -->
<!-- #$-:GIMP Imagemap Plugin by Maurits Rijk -->
<!-- #$-:Please do not edit lines starting with "#$" -->
<!-- #$VERSION:1.3 -->
<!-- #$AUTHOR:barries -->
<AREA SHAPE="RECT" COORDS="0,0,71,100" href="/pub/a/2002/09/24/axkit.html?page=2#filelist" alt="The &lt;filelist&gt; document generated by AxKit">
<AREA SHAPE="RECT" COORDS="87,43,186,69" href="/pub/a/2002/09/24/axkit.html?page=2#My::Filelist2Data" alt="My::Filelist2Data. Converts the <filelist> to a Perl data structure">
<AREA SHAPE="RECT" COORDS="201,43,280,69" href="/pub/a/2002/09/24/axkit.html?page=3#My::ProofSheet" alt="My::ProofSheet.  Takes the Perl data structure and generates a list of images with some metadata">
<AREA SHAPE="RECT" COORDS="297,43,390,70" href="/pub/a/2002/09/24/axkit.html?page=3#XML::Filter::TableWrapper" alt="XML::Filter::TableWrapper.  Segments the list of images in to rows suitable for use in an HTML &lt;table&gt;">
<AREA SHAPE="RECT" COORDS="73,0,408,82" href="/pub/a/2002/09/24/axkit.html?page=2#My::ProofSheetMachine" alt="My::ProofSheetMachine.  A SAX machine containing 3 SAX filters">
<AREA SHAPE="RECT" COORDS="62,219,146,358" href="/pub/a/2002/09/24/axkit.html?page=3#rowsplitter.xsl" alt="rowsplitter.xsl.  Converts each row of thumbnail metadata in to two rows, one for images, the other for captions">
<AREA SHAPE="RECT" COORDS="147,218,221,384" href="/pub/a/2002/09/24/axkit.html?page=3#metamerger.xsl" alt="metamerger.xsl.  Adds in the external .meta files, if they exist">
<AREA SHAPE="RECT" COORDS="105,123,267,199" href="/pub/a/2002/09/24/axkit.html#TheMetaFile" alt=".meta files for the images">
<AREA SHAPE="RECT" COORDS="226,219,302,358" href="/pub/a/2002/09/24/axkit.html?page=4#captionstyler.xsl" alt="captionstyler.xsl.  Converts the captions to XHTML">
<AREA SHAPE="RECT" COORDS="306,218,386,382" href="/pub/a/2002/09/24/axkit.html?page=4#pagestyler.xsl" alt="pagestyler.xsl.  Converts the main part of the page to XHTML">
<AREA SHAPE="RECT" COORDS="391,208,449,292" href="/pub/a/2002/09/24/axkit.html?page=1#proofsheet.png" alt="the final output">
</MAP>
The blue documents are content: the directory listing, the meta files and the generated HTML.  This does not show the image processing, see <a href="/pub/a/2002/09/24/axkit.html?page=4#My::Thumbnailer">My::Thumbnailer</a> for that.</p>

</td></tr></table>

<p>In this case, unlike our previous pipelines, data does not flow in a
purely linear fashion: The directory listing from AxKit (<a href="/pub/a/2002/09/24/axkit.html?page=2#filelist">&lt;filelist&gt;</a>) feeds the pipeline and is
massaged by three SAX filters and then by four XSLT filters.  There are so many
filters because this application is built to be customizable by tweaking
specific filters or by adding other filters to the pipeline.  It also
uses several SAX filters available on CPAN to make life
much easier for us.</p>

<p>In actual use, you may want to add more filters for things like
branding, distinguishing groups of images by giving directory
heirarchies different backgrounds or titles, adding ad banners, etc.</p>
  
<p>Here's a brief description of what each filter does, and why each is
an independant filter:</p>

<ul>

  <li><a href="/pub/a/2002/09/24/axkit.html?page=2#My::ProofSheetMachine">My::ProofSheetMachine</a> is a
  short module that builds a <a href="http://search.cpan.org/author/RBS/XML-SAX-Machines/lib/XML/SAX/Machines.pm#DESCRIPTION">SAX
  Machine Pipeline</a>.  SAX filters are used in this application to
  handle tasks that are more suited to Perl than to XSLT or XSP:

    <ul>

      <li><a href="/pub/a/2002/09/24/axkit.html?page=2#My::Filelist2Data">My::FileList2Data</a> is another
      short module that uses the <a href="http://search.cpan.org/author/GRANTM/XML-Simple/Simple.pm">XML::Simple</a>
      module from CPAN to convert the <code>&lt;filelist&gt;</code> in
      to a Perl data structure that is passed on.  This is its own
      filter because we want to customize XML::Simple and the resulting
      data structure a bit before passing it on.</li>

      <li><a href="/pub/a/2002/09/24/axkit.html?page=3#My::ProofSheet">My::ProofSheet</a> is the heart of
      the gallery page generation.  It builds a list of images from the
      filelist data structure and adds information about the
      thumbnail images and meta files.</li>

      <li><a href="/pub/a/2002/09/24/axkit.html?page=3#XML::Filter::TableWrapper">XML::Filter::TableWrapper</a>
      is a module from CPAN
      that is used to wrap a possibly lengthy list of images into rows
      of no more than five images each.</li>

    </ul>

  </li>

  <li><a href="/pub/a/2002/09/24/axkit.html?page=3#rowsplitter.xsl">rowsplitter.xsl</a> takes each row of images and makes it
  into two table rows: one for the images and one for the captions.
  This is easier to do in XSLT than in SAX, so here is where we shift
  from SAX processing to XSLT processing.</li>

  <li><a href="/pub/a/2002/09/24/axkit.html?page=3#metamerger.xsl">metamerger.xsl</a> examines each caption
  to see if My::ProofSheet put the URL for a meta file in it.  If so, it
  opens the meta file and inserts it in the caption.  This is a separate
  filter because the site admin may prefer to write a custom filter here
  to integrate meta information from some other source, like a single
  master file or a centralized database.</li>

  <li><a href="/pub/a/2002/09/24/axkit.html?page=4#captionstyler.xsl">captionstyler.xsl</a> looks at each
  caption and rewrites it to be XHTML.  This is a separate filter for
  two reasons: it allows the look and feel of the captions to be altered
  without having to mess with the other filters and, because it is the
  only filter that cares about the contents of the meta file, the site
  admin can alter the schema of the meta files and then alter this
  filter to match.</li>

  <li><a href="/pub/a/2002/09/24/axkit.html?page=4#pagestyler.xsl">pagestyler.xsl</a> converts everything
  outside of the caption elements in to HTML.  It is separate so that
  the page look and feel can be altered per-site or per-directory
  without affecting the caption content, etc.</li> </ul>

<p>There are several key things to note about this design.  The first is
that the separation of the process into multiple filters offers the
administrator the ability to modify the site's content and styling.
Second, because AxKit is built on Apache's configuration engine, which
filters are used for a particular directory request can be selected
based on URL, directory path, query string parameters, browser types,
etc.  The third point to note is the use of SAX processors to handle
tasks that are easier (far easier in some cases) to implement in Perl,
while XSLT is used when it is more (programmer and/or processor)
efficient.</p>














<a name="httpd.conf"></a><a name="TheConfiguration"></a><h3>The Configuration</h3>

<p>Here's how we configure AxKit to do all of this:</p>

<pre><code>    ##
    ## Init the httpd to use our "private install" libraries
    ##
    PerlRequire startup.pl

    ##
    ## AxKit Configuration
    ##
    PerlModule AxKit

    &lt;Directory "/home/me/htdocs"&gt;
        Options -All +Indexes +FollowSymLinks

        # Tell mod_dir to translate / to /index.xml or /index.xsp
        DirectoryIndex index.xml index.xsp
        AddHandler axkit .xml .xsp

        AxDebugLevel 10

        AxTraceIntermediate /home/me/axtrace

        AxGzipOutput Off

        AxAddXSPTaglib AxKit::XSP::Util
        AxAddXSPTaglib AxKit::XSP::Param

        AxAddStyleMap text/xsl \
                      Apache::AxKit::Language::LibXSLT

        <b>AxAddStyleMap application/x-saxmachines \
                      Apache::AxKit::Language::SAXMachines</b>

    &lt;/Directory&gt;

    <b>
    &lt;Directory "/home/me/htdocs/04"&gt;
        </b><font color="#000000"># Enable XML directory listings (see <a href="/pub/a/2002/09/24/axkit.html?page=2#filelist">Generating File Lists</a>)</font><b>
        AxHandleDirs On

        </b><font color="#000000">#######################</font><b>
        </b><font color="#000000"># Begin pipeline config</font><b>
        AxAddRootProcessor application/x-saxmachines . \
            {http://axkit.org/2002/filelist}filelist
        PerlSetVar AxSAXMachineClass "<a href="/pub/a/2002/09/24/axkit.html?page=2#My::ProofSheetMachine">My::ProofSheetMachine</a>"

        </b><font color="#000000"># The absolute stylesheet URLs are because</font><b>
        </b><font color="#000000"># I prefer to keep stylesheets out of the</font><b>
        </b><font color="#000000"># htdocs for security reasons.</font><b>
        AxAddRootProcessor text/xsl <a href="/pub/a/2002/09/24/axkit.html?page=3#rowsplitter.xsl">file:///home/me/04/rowsplitter.xsl</a> \
            {http://axkit.org/2002/filelist}filelist

        AxAddRootProcessor text/xsl <a href="/pub/a/2002/09/24/axkit.html?page=3#metamerger.xsl">file:///home/me/04/metamerger.xsl</a> \
            {http://axkit.org/2002/filelist}filelist

        AxAddRootProcessor text/xsl <a href="/pub/a/2002/09/24/axkit.html?page=4#captionstyler.xsl">file:///home/me/04/captionstyler.xsl</a> \
            {http://axkit.org/2002/filelist}filelist

        AxAddRootProcessor text/xsl <a href="/pub/a/2002/09/24/axkit.html?page=4#pagestyler.xsl">file:///home/me/04/pagestyler.xsl</A> \
            {http://axkit.org/2002/filelist}filelist
        </b><font color="#000000"># End pipeline config</font><b>
        </b><font color="#000000">#####################</font><b>

        </b><font color="#000000"># This is read by <a href="/pub/a/2002/09/24/axkit.html?page=2#My::ProofSheetMachine">My::ProofSheetMachine</a></font><b>
        PerlSetVar MyColumns 5

        </b><font color="#000000"># This is read by <a href="/pub/a/2002/09/24/axkit.html?page=3#My::ProofSheet">My::ProofSheet</a></font><b>
        PerlSetVar MyMaxX 100

        </b><font color="#000000"># Send thumbnail image requests to our</font><b>
        </b><font color="#000000"># thumbnail generator</font><b>
        &lt;FilesMatch "^\."&gt;
            SetHandler  perl-script
            PerlHandler My::Thumbnailer
            PerlSetVar  MyMaxX 100
            PerlSetVar  MyMaxY 100
        &lt;/FilesMatch&gt;
        
    &lt;/Directory&gt;</b></code></pre>

<p>The first <code>&lt;Directory&gt;</code> section contains the AxKit
directives we introduced in <a href="/pub/a/2002/07/02/axkit.html?page=2#MixingAndMatching">article
1</a> and a new stylesheet mapping for
<code>application/x-saxmachines</code> that allows us to use a SAX machine in
the pipeline.  Otherwise, all of the configuration directives key to
this example are in the <code>&lt;Directory
"/home/me/htdocs/04"&gt;</code> section.</p>

<blockquote><p>We saw basic examples of how AxKit works with the Apache
configuration engine in <a href="/pub/a/2002/07/02/axkit.html?page=2#MixingAndMatching">article
1</a> and <a href="/pub/a/2002/04/16/axkit.html#httpd.conf">article
2</a> in this series.  We'll use this photo gallery application to
demonstrate many of the more powerful mechanisms in a future article.</p>
</blockquote>

<p>By setting <code>AxHandleDirs On</code>, we tell AxKit to generate
the &lt;filelist&gt; document (<a href="/pub/a/2002/09/24/axkit.html?page=2#GeneratingFileLists">described in the section
Generating File Lists</a>) in the 04
directory and below.</p>

<p>Then it's off to configure the pipeline for the 04 directory
hierarchy.  To do this, we take advantage of the fact that AxKit places
all elements in the filelist document in to the namespace
<code>http://axkit.org/2002/filelist</code>.  The
<code>AxAddRootProcessor</code>'s third parameter causes AxKit to look
at all documents it serves from the 04 directory tree and check to see
whether the root element matches the namespace and element name.</p>

<blockquote>
<p>This is specified in the notation used
by James Clark in his <a href="http://www.jclark.com/xml/xmlns.htm">introduction to XML
namespaces</a>.</p>
</blockquote>

<p>If the document matches, and all AxKit-generated filelists will, then
the MIME type and the stylesheet specified in the first two parameters
are added to the pipeline.  The four <code>AxAddRootProcessor</code>
directives add the SAX machine and the four XSLT filters we described in
<a href="/pub/a/2002/09/24/axkit.html#ThePipeline">the section "The Pipeline"</a>.</p>

<p>When loading a SAX machine into the pipeline, you can give it a
simple list of SAX filters (<a href="http://search.cpan.org/search?mode=module&amp;query=XML%3A%3AFilter">there are many available on
CPAN</a>) and it will build a pipeline of them.  This is done with a
(not shown) <code>PerlSetVar AxSAXMachineFilters "..."</code> directive.
The limitation with this directive is that you cannot pass in any
initialization values to the filters and we want to.</p>

<p>So, instead, we use the <code>PerlSetVar AxSAXMachineClass
"My::ProofSheetMachine"</code> to tell the
Apache::AxKit::Language::SAXMachines module to load the class
<a href="/pub/a/2002/09/24/axkit.html?page=2#My::ProofSheetMachine">My::ProofSheetMachine</a>
and let that class construct the SAX machine.</p>

<p>The final part of the configuration uses a <code>&lt;Files&gt;</code>
section to forward all requests for thumbnail images to the mod_perl
handler in <a href="/pub/a/2002/09/24/axkit.html?page=4#My::Thumbnailer">My::Thumbnailer</a>.</p>

<a name="WalkingThePipeline" /><h3>Walking the Pipeline</h3>

<p>Now that we have our filters in place, let's walk the pipeline and
take a look at each filter and what it emits.</p>

<a name="filelist"/>
<a name="GeneratingFileLists" /><h4>Generating File Lists</h4>

<p><a name="pipeline_filelist.png"  href="/pub/a/2002/09/24/axkit.html#pipeline.png"><img src="/pub/2002/09/24/graphics/pipeline_filelist.png" alt="&lt;filelist&gt; document's position in the processing pipeline" width="110" height="84" border="0" align="right"/></a></p>

<p>First, here's a look at the <code>&lt;filelist&gt;</code> document that
feeds the chain.  This is created by AxKit when it serves a directory
request in much the same way that Apache creates HTML directory
listings.  AxKit only generates these pages when <code>AxHandleDirs
On</code> directive.  This causes AxKit to scan the directory for the
above screenshot and emit XML like (whitespace added, repetitive stuff
elided):</p>

<pre><code>    &lt;?xml version="1.0" encoding="UTF-8"?&gt;
    &lt;!DOCTYPE filelist PUBLIC
      "-//AXKIT/FileList XML V1.0//EN"
      "file:///dev/null"
    &gt;
    &lt;filelist xmlns="http://axkit.org/2002/filelist"&gt;
      &lt;directory
        atime="1032276941"
        mtime="1032276939"
        ctime="1032276939"
        readable="1"
        writable="1"
        executable="1"
        size="4096" &gt;.&lt;/directory&gt;
      &lt;directory ...&gt;<b>..</b>&lt;/directory&gt;
      &lt;directory ...&gt;<b>Mary</b>&lt;/directory&gt;
      &lt;directory ...&gt;<b>Jim</b>&lt;/directory&gt;
      &lt;file <b>mtime="1031160766"</b> ...&gt;a-look.jpeg&lt;/file&gt;
      &lt;file <b>mtime="1031160787"</b> ...&gt;<b>a-lotery</b>.jpeg&lt;/file&gt;
      &lt;file <b>mtime="1031160771"</b> ...&gt;<b>a-lucky</b>.jpeg&lt;/file&gt;
      &lt;file <b>mtime="1032197214"</b> ...&gt;a-look.meta&lt;/file&gt;
      &lt;file <b>mtime="1035239142"</b> ...&gt;foo.html&lt;/file&gt;
      ...
    &lt;/filelist&gt;</code></pre>

<p>The emboldened bits are the pieces of data we want to display: some
filenames and their modification times.  Some things to notice:
</p>
<ul>

<li>All of the elements -- most importantly the root element as we'll see
in a bit -- are in a special namespace,
<code>http://axkit.org/2002/filelist</code>, using the
<code>xmlns=</code> attribute (see <a href="http://www.jclark.com/xml/xmlns.htm">James Clark's
introduction</a> for details).</li>

<li>The entries are in unsorted order.  We might want to allow the
user to sort by different attributes someday, but this means that we at
least need to sort the results somehow.</li>

<li>They contain the complete output from the <code>stat()</code> system
call as attributes, so we can use the <code>mtime</code> attribute to
derive a modification time.</li>

<li>There are
files in there (<code>a-look.meta</code> and <code>foo.html</code>) that
we clearly should not be displayed as images.</li>

<li>The filename for <code>a-look.jpeg</code> is not emboldened: We'll
use the <code>&lt;title&gt;</code> element from the
<code>a-look.meta</code> file instead.</li>

</ul>

<pre><code>    &lt;?xml version="1.0" encoding="UTF-8"?&gt;
    &lt;!DOCTYPE filelist PUBLIC
      "-//AXKIT/FileList XML V1.0//EN"
      "file:///dev/null"
    &gt;
    &lt;filelist xmlns="http://axkit.org/2002/filelist"&gt;
      &lt;directory
        atime="1032276941"
        mtime="1032276939"
        ctime="1032276939"
        readable="1"
        writable="1"
        executable="1"
        size="4096" &gt;.&lt;/directory&gt;
      &lt;directory ...&gt;<b>..</b>&lt;/directory&gt;
      &lt;directory ...&gt;<b>Mary</b>&lt;/directory&gt;
      &lt;directory ...&gt;<b>Jim</b>&lt;/directory&gt;
      &lt;file <b>mtime="1031160766"</b> ...&gt;a-look.jpeg&lt;/file&gt;
      &lt;file <b>mtime="1031160787"</b> ...&gt;<b>a-lotery</b>.jpeg&lt;/file&gt;
      &lt;file <b>mtime="1031160771"</b> ...&gt;<b>a-lucky</b>.jpeg&lt;/file&gt;
      &lt;file <b>mtime="1032197214"</b> ...&gt;a-look.meta&lt;/file&gt;
      &lt;file <b>mtime="1035239142"</b> ...&gt;foo.html&lt;/file&gt;
      ...
    &lt;/filelist&gt;</code></pre>

<a name="My::ProofSheetMachine" /></a><h4>My::ProofSheetMachine</h4>

<p><a name="pipeline_proofsheetmachine_pm.png" href="/pub/a/2002/09/24/axkit.html#pipeline.png"></a>
<img src="/pub/2002/09/24/graphics/pipeline_proofsheetmachine_pm.png" alt="My::ProofSheetMachine's position in the processing pipeline." width="110" height="84" border="0" align="right"/></p>

<p>The processing pipeline is kicked off with a set of three SAX filters built by the My::ProofSheetMachine module:</p>


<pre><code>    package My::ProofSheetMachine;
    
    use strict;
    
    use XML::SAX::Machines qw( Pipeline );
    use My::ProofSheet;
    use XML::Filter::TableWrapper;
    
    sub new {
        my $proto = shift;
        return bless {}, ref $proto || $proto;
    }
    
    sub get_machine {
        my $self = shift;
        my ( $r ) = @_;
    
        my $m = Pipeline(
            <a href="/pub/a/2002/09/24/axkit.html?page=2#My::Filelist2Data">My::Filelist2Data</a>
            => <a href="/pub/a/2002/09/24/axkit.html?page=3#My::ProofSheet">My::ProofSheet</a>->new( Request => $r ),
            => <a href="/pub/a/2002/09/24/axkit.html?page=3#XML::Filter::TableWrapper">XML::Filter::TableWrapper</a>->new(
                ListTags => "{}images",
                Columns  => $r->dir_config( "MyColumns" ) || 3,
            ),
        );
    
        return $m;
    }
    
    1;</code></pre>

<p>This module provides a minimal constructor, <code>new()</code> so it
can be instantiated (this is an Apache::AxKit::Language::SAXMachines
requirement, we don't need that for our sake).  AxKit will call the
<code>get_machine()</code> method once each request to obtain the SAX
machine is used.  SAX machines are not reused from request to request.</p>

<p><code>$r</code> is a reference to the <a href="http://search.cpan.org/author/JIMW/libapreq/Request/Request.pm">Apache
request</a> object (well, actually, to an AxKit subclass of it).  This
is passed into 
<a href="/pub/a/2002/09/24/axkit.html?page=3#My::ProofSheet">My::ProofSheet</a>, which uses to interact
query some <a href="/pub/a/2002/09/24/axkit.html?page=2#httpd.conf">httpd.conf</a> settings, to control
AxKit's cache, and to probe the filesystem through Apache.</p>

<p><code>$r</code> is also queried in this module to see whether there is a
<code>MyColumns</code> setting for this request, with a default
in case, it's not.  The <code>ListTags</code> setting tells <a href="/pub/a/2002/09/24/axkit.html?page=3#XML::Filter::TableWrapper">XML::Filter::TableWrapper</a> to
segment the image list produced by the first two filters into rows of
images (preparing it to be an HTML table, in other words).</p>

<p>The need to pass parameters like this to the SAX filters is the sole
reason we're using a SAX machine factory class like this.  This class is
specified by using <code>PerlSetVar AxSAXMachineClass</code>; if we
didn't need to initialize the filters like this, then we could have listed
them in a <code>PerlSetVar AxSAXMachineFilters</code> directive.  For
more details on how SAX machines are integrated with AxKit, see <a href="http://search.cpan.org/author/MSERGEANT/AxKit/lib/Apache/AxKit/Language/SAXMachines.pm">the
man page</a></p>

<p>Currently, only one SAX machine is allowed in an AxKit pipeline at a
time (though different pipelines can have different machines in them).
This is a limitation of the configuration system more than anything and
may well change if need be.  However, if we need to add SAX processors
to the end of the machine, then the <code>PerlSetVar
AxSAXMachineFilters</code> can be used to insert site-specific filters
after the main machine (and before the XSLT processors).</p>

<a name="My::Filelist2Data"></a><h4>My::Filelist2Data</h4>


<a href="/pub/a/2002/09/24/axkit.html#pipeline.png" name="pipeline_filelist.png2"><p><img src="/pub/2002/09/24/graphics/pipeline_filelist2data_pm.png" alt="My::Filelist2Data's position in the processing pipeline." width="110" height="84" border="0" align="right"/></a></p>

<p>Converting the <code>&lt;filelist&gt;</code> into a proofsheet takes a
bit of detailed data munging.  This is quite easy in Perl, so the first
step in our pipeline is to convert the XML file listing into data.  <a href="http://search.cpan.org/author/GRANTM/XML-Simple/Simple.pm">XML::Simple</a>
provides this functionality for us, and we overload it so we can grab
the resulting data structure and pass it on:</p>

<pre><code>    package My::Filelist2Data;
    
    use XML::Simple;
    @ISA = qw( XML::Simple );
    
    use strict;
    
    sub new {
        my $proto = shift;
        my %opts = @_;
    
        <font color="#000000"># The Handler value is passed in by the Pipeline()</font>
        <font color="#000000"># call in My::ProofSheetMachine.</font>
        my $h = delete $opts{Handler};
    
        <font color="#000000"># Even if there's only one file element present,</font>
        <font color="#000000"># make XML::Simple put it in an ARRAY so that</font>
        <font color="#000000"># the downstream filter can depend on finding an</font>
        <font color="#000000"># array of elements and not a single element.</font>
        <font color="#000000"># This is an XML::Simple option that is almost</font>
        <font color="#000000"># always set in practice.</font>
        $opts{forcearray} = [qw( file )];
    
        <font color="#000000"># Each &lt;file> and &lt;directory> element contains</font>
        <font color="#000000"># the file name as simple text content.  This</font>
        <font color="#000000"># option tells XML::Simple to store it in the</font>
        <font color="#000000"># data member "filename".</font>
        $opts{contentkey} = "filename";
    
        <font color="#000000"># This subroutine gets called when XML::Simple</font>
        <font color="#000000"># has converted the entire document with the</font>
        <font color="#000000"># $data from the document.</font>
        $opts{DataHandler} = sub {
            shift;
            my ( $data ) = @_;
    
            <font color="#000000"># If no files are found, place an array</font>
            <font color="#000000"># reference in the right spot.  This is to</font>
            <font color="#000000"># to simplify downstream filter code.</font>
            $data->{file}      ||= [];
    
            <font color="#000000"># Pass the data structure to the next filter.</font>
            $h->generate( $data );
        } if $h;
    
        <font color="#000000"># Call XML::Simple's constructor.</font>
        return $proto->SUPER::new( %opts );;
    }
    
    1;</code></pre>

<p>Sending a data structure like this between SAX machines using a
non-SAX event is known as "cheating."  But this is Perl, and
allowing you to cheat responsibly and judiciously is one of Perl's great
strengths.  This works and should work for the foreseeable future.  If
you're planning on doing something like this for a general purpose
filter, then it behooves you to also provide <code>set_handler</code> and
<code>get_handler</code> methods so your filter can be repositioned
after instantiation (something XML::SAX::Machines do if need be), but we
don't need to clutter this single-purpose example.</p>

<p>The <code>&lt;filelist&gt;</code> document gets converted to a Perl
data structure where each element is a data member in a HASH or an
array,  like (data elided and rearranged to relate well to the
source XML):</p>

<pre><code>    {
      xmlns => 'http://axkit.org/2002/filelist',
      directory => [
        {
          atime      => '1032276941'
          mtime      => '1032276939',
          ctime      => '1032276939',
          readable   => '1',
          writable   => '1',
          executable => '1',
          size       => '4096',
          content    => '.',
        },
        {
          ...
          content    => '<b>..</b>',
        },
        {
          ...
          content    => '<b>Mary</b>',
        },
        {
          ...
          content    => '<b>Jim</b>',
        }
      ]
      file => [
        {
          <b>mtime      => '1031160766</b>',
          ...
          content    => '<b>a-look.jpeg</b>',
        },
        {
          <b>mtime      => '1031160787</b>',
          ...
          content    => '<b>a-lotery.jpeg</b>',
        },
        {
          <b>mtime      => '1031160771</b>',
          ...
          content    => '<b>a-lucky.jpeg</b>',
        },
        {
          <b>mtime      => '035239142</b>',
          ...
          content    => '<b>foo.html</b>',
        },
        ...
      ],
    }</code></pre>















<a name="My::ProofSheet"></a><h4>My::ProofSheet</h4>

<p><a href="/pub/a/2002/09/24/axkit.html#pipeline.png" name="pipeline_proofsheet_pm.png"><img src="/pub/2002/09/24/graphics/pipeline_proofsheet_pm.png" alt="My::ProofSheet's position in the processing pipeline." width="110" height="84" border="0" align="right"/></a></p>

<p>Once the data is in Perl data structure, it's easy to tweak it (making
<code>mtime</code> fields into something readable, for instance)
and extend it (adding information about thumbnail images and .meta
files, for instance).  This is what My::ProofSheet does:</p>


<pre><code>    package My::ProofSheet;
    
    use XML::SAX::Base;
    @ISA = qw( XML::SAX::Base );
    
    <font color="#000000"># We need to access the Apache request object to</font>
    <font color="#000000"># get the URI of the directory we're presenting,</font>
    <font color="#000000"># its physical location on disk, and to probe</font>
    <font color="#000000"># the files in it to see if they are images.</font>
    use Apache;
    
    <font color="#000000"># My::Thumbnailer is an Apache/mod_perl module that</font>
    <font color="#000000"># creates thumbnail images on the fly.  See below.</font>
    use My::Thumbnailer qw( image_size thumb_limits );
    
    <font color="#000000"># XML::Generator::PerlData lets us take a Perl data</font>
    <font color="#000000"># structure and emit it to the next filter serialized</font>
    <font color="#000000"># as XML.</font>
    use XML::Generator::PerlData;
    
    use strict;
    
    sub generate {
        my $self = shift;
        my ( $data ) = @_;
    
        <font color="#000000"># Get the AxKit request object so we can</font>
        <font color="#000000"># ask it for the URI and use it to test</font>
        <font color="#000000"># whether files are images or not.</font>
        my $r = $self->{Request};
    
        my $dirname = $r->uri;      <font color="#000000"># "/04/Baby_Pictures/Other/"</font>
        my $dirpath = $r->filename; <font color="#000000"># "/home/me/htdocs/...Other/"</font>
    
    
        my @images = map $self->file2image( $_, $dirpath ),
            sort {
                $a->{filename} cmp $b->{filename}
            } @{$data->{file}};
    
        <font color="#000000"># Use a handy SAX module to generate XML from our Perl</font>
        <font color="#000000"># data structures.  The XML will look basically like:</font>
        <font color="#000000"># Write XML that looks like</font>
        <font color="#000000">#</font>
        <font color="#000000"># &lt;proofsheet></font>
        <font color="#000000">#   &lt;images></font>
        <font color="#000000">#     &lt;image>...&lt;/image></font>
        <font color="#000000">#     &lt;image>...&lt;/image></font>
        <font color="#000000">#     ...</font>
        <font color="#000000">#   &lt;/images></font>
        <font color="#000000">#   &lt;title>/04/BabyePictures/Others&lt;/title></font>
        <font color="#000000"># &lt;/proofsheet></font>
        <font color="#000000">#</font>
        XML::Generator::PerlData->new(
            rootname => "proofsheet",
            Handler => $self,
        )->parse( {
            title       => $dirname,
            images      => { image => \@images },
        } );
    }
    
    
    sub file2image {
        my $self = shift;
        my ( $file, $dirpath ) = @_;
    
        <font color="#000000"># Remove the filename from the fields so it won't</font>
        <font color="#000000"># show up in the &lt;image> structure.</font>
        my $fn = $file->{filename};
    
        <font color="#000000"># Ignore hidden files (first char is a ".").</font>
        <font color="#000000"># Thumbnail images are cached as hidden files.</font>
        return () if 0 == index $fn, ".";
    
        <font color="#000000"># Ignore files Apache knows aren't images</font>
        my $type = $self->{Request}->lookup_file( $fn )->content_type;
        return () unless
            defined $type
            &amp;&amp; substr( $type, 0, 6 ) eq "image/";
    
        <font color="#000000"># Strip the extension(s) off.</font>
        ( my $name = $fn ) =~ s/\..*//;
    
        <font color="#000000"># A meta filename is the image filename with a ".meta"</font>
        <font color="#000000"># extension instead of whatever extension it has.</font>
        my $meta_fn   = "$name.meta";
        my $meta_path = "$dirpath/$meta_fn";
    
        <font color="#000000"># The thumbnail file is stored as a hidden file</font>
        <font color="#000000"># named after the image file, but with a leading</font>
        <font color="#000000"># '.' to hide it.</font>
        my $thumb_fn   = ".$fn";
        my $thumb_path = "$dirpath/$thumb_fn";
    
        my $last_modified = localtime $file->{mtime};
    
        my $image = {
            %$file,                  <font color="#000000"># Copy all fields</font>
            type           => $type, <font color="#000000"># and add a few</font>
            name           => $name,
            thumb_uri      => $thumb_fn,
            path           => "$dirpath/$fn",
            last_modified  => $last_modified,
        };
    
        if ( -e $meta_path ) {
            <font color="#000000"># Only add a URI to the meta info, metamerger.xsl will</font>
            <font color="#000000"># slurp it up if and only if &lt;meta_uri> is present.</font>
            $image->{meta_filename} = $meta_fn;
            $image->{meta_uri}      = "file://$meta_path";
        }
    
        <font color="#000000"># If the thumbnail exists, grab its width and height</font>
        <font color="#000000"># so later stages can populate the &lt;img> tag with them.</font>
        <font color="#000000"># The eval {} is in case the image doesn't exist or</font>
        <font color="#000000"># the library can't cope with the image format.</font>
        <font color="#000000"># Disable caching AxKit's output if a failure occurs.</font>
        eval {
            ( $image->{thumb_width}, $image->{thumb_height} )
                = image_size $thumb_path;
        } or $self->{Request}->no_cache( 1 );
    
        return $image;
    }
    
    
    1;</code></pre>

<p>When My::Filelist2Data calls <code>generate()</code>,
<code>generate()</code> sorts and scans the list of files by filename,
converts each to an image and sends a page title and the resulting list
of images to the next filter (<a href="/pub/a/2002/09/24/axkit.html?page=3#XML::Filter::TableWrapper">XML::Filter::TableWrapper</a>).  Kip Hampton's
<a href="http://search.cpan.org./author/KHAMPTON/XML-Generator-PerlData/PerlData.pm">XML::Generator::PerlData</a>
is a Perl data -&gt; XML serialization module.  It's not meant for
generating generic XML; it focuses purely on building an XML
representation of a Perl data structure.  In this case, that's ideal,
because we will be generating the output document with XSLT templates
and we don't care about the exact order of the elements in each
<code>&lt;image&gt;</code> element, each <code>&lt;image&gt;</code>
element is just a hash of key/value pairs.  We do control the order of
the <code>&lt;image&gt;</code> elements, however, by passing an ordered
list of them in to XML::Generator::PerlData as an array.</p>

<p>Sorting by filename may not be the preferred thing to do for all
applications, because users may prefer to sort by the caption title
for the image, but then again they may not, and this allows the site
administrator to control sort order by naming the files appropriately.
We can add always add sorting later.</p>

<p>Another peculiarity of this code is that it doesn't guarantee that
there will be <code>thumb_width</code> and <code>thumb_height</code>
values available.  If you just drop the source images in a directory,
then the first time the server generates this page, there will be no
thumbnails available.  In this case, the call to
<code>no_cache(1)</code> prevents AxKit from caching the output page so
that suboptimal HTML does not get stuck in the cache.  This will give
the server another chance at generating it with proper tags, hoping of
course that by the next time this page is requested, the requisite
thumbnails will be available to measure.</p>

<p>This approach gets the HTML to the browser fast, so the user's
browser window will clear quickly and start filling with the top of ths
page, so the user will see some activity and be less likely to get
impatient.  The thumbnails will be generated when the browser sees all
the <code>&lt;img&gt;</code> tags.  The alternative approach would be to
thumbnail the images inline, which would result in a significant delay
on large listings before the first HTML hits the browser, or
prethumbnailing.</p>

<p>One thing to note about this approach is that many browsers will
request images several at a time, which will cause several server
processes to be thumbnailing several different images at once.  This
should result in lower lag on low-load servers because processes can
interleave CPU time and disk I/O waits, and can take advantage of
multiple processors, if present.  On heavily loaded servers, of course,
this might be a bad thing; pregenerating thumbnails there would be a
good idea.</p>

<p>The output from this filter looks like:</p>

<pre><code>    &lt;?xml version="1.0"?&gt;
    &lt;proofsheet&gt;
      &lt;images&gt;
        &lt;image&gt;
          &lt;path&gt;
		    /home/barries/src/mball/AxKit/www/htdocs/04/Baby_Pictures/Others/a-look.jpeg
		  &lt;/path&gt;
          &lt;writable&gt;1&lt;/writable&gt;
          &lt;filename&gt;<b>a-look.jpeg</b>&lt;/filename&gt;
          &lt;thumb_uri&gt;<b>.a-look.jpeg</b>&lt;/thumb_uri&gt;
          &lt;meta_filename&gt;a-look.meta&lt;/meta_filename&gt;
          &lt;name&gt;a-look&lt;/name&gt;
          &lt;last_modified&gt;<b>Wed Sep  4 13:32:46 2002</b>&lt;/last_modified&gt;
          &lt;ctime&gt;1032552249&lt;/ctime&gt;
          <b>&lt;meta_uri&gt;
            <a href="/pub/a/2002/09/24/axkit.html#TheMetaFile">file:///home/barries/src/mball/AxKit/www/htdocs/04/Baby_Pictures/Others/a-look.meta</a>
          &lt;/meta_uri&gt;</b>
          &lt;mtime&gt;1031160766&lt;/mtime&gt;
          &lt;size&gt;8522&lt;/size&gt;
          &lt;readable&gt;1&lt;/readable&gt;
          &lt;type&gt;image/jpeg&lt;/type&gt;
          &lt;atime&gt;1032553327&lt;/atime&gt;
        &lt;/image&gt;
        &lt;image&gt;
          &lt;path&gt;
            /home/barries/src/mball/AxKit/www/htdocs/04/Baby_Pictures/Others/a-lotery.jpeg
          &lt;/path&gt;
          &lt;writable&gt;1&lt;/writable&gt;
          &lt;filename&gt;<b>a-lotery.jpeg</b>&lt;/filename&gt;
          &lt;thumb_uri&gt;.a-lotery.jpeg&lt;/thumb_uri&gt;
          &lt;name&gt;<b>a-lotery</b>&lt;/name&gt;
          &lt;last_modified&gt;<b>Wed Sep  4 13:33:07 2002</b>&lt;/last_modified&gt;
          &lt;ctime&gt;1032552249&lt;/ctime&gt;
          &lt;mtime&gt;1031160787&lt;/mtime&gt;
          &lt;size&gt;10113&lt;/size&gt;
          &lt;readable&gt;1&lt;/readable&gt;
          &lt;type&gt;image/jpeg&lt;/type&gt;
          &lt;atime&gt;1032553327&lt;/atime&gt;
        &lt;/image&gt;
      &lt;/images&gt;
      ...
      &lt;title&gt;/04/Baby_Pictures/Others&lt;/title&gt;
    &lt;/proofsheet&gt;</code></pre>

<p>All the data from the original <code>&lt;file&gt;</code> elements are
in each <code>&lt;image&gt;</code> element along with the new fields.
Note that the first <code>&lt;image&gt;</code> contains the
<code>&lt;meta_uri&gt;</code> (pointing to <a href="/pub/a/2002/09/24/axkit.html#TheMetaFile">a-look.meta</a>)
while the second doesn't because there is no <code>a-lotery.meta</code>.  As
expected both have the <code>&lt;thumb_uri&gt;</code> tags.  The parts
in <b>bold</b> face are the bits that our presentation happens to want;
yours might want more or different bits.</p>

<p>While there is a lot of extra information in this structure, it's
really just the output from one system call (<code>stat()</code>) and
some possibly useful byproducts of the My::ProofSheet machinations, so
it's very cheap information that some front end somewhere might want.
It's also easier to leave it all in than to emit just what our example
frontend might want and will enable any future upstream filters or
extentions to AxKit's directory scanning to shine through.</p>

<p>No <code>&lt;thumb_width&gt;</code> or
<code>&lt;thumb_height&gt;</code> tags are present because I copied this
file from the axtrace directory (see the
<code>AxTraceIntermediate</code> directive in <a href="/pub/a/2002/09/24/axkit.html?page=2#httpd.conf">our
httpd.conf file</a>) after viewing a newly added directory.  Here's what
the first <code>&lt;image&gt;</code> element looks like when viewing
after my browser had requested all thumbnails:</p>

<pre><code>    &lt;?xml version="1.0"?&gt;
    &lt;proofsheet&gt;
      &lt;images&gt;
        &lt;image&gt;
          <b>&lt;thumb_width&gt;72&lt;/thumb_width&gt;</b>
          &lt;path&gt;
            /home/barries/src/mball/AxKit/www/htdocs/04/Baby_Pictures/Others/a-look.jpeg
          &lt;/path&gt;
          &lt;writable&gt;1&lt;/writable&gt;
          &lt;filename&gt;a-look.jpeg&lt;/filename&gt;
          <b>&lt;thumb_height&gt;100&lt;/thumb_height&gt;</b>
          &lt;thumb_uri&gt;.a-look.jpeg&lt;/thumb_uri&gt;
          &lt;meta_filename&gt;a-look.meta&lt;/meta_filename&gt;
          &lt;name&gt;a-look&lt;/name&gt;
          &lt;last_modified&gt;Wed Sep  4 13:32:46 2002&lt;/last_modified&gt;
          &lt;ctime&gt;1032552249&lt;/ctime&gt;
          &lt;meta_uri&gt;
            file:///home/barries/src/mball/AxKit/www/htdocs/04/Baby_Pictures/Others/a-look.meta
          &lt;/meta_uri&gt;
          &lt;mtime&gt;1031160766&lt;/mtime&gt;
          &lt;size&gt;8522&lt;/size&gt;
          &lt;readable&gt;1&lt;/readable&gt;
          &lt;type&gt;image/jpeg&lt;/type&gt;
          &lt;atime&gt;1032784360&lt;/atime&gt;
        &lt;/image&gt;
        ...
      &lt;/images&gt;
      &lt;title&gt;/04/Baby_Pictures/Others&lt;/title&gt;
    &lt;/proofsheet&gt;</code></pre>

<a name="XML::Filter::TableWrapper" /><h4>XML::Filter::TableWrapper</h4>

<p><a href="/pub/a/2002/09/24/axkit.html#pipeline.png" name="pipeline_tablewrapper_pm.png"><img src="/pub/2002/09/24/graphics/pipeline_tablewrapper_pm.png" alt="My::TableWrapper's position in the processing pipeline" width="110" height="84" border="0" align="right"/></a></p>

<p><a href="http://search.cpan.org/author/RBS/XML-Filter-TableWrapper/lib/XML/Filter/TableWrapper.pm">XML::Filter::TableWrapper</a>
is a CPAN module is used to take the <code>&lt;images&gt;</code> list
and segmenting it by insert <code>&lt;tr&gt;...&lt;/tr&gt;</code> tags
around every (it's configurable) <code>&lt;image&gt;</code>
elements.  This configuration is done by the <a href="/pub/a/2002/09/24/axkit.html?page=2#My::ProofSheetMachine">My::ProofSheetMachine</a> module we showed
earlier:</p>

<pre><code>    XML::Filter::TableWrapper->new(
        ListTags => "{}images",
        Columns  => $r->dir_config( "MyColumns" ) || 3,
    ),</code></pre>

<p>The output, for our list of 9 images, looks like:</p>

<pre><code>    &lt;?xml version="1.0"?&gt;
    &lt;proofsheet&gt;
      &lt;images&gt;
        &lt;tr&gt;
          &lt;image&gt;
            ...
          &lt;/image&gt;
          ... 4 more image elements...
        &lt;/tr&gt;
        &lt;tr&gt;
          &lt;image&gt;
            ...
          &lt;/image&gt;
          ... 3 more image elements...
        &lt;/tr&gt;
      &lt;/images&gt;
      &lt;title&gt;/04/Baby_Pictures/Others&lt;/title&gt;
    &lt;/proofsheet&gt;</code></pre>

<p>Now all the presentation stylesheet (<a href="/pub/a/2002/09/24/axkit.html?page=4#pagestyler.xsl">pagestuler.xsl</a>) can key off the
<code>&lt;tr&gt;</code> tags to build an HTML <code>&lt;table&gt;</code>
or ignore them (and not pass them through) if it wants to display in a
list format.</p>

<p>While I'm sure this is possible in XSLT, I have no idea how to do it easily.</p>

<a name="rowsplitter.xsl" /><h4>rowsplitter.xsl</h4>

<p><a href="/pub/a/2002/09/24/axkit.html#pipeline.png" name="pipeline_rowsplitter_xsl.png"><img src="/pub/2002/09/24/graphics/pipeline_rowsplitter_xsl.png" alt="rowsplitter.xsl's position in the processing pipeline." width="110" height="84" border="0" align="right"/></a></p>

<p>Experimentation with an early version of this application showed that
presenting captions in the same table cell as the thumbnails when the
thumbnails are of differing heights caused the captions to be showed at
varying heights.  This made it hard to scan the captions and added a lot
of visual clutter to the page.</p>

<p>One solution is to add an XSLT filter that splits each table row of
image data in to two rows, one for the thumbnail and another for the
caption:</p>

<pre><code>    &lt;xsl:stylesheet 
      version="1.0"
      xmlns:xsl="http://www.w3.org/1999/XSL/Transform"
    &gt;
    
    &lt;xsl:template match="image" mode="caption"&gt;
      &lt;caption&gt;
        &lt;xsl:copy-of select="@*|*|node()" /&gt;
      &lt;/caption&gt;
    &lt;/xsl:template&gt;
    
    &lt;xsl:template match="images/tr"&gt;
      &lt;xsl:copy-of select="." /&gt;
      &lt;tr>&lt;xsl:apply-templates select="image" mode="caption" /&gt;&lt;/tr&gt;
    &lt;/xsl:template&gt;
    
    &lt;xsl:template match="@*|node()"&gt;
      &lt;xsl:copy&gt;
        &lt;xsl:apply-templates select="@*|node()"/&gt;
      &lt;/xsl:copy&gt;
    &lt;/xsl:template&gt;
    
    &lt;/xsl:stylesheet&gt;</code></pre>

<p>The second template in this stylesheet matches each row
(<code>&lt;tr&gt;</code> element) in the <code>&lt;images&gt;</code>
element and copies it verbatim and then emits a second
<code>&lt;tr&gt;</code> element right after it with a list of
<code>&lt;caption&gt;</code> elements with copies of the content of each
of the <code>&lt;image&gt;</code> tags in the original row.  The first
template is applied only to the <code>&lt;image&gt;</code> tags when
creating this second row due to the <code>mode="caption"</code>
attributes.</p>

<p>The third template is a standard piece of XSLT boilerplate that
passes through all the XML that is not matched by the first two
templates.  This XML would otherwise be mangled (stripped of elements,
to be specific) by the wacky default XSLT rules.</p>

<p>Now, I know several ways to do this in Perl in the AxKit environment
and none are so easy for me as using XSLT.  <a href="http://info.astrian.net/jargon/terms/y.html#YMMV">YMMV</a>.</p>

<p>The output from that stage looks like:</p>


<pre><code>    &lt;?xml version="1.0"?&gt;
    &lt;proofsheet&gt;
      &lt;images&gt;

        &lt;tr&gt;&lt;image&gt;...  &lt;/image&gt;   ...total of 5... &lt;/tr&gt;
        &lt;tr&gt;&lt;caption&gt;...&lt;/caption&gt; ...total of 5... &lt;/tr&gt;

        &lt;tr&gt;&lt;image&gt;...  &lt;/image&gt;   ...total of 4... &lt;/tr&gt;
        &lt;tr&gt;&lt;caption&gt;...&lt;/caption&gt; ...total of 4... &lt;/tr&gt;

      &lt;/images&gt;
      &lt;title&gt;/04/Baby_Pictures/Others&lt;/title&gt;
    &lt;/proofsheet&gt;</code></pre>

<p>The content of each <code>&lt;image&gt;</code> tag and each
<code>&lt;caption&gt;</code> tag is identical.  It's easier to do the
transform this way and allows the frontend stylesheets the flexibility
of doing things like putting the image filename or modification time in
the same cell as the thumbnail.<p>

<a name="metamerger.xsl" /><h4>metamerger.xsl</h4>

<p><a href="/pub/a/2002/09/24/axkit.html#pipeline.png" name="pipeline_metamerger_xsl.png"><img src="/pub/2002/09/24/graphics/pipeline_metamerger_xsl.png" alt="metamerger.xsl's position in the processing pipeline" border="0" align="right"/></a></p>

<p>As with the row splitter, expressing the metamerger in XSLT is an
expedient way of merging in external XML documents, for several reasons.
The first is for efficiency's sake: We're already using XSLT before and
after this filter, and AxKit optimizes XSLT->XSLT handoffs to avoid
reparsing.  Another is that the underlying implementation of AxKit's
XSLT engine is the speedy C of libxslt. A third is that we're not
altering the incoming file at all in this stage, so the XSLT does not
get out of hand (I do not consider XSLT to be a very readable
programming language; its XML syntax makes for very opaque source code).</p>

<p>Another approach would be to go back and tweak <a href="/pub/a/2002/09/24/axkit.html?page=3#My::ProofSheet">My::ProofSheet</a> to inherit from <a href="http://search.cpan.org/author/RBS/XML-SAX-Machines/lib/XML/Filter/Merger.pm">XML::Filter::Merger</a>
and insert it using a SAX parser.  That would be a bit slower, I
suspect, because SAX parsing in general tends to be slower than XSLT's
internal parsing.  It would rob the application of the configurability
that having merging as a separate step engenders.  By factoring this
functionality in to the metamerger.xsl stylesheet, we offer the site
designer the ability to pull data from other sources, or even to fly
without any metadata at all.</p>

<p>Here's what metamerger.xsl looks like:</p>

<pre><code>    &lt;xsl:stylesheet 
      version="1.0"
      xmlns:xsl="http://www.w3.org/1999/XSL/Transform"
    >
    
    &lt;xsl:template match="caption">
      &lt;caption>
        &lt;xsl:copy-of select="*|@*|node()" />
        &lt;xsl:copy-of select="document( meta_uri )" />
      &lt;/caption>
    &lt;/xsl:template>
    
    &lt;xsl:template match="*|@*">
      &lt;xsl:copy>
        &lt;xsl:apply-templates select="*|@*|node()" />
      &lt;/xsl:copy>
    &lt;/xsl:template>
    
    &lt;/xsl:stylesheet></code></pre>

<p>The first template does all the work of matching each
<code>&lt;caption&gt;</code> element and copying its content, then
parsing and inserting the document indicated by the
<code>&lt;meta_uri&gt;</code> element, if present.  The
<code>document()</code> function turns into a noop if
<code>&lt;meta_uri&gt;</code> is not present.  The second template is
that same piece of boilerplate we saw in <a href="/pub/a/2002/09/24/axkit.html?page=3#rowsplitter.xsl">rowsplitter.xsl</a> to copy through everything we don't explicitly match.














<p>And here's what the <code>&lt;caption&gt;</code> for
<code>a-look.jpeg</code> now looks like (all the other
<code>&lt;caption&gt;</code> elements were left untouched because there
are no other .meta files in this directory):</p>

<pre><code>    &lt;caption>
      &lt;thumb_width>72&lt;/thumb_width>
      &lt;path>/home/barries/src/mball/AxKit/www/htdocs/04/Baby_Pictures/Others/a-look.jpeg&lt;/path>
      &lt;writable>1&lt;/writable>
      &lt;filename>a-look.jpeg&lt;/filename>
      &lt;thumb_height>100&lt;/thumb_height>
      &lt;thumb_uri>.a-look.jpeg&lt;/thumb_uri>
      &lt;meta_filename>a-look.meta&lt;/meta_filename>
      &lt;name>a-look&lt;/name>
      &lt;last_modified>Wed Sep  4 13:32:46 2002&lt;/last_modified>
      &lt;ctime>1032552249&lt;/ctime>
      &lt;meta_uri>file:///home/barries/src/mball/AxKit/www/htdocs/04/Baby_Pictures/Others/a-look.meta&lt;/meta_uri>
      &lt;mtime>1031160766&lt;/mtime>
      &lt;size>8522&lt;/size>
      &lt;readable>1&lt;/readable>
      &lt;type>image/jpeg&lt;/type>
      &lt;atime>1032784360&lt;/atime>
      <b>&lt;meta>
        &lt;title>A baby picture&lt;/title>
        &lt;comment>&lt;b>ME!&lt;/b>.  Well, not really.  Actually, it's some random image from the 'net.
&lt;/comment>
      &lt;/meta></b>
    &lt;/caption></code></pre>

<p>As mentioned before, this stylesheet does not care what you put in
the meta file, it just inserts anything in that file from the root
element on down.  So you are free to put any meta information your
application requires in the meta file and adjust the presentation
filters to style it as you will.</p>

<p>The .meta information is not inserted in to the
<code>&lt;image&gt;</code> tags because we know that none of our
presentation will not need any of it there.</p>

<a name="captionstyler.xsl" /><h4>captionstyler.xsl</h4>

<p><a href="/pub/a/2002/09/24/axkit.html#pipeline.png" name="pipeline_captionstyler_xsl.png"><img src="/pub/2002/09/24/graphics/pipeline_captionstyler_xsl.png" alt="captionstyler.xsl's position in the processing pipeline" width="110" height="84" border="0" align="right" /></a></p>

<p>The last two stages of our pipeline turn the data assembled so far into HTML.  This is done in two stages in order to separate general layout and presentation from the presentation of the caption because the
these portions of the presentation might need to vary independently between one collection of images and another.</p>

<p>The caption stylesheet for this example is:</p>


<pre><code>    &lt;xsl:stylesheet 
      version="1.0"
      xmlns:xsl="http://www.w3.org/1999/XSL/Transform"
    >
    
    &lt;xsl:template match="caption">
      &lt;caption width="100" align="left" valign="top">
    
        &lt;a href="{filename}">
          &lt;xsl:choose>
            &lt;xsl:when test="meta/title and string-length( meta/title )">
              &lt;xsl:copy-of select="meta/title/node()" />
            &lt;/xsl:when>
            &lt;xsl:otherwise>
              &lt;xsl:value-of select="name" />
            &lt;/xsl:otherwise>
          &lt;/xsl:choose>
        &lt;/a>&lt;br />
    
        &lt;font size="-1" color="#808080">
          &lt;xsl:copy-of select="last_modified/node()" />
          &lt;br />
        &lt;/font>
    
        &lt;xsl:copy-of select="meta/comment/node()" />
    
      &lt;/caption>
    &lt;/xsl:template>
    
    &lt;xsl:template match="*|@*|node()">
      &lt;xsl:copy>
        &lt;xsl:apply-templates />
      &lt;/xsl:copy>
    &lt;/xsl:template>
    
    &lt;/xsl:stylesheet></code></pre>

<p>The first template replaces all <code>&lt;caption&gt;</code> elements
with new <code>&lt;caption&gt;</code> cells with a default width and
alignment, and then fills these with the name of the image, which is
also a link to the underling image file, and the
<code>&lt;last_modified</code> time string formatted by <a href="/pub/a/2002/09/24/axkit.html?page=3#My::ProofSheet">My::ProofSheet</a> and any
<code>&lt;comment&gt;</code> that might be present in the meta
file.</p>

<p>The <code>&lt;xsl:choose&gt;</code> element is what selects the title
to display for the image.  The first <code>&lt;xsl:when&gt;</code>looks
to see if there is a <code>&lt;title&gt;</code> element in the meta file
and uses it if present.  The
<code>&lt;xsl:otherwise&gt;</code> defaults the name to the
<code>&lt;name&gt;</code> set by My::ProofSheet.</p>

<p>The captions output by this stage look like:</p>

<pre><code>    &lt;caption width="100" align="left" valign="top">
      &lt;a href="a-look.jpeg">A baby picture&lt;/a>
      &lt;br/>
      &lt;font size="-1" color="#808080">Wed Sep
        4 13:32:46 2002&lt;br/>
      &lt;/font>
      &lt;b>ME!&lt;/b>.  Well, not really.  Actually, it's
        some random image from the 'net.
    &lt;/caption>
    &lt;caption width="100" align="left" valign="top">
      &lt;a href="a-lotery.jpeg">a-lotery&lt;/a>
      &lt;br/>
      &lt;font size="-1" color="#808080">Wed Sep
        4 13:33:07 2002&lt;br/>&lt;/font>
    &lt;/caption></code></pre>

<p>The former is what comes out when a .meta file is found, the latter
when it is not.</p>

<a name="pagestyler.xsl"/><h4>pagestyler.xsl</h4>

<p>And now, the final stage.  If you've made it this far,
congratulations; this is the start of a real application and not just a
toy, so it's taken quite some time to get here.</p>

<p><a href="/pub/a/2002/09/24/axkit.html#pipeline.png" name="pipeline_pagestyler_xsl.png"><img src="/pub/2002/09/24/graphics/pipeline_pagestyler_xsl.png" alt="pagestyler.xsl's position in the processing pipeline" width="110" height="84" border="0" align="right"/></a></p>

<p>The final stage of the processing pipeline generates an HTML page from the raw data, except for the attributes and content of <code>&lt;caption&gt;</code> tags, which it passes through as-is:</p>


<pre><code>    &lt;xsl:stylesheet 
      version="1.0"
      xmlns:xsl="http://www.w3.org/1999/XSL/Transform"
    >
    
    &lt;xsl:template match="/*">
      &lt;html>
        &lt;head>
          &lt;title>Images in &lt;xsl:value-of select="title" />&lt;/title>
        &lt;/head>
        &lt;body bgcolor="#ffffff">
          &lt;xsl:apply-templates select="images" />
        &lt;/body>
      &lt;/html>
    &lt;/xsl:template>
    
    
    &lt;xsl:template match="images">
      &lt;table>
        &lt;xsl:apply-templates />
      &lt;/table>
    &lt;/xsl:template>
    
    &lt;xsl:template match="tr">
      &lt;xsl:copy>
        &lt;xsl:apply-templates select="*" />
      &lt;/xsl:copy>
    &lt;/xsl:template>
    
    &lt;xsl:template match="image">
      &lt;td align="left" valign="top">
        &lt;a href="{filename}">
          &lt;img border="0" src="{thumb_uri}">
            &lt;xsl:if test="thumb_width">
              &lt;xsl:attribute name="width">
                &lt;xsl:value-of select="thumb_width" />
              &lt;/xsl:attribute>
            &lt;/xsl:if>
            &lt;xsl:if test="thumb_height">
              &lt;xsl:attribute name="height">
                &lt;xsl:value-of select="thumb_height" />
              &lt;/xsl:attribute>
            &lt;/xsl:if>
          &lt;/img>
        &lt;/a>
      &lt;/td>
    &lt;/xsl:template>
    
    &lt;xsl:template match="@*|node()" mode="caption">
      &lt;xsl:copy>
        &lt;xsl:apply-templates select="@*|node()" mode="caption" />
      &lt;/xsl:copy>
    &lt;/xsl:template>
    
    &lt;xsl:template match="caption">
      &lt;td>
        &lt;xsl:apply-templates select="@*|node()" mode="caption" />
      &lt;/td>
    &lt;/xsl:template>
    
    &lt;/xsl:stylesheet></code></pre>

<p>The first template generates the skeleton of the HTML page, the
second one grabs the <code>&lt;images&gt;</code> list from the source
document, emits a <code>&lt;table&gt;</code>, the third copies the
<code>&lt;tr&gt;</code> tags, the fourth replaces all
<code>&lt;image&gt;</code> tags with <code>&lt;td&gt;</code> tags
containing the thumbnail image as a link to the underlying image
(similar to what <a href="/pub/a/2002/09/24/axkit.html?page=4#captionstyler.xsl">captionstyler.xsl</a> did
with the picture name).  The only subtlety here is that the optional
<code>&lt;thumb_width&gt;</code> and <code>&lt;thumb_height&gt;</code>
elements are used, if present, to inform the browser of the size of the
thumbnail in order to speed up the layout process (as mentioned before, pages
that don't contain this information are not cached so that when the
thumbnails are generated, new HTML will be generated with it).</p>

<p>The fourth template converts the <code>&lt;caption&gt;</code>
elements to <code>&lt;td&gt;</code> elements and copies all their
content through, since <a href="/pub/a/2002/09/24/axkit.html?page=4#captionstyler.xsl">captionstyler.xsl</a> already did the
presentation for them.</p>

<p>Tweaking this stylesheet or replacing it controls the entire page
layout other than thumbnail sizing (which is set by the optional
<code>MyMaxX</code> and <code>MyMaxY</code> <code>PerlSetVar</code>
settings in <a href="/pub/a/2002/09/24/axkit.html?page=2#httpd.conf">httpd.conf</a>).  A different
stylesheet in this point in the chain could choose to ignore the
<code>&lt;tr&gt;</code> tags and present a list style output.  A later
stylesheet could be added to add branding or advertising to the site,
etc., etc.</p>

<a name="My::Thumbnailer"/><h4>My::ThumbNailer</h4>

<p>Here's the apache module that generates thumbnails.  The key thing to
remember is that, unlike all the other code and XML shown in this
article, this is called once per thumbnail image, not once per
directory.  When a browser requests a directory listing, it gets HTML
from the pipeline above with lots of URIs for thumbnail images.  It will
then usually request each of those in turn.  The <a href="/pub/a/2002/09/24/axkit.html?page=2#httpd.conf">httpd.conf</a> file directs all requests for dotfiles
to this module:</p>


<pre><code>    package My::Thumbnailer;
    
    <font color="#000000"># Allow other modules like <a href="/pub/a/2002/09/24/axkit.html?page=3#My::ProofSheet">My::ProofSheet</A> to use some</font>
    <font color="#000000"># of our utility routines.</font>
    use Exporter;
    @ISA = qw( Exporter );
    @EXPORT_OK = qw( image_size thumb_limits );
    
    use strict;
    
    use <a href="http://search.cpan.org/author/DOUGM/mod_perl-1.27/Constants/Constants.pm">Apache::Constants</a> qw( DECLINED );
    use <a href="http://search.cpan.org/author/JIMW/libapreq/Request/Request.pm">Apache::Request</a>;
    use <a href="http://search.cpan.org/author/JHI/perl/lib/File/Copy.pm">File::Copy</a>;
    use <a href="http://search.cpan.org/author/ADDI/Imager/Imager.pm">Imager</a>;
    
    
    sub image_size {
        my $img = shift;
    
        if ( ! ref $img ) {
            my $fn = $img;
            $img = Imager->new;
            $img->open( file => $fn )
                or die $img->errstr(), ": $fn";
        }
    
        ( $img->getwidth, $img->getheight );
    }
    
    
    sub thumb_limits {
        my $r = shift;
    
        <font color="#000000"># See if the site admin has placed MyMaxX and/or</font>
        <font color="#000000"># MyMaxY in the <a href="/pub/a/2002/09/24/axkit.html?page=2#httpd.conf">httpd.conf</a>.</font>
        my ( $max_w, $max_h ) = map
            $r->dir_config( $_ ),
            qw( MyMaxX MyMaxY );
    
        return ( $max_w, $max_h )
            if $max_w || $max_h;
    
        <font color="#000000"># Default to scaling down to fit in a 100 x 100</font>
        <font color="#000000"># pixel area (aspect ration will be maintained).</font>
        return ( 100, 100 );
    }
    
    
    <font color="#000000"># Apache/mod_perl <a href="/pub/a/2002/09/24/axkit.html?page=2#httpd.conf">is configured</a> to call</font>
    <font color="#000000"># this handler for every dotfile</font>
    <font color="#000000"># requested.  All thumbnail images are dotfiles,</font>
    <font color="#000000"># some dotfiles may not be thumbnails.</font>
    sub handler {
        my $r = Apache::Request->new( shift );
    
        <font color="#000000"># We only want to handle images.</font>
        <font color="#000000"># Let Apache handle non-images.</font>
        goto EXIT
            unless substr( $r->content_type, 0, 6 ) eq "image/";
    
        <font color="#000000"># The actual image filename is the thumbnail</font>
        <font color="#000000"># filename without the leading ".".  There's</font>
        ( my $orig_fn = $r->filename ) =~ s{/\.([^/]+)\z}{/$1}
            or die "Can't parse ", $r->filename;
    
        <font color="#000000"># Let Apache serve the thumbnail if it already</font>
        <font color="#000000"># exists and is newer than the original file.</font>
        {
            my $thumb_age = -M $r->finfo;
            my $orig_age  = -M $orig_fn;
            goto EXIT
                if $thumb_age &amp;&amp; $thumb_age &lt;= $orig_age;
        }
    
        <font color="#000000"># Read in the original file</font>
        my $orig = Imager->new;
        unless ( $orig->open( file => $orig_fn ) ) {
            <font color="#000000"># Imager can't hack the format, fall back</font>
            <font color="#000000"># to the original image.  This can happen</font>
            <font color="#000000"># if you forget to install libgif</font>
            <font color="#000000"># (as I have done).</font>
            goto FALLBACK
                if $orig->errstr =~ /format not supported/;
    
            <font color="#000000"># Other errors are probably more serious.</font>
            die $orig->errstr, ": $orig_fn\n";
        }
    
        my ( $w, $h ) = image_size( $orig );
    
        die "!\$w for ", $r->filename, "\n" unless $w;
        die "!\$h for ", $r->filename, "\n" unless $h;
    
        my ( $max_w, $max_h ) = thumb_limits( $r );
    
        <font color="#000000"># Scale down only,  If the image is smaller than</font>
        <font color="#000000"># the thumbnail limits, let Apache serve it as-is.</font>
        <font color="#000000"># thumb_limits() guarantees that either $max_w</font>
        <font color="#000000"># or $max_h will be true.</font>
        goto FALLBACK
            if ( ! $max_w || $w &lt; $max_w )
            &amp;&amp; ( ! $max_h || $h &lt; $max_h );
    
        <font color="#000000"># Scale down to the maximum dimension to the</font>
        <font color="#000000"># requested size.  This can mess up for images</font>
        <font color="#000000"># that are meant to be scaled on each axis</font>
        <font color="#000000"># independantly, like graphic bars for HTML</font>
        <font color="#000000"># page seperators, but that's a very small</font>
        <font color="#000000"># demographic.</font>
        my $thumb = $orig->scale(
            $w > $h
                ? ( xpixels => $max_w )
                : ( ypixels => $max_h )
        );
        $thumb->write( file => $r->filename,)
            or die $thumb->errstr, ": ", $r->filename;
    
        goto BONK;
    
    FALLBACK:
        <font color="#000000"># If we can't or don't want to build the thumbnail,</font>
        <font color="#000000"># just copy the original and let Apache figure it out.</font>
        warn "Falling back to ", $orig_fn, "\n";
        copy( $orig_fn, $r->filename );
    
    BONK:
        <font color="#000000"># Bump apache on the head just hard enough to make it</font>
        <font color="#000000"># forget the thumbnail file's old stat() and</font>
        <font color="#000000"># mime type since we've most likely changed all</font>
        <font color="#000000"># that now.  This is important for the headers</font>
        <font color="#000000"># that control downstream caching, for instance,</font>
        <font color="#000000"># or in case Imager changed mime types on us</font>
        <font color="#000000"># (unlikely, but hey...)</font>
        $r->filename( $r->filename );
    
    EXIT:
        <font color="#000000"># We never serve the image data, Apache is perfectly</font>
        <font color="#000000"># good at doing this without our help.  Returning</font>
        <font color="#000000"># DECLINED causes Apache to use the next handler in</font>
        <font color="#000000"># its list of handlers.  Normally this is the default</font>
        <font color="#000000"># Apache file handler.</font>
        return DECLINED;
    }
    
    1;</code></pre>

<p>There should be enough inline commentary to explain that lot.  The
only thing I'll say is that, to head off the gotophobes, I think the use
of <code>goto</code> makes this routine a lot clearer than the
alternatives; the early versions did not use it and were less
readable/maintainable.  This is because the three normal exit routes
happen to stack nicely up from the bottom so the fallthrough from one
labeled chunk to the next happens nicely.</p>

<p>The most glaring mistake here is that there is no file locking.
We'll add that in next time.</p>

<a name="Summary"/><h3>Summary</h3>

<p>The final result of the code in this article is to build the image
proofsheet section of <a href="/pub/a/2002/09/24/axkit.html?page=1#proofsheet.png">the page we showed at the
beginning of the article</a>.  The next article will complete that page, and
then we'll build the image presentation page and a metadata editor in future
articles.</p>


<a name="help" /><h3>Help and thanks</h3>

<p>In case of trouble, have a look at some of the <a href="/pub/a/2002/03/12/axkit.html?page=3#help">helpful resources we
listed in the first article</a>.</p>


        </div>



    </div>
    <div class="asset-footer"></div>
</div>


                            
                            <div id="entry-1370" class="entry-asset asset hentry">
    <div class="asset-header">
        <h2 class="asset-name entry-title"><a href="/pub/2002/09/p6pdigest/20020922.html" rel="bookmark">This week on Perl 6 (9/16 - 9/22, 2002)</a></h2>
        <div class="asset-meta">
            <span class="byline">
    
                By <span class="vcard author">Piers Cawley</span> on <abbr class="published" title="2002-09-22T00:00:00-08:00">September 22, 2002 12:00 AM</abbr>
    
            </span>

            
            

        </div>
    </div>
    <div class="asset-content entry-content">

        <div class="asset-body">
            
<!-- sidebar begins -->
<!-- don't move sidebars -->
<!-- sidebar ends -->


<p>So, another week, another Perl 6 summary. Let's see if I can get
through this one without calling Tim Bunce 'Tim Bunch' shall we? Or
maybe I should leave a couple of deliberate errors in as a less than
cunning ploy to get more feedback. Hmmm.</p>
<p>So, kicking off with the internals list as always:</p>

<h4><a name="the_compound_key_discussions_continue">The Compound Key discussions continue</a></h4>
<p>Dan Sugalski, Graham Barr and Leopold Toetsch (who, incidentally,
turned 44 on the 16th, so not only does he contribute really useful
code, he makes Dan and I feel younger. Can this man do no wrong?)  all
thought hard about Ken Fox's Hard Question from last week. The Hard
Question was: `If <code>%h{&quot;a&quot;}[0][1]</code> is a PASM <code>P2[&quot;a&quot;;0;1]</code>, then what
is <code>%h{&quot;a&quot;}{0}[1]</code>?'. Leo thought that things would work because an
integer isn't a valid key type for a hash, so the second case would throw
a `Not a string' error. Dan thought that this might not be enough, so
we probably need an extra flag to designate whether a key element
should be taken as an array or hash lookup. Graham Barr agreed, citing
the `hash with objects as keys' example that seems to crop up
everywhere, and suggesting the rather lovely looking <code>my @array is
indexed('a'..'b');</code> as another possibility. Graham also wondered how
the flag should be used, suggesting that it should get passed into a
vtable's lookup method, thus allowing the writing of PMCs that don't
care how they're looked up, or other PMCs that did cunning things
depending on how they were accessed. Dan agreed.</p>
<p><a href="http://groups.google.com/groups?threadm=3D85825B.7060004%40toetsch.at">http://groups.google.com/groups</a></p>

<h4><a name="return_undef_for_negative_indices">Return undef for negative indices</a></h4>
<p>Sean O'Rourke supplied a patch that arranged for <code>@ary[-1000]</code>, say,
to give <code>undef</code> when <code>@ary</code> has fewer than 1000 elements. Also
included was a patch which changed array's <code>get_string()</code> method to
return the array's <code>get_integer()</code> value converted to a string. Leo
Toetsch wasn't keen on this idea, wondering if it shouldn't return
something like &quot;PerlArray(0xaddr)&quot; by analogy with the behaviour of
PerlHash PMCs. Sean disagreed, pointing out that in Perl5 one could
say <code>print &quot;You scored $score out of&quot; . @questions . &quot;questions.&quot;</code>,
and the array would stringify to the number of elements it
contained. Brent Dax pointed out that in Perl 6 one would have to
write <code>print '\@foo has ' _ +@foo _ ' elements';</code> because Perl 6
arrays stringify to their elements, separated by
<code>.prop{sep} //= ' '</code>. Sean didn't like this, but appeared to take the
point. Uri Guttman quibbled about style, and proposed <code>print &quot;\@foo
has $(@foo.length) elements&quot;;</code>, which certainly does a good job of
making its intention explicit.</p>
<p><a href="http://rt.perl.org/rt2/Ticket/Display.html?id=17346">http://rt.perl.org/rt2/Ticket/Display.html</a></p>

<h4><a name="a_lexicals_prepatch">A Lexicals pre-patch</a></h4>
<p>Sean O'Rourke was unhappy with the current lexical implementation, as
it doesn't seem to support different levels of static
nesting. Apparently this makes nested scopes hard to implement,
especially in the presence of Perl 6's <code>%MY</code> magic. So he sent a
patch for people to play with.</p>
<p>Jonathan Sillito liked the patch, and pointed to a different
approach that would make taking closures easier, but which would
possibly make lookup slightly less efficient. Sean wondered how Jon's
scheme would handle recursion. Jon thought about that, and answered
by outlining how you would implement closures using Sean's scheme, and
proposing that Sean make a 'real' patch.</p>
<p>J&uuml;rgen <strong>ouml</strong>mmels had a pile of questions too, related to
using Sean's patch to implement proper Scheme functions, and he
proposed a set of ops for manipulating pads. Sean agreed that this
looked useful.</p>
<p><a href="http://groups.google.com/groups?threadm=Pine.GSO.4.32.0209152038100.73-101000%40gradlab.ucsd.edu">http://groups.google.com/groups</a></p>
<p><a href="http://groups.google.com/groups?threadm=Pine.LNX.4.44.0209160934050.32450-100000%40taipan.cs.ubc.ca">http://groups.google.com/groups</a></p>
<p><a href="http://groups.google.com/groups?threadm=Pine.LNX.4.44.0209160934050.32450-100000%40taipan.cs.ubc.ca">http://groups.google.com/groups</a></p>

<h4><a name="default.pmc_patches"><em>default.pmc</em> patches</a></h4>
<p>Leopold Toetsch patched <em>default.pmc</em> to make almost all methods
throw meaningful exceptions. Sean O'Rourke reckoned that the patch
went a bit far, proposing a few places where having a slightly richer
default behaviour would be the Right Thing to do, and some others
where doing nothing was the right default behaviour -- the example given
was <code>init</code>. Leo countered that one should really have a
<em>default_scalar.pmc</em> for the first types, and that, for the second
type, the PMC should have an explicitly empty method. The thread
resembled the Monty Python Argument skit for a few messages (`Look,
this isn't a proper argument!', `Yes it is!', `No it isn't it's just
contradiction!'). After a couple of rounds of this, Sean showed his
(substantial) list of default behaviours that he thinks should be in
<em>default.pmc</em>, and Leo showed us his planned PMC hierarchy.</p>
<p>Dan came down on Leo's side.</p>
<p><a href="http://rt.perl.org/rt2/Ticket/Display.html?id=17358">http://rt.perl.org/rt2/Ticket/Display.html</a></p>
<p><a href="http://groups.google.com/groups?threadm=Pine.GSO.4.32.0209170711300.27456-100000%40gradlab.ucsd.edu">http://groups.google.com/groups</a> -- Sean's
list</p>
<p><a href="http://groups.google.com/groups?threadm=3D88134D.20607%40toetsch.at">http://groups.google.com/groups</a> -- Leo's hierarchy</p>

<h4><a name="keyed_ops">Keyed ops</a></h4>
<p>Has there been a week since I started doing these summaries that
<em>hasn't</em> seen a discussion of keys, keyed ops or key structures? This
week's <em>second</em> keys thread was kicked off by Leopold Toetsch
wondering about the legality of, for example:</p>
<pre><code>
    add P0[P1], P2, P3[P4]</code></pre>
<p>If it is legal, what PASM ops should be generated. The problem is
that the naive approach of using an op based on the argument list
would lead to a horrible explosion of specific opcodes to deal with
the possible combinations of keyed and unkeyed arguments. Leo wondered
if the instruction should get turned into:</p>
<pre><code>
    add P0[P1], P2[&lt;The Null Key&gt;], P3[P4]</code></pre>
<p>Tom Hughes and Leo batted this back and forth for a bit. Tom noted
that it wouldn't be hard to create a null key: just create a key with
0 elements for every PMC that didn't otherwise have a key structure,
but he still worried that we were looking at 64 different op codes for
each 3 argument op.</p>
<p>Sean O'Rourke pointed out that if scratchpads do become `proper'
PMCs, then the various 3 argument keyed ops would become remarkably
useful. For instance <code>@a[0] = %b{1} + $c</code> could become</p>
<pre><code>
    add P0[&quot;@a0&quot;;0], P0[&quot;%b&quot;;1], P0[&quot;$c&quot;]</code></pre>
<p>But Tom wasn't sure that this quite fit in with Leo's plan. Leo
meanwhile produced an RFC with his proposals for how keyed opcodes
should look.</p>
<p><a href="http://groups.google.com/groups?threadm=3D883BE9.6060600%40toetsch.at">http://groups.google.com/groups</a></p>
<p><a href="http://groups.google.com/groups?threadm=3D8AE672.7040201%40toetsch.at">http://groups.google.com/groups</a></p>















<h3><a name="meanwhile,_in_perl6language...">Meanwhile, in perl6-language...</a></h3>
<p>Last week's discussion of argument passing continued on its merry
way. As well as a certain amount of debate as to the meaning of
`topicalize', Larry clarified a few points. For instance, current
thinking seems to be that if you want to capture the caller's topic
in a named variable you'd do:</p>
<pre><code>
   sub (...) is given ($x) { ... }</code></pre>
<p>which would set the sub's <code>$x</code> variable to the same value as its caller's
<code>$_</code>. He also offered some comments on good style when using <code>$_</code> and
made Angel Faus's day when he told us that it's looking like parameter
defaults will be specified by <code>=</code> rather than <code>//=</code>. Sean O'Rourke
wasn't entirely sure about the <code>is given</code> syntax, but Larry pointed
out that Sean's proposed syntax wouldn't allow for prototyping
`<code>CORE::print</code>, among other things.' It also looks like we're going
to be using <code>exists</code> to see whether a parameter got passed or not.</p>
<p><a href="http://groups.google.com/groups?threadm=Pine.LNX.4.44.0209200730130.31624-100000%40london.wall.org">http://groups.google.com/groups</a></p>
<p><a href="http://groups.google.com/groups?threadm=Pine.LNX.4.44.0209200829370.31624-100000%40london.wall.org">http://groups.google.com/groups</a></p>
<p><a href="http://groups.google.com/groups?threadm=Pine.LNX.4.44.0209200858210.31624-100000%40london.wall.org">http://groups.google.com/groups</a></p>
<p><a href="http://groups.google.com/groups?threadm=Pine.LNX.4.44.0209200927190.31624-100000%40london.wall.org">http://groups.google.com/groups</a></p>

<h4><a name="hotplug_regexes,_other_misc_regex_questions">Hotplug regexes, other misc regex questions</a></h4>
<p>Steve Fink asked a few questions, mostly relating to pattern closures
having side effects, supplying a few pathological (psychotic?) patterns
as examples. My particular `favourite' was</p>
<pre><code>
   my $x = &quot;the letter x&quot;;
   print &quot;yes&quot; if $x =~ /the { $x _= &quot;!&quot; } .* !/;</code></pre>
<p>Damian reckoned that if the above were allowed at all, then the match
should succeed, and offered answers (opinions) on the rest of Steve's
menagerie. One of his suggestions involved a superposition, but I
think he might have been joking. Larry also gave his somewhat more
authoritative answers.</p>
<p><a href="http://groups.google.com/groups?threadm=20020915232729.GM17811%40foxglove.digital-integrity.com">http://groups.google.com/groups</a></p>
<p><a href="http://groups.google.com/groups?threadm=3D88954F.7010508%40conway.org">http://groups.google.com/groups</a></p>
<p><a href="http://groups.google.com/groups?threadm=Pine.LNX.4.44.0209200130560.29479-100000%40london.wall.org">http://groups.google.com/groups</a></p>

<h4><a name="hyperoperators_and_dimensional_extension">Hyperoperators and dimensional extension</a></h4>
<p>Brent Dax wondered about how hyperoperators would work with multiple
dimensions. Dan's answer can be summarized as `properly', which wasn't
quite specific enough for Brent, but Dan stuck to his guns. Dan also
demonstrated that whilst he may be an American, he knows how to spell
`behaviour'.</p>
<p><a href="http://groups.google.com/groups?threadm=007f01c25ee1%24a7899760%246501a8c0%40deepblue">http://groups.google.com/groups</a></p>

<h4><a name="regex_query">Regex query</a></h4>
<p>Simon Cozens had a few questions about grammars and rules. He's trying
to write a grammar to parse a Linux <em>/etc/raidtab</em> file, and has a
few questions about `drilling down' into the match object. The thread
is tricky to summarize. However, in one post Larry said that `any
list forced into scalar context will make a ref in Perl 6' and gave
<code>$arrayref = (1,2,3)</code> as an example. This caused a thread explosion,
which has boiled over into the current week as people followed the
implications of that through (some even going so far as to wonder if
that meant we wouldn't need <code>[...]</code> any more). Frankly, things got
ugly (at least syntactically). I'm tempted to draw a veil over some of
the ugliness; if you want to, read the thread. I'm waiting for Larry
to get back home and make everything better with another of his
shockingly wise postings. No pressure Larry.</p>
<p><a href="http://groups.google.com/groups?threadm=86lm5xry63.fsf%40squash.oucs.ox.ac.uk">http://groups.google.com/groups</a></p>
<p><a href="http://groups.google.com/groups?threadm=Pine.LNX.4.44.0209200110510.29479-100000%40london.wall.org">http://groups.google.com/groups</a> --
Pigeons, meet a cat.</p>

<h4><a name="backtracking_syntax">Backtracking syntax</a></h4>
<p>'Ralph' doesn't like the backtracking syntax, and proposed replacing
<code>:</code>, <code>::</code>, <code>:::</code>, <code>&lt;commit&gt;</code> and <code>&lt;cut&gt;</code> with <code>:</code>,
<code>:]</code>, <code>:&gt;</code>, <code>:/</code> and <code>://</code> respectively. Simon Cozens and
Markus Laire spoke up against the proposal.</p>
<p><a href="http://groups.google.com/groups?threadm=039201c26267%24684374c0%246601a8c0%40ralph">http://groups.google.com/groups</a></p>


<h3><a name="in_brief">In Brief</a></h3>
<p>Leopold Toetsch has sent Dan a patch to implement a proposed hierarchy
of PMC classes. Leo was this week's official patchmonster, submitting
patches to make <em>core_ops*.c</em> more readable, improve predereferencing
in <em>interpreter.c</em>, add a test case for restarting the interpreter
and squeezing out a 10% increase in life performance. (This last one
brought some questions from Mike Lambert.)</p>
<p>Simon `Unix Guru' Cozens popped in with some bug spots. First, he
pointed out that the magic number in a .pbc file wasn't being taken
into account in time. Then he found that <code>queens.pasm</code> was solving
the somewhat trivial `one queen problem', rather than the more
impressive `8 queens' problem. Finally, he pointed out that the <em>hanoi</em>
program seemed to be slightly broken too. And then the week ran out.</p>
<p>Garret Goebbel pointed us all at a survey of native interfaces for
several languages, which can be found at:
<a href="http://xarch.tu-graz.ac.at/autocad/lisp/ffis.html">http://xarch.tu-graz.ac.at/autocad/lisp/ffis.html</a></p>


<h3><a name="who's_who_in_perl_6">Who's Who in Perl 6</a></h3>
<dl>
<dt><strong><a name="item_who_are_you%3f">Who are you?</a></strong><br />
</dt>
<dd>
Leon Brocard, <a href="mailto:acme@astray.com">acme@astray.com</a>
</dd>

<dt><strong><a name="item_what_do_you_do_for%2fwith_perl_6%3f">What do you do for/with Perl 6?</a></strong><br />
</dt>
<dd>
I'm currently more interested in the Parrot side of Perl 6. I mostly
tinker with Parrot assembly (PASM), and try to keep the
<a href="http://parrotcode.org/examples/">http://parrotcode.org/examples/</a> page up to date with current Parrot
thinking. Sometimes I convert C code to PASM by hand. Sometimes I
think evil things about converting other bytecode formats (say, Java's
.class files) to Parrot. I presented a talk at the O'Reilly Open
Source Conference called &quot;<a href="http://conferences.oreillynet.com/cs/os2002/view/e_sess/2515">Targeting Parrot</a>&quot;, which is something that we should make terribly easy to actually do.
</dd>

<dt><strong><a name="item_where_are_you_coming_from%3f">Where are you coming from?</a></strong><br />
</dt>
<dd>
680x0 programming, mostly. Programming Parrot is like how you remember
programming assembly was, only higher level and more fun.
</dd>

<dt><strong><a name="item_when_do_you_think_perl_6_will_be_released%3f">When do you think Perl 6 will be released?</a></strong><br />
</dt>
<dd>
Sooner than most people think.
</dd>

<dt><strong><a name="item_why_are_you_doing_this%3f">Why are you doing this?</a></strong><br />
</dt>
<dd>
For fun, of course. And because it's interesting to see the development
process behind a fast, portable virtual machine. Actually implementing
Perl 6 on top of Parrot is just a simple matter of programming...
</dd>

<dt><strong><a name="item_you_have_5_words%2e_describe_yourself%2e">You have 5 words. Describe yourself.</a></strong><br />
</dt>
<dd>
Orange Perl/Parrot Euro-hacker
</dd>

<dt><strong><a name="item_do_you_have_anything_to_declare%3f">Do you have anything to declare?</a></strong><br />
</dt>
<dd>
I enjoy optimising computer-generated SQL statements.
</dd>
</dl>


<h3><a name="acknowledgements">Acknowledgements</a></h3>
<p>It looks like Wednesday is becoming summary mail out day
now. Surprisingly time consuming so it is...</p>
<p>Thanks to Leon Brocard for answering the questionnaire, making it
embarrassingly easy for me to mention his name this week. I'm now
running <em>really</em> low on sets of answers. Come on people, mail your
answers to <em><a href="mailto:5Ws@bofh.org.uk">5Ws@bofh.org.uk</a></em> and fame and... well fame anyway
will be yours.</p>
<p>Once more, thanks to the crack proof readers on rhizomatic.net and
elsewhere. This week's primary proof readers were: Kate Pugh, Paul
Makepeace and Simon Bisson. Thanks people.</p>
<p>If you think this summary has value, then please send your money to
the Perl Foundation <a href="http://donate.perl-foundation.org">http://donate.perl-foundation.org</a> and help
support the ongoing development of Perl 6. As usual, the fee paid by
the O'Reilly Network for their publication of this summary has been
donated directly to the Perl Foundation.</p>

        </div>



    </div>
    <div class="asset-footer"></div>
</div>


                            
                            <div id="entry-1360" class="entry-asset asset hentry">
    <div class="asset-header">
        <h2 class="asset-name entry-title"><a href="/pub/2002/09/17/ewispp.html" rel="bookmark">Embedding Web Servers</a></h2>
        <div class="asset-meta">
            <span class="byline">
    
                <abbr class="published" title="2002-09-18T00:00:00-08:00">September 18, 2002 12:00 AM</abbr>
    
            </span>

            
            

        </div>
    </div>
    <div class="asset-content entry-content">

        <div class="asset-body">
            

<p>As with most of my previous articles, this one grew out of a project at
my $DAY_JOB.  The project du-jour involves large dependency graphs,
often containing thousands of nodes and edges.  Some of the
relationships are automatically generated and can be quite
complicated.  When something goes wrong, it's useful to be able to
visualize the graph.</p>
<p>Simple Graph:</p>
<img src="/pub/2002/09/17/graphics/graph.gif" alt="A Simple Graph" /><p>We 
use <a href="http://www.graphviz.org">GraphViz</a> for rendering the graph,
but it falls down on huge graphs.  They turn into an unreadable mess
of thick lines -- less than useful.  To work around this, we trim down the
graph to just a segment, centered around one node, and display
only n inputs or outputs.</p>
<p>This works great, except that the startup time to create the graph
data can be quite long, because of all the graph processing that is
necessary to make sure the information is up to date.  (The actually
graph rendering is quite fast, for small graphs.)</p>
<p>The solution?  Process the data once, and render it multiple times,
using, yes, you guessed it, a Web interface!</p>


<h4><a name="mechanics_of_http">Mechanics of HTTP</a></h4>
<p>The <a href="http://www.w3.org/Protocols/rfc2616/rfc2616.html">Hyper Text Transfer Protocol (HTTP)</a>, is the
protocol on which most of the Web thrives.  It is a simple
client/server protocol that runs over TCP/IP sockets.</p>
<p>Extremely oversimplified, it looks like this:</p>

<ul>
<li>
Client sends request to server: &quot;Send me document named X&quot;</li>

<li>
Server responds to client: &quot;Here's the data you asked for&quot; (or &quot;Sorry!
I don't know what you mean.&quot;)</li>

</ul>

<p>In practice, it's not much more complicated:</p>
<p>We will use <a href="http://www.wget.org">wget</a> to examine a sample HTTP
request:</p>
<p><code>wget -dq http://www.perl.org/index.shtml</code></p>
<pre><code>
 ---request begin---
 GET /index.shtml HTTP/1.0
 User-Agent: Wget/1.8.1
 Host: www.perl.org
 Accept: */*
 Connection: Keep-Alive
 
 ---request end---
 HTTP/1.1 200 OK
 Date: Tue, 13 Aug 2002 18:12:23 GMT
 Server: Apache/2.0.40 (Unix)
 Accept-Ranges: bytes
 Content-Length: 10494
 Keep-Alive: timeout=15, max=100
 Connection: Keep-Alive
 Content-Type: text/html; charset=ISO-8859-1
 
 &lt;... data downloaded to a file by wget...&gt;</code></pre>
<p>There's a lot of things we don't care about in a simple server - so
lets boil it down to the guts.</p>
<p>Request:</p>
<pre><code>
 GET /index.shtml HTTP/1.0</code></pre>
 
<p><code>GET</code> is the type of HTTP action.  There are others, but they're
beyond the scope of this article.</p>

<p><code>/index.shtml</code> is the name of the page to retrieve.</p>

<p><code>HTTP/1.0</code> is the protocol version supported by your client.</p>

<p>Response:</p>
<pre><code>
 HTTP/1.1 200 OK
 Content-Type: text/html;
 
 &lt;data&gt;</code></pre>
 
<p>The first line is the status response.  It includes the HTTP protocol
version supported by the server, followed by the 
<a href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10">status code</a> and
a short text string defining the status.</p>

<p>For this article, we'll just care about status code 200 (everything
is ok, here's the data) and code '404' (not found).</p>

<p>The next line is the MIME content type.  This is required so that the
Web browser knows how to display the data.</p>

<p>Common Content-Types:</p>

<pre><code>
        text/html       a HTML document
        text/plain      a plain text document
        image/jpeg      a JPEG image
        image/gif       a GIF image</code></pre>
		
<p>After the above &quot;header&quot; section, there must be a blank line, and then
the bytes containing the data.  There's a lot more information that
can go into the header block, but for the simple applications we will
be developing, they are not needed.</p>

<p>You can use a telnet client to retrieve data from any Web server.  You
need to be careful though - many modern Web servers are virtual hosted,
which means they require the Host: header in the request to retrieve
the appropriate data.</p>















<h3><a name="writing_a_simple_webserver">Writing A Simple Web Server</a></h3>


<h4><a name="the_basics">The Basics</a></h4>

<p>With the above information, it isn't hard to write your own simple
Web server.  There are several ways to do this and a few already
written on CPAN.  We're going to start from first principles though,
and pretend, for the moment, we don't know about CPAN.</p>

<p>A good place to start looking for client/server information is in the
<a href="http://www.perldoc.com/perl5.8.0/pod/perlipc.html">perlipc</a> document.
About 2/3 of the way through is a section on &quot;Internet TCP Clients and
Servers&quot;.  This section shows how to use simple socket commands to
setup a simple server.  A little further down is the section we're
interested in - it demonstrates using the IO::Socket module to write a
simple TCP server.  I'll replicate that here.</p>

<pre><code>
 #!/usr/bin/perl -w
 use IO::Socket;
 use Net::hostent;              # for OO version of gethostbyaddr
 
 $PORT = 9000;                  # pick something not in use
 
 $server = IO::Socket::INET-&gt;new( Proto     =&gt; 'tcp',
                                  LocalPort =&gt; $PORT,
                                  Listen    =&gt; SOMAXCONN,
                                  Reuse     =&gt; 1);
								  
 die &quot;can't setup server&quot; unless $server;
 print &quot;[Server $0 accepting clients at http://localhost:$PORT/]\n&quot;;
 
 while ($client = $server-&gt;accept()) {
   $client-&gt;autoflush(1);
   print $client &quot;Welcome to $0; type help for command list.\n&quot;;
   $hostinfo = gethostbyaddr($client-&gt;peeraddr);
   printf &quot;[Connect from %s]\n&quot;, $hostinfo-&gt;name || $client-&gt;peerhost;
   print $client &quot;Command? &quot;;
   while ( &lt;$client&gt;) {
     next unless /\S/;       # blank line
     if    (/quit|exit/i)    { last; }
     elsif (/date|time/i)    { printf $client &quot;%s\n&quot;, scalar localtime; }
     elsif (/who/i )         { print  $client `who 2&gt;&amp;1`; }
     elsif (/cookie/i )      { print  $client `/usr/games/fortune 2&gt;&amp;1`; }
     elsif (/motd/i )        { print  $client `cat /etc/motd 2&gt;&amp;1`; }
     else {
       print $client &quot;Commands: quit date who cookie motd\n&quot;;
     }
   } continue {
      print $client &quot;Command? &quot;;
   }
   close $client;
 }</code></pre>


<h4><a name="httpify_it">HTTPify It</a></h4>

<p>That's not a HTTP server by any stretch of the imagination, but with a
different inner loop it could easily become one:</p>

<pre><code>
 while ($client = $server-&gt;accept()) {
   $client-&gt;autoflush(1);
   
   my $request = &lt;$client&gt;;
   if ($request =~ m|^GET /(.+) HTTP/1.[01]|) {
      if (-e $1) {
       print $client &quot;HTTP/1.0 200 OK\nContent-Type: text/html\n\n&quot;;
       open(my $f,&quot;&lt;$1&quot;);
       while(&lt;$f&gt;) { print $client $_ }; 
      } else {
       print $client &quot;HTTP/1.0 404 FILE NOT FOUND\n&quot;;
       print $client &quot;Content-Type: text/plain\n\n&quot;;
       print $client &quot;file $1 not found\n&quot;;
      }      
   } else {
     print $client &quot;HTTP/1.0 400 BAD REQUEST\n&quot;;
     print $client &quot;Content-Type: text/plain\n\n
     print $client &quot;BAD REQUEST\n&quot;;
   }
   close $client;
 }</code></pre>
 
<p>Let's look at the changes piece by piece:</p>

<pre><code>
   my $request = &lt;$client&gt;;</code></pre>
   
<p>Retrieve one line from the socket connected to the client.  For this
to be a valid HTTP request, it must match the following:</p>

<pre><code>
   if ($request =~ m|^GET /(.+) HTTP/1.[01]|) {</code></pre>
   
<p>That checks that it's a HTTP GET request, and is of a protocol version
we know about.</p>

<pre><code>
      if (-e $1) {
       print &quot;HTTP/1.0 200 OK\nContent-Type: text/html\n\n&quot;;
       open(my $f,&quot;&lt;$1&quot;);
       while(&lt;$f&gt;) { print $client $_ };</code></pre>
	   
<p>If the requested file exists, then send back a HTTP header that says that,
along with a content type, and then the data.  (We are assuming the
content type is HTML here.  Most http servers figure out the content
type from the extension of the file.)</p>

<pre><code>
      } else {
       print $client &quot;HTTP/1.0 404 FILE NOT FOUND\n&quot;;
       print $client &quot;Content-Type: text/plain\n\n&quot;
       print $client &quot;file $1 not found\n&quot;;
      }</code></pre>
	  
<p>If the file doesn't exist, then send back a 404 error.  The content of the
error is a description of what went wrong.</p>

<pre><code>
   } else {
     print $client &quot;HTTP/1.0 400 BAD REQUEST\n&quot;;
     print $client &quot;Content-Type: text/plain\n\n
     print $client &quot;BAD REQUEST\n&quot;;
   }</code></pre>
   
<p>A similar error handler, in case we can't parse the request.</p>

<p>Almost 50 percent of the code is for error handling, and that doesn't even
take into account the error handling we didn't do for I/O issues.  But
that's the core of a Web server, all in about 15 lines of Perl.</p>

<p>
If you use the above code without modification, it will allow <I>every          
file on your system</i> to be read.  Generally, this is a bad thing.  An          
explanation of proper security is outside the scope of this article,           
but generally you want to limit access to a subset of files, located           
under some directory prefix.  <code>File::Spec::canonpath</code> and
<code>Cwd::realpath</code> are useful functions for testing this. 
</p>

<h3><a name="single_threaded,_non_forking,_blocking">Single Threaded, Nonforking, Blocking</a></h3>
<p>The Web server presented above is very simple.  It only deals with
one request at a time.  If a second request is received while the
first is being processed, then it will be <strong>blocked</strong> until the first
completes.</p>

<p>There are two schemes used to take advantage of modern computers'
ability to multiprocess (run more than one thing at once.)  The
simplest way is to fork off a Web server process for each incoming
request.  Because of forking overhead, many servers pre-fork.  The
second method is to create multiple threads.  (Threads are lighter
weight than processes.)</p>

<p>For a simple embedded server, it isn't much more difficult to build a
forking server, but the extra work is unnecessary if it's only going
to be used by one person or with a low hit-rate.  The only advantage
to the forking method is that it can serve multiple pages at once.
(Taking advantage of modern operating systems ability to
multiprocess.)</p>

<p>More information on forking servers, can be found in the
<a href="http://www.perldoc.com/perl5.8.0/pod/perlipc.html">perlipc</a>
documentation.</p>

<p>With a simple modification to our loop, we can turn our Web server into
a forking client:</p>

<pre><code>
 while ($client = $server-&gt;accept()) {
   my $pid = fork();
   die &quot;Cannot fork&quot; unless defined $pid;
   do { close $client; next; } if $pid; # parent
   # fall through in child
   $client-&gt;autoflush(1);</code></pre>




<h3><a name="structure">Structure</a></h3>
<p>The example server above is useful for simple reporting of generated
data.  Because the accept loop is closed, all processing by the main
part of the program needs to be complete before the Web server is run.
(Of course, actions from the Web server can trigger other pieces of the
program to run.)</p>
<p>There are other ways to integrate a simple Web server depending on the
structure of your program, but for this article, we'll stick with the
design above.</p>


















<h3><a name="graph_walker">Graph Walker</a></h3>
<p>Above we mentioned using GraphViz to create an embedded graph viewer.
To do that we'll use a Graph class that has some methods that will
make our life easier.  (There isn't actually a class that does all
this, but you can do it with a combination of Graph and GraphViz
available on CPAN.)</p>
<p>It is outside the scope of this article to cover graph operations, but
I've named the methods so that they should be easy to figure out.  I
am also going to gloss over some of the GraphViz details.  They can be
picked up from a tutorial.</p>


<h4><a name="three_easy_steps">Three Easy Steps</a></h4>

<ol>
<li><p><strong><a name="item_define_the_goal">Define the Goal</a></strong></p>

<p>This is the easy part.
</p>
<p>To develop a graph browser that allows the user to click on a node to
recenter the graph.</p>
</li>

<li><p><strong><a name="item_define_the_url_scheme">Define the URL scheme</a></strong></p>

<p>How is the Web browser going to communicate back to the Web server?
The only way it can is by requesting pages (via URLs.)  For a graph
browser we need two different kinds.
</p>

<p>First, an image representing the graph.  Second, a HTML page containing
the <strong>IMG</strong> tag for the graph and the 
<a href="http://www.cris.com/~automata/tutorial.shtml">imagemap</a>.</p>

<p>Since every node has a unique name we can use that to represent which
node, and then use an extension to determine whether it is the HTML
page or the graphic.</p>
<pre><code>
    node1.html - HTML page for graph centered on node1
    node1.gif  - GIF image for graph centered on node1</code></pre>

</li>

<li><p><strong><a name="item_implement%21">Implement!</a></strong></p>

<p>Now that you know what you're building, you can put it all together
and implement it.
</p>

</li>
</ol>

<pre><code>
 my $graph = do_something_and_build_a_graph();
 
 while ($client = $server-&gt;accept()) {
   $client-&gt;autoflush(1);
   
   my $request = &lt;$client&gt;;
   if ($request =~ m|^GET /(.+)\.(html|gif) HTTP/1.[01]|) {
      if ($graph-&gt;has_node($1)) {
       if ($2 eq &quot;gif&quot;) {
         send_gif( $client, $1 );
       } else { # $2 must be 'html'
         send_html( $client, $1 );
       }
      } else {
       print $client &quot;HTTP/1.0 404 NODE NOT FOUND\n&quot;;
       print $client &quot;Content-Type: text/plain\n\n&quot;;
       print $client &quot;node $1 not found\n&quot;;
      }      
   } else {
     print $client &quot;HTTP/1.0 400 BAD REQUEST\n&quot;;
     print $client &quot;Content-Type: text/plain\n\n
     print $client &quot;BAD REQUEST\n&quot;;
   }
   close $client;
 }
 
 sub send_html {
    my ($client, $node) = @_;
	
    my $subgraph = $graph-&gt;subgraph( $node, 2, 2 );
    
    my $csimap = $subgraph-&gt;as_csimap( &quot;graphmap&quot; );
    my $time = scalar localtime;
	
    print $client &quot;HTTP/1.0 200 OK\nContent-Type: text/html\n\n&quot;;
	
    print $client&lt;&lt;&quot;EOF&quot;;
	
    &lt;HTML&gt;
     &lt;HEAD&gt;
      &lt;TITLE&gt;Graph centered on $node&lt;/TITLE&gt;
      $csimap
     &lt;/HEAD&gt;
     &lt;BODY&gt;
     &lt;H1&gt;Graph centered on $node&lt;/H1&gt;
     &lt;IMG SRC=&quot;/$node.gif&quot; USEMAP=&quot;graphmap&quot; BORDER=0&gt;
     &lt;HR&gt;
     &lt;SMALL&gt;Page generated at $time&lt;/SMALL&gt;
     &lt;/BODY&gt;
    &lt;/HTML&gt;
  
  EOF
     ;
	 
  }
  
 sub send_gif {
    my ($client, $node) = @_;
	
    my $subgraph = $graph-&gt;subgraph( $node, 2, 2 );
    
    my $gif = $subgraph-&gt;as_gif();
	
    print $client &quot;HTTP/1.0 200 OK\nContent-Type: text/gif\n\n&quot;;
	
    print $client $gif;
	
  }     
    
And that's it!  We have created a dynamic graph browser.</code></pre>

<p>I will admit that we glossed over some of the HTML and Client Side
Imagemap details -- because they're tangential to the issue of embedding
a Web server into a tool.  An embedded Web server is like merging the
Web server, cgi script and source of the data into one program --
sometimes the best way to build one is to start with a standard CGI
script and use that.</p>


<h3><a name="more_details">More Details</a></h3>


<h4><a name="query_strings">Query Strings</a></h4>

<p>Because our embedded Web server isn't serving actual files off of your
hard drive you have lots of flexibility as to how to parse the
requested URL.  In normal Web servers the common way to pass extra
arguments to requested pages/scripts is by using a <strong>query string</strong>.</p>

<p>A URL with a query string looks like this:</p>

<pre><code>
    http://foo.bar/thepage.html?querystring</code></pre>
	
<p>There is a convention for passing key/value data in query strings
(from HTML FORM's for example):</p>

<pre><code>
    http://foo.bar/page.html?keyone=dataone&amp;keytwo=datatwo&amp;keythree=3&quot;</code></pre>
	
<p>It's easy to modify our embedded webserver template to accept query
strings.  Just add it to the regular expression that parses the
request:</p>

<pre><code>
   if ($request =~ m|^GET /(.+)(?:\?(.*))? HTTP/1.[01]|) {</code></pre>
   
<p>$2 will then contain the query string.  You can parse it by hand or
pass it to CGI.pm or another CGI Module to parse it.</p>


<h4><a name="uri_escaping">URI Escaping</a></h4>

<p>Some characters have special meaning in URIs.  (We've already seen ?
and &amp;.  Others are &quot; (space), %, and #.  See the RFC for the full
list.)  In order to allow them to be passed in requests they need to
be escaped.  Escaping a URI changes the special characters into their
hex representation with a prepended %.  For example, &quot; becomes %20.</p>

<p>The easiest way to perform this encoding is to use the URI::Escape
module.</p>

<pre><code>
 use URI::Escape;
 $safe = uri_escape(&quot;10% is enough\n&quot;);
  # $safe is &quot;10%25%20is%20enough%0D&quot;;
 $str  = uri_unescape($safe);
  # $str is 10% is enough\n</code></pre>
  
<p>We will want to unescape any data received from the client:</p>

<pre><code>
    if ($request =~ m|^GET /(.+)(?:\?(.*))? HTTP/1.[01]|) {
      my $page = uri_unescape($1);
      my $querystring = uri_unescape($2);</code></pre>




<h3><a name="more_ideas">More Ideas</a></h3>

<p>You might want to embed a Web server into a tool to display the status
of a task in a complicated way.  Sure, you could just write the file
to disk, but that's less fun!</p>

<p>If a task has multiple possible outputs, then you could use the Web server
to allow the user to choose between them visually, or pop up a browser at various states of a project to let the user
confirm that things are going according to plan.</p>

<p>Speaking of popping up, you don't need to make the user do anything to
see the results of the page.  You can force the browser to do it
for you.</p>

<p>On UNIX systems you can use Mozilla/Netscape's 
<a href="http://wp.netscape.com/newsref/std/x-remote.html">X-Remote protocol</a>:</p>

<pre><code>
    system(q[netscape -remote 'openURL(&quot;http://localhost:9000/&quot;)' &amp;]);</code></pre>
	
<p>Our example code has a port number hardcoded into it.  If that port is
already being used on your system, then the IO::Socket::INET::new() call
will fail.  An easy improvement is to loop over a range of ports, or
random port numbers, until an available port is found.</p>


<h3><a name="reusable_code">Reusable Code</a></h3>

<p>In some cases, I've avoided the use of modules in this article.  There
are many things that could be done with modules including argument
handling (CGI.pm), URI/URL parsing (the URI family of modules), and
even the HTTP server itself.  (HTTP::Daemon)</p>

<p>The code we've presented here tries to go through the behind the
scenes process so you know what's going on.</p>

<p>For quick and dirty servers, HTTP::Daemon is probably easier to use.
Here's an example:</p>

<pre><code>
 use HTTP::Daemon;
 use HTTP::Status;
 use Pod::Simple::HTML;
 
 my $file = shift;
 die &quot;File $file not found&quot; unless -e $file;
 
 my $d = HTTP::Daemon-&gt;new || die;
 print &quot;Please contact me at: &lt;URL:&quot;, $d-&gt;url, &quot;&gt;\n&quot;;
 while (my $c = $d-&gt;accept) {
   while (my $r = $c-&gt;get_request) {
     if ($r-&gt;method eq 'GET') {
       my $rs = new HTTP::Response(RC_OK);
       $rs-&gt;content( Pod::Simple::HTML-&gt;filter($file) );
       $c-&gt;send_response($rs);
     } else {
       $c-&gt;send_error(RC_FORBIDDEN)
     }
   }
   $c-&gt;close;
   undef($c);
 }</code></pre>
 
<p>The above HTTP::Daemon based server is a simple, single purpose,
POD-&gt;HTML converter.  I provide it with the name of a pod file to
parse, and every time I reload the page, it will pass it through
Pod::Simple and display the HTML to the browser.</p>

<p>You'll note it has the same structure as our hand-made examples, but
it handles some of the nitty-gritty work for you by encapsulating it
in classes.</p>

<p>(If you think that HTTP::Daemon is much simpler than the original, then you
should see the first version of this article which used the low-level
socket calls.)</p>


<h3><a name="in_conclusion">In Conclusion</a></h3>
<p>Embedded hardware is all the rage these days - but embedded software
can be quite useful, too.  By embedding a Web server into your software
you gain lots of possible output options that were difficult to have
before.  Tables, graphics and color!  (Not to mention, output can be
viewed by multiple computers.)  Embedded Web servers open a world of
opportunities to you.</p>



        </div>



    </div>
    <div class="asset-footer"></div>
</div>


                            
                            <div id="entry-1368" class="entry-asset asset hentry">
    <div class="asset-header">
        <h2 class="asset-name entry-title"><a href="/pub/2002/09/p6pdigest/20020915.html" rel="bookmark">This week on Perl 6 (9/9 - 9/15, 2002)</a></h2>
        <div class="asset-meta">
            <span class="byline">
    
                By <span class="vcard author">Piers Cawley</span> on <abbr class="published" title="2002-09-15T00:00:00-08:00">September 15, 2002 12:00 AM</abbr>
    
            </span>

            
            

        </div>
    </div>
    <div class="asset-content entry-content">

        <div class="asset-body">
            

<p>Happy birthday to me! // Happy birthday to me! // Happy birthday, dear
meeeee! // Happy birthday to me!</p>
<p>And, with a single breech of copyright, Piers was free. The production
of this summary was delayed by my turning 35 on the 15th and then
spending the Monday train journey reading one of my birthday presents
(<em>Dead Air</em> by Iain Banks, it's jolly good) instead of writing a
summary. So this morning, I left the book at home.</p>
<p>So, what's been going on with Perl 6. We'll start, as usual with
perl6-internals.</p>

<h3><a name="goal_call_for_0.0.9">Goal Call for 0.0.9</a></h3>
<p>The week before, Dan had asked for some suggestions as to what should
be the priorities for the 0.0.9 release of Parrot. One of Nicholas
Clark's goals from last week was the 'Careful elimination of all
compiler warnings, particularly on non x86 platforms, and for builds
with nondefault INTVAL size,' and discussions of how to go about
doing this (and indeed some doing) carried on into this week. There
was also some discussion about whether IMCC and the Perl 6 compiler
should be built by default. On the one hand, it would mean that the
tinderboxes were testing those important subsystems, on the other
hand, it was thought that there were some people who wouldn't be
interested in testing those things. Consensus seemed to be that we
should just build and test them anyway.</p>
<p><a href="http://groups.google.com/groups?threadm=3D7D20DC.25243.2E48F2C%40localhost">http://groups.google.com/groups</a></p>

<h3><a name="scheme_implementation_details">Scheme Implementation Details</a></h3>
<p>J&uuml;rgen B&ouml;mmels and Piers Cawley continued their discussion
of how to go about implementing a scheme interpreter, and <code>lambda</code> in
particular. Piers made noises about a proof of concept implementation
of Scheme that he'd made using Perl objects, but didn't show
code. (And, I can exclusively reveal, will not be showing the
original) code owing to badness with backups and lackadaisical use of
CVS). J&uuml;rgen, who had actually made the effort of writing some
code, listened politely and agreed that Piers' suggestions looked like
they might be a way forward. J&uuml;rgen went away and implemented a
first cut at <code>quote</code>, <code>define</code> and <code>set!</code>.</p>
<p><a href="http://groups.google.com/groups?threadm=m2k7lvowtg.fsf%40helium.physik.uni-kl.de">http://groups.google.com/groups</a></p>
<p><a href="http://rt.perl.org/rt2/Ticket/Display.html?id=17109">http://rt.perl.org/rt2/Ticket/Display.html</a></p>

<h3><a name="chr,_ord_etc."><code>chr</code>, <code>ord</code> etc.</a></h3>
<p>Clinton A Pierce restarted this thread and discussed what he'd like to
see (apart from a pony) from Parrot's equivalent of Perl 5's
<code>pack</code>. Clint wondered whether Parrot <code>pack</code> should use a template,
or if it should be implemented as a horde of smaller ops, each
handling a different conversion, so that a single, Perl level call to
pack would become lots of op calls at the parrot level. Clint also
drools at the thought of doing <code>sprintf</code> at the parrot level. Aaron
Sherman agreed with most (all?) of Clint's proposals, and also wants a
pony. (Who doesn't?). Peter Gibbs went so far as to offer a patch
which implemented a subset of pack functionality, and was
applauded. Graham Barr wondered if pack should also allow for packing
to 'native' types, which wouldn't have to worry about
endian issues. Peter thought that would be a good idea. Nicholas
Clark pointed out that extending the code to cope with unsigned
integers would be a good idea, too.</p>
<p><a href="http://groups.google.com/groups?threadm=5.1.0.14.2.20020909211617.00af3a70%40www.geeksalad.org">http://groups.google.com/groups</a></p>

<h3><a name="lexicals">Lexicals</a></h3>
<p>J&uuml;rgen B&ouml;mmels asked a pile of questions about the
implementation of lexical variables and how one could use them to make
a closure. Jonathan Sillito provided a mixture of answers and guesses.
It seems that we're waiting on Dan to firm up some things about
lexicals.</p>
<p><a href="http://groups.google.com/groups?threadm=m2fzwjos4k.fsf%40helium.physik.uni-kl.de">http://groups.google.com/groups</a></p>

<h3><a name="imcc_0.0.9_runs_100%_perl_6_tests_+_various_results">IMCC 0.0.9 Runs 100% Perl 6 Tests + Various Results</a></h3>
<p>Leopold Toetsch has been working on getting IMCC to generate parrot
bytecode directly rather than going through a stage of generating an
intermediate <code>.pasm</code> file, and had been having some problems with
'writing out the .pbc, especially Const_Table, type PFC_KEY /
PARROT_ARG_SC'. Two hours later, he announced that he had all the perl6
tests running successfully within IMCC, but only if GC was turned off
(there are problems with the longer running tests when GC is turned
on). Things get progressively worse as first JIT, and then
Predereferencing are turned on.</p>
<p>Dan wondered what the GC bug could be. Leo wasn't sure but posted
some possible pointers. Peter Gibbs thought that at least one of the
bugs was in <em>continuation.pmc</em> and posted a patch that fixed one of
the problems when running under parrot. Meanwhile, Leo tracked down
the bug to a bit of code that he'd appropriated from <em>debug.c</em>, so he
fixed his IMCC and sent in a patch to fix <em>debug.c</em> as well. Applying
both patches meant that the tests all passed under both IMCC and
parrot.</p>
<p>Dan applied both patches.</p>
<p>Leo later fixed his problem with writing out a .pbc file directly
from IMCC, and offered a patch to <em>packout.c</em> which he described as
ugly, but working.</p>
<p>I think Mr Toetsch is going go get my 'kudos' award for this week as
he later patched things to make the 'predereferenced' run mode work
again (all perl6 tests pass when run with -P). By the way, there
appears to be no reference to 'predereferenced' in the glossary.</p>
<p><a href="http://groups.google.com/groups?threadm=3D7DC62D.8030500%40toetsch.at">http://groups.google.com/groups</a> -- Problem</p>
<p><a href="http://groups.google.com/groups?threadm=3D7DE1A9.9020903%40toetsch.at">http://groups.google.com/groups</a> -- Qualified success</p>
<p><a href="http://rt.perl.org/rt2/Ticket/Display.html?id=17193">http://rt.perl.org/rt2/Ticket/Display.html</a></p>

















<h3><a name="problem_parsing_builtins">Problem Parsing Builtins</a></h3>
<p>Aaron Sherman and others have been torture testing the Perl 6
compiler. The most comprehensive test is the <em>Builtins.p6m</em> file (now
split into several smaller files) that provides prototypes (and a
smaller number of implementations) for Perl 5's built-in functions (we
don't know what Perl 6's builtins will be, so Perl 5 is a good
start). Sadly, right now, the Perl6 compiler can't cope with all the
builtins, so there's been a game of working out which is broken, the
parser or the code. Aaron has posted many short scripts highlighting
problems he's found. My particular 'favorite' is <code>my $x = 1; $x =
+x</code>, sending the compiler off into an infinite recursion. Sean O'Rourke
has added these issues to his queue.</p>

<h3><a name="[rfc]_buildings_core.ops_op_hash_at_runtime">[RFC] buildings core.ops op_hash at runtime</a></h3>
<p>Leopold Toetsch posted a proposal for altering the build system to get
rid of some rather over the top duplication of (generated)
code. Nicholas Clark liked the idea, but I don't believe the patch got
applied -- yet.</p>
<p>Leo also suggested moving the op_info_table out into a separate
file which could be shared by the various <em>core_ops*.c</em> files.</p>
<p><a href="http://groups.google.com/groups?threadm=3D7F1FF4.30108%40toetsch.at">http://groups.google.com/groups</a></p>
<p><a href="http://groups.google.com/groups?threadm=3D7F64E8.5010804%40toetsch.at">http://groups.google.com/groups</a></p>

<h3><a name="imcc_/_mac_os_x_problem">IMCC / Mac OS X problem</a></h3>
<p>Leon Brocard (yay! Still batting 100 percent on this one ...) has been having
problems building IMCC under Mac OS X. The individual .c files all
compile, but bad things happen at link time. Leo, Kevin Falcone and
Andy Dougherty all pitched in and, after a flurry of patches, IMCC is
now building and working correctly under Mac OS X.</p>
<p><a href="http://rt.perl.org/rt2/Ticket/Display.html?id=17159">http://rt.perl.org/rt2/Ticket/Display.html</a></p>

<h3><a name="problems_with_64_bit_integer_builds">Problems with 64-bit integer builds</a></h3>
<p>There have been problems building Parrot on some of the tinderbox
systems, and many boxes are not green. Andy Dougherty had some
thoughts on this, and on how to improve things. Andy's view is that so
many of the tinderboxes are broken, it's hard to tell whether your new
patch is making things better or worse, especially when the rebuilds
can take several hours in some cases. Andy hopes that, once the
majority of boxes are green most of the time, people will take more
notice when one or another turns orange or red. In another thread,
Andy offered a patch that had been a showstopper for some
architectures, which would dump core during config's alignment
detection tests.</p>
<p><a href="http://groups.google.com/groups?threadm=Pine.SOL.4.10.10209121106550.5961-100000%40maxwell.phys.lafayette.edu">http://groups.google.com/groups</a></p>
<p><a href="http://rt.perl.org/rt2/Ticket/Display.html?id=17202">http://rt.perl.org/rt2/Ticket/Display.html</a></p>

<h3><a name="rfc:_how_are_compound_keys_with_a_perlhash_intended_to_work">RFC: How are compound keys with a PerlHash intended to work?</a></h3>
<p>Leopold Toetsch wondered about the handling of compound keys in
PerlHash objects. Dan confirmed that Leo's intuition about this was
right, which was good, because Leo had a patch ready, but he still
wondered about a some additional vtable methods. So he made some more
proposals about how to deal with that case. Dan again agreed with
Leo's analysis, and Leo came up with another patch. Steve Fink
apologized for not having done this already, but his 'tuit shipment was
confiscated due to heightened airport security.' Steve also neatly
summarized the conclusions reached last time this came up.</p>
<p>Meanwhile, Graham Barr wondered where any type checking would
happen. Leo thought it was implicit on lookup and showed code. So did
Dan, but Ken Fox is still unsure.</p>
<p><a href="http://groups.google.com/groups?threadm=3D819911.9090605%40toetsch.at">http://groups.google.com/groups</a></p>
<p><a href="http://rt.perl.org/rt2/Ticket/Display.html?id=17241">http://rt.perl.org/rt2/Ticket/Display.html</a> -- Leo's patch</p>
<p><a href="http://groups.google.com/groups?threadm=20020915092722.A12297%40pobox.com">http://groups.google.com/groups</a></p>


<h2><a name="meanwhile,_in_perl6language">Meanwhile, in perl6-language</a></h2>
<p>The week before, Erik Steven Harrison had wondered what counted as a
runtime property, apart from <code>true</code> and <code>false</code>. This week, Damian
popped up with a list of 10 off the top of his head. <code>return 255 but
undef;</code>, or <code>$name = &quot;Damian&quot; but We_better_call_ya(&quot;Bruce&quot;)</code> anyone?</p>
<p><a href="http://groups.google.com/groups?threadm=3D7C474C.2000307%40conway.org">http://groups.google.com/groups</a></p>

<h3><a name="second_try:_builtins">Second Try: Builtins</a></h3>
<p>Aaron Sherman's efforts at producing an initial builtins list for Perl
6 got discussed on the language list as well. Chuck Kulchar had
wondered how well, if at all, they worked with the current perl6
compiler (they don't... yet), and why they were written in Perl. Aaron
Sherman posted his reasons (maintainability, maintainability and
maintainability). Nicholas Clark argued that Parrot code wasn't
necessarily hard to maintain, and also made the case for implementing
some functionality in C. Aaron thought that, eventually, they're be a
mix of different implementation languages, with many of the 'munge
args, call equivalent library function' type functions moved out into
libraries anyway.</p>
<p><a href="http://groups.google.com/groups?threadm=1031607402.1761.243.camel%40put">http://groups.google.com/groups</a></p>

<h3><a name="more_a5/e5_questions">More A5/E5 Questions</a></h3>
<p>Discussions of the Perl 6 rules system rolled on. David Helgason had
worries about hypothetical variables but keys in a hash and should not
therefore have sigils in their names at all. Damian pointed out that
<em>all</em> Perl 6 variables were just keys in a hash. David wondered
about the difference between binding a value to a variable in a
containing scope and just binding to an entry in the match object
(Damian and Allison apparently have a really neat idea for this, but
it's not yet had the Larry stamp of approval). David's last worry was
that <code>$0</code> was a rather cryptic name for the match object and
shouldn't it have a meaningful name like <code>$MATCH</code> (Damian thought
that squashing a cryptic name in favor of an arbitrary one wasn't
necessarily a win.</p>
<p>Jonathan Scott Duff had wondered (in off list mail to Damian, but
Damian answered in public) how he could tell <code>^^</code> and <code>$$</code> only to
match just after and before his platform specific newline
sequence. Damian thought that suggested rolling ones own <code>&lt;sol&gt;</code>
and <code>&lt;eol&gt;</code> rules. Jonathan had also wondered about some of the
the binding semantics of nested rules. Damian's answer gave him an
appropriate 'ah! yes!' moment.</p>
<p>Aaron Sherman had another question about rules and kicked off the
'Throwing lexicals' (Weren't they a band?) by wondering 'How do rules
create hypotheticals?' Everyone passed up the chance to do a 'Well, a
mummy rule, and a daddy rule, who are very much in love...'
joke, leaving it to the summary writer.</p>
<p>I confess, I'm not sure I understand Aaron's concern (about what to do
when you assign to a hypothetical that doesn't exist in a containing
scope. I thought you just bound to an appropriately named key in the
current match object), which makes things a tad tricky, but Luke
Palmer seemed to understand and wondered if there would be some way of
declaring that a given hypothetical <em>wouldn't</em> infect its containing
scope(s). Damian popped up again, promising that, once Larry had made
a decision, he would be unveiling one of the solutions that he and
Allison have cooked up.</p>
<p><a href="http://groups.google.com/groups?threadm=200209091032.g89AWMA25902%40backup.dht.dk">http://groups.google.com/groups</a></p>
<p><a href="http://groups.google.com/groups?threadm=20020909115113.A519%40cbi.tamucc.edu">http://groups.google.com/groups</a></p>
<p><a href="http://groups.google.com/groups?threadm=1031369519.6415.366.camel%40put">http://groups.google.com/groups</a></p>
















<h3><a name="blocks_and_semicolons">Blocks and Semicolons</a></h3>
<p>Piers Cawley wondered about blocks, statements and when they need
terminating semicolons, and kicked off a long thread. To be honest,
I'm not sure it really went anywhere, but we covered a lot of
ground. The confusion arises, I think, because the design of Perl6 has
moved (rather substantially in places) from the design described in
some of the earlier apocalypses and exegeses. Questions like 'is
<code>when</code> a statement, or just a clever function?', 'has Larry changed
his mind about no special cases for blocks?' and others would appear
to be standing in need of some definitive answers. These will, of
course be forthcoming, if only in Perl6's final grammar, but we're an
impatient lot.</p>
<p><a href="http://groups.google.com/groups?threadm=84hegxvufx.fsf%40despairon.bofh.org.uk">http://groups.google.com/groups</a></p>

<h3><a name="xs_in_perl_6">XS in Perl 6</a></h3>
<p>Aaron Sherman had a few thoughts about XS (well, whatever is going to
replace it in Perl 6 and Parrot anyway) which he shared with the
list. Essentially his proposals covered ways in which modules that are
partially implemented in other languages could be cleanly declared and
prototyped using Perl syntax rather than the current method involving
XS, which looks like no other language on ghod's green earth. Brent
Dax proposed a slightly different syntax, using a <code>returns</code> property
(<code>sub foo is returns(...)</code>? Don't you love grammar?). The thread got
rather long as Brent and Aaron discussed things back and forth, with
Nicholas Clark interjecting at one point to draw the participants
attention to the fact that they seemed to be on the verge of
reinventing Inline::C. Tim Bunch suggested that we 'should be thinking
about the forward declaration syntax and semantics for using existing
libraries at this stage.  [He suspects] that it'll then become clear
how to add extra code in a simple and natural way.'</p>
<p>Tim also pitched in with a long quote from Larry about his goals for
the Perl 6 extension mechanism.</p>
<p>David Whipp wondered whether we shouldn't actually be thinking about
<em>Parrot's</em> XS replacement rather than Perl 6's. Aaron thought not,
because even when parrot's extension model was fully specced out, we
still need to worry about how that interacts with Perl at a language
level. Dan Sugalski disagreed with Aaron, pointing out that Perl 6 XS
isn't due to be dealt with until Apocalypse 21. Aaron wondered whether
this <em>really</em> meant we'd be waiting for '16 more Apocalypses before
we write code that allows <code>chdir()</code> to call the C library function?'
Dan thought Aaron was worrying unduly and pointed out that <code>chdir</code>
is, or will be, a Parrot opcode. Aaron responded to this by stepping
back and defining some useful terms and stated his current position in
those terms. And then the week ended.</p>
<p>This one could run and run. Tune in next week for the exciting
continuation. (Ooh, we haven't done continuations recently have we?)</p>
<p><a href="http://groups.google.com/groups?threadm=1031866595.22407.528.camel%40put">http://groups.google.com/groups</a></p>
<p><a href="http://groups.google.com/groups?threadm=20020914131836.GB285%40Bagpuss.unfortu.net">http://groups.google.com/groups</a></p>
<p><a href="http://groups.google.com/groups?threadm=20020913225105.GF539%40dansat.data-plan.com">http://groups.google.com/groups</a></p>
<p><a href="http://groups.google.com/groups?threadm=1032126251.5291.83.camel%40put">http://groups.google.com/groups</a></p>

<h3><a name="passing_arguments">Passing Arguments</a></h3>
<p>In a subthread of the 'blocks and semicolons' thread, Aaron Sherman
wondered about passing arguments. Aaron listed five different forms 
and wondered about how one would mix up the different styles. Luke
Palmer and Brent Dax both wondered what made one of his special cases
a special case. Again, it looks like the whole area of prototypes
could use some cleaning up (but then we're currently working on clues
from other design documents; hopefully the upcoming Apocalypse 6 will
clear up many of these issues).</p>
<p><a href="http://groups.google.com/groups?threadm=1031950173.1575.559.camel%40put">http://groups.google.com/groups</a></p>


<h2><a name="in_brief">In Brief</a></h2>
<p>Steve Fink committed his IntList patch, and Josef H&ouml;&ouml;k
queried the creation of an <em>intlist.c</em> file in the Parrot core, as his
matrix patch had been rejected for doing something similar. Nobody has
responded to this yet.</p>
<p>Ramesh Ananthakrishnan wondered whether compiling C down to Parrot
would be a useful thing to do, as a way of magically porting useful
stuff that was already written in C. Aaron Sherman thought that it
wouldn't be useful as a 'magic porting' tool, as that would be better
done by linking to existing C libraries, and that for small fragments,
a manual conversion would probably be better anyway.</p>
<p>Ramesh (or should that be Ananthakrishnan) also wondered whether it is
possible to write networking code in Parrot. Answer: Not yet, but a
Sockets extension is probably get written at some point.</p>
<p>Andy Dougherty patched the build's link order to take traditional,
order dependent, linkers into account.</p>
<p>Jerome Quelin fixed Befunge (though, with a language like that, how
anyone could tell it's broken is a mystery) to use the new <code>chr</code>
opcode.</p>
<p>Dan Sugalski turned 35 on the 12th. I turned 35 on the 15th. Did I
miss anyone else's birthday?</p>
<p>Leopold Toetsch patched <code>Parrot_vsprintf_s</code> and after prompting
supplied a test that failed without the patch in place. (Remember
boys and girls, if you're offering a patch that fixes a bug, make sure
you also supply a test that shows up the bug.)</p>
<p>Jeff Forr wanted to declare next (this) week to be a week of
bug hunting, but Nicholas Clark pointed out that this clashed with
YAPC::Europe and maybe it was better to make the week after a
bug hunt. Jeff agreed.</p>

















<h2><a name="the_perl_6_mini_conference_in_zurich">The Perl 6 Mini Conference in Zurich</a></h2>
<p>Also going on last week was a Perl 6 mini conference, held in
Zurich. Larry, Damian, Dan, Allison and Hugo all gathered to sit around
a table and thrash out some more of the Perl 6 design. I assume that
whiteboards were also available. As well as doing design work, there
was a mini conference, complete with talks from all of the above, and
due to time and money commitments I couldn't make it. However, Paul
Johnson could, and he wrote me a report, which I present here pretty
much unedited.</p>

<h3><a name="a_report,_by_paul_johnson">A Report, by Paul Johnson</a></h3>
<p>Last week, Perl 6 moved to Z&uuml;rich.  The bulk of the Perl 6 design team
was here as guests of ETH, and spent the week, er, designing Perl 6 I
suppose.  But maybe they were out exploring Z&uuml;rich and its environs.  If
they were, who can blame them?  If they weren't, well they'll just have
to came back another time :-)</p>
<p>On Thursday and Friday they also managed to fit in a Mini::Conference on
Perl 6.  In attendance were Larry Wall, with his wife, Gloria, Damian
Conway, Dan Sugalski, Allison Randall and Hugo van der Sanden.</p>
<p>We were treated to two days of talks and discussion about Perl 6.  Larry
Wall gave the keynote speech to start the conference.  As always,
Larry's talk was interesting and entertaining.  The scheduled topic was
"Studies in the Ballistic Arts", however, Larry said that this title was
prepared before the talk itself, and the talk, along with the title,
morphed into one about the Science of Perl.  This will be heard again at
YAPC::E in a few days, and so I won't spoil it by attempting to
summarise it here.</p>
<p>Next up was Damian Conway, who gave his presentation entitled
"Introduction to Perl 6", covering the first five Apocalypses.  Damian
has managed to acquire quite a reputation within the Perl community, and
Larry promised that Damian would be more entertaining than he.  That was
quite a promise, but I don't think anyone was disappointed.  Damian in
turn promised that Dan, speaking next, would be more entertaining than
he.  I think Dan was probably too busy to notice, checking in some
patches or redoing the GC or something.</p>
<p>Damian noted that the audience was probably more sympathetic than most
he gave the presentation to, given that they had come to a two day
conference devoted to Perl 6.  There were nonetheless a number of people
who were worried about the move to Perl 6, and one who was still worried
about moving to Perl 5!  I think that most of Damian's jokes flew high
over the heads of most people, but I appreciated them at least.  I
suppose that XXXX (4x) hasn't made it to Switzerland.  And maybe
Crocodile Dundee wasn't such a big hit.  Even Switzerland's joining of
the UN two days earlier seemed to go unnoticed, although it is UNO here.
I think there were a few Java programmers in the audience too, since
when Damian mentioned about Java having a HelloWorld library about half
the audience laughed and half seemed a little concerned that they hadn't
heard of it before.  And the suggestion that Archbishop Tutu might not
like being interpolated was entirely missed.  (Should we interpolate $to
too?) Still, had the jokes been in German, they'd have flown right past
me instead.  And I trust Damian's German accent will stay in place
should he have occasion to talk about B&amp;D languages in Munich.</p>
<p>Unsurprisingly, Dan spoke about "The Parrot Virtual Machine".  Dan
actually gave two presentations back to back.  The first was an overview
of Parrot, and the second was a more detailed look at parts of it.  This
was a very interesting look at the fast moving world of perl6-internals
and seemed to be well received by a knowledgeable audience.</p>
<p>The second day started with a presentation by Allison Randall entitled
"Linguistic Basis of Perl 6".  Every so often, in perl6-language in
particular, some discussion about linguistics crops up, often referring
to tagmemics.  Allison explained to us what a tagmeme is, and how it
relates to the design of Perl 6.  I won't pretend to understand it all,
but apparently tagmemics is the Swiss Army Knife of linguistics, a
tagmeme is a unit in context, tagmemes are fractal, and both "etic" and
"emic" are real words, protestations of my spell checker to the contrary
notwithstanding.  I understand that Allison gave this talk at TPC and
will also give it at YAPC::E, so soon we'll all understand tagmemic
matrices and be perfectly happy to get dropped off into some uncharted
jungle.</p>
<p>Following Allison's presentation there were questions about some minor
syntactic issues such as why the switch statement used "given" and
"when" instead of "switch" and "case".  The explanation of how nicely it
read in English was countered with arguments that that wouldn't benefit
the German speakers so much and that "switch" and "case" were probably
already familiar to programmers.  Damian suggested that maybe a German
Perl grammar would be in order, to which the inevitable response was
that a Swiss German grammar was really required, but which dialect would
it be in?  Damian showed how easy it would be to derive your own Perl
grammar and change keywords if you didn't like them.  This was also
useful to the chap who wanted elsif spelt correctly.</p>
<p>Damian's second presentation was "Programming in Perl 6" in which he
took a number of real Perl 5 programs written and regularly used by
prominent members of the Perl community, and he changed them into Perl
6.  He did this twice, first to produce a minimal delta change and
second to produce idiomatic Perl 6, at least insofar as Perl 6 has
managed to acquire idioms.  Both of Damian's presentations were
punctuated with questions to Larry, asking if what Damian had just
presented was true this week too.  In some cases the language design
seemed to be taking place before our eyes.</p>
<p>This presentation seemed to allay a lot of fears and everyone seemed
quite happy with Perl 6 to the extent that Damian finished half an hour
early.  The option was a long lunch or Damian offered to give his
Lingua::Romana::Perligata presentation.  I don't think there was ever
any doubt, but when Larry mentioned that he had never heard that talk it
was decided.  The talk is normally two hours long, but Damian managed to
squeeze it into 45 minutes.  I think this was probably aided in part by
most people simultaneously missing the jokes and being comfortable with
a language which requires the matching of number, case and gender.  I
suspect this is the opposite from most native English speaking
audiences.</p>
<p>Finally Hugo was here representing the face of sanity.  He told us of
his plans for Perl 5.10.  These included making perl clean, small and
fast.  To this end he intends to rewrite parts of the regular expression
engine, to oversee the creation of a scheme whereby there are multiple
blessed perl installations, and to claw back some of the speed that has
been lost since version 5 was released.  In short, to ensure that making
Perl 6 better, faster and stronger than Perl 5 is as difficult as
possible.</p>
<p>Last on the agenda was a question and answer session with the entire
team.  This was especially interesting, in part I think because there
was not an enormous number of questions.  This allowed the answers to be
complete, to the point of verging on rambling.  That's not a bad thing,
because it let us get past the superficial answers and into more
philosophical areas.  Dan told us why Parrot was called Parrot.  Larry
told us why Perl was called Perl, what it stood for and when, and why it
was perfect for search engines even before there were search engines.
Dan told us not to get worried about everything, after all, it's only
ones and zeros.  Damian and Dan alluded to interesting things they could
tell us, but then they would have to shoot us.  Larry speculated on
whether placing a time bomb in the perl interpreter would help us find
out who is using Perl and for what.  Larry and Damian told us some scary
things that people do with Perl and Larry told us he flew over here in
one of them.  Larry also told us the secret of leadership (which is at
least 2000 years old), and talked about how well his goal for the
community's rewrite of the community is working.  And there was a bunch
of other stuff that I was far too busy enjoying to make notes about.</p>
<p>All in all, it was a thoroughly enjoyable and informative couple of
days.  Many thanks to ETH Z&uuml;rich and in particular to David Schweikert
for organising the event.  Attendance was about 90, and profits, which
look to be around CHF 4000 or so go the the Perl Foundation.  Next stop:
M&uuml;nich.</p>

















<h2><a name="who's_who_in_perl_6">Who's Who in Perl 6</a></h2>
<p>You lucky people, last week you got Dan, this week it's Damian. Next
week, the World! Bwah hah hah ha! Ahem. Without further ado:</p>
<dl>
<dt><strong><a name="item_who_are_you%3f">Who are you?</a></strong><br />
</dt>
<dd>
Damian Conway
</dd>

<dt><strong><a name="item_what_do_you_do_for_perl_6%3f">What do you do for Perl 6?</a></strong><br />
</dt>
</dl>
<ul>
<li><strong><a name="item_i_help_larry_with_the_design_of_the_language_synta">I help Larry with the design of the language syntax and semantics.</a></strong><br />
</li>
<li><strong><a name="item_exegeses">I write the Exegeses (which explicate Larry's Apocalyptic designs).</a></strong><br />
</li>
<li><strong><a name="item_i_create_perl_5_modules_to_prototype_and_demonstra">I create Perl 5 modules to prototype and demonstrate Perl 6 features.</a></strong><br />
</li>
<li><strong><a name="item_i_roam_the_worlds_%2d%2d_both_real_and_virtual_%2d">I roam the worlds -- both real and virtual -- explaining Perl
6.</a></strong><br />
</li>
</ul>
<dl>
<dt><strong><a name="item_where_are_you_coming_from%3f">Where are you coming from?</a></strong><br />
</dt>
<dd>
Two years of electrical engineering degree, four years of computer
science degree, six years of Ph.D research, eight years of designing
programming languages, two decades of teaching programming, an abiding
interest in human-computer interaction, a deep scepticism of
formal/theoretical solutions to practical problems, an abiding belief
that computers and languages were meant to serve humans not vice-versa,
and the overriding axiom that simpler is better (or, at least, simpler).
</dd>

<dt><strong><a name="item_when_do_you_think_perl_6_will_be_released%3f">When do you think Perl 6 will be released?</a></strong><br />
</dt>
<dd>
By Christmas.
</dd>

<dt><strong><a name="item_why_are_you_doing_this%3f">Why are you doing this?</a></strong><br />
</dt>
<dd>
I'd been doing language design for the better part of a decade before I
started using Perl. So when the opportunity arose to work on my favourite
language and collaborate with such an extraordinarily talented team of
people, how could I possibly resist?
</dd>

<dt><strong><a name="item_you_have_17_syllables%2e_describe_yourself%2e">You have 17 syllables. Describe yourself.</a></strong><br />
</dt>
<dd>
<pre>
       Out of the torrent
    an excited voice describes
       the passing wonders.</pre>
</dd>
<dt><strong><a name="item_do_you_have_anything_to_declare%3f">Do you have anything to declare?</a></strong><br />
</dt>
<dd>
You're kidding, right? <em>How</em> many hours do you have?
</dd>
</dl>


<h2><a name="acknowledgements_etc.">Acknowledgements etc.</a></h2>
<p>You may have noticed that I'm a little late mailing out the summary 
this week (though if you read this at www.perl.com you're probably
wondering what I'm on about). Things have been hectic, and I really
can't type or think fast enough. Normal service will hopefully be
resumed this week.</p>
<p>Thanks are due to Damian for making the time to answer the
questionnaire, even if he did cheat on the 'five words'
question. Thanks are also due to everyone who has taken the time to
send me answers over the weeks, apologies for not thanking you
immediately. As usual, if you're involved on either of the main Perl 6
development lists, please consider answering the questions and sending
your answers to <em><a href="mailto:mailto:5Ws@bofh.org.uk">mailto:5Ws@bofh.org.uk</a></em>. I'm running low on answers,
and I'd really like to see responses from (among others) Leopold
Toetsch, Steve Fink, Brent Dax, and Jeff Goff. I don't <em>care</em> if
you've already answered Bryan Warnock's questions, it's a different
summary now.</p>
<p>Thanks too to the crack team of proofreaders from the rhizomatic.net
irc server who will hopefully have whipped my grammar into shape by
the time I think 'I really should get my finger out and post this.'</p>
<p>As usual, if you think that this summary has value, please consider
sending money to the Perl Foundation
<a href="http://donate.perl-foundation.org">http://donate.perl-foundation.org</a> and help to support the ongoing
development of Perl. The O'Reilly Network will, as usual, be paying my
publication fee for this article directly to the Perl Foundation. If
you didn't like the summary, then write your own; different viewpoints are
always welcome.</p>
<p>If you want to reward me directly, well, iBooks are always nice (but
I'd be <em>so</em> embarrassed if I received one), but so is
feedback. Let me know what you think.</p>

        </div>



    </div>
    <div class="asset-footer"></div>
</div>


                            
                            <div id="entry-1358" class="entry-asset asset hentry">
    <div class="asset-header">
        <h2 class="asset-name entry-title"><a href="/pub/2002/09/11/log4perl.html" rel="bookmark">Retire your debugger, log smartly with Log::Log4perl!</a></h2>
        <div class="asset-meta">
            <span class="byline">
    
                By <span class="vcard author">Michael Schilli</span> on <abbr class="published" title="2002-09-11T00:00:00-08:00">September 11, 2002 12:00 AM</abbr>
    
            </span>

            
            

        </div>
    </div>
    <div class="asset-content entry-content">

        <div class="asset-body">
            <p>You've rolled out an application and it produces mysterious, sporadic
errors? That's pretty common, even if fairly well-tested applications are
exposed to real-world data. How can you track down when and where exactly
your problem occurs? What kind of user data is it caused by? A debugger
won't help you there.</p>

<p>And you don't want to keep track of only <em>bad</em> cases. It's helpful to log all types of
meaningful incidents while your system is running in production, in order
to extract statistical data from your logs later. Or, what if a problem
only happens after a certain sequence of 'good' cases? Especially in
dynamic environments like the Web, anything can happen at any time and you
want a footprint of every event later, when you're counting the corpses.</p>

<p>What you need is well-architected <em>logging</em>: Log statements in your code and a logging package like <code>Log::Log4perl</code> providing a "remote-control," which allows you to turn on previously inactive
logging statements, increase or decrease their verbosity independently in
different parts of the system, or turn them back off entirely. Certainly
without touching your system's code -- and even <em>without restarting</em> it.</p>

<p>However, with traditional logging systems, the amount of data written to
the logs can be overwhelming. In fact, turning on low-level-logging on a
system under heavy load can cause it to slow down to a crawl or even crash.</p>

<p><code>Log::Log4perl</code> is different. It is a pure Perl port of the widely popular Apache/Jakarta <code>log4j</code> library [3] for Java, a project made public in 1999, which has been
actively supported and enhanced by a team around head honcho <em>Ceki
G&uuml;lc&uuml;</em> during the years.</p>

<p>The comforting facts about <code>log4j</code> are that it's really well thought out, it's the alternative logging
standard for Java and it's been in use for years with numerous projects. If
you don't like Java, then don't worry, you're not alone -- the <code>Log::Log4perl</code> authors (yours truly among them) are all Perl <em>hardliners</em>
who made sure <code>Log::Log4perl</code> is <em>real</em> Perl.</p>

<p>In the spirit of <code>log4j</code>, <code>Log::Log4perl</code> addresses the shortcomings of typical ad-hoc or homegrown logging systems
by providing three mechanisms to control the amount of data being
logged and where it ends up at:</p>

<ul>

<li><em>Levels</em> allow you to specify the <em>priority</em> of log messages. Low-priority messages are suppressed when the
system's setting allows for only higher-priority messages.</li>

<li><em>Categories</em> define which parts of the system you want to enable logging in. Category
inheritance allows you to elegantly reuse and override previously defined
settings of different parts in the category hierarchy.</li>

<li><em>Appenders</em> allow you to choose which output devices the log data is being written to, once
it clears the previously listed hurdles. </li>

</ul>

<p>In combination, these three control mechanisms turn out to be very
powerful. They allow you to control the logging behavior of even the most
complex applications at a granular level. However, it takes time to get
used to the concept, so let's start the easy way:</p>

<h3><a name="Getting_your_feet_wet_with_Log4p">Getting Your Feet Wet With Log4perl</a></h3>

<p>If you've used logging before, then you're probably familiar with logging
priorities or <em>levels</em> . Each log incident is assigned a level. If this incident level is higher
than the system's logging level setting (typically initialized at system
startup), then the message is logged, otherwise it is suppressed.</p>

<p><code>Log::Log4perl</code> defines five logging levels, listed here from low to high:</p>

<pre><code>
    DEBUG
    INFO
    WARN
    ERROR
    FATAL</code></pre>

<p>Let's assume that you decide at system startup that only messages of level
WARN and higher are supposed to make it through. If your code then contains
a log statement with priority DEBUG, then it won't ever be executed. However, if
you choose at some point to bump up the amount of detail, then you can just set
your system's logging priority to DEBUG and you will see these DEBUG
messages starting to show up in your logs, too.</p>

<p>Listing <code>drink.pl</code> shows an example. <code>Log::Log4perl</code> is called with the
<code>qw(:easy)</code> target to provide a beginner's interface for us. We initialize the logging
system with <code>easy_init($ERROR)</code>, telling it to suppress all messages except those marked <code>ERROR</code> and higher (<code>ERROR</code> and
<code>FATAL</code> that is). In easy mode, <code>Log::Log4perl</code> exports the scalars
<code>$DEBUG</code>, <code>$INFO</code> etc. to allow the user to easily specify the desired priority.</p>

<h4>Listing 1: drink.pl</h4>

<pre><code>
    01 use Log::Log4perl qw(:easy);
    02
    03 Log::Log4perl-&gt;easy_init($ERROR);
    04
    05 drink();
    06 drink("Soda");
    07
    08 sub drink {
    09     my($what) = @_;
    10
    11     my $logger = get_logger();
    12
    13     if(defined $what) {
    14         $logger-&gt;info("Drinking ", $what);
    15     } else {
    16         $logger-&gt;error("No drink defined");
    17     }
    18 }</code></pre>

<p><code>drink.pl</code> defines a function, <code>drink()</code>, which takes a beverage as an argument and complains if it didn't get one.
In the <code>Log::Log4perl</code> world, logger <em>objects</em> do the work. They can be obtained by the <code>get_logger()</code>
function, returning a reference to them. </p>

<p>There's no need to pass around logger references between your system's
functions. This effectively avoids cluttering up your beautifully crafted
functions/methods with parameters unrelated to your implementation.
<code>get_logger()</code> can be called by <em>every</em> function/method directly with little overhead in order to obtain a
logger. <code>get_logger</code> makes sure that no new object is created unnecessarily. In most cases, it
will just cheaply return a reference to an already existing object
(singleton mechanism).</p>

<p>The logger obtained by <code>get_logger()</code> (also exported by
<code>Log::Log4perl</code> in <code>:easy</code> mode) can then be used to trigger logging incidents using the following
methods, each taking one or more messages, which they just concatenate when
it comes to printing them:</p>

<pre><code>    $logger-&gt;debug($message, ...);
    $logger-&gt;info($message, ...);
    $logger-&gt;warn($message, ...);
    $logger-&gt;error($message, ...);
    $logger-&gt;fatal($message, ...);</code></pre>

<p>The method names are corresponding with messages priorities:
<code>debug()</code> logs with level <code>DEBUG</code>, <code>info</code> with <code>INFO</code> and so forth. You might think that five levels are not enough to effectively
block the clutter and let through what you actually need. But before
screaming for more, read on. <code>Log::Log4perl</code> has different, more powerful mechanisms to control the amount of output
you're generating.</p>

<p><code>drink.pl</code> uses <code>$logger-&gt;error()</code> to log an error if a parameter is missing and <code>$logger-&gt;info()</code> to tell what it's doing in case everything's OK. In <code>:easy</code> mode, log messages are just written to STDERR, so the output we'll see from <code>drink.pl</code> will be: </p>

<pre><code>    2002/08/04 11:43:09 ERROR&gt; drink.pl:16 main::drink - No drink defined</code></pre>

<p>Along with the current date and time, this informs us that in line 16 of
<code>drink.pl</code>, inside the function <code>main::drink()</code>, a message of priority ERROR was submitted to the log system. Why isn't
there a another message for the second call to <code>drink()</code>, which provides the beverage as required? Right, we've set the system's
logging priority to
<code>ERROR</code>, so <code>INFO</code>-messages are being suppressed. Let's correct that and change line 3 in <code>drink.pl</code> to: </p>

<pre><code>    Log::Log4perl-&gt;easy_init($INFO);</code></pre>

<p>This time, both messages make it through:</p>

<pre><code>    2002/08/04 11:44:59 ERROR&gt; drink.pl:14 main::drink - No drink defined
    2002/08/04 11:44:59 INFO&gt; drink.pl:16 main::drink - Drinking Soda</code></pre>

<p>Also, please note that the <code>info()</code> function was called with two arguments but just concatenated them to form a
single message string.</p>

<h3><a name="Moving_on_to_the_big_leagues">Moving On to the Big Leagues</a></h3>

<p>The <code>:easy</code> target brings beginners up to speed with
<code>Log::Log4perl</code> quickly. But what if you don't want to log your messages solely to STDERR,
but to a logfile, to a database or simply STDOUT instead? Or, if you'd like
to enable or disable logging in certain parts of your system independently?
Let's talk about categories and appenders for a second.</p>

<h3><a name="Logger_Categories">Logger Categories</a></h3>

<p>In <code>Log::Log4perl</code>, every logger has a category assigned to it. Logger Categories are a way
of identifying loggers in different parts of the system in order to change
their behavior from a central point, typically in the system startup
section or a configuration file.</p>

<p>Every logger has has its place in the logger hierarchy. Typically, this
hierarchy resembles the class hierarchy of the system. So if your system
defines a class hierarchy <code>Groceries</code>, <code>Groceries::Food</code> and <code>Groceries::Drinks</code>, then chances are that your loggers follow the same scheme.</p>

<p>To obtain a logger that belongs to a certain part of the hierarchy, just
call <code>get_logger</code> with a string specifying the category:</p>

<pre><code>    ######### System initialization section ###
    use Log::Log4perl qw(get_logger :levels);

    my $food_logger = get_logger(&quot;Groceries::Food&quot;);
    $food_logger-&gt;level($INFO);</code></pre>

<p>This snippet is from the initialization section of the system. It defines
the logger for the category <code>Groceries::Food</code> and sets its priority to <code>INFO</code> with the <code>level()</code> method.</p>

<p>Without the <code>:easy</code> target, we have to pass the arguments <code>get_logger</code> and <code>:levels</code> to <code>use Log::Log4perl</code> in order to get the <code>get_logger</code> function and the level scalars (<code>$DEBUG</code>, <code>$INFO</code>, etc.) imported to our program.</p>

<p>Later, most likely inside functions or methods in a package called <code>Groceries::Food</code>, you'll want to obtain the logger instance and send messages to it. Here's
two methods, <code>new()</code> and <code>consume()</code>,
that both grab the (yes, one) instance of the <code>Groceries::Food</code> logger in order to let the user know what's going on:</p>

<pre><code>    ######### Application section #############
    package Groceries::Food;

    use Log::Log4perl qw(get_logger);

    sub new {
        my($class, $what) = @_;

        my $logger = get_logger(&quot;Groceries::Food&quot;);

        if(defined $what) {
            $logger-&gt;debug(&quot;New food: $what&quot;);
            return bless { what =&gt; $what }, $class;
        }

        $logger-&gt;error(&quot;No food defined&quot;);
        return undef;
    }

    sub consume {
        my($self) = @_;

        my $logger = get_logger(&quot;Groceries::Food&quot;);
        $logger-&gt;info(&quot;Eating $self-&gt;{what}&quot;);
    }</code></pre>

<p>Since we've defined the <code>Groceries::Food</code> logger earlier to carry priority <code>$INFO</code>, all messages of priority <code>INFO</code> and higher are going to be logged, but <code>DEBUG</code> messages won't make it through -- at least not in the <code>Groceries::Food</code> part of the system.</p>

<p>So do you have to initialize loggers for all possible classes of your
system? Fortunately, <code>Log::Log4perl</code> uses inheritance to make it easy to specify the behavior of entire armies
of loggers. In the above case, we could have just said:</p>

<pre><code>    ######### System initialization section ###
    use Log::Log4perl qw(get_logger :levels);

    my $food_logger = get_logger(&quot;Groceries&quot;);
    $food_logger-&gt;level($INFO);</code></pre>

<p>and not only the logger defined with category <code>Groceries</code> would carry the priority <code>INFO</code>, but also all of its descendants -- loggers defined with categories <code>Groceries::Food</code>, <code>Groceries::Drinks::Beer</code> and all of their subloggers will inherit the level setting from the <code>Groceries</code>
parent logger (see figure 1).</p>

<table border="0" cellpadding="2" cellspacing="2">
<tr>
<td width="475"><img src="/pub/2002/09/11/graphics/levels.gif" width="475" height="302" alt="Figure 1" /></td>
</tr>
<tr>
<span class="secondary">
<td><strong>Figure 1: Explicitly set vs. inherited priorities</strong></td>
</span>
</tr>
</table>

<p>Of course, any child logger can choose to override the parent's <code>level()</code> setting -- in this case the child's setting takes priority. We'll talk
about typical use cases shortly.</p>

<p>At the top of the logger hierarchy sits the so-called <em>root logger</em>, which doesn't have a name. This is what we've used earlier with the
<code>:easy</code> target: It initializes the root logger that we will retrieve later via <code>get_logger()</code> (without arguments). By the way, nobody forces you to name your logger
categories after your system's class hierarchy. But if you're developing a
system in object-oriented style, then using the class hierarchy is usually the
best choice. Think about the people taking over your code one day: The
class hierarchy is probably what they know up front, so it's easy for
them to tune the logging to their needs.</p>

<p>Let's summarize: Every logger belongs to a category, which is either the
root category or one of its direct or indirect descendants. A category can
have several children but only one parent, except the root category, which
doesn't have a parent. In the system's initialization section, loggers can
define their priority using the <code>level()</code> method and one of the scalars <code>$DEBUG</code>, <code>$INFO</code>, etc. which can be imported from
<code>Log::Log4perl</code> using the <code>:levels</code> target.</p>

<p>While loggers <em>must</em> be assigned to a category, they may choose <em>not</em>
to set a <em>level</em>. If their <em>actual</em> level isn't set, then they inherit the level of the first parent or ancestor
with a defined level. This will be their <em>effective</em> priority. At the top of the category hierarchy resides the <em>root logger</em>, which always carries a default priority of
<code>DEBUG</code>. If no one else defines a priority, then all unprioritized loggers inherit
their priority from the root logger.</p>

<p>Categories allow you to modify the effective priorities of all your loggers
in the system from a central location. With a few commands in the system
initialization section (or, as we will see soon, in a
<code>Log::Log4perl</code> configuration file), you can remote-control low-level debugging in a small
system component without changing any code. Category inheritance enables
you to modify larger parts of the system with just a few keystrokes.</p>

<h3><a name="Appenders">Appenders</a></h3>

<p>But just a logger with a priority assigned to it won't log your message
anywhere. This is what
<em>appenders</em> are for. Every logger (including the root logger) can have one or more
appenders attached to them, objects, that take care of sending messages
without further ado to output devices like the screen, files or the syslog
daemon. Once a logger has decided to fire off a message because the
incident's effective priority is higher or equal than the logger level, <em>all</em> appenders attached to this logger will receive the message -- in order to
forward it to each appender's area of expertise.</p>

<p>Moreover, and this is <em>very</em> important, <code>Log::Log4perl</code> will walk up the hierarchy and forward the message to every appender
attached to one of the logger's parents or ancestors.</p>

<p><code>Log::Log4perl</code> makes use of all appenders defined in the <code>Log::Dispatch</code>
namespace, a separate set of modules, created by <em>Dave Rolsky</em> and others, all freely available on CPAN. There's appenders to write to the
screen (<code>Log::Dispatch::Screen</code>), to a file (<code>Log::Dispatch::File</code>), to a database (<code>Log::Dispatch::DBI</code>), to send messages via e-mail (<code>Log::Dispatch::Email</code>), and many more.</p>

<p>New appenders are defined using the <code>Log::Log4perl::Appender</code> class. The exact number and types of parameters required depends on the
type of appender used, here's the syntax for one of the most common ones,
the logfile appender, which appends its messages to a log file:</p>

<pre><code>        # Appenders
    my $appender = Log::Log4perl::Appender-&gt;new(
        &quot;Log::Dispatch::File&quot;,
        filename =&gt; &quot;test.log&quot;,
        mode     =&gt; &quot;append&quot;,
    );

    $food_logger-&gt;add_appender($appender);</code></pre>

<p>This will create a new appender of the class <code>Log::Dispatch::File</code>, which will <em>append</em> messages to the file <code>test.log</code>. If we had left out the <code>mode =&gt; "append"</code> pair, then it would just overwrite the file each time at system startup. </p>

<p>The wrapper class
<code>Log::Log4perl::Appender</code>
provides the necessary glue around <code>Log::Dispatch</code> modules to make them usable by <code>Log::Log4perl</code> as appenders. This tutorial shows only the most common ones:
<code>Log::Dispatch::Screen</code> to write messages to STDOUT/STDERR and
<code>Log::Dispatch::File</code>, to print to a log file. However, you can use <em>any</em>  <code>Log::Dispatch</code>-Module with <code>Log::Log4perl</code>. To find out what's available and how to their respective parameter
settings are, please refer to the detailed <code>Log::Dispatch</code> documentation. Using <code>add_appender()</code>, you can attach as many appenders to <em>any</em> logger as you like.</p>

<p>After passing the newly created appender to the logger's <code>add_appender()</code>
method like in</p>

<pre><code>    $food_logger-&gt;add_appender($appender);</code></pre>

<p>it is attached to the logger and will handle its messages if the logger
decides to fire. Also, it will handle messages percolating up the hierarchy
if a logger further down decides to fire. </p>

<p>This will cause our <code>Log::Dispatch::File</code> appender to add the following line</p>

<pre><code>    INFO - Eating Sushi</code></pre>

<p>to the logfile <code>test.log</code>. But wait -- where did the nice formatting with date, time, source file
name, line number and function go we saw earlier on in <code>:easy</code> mode? By simply specifying an appender without defining its <em>layout</em>, <code>Log::Log4perl</code>
just assumed we wanted the no-frills log message layout <code>SimpleLayout</code>, which just logs the incident priority and the message, separated by a
dash.</p>

<h3><a name="Layouts">Layouts</a></h3>

<p>If we want to get fancier (the previously shown <code>:easy</code> target did this behind our back), then we need to use the more flexible <code>PatternLayout</code>
instead. It takes a format string as an argument, in which it will --
similar to <code>printf()</code> -- replace a number of placeholders by
their actual values when it comes down to log the message. Here's how to
attach a layout to our appender:</p>

<pre><code>        # Layouts
    my $layout =
      Log::Log4perl::Layout::PatternLayout-&gt;new(
                     &quot;%d %p&gt; %F{1}:%L %M - %m%n&quot;);
    $appender-&gt;layout($layout);</code></pre>

<p>Since <code>%d</code> stands for date and time, <code>%p</code> for priority, <code>%F</code> for
the source file name, <code>%M</code> for the method executed,
<code>%m</code> for the log message and <code>%n</code> for a newline, this
layout will cause the appender to write the message like this:</p>

<pre><code>    2002/08/06 08:26:23 INFO&gt; eat:56 Groceries::Food::consume - Eating Sushi</code></pre>

<p>The <code>%F{1}</code> is special in that it takes the right-most component of the file, which
usually consists of the full path -- just like the
<code>basename()</code> function does.</p>

<p>That's it -- we've got <code>Log::Log4perl</code> ready for the big league. Listing
<code>eat.pl</code> shows the entire "system": Startup code, the main program and the
application wrapped into the <code>Groceries::Food</code> class.</p>

<h4>Listing 2: eat.pl</h4>

<pre><code>
    01 ######### System initialization section ###
    02 use Log::Log4perl qw(get_logger :levels);
    03
    04 my $food_logger = get_logger("Groceries::Food");
    05 $food_logger-&gt;level($INFO);
    06
    07     # Appenders
    08 my $appender = Log::Log4perl::Appender-&gt;new(
    09     "Log::Dispatch::File",
    10     filename =&gt; "test.log",
    11     mode     =&gt; "append",
    12 );
    13
    14 $food_logger-&gt;add_appender($appender);
    15
    16     # Layouts
    17 my $layout =
    18   Log::Log4perl::Layout::PatternLayout-&gt;new(
    19                  "%d %p&gt; %F{1}:%L %M - %m%n");
    20 $appender-&gt;layout($layout);
    21
    22 ######### Run it ##########################
    23 my $food = Groceries::Food-&gt;new("Sushi");
    24 $food-&gt;consume();
    25
    26 ######### Application section #############
    27 package Groceries::Food;
    28
    29 use Log::Log4perl qw(get_logger);
    30
    31 sub new {
    32     my($class, $what) = @_;
    33
    34     my $logger = get_logger("Groceries::Food");
    35
    36     if(defined $what) {
    37         $logger-&gt;debug("New food: $what");
    38         return bless { what =&gt; $what }, $class;
    39     }
    40
    41     $logger-&gt;error("No food defined");
    42     return undef;
    43 }
    44
    45 sub consume {
    46     my($self) = @_;
    47
    48     my $logger = get_logger("Groceries::Food");
    49     $logger-&gt;info("Eating $self-&gt;{what}");
    50 }</code></pre>

<h3><a name="Beginner_s_Pitfalls">Beginner's Pitfalls</a></h3>

<p>Remember when we said that if a logger decides to fire, then it forwards
the message to all of its appenders and also has it bubble up the hierarchy
to hit all other appenders it meets on the way up?</p>

<p>Don't underestimate the ramifications of this statement. It usually puzzles <code>Log::Log4perl</code> beginners. Imagine the following logging requirements for a new system: </p>

<ul>

<li>Messages of level FATAL are supposed to be written to STDERR, no matter
which subsystem has issued them.</li>

<li>Messages issued by the <code>Groceries</code> category, priorized DEBUG and higher need to be appended to a log file for
debugging purposes.</li>

</ul>

<p>Easy enough: Let's set the root logger to <code>FATAL</code> and attach a <code>Log::Dispatch::Screen</code> appender to it. Then, let's set the <code>Groceries</code> logger to <code>DEBUG</code> and attach a <code>Log::Dispatch::File</code> appender to it.</p>

<table border="0" cellpadding="2" cellspacing="2">
<tr>
<td width=""><img src="/pub/2002/09/11/graphics/pitfalls.gif" width="475" height="262" alt="Figure 2" /></td>
</tr>
<tr>
<span class="secondary">
<td><strong>Figure 2: A Groceries::Food and a root appender</strong></td>
</span>
</tr>
</table>

<p>Now, if any logger anywhere in the system issues a <code>FATAL</code> message and decides to 'fire,' the message will bubble up to the top of the
logger hierarchy, be caught by every appender on the way and ultimately
end up at the root logger's appender, which will write it to STDERR as
required. Nice.</p>

<p>But what happens to DEBUG messages originating within <code>Groceries</code>? Not only will the <code>Groceries</code> logger 'fire' and forward the message to its appender, but it will also
percolate up the hierarchy and end up at the appender attached to the root
logger. And, it's going to fill up STDERR with DEBUG messages from <code>Groceries</code>, whoa!</p>

<p>This kind of unwanted appender chain reaction causes duplicated logs.
Here's two mechanisms to keep it in check:</p>

<ul>
<li><p>Each appender carries an <em>additivity</em> flag. If this is set to a false value, like in</p>

<pre><code>    $appender-&gt;additivity(0);</code></pre>

<p>then the message won't bubble up further in the hierarchy after the appender is
finished.</p></li>

<li><p>Each appender can define a so-called <em>appender threshold</em>, a minimum level required for an oncoming message to be honored by the
appender:</p>

<pre><code>    $appender-&gt;threshold($ERROR);</code></pre>

<p>If the level doesn't meet the appender's threshold, then it is simply ignored by
this appender.</p></li>

</ul>

<p>In the case above, setting the additivity flag of the
<code>Groceries</code>-Appender to a false value won't have the desired effect, because it will
stop FATAL messages of the <code>Groceries</code> category to be forwarded to the root appender. However, setting the root
logger's threshold to <code>FATAL</code> will do the trick: DEBUG messages bubbling up from <code>Groceries</code> will simply be ignored.</p>

<h3><a name="Compact_logger_setups_with_confi">Compact Logger Setups With Configuration Files</a></h3>

<p>Configuring <code>Log::Log4perl</code> can be accomplished outside of your program in a configuration file. In
fact, this is the most compact and the most common way of specifying the
behavior of your loggers. Because <code>Log::Log4perl</code> originated out of the Java-based <code>log4j</code> system, it understands <code>log4j</code> configuration files:</p>

<pre><code>    log4perl.logger.Groceries=DEBUG, A1
    log4perl.appender.A1=Log::Dispatch::File
    log4perl.appender.A1.filename=test.log
    log4perl.appender.A1.mode=append
    log4perl.appender.A1.layout=Log::Log4perl::Layout::PatternLayout
    log4perl.appender.A1.layout.ConversionPattern=%d %p&gt; %F{1}:%L %M - %m%n</code></pre>

<p>This defines a logger of the category <code>Groceries</code>, whichs priority is set to DEBUG. It has the appender <code>A1</code> attached to it, which is later resolved to be a new <code>Log::Dispatch::File</code> appender with various settings and a PatternLayout with a user-defined
format (<code>ConversionPattern</code>).</p>

<p>If you store this in <code>eat.conf</code> and initialize your system with</p>

<pre><code>    Log::Log4perl-&gt;init(&quot;eat.conf&quot;);</code></pre>

<p>then you're done. The system's compact logging setup is now separated from the
application and can be easily modified by people who don't need to be
familiar with the code, let alone Perl.</p>

<p>Or, if you store the configuration description in <code>$string</code>, then you can initialize it with </p>

<pre><code>    Log::Log4perl-&gt;init(\$string);</code></pre>

<p>You can even have your application check the configuration file in regular
intervals (this obviously works only with files, not with strings):</p>

<pre><code>    Log::Log4perl-&gt;init_and_watch(&quot;eat.conf&quot;, 60);</code></pre>

<p>checks <code>eat.conf</code> every 60 seconds upon log requests and reloads everything and
re-initializes itself if it detects a change in the configuration file.
With this, it's possible to tune your logger settings <em>while</em> the system is running without restarting it!</p>

<p>The compatibility of <code>Log::Log4perl</code> with <code>log4j</code> goes so far that
<code>Log::Log4perl</code> even understands <code>log4j</code>
Java classes as appenders and maps them, if possible, to the corresponding
ones in the <code>Log::Dispatch</code> namespace.
<code>Log::Log4perl</code> will happily process the following Java-fied version of the configuration
shown at the beginning of this section:</p>

<pre><code>    log4j.logger.Groceries=DEBUG, A1
    log4j.appender.A1=org.apache.log4j.FileAppender
    log4j.appender.A1.File=test.log
    log4j.appender.A1.layout=org.apache.log4j.PatternLayout
    log4j.appender.A1.layout.ConversionPattern=%F %L %p %t %c - %m%n</code></pre>

<p>The Java-specific <code>FileAppender</code> class will be mapped by <code>Log::Log4perl</code>
to <code>Log::Dispatch::File</code> behind the scenes and the parameters adjusted (The Java-specific <code>File</code> will become <code>filename</code> and an additional parameter
<code>mode</code> will be set to <code>"append"</code> for the <code>Log::Dispatch</code> world).</p>

<h3><a name="Typical_use_cases">Typical Use Cases</a></h3>

<p>The configuration file format is more compact than the Perl code, so let's
use it to illustrate some real-world cases (although you could do the
same things in Perl, of course!):</p>

<p>We've seen before that a configuration line like:</p>

<pre><code>    log4perl.logger.Groceries=DEBUG, A1</code></pre>

<p>will turn on logging in <code>Groceries::Drink</code> and <code>Groceries::Food</code> (and all of their descendants if they exist) with priority DEBUG via
inheritance. What if
<code>Groceries::Drink</code> gets a bit too noisy and you want to raise its priority to at least INFO
while keeping the DEBUG setting for <code>Groceries::Food</code>? That's easy, no need to change your code, just modify the configuration
file:</p>

<pre><code>    log4perl.logger.Groceries.Drink=INFO, A1
    log4perl.logger.Groceries.Food=DEBUG, A1</code></pre>

<p>or, you could use inheritance to accomplish the same thing. You define INFO
as the priority for
<code>Groceries</code> and override <code>Groceries.Food</code> with a less restrictive setting:</p>

<pre><code>    log4perl.logger.Groceries=INFO, A1
    log4perl.logger.Groceries.Food=DEBUG, A1</code></pre>

<p><code>Groceries::Food</code> will be still on <code>DEBUG</code> after that, while <code>Groceries</code> and <code>Groceries::Drinks</code> will be on <code>INFO</code>.</p>

<p>Or, you could choose to turn on detailed DEBUG logging all over the system
and just bump up the minimum level for the noisy <code>Groceries.Drink</code>:</p>

<pre><code>    log4perl.logger=DEBUG, A1
    log4perl.logger.Groceries.Drink=INFO, A1</code></pre>

<p>This sets the root logger to <code>DEBUG</code>, which all other
loggers in the system will inherit. Except <code>Groceries.Drink</code> and its descendents, of course, which will carry the <code>INFO</code> priority.</p>

<p>Or, similarily to what we've talked about in the <a href="#Beginner_s_Pitfalls">Beginner's Pitfalls</a>
section, let's say you wanted to print FATAL messages system-wide to
STDOUT, while turning on detailed logging under <code>Groceries::Food</code>
and writing the messages to a log file? Use this:</p>

<pre><code>    log4perl.logger=FATAL, Screen
    log4perl.logger.Groceries.Food=DEBUG, Log

    log4perl.appender.Screen=Log::Dispatch::Screen
    log4perl.appender.Screen.stderr=0
    log4perl.appender.Screen.Threshold=FATAL
    log4perl.appender.Screen.layout=Log::Log4perl::Layout::SimpleLayout

    log4perl.appender.Log=Log::Dispatch::File
    log4perl.appender.Log.filename=test.log
    log4perl.appender.Log.mode=append
    log4perl.appender.Log.layout=Log::Log4perl::Layout::SimpleLayout</code></pre>

<p>As mentioned in <a href="#Appenders">Appenders</a>, setting the appender threshold of the screen appender to FATAL keeps <code>DEBUG</code> messages out of the root appender and so effectively prevents message
duplication.</p>

<p>According to the <code>Log::Dispatch::Screen</code> documentation, setting its <code>stderr</code> attribute to a false value causes it log to STDOUT instead of STDERR.
<code>log4perl.appender.XXX.layout</code> is the configuration file way to specify the no-frills Layout seen earlier.</p>

<p>You could also have multiple appenders attached to one category, like in</p>

<pre><code>    log4perl.logger.Groceries=DEBUG, Log, Database, Emailer</code></pre>

<p>if you had <code>Log::Dispatch</code>-type appenders defined for <code>Log</code>, <code>Database</code>
and <code>Emailer</code>.</p>


<h3><a name="Performance_penalties_and_how_to">Performance Penalties and How to Minimize Them</a></h3>

<p>Logging comes with a (small) price tag: We figure out at <em>runtime</em>
if a message is going to be logged or not. <code>Log::Log4perl</code>'s primary design directive has been to run this check at maximum speed in
order to avoid slowing down the application. Internally, it has been highly
optimized so that even if you're using large category hierarchies, the
impact of a call to e.g.
<code>$logger-&gt;debug()</code> in non-<code>DEBUG</code> mode is negligable.</p>

<p>While <code>Log::Log4perl</code> tries hard not to impose a runtime penalty on your application, it has
no control over the code leading to <code>Log::Log4perl</code> calls and needs your cooperation with that. For example, take a look at
this:</p>

<pre><code>   use Data::Dumper;
   $log-&gt;debug(&quot;Dump: &quot;, Dumper($resp));</code></pre>

<p>Passing arguments to the logging functions can impose a severe runtime
penalty, because there's often expensive operations going on before the
arguments are actually passed on to <code>Log::Log4perl</code>'s logging functions. The snippet above will have <code>Data::Dumper</code> completely unravel the structure of the object behind <code>$resp</code>, pass the whole slew on to <code>debug()</code>, which might then very well decide to throw it away. If the effective
debug level for the current category isn't high enough to actually forward
the message to the appropriate <code>appender(s),</code> then we should have
never called
<em>Dumper()</em> in the first place.</p>

<p>With this in mind, the logging functions don't only accept strings as
arguments, but also subroutine references which, in case the logger is
actually firing, it will call the subroutine behind the reference and take
its output as a message:</p>

<pre><code>   $log-&gt;debug(&quot;Dump: &quot;, sub { Dumper($resp) } );</code></pre>

<p>The snippet above won't call <code>Dumper()</code> right away, but pass on the subroutine reference to the logger's <code>DEBUG</code> method instead. Perl's closure mechanism will make sure that the value of
<code>$resp</code> will be preserved, even if the subroutine will be handed
over to
<code>Log::Log4perl</code>s lower level functions. Once <code>Log::Log4perl</code> will decide that the message is indeed going to be logged, it will execute
the subroutine, take its return value as a string and log it.</p>

<p>Also, your application can help out and check if it's necessary to pass <em>any</em> parameters at all:</p>

<pre><code>   if($log-&gt;is_debug()) {
       $log-&gt;debug(&quot;Interpolation: @long_array&quot;);
   }</code></pre>

<p>At the cost of a little code duplication, we avoid interpolating a huge
array into the log string in case the effective log level prevents the
message from being logged anyway.</p>

<h3><a name="Installation">Installation</a></h3>

<p><code>Log::Log4perl</code> is freely available from CPAN. It also requires the presence of two other
modules,
<code>Log::Dispatch</code> (2.00 or better, which is a bundle itself) and
<code>Time::HiRes</code> (1.20 or better). If you're using the CPAN shell to install
<code>Log::Log4perl</code>, then it will resolve these and other recursive dependencies for you
automatically and download the required modules one by one from CPAN.</p>

<p>At the time this article went to print, 0.22 was the stable release of <code>Log::Log4perl</code>, available from [1] and CPAN. Also on [1], the CVS source tree is publicly
available for those who want the (sometimes shaky) bleeding development
edge. The CPAN releases, on the other hand are guaranteed to be stable.</p>

<p>If you have questions, requests for new features, or if you want to
contribute a patch to <code>Log::Log4perl</code>, then please send them to our mailing list at
<a href="MAILTO:log4perl-devel@lists.sourceforge.net">log4perl-devel@lists.sourceforge.net</a>
on SourceForge.</p>

<h3><a name="Project_Status_and_similar_Modul">Project Status and Similar Modules</a></h3>

<p><code>Log::Log4perl</code> has been inspired by
<em>Tatsuhiko Miyagawa</em>'s clever <code>Log::Dispatch::Config</code> module, which provides a wrapper around the <code>Log::Dispatch</code>
bundle and understands a subset of the <code>log4j</code> configuration file syntax. However, <code>Log::Dispatch::Config</code>
does not provide a full Perl API to <code>log4j</code> -- and this is a key issue which <code>Log::Log4perl</code> has been designed to address.
<code>Log::Log4perl</code> is a <code>log4j</code>  <em>port</em>, not just a subset.</p>

<p>The <code>Log::Log4perl</code> project is still under development, but its API has reached a fairly mature
state, where we will change things only for (very) good reasons. There's
still a few items on the to-do list, but these are mainly esoteric features
of <code>log4j</code> that still need to find their way into <code>Log::Log4perl</code>, since the overall goal is to keep it compatible. Also, <code>Log::Log4perl</code> isn't thread safe yet -- but we're working on it.</p>

<h3><a name="Thanks">Thanks</a></h3>

<p>Special thanks go to fellow Log4perl founder Kevin Goess <a href="MAILTO:cpan@goess.org,">(cpan@goess.org),</a> who wrote half of the
code, helped generously to correct the manuscript for this article and
invented these crazy performance improvements, making log4j jealous!</p>

<h3><a name="Mission">Mission</a></h3>

<p>Scatter plenty of debug statements all over your code -- and put them to
sleep via the <code>Log::Log4perl</code> configuration. Let the INFO, ERROR and FATAL statements print to a log
file. If you run into trouble, then lower the level in selected parts of the
system, and redirect the additional messages to a different file. The
dormant DEBUG statements won't cost you anything -- but if you run into
trouble, then they might save the day, because your system will have an embedded
debugger on demand. Have fun!</p>

<h3><a name="Infos">Infos</a></h3>

<p><strong><a name="item__1_">[1]</a></strong>
The <code>log4perl</code> project page on SourceForge:
<a href="http://log4perl.sourceforge.net">http://log4perl.sourceforge.net</a></p>

<p><strong><a name="item__2_">[2]</a></strong>
The <code>Log::Log4perl</code> documentation:
<a href="http://log4perl.sourceforge.net/releases/Log-Log4perl/docs/html/Log/Log4perl.html">http://log4perl.sourceforge.net/releases/Log-Log4perl/docs/html/Log/Log4perl.html</a></p>

<p><strong><a name="item__3_">[3]</a></strong>
The <code>log4j</code> project page on the Apache site:
<a href="http://jakarta.apache.org/log4j">http://jakarta.apache.org/log4j</a></p>

<p><strong><a name="item__4_">[4]</a></strong>
Documentation to Log::Dispatch modules:
<a href="http://search.cpan.org/author/DROLSKY/Log-Dispatch-2.01/Dispatch.pm">http://search.cpan.org/author/DROLSKY/Log-Dispatch-2.01/Dispatch.pm</a></p>

        </div>



    </div>
    <div class="asset-footer"></div>
</div>


                            
                            <div id="entry-1356" class="entry-asset asset hentry">
    <div class="asset-header">
        <h2 class="asset-name entry-title"><a href="/pub/2002/09/10/review.html" rel="bookmark">Writing CGI Applications with Perl</a></h2>
        <div class="asset-meta">
            <span class="byline">
    
                By <span class="vcard author">Simon Cozens</span> on <abbr class="published" title="2002-09-10T00:00:00-08:00">September 10, 2002 12:00 AM</abbr>
    
            </span>

            
            

        </div>
    </div>
    <div class="asset-content entry-content">

        <div class="asset-body">
            <P>
It seems every month or so, there's a new Perl and CGI book out;
huge thick volumes promising to teach you all you need to know about
programming for the Web in 24 hours. They all start with "Hello world"
and they invariably finish with a shopping cart example. All this I
find a little tedious.
</P>
<P>
<I>Writing CGI Applications with Perl</I> is not like this. Although, I
have to admit, it has the obligatory shopping cart example. It starts
on a firm footing - security, trustworthiness of user input and the
environment, and tainting. Indeed, security is a recurrent - and a
welcome - theme throughout the book.
</P>
<P>
Brent and Kevin are both well-known members of the Perl community, and
the style and idiomatic nature of their code is second to none. If you
learn Web programming from this book, then you'll be learning quality
code, guaranteed.
</P>
<P>
If I had to find the biggest criticism of this book, then it would be that
its audience is quite unclear; you'll need a reasonably firm basic
knowledge of Perl to get the most out of it, and if your Perl is
reasonably strong, then you may find the patient, line-by-line explanation of
the code segments a little tedious. On the other hand, the beginner may
enjoy this style of exposition, but become lost as the book progresses
to more advanced subjects, such as the Perl DBI, graphics manipulation
and <CODE>mod_perl</CODE>.
</P>
<P>
Another issue I have is that the organization of material isn't
particularly great - applications developed in the middle of the book
use a backend database, but the DBI is only explained in a later
chapter. However, I have to admit that if you stick to a strict order
of introducing material, then the examples for the first half of the book end
up being horribly contrived. Kevin and Brent have sacrificed a little
linearity to end up with much more interesting, real-life applications.
</P>
<P>
What struck me most of all about this book was the clarity of
presentation; both of the explanation of the code, but also of the
physical layout of the book. A large left margin is perfect for
scribbling notes, and the code stands out beautifully. Pulling together
all of the code for a recap at the end of the chapter helps, too, except
in the case of longer examples where you end up with pages of
uncommented code.
</P>
<P>
However, some of the longer examples, particularly the full-chapter 
document management example (something that's come in particularly
handy when we've been developing a similar application ourselves ... .)
could do with many more screenshots so the reader can tell what the
result is going to be.
</P>
<P>
I was impressed to find that the book covers the more practical areas of
CGI programming - uploading your files to the server, debugging, testing
off-line, dealing with Web caches and so on. There's even a welcome
section on how to read the Perl documentation. In fact, it was a bit of
shame to look up the dreaded "premature end of script headers" error
message in the index and not find an entry; but in real life, the entry
for "debugging" pointed to a soultion that would work.
</P>
<P>
On the whole, the book covers the complete range of things you're likely
to be doing with CGI: from basic uses of the protocol, through file
upload forms, using mod_perl, and the ever-popular Web page hit counter,
right up to full-size production applications. In short, I'd consider
this <B>the</B> book for those wishing to convert a little Perl
experience into solid Web developer knowledge.
</P>
<P>
<I>
Writing CGI Applications with Perl is published by Addison-Wesley
</I>
</P>



        </div>



    </div>
    <div class="asset-footer"></div>
</div>


                            
                            <div id="entry-1366" class="entry-asset asset hentry">
    <div class="asset-header">
        <h2 class="asset-name entry-title"><a href="/pub/2002/09/p6pdigest/20020908.html" rel="bookmark">This week on Perl 6 (9/1 - 9/8, 2002)</a></h2>
        <div class="asset-meta">
            <span class="byline">
    
                By <span class="vcard author">Piers Cawley</span> on <abbr class="published" title="2002-09-08T00:00:00-08:00">September  8, 2002 12:00 AM</abbr>
    
            </span>

            
            

        </div>
    </div>
    <div class="asset-content entry-content">

        <div class="asset-body">
            

<p>Well, what a week it's been, eh, people? Larry's been telling the
Slashdot crowd about quantum God and big knobs, there's been a call
for Perl 6 programmers on Perlmonks
(<a href="http://makeashorterlink.com/?L51631EB1">http://makeashorterlink.com/</a>), and the Octarine
parrot took flight.</p>
<p>So, let's start with perl6-internals, as is traditional.</p>


<h4><a name="the_octarine_parrot_flies!">The Octarine Parrot flies!</a></h4>
<p>Jeff Goff (who deserves to suffer for his parody of <em>Eight Days a
Week</em>) announced Parrot 0.0.8, available from the usual places. This
release includes:</p>
<dl>
<dt><strong><a name="item_working_perl_6_rules%2fpatterns">Working Perl 6 rules/patterns</a></strong><br />
</dt>
<dt><strong><a name="item_multidimensional_keyed_access">Multidimensional keyed access</a></strong><br />
</dt>
<dt><strong><a name="item_jit_for_arm_processors">JIT for ARM processors</a></strong><br />
</dt>
<dt><strong><a name="item_lexical_scope_operators">Lexical scope operators</a></strong><br />
</dt>
<dt><strong><a name="item_many_bugfixes_and_smaller_subsystems">Many bugfixes and smaller subsystems</a></strong><br />
</dt>
</dl>
<p>Mere moments after announcing the new baby, Jeff realised he'd made a
mistake with the tarball's MANIFEST, and announced the release of
Parrot 0.0.8.1, which has all the same features as 0.0.8, but a
MANIFEST error has been excised. MANIFEST seems to be a source of
problems, as Tanton Gibbs also had problems with it later in the week.</p>
<p><a href="http://makeashorterlink.com/?A16623DA1">http://makeashorterlink.com/</a> -- Announcement</p>
<p><a href="http://www.cpan.org/src/parrot-0.0.8.1.tgz">http://www.cpan.org/src/parrot-0.0.8.1.tgz</a> -- Tarball</p>


<h4><a name="goal_call_for_0.0.9">Goal call for 0.0.9</a></h4>
<p>Soon after the 0.0.8 announcement Dan asked us what we wanted to see
in 0.0.9 and offered his list. The list became rather long as Sean
O'Rourke, Steve Fink and Nicholas Clark all chipped in
suggestions. The 'long' list ended up as:</p>
<dl>
<dt><strong><a name="item_exceptions">Exceptions</a></strong><br />
</dt>
<dt><strong><a name="item_initial_pmc_freeze%2fthaw_api">Initial PMC freeze/thaw API</a></strong><br />
</dt>
<dt><strong><a name="item_sub_indicators_in_bytecode">Sub indicators in bytecode</a></strong><br />
</dt>
<dt><strong><a name="item_on%2dthe%2dfly_bytecode_section_generation">On-the-fly bytecode section generation</a></strong><br />
</dt>
<dt><strong><a name="item_methods">Methods (in PASM and C)</a></strong><br />
</dt>
<dt><strong><a name="item_implementation_of_some_methods_for_the_perl_classe">Implementation of some methods for the Perl classes</a></strong><br />
</dt>
<dt><strong><a name="item_stashes">Stashes</a></strong><br />
</dt>
<dt><strong><a name="item_resolve_the_prompt_finalization_problem">Resolve the prompt finalization problem</a></strong><br />
</dt>
<dt><strong><a name="item_cleanup">PMC name, implementation <code>cleanup(*)</code></a></strong><br />
</dt>
<dt><strong><a name="item_filename%2c_line_number_tracking">Filename, line number tracking</a></strong><br />
</dt>
<dt><strong><a name="item_careful_elimination_of_compiler_warnings">Careful elimination of compiler warnings</a></strong><br />
</dt>
<dt><strong><a name="item_rationalization_of_bytecode_generation">Rationalization of bytecode generation</a></strong><br />
</dt>
</dl>
<p>(*) The PMC issue was brought up by Steve. He pointed out that right
now we have a situation where theoretically language independent PMCs
often refer to, and create, Perl specific PMCs on the fly, which seems
slightly wrong.</p>
<p><a href="http://makeashorterlink.com/?S12652EB1">http://makeashorterlink.com/</a></p>
<p><a href="http://makeashorterlink.com/?I13662EB1">http://makeashorterlink.com/</a> -- Steve's
list</p>


<h4><a name="approximate_string_matching_in_regexes">Approximate string matching in regexes</a></h4>
<p>Sean O'Rourke discoursed on edit distances and approximate matching,
and offered a patch implementing an <code>rx_amatch</code> opcode.</p>
<p><a href="http://makeashorterlink.com/?U24663EB1">http://makeashorterlink.com/</a></p>


<h4><a name="more_regex_stack_manipulations">More regex stack manipulations</a></h4>
<p>Sean also implemented a couple of opcodes for manipulating the regex
engine's stack: <code>rx_stackdepth Ix</code> and <code>rx_stackchop Ix</code>. Dan
thought that the semantics of <code>rx_stackchop</code> were slightly off, and
that the instructions were actually intstack specific and should
therefore be called <code>intstackdepth</code> and &lt;intstackchop&gt;
respectively. Dan is also 'really, <em>really</em> close to tossing the last
pretense of being a stack-based system and [moving] all the way to
routine-based frames instead, which would definitely make some things
easier.' (Whatever that means). Sean and Steve Fink both seemed to
think that that may be a step too far, at least for something as
backtrack heavy as the regex core. Steve thought he would rather not
create a few thousand Exception or Continuation objects and also
made noises about encapsulating <em>intstack.c</em>'s functionality in an
appropriately named PMC.</p>
<p>Later in the week, Steve delivered his patch to provide an integer
array PMC, but wondered if it shouldn't be called an integer dequeue
(a double ended queue). John Porter voted for dequeue. Leopold Toetsch
wondered why the patch needed a pair of new ops, and questioned the
entire premise of the patch, so Steve mounted a sterling defence of
his patch.</p>
<p><a href="http://makeashorterlink.com/?P25663EB1">http://makeashorterlink.com/</a></p>
<p><a href="http://makeashorterlink.com/?J16621EB1">http://makeashorterlink.com/</a></p>


<h4><a name="core.ops_argdir"><em>core.ops</em> ARGDIR</a></h4>
<p>Leopold Toetsch kicked off a discussion of 'the intended meaning of
ARGDIR_IN/OUT'. I'm afraid to say that while I understand the
individual words in his message, I don't really understand the post
as a whole. Which is my own fault, and makes life rather hard for a
summarizer. However, Nicholas Clark and Angel Faus seemed to
understand him, and discussion ensued.</p>
<p><a href="http://makeashorterlink.com/?D27621EB1">http://makeashorterlink.com/</a> -- Thread starts here.</p>


<h4><a name="parrot:_maximizing_the_audience">Parrot: maximizing the audience</a></h4>
<p>Jerome Quelin put the cat among the pigeons when he made a few
observations about the perlcentricity of Parrot, and wondered what
the benefits of making Parrot more explicitly vendor neutral. Jerome
wondered 'what could <em>we</em> do in order to open parrot to non-Perl
centric people?'</p>
<p>Markus Lair suggested renaming perl6-internals to 'something better
like "parrot internals". Sean O'Rourke wondered what effect this would
have, apart from breaking his procmail setup. Dan thinks we'll
probably shift to a more neutral list name eventually. John Porter
claimed that 'some folks seem to think that sufficient reason [to
change] exists now.', and Dan pointed out that John didn't have to
convince 'some folks', he had to convince Dan. John then attempted to
invoke Larry.</p>
<p>John Porter reckoned that changing the list name would have "a huge
psychological effect, at least outside our tight little club.  But if
that's only as far as you can see..."; Dan responded with admirable
restraint.</p>
<p>Steve Fink is surprised at how little Parrot is tied to Perl 6, and
noted that Perl 6 'mostly provides evidence that this isn't just an
exercise in intellectual masturbation', and came down in favour of
renaming the mailing list.</p>
<p>Ask Bjoern Hansen popped his head up to say that it would soon be
relatively easy to change the list name to, say,
<a href="mailto:'dev@parrotcode.org'.">'dev@parrotcode.org'.</a></p>
<p>Andrew Kuchling, one of the python-dev crew, popped in to talk about
<em>parrot-gen.py</em>, and why it's not being heavily developed. (From his
point of view, the mailing list name is an irrelevancy BTW). Andrew
made some good points about the fun and benefits of Parrot from the
point of view of a Pythoneer (it isn't much fun, mostly because of
the culture shock and that there don't appear to be any real benefits apart
from the possibly chimerical cross-language stuff), and worried about
the amount of optimization that was going on before we'd got any real
languages implemented. Andrew also suggested making Scheme one of the
driving languages for Parrot, based on its simple syntax and fully
specified semantics.</p>
<p>As a result of all this, Dan posted his list of 'Parrot long-term
goals/prospects', a 9 point list, with footnotes about where he sees
things going. I'm not going to summarize it because it's already its
own summary. Read it. There was some discussion about what the
eventual 'pure parrot' build environment will look like, including
some optimistic copyright lines...</p>
<p><a href="http://makeashorterlink.com/?G48625EB1">http://makeashorterlink.com/</a></p>
<p><a href="http://makeashorterlink.com/?E59651EB1">http://makeashorterlink.com/</a></p>
<p><a href="http://makeashorterlink.com/?J2A632EB1">http://makeashorterlink.com/</a> -- A Pythoneer speaks</p>
<p><a href="http://makeashorterlink.com/?B2B631EB1">http://makeashorterlink.com/</a> -- Dan's list</p>

















<h4><a name="implementation_of_lists_for_languages/scheme">Implementation of Lists for languages/scheme</a></h4>
<p>J&uuml;gen B&ouml;mmels offered a patch implementing Scheme pairs,
using simple Arrays. Dan was impressed, and wondered how far we were
from 'real' scheme. J&uuml;rgen thinks we're quite some way away; we
still need symbols, strings, lexicals, functions, macros,
continuations... Piers Cawley outlined an OO way forward using
(initially) hashes, and proposed a 'SchemeObject' PMC, which would
hide a lot of the common structural code needed for dispatching
methods implemented in any of C/Parrot/Scheme.</p>
<p><a href="http://makeashorterlink.com/?O2C651EB1">http://makeashorterlink.com/</a></p>


<h4><a name="teasing_notes">Teasing notes</a></h4>
<p>Dan announced that he was about to go dark for a while as a deadline
of his had just got a lot closer. However, he dropped a list of hints
about what was forthcoming. Bryan asked for some clarification of a
few hints (but they're <em>hints</em>, they're supposed to be a bit vague),
and Dan went and spoiled the mystery by giving him some.</p>
<pre>
    <a href="http://archive.develooper.com/perl6-internals@perl.org/msg12475.html">http://archive.develooper.com/perl6-internals@perl.org/msg12475.html</a></pre>


<h4><a name="tinderbox_turning_green">Tinderbox turning green</a></h4>
<p>Andy Dougherty noted that the recent work on portability and general
lint gathering meant that we were well on the way to a green tinderbox
(ie: automated builds are mostly working, yay!). Dan thought that gave
him an ideal opportunity to break things again by adding exceptions to
the mix. <em>Andy</em> then went a bit red, for assorted and faintly
embarrassing reasons: the patch that was meant to turn things green
had been applied and then inadvertently backed out. There's a moral
here somewhere.</p>
<p>Actually there was a spate of inadvertent unpatching last week. People
are embarrassed and hopefully putting procedures in place to avoid
another spate.</p>
<p><a href="http://makeashorterlink.com/?E6E631EB1">http://makeashorterlink.com/</a></p>


<h4><a name="perl_6_miscellany">Perl 6 miscellany</a></h4>
<p>Steve Fink offered a portmanteau patch for the Perl 6 compiler,
including such delights as a '-e' flag to perl6 so the one line script
folks could play. (First person to do the RSA one-liner in Perl 6 gets
<em>much</em> kudos from me). Sean wondered about a few of the other fixes,
and between them he and Steve found and squashed a bug with here docs,
and discussed ways of getting working Perl 6 patterns up and running.</p>
<p><a href="http://makeashorterlink.com/?Z6F654EB1">http://makeashorterlink.com/</a></p>


<hr />
<h3><a name="meanwhile,_in_perl6language">Meanwhile, in perl6-language</a></h3>
<p>Garrett Goebel reopened the 'auto deserialization' thread from last
week (which ended up with the concept of <code>my Date $date .=
new('June 25, 2002')</code> as the Damian approved idea). Garrett's
confusion seemed to hang on whether <code>my Date $date</code> and <code>my
Date $date = Date-&gt;new()</code> were equivalent. If they were, then a
class which implemented its own <code>operator:=</code> method could arrange
things so that the originally proposed <code>my Date $date = 'June 25,
2002'</code> would work.</p>
<p>Miko O'Sullivan proposed that, in the absence of a method name, <code>.=</code>
should automagically call a <code>new_from_[class of object being
passed]</code>, noting that golfers would love it. The consensus seems to be
against this particular bit of DWIMmery.</p>
<p>A subthread of this mammoth thread concerned multimethod
dispatch. David Wheeler wanted to know what it was, so Dan explained,
and Damian pointed at a Perl Journal article on the subject. This
subthread ended up spawning its own thread, where Miko wondered if
multi dispatch/overloading implied anything about
runtime/compiletime. Dan thought not, and said it was dependent on the
language.</p>
<p>Quote of the thread: "I can still remember the precise moment I first
fell in love with polymorphism." -- Damian, in the TPJ article referred
to.</p>
<p><a href="http://makeashorterlink.com/?B10721EB1">http://makeashorterlink.com/</a></p>
<p><a href="http://makeashorterlink.com/?N61742EB1">http://makeashorterlink.com/</a></p>
<p><a href="http://makeashorterlink.com/?H12722EB1">http://makeashorterlink.com/</a> -- multimethods?</p>
<p><a href="http://makeashorterlink.com/?X53743EB1">http://makeashorterlink.com/</a> -- TPJ article</p>
<p><a href="http://makeashorterlink.com/?R24712EB1">http://makeashorterlink.com/</a></p>


<h4><a name="class_aliasing">Class aliasing</a></h4>
<p>The 'auto deserialization' thread also spawned a discussion of Class
aliasing, but declined to change its subject line, making the life of
a summarizer <em>so</em> much easier...</p>
<p>Last week, Damian had proposed doing <code>class Date is
Really::Long::Package::Name::Ugh</code>, ie. subclassing the long name
into a handy short name. Everyone else seemed to think he was
proposing aliasing a class name (which Damian later denied).</p>
<p>Uri Guttman certainly thought that Damian was talking about lexical
aliasing of classes (my mailer picks his post as this week's base for
this particular subthread). Trey Harris thought that Damian was
talking about subclassing, and proposed <code>my class Date is
Really::Long::Package::Name::Ugh</code>, which introduces a lexically scoped
subclass. Nicholas Clark wondered if <code>class Date :=
Really::Long::Package::Name::Ugh</code> would express aliasing of
classes. Damian thought it probably would, but noted that Larry hasn't
said a definite 'yes' to class name aliasing.</p>
<p>Brent Dax wondered if classes weren't in danger of becoming the "new
filehandles" -- relatively limited entities with no sigils that
confuse the syntax horribly.' and pointed out an ambiguous case.</p>
<p>David Wheeler apologised to everyone for confusing inheritance and
aliasing in the first place, and the thread wound down to a close.</p>
<p><a href="http://makeashorterlink.com/?D25752EB1">http://makeashorterlink.com/</a></p>


<h4><a name="@array_=_%hash"><code>@array = %hash</code></a></h4>
<p>Another thread from last week that rumbled on into this one.</p>
<p>The discussion of when hashes could have pairs as keys wouldn't go
away. Damian says that the <code>%hash = (...)</code> case is syntactic
sugar and that having a pair in an even slot of such a list would
probably be an error. I assume that this also applies in the case of
<code>%hash = @array</code>.</p>
<p>In a subthread, Piers Cawley told David Whipp that he hadn't actually
been joking when he proposed implementing the entire Smalltalk
Collection hierarchy and making it available in core Perl 6. Luke
Palmer liked the idea too. Dan saw no reason why such a thing should
be impossible either...</p>
<p><a href="http://makeashorterlink.com/?A36721EB1">http://makeashorterlink.com/</a></p>
<p><a href="http://makeashorterlink.com/?T37723EB1">http://makeashorterlink.com/</a></p>


<h4><a name="atomicness_and_\n">Atomicness and <code>\n</code></a></h4>
<p>Last week Damian reminded us of <code>$roundor7 =
rx/&lt;&lt;roundascii&gt;+[17]&gt;/</code>, and Brent Dax wondered how one could be
sure that <code>&lt;roundascii&gt;</code> is a character class. Luke wondered if
it mattered. The thread eventually led Aaron Sherman to make a few
proposals about user defined character classes in regular
expressions. Deborah Ariel Pickett wondered why we still used <code>?</code> for
non-greedy quantifiers, citing teachability reasons for why we
shouldn't.</p>
<p><a href="http://makeashorterlink.com/?F28722EB1">http://makeashorterlink.com/</a></p>
<p><a href="http://makeashorterlink.com/?Y29713EB1">http://makeashorterlink.com/</a></p>
<p><a href="http://makeashorterlink.com/?P2A752EB1">http://makeashorterlink.com/</a></p>


<h4><a name="hypothetical_variables_and_scope">Hypothetical variables and scope</a></h4>
<p>Aaron Sherman announced that he was working on a library of rules and
subroutines for dealing with UNIX system files, mostly as mental
exercise to help with his understanding of Perl's new pattern
features. He wondered, in particular, about the scoping of
hypothetical variables in the presence of lexicals of the same
name. For some reason this turned into a minor argument about whether
<code>my $x; / (\S*) { let $x = .pos } \s* foo /</code>, from Apocalypse 5,
was a typo for <code>my $x; / (\S*) { let $x := .pos } /</code>. I'm not
going to try to summarize the argument.</p>
<p><a href="http://makeashorterlink.com/?U3B725EB1">http://makeashorterlink.com/</a></p>


<h4><a name="argument_aliasing_for_subs">Argument aliasing for subs</a></h4>
<p>Pete Behroozi wondered about syntax for 'allowing subroutines to have
many different names for the same argument', citing CGI.pm as an
example of such code in Perl 6. Damian thought that if it were
allowed, it would be done with properties <code>sub hidden (..., int
$force is aka($override) ) {...}</code>, (well, he did after he realised
that his first post on this issue was the result of posting after
travelling 14,000 miles and giving 93 hours of talks in the space of
18 days, and was somewhat flawed).</p>
<p>All this cunning use of <code>is</code> led Erik Steven Harrison (who should fix
his mailer so it does References or In-Reply-To properly) to wonder if
properties weren't being a little overused, and wondered if the is/but
distinction was still around. Damian thought not, and reiterated the
difference between <code>is</code> and <code>but</code>, and when you would use each of
them. Erik also wondered what was wrong with <code>sub hidden ( int
$force := $override ) {...}</code>. Damian pointed out that it didn't play
well with the defaulting operator, <code>//=</code>, in parameter
declarations.</p>
<p>Peter Behroozi got confused about the difference between <code>$foo is
named('baz')</code> and <code>$foo is aka($baz)</code>. (<code>named</code> changes the
externally visible name of a parameter, <code>aka</code> adds another external
name for the parameter).</p>
<p>The thread then morphed into a discussion of runtime and compiletime
properties. If you've not seen such a discussion before, the whole
thread is worth reading.</p>
<p><a href="http://makeashorterlink.com/?R5C741EB1">http://makeashorterlink.com/</a></p>
















<h4><a name="perl_6_parser,_built_in_rules,_etc.">Perl 6 parser, built in rules, etc.</a></h4>
<p>Erik Steven Harrison wondered about backward compatibility issues with
changing Perl 6's grammar when the grammar rules are so exposed to the
user. Sean O'Rourke didn't think it was an issue yet. Dan told us that
the eventual Perl 6 grammar would be maintained in a backward
compatible way, with documented places for adding changes, and that
this would be maintained for as long as Larry said so.</p>
<p><a href="http://makeashorterlink.com/?A6D721EB1">http://makeashorterlink.com/</a></p>


<h4><a name="regex_args_and_interpolation">regex args and interpolation</a></h4>
<p>David Whipp confused the heck out of me when he asked about 'regex
args and interpolation'. I confess I can't for the life of me see what
the issue is that he's trying to get at. Ken Fox seemed to understand
him though, but wanted to know what the rule was that he was using in
his example code, and proposed a couple of implementations of
it. Nicholas Clark wondered about a section of Ken's post:</p>
<pre>
    { use grammar Perl::AbstractSyntax;
      $0 := (expr (invoke 'new (class 'Date) $1 $2 $3))) }</pre>
<p>Specifically, what was that S-expression doing there? Piers Cawley
pointed out that S-expressions were a concise way of writing out an
AST's structure. Nick agreed, but pointed out that it was still in the
middle of a stream of Perl, but worked out that the <code>use grammar
Perl::AbstractSyntax</code> part of Ken's code meant that all bets were
off. At this point Nick's head threatened to explode at the
wonderfulness of it all.</p>
<p><a href="http://makeashorterlink.com/?K1E762EB1">http://makeashorterlink.com/</a></p>


<h4><a name="defaulting_params_(reprise)">Defaulting params (reprise)</a></h4>
<p>Miko O'Sullivan doesn't like <code>sub foo ( $arg //= 1 )
{...}</code> for specifying default values for function arguments. He would
rather have <code> sub foo ( $arg is default(1) ) {...}</code>. Damian
pointed out that <code>is default(...)</code> would be a compiletime only
thing, which didn't necessarily make sense.</p>
<p><a href="http://makeashorterlink.com/?D2F712EB1">http://makeashorterlink.com/</a></p>


<h4><a name="hypotheticals_again">Hypotheticals again</a></h4>
<p>Jonathan Scott Duff wondered some more about hypotheticals and
<code>let</code>. He wanted to know whether hypothetically binding to a
lexically scoped variable would also introduce that name into the
match object. A strict reading of Apocalypse 5 suggests that that
isn't the case, which, Jonathan points out, causes the programmer a
few headaches. Damian agreed that he'd like to see <code>$0</code> contain keys
for all the hypotheticals used in a match, whether they came from the
lexical scope or not. Damian would also like them to turn up in
<code>$o{'$name_with_dollar'</code> as well. So, it seems that everyone's
assumptions are aligned and we can carry on.</p>
<p><a href="http://makeashorterlink.com/?Z20821EB1">http://makeashorterlink.com/</a></p>


<h4><a name="first_crack_at_builtins.p6m">First crack at Builtins.p6m</a></h4>
<p>Aaron Sherman decided that what the world needs now is, at least, a
set of function signatures for everything that's in perl5's perlfunc
listing. He's even had a crack at implementing those functions where
possible. Aaron points out that he thinks of this file as
documentation, not code. People were impressed, and there's talk of
using it to compile down to the IMCC input as a base for hand
optimizing. Aaron also released a second version with more functions
implemented and a slightly different organization.</p>
<p><a href="http://makeashorterlink.com/?U31821EB1">http://makeashorterlink.com/</a></p>
<p><a href="http://makeashorterlink.com/?E32812EB1">http://makeashorterlink.com/</a></p>


<h4><a name="more_a5/e5_questions">More A5/E5 questions</a></h4>
<p>Jonathan Scott Duff asked a bunch of questions about the pattern
engine, and got a bunch of answers.</p>
<p><a href="http://makeashorterlink.com/?R33822EB1">http://makeashorterlink.com/</a></p>


<hr />
<h3><a name="in_brief">In brief</a></h3>
<p>Leon Brocard wondered if the concatenation bug was fixed yet...</p>
<p>Leon also offered a patch implementing <code>chr</code>, reckoning that if we
have <code>ord</code>, then symmetry demands <code>chr</code>. Dan applied it, and Jerome
Quelin found a bug in his Befunge-93 interpreter which he thought was
a bug in the chr implmentation, but turned out not to be.</p>
<p>The Perl 6 compiler now does interpolated strings. Kudos to Joseph
Ryan.</p>
<p>Josef H&ouml;&ouml;k had a problem with <code>key_next</code> not behaving as
expected within multiarray.pmc. Tom Hughes pointed where expectation
and reality differed, and harmony was restored.</p>
<p>Kevin Falcone patched the glossary to include a definition of ICU.</p>
<p>Mike Lambert is having problems with the Perl 6 compiler under
Windows. Sean O'Rourke can't duplicate the problem. Anyone else tried
this? More information is welcome.</p>
<p>Ken Fox and Damian continued their discussion of how one would munge
the current Perl 6 grammar.</p>
<p>John Williams wondered about doing reduce with <code>^+=</code>. Damian can't
remember what side he argued when it came up last October, but is now
of the opinion that John's suggestion is a good idea.</p>
<p>Mr Nobody suggested some changes to the Apocalypse 5 pattern syntax
for reasons of length. Consensus seems to be that these changes aren't
a good idea.</p>


<hr />
<h3><a name="who's_who_in_perl_6">Who's who in Perl 6</a></h3>
<dl>
<dt><strong><a name="item_who_are_you%3f">Who are you?</a></strong><br />
</dt>
<dd>
I'm Dan and ... I design virtual machines.
</dd>


<dt><strong><a name="item_what_do_you_do_for%2fwith_perl_6%3f">What do you do for/with Perl 6?</a></strong><br />
</dt>
<dd>
I'm designing the virtual machine to compile and run it.
</dd>


<dt><strong><a name="item_where_are_you_coming_from%3f">Where are you coming from?</a></strong><br />
</dt>
<dd>
A place about 70 miles east of here.
</dd>
<dd>
<p>I started fiddling with computers with an Atari 800 (fully decked out
with a massive *48*K of RAM!) a long, long time ago. That lead me to
Atari BASIC, then to 6502 assembly, then to Forth. Then (briefly) to
college and Pascal and PL/I running under VM/CMS on an OS/370 system.</p>
</dd>
<dd>

<p>From there I bounced to COBOL (on both RSTS/E and OS/370) and OS/370
assembly, and then to C under RSTS/E. I disliked C on first sight (so
of course that's what I spend most of my life writing now), and it
didn't get any better on my Amiga, though AREXX there was rather
nice. Wrote an article on AREXX for one of the now-dead Amiga
magazines, too.</p>
</dd>
<dd>
<p>My first real job in the industry was maintaining a horrid app written
in BASIC on RSTS/E (with the new bits written in BASIC/PLUS 2.6, which
was a nice dialect of BASIC, and something I still like better than C)
and helping write a new system in Progress on Unix boxen. (DG AViiON
systems with the 88K series processor. Now there was a sweet, and alas,
now dead, RISC processor)</p>
</dd>
<dd>
<p>That lead to writing C and SQL code on a VMS system, at which point my
fate was sealed, and I've been doing VMS admin and programming ever
since.</p>
</dd>
<dd>
<p>I first encountered Perl when looking for a guestbook for a webserver
we were running on one of the VMS boxes. It was, of course, written in
Perl, which meant grabbing a copy of perl. It was one of the 5.003_9x
releases, and since Dec C was significantly pickier than any other C
compiler at the time, I started shooting patches for it to Chip.</p>
</dd>
<dd>
<p>That lead to my first XS module, and then to the second, and third
(and eighth, and tenth, and...). Oddly enough, I wrote my first piece
of Perl code about six months after my first patch to the perl core
(Charles Bailey wrote the Perl pieces for the first module I did, and
chunks of the XS) I ended up with the VMS maintenance hat for a while,
which has since been passed on, and I got snared by the fun that was
the first threading attempt for 5.005.</p>
</dd>
<dd>
<p>I ended up volunteering to coordinate the Perl 6 development at TPC 4,
since everyone more competent had the good sense to run screaming away
from the job, and I've had it ever since.</p>
</dd>


<dt><strong><a name="item_when_do_you_think_perl_6_will_be_released%3f">When do you think Perl 6 will be released?</a></strong><br />
</dt>
<dd>
When it's done.
</dd>


<dt><strong><a name="item_why_are_you_doing_this%3f">Why are you doing this?</a></strong><br />
</dt>
<dd>
Beats the heck out of me. Someone's got to.
</dd>


<dt><strong><a name="item_you_have_5_words%2e_describe_yourself%2e">You have 5 words. Describe yourself.</a></strong><br />
</dt>
<dd>
Tall enough, under the circumstances.
</dd>


<dt><strong><a name="item_do_you_have_anything_to_declare%3f">Do you have anything to declare?</a></strong><br />
</dt>
<dd>
Yes, absolutely.
</dd>

</dl>


<hr />
<h3><a name="acknowledgments">Acknowledgments</a></h3>
<p>This summary is dedicated to the memory of Gizmo, a cat of great
character, who we had to have put down on Saturday at the age of 17.</p>
<p>Chris Ball, Mark Fowler and Pete Sergeant helped with proofreading
this week. Thanks chaps.</p>
<p>Once again, if you like the summary, please consider giving money to
the Perl Foundation at <a href="http://donate.perl-foundation.org/">http://donate.perl-foundation.org/</a> -- your
money will go to help fund the ongoing development of Perl 6.</p>
<p>This week's summary was, once again sponsored by the O'Reilly Network
who are paying the publication fee for the article directly to the
Perl Foundation.</p>


        </div>



    </div>
    <div class="asset-footer"></div>
</div>


                            
                            <div id="entry-1354" class="entry-asset asset hentry">
    <div class="asset-header">
        <h2 class="asset-name entry-title"><a href="/pub/2002/09/04/threads.html" rel="bookmark">Going Up?</a></h2>
        <div class="asset-meta">
            <span class="byline">
    
                By <span class="vcard author">Sam Tregar</span> on <abbr class="published" title="2002-09-04T00:00:00-08:00">September  4, 2002 12:00 AM</abbr>
    
            </span>

            
            

        </div>
    </div>
    <div class="asset-content entry-content">

        <div class="asset-body">
            
<!-- sidebar begins -->
<!-- don't move sidebars -->
<!-- sidebar ends -->


<p>Perl 5.8.0 is the first version of Perl with a stable threading
implementation.  Threading has the potential to change the way we
program in Perl, and even the way we think about programming.  This
article explores Perl's new threading support through a simple toy
application - an elevator simulator.</p>


<p>Until now, Perl programmers have had a single mechanism for
parallel processing - the venerable <code>fork()</code>.  When a program forks,
an entirely new process is created.  It runs the same code as the
parent process, but exists in its own memory space with no access to
the parent process' memory.  Communication between forked processes
is possible but it's not at all convenient, requiring pipes, sockets,
shared memory or other clumsy mechanisms.</p>


<p>In contrast, multiple threads exist inside a single process, in the
same memory space as the creating thread.  This allows threads to
communicate much more easily than separate processes.  The potential
exists for threads to work together in ways that are virtually
impossible for normal processes.</p>

<img src="/pub/2002/09/04/graphics/figure1.gif" alt="figure1" align="right" />
<p>Additionally, threads are faster to create and use less memory than
full processes (to what degree depends on your operating system).
Perl's current threading implementation doesn't do a good job of
realizing these gains, but improvements are expected.  If you learn to
thread now, then you'll be ready to take advantage of the extra speed
when it arrives.  But even if it never gets here, thread programming
is still a lot of fun!</p>



<h2><a name="building a threading perl">Building a Threading Perl</a></h2>
<p>To get started with threads you'll need to compile Perl 5.8.0
(<a href="http://cpan.org/src/stable.tar.gz">http://cpan.org/src/stable.tar.gz</a>) with threads enabled.  You can
do that with this command in the unpacked source directory:</p>


<pre><code>
  sh Configure -Dusethreads</code></pre>


  
<p>Also, it's a good idea to install your thread-capable Perl someplace
different than your default install as enabling threading will slow
down even nonthreaded programs.  To do that, use the <code>-Dprefix</code>
argument to configure.  You'll also need to tell Configure not to link
this new Perl as <code>/usr/bin/perl</code> with <code>-Uinstallusrbinperl</code>.  Thus, a
good Configure line for configuring a threaded Perl might be:</p>


<pre><code>
  sh Configure -Dusethreads -Dprefix=~/myperl -Uinstallusrbinperl</code></pre>


<p>Now you can <code>make</code> and <code>make install</code>.  The resulting Perl binary
will be ready to run the simulator in Listing 1, so go ahead and give
it a try.  When you get back, I'll explain how it works.</p>


<h2><a name="an elevator simulator">An Elevator Simulator</a></h2>
<p>The elevator simulator's design was inspired by an assignment from
Professor Robert Dewar's class in programming languages at New York
University.  The objective of that assignment was to learn how to use
the threading features of Ada.  The requirements are simple:</p>


<ul>
<li>
Each elevator and each person must be implemented as a separate
thread.</li>


<li>
People choose a random floor and ride up to it from the ground floor.
They wait there for a set period of time and then ride back down to
the ground floor.</li>


<li>
At the end of the simulation, the user receives a report showing the
efficiency of the elevator algorithm based on the waiting and riding
time of the passengers.</li>


<li>
Basic laws of physics must be respected.  No teleporting people
allowed!</li>

</ul>
<p>The class assignment also required students to code a choice of
elevator algorithms, but I've left that part as an exercise for the
reader.  (See how lazy I can get without a grade hanging over my
head?)</p>


<p>When you run the simulator you'll see output like:</p>


<pre><code>
  $ ./elevator.pl 
  Elevator 0 stopped at floor 0.
  Elevator 1 stopped at floor 0.
  Elevator 2 stopped at floor 0.
  Person 0 waiting on floor 0 for elevator to floor 11.
  Person 0 riding elevator 0 to floor 11.
  Elevator 0 going up to floor 11.
  Person 1 waiting on floor 0 for elevator to floor 1.
  Person 2 waiting on floor 0 for elevator to floor 14.
  Person 2 riding elevator 1 to floor 14.
  Person 1 riding elevator 1 to floor 1.
  Elevator 1 going up to floor 1.</code></pre>


<p>And when the simulation finishes, you'll get some statistics:</p>


<pre><code>
  Average Wait Time:   1.62s
  Average Ride Time:   4.43s</code></pre>


<pre><code>
  Longest Wait Time:   3.95s
  Longest Ride Time:  10.09s</code></pre>


<h2><a name="perl's threading flavor">Perl's Threading Flavor</a></h2>



<p>Before jumping headlong into the simulator code I would like to
introduce you to Perl's particular threading flavor.  There are a wide
variety of threading models living in the world today - POSIX threads,
Java threads, Linux threads, Windows threads, and many more.  Perl's
threads are none of these; they are of an entirely new variety.  This
means that you may have to set aside some of your assumptions about
how threads work before you can truly grok Perl threads.</p>


<blockquote>
<p>Note that Perl's threads are not 5.005 threads.  In Perl 5.005 an
experimental threading model was created.  Now known as 5.005 threads,
this system is deprecated and should not be used by new code.</p>
</blockquote>

<p>In Perl's threading model, variables are <em>not</em> shared by default
unless explicitly marked to be shared.  This is important, and
also different from most other threading models, so allow me to
repeat myself.  Unless you mark a variable as shared it will be
treated as a private thread-local variable.  The downside of this
approach is that Perl has to clone all of the nonshared variables
each time a new thread is created.  This takes memory and time.  The
upside is that most nonthreaded Perl code will ``just work'' with
threads.  Since nonthreaded code doesn't declare any shared variables
there's no need for locking and little possibility for problems.</p>


<p>Perl's threading model can be described as low-level, particularly
compared to the threading models of Java and Ada.  Perl offers you the
ability to create threads, join them and yield processor time to other
threads.  For communication between threads you can mark variables as
shared, lock shared variables, wait for signals on shared variables,
and send signals on shared variables.  That's it!</p>


<p>Most higher-level features, like Ada's entries or Java's synchronized
methods, can be built on top of these basic features.  I expect to see
plenty of development happening on CPAN in this direction as more Perl
programmers get into threads.</p>


<h2><a name="preamble">Preamble</a></h2>

<p>Enough abstraction, let's see this stuff work!  The elevator simulator
in Listing 1 starts with a section of POD documentation describing how
to use the program.  After that comes a block of <code>use</code> declarations:</p>


<pre><code>
  use 5.008;             # 5.8 required for stable threading
  use strict;            # Amen
  use warnings;          # Hallelujah
  use threads;           # pull in threading routines
  use threads::shared;   # and variable sharing routines</code></pre>


<p>The first line makes sure that Perl version 5.8.0 or later is used to
run the script.  It isn't written <code>use 5.8.0</code> because that's a syntax
error with older Perls and the whole point is to produce a friendly
message telling the user to upgrade.  The next lines are the
obligatory <code>strict</code> and <code>warnings</code> lines that will catch many of the
errors to which my fingers are prone.</p>


<p>Next comes the <code>use threads</code> call that tells Perl I'll be using
multiple threads.  This must come as early as possible in your
programs and always before the next line, <code>use threads::shared</code>.  The
<code>threads::shared</code> module allows variables to be shared between
threads, making communication between threads possible.</p>


<p>Finally, GetOpt::Long is used to load parameters from the command
line.  Once extracted, the parameter values are stored in global
variables with names in all caps (<code>$NUM_ELEVATORS</code>, <code>$PEOPLE_FREQ</code>,
and so on).</p>















<h2><a name="building state">Building State</a></h2>
<p>The building is represented in the simulation with three shared
variables, <code>%DOOR</code>, <code>@BUTTON</code> and <code>%PANEL</code>.  These variables are
declared as shared using the <code>shared</code> attribute:</p>


<pre><code>
  # Building State
  our %DOOR   : shared; # a door for each elevator on each floor
  our @BUTTON : shared; # a button for each floor to call the elevators
  our %PANEL  : shared; # a panel of buttons in each elevator for each floor</code></pre>


<p>When a variable is marked as shared its state will be synchronized
between threads.  If one thread makes a change to a shared variable
then all the other threads will see that change.  This means that
threads will need to lock the variable in order to access it safely,
as I'll demonstrate below.</p>


<p>The building state is initialized in the <code>init_building()</code> function.</p>


<pre><code>
  # initialize building state
  sub init_building {
      # set all indicators to 0 to start the simulation
      for my $floor (0 .. $NUM_FLOORS - 1) {       
          $BUTTON[$floor] = 0;
          for my $elevator (0 .. $NUM_ELEVATORS - 1) {
              $PANEL{&quot;$elevator.$floor&quot;} = 0;
              $DOOR{&quot;$elevator.$floor&quot;}  = 0;
          }
      }   
  }</code></pre>


<p>The buttons on each floor are set to 0 to indicate that they are
``off.''  When a person wants to summon the elevator to a floor they
will set the button for that floor to 1 (<code>$BUTTON[$floor] = 1</code>).For
each elevator there are a set of panel buttons and a set of doors, one
for each floor.  These are all cleared to 0 at the start of the
simulation.  When an elevator reaches a floor it will open the door by
setting the appropriate item in <code>%DOOR</code> to 1
(<code>$DOOR{&quot;$elevator.$floor&quot;} = 1</code>).  Similarly, people tell the
elevators where to go by setting entries in <code>%PANEL</code> to 1
(<code>$PANEL{&quot;$elevator.$floor&quot;} = 1</code>).</p>


<p>Figure 2 shows a single-elevator building with four floors and three
people.  Don't worry if this doesn't make much sense yet, you'll see it
in action later.</p>


<img src="/pub/2002/09/04/graphics/figure2.gif" alt="figure2" />

<h2><a name="thread creation">Thread Creation</a></h2>

<p>After calling <code>init_building()</code> to initialize the shared building
state variables, the program creates the elevator threads inside
<code>init_elevator()</code>:</p>


<pre><code>
  # create elevator threads
  sub init_elevator {
      our @elevators;
      for (0 .. $NUM_ELEVATORS - 1) {
          # pass each elevator thread a unique elevator id
          push @elevators, threads-&gt;new(\&amp;Elevator::run, 
                                        id =&gt; $_);
      }
  }</code></pre>


<p>Threads are created by calling <code>threads-&gt;new()</code>.  The first
argument to <code>threads-&gt;new()</code> is a subroutine reference where the
new thread will begin execution.  In this case, it is the
<code>Elevator::run()</code> subroutine declared later in the program.  Anything
after the first argument is passed as an argument to this subroutine.
In this case each elevator is given a unique ID starting at 0.</p>


<p>The return value from <code>threads-&gt;new()</code> is an object representing
the created thread.  This is saved in a global variable,
<code>@elevators</code>, for use later in shutting down the simulation.</p>


<p>After the elevators are created the simulation is ready to send in
people with the <code>init_people()</code> routine:</p>


<pre><code>
  # create people threads
  sub init_people {
      our @people;
      for (0 .. $NUM_PEOPLE - 1) {
          # pass each person thread a unique person id and a random
          # destination
          push @people, threads-&gt;new(\&amp;Person::run,
                                     id   =&gt; $_, 
                                     dest =&gt; int(rand($NUM_FLOORS - 2)) + 1);</code></pre>


<pre><code>
          # pause if we've launched enough people this second
          sleep 1 unless $_ % $PEOPLE_FREQ;
      }
  }</code></pre>


<p>This routine creates <code>$PEOPLE_FREQ</code> people and then sleeps for one
second before continuing.  If this wasn't done, then all the people would
arrive at the building at the same time and the simulation would be
rather boring.  Notice that while the main thread sleeps the
simulation is proceeding in the elevator and people threads.</p>


<p>The people threads start at <code>Person::run()</code>, which will be described
later.  <code>Person::run()</code> receives two parameters - a unique ID and a
randomly chosen destination floor.  Each person will board an elevator
at the ground floor, ride to this floor, wait there for a set period
of time and then ride an elevator back down.</p>
















<h2><a name="the elevator class">The Elevator Class</a></h2>
<p>Each elevator thread contains an object of the Elevator class.  The
<code>Elevator::run()</code> routine creates this object as its first activity:</p>


<pre><code>
  # run an Elevator thread, takes a numeric id as an argument and
  # creates a new Elevator object
  sub run {
      my $self = Elevator-&gt;new(@_);</code></pre>


<p>Notice that since <code>$self</code> is <em>not</em> marked shared it is a
thread-local variable.  Thus, each elevator has its own private
<code>$self</code> object.  The <code>new()</code> method just sets up a hash with some
useful state variables and returns a blessed object:</p>


<pre><code>
  # create a new Elevator object
  sub new {
      my $pkg = shift;
      my $self = { state =&gt; STARTING,
                   floor =&gt; 0,
                   dest  =&gt; 0,
                   @_,
                 };
      return bless($self, $pkg);
  }</code></pre>


<p>All elevators start at the ground floor (floor 0) with no destination.
The <code>state</code> attribute is set to <code>STARTING</code> which comes from this set
of constants used to represent the state of the elevator:</p>


<pre><code>
  # state enumeration
  use constant STARTING   =&gt; 0;
  use constant STOPPED    =&gt; 1;
  use constant GOING_UP   =&gt; 2;
  use constant GOING_DOWN =&gt; 3;</code></pre>


<p>After setting up the object, the elevator thread enters an infinite
loop looking for button presses that will cause it to travel to a
floor.  At the top of the loop <code>$self-&gt;next_dest()</code> is called to
determine where to go:</p>


<pre><code>
    # run until simulation is finished
    while (1) {
        # get next destination
        $self-&gt;{dest} = $self-&gt;next_dest;</code></pre>


<p>The <code>next_dest()</code> method examines the shared array <code>@BUTTON</code> to
determine if any people are waiting for an elevator.  It also looks at
<code>%PANEL</code> to see if there are people inside the elevator heading to a
particular floor.  Since <code>next_dest()</code> accesses shared variables it
starts with a call to <code>lock()</code> for each shared variable:</p>


<pre><code>
  # choose the next destination floor by looking at BUTTONs and PANELs
  sub next_dest {
      my $self = shift;
      my ($id, $state, $floor) = @{$self}{('id', 'state', 'floor')};
      lock @BUTTON;
      lock %PANEL;</code></pre>


<p>Perl's <code>lock()</code> is an advisory locking mechanism, much like
<code>flock()</code>.  When a thread locks a variable it will wait for any other
threads to release their locks before proceeding.  The lock obtained
by <code>lock()</code> is lexical - that is, it lasts until the enclosing scope
is exited.  There is no <code>unlock()</code> call, so it's important to
carefully scope your calls to <code>lock()</code>.  In this case the locks on
<code>@BUTTON</code> and <code>%PANEL</code> last until <code>next_dest()</code> returns.</p>


<p><code>next_dest()</code>'s logic is simple, and largely uninteresting for the
purpose of learning about thread programming.  It does a simple scan
across <code>@BUTTON</code> and <code>%PANEL</code> looking for <code>1</code>s and takes the first
one it finds.</p>


<p>Once <code>next_dest()</code> returns the elevator has its marching orders.  By
comparing the current floor (<code>$self-&gt;{floor}</code>) to the destination
the elevator now knows whether it should stop, or travel up or down.  First, let's look at what happens when the elevator decides to
stop:</p>


<pre><code>
   # stopped?
   if ($self-&gt;{dest} == $self-&gt;{floor}) {
        # state transition to STOPPED?
        if ($self-&gt;{state} != STOPPED) {
            print &quot;Elevator $id stopped at floor $self-&gt;{dest}.\n&quot;;
            $self-&gt;{state} = STOPPED;
        }</code></pre>


<pre><code>
        # wait for passengers
        $self-&gt;open_door;
        sleep $ELEVATOR_WAIT;</code></pre>


<p>The code starts by printing a message and changing the state attribute
if the elevator was previously moving.  Then it calls the
<code>open_door()</code> method and sleeps for <code>$ELEVATOR_WAIT</code> seconds.</p>


<p>The <code>open_door()</code> method opens the elevator door.  This allows
waiting people to board to elevator.</p>


<pre><code>
  # open the elevator doors
  sub open_door {
      my $self = shift;
      lock %DOOR;
      $DOOR{&quot;$self-&gt;{id}.$self-&gt;{floor}&quot;} = 1;
      cond_broadcast(%DOOR);
  }</code></pre>


<p>Like <code>next_dest()</code>, <code>open_door()</code> manipulates a shared variable so
it starts with a call to <code>lock()</code>.  It then sets the elevator door
for the elevator on this floor to open by assigning <code>1</code> to the
appropriate entry in <code>%DOOR</code>.  Then it wakes up all waiting person
threads by calling <code>cond_broadcast()</code> on <code>%DOOR</code>.  I'll go into more
detail about <code>cond_broadcast()</code> when I show you the Person class
later on.  For now suffice it to say that the people threads wait on
the <code>%DOOR</code> variable and will be woken up by this call.</p>


<p>The other states, for going up and going down, are handled similarly:</p>


<pre><code>
  } elsif ($self-&gt;{dest} &gt; $self-&gt;{floor}) {
      # state transition to GOING UP?
      if ($self-&gt;{state} != GOING_UP) {
          print &quot;Elevator $id going up to floor $self-&gt;{dest}.\n&quot;;
          $self-&gt;{state} = GOING_UP;
          $self-&gt;close_door; 
      }</code></pre>


<pre><code>
      # travel to next floor up
      sleep $ELEVATOR_SPEED;
      $self-&gt;{floor}++;</code></pre>


<pre><code>
  } else {
      # state transition to GOING DOWN?
      if ($self-&gt;{state} != GOING_DOWN) {
          print &quot;Elevator $id going down to floor $self-&gt;{dest}.\n&quot;;
          $self-&gt;{state} = GOING_DOWN;
          $self-&gt;close_door; 
      }</code></pre>


<pre><code>
      # travel to next floor down
      sleep $ELEVATOR_SPEED;
      $self-&gt;{floor}--;
  }</code></pre>


<p>The elevator looks at the last value for <code>$self-&gt;{state}</code> to
determine whether it was already heading up or down.  If not, then it prints a
message and calls <code>$self-&gt;close_door()</code>.  Then it sleeps for
<code>$ELEVATOR_SPEED</code> seconds as it travels between floors and adjusts
its current floor accordingly.</p>


<p>The <code>close_door()</code> method simply does the inverse of <code>open_door()</code>,
but without the call to <code>cond_broadcast()</code> since there's no point
waking people up if they can't get on the elevator:</p>


<pre><code>
  # close the elevator doors
  sub close_door {
      my $self = shift;
      lock %DOOR;
      $DOOR{&quot;$self-&gt;{id}.$self-&gt;{floor}&quot;} = 0;
  }</code></pre>


<p>Finally, at the bottom of the elevator loop there is a check on the
shared variable <code>$FINISHED</code>:</p>


<pre><code>
  # simulation over?
  { lock $FINISHED; return if $FINISHED; }</code></pre>


<p>Since the elevator threads are in an infinite loop the main thread
needs a way to tell them when the simulation is over.  It uses the
shared variable <code>$FINISHED</code> for this purpose.  I'll go into more
detail about why this is necessary later.</p>


<p>That's all there is to the Elevator class code.  Elevators simply
travel from floor to floor opening and closing doors in response to
buttons being pushed by people.</p>
















<h2><a name="the person class">The Person Class</a></h2>
<p>Now that we've looked at the machinery, let's turn our attention to
the inhabitants of this building, the people.  Each person thread is
created with a goal - ride an elevator up to the assigned floor, wait
a bit and then ride an elevator back down.  Person threads are also
responsible for keeping track of how long they wait for the elevator
and how long they ride.  When they finish they report this information
back to the main thread where it is output for your edification.</p>


<p><code>Person::run()</code> starts the same way as <code>Elevator::run()</code>, by
creating a new object:</p>


<pre><code>
  # run a Person thread, takes an id and a destination floor as
  # arguments.  Creates a Person object.
  sub run {
      my $self = Person-&gt;new(@_);</code></pre>


<p>Inside <code>Person::new()</code> two attributes are setup to keep track of the
person's progress, floor and elevator:</p>


<pre><code>
  # create a new Person object
  sub new {
      my $pkg = shift;
      my $self = { @_,
                   floor    =&gt; 0,
                   elevator =&gt; 0 };
      return bless($self, $pkg);
  }</code></pre>


<p>Back in <code>Person::run()</code> the person thread begins waiting for the
elevator by calling <code>$self-&gt;wait()</code>.  The calls to <code>time()</code> will
be used later to report on how long the person waited.</p>


<pre><code>
  # wait for elevator going up
  my $wait_start1 = time;
  $self-&gt;wait;
  my $wait1 = time - $wait_start1;</code></pre>


<p>The <code>wait()</code> method is responsible for waiting until an elevator
arrives and opens its doors on this floor:</p>


<pre><code>
  # wait for an elevator
  sub wait {
      my $self = shift;</code></pre>


<pre><code>
      print &quot;Person $self-&gt;{id} waiting on floor 1 for elevator &quot;,
        &quot;to floor $self-&gt;{dest}.\n&quot;;</code></pre>


<pre><code>
      while(1) {
          $self-&gt;press_button();
          lock(%DOOR);
          cond_wait(%DOOR);
          for (0 .. $NUM_ELEVATORS - 1) {
              if ($DOOR{&quot;$_.$self-&gt;{floor}&quot;}) {
                  $self-&gt;{elevator} = $_;
                  return;
              }
          }
      }
  }</code></pre>


<pre><code>
  # signal an elevator to come to this floor
  sub press_button {
      my $self = shift;
      lock @BUTTON;
      $BUTTON[$self-&gt;{floor}] = 1;
  }</code></pre>



<p>After printing out a message, the code enters an infinite loop waiting
for the elevator.  At the top of the loop, the <code>press_button()</code>
method is called.  <code>press_button()</code> locks <code>@BUTTON</code> and sets
<code>$BUTTON[$self-&gt;{floor}]</code> to <code>1</code>.  This will tell the elevators that a
person is waiting on the ground floor.</p>


<p>The code then locks <code>%DOOR</code> and calls <code>cond_wait(%DOOR)</code>.  This has
the effect of releasing the lock on <code>%DOOR</code> and putting the thread to
sleep until another thread does a <code>cond_broadcast(%DOOR)</code> (or
<code>cond_signal(%DOOR)</code>, a variant of <code>cond_broadcast()</code> that just
wakes a single thread).  When the thread wakes up again it re-acquires
the lock on <code>%DOOR</code> and then checks to see if the door that just
opened is on this floor.  If it is the person notes the elevator and
returns from <code>wait()</code>.</p>


<p>If there's no elevator on the floor where the person is waiting, the
loop is run again.  The person presses the button again and then goes
back to sleep waiting for the elevator.  You might be wondering why
the call to <code>press_button()</code> is inside the loop instead of outside.
The reason is that it is possible for the person to wake up from
<code>cond_wait()</code> but have to wait so long to re-acquire the lock on
<code>%DOOR</code> that the elevator is already gone.</p>


<p>Once the elevator arrives, control returns to <code>run()</code> and the person
boards the elevator:</p>


<pre><code>
    # board the elevator, wait for arrival at destination floor and get off
    my $ride_start1 = time;
    $self-&gt;board;
    $self-&gt;ride;
    $self-&gt;disembark;
    my $ride1 = time - $ride_start1;</code></pre>


<p>The <code>board()</code> method is simple enough.  It just turns off the
<code>@BUTTON</code> entry used to summon the elevator and presses the
appropriate button inside the elevator's <code>%PANEL</code>:</p>


<pre><code>
  # get on an elevator
  sub board {
      my $self = shift;
      lock @BUTTON;
      lock %PANEL;
      $BUTTON[$self-&gt;{floor}] = 0;
      $PANEL{&quot;$self-&gt;{elevator}.$self-&gt;{dest}&quot;} = 1;
  }</code></pre>


<p>Next, the <code>run()</code> code calls <code>ride()</code> which does another
<code>cond_wait()</code> on <code>%DOOR</code>, this time waiting for the door in the
elevator to open on the destination floor:</p>


<pre><code>
  # ride to the destination
  sub ride {
      my $self = shift;</code></pre>


<pre><code>
      print &quot;Person $self-&gt;{id} riding elevator $self-&gt;{elevator} &quot;,
        &quot;to floor $self-&gt;{dest}.\n&quot;;</code></pre>


<pre><code>
      lock %DOOR;
      cond_wait(%DOOR) until $DOOR{&quot;$self-&gt;{elevator}.$self-&gt;{dest}&quot;};
  }</code></pre>


<p>When the elevator arrives, <code>ride()</code> will return and the person thread
calls <code>disembark()</code>, which clears the entry in <code>%PANEL</code> for this
floor and sets the current floor in <code>$self-&gt;{floor}</code>.</p>


<pre><code>
  # get off the elevator
  sub disembark {
      my $self = shift;
</code></pre>


<pre><code>

      print &quot;Person $self-&gt;{id} getting off elevator $self-&gt;{elevator} &quot;,
        &quot;at floor $self-&gt;{dest}.\n&quot;;</code></pre>


<pre><code>

      lock %PANEL;
      $PANEL{&quot;$self-&gt;{elevator}.$self-&gt;{dest}&quot;} = 0;
      $self-&gt;{floor} = $self-&gt;{dest};
  }</code></pre>


<p>After reaching the destination floor, the person thread waits for
<code>$PEOPLE_WAIT</code> seconds and then heads back down by repeating the
steps again with <code>$self-&gt;{dest}</code> set to 0:</p>


<pre><code>
    # spend some time on the destination floor and then head back
    sleep $PEOPLE_WAIT;
    $self-&gt;{dest} = 0;</code></pre>


<p>When this is complete the person has arrived at the ground floor.  The
thread ends by returning the recorded timing data with <code>return</code>:</p>


<pre><code>
    # return wait and ride times
    return ($wait1, $wait2, $ride1, $ride2);</code></pre>


<h2><a name="the grand finale">The Grand Finale</a></h2>
<p>While the simulation is running the main thread is sitting in
<code>init_people()</code> creating person threads periodically.  Once this task
is complete the <code>finish()</code> routine is called.</p>


<p>The first task of <code>finish()</code> is to collect statistics from the people
threads as they complete:</p>


<pre><code>
  # finish the simulation - join all threads and collect statistics
  sub finish {
      our (@people, @elevators);
</code></pre>


<pre><code>

      # join the people threads and collect statistics
      my ($total_wait, $total_ride, $max_wait, $max_ride) = (0,0,0,0);
      foreach my $person (@people) {
          my ($wait1, $wait2, $ride1, $ride2) = $person-&gt;join;
          $total_wait += $wait1 + $wait2;
          $total_ride += $ride1 + $ride2;
          $max_wait    = $wait1 if $wait1 &gt; $max_wait;
          $max_wait    = $wait2 if $wait2 &gt; $max_wait;
          $max_ride    = $ride1 if $ride1 &gt; $max_ride;
          $max_ride    = $ride2 if $ride2 &gt; $max_ride;
      }</code></pre>


<p>To extract return values from a finished thread the <code>join()</code> method
must be called on the thread object.  This method will wait for the
thread to end, which means that this loop won't finish until the last
person reaches the ground floor.</p>


<p>Once all the people are processed, the simulation is over.  To tell
the elevators to shutdown the shared variable <code>$FINISHED</code> is set to
1 and the elevators are joined:</p>


<pre><code>
  # tell the elevators to shut down
  { lock $FINISHED; $FINISHED = 1; }
  $_-&gt;join for @elevators;</code></pre>


<p>If this code were omitted the simulation would still end but Perl
would print a warning because the main thread exited with other
threads still running.</p>


<p>Finally, <code>finish()</code> prints out the statistics collected from the
person threads:</p>


<pre><code>
  # print out statistics
  print &quot;\n&quot;, &quot;-&quot; x 72, &quot;\n\nSimulation Complete\n\n&quot;, &quot;-&quot; x 72, &quot;\n\n&quot;;
  printf &quot;Average Wait Time: %6.2fs\n&quot;,   ($total_wait / ($NUM_PEOPLE * 2));
  printf &quot;Average Ride Time: %6.2fs\n\n&quot;, ($total_ride / ($NUM_PEOPLE * 2));
  printf &quot;Longest Wait Time: %6.2fs\n&quot;,   $max_wait;
  printf &quot;Longest Ride Time: %6.2fs\n\n&quot;, $max_ride;</code></pre>


<p>The end!</p>


<h2><a name="a few wrinkles">A Few Wrinkles</a></h2>
<p>Overall, the simulator was a fun project with few major stumbling
blocks.  However, there were a few problems or near problems that
you would do well to avoid.</p>


<p><strong>Deadlock</strong></p>


<p>All parallel programs are susceptible to deadlock, but, by virtue of
higher levels of inter-activity, threads suffer it more frequently.
Deadlock occurs when independent threads (or processes) each need a
resource the other has.</p>


<p>In the elevator simulator I avoided deadlock by always performing
multiple locks in the same order.  For example,
<code>Elevator::next_dest()</code> begins with:</p>


<pre><code>
  lock @BUTTON;
  lock %PANEL;</code></pre>


<p>And in <code>Person::board()</code> the same sequence is repeated:</p>


<pre><code>
  lock @BUTTON;
  lock %PANEL;</code></pre>

<p>If the lock calls in <code>Person::board()</code> were reversed then the
following could occur:</p>


<ol>
<li>
Elevator 2 locks <code>@BUTTON</code>.</li>


<li>
Person 3 locks <code>%PANEL</code>.</li>


<li>
Elevator 2 tries to lock <code>%PANEL</code> and blocks waiting for Person 3's lock.</li>


<li>
Person 3 tries to lock <code>@BUTTON</code> and blocks waiting for Elevator 2's lock.</li>


<li>
<em>Deadlock!</em> Neither thread can proceed and the simulation will never
end.</li>

</ol>
<p><strong>Modules</strong></p>


<p>In general, unless a module has been specifically vetted as thread
safe it cannot be used in a threaded program.  Most pure Perl modules
should be thread safe but most XS modules are not.  This goes for core
modules too!</p>


<p>An earlier version of the elevator simulator used Time::HiRes to allow
for fractional <code>sleep()</code> times.  This really helped speed up the
simulation since it meant that elevators could traverse more than one
floor per second.  However, on further investigation (and advice from
Nick Ing-Simmons) I realized that Time::HiRes is not necessarily
thread safe.  Although it seemed to work fine on my machine there's no
reason to believe that would be the case elsewhere, or even that it
wouldn't blow up at some random point in the future.  The problem with
thread safety is that it's virtually impossible to test for; either
you can prove you have it or you must assume you don't!</p>


<p><strong>Synchronized <code>rand()</code></strong></p>


<p>The first version of the simulator I wrote had the people threads
calling <code>rand()</code> inside <code>Person::run()</code> to choose the destination
floor.  I also had a call to <code>srand()</code> in the main thread, not
realizing that Perl now calls <code>srand()</code> with a good seed
automatically.  The combination resulted in every person choosing the
same destination floor.  Yikes!</p>


<p>The reason for this is that by calling <code>srand()</code> in the main thread I
set the random seed.  Then when the threads were created that seed was
copied into each thread.  The call to <code>rand()</code> then generated the
same first value in each thread.</p>


<h2><a name="resources">Resources</a></h2>
<p>Perl comes with copious threading documentation.  You can read these
docs by following the links below or by using the <code>perldoc</code> program
that comes with Perl.</p>

<ul>

<li>
<a href="/2002/09/04/examples/elevator.pl">elevator.pl</a> - Sample code from this article.
</li>

<li>
perlthrtut (<a href="http://perldoc.com/perl5.8.0/pod/perlthrtut.html">http://perldoc.com/perl5.8.0/pod/perlthrtut.html</a>) - a
threading tutorial</li>


<li>
threads (<a href="http://perldoc.com/perl5.8.0/lib/threads.html">http://perldoc.com/perl5.8.0/lib/threads.html</a>) - the
reference for the threads module</li>


<li>
threads::shared
(<a href="http://perldoc.com/perl5.8.0/lib/threads/shared.html">http://perldoc.com/perl5.8.0/lib/threads/shared.html</a>) -the
reference for the threads::shared module</li>


</ul>

        </div>



    </div>
    <div class="asset-footer"></div>
</div>


                            
                            <div id="entry-1352" class="entry-asset asset hentry">
    <div class="asset-header">
        <h2 class="asset-name entry-title"><a href="/pub/2002/09/04/perlfororacle.html" rel="bookmark">The Fusion of Perl and Oracle</a></h2>
        <div class="asset-meta">
            <span class="byline">
    
                By <span class="vcard author">Andy Duncan</span> on <abbr class="published" title="2002-09-04T00:00:00-08:00">September  4, 2002 12:00 AM</abbr>
    
            </span>

            
            

        </div>
    </div>
    <div class="asset-content entry-content">

        <div class="asset-body">
            
<p><i>Andy Duncan is the co-author of <a href="http://www.oreilly.com/catalog/oracleperl/">Perl for Oracle DBAs</a>.</i></p>

<p>My coauthor, Jared Still, and I had the task of writing a book, <i>Perl for Oracle DBAs</i>, about two of our favorite subjects, Perl and Oracle. Our goal was to link Perl and ready-canned Perl applications to the job of making an Oracle DBA's life both easier and better. Besides covering the entire spread of Perl, and in particular, relating the examination and control of Oracle databases, we also created a wide-ranging, open 
source Perl Toolkit for Oracle DBAs.  The toolkit contains all the Perl scripts we've used as DBAs for the past decade, wrapped up into a single, object-oriented project for both Unix and Win32, and which forms the heart of our book.  We've also included a comprehensive 
guide to all of the Perl Oracle DBA tools already out there, including Orac, Oracletool, 
DDL::Oracle, StatsView, Senora, Apache::OWA, and many more.</p>



<p>I thought that in this article, we'd go beyond our passionate and committed belief that 
Perl is simply the finest scripting language ever invented for helping Oracle DBAs in their 
daily working lives, and question just why Perl 
possesses such a good symbiosis with the Oracle database.  We'll also try to explain how 
the answers to this question helped us construct our Perl DBA Toolkit.</p>

<h3>Objectivism</h3>

<p>At first glance, Perl and Oracle seem like strange bedfellows, so how can they be linked 
so well to each other? We think there's is perhaps even a philosophical link 
stretching between Perl and Oracle, all the way back to Aristotle and Athens, the first state 
in the world to champion the rights of the individual.  This link, we believe, is "Objectivism." This most modern of philosophies was created by Ayn 
Rand, an escapee of 1920s Leningrad, who is more famous as the author of <i>Atlas Shrugged</i>.  
It remains perhaps one of the most influential books of the past 100 years, in the 
same league as <i>Brave New World</i>, <i>Animal Farm</i>, and <i>1984</i>; it is also the fictional representation of Objectivism.</p>

<p>Ayn Rand's ideas form a philosophy in defense of the individual and his or her rights, 
which spring principally from an individual's right to life, and the pursuit of his or her own 
happiness, within the rule of law.  To demonstrate this, in a dramatic sense, Ayn Rand's 
books portrayed what she later called "Ideal" men.  In one of her earlier books, <i>The 
Fountainhead</i>, Ayn Rand's hero was Howard Roark, a maverick architect, and the best of 
his generation, who insists on clean, simple, and strong design.  Virtually everyone else is 
stuck in ornament and the nineteenth century, whereas Roark creates great soaring towers of 
glass and steel that take one's breath away.  Although Roark often takes payment and credit, 
he is so dedicated to his craft that he often misses out on both, handing them on to other, lesser 
architects just so he can see his bold designs completed.</p>  

<p>Roll the clock forward 50 years, and if Ayn Rand were to write <i>The Fountainhead</i> now, it would be surprising if she didn't replace her building architect with a computer language 
architect, perhaps someone like Larry Wall.  Howard 
Roark's architecture brings joy to millions of ordinary, hard-working 
people.  In the same way, Perl has increased the productivity and creative expression of 
Oracle DBAs and system administrators everywhere because it is so deliberately tailored 
toward the individual.  It is all things to all people, and you can blend it with any 
architecture to create exactly the software you want.  You are limited only by 
your system administrator's disk quota for DBA users.  Similarly, with our toolkit, we have 
tried to keep it free from adornment and left it highly configurable for your own individual 
needs.  We've also tried to aid the construction of further solutions, and keep this as simple 
as possible by providing ready-built modules that you can plug right into your own 
designs and interfaces.  Our main architectural modules are summarized below, in Table 1.</p>


<div align="center"><h4>Table 1.  Main PDBA Toolkit Supporting Modules</h4></div>

<table cellpadding="2" cellspacing="2" border="1">
<tr>
<th>Module</th>
<th>Description</th>
</tr>

<tr>
<td><code>PDBA::CM</code></td>
<td>Connection manager that simplifies Perl-to-Oracle connectivity.</td>
</tr>

<tr>
<td><code>PDBA::ConfigFile</code></td>
<td>Finds and opens configuration files.</td>
</tr>

<tr>
<td><code>PDBA::ConfigLoad</code></td>
<td>Finds, opens, parses, and loads configuration files into memory.</td>
</tr>

<tr>
<td><code>PDBA::DBA</code></td>
<td>Designed for DBA-specific tasks; many methods are data-
dictionary related.</td>
</tr>

<tr>
<td><code>PDBA::Daemon</code></td>
<td>Runs Perl script daemons on Unix.</td>
</tr>

<tr>
<td><code>Win32::Daemon</code></td>
<td>This module, by Dave Roth, is included (with permission) because 
it is so important to toolkit daemon services on Win32 systems.</td>
</tr>

<tr>
<td><code>PDBA::GQ</code></td>
<td>Generic Query module that simplifies single tables queries.</td>
</tr>

<tr>
<td><code>PDBA::LogFile</code></td>
<td>Creates and locks log files; used by many scripts in the toolkit to 
perform logging actions.</td>
</tr>

<tr>
<td><code>PDBA::OPT</code></td>
<td>Processes command line arguments unhandled by calling scripts.</td>
</tr>

<tr>
<td><code>PDBA::PWC</code></td>
<td>Password client module.</td>
</tr>

<tr>
<td><code>PDBA::PWD</code></td>
<td>Password server module.</td>
</tr>

<tr>
<td><code>PDBA::PWDNT</code></td>
<td>Password server modules for Win32.</td>
</tr>

<tr>
<td><code>PDBA::PidFile</code></td>
<td>Used to control script execution.</td>
</tr>


<tr>
<td><code>PDBA</code></td>
<td>Modular collection of widely used methods.</td>
</tr>

</table>
<!--end table data-->

<p>With architecture, as with Perl, what you see is what you get, and it is impossible to hide 
steel and glass constructions from rival architects.  However, your inspiration and artistic 
ability are your own, and it is your signature at the bottom of the blueprints, just as it is 
Larry Wall's copyright name on the Perl Artistic License.  So if Larry Wall is an "Ideal" 
man in Ayn Rand's Objectivist mold, what about the other Larry in our story, Mr. Ellison 
of Redwood Shores?</p>

<h3>Proprietary Technology</h3>

<p>In <i>Atlas Shrugged</i> one of the main "Ideal" men is Hank Rearden.  Using his own capital, 
determination, and research ability, Hank Rearden creates a proprietary super-strength metal, 
of which the whole world is unable to get enough.  It is used in fast trains, speeding bullets, 
and tall buildings.  This entirely new metal is cheaper, lighter, and stronger than any other 
known type of steel or alloy; Rearden Metal is a product that transforms the world.  Once 
again, rolling forward a couple of generations and modernizing the names, if Ayn Rand 
were to replace the key productive technology of 1950s America with that of early twenty-first century America, she would probably choose to write about databases.  Her hero, Larry 
Rearden, would be a rugged individualist running a database corporation that creates 
cutting-edge products used throughout the world in a thousand different industries.  
Remind you of anyone?</p>

<p>We think Oracle and Perl work together so well because they were both created by 
incredible individuals for other individual businesses, individual Oracle DBAs, and 
individual Perl programmers.  With both there are no imposed limits, and just as much help 
as you might need, from either <a href="http://technet.oracle.com">Oracle support</a>, or the worldwide <a href="http://www.perl.com">Perl community</a>.  And of course, <i>Perl for Oracle DBAs</i>.</p>
















<h3>The Perl DBA Toolkit</h3>

<p>To take advantage of this synergy between Perl and Oracle in our toolkit, we've blended the 
two streams together into four key DBA areas.  These are password serving, the 
performance of routine DBA tasks, the monitoring of the database, and the building of a 
database repository for informational time-traveling.</p>

<p>The completed Perl DBA Toolkit scripts described below in Table 2 allow it to work 
securely around a network without clear passwords being passed around, thereby enabling 
you to have one toolkit point of control for all of your databases, no matter where they're 
located.</p>

<!--prod: pls see Word doc for table formatting-->

<div align="center"><h4>Table 2. Password serving</h4></div>

<table cellpadding="2" cellspacing="2" border="1">
<tr>
<th>Script</th>
<th>Description</th>
</tr>

<tr>
<td><code>pwd.pl</code></td>
<td>Password server daemon that encrypts passwords via a TCP socket; 
works remotely with the other Perl scripts via the toolkit module set.</td>
</tr>

<tr>
<td><code>pwc.pl</code></td>
<td>Client that remotely retrieves encrypted passwords from the password 
server, easing the secure database access overhead imposed by other 
scripts. </td>
</tr>

<tr>
<td><code>pwd_service.pl</code></td>
<td>Installs the password server as a daemon (on Unix) or service (on 
Win32).</td>
</tr>

</table>
<!--end table data-->

<p>The scripts in Table 3 perform a wide variety of DBA tasks, including the creation of new 
users from the command line, the creation of new users via duplicated accounts, and the 
creation of multiple accounts with automatically mailed passwords.  They also cover the 
maintenance of indexes, the killing of sniped database sessions, the management of extent 
usage, and the extraction of DDL and data for SQL*Loader transfer.</p>

<div align="center"><h4>Table 3. Routine database administration</h4></div>

<table cellpadding="2" cellspacing="2" border="1">
<tr>
<th>Script</th>
<th>Description</th>
</tr>

<tr>
<td><code>ddl_oracle.pl</code></td>
<td>Generates the DDL necessary to recreate schemas, tables, indexes, 
views, PL/SQL, materialized views, and other objects.</td>
</tr>

<tr>
<td><code>sqlunldr.pl</code></td>
<td>Dumps entire schemas to comma-delimited files and generates the 
SQL*Loader scripts necessary to reload them. Also dumps LONG RAW 
and BLOB objects, converting them to hex format via the Oracle 
HEX_TO_RAW function in the SQL*Loader control file in order to 
convert the data back into binary format.</td>
</tr>

<tr>
<td><code>create_user.pl</code></td>
<td>Creates Oracle users from the command line. You can create a user and 
assign passwords, tablespaces, and privileges, all with one easy 
command-line call. Best of all, you can use this script to pre-configure 
different groups of runtime privileges.</td>
</tr>

<tr>
<td><code>drop_user.pl</code></td>
<td>Drops a database user by first dropping all of their tables and indexes 
before dropping the account. Doing so avoids most of the resource-
intensive SQL recursion incurred when dropping an account containing 
many tables and indexes.</td>
</tr>

<tr>
<td><code>dup_user.pl</code></td>
<td>Duplicates an account, with the source user's system privileges, object 
privileges, roles, and quotas assigned directly to the target user.</td>
</tr>

<tr>
<td><code>mucr8.pl</code></td>
<td>When creating a large number of users, this utility creates them all with 
a single operation. Configurable permissions are granted, and the 
passwords automatically generated get emailed back to the new account 
owners.</td>
</tr>

<tr>
<td><code>kss.pl</code></td>
<td>Kills sniped sessions (which are lapsed sessions on busy databases 
consuming unnecessary memory resource).</td>
</tr>

<tr>
<td><code>kss_NT.pl</code></td>
<td>Win32 version of kss.pl.</td>
</tr>
<tr>

<td><code>kss_service.pl</code></td>
<td>Used to create an appropriate snipe killing service on Win32.</td>
</tr>

<tr>
<td><code>idxr.pl</code></td>
<td>Determines if an index should be rebuilt and, if so, rebuilds it. Checks 
on a per-schema basis, and is configured to check indexes based on days 
since the index was last analyzed.  A configurable time limit is imposed, 
which allows index rebuilds to fit within a predefined time schedule.</td>
</tr>

<tr>
<td><code>maxext.pl</code></td>
<td>Monitors the size and number of extents in tables and indexes. If they're 
nearing a maximum allowed or if the object will be unable to extend 
because of limited free space, it notifies the DBA. This script is most 
useful for databases that use dictionary-managed extents.</td>
</tr>


</table>


<p>Table 4 lists our remote monitoring scripts, which help to maximize the availability of your 
databases by alerting you to both error conditions reported in the Oracle alert log and to 
problems with database connectivity.  Some of them can even phone you up.</p>

<div align="center"><h4>Table 4.  Database monitoring</h4></div>

<table cellpadding="2" cellspacing="2" border="1">
<tr>
<th>Script</th>
<th>Description</th>
</tr>

<tr>
<td><code>chkalert.pl</code></td>
<td>Daemon that monitors Oracle alert logs for error conditions and 
notifies the DBA via either email messages or pager calls.  Oracle's 
alert.log files contain important error messages as well as a log of 
database startup and shutdown messages.</td>
</tr>

<tr>
<td><code>chkalert_NT.pl</code></td>
<td>Win32 version of chkalert.pl.</td>
</tr>

<tr>
<td><code>chkalert_service.pl</code></td>
<td>Utility script that creates a Win32 service for chkalert_NT.pl.</td>
</tr>

<tr>
<td><code>dbup.pl</code></td>
<td>Working alongside chkalert.pl, a highly configurable database 
connectivity monitor that checks to see if databases are up and 
available.</td>
</tr>

<tr>
<td><code>dbup_NT.pl</code></td>
<td>Win32 version of dbup.pl.</td>
</tr>

<tr>
<td><code>dbup_service.pl</code></td>
<td>Creates the Win32 service for dbup_NT.pl.</td>
</tr>

<tr>
<td><code>dbignore.pl</code></td>
<td>Utility script used with dbup.pl to temporarily disable connectivity 
checks on an individual database (e.g., while maintenance is being 
performed).</td>
</tr>

</table>


<p>Table 5 summarizes what we've called repository scripts. These compare different database 
schema versions over time, detecting database changes (official or otherwise).  They also 
store SQL execution plans within a library cache to allow comparison between current execution plans and plans previously collected; this way, the scripts can report on changed 
execution plans and the reasons behind the changes.</p>

<div align="center"><h4>Table 5.  Repository and DDL "time travel"</h4></div>

<table cellpadding="2" cellspacing="2" border="1">
<tr>
<th>Script</th>
<th>Description</th>
</tr>

<tr>
<td><code>baseline.pl</code></td>
<td>Creates the baseline for the PDBA repository, establishes "time travel" 
control of DDL (Data Definition Language), and stores the entire database 
structural change record across time boundaries.</td>
</tr>

<tr>
<td><code>spdrvr.pl</code></td>
<td>Perl driver for SQL*Plus that reports on information created by baseline.pl.</td>
</tr>

<tr>
<td><code>sxp.pl</code></td>
<td>Collects and stores SQL statements from the data dictionary and generates 
accompanying execution plans for later comparison with other plans.</td>
</tr>

<tr>
<td><code>sxpcmp.pl</code></td>
<td>Examines the current SQL statements, generating execution plans.</td>
</tr>

<tr>
<td><code>sxprpt.pl</code></td>
<td>Generates reports based on the stored SQL and execution plans.</td>
</tr>

</table>


<h3>Perl Philosophy</h3>

<p>There is something else that makes Perl different from other computer languages, which may 
move it closer towards the rugged individualists of American business; it has three major 
philosophical virtues.  And so does Objectivism.  Coincidence?  I'll leave it to you to decide 
whether the two sets of virtues below are in any way related:</p>

<p>The three great virtues of the Perl programmer, as originally defined by Larry Wall, are: 
Laziness, the quality that makes you write labor-saving programs to increase productivity; 
Impatience, the injustice you feel when applications are inefficient, which makes you write clever programs to anticipate your needs, and Hubris, the pride that makes you create great 
solutions, which others will say only good things about.</p>

<p>The three cardinal virtues of Objectivist ethics are:  <i>Purpose</i>, the recognition that productive work is how man's mind sustains his life; <i>Reason</i>, the use of rationality as the only guide to considered action and wealth creation, and <i>Self-Esteem</i>, the recognition that as man is a being of self-made wealth, it is this route through which he can acquire the pride of the self-made soul.</p>

<p>Ayn Rand's life works were about wealth creation, and the individual.  However they were 
not just about money.  They were also about any form of wealth or ideas creation, where 
wealth is the product of one person's mind.  And with the Perl Artistic License copyright, it is 
clear the wealth of Perl was created and is owned by Larry Wall.  Although he decides to 
give it away, this is entirely his right.  Perl even possesses its own culture of freedom, 
reflected in the Perl catch phrase TMTOWTDI--There's More Than One Way To Do It--
and its own free-trade area, the Comprehensive Perl Archive Network, or <a href="http://www.cpan.org">CPAN</a>.  This is where thousands of worldwide Perl developers swap modules, in exchange for respect from the rest of Perl society.  Indeed, the respect 
that Larry Wall has duly earned is priceless.  He may remain unable to buy MiG jets with it, 
but it still makes him a major keynote speaker at technology conferences, just like our other 
shrugging Atlas in this article, Larry Ellison.</p>



<p>In following this established Perl philosophy, we've created our toolkit as an entirely open 
source project.  We'll wait and see how it develops, but we're looking forward to your 
comments and suggestions on how it can be further improved to meet your own specialized 
requirements; we're hoping it will match the runaway 
success of Steve Feuerstein's <a href="http://oracle.oreilly.com/utplsql/">utPLSQL project</a>.</p>

<h3>The Sign of the Dollar</h3>

<p>The Two Larrys are both free men of the mind who live on two sides of the same coin.  They 
have created between them two of the world's great American productive inventions, Perl 
and Oracle, which work well together because they arise from the same 
intellectual substrate.  Without the pioneering work of both Wall and Ellison, 
the world would be both spiritually and materially poorer. And
here's a final thought. For those who've read <i>Atlas Shrugged</i>, you'll know the basic value 
symbol of the free men of the mind; it was a golden dollar symbol.  
And by a bizarre twist in our tale, every Perl script ever written is full of basic value 
variables, each preceded by a dollar symbol.  Another coincidence?  Possibly.  But more 
bizarrely, if you take a vinyl copy of John Lennon's 1970s anthem, "Imagine," and play it 
backward, it says "Perl for Oracle DBAs."  No kidding.</p>

<p>(If you'd like to learn more about Ayn Rand's work, check out this <a href="http://www.aynrand.org/">Web site</a>.) </p>







        </div>



    </div>
    <div class="asset-footer"></div>
</div>


                            
                            <div id="entry-1364" class="entry-asset asset hentry">
    <div class="asset-header">
        <h2 class="asset-name entry-title"><a href="/pub/2002/09/p6pdigest/20020901.html" rel="bookmark">This week on Perl 6 (8/26 - 9/1, 2002)</a></h2>
        <div class="asset-meta">
            <span class="byline">
    
                By <span class="vcard author">Piers Cawley</span> on <abbr class="published" title="2002-09-01T00:00:00-08:00">September  1, 2002 12:00 AM</abbr>
    
            </span>

            
            

        </div>
    </div>
    <div class="asset-content entry-content">

        <div class="asset-body">
            
<!-- INDEX END -->
<p>Well, it has been a week. Damian came to London and made our heads spin;
perl6-language erupted in a flurry of interesting, high signal/noise
threads; Parrot reached its 0.0.8 release; Larry made many of his
wonderfully unexpected but obviously <em>right</em> interjections and the
world kept on turning.</p>
<p>So, we'll kick off with perl6-internals as usual.</p>

<h3><a name="dod_etc">DOD etc</a></h3>
<p>The 'elimination of garbage collection hand waving' thread continued as
Nicholas Clark asked a hard question about garbage collection and dead
object detection (DOD). As far as Nick could tell, it seems that 'if
we have unrefcounted &quot;deterministic destruction&quot; objects somewhere
freely in the GC system, then we'll be needing a DOD run after every
statement' and he noted that 'all ways of doing deterministic
destruction seem to have considerable overhead.' Sean O'Rourke
wondered whether we could use a hybrid 'full GC + refcounts where needed'
scheme, but Juergen Boemmels pointed out that refcounting would be
contagious. Anything that contained a reference to a refcounted
object would need to be refcounted in its turn.</p>
<p>Meanwhile, Mike Lambert wondered why we needed to promise deterministic
destruction in the first place and proposed a couple of schemes to
deal with the canonical 'filehandle' case. Sean O'Rourke and Steve
Fink both came forward with cases where deterministic destruction
proved useful, and where Mike's scheme didn't really work. And that's
where the thread came to rest. I have the feeling that it, or a thread
like it, will be back.</p>



<p><a href="http://makeashorterlink.com/?K11642DA1">http://makeashorterlink.com/</a></p>


<h3><a name="dynamic_keys">Dynamic Keys</a></h3>
<p>Tom Hughes, who has been doing good work on keyed access wondered
about dealing with dynamic keys, and proposed a way forward. Dan asked
whether Tom had looked at the proposed ops in PDD06, and pointed out
that dynamic keys didn't necessarily need to go the whole PMC
hog. 'They're our internal structures -- we can screw with them as we
need :)'. Tom pointed out a few issues with the PDD06 op set, and
proposed a few more ops with a (hopefully) consistent naming
scheme. So far he's had no answer to the questions he raised in that
post.</p>
<p><a href="http://makeashorterlink.com/?P12621DA1">http://makeashorterlink.com/</a></p>


<h3><a name="perl6_test_failures">Perl6 Test Failures</a></h3>
<p>Steve Fink wondered about all the test failures he keeps seeing for
Perl 6; he doesn't want to go trying to make a language neutral regex
engine play nicely with the Perl6 engine when that engine is in such a
state of flux. Sean O'Rourke suggested nailing down some calling
conventions and then both teams could code to those conventions. Steve
pointed out that, so far, he knows of at least five attempts at a regex engine in parrot. Leopold Toetsch suggested that Steve try the tests again, forcing a grammar rebuild, and the test failures got all better.</p>
<p><a href="http://makeashorterlink.com/?R23631DA1">http://makeashorterlink.com/</a></p>


<h3><a name="regex_status">Regex status</a></h3>
<p>On Wednesday, Dan wondered where we were with Apocalypse/Exegesis 5
compatible patterns/rules/regexes. Sean O'Rourke told him. (Answer:
Still some way to go, but making good speed.)</p>
<p><a href="http://makeashorterlink.com/?U14651DA1">http://makeashorterlink.com/</a></p>


<h3><a name="counting_down_to_0.0.8">Counting down to 0.0.8</a></h3>
<p>On Thursday, Jeff Goff posted his timetable for 0.0.8, 'Octarine'
release of Parrot, complete with a 25-hour code freeze. Markus
wondered whether using a GMT timetable might be more friendly for everyone
who wasn't on the East Coast of the United States. Parrot actually saw
release Monday, Sept. 2, which is slightly outside the
scope of this summary, but I'll let it sneak in anyway.</p>
<p><a href="http://makeashorterlink.com/?Z55612DA1">http://makeashorterlink.com/</a></p>
<p><a href="http://makeashorterlink.com/?A16623DA1">http://makeashorterlink.com/</a></p>


<h3><a name="an_'oops'_moment.">An 'Oops' Moment</a></h3>
<p>Leopold Toetsch found an interesting bug with the GC system
interacting with initialization. <em>examples/life.ar.p6</em> is a Perl6
implementation of Conway's Life, which has a rather lengthy
initialization phase, after which it checks the <code>@ARGS</code> array, which
is conventionally placed in <code>P0</code> at startup. But there's a catch. By
the time it comes to make the check, <code>@ARGS</code> has been garbage
collected. Peter Gibbs posted a quick fix patch, and Mike Lambert
stuck his hand up to being a 'lazy bum,' but reckoned that Steve
Fink's fixes should solve the problem.</p>
<p><a href="http://makeashorterlink.com/?U27631DA1">http://makeashorterlink.com/</a></p>


<h3><a name="various_changes_to_imcc">Various changes to IMCC</a></h3>
<p>Whilst 'idly toying' with IMCC, Steve Fink made a bunch of speculative
changes, bundled 'em up in a patch and offered them to the list. I'm
not sure what people thought of the changes, but the thread morphed
into a discussion of generating conditional makefiles and making sure
that IMCC and the other tools needed to get the Perl6 compiler working
were as portable as possible. Mike Lambert pointed out that it may
make sense to have the files generated by bison/flex checked directly
into the repository, since then those tools wouldn't be needed except
by people who go messing with the grammar.</p>
<p><a href="http://makeashorterlink.com/?F28652DA1">http://makeashorterlink.com/</a></p>


<h3><a name="concatenation_failing">Concatenation Failing</a></h3>
<p>Leon Brocard (phew, I was worried I was going to have to run his
questionnaire this week) found a bug where concatenation fails
occasionally, leaving no clues as to why. He attached some sample code
that illustrates the problem. Peter Sinnott noted that Parrot seems
to be getting confused about the length of the strings involved. Meanwhile, Peter
Gibbs offered a patch and Mike Lambert reckoned it fixed a
bug in his code, but couldn't for the life of him work out why. Peter
reckons it has to do with <code>unmake_COW</code> resizing the allocation and
causing confusion elsewhere. I get the feeling that what we have now
is a 'symptomatic' fix in search of a fix for an underlying issue. But
I'm just a summarizer.</p>
<p>Markus Laire found what he thinks might be another bug, but I've no
idea if it's fixed by Peter Gibbs' patch.</p>
<p><a href="http://makeashorterlink.com/?N69623DA1">http://makeashorterlink.com/</a></p>
<p><a href="http://makeashorterlink.com/?V3A623DA1">http://makeashorterlink.com/</a></p>


<h3><a name="irix64_alignment_problem">IRIX64 alignment problem</a></h3>
<p>Steven McDougall chased down a bug causing <em>t/pmc/perlhash.t</em> to
throw a bus error, but wasn't at all sure how to go about fixing it,
and asked for advice. Bryan C. Warnock offered a few pointers, as did
Peter Gibbs, but we don't have a fix yet.</p>
<p><a href="http://makeashorterlink.com/?M3B615DA1">http://makeashorterlink.com/</a></p>



<h3><a name="meanwhile,_in_perl6language">Meanwhile, in perl6-language</a></h3>


<h3><a name="prototypes,_grammars_and_subs,_oh_my!">Prototypes, grammars and subs, oh my!</a></h3>
<p>Thom Boyer wondered what <code>while</code>'s signature would be. He'd
considered <code>sub while (bool $test, &amp;body);</code> and <code>sub (&amp;test,
&amp;body);</code> but neither really fit. Larry agreed and offered</p>
<pre><code>
    sub while (&amp;test is expr, &amp;body);</code></pre>
<p>and then, reaching deeper into his bag of tricks, he pulled out the
wonderful/scary</p>
<pre><code>
    sub while (&amp;test is rx/&lt;expr&gt;/, &amp;body);</code></pre>
<p>(Think about that for a moment. What is proposed that you'll be able
to specify a grammar for your functions argument list, which is
definitely something that made <em>me</em> sit up and take notice.) Damian
sat up and took notice, too, offering some refinements and doing some
thinking aloud. Damian suggested that maybe the prototype should look
like <code>sub while ( &amp;test is specified(/&lt;Perl.expr&gt;/), &amp;body);
&gt;&gt;. Damian also suggested blurring the line still further between
statements and expressions by having the likes of C&lt;for&gt;</code> return a
value, and had some thoughts on multimethods. Trey Harris also offered
some more comments on multimethods.</p>
<p>All of which leaves me looking forward with bated breath for
Apocalypse 6.</p>
<p>Quote of the thread: &quot;The whole point of making Perl 6 parse itself
with regexes is to make this sort of stuff easy.&quot; -- Larry</p>
<p><a href="http://makeashorterlink.com/?H1C632DA1">http://makeashorterlink.com/</a></p>
<p><a href="http://makeashorterlink.com/?E1D623DA1">http://makeashorterlink.com/</a></p>
















<h3><a name="rule,_rx_and_sub">Rule, rx and sub</a></h3>
<p>Deborah Ariel Pickett summarized the state of her understanding of the
difference between <code>rule</code> and <code>rx</code> and wondered if there was any
case where</p>
<pre><code>
    ... rule ...</code></pre>
<p>and 
    ... rx ...</p>
<p>(given the same <code>...</code>s in both cases), lead to valid, but different
semantics. Uri Guttman thinks not. Damian thinks so, and provided an
example. (It was joked, on the London.pm mailing list (by Damian
himself) that Damian is currently our only real, live Perl6
interpreter.). Luke Palmer raised a red flag about Damian's example;
Damian thinks it wasn't a red flag, but left it to Larry to
adjudicate. This also provoke a certain amount of discussion about the
philosophy behind some of the design decisions so far.</p>
<p>Glenn Linderman wondered whether <code>rx</code> shouldn't be respelled, as the term
'regex' is being deprecated. Damian suggested that <code>rx</code> actually
stood for 'Rule eXpedient', but I'm not sure he convinced anyone
(himself included). Ever the linguist, Larry observed that 'we can
tweak what people mean by &quot;regular expression&quot;, but there's no way on
earth we can stop them from using the term.' and that, no matter how
many editions it goes through, Friedl's book is always going to be
called <em>Mastering Regular Expressions</em>. So, Larry is 'encouraging use
of the technical term &quot;regex&quot; as a way to not precisely mean &quot;regular
expression&quot;.'</p>
<p>Piers Cawley raised a question about when <code>}</code> terminates a
statement and got it wrong. This subthread led to a short discussion
on good Perl 6 style. Damian told us that 'Any subroutine/function
like <code>if</code> that has a signature that ends in a <code>&amp;sub</code> argument can be
parsed without the trailing semicolon', which I don't remember seeing
in any Apocalypse. This led to a discussion about what was legal in a
prototype specifier, ending when Larry told us that it'd be possible
to specify a grammar as a function's prototype.</p>
<p><a href="http://makeashorterlink.com/?G3F656DA1">http://makeashorterlink.com/</a></p>
<p><a href="http://makeashorterlink.com/?C10753DA1">http://makeashorterlink.com/</a></p>
<p><a href="http://makeashorterlink.com/?V21742DA1">http://makeashorterlink.com/</a></p>
<p><a href="http://makeashorterlink.com/?C22751DA1">http://makeashorterlink.com/</a></p>


<h3><a name="auto_deserialization">Auto deserialization</a></h3>
<p>At the root of what turned into a large thread, Steve Canfield asked a
deceptively simple question: '[Will] code like this Do What I Mean:
<code>my Date $bday = 'June 24, 2002'</code>'? We weren't entirely sure what
he meant by that...</p>
<p>The thread was long, and pretty much unsummarizable, but we ended up
with the rather pleasant looking <code>my Date $date .= new('Jun 24,
20002')</code>, the idea being that, because <code>$date</code> is known to be a
<code>Date</code>, even if it's undefined, then it's possible to make a static
method call on it. The response to this suggestion spilt over into
the next week, but 'favourable' would be a good description of it.</p>
<p><a href="http://makeashorterlink.com/?P23712DA1">http://makeashorterlink.com/</a></p>
<p><a href="http://makeashorterlink.com/?M14721DA1">http://makeashorterlink.com/</a></p>


<h3><a name="hypothetical_synonyms">Hypothetical synonyms</a></h3>
<p>Aaron Sherman wondered if he would be able to write</p>
<pre><code>
    $stuff = $field if m{^\s*[
        &quot;(.*?)&quot;     {let $field = $1} |
         (\S+)      {let $field = $2}]};</code></pre>
<p>Larry thought</p>
<pre><code>
    my $stuff;
    
    m{^\s*[
        &quot;$stuff:=(.*?)&quot; |
         $stuff:=(\S+)
    ]};</code></pre>
<p>was a better way of doing it, saying that he saw no 'particular reason
why a top-level regex can't refer to variables in the surrounding
scope, either by default, or via a :modifier of some sort.'</p>
<p>Uri Guttman, in possibly the first ever Perl 6 golf post (he denies
it's really golf), suggested a way of shortening the pattern further,
and Larry trumped him by shortening it to <code>my $field =
/&lt;shellword&gt;/</code>, which led Nicholas Clark to wonder about oneliners
along the lines of <code>my $data = /&lt;xml&gt;/</code> and wondered if the Perl
regex engine would be faster than using <code>expat</code>. Nick also wondered
if Perl 6 would give shorter golf solutions than Perl 5.</p>
<p>There was quite a bit more in this thread, but my summarizing skills
are failing.</p>
<p><a href="http://makeashorterlink.com/?X15721DA1">http://makeashorterlink.com/</a> -- Thread starts here, it's jolly
good.</p>


<h3><a name="does_:::_constrain_the_pattern_engine_implementation">Does ::: constrain the pattern engine implementation</a></h3>
<p>Deven T. Corzine wondered if the presence of <code>:::</code> and friends in the
pattern language meant we'd constrained the possible implementation of
the pattern engine before we'd started, and if we could implement
something that didn't do backtracking. General opinion seemed to be
that we couldn't avoid backtracking, but Deven wondered if it wouldn't
be possible to use a non backtracking implementation for some special
cases. The consensus appears to be 'If you build it, and it's faster,
we will come'.</p>
<p><a href="http://makeashorterlink.com/?N16733DA1">http://makeashorterlink.com/</a></p>


<h3><a name="backtracking_into_{_code_}">Backtracking into <code>{ code }</code></a></h3>
<p>Ken Fox wondered if</p>
<pre><code>
  rule expr1 { &lt;term&gt; { /@operators/ or fail } &lt;term&gt; };</code></pre>
<p>and</p>
<pre><code>
  rule expr2 { &lt;term&gt; @operators &lt;term&gt; }</code></pre>
<p>were equivalent. Damian thought not, and added that <code>expr1</code> should
probably be rewritten as <code>rule expr1 { &lt;term&gt; { m:cont/@operators/
or fail } &lt;term&gt; }</code>. Larry says that we <em>will</em> backtrack into
subrules.</p>
<p>Again, the whole thread is worth reading if you're interested in the
rules/patterns/regex engine.</p>
<p><a href="http://makeashorterlink.com/?D67741DA1">http://makeashorterlink.com/</a></p>


<h3><a name="prebinding_questions">Prebinding questions</a></h3>
<p>Philip Hellyer asked a bunch of questions sparked by Damian's talk
about Perl 6 to London.pm (at the Conway Hall no less, London.pm knows
how to find appropriate venues). Damian answered them.</p>
<p><a href="http://makeashorterlink.com/?E38721DA1">http://makeashorterlink.com/</a></p>


<h3><a name="@array_=_%hash"><code>@array = %hash</code></a></h3>
<p>Nicholas Clark noted that <code>@array = %hash</code>, for a hash of n elements
would return an array of n pairs. The Perl5 style, returning a list of
2n elements, keys and values interleaved would be <code>@array =
%hash.kv</code>. All this led Nick to wonder what happened in the other
direction. Obviously <code>%hash = @list_of_pairs</code> was going to do the
right thing, but what about <code>%hash = @kv_array</code>. And, more
worryingly, what about</p>
<pre><code>
   %hash = (&quot;Something&quot;, &quot;mixing&quot;, pairs =&gt; &quot;and&quot;, &quot;scalars&quot;);</code></pre>
<p>It turns out that the <code>@kv_array</code> case will Just Work, and the last
case will cause discussion to break out. Damian thought that the
example above would throw an error because there are 5 elements in the
list. Another school thought that, because PAIRs are first class
objects in Perl 6, the code should work, with one of the keys of the
hash being the pair <code>(pairs =</code> 'and')&gt;. Damian thought not, and
discussion ensued. I'm afraid I'm not entirely well qualified to
summarize this thread as I'm one of those who thinks Damian is wrong,
or at least, not yet sufficiently correct. However, for now, the state
of the design is such that pairs are 'special' and it takes an effort
of compile time will to use them as keys (or values come to that) in
a hash.</p>
<p><a href="http://makeashorterlink.com/?G19752DA1">http://makeashorterlink.com/</a></p>


<h3><a name="regex_stuff">Regex stuff</a></h3>
<p>Choosing a deliberately vague subject line in an effort to give the
summarizer a headache, Piers Cawley asked a question about binding to
numeric hypotheticals. It turns out that binding to a numeric
hypothetical variable in a regular expression is special cased
(resetting the numeric 'counter') and even mentioned in the
appropriate apocalypse, and the problem that Piers thought he saw
doesn't actually exist.</p>
<p><a href="http://makeashorterlink.com/?G6A752DA1">http://makeashorterlink.com/</a></p>


<h3><a name="atomicness_and_\n">Atomicness and \n</a></h3>
<p>Aaron Sherman wondered what <code>\n</code> would be translated to in a Perl 6
pattern. Aaron proposed <code>&lt;[\x0a\x0d...]+&gt;</code>. Damian thought it was
<code>&lt;[\x0a\x0d]&gt;</code>, and Ken Fox thought it would be something like
<code>\0xd \0xa | \x0d | \x0a</code>. Personally I think it'll be <code>[ \0xd
\0xa | &lt;[\x0a\x0d...]&gt; ]</code>. (I also believe that whoever came up with
the idea of a two character end of line marker should be taken out and
shot, but that's another story entirely).</p>
















<h3><a name="the_news_from_london">The news from London</a></h3>
<p>On Thursday Damian managed to deliver his Perl 6 prospectus talk in
about 3.5 hours. Okay, it <em>sounds</em> like a long time, but Damian told
us that, on average, the talk runs to 5 hours. The 'one question' rule
introduced by London.pm seems to have worked well. As predicted a
whole load of lights went on over peoples heads as they started to
'get' how the whole thing hung together.</p>
<p>Anyway, the one question rule led to a bunch of questions about Perl 6
cropping up on the London.pm mailing list that haven't (yet) been
cross posted to perl6-language. One interesting question concerned
what happens when bare/if/while/do/when/etc blocks have <code>return</code> in
them. Damian answered that they throw a 'return' control exception,
which the control structure catches and re-throws. Piers wondered how
you'd go about writing your own looping construct and made a couple of
proposals about the treatment of control exceptions.</p>
<p>Quote of the London.pm threads: 'yImoj Perl javDIch!' which, as
everyone knows, is the Klingon for 'Be Perl6. Now!'.</p>
<p><a href="http://makeashorterlink.com/?Y3B721DA1">http://makeashorterlink.com/</a></p>
<p><a href="http://makeashorterlink.com/?E2C752DA1">http://makeashorterlink.com/</a></p>


<h3><a name="call_for_assistance">Call for assistance</a></h3>
<p>Next week is the Zurich Perl 6 mini conference, and I won't be
there. Soon after that is YAPC::Europe 2002, and I won't be there
either. This week, Damian is in Belfast and will be talking to
Belfast.pm about stuff, guess what, I'm not there either. If anyone
would like to send me some Perl 6 related reports for the summary from
any of these events I would be <em>enormously</em> grateful. Thanks in
advance.</p>


<h3><a name="squashing_a_myth">Squashing a myth</a></h3>
<p>You may have come across the 'Damian Conway is looking for graduate
students' meme. I know I have, and I repeated it at one of Damian's
talks in London. Guess what, it's not true (as I should have
realised). Damian is no longer associated with any institute of higher
learning and is not looking for graduate students. Kindly readjust
your memeplexes.</p>



<h3><a name="in_brief">In Brief</a></h3>
<p>Pete Sergeant pointed us all at some work he'd done toward building
an 'operations dictionary' for Parrot. Available at
<a href="http://grou.ch/parrot/index.cgi">http://grou.ch/parrot/index.cgi</a>.</p>
<p>Over the course of a surprisingly long thread, Steve Lambert, Markus
Laire and Leopold Toetsch and a few of the usual suspects got IMCC and
Perl6 compiling properly with Windows.</p>
<p>Bryan C. Warnock offered a large patch to parrot's <em>glossary.pod</em>; a
document worth reading. Bryan also PODified byteorder.dev so it would
show up correctly on <a href="http://www.parrotcode.org/docs/">http://www.parrotcode.org/docs/</a>. Bryan also
added POD title blocks to a pile of PODs. Kudos to the docmonster.</p>
<p>Daniel Grunblatt added conditional breakpoints and watchpoints to the
Parrot Debugger. Steve Fink also waved a magic wand over the debugger
and fixed up a bunch of problems. Well done chaps.</p>
<p>Andy Dougherty wondered about how up to date MANIFEST is. There were
497 files listed in MANIFEST, but a fresh CVS checkout runs to 2215
files. Daniel Grunblatt thinks he's added all the important files to
MANIFEST.</p>
<p>Sean O'Rourke made some big changes to IMCC; newlines within statements
are no longer allowed, and there's been some 'significant changes to
register allocation and spilling.'</p>
<p>Bryan C. Warnock wondered about the file permissioning inconsistency in
the parrot source tree. Andy Dougherty pointed out that it wasn't
(quite) as inconsistent as it looked; build scripts should be left
without execute bits so that makefile authors would use the more
portable <code>$(PERL) script.pl</code>, which makes no assumptions about
the whereabouts of perl.</p>
<p>Peter Gibbs offered a <em>huge</em> patch, merging his 'African Grey' parrot
tweaks with the CVS parrot. It's not been applied in CVS, but
<a href="http://makeashorterlink.com/?O1D741DA1">http://makeashorterlink.com/</a> has the details.</p>
<p>Jason Gloudon wondered about temporary PMCs used in opcodes like <code>&lt;
ADD Px, Py, Pz </code>&gt;, and wondered what <code>set_pmc</code> should do in the
simple case. Sean O'Rourke pointed out that often one wouldn't need to
create transient PMCs because one could use the specialist string and
number registers to hold the temporaries. Sean voted for 'morph' in
the simple <code>set_pmc</code> case.</p>
<p>Jonathan Sillito contributed a patch allowing for hierarchical lookup
of lexical variables in scratchpads, and which makes subroutines into
real closures (by virtue of the hierarchical lookup up of lexical
variables...). Warnock's Dilemma applies...</p>
<p>Andy Dougherty did some cleaning up of the build process, removing
lint and cruft from the Makefiles and Configure.pl. Hmmm... I wonder
how far we are from our goal of 'compile a miniparrot, use that to
execute the more advanced config script, and then compile the full
parrot', and removing the dependency on Perl to build parrot...</p>
<p>Now that we have ICU in the repository Angel Faus wondered how we
should deal with differently encoded strings. No answers yet.</p>
<p>Andy Dougherty wondered if the time had come to make IMCC build with
plain old yacc and lex instead of depending on bison and flex. Leopold
Toetsch reckoned that that would be a good idea and asked Andy for his
patches.</p>
<p>Leopold found a bug in <code>mul</code>, <code>div</code>, <code>mod</code>, <code>sub</code>, <code>concat</code> when
operating on PMCs. So he fixed it. I'm not sure if the patch has been
applied.</p>
<p>J&uuml;rgen B&ouml;mmels got fed up with <em>MANIFEST</em> not being
accurate. So he wrote an automated test which compares the <em>MANIFEST</em>
with <em>CVS/Entries</em> and complains if they don't match. I don't know if
it's been checked in yet, but when it does, let's hope the committer
remembers to update the manifest.</p>
<p>Steve Fink has a patch which stops Configure.pl touching files unless
they've actually changed, and wondered if it would be of any use to
people not actually working on Configure. Nicholas Clark took the
opportunity to point us at <a href="http://ccache.samba.org/">http://ccache.samba.org/</a>.</p>
<p>Steve Fink also submitted a flurry of clean up patches, many of which
look like they'll get applied once 0.0.8 has been released.</p>
<p>Dan noted that Hashes are an order of magnitude slower to GC than, say
PerlStrings, and two orders of magnitude slower than PerlInts. Which
isn't good. Dan wondered if there might be a way to get less GC
overhead. Steve Fink offered a few suggestions.</p>
<p>':/::/:::/&lt;commit&gt; makes backtrack fail current
atom/group/rule/match.' -- Markus Laire summarizes the various
backtracking assertions.</p>



<h3><a name="who's_who_in_perl_6">Who's who in Perl 6</a></h3>
<dl>
<dt><strong><a name="item_who_are_you%3f">Who are you?</a></strong><br />
</dt>
<dd>
Miko (pronounced &quot;Mike-Oh&quot;) O'Sullivan, Father of Melody, Husband of
Starflower, Follower of Jesus, Author of The Idocs Guide to HTML
</dd>


<dt><strong><a name="item_what_do_you_do_for%2fwith_perl_6%3f">What do you do for/with Perl 6?</a></strong><br />
</dt>
<dd>
Participate in perl6-language, generally by suggesting small
features that I think would make life a lot easier for programmers.
</dd>


<dt><strong><a name="item_where_are_you_coming_from%3f">Where are you coming from?</a></strong><br />
</dt>
<dd>
I come from the perspective that a) I want things to just work without a
lot of startup effort on my part b) I believe that things can in fact
actually do that c) Perl does d) Perl can do so even more e) I'm pretty
normal in these feelings.  Oh, also Blacksburg, VA, USA.
</dd>


<dt><strong><a name="item_when_do_you_think_perl_6_will_be_released%3f">When do you think Perl 6 will be released?</a></strong><br />
</dt>
<dd>
Put me down for June 6, 2003, 1:37:03 am EST.
</dd>


<dt><strong><a name="item_why_are_you_doing_this%3f">Why are you doing this?</a></strong><br />
</dt>
<dd>
I'm sort of like a Lab (i.e. the dog) that instinctively jumps into a
lake: I just must do it.
</dd>


<dt><strong><a name="item_you_have_5_words%2e_describe_yourself%2e">You have 5 words. Describe yourself.</a></strong><br />
</dt>
<dd>
Impatient.
</dd>


<dt><strong><a name="item_do_you_have_anything_to_declare%3f">Do you have anything to declare?</a></strong><br />
</dt>
<dd>
I declare a lot of public static constants.
</dd>

</dl>



<h3><a name="acknowledgements">Acknowledgements</a></h3>
<p>Thanks to Gill for putting up with me last night while I sat and
pretty much ignored everything as I worked on this summary. For some
reason, perl6-language threads are much harder to summarize well; I
<em>always</em> take longer to write a summary when that list is busy.</p>
<p>As usual, if you liked this summary, please send money to the Perl
Foundation at <a href="http://donate.perl-foundation.org/">http://donate.perl-foundation.org/</a> to support the
ongoing development of Perl.</p>
<p>This week's summary was funded by the O'Reilly Network, who now pay the
publication fee for the summaries directly to the Perl
Foundation. So, a big thank you to them.</p>



        </div>



    </div>
    <div class="asset-footer"></div>
</div>




                            <div class="content-nav">
                                <a href="/pub/2002/08/">&laquo; August 2002</a> |
                                <a href="/pub/">Main Index</a> |
                                <a href="/pub/archives.html">Archives</a>
                                | <a href="/pub/2002/10/">October 2002 &raquo;</a>
                            </div>


                        </div>
                    </div>


                    <div id="beta">
    <div id="beta-inner">


    
    <div class="widget-what-is-perl widget">
    <div class="widget-content widget-content-what-is-perl">
       Visit the home of the  Perl programming language: <a href="http://www.perl.org/">Perl.org</a
    </div>
</div>
<div class="widget-find-out-more widget-archives widget">
    <div class="widget-content">
        <ul>
            <li><a href="http://www.perl.org/get.html">Download</a></li>
            <li><a href="http://perldoc.perl.org/">Documentation</a></li>
            <li><a href="http://blogs.perl.org/">Perl Bloggers</a></li>
            <li><a href="http://news.perlfoundation.org/">Foundation News</a></li>
        </ul>
    </div>
</div><div class="widget-tcpc widget">
<h3 class="widget-header">Sponsored by</h3>
    <div class="widget-content">
        <a href="http://training.perl.com/" alt="Perl Training" target="_blank"><img src="/i/tcpc.png" width="150" height="50"></a>
    </div>
</div>

<div class="widget-syndication widget">
    <div class="widget-content">
        <ul>
            <li><img src="/mt-static/images/status_icons/feed.gif" alt="Subscribe to feed" width="9" height="9" /> <a href="/pub/atom.xml">Subscribe to this website's feed</a></li>

        </ul>
    </div>
</div>
<div class="widget-archive-monthly widget-archive widget">
    <h3 class="widget-header">Monthly <a href="/pub/archives.html">Archives</a></h3>
    <div class="widget-content">
        <ul>
        
            <li><a href="/pub/2014/02/">February 2014 (1)</a></li>
        
    
        
            <li><a href="/pub/2014/01/">January 2014 (1)</a></li>
        
    
        
            <li><a href="/pub/2013/10/">October 2013 (1)</a></li>
        
    
        
            <li><a href="/pub/2013/01/">January 2013 (1)</a></li>
        
    
        
            <li><a href="/pub/2012/12/">December 2012 (1)</a></li>
        
    
        
            <li><a href="/pub/2012/11/">November 2012 (1)</a></li>
        
    
        
            <li><a href="/pub/2012/10/">October 2012 (2)</a></li>
        
    
        
            <li><a href="/pub/2012/08/">August 2012 (2)</a></li>
        
    
        
            <li><a href="/pub/2012/06/">June 2012 (11)</a></li>
        
    
        
            <li><a href="/pub/2012/05/">May 2012 (18)</a></li>
        
    
        
            <li><a href="/pub/2012/04/">April 2012 (17)</a></li>
        
    
        
            <li><a href="/pub/2012/02/">February 2012 (1)</a></li>
        
    
        
            <li><a href="/pub/2011/12/">December 2011 (1)</a></li>
        
    
        
            <li><a href="/pub/2011/09/">September 2011 (1)</a></li>
        
    
        
            <li><a href="/pub/2011/08/">August 2011 (2)</a></li>
        
    
        
            <li><a href="/pub/2011/06/">June 2011 (1)</a></li>
        
    
        
            <li><a href="/pub/2011/05/">May 2011 (3)</a></li>
        
    
        
            <li><a href="/pub/2011/04/">April 2011 (1)</a></li>
        
    
        
            <li><a href="/pub/2011/03/">March 2011 (1)</a></li>
        
    
        
            <li><a href="/pub/2011/02/">February 2011 (1)</a></li>
        
    
        
            <li><a href="/pub/2011/01/">January 2011 (1)</a></li>
        
    
        
            <li><a href="/pub/2010/11/">November 2010 (1)</a></li>
        
    
        
            <li><a href="/pub/2010/10/">October 2010 (2)</a></li>
        
    
        
            <li><a href="/pub/2010/09/">September 2010 (1)</a></li>
        
    
        
            <li><a href="/pub/2010/08/">August 2010 (3)</a></li>
        
    
        
            <li><a href="/pub/2010/07/">July 2010 (2)</a></li>
        
    
        
            <li><a href="/pub/2010/04/">April 2010 (2)</a></li>
        
    
        
            <li><a href="/pub/2010/03/">March 2010 (4)</a></li>
        
    
        
            <li><a href="/pub/2008/05/">May 2008 (1)</a></li>
        
    
        
            <li><a href="/pub/2008/04/">April 2008 (2)</a></li>
        
    
        
            <li><a href="/pub/2008/03/">March 2008 (1)</a></li>
        
    
        
            <li><a href="/pub/2008/02/">February 2008 (1)</a></li>
        
    
        
            <li><a href="/pub/2008/01/">January 2008 (1)</a></li>
        
    
        
            <li><a href="/pub/2007/12/">December 2007 (2)</a></li>
        
    
        
            <li><a href="/pub/2007/09/">September 2007 (1)</a></li>
        
    
        
            <li><a href="/pub/2007/08/">August 2007 (1)</a></li>
        
    
        
            <li><a href="/pub/2007/07/">July 2007 (1)</a></li>
        
    
        
            <li><a href="/pub/2007/06/">June 2007 (1)</a></li>
        
    
        
            <li><a href="/pub/2007/05/">May 2007 (1)</a></li>
        
    
        
            <li><a href="/pub/2007/04/">April 2007 (1)</a></li>
        
    
        
            <li><a href="/pub/2007/03/">March 2007 (1)</a></li>
        
    
        
            <li><a href="/pub/2007/02/">February 2007 (1)</a></li>
        
    
        
            <li><a href="/pub/2007/01/">January 2007 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/12/">December 2006 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/11/">November 2006 (2)</a></li>
        
    
        
            <li><a href="/pub/2006/10/">October 2006 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/09/">September 2006 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/08/">August 2006 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/07/">July 2006 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/06/">June 2006 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/05/">May 2006 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/04/">April 2006 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/03/">March 2006 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/02/">February 2006 (4)</a></li>
        
    
        
            <li><a href="/pub/2006/01/">January 2006 (4)</a></li>
        
    
        
            <li><a href="/pub/2005/12/">December 2005 (4)</a></li>
        
    
        
            <li><a href="/pub/2005/11/">November 2005 (3)</a></li>
        
    
        
            <li><a href="/pub/2005/10/">October 2005 (2)</a></li>
        
    
        
            <li><a href="/pub/2005/09/">September 2005 (2)</a></li>
        
    
        
            <li><a href="/pub/2005/08/">August 2005 (9)</a></li>
        
    
        
            <li><a href="/pub/2005/07/">July 2005 (8)</a></li>
        
    
        
            <li><a href="/pub/2005/06/">June 2005 (9)</a></li>
        
    
        
            <li><a href="/pub/2005/05/">May 2005 (8)</a></li>
        
    
        
            <li><a href="/pub/2005/04/">April 2005 (7)</a></li>
        
    
        
            <li><a href="/pub/2005/03/">March 2005 (6)</a></li>
        
    
        
            <li><a href="/pub/2005/02/">February 2005 (7)</a></li>
        
    
        
            <li><a href="/pub/2005/01/">January 2005 (6)</a></li>
        
    
        
            <li><a href="/pub/2004/12/">December 2004 (8)</a></li>
        
    
        
            <li><a href="/pub/2004/11/">November 2004 (8)</a></li>
        
    
        
            <li><a href="/pub/2004/10/">October 2004 (5)</a></li>
        
    
        
            <li><a href="/pub/2004/09/">September 2004 (9)</a></li>
        
    
        
            <li><a href="/pub/2004/08/">August 2004 (6)</a></li>
        
    
        
            <li><a href="/pub/2004/07/">July 2004 (8)</a></li>
        
    
        
            <li><a href="/pub/2004/06/">June 2004 (6)</a></li>
        
    
        
            <li><a href="/pub/2004/05/">May 2004 (7)</a></li>
        
    
        
            <li><a href="/pub/2004/04/">April 2004 (8)</a></li>
        
    
        
            <li><a href="/pub/2004/03/">March 2004 (8)</a></li>
        
    
        
            <li><a href="/pub/2004/02/">February 2004 (9)</a></li>
        
    
        
            <li><a href="/pub/2004/01/">January 2004 (7)</a></li>
        
    
        
            <li><a href="/pub/2003/12/">December 2003 (4)</a></li>
        
    
        
            <li><a href="/pub/2003/11/">November 2003 (7)</a></li>
        
    
        
            <li><a href="/pub/2003/10/">October 2003 (8)</a></li>
        
    
        
            <li><a href="/pub/2003/09/">September 2003 (6)</a></li>
        
    
        
            <li><a href="/pub/2003/08/">August 2003 (7)</a></li>
        
    
        
            <li><a href="/pub/2003/07/">July 2003 (9)</a></li>
        
    
        
            <li><a href="/pub/2003/06/">June 2003 (9)</a></li>
        
    
        
            <li><a href="/pub/2003/05/">May 2003 (8)</a></li>
        
    
        
            <li><a href="/pub/2003/04/">April 2003 (8)</a></li>
        
    
        
            <li><a href="/pub/2003/03/">March 2003 (10)</a></li>
        
    
        
            <li><a href="/pub/2003/02/">February 2003 (8)</a></li>
        
    
        
            <li><a href="/pub/2003/01/">January 2003 (8)</a></li>
        
    
        
            <li><a href="/pub/2002/12/">December 2002 (5)</a></li>
        
    
        
            <li><a href="/pub/2002/11/">November 2002 (9)</a></li>
        
    
        
            <li><a href="/pub/2002/10/">October 2002 (7)</a></li>
        
    
        
            <li><a href="/pub/2002/09/">September 2002 (11)</a></li>
        
    
        
            <li><a href="/pub/2002/08/">August 2002 (8)</a></li>
        
    
        
            <li><a href="/pub/2002/07/">July 2002 (8)</a></li>
        
    
        
            <li><a href="/pub/2002/06/">June 2002 (4)</a></li>
        
    
        
            <li><a href="/pub/2002/05/">May 2002 (6)</a></li>
        
    
        
            <li><a href="/pub/2002/04/">April 2002 (6)</a></li>
        
    
        
            <li><a href="/pub/2002/03/">March 2002 (7)</a></li>
        
    
        
            <li><a href="/pub/2002/02/">February 2002 (5)</a></li>
        
    
        
            <li><a href="/pub/2002/01/">January 2002 (8)</a></li>
        
    
        
            <li><a href="/pub/2001/12/">December 2001 (7)</a></li>
        
    
        
            <li><a href="/pub/2001/11/">November 2001 (5)</a></li>
        
    
        
            <li><a href="/pub/2001/10/">October 2001 (9)</a></li>
        
    
        
            <li><a href="/pub/2001/09/">September 2001 (7)</a></li>
        
    
        
            <li><a href="/pub/2001/08/">August 2001 (13)</a></li>
        
    
        
            <li><a href="/pub/2001/07/">July 2001 (8)</a></li>
        
    
        
            <li><a href="/pub/2001/06/">June 2001 (13)</a></li>
        
    
        
            <li><a href="/pub/2001/05/">May 2001 (11)</a></li>
        
    
        
            <li><a href="/pub/2001/04/">April 2001 (9)</a></li>
        
    
        
            <li><a href="/pub/2001/03/">March 2001 (8)</a></li>
        
    
        
            <li><a href="/pub/2001/02/">February 2001 (8)</a></li>
        
    
        
            <li><a href="/pub/2001/01/">January 2001 (8)</a></li>
        
    
        
            <li><a href="/pub/2000/12/">December 2000 (6)</a></li>
        
    
        
            <li><a href="/pub/2000/11/">November 2000 (10)</a></li>
        
    
        
            <li><a href="/pub/2000/10/">October 2000 (10)</a></li>
        
    
        
            <li><a href="/pub/2000/09/">September 2000 (2)</a></li>
        
    
        
            <li><a href="/pub/2000/08/">August 2000 (2)</a></li>
        
    
        
            <li><a href="/pub/2000/07/">July 2000 (5)</a></li>
        
    
        
            <li><a href="/pub/2000/06/">June 2000 (7)</a></li>
        
    
        
            <li><a href="/pub/2000/05/">May 2000 (7)</a></li>
        
    
        
            <li><a href="/pub/2000/04/">April 2000 (3)</a></li>
        
    
        
            <li><a href="/pub/2000/03/">March 2000 (2)</a></li>
        
    
        
            <li><a href="/pub/2000/02/">February 2000 (2)</a></li>
        
    
        
            <li><a href="/pub/2000/01/">January 2000 (2)</a></li>
        
    
        
            <li><a href="/pub/1999/12/">December 1999 (6)</a></li>
        
    
        
            <li><a href="/pub/1999/11/">November 1999 (6)</a></li>
        
    
        
            <li><a href="/pub/1999/10/">October 1999 (5)</a></li>
        
    
        
            <li><a href="/pub/1999/09/">September 1999 (4)</a></li>
        
    
        
            <li><a href="/pub/1999/08/">August 1999 (3)</a></li>
        
    
        
            <li><a href="/pub/1999/07/">July 1999 (2)</a></li>
        
    
        
            <li><a href="/pub/1999/06/">June 1999 (3)</a></li>
        
    
        
            <li><a href="/pub/1999/04/">April 1999 (1)</a></li>
        
    
        
            <li><a href="/pub/1999/03/">March 1999 (1)</a></li>
        
    
        
            <li><a href="/pub/1999/01/">January 1999 (1)</a></li>
        
    
        
            <li><a href="/pub/1998/12/">December 1998 (1)</a></li>
        
    
        
            <li><a href="/pub/1998/11/">November 1998 (1)</a></li>
        
    
        
            <li><a href="/pub/1998/07/">July 1998 (2)</a></li>
        
    
        
            <li><a href="/pub/1998/06/">June 1998 (1)</a></li>
        
    
        
            <li><a href="/pub/1998/03/">March 1998 (1)</a></li>
        
        </ul>
    </div>
</div>
        
    

<div class="widget-powered widget">
    <div class="widget-content">
        <a href="http://www.movabletype.com/"><img src="/mt-static/images/bug-pbmt-white.png" alt="Powered by Movable Type 5.13-en" width="120" height="75" /></a>
    </div>
</div>



    </div>
</div>






                </div>
            </div>


            <div id="footer">
    <div id="footer-inner">
        <div id="footer-content">
            <div class="widget-powered widget">
                <div class="widget-content">
                    Powered by <a href="http://www.movabletype.com/" rel="generator">Movable Type Pro</a>
                </div>
            </div>

            <div class="widget-creative-commons widget">
                <div class="widget-content">
                    This blog is licensed under a <a href="http://creativecommons.org/licenses/by-nc-nd/3.0/">Creative Commons License</a>.
                </div>
            </div>

        </div>
    </div>
</div>



        </div>
    </div>
</body>
</html>
