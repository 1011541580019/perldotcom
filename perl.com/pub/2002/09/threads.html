<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" id="sixapart-standard">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="generator" content="Movable Type Pro 5.02" />
<link rel="stylesheet" href="/pub/styles.css" type="text/css" />
<link rel="start" href="/pub/" title="Home" />
<link rel="alternate" type="application/atom+xml" title="Recent Entries" href="/pub/atom.xml" />
<script type="text/javascript" src="/pub/mt.js"></script>

<script type="text/javascript">

 var _gaq = _gaq || [];
 _gaq.push(['_setAccount', 'UA-50555-22']);
 _gaq.push(['_trackPageview']);

 (function() {
   var ga = document.createElement('script'); ga.type =
   'text/javascript'; ga.async = true;
   ga.src = ('https:' == document.location.protocol ? 'https://ssl' :
   'http://www') + '.google-analytics.com/ga.js';
   var s = document.getElementsByTagName('script')[0];
   s.parentNode.insertBefore(ga, s);
 })();

</script>
    
    <link rel="prev bookmark" href="/pub/2002/09/perlfororacle.html" title="The Fusion of Perl and Oracle" />
    <link rel="next bookmark" href="/pub/2002/09/20020908.html" title="This week on Perl 6 (9/1 - 9/8, 2002)" />
    
    
    <title>Going Up? - Perl.com</title>
</head>
<body id="perl-com" class="mt-entry-archive layout-wt">
    <div id="container">
        <div id="container-inner">


            <div id="header">
    <div id="header-inner">
        <div id="header-content">
        <div id="top_advert"> 
<!-- Put any landscape advert in here -->
<a href="http://www.perlfoundation.org/" target="_new">
<img src="/i/tpf_banner.png" width="468" height="60" /></a>
        </div> 



            <div id="header-name"><a href="/pub/" accesskey="1">Perl.com</a></div>
            <div id="header-description"></div>




        </div>
    </div>
</div>



            <div id="content">
                <div id="content-inner">


                    <div id="alpha">
                        <div id="alpha-inner">


                            <div id="entry-1354" class="entry-asset asset hentry">
                                <div class="asset-header">
                                    <h1 id="page-title" class="asset-name entry-title">Going Up?</h1>
                                    <div class="asset-meta">
                                        <span class="byline">

                                            By <span class="vcard author">Sam Tregar</span> on <abbr class="published" title="2002-09-04T00:00:00-08:00">September  4, 2002 12:00 AM</abbr>

                                        </span>


                                    </div>
                                </div>
                                <div class="asset-content entry-content">

                                    <div class="asset-body">
                                        
<!-- sidebar begins -->
<!-- don't move sidebars -->
<!-- sidebar ends -->


<p>Perl 5.8.0 is the first version of Perl with a stable threading
implementation.  Threading has the potential to change the way we
program in Perl, and even the way we think about programming.  This
article explores Perl's new threading support through a simple toy
application - an elevator simulator.</p>


<p>Until now, Perl programmers have had a single mechanism for
parallel processing - the venerable <code>fork()</code>.  When a program forks,
an entirely new process is created.  It runs the same code as the
parent process, but exists in its own memory space with no access to
the parent process' memory.  Communication between forked processes
is possible but it's not at all convenient, requiring pipes, sockets,
shared memory or other clumsy mechanisms.</p>


<p>In contrast, multiple threads exist inside a single process, in the
same memory space as the creating thread.  This allows threads to
communicate much more easily than separate processes.  The potential
exists for threads to work together in ways that are virtually
impossible for normal processes.</p>

<img src="/pub/2002/09/04/graphics/figure1.gif" alt="figure1" align="right" />
<p>Additionally, threads are faster to create and use less memory than
full processes (to what degree depends on your operating system).
Perl's current threading implementation doesn't do a good job of
realizing these gains, but improvements are expected.  If you learn to
thread now, then you'll be ready to take advantage of the extra speed
when it arrives.  But even if it never gets here, thread programming
is still a lot of fun!</p>



<h2><a name="building a threading perl">Building a Threading Perl</a></h2>
<p>To get started with threads you'll need to compile Perl 5.8.0
(<a href="http://cpan.org/src/stable.tar.gz">http://cpan.org/src/stable.tar.gz</a>) with threads enabled.  You can
do that with this command in the unpacked source directory:</p>


<pre><code>
  sh Configure -Dusethreads</code></pre>


  
<p>Also, it's a good idea to install your thread-capable Perl someplace
different than your default install as enabling threading will slow
down even nonthreaded programs.  To do that, use the <code>-Dprefix</code>
argument to configure.  You'll also need to tell Configure not to link
this new Perl as <code>/usr/bin/perl</code> with <code>-Uinstallusrbinperl</code>.  Thus, a
good Configure line for configuring a threaded Perl might be:</p>


<pre><code>
  sh Configure -Dusethreads -Dprefix=~/myperl -Uinstallusrbinperl</code></pre>


<p>Now you can <code>make</code> and <code>make install</code>.  The resulting Perl binary
will be ready to run the simulator in Listing 1, so go ahead and give
it a try.  When you get back, I'll explain how it works.</p>


<h2><a name="an elevator simulator">An Elevator Simulator</a></h2>
<p>The elevator simulator's design was inspired by an assignment from
Professor Robert Dewar's class in programming languages at New York
University.  The objective of that assignment was to learn how to use
the threading features of Ada.  The requirements are simple:</p>


<ul>
<li>
Each elevator and each person must be implemented as a separate
thread.</li>


<li>
People choose a random floor and ride up to it from the ground floor.
They wait there for a set period of time and then ride back down to
the ground floor.</li>


<li>
At the end of the simulation, the user receives a report showing the
efficiency of the elevator algorithm based on the waiting and riding
time of the passengers.</li>


<li>
Basic laws of physics must be respected.  No teleporting people
allowed!</li>

</ul>
<p>The class assignment also required students to code a choice of
elevator algorithms, but I've left that part as an exercise for the
reader.  (See how lazy I can get without a grade hanging over my
head?)</p>


<p>When you run the simulator you'll see output like:</p>


<pre><code>
  $ ./elevator.pl 
  Elevator 0 stopped at floor 0.
  Elevator 1 stopped at floor 0.
  Elevator 2 stopped at floor 0.
  Person 0 waiting on floor 0 for elevator to floor 11.
  Person 0 riding elevator 0 to floor 11.
  Elevator 0 going up to floor 11.
  Person 1 waiting on floor 0 for elevator to floor 1.
  Person 2 waiting on floor 0 for elevator to floor 14.
  Person 2 riding elevator 1 to floor 14.
  Person 1 riding elevator 1 to floor 1.
  Elevator 1 going up to floor 1.</code></pre>


<p>And when the simulation finishes, you'll get some statistics:</p>


<pre><code>
  Average Wait Time:   1.62s
  Average Ride Time:   4.43s</code></pre>


<pre><code>
  Longest Wait Time:   3.95s
  Longest Ride Time:  10.09s</code></pre>


<h2><a name="perl's threading flavor">Perl's Threading Flavor</a></h2>



<p>Before jumping headlong into the simulator code I would like to
introduce you to Perl's particular threading flavor.  There are a wide
variety of threading models living in the world today - POSIX threads,
Java threads, Linux threads, Windows threads, and many more.  Perl's
threads are none of these; they are of an entirely new variety.  This
means that you may have to set aside some of your assumptions about
how threads work before you can truly grok Perl threads.</p>


<blockquote>
<p>Note that Perl's threads are not 5.005 threads.  In Perl 5.005 an
experimental threading model was created.  Now known as 5.005 threads,
this system is deprecated and should not be used by new code.</p>
</blockquote>

<p>In Perl's threading model, variables are <em>not</em> shared by default
unless explicitly marked to be shared.  This is important, and
also different from most other threading models, so allow me to
repeat myself.  Unless you mark a variable as shared it will be
treated as a private thread-local variable.  The downside of this
approach is that Perl has to clone all of the nonshared variables
each time a new thread is created.  This takes memory and time.  The
upside is that most nonthreaded Perl code will ``just work'' with
threads.  Since nonthreaded code doesn't declare any shared variables
there's no need for locking and little possibility for problems.</p>


<p>Perl's threading model can be described as low-level, particularly
compared to the threading models of Java and Ada.  Perl offers you the
ability to create threads, join them and yield processor time to other
threads.  For communication between threads you can mark variables as
shared, lock shared variables, wait for signals on shared variables,
and send signals on shared variables.  That's it!</p>


<p>Most higher-level features, like Ada's entries or Java's synchronized
methods, can be built on top of these basic features.  I expect to see
plenty of development happening on CPAN in this direction as more Perl
programmers get into threads.</p>


<h2><a name="preamble">Preamble</a></h2>

<p>Enough abstraction, let's see this stuff work!  The elevator simulator
in Listing 1 starts with a section of POD documentation describing how
to use the program.  After that comes a block of <code>use</code> declarations:</p>


<pre><code>
  use 5.008;             # 5.8 required for stable threading
  use strict;            # Amen
  use warnings;          # Hallelujah
  use threads;           # pull in threading routines
  use threads::shared;   # and variable sharing routines</code></pre>


<p>The first line makes sure that Perl version 5.8.0 or later is used to
run the script.  It isn't written <code>use 5.8.0</code> because that's a syntax
error with older Perls and the whole point is to produce a friendly
message telling the user to upgrade.  The next lines are the
obligatory <code>strict</code> and <code>warnings</code> lines that will catch many of the
errors to which my fingers are prone.</p>


<p>Next comes the <code>use threads</code> call that tells Perl I'll be using
multiple threads.  This must come as early as possible in your
programs and always before the next line, <code>use threads::shared</code>.  The
<code>threads::shared</code> module allows variables to be shared between
threads, making communication between threads possible.</p>


<p>Finally, GetOpt::Long is used to load parameters from the command
line.  Once extracted, the parameter values are stored in global
variables with names in all caps (<code>$NUM_ELEVATORS</code>, <code>$PEOPLE_FREQ</code>,
and so on).</p>















<h2><a name="building state">Building State</a></h2>
<p>The building is represented in the simulation with three shared
variables, <code>%DOOR</code>, <code>@BUTTON</code> and <code>%PANEL</code>.  These variables are
declared as shared using the <code>shared</code> attribute:</p>


<pre><code>
  # Building State
  our %DOOR   : shared; # a door for each elevator on each floor
  our @BUTTON : shared; # a button for each floor to call the elevators
  our %PANEL  : shared; # a panel of buttons in each elevator for each floor</code></pre>


<p>When a variable is marked as shared its state will be synchronized
between threads.  If one thread makes a change to a shared variable
then all the other threads will see that change.  This means that
threads will need to lock the variable in order to access it safely,
as I'll demonstrate below.</p>


<p>The building state is initialized in the <code>init_building()</code> function.</p>


<pre><code>
  # initialize building state
  sub init_building {
      # set all indicators to 0 to start the simulation
      for my $floor (0 .. $NUM_FLOORS - 1) {       
          $BUTTON[$floor] = 0;
          for my $elevator (0 .. $NUM_ELEVATORS - 1) {
              $PANEL{&quot;$elevator.$floor&quot;} = 0;
              $DOOR{&quot;$elevator.$floor&quot;}  = 0;
          }
      }   
  }</code></pre>


<p>The buttons on each floor are set to 0 to indicate that they are
``off.''  When a person wants to summon the elevator to a floor they
will set the button for that floor to 1 (<code>$BUTTON[$floor] = 1</code>).For
each elevator there are a set of panel buttons and a set of doors, one
for each floor.  These are all cleared to 0 at the start of the
simulation.  When an elevator reaches a floor it will open the door by
setting the appropriate item in <code>%DOOR</code> to 1
(<code>$DOOR{&quot;$elevator.$floor&quot;} = 1</code>).  Similarly, people tell the
elevators where to go by setting entries in <code>%PANEL</code> to 1
(<code>$PANEL{&quot;$elevator.$floor&quot;} = 1</code>).</p>


<p>Figure 2 shows a single-elevator building with four floors and three
people.  Don't worry if this doesn't make much sense yet, you'll see it
in action later.</p>


<img src="/pub/2002/09/04/graphics/figure2.gif" alt="figure2" />

<h2><a name="thread creation">Thread Creation</a></h2>

<p>After calling <code>init_building()</code> to initialize the shared building
state variables, the program creates the elevator threads inside
<code>init_elevator()</code>:</p>


<pre><code>
  # create elevator threads
  sub init_elevator {
      our @elevators;
      for (0 .. $NUM_ELEVATORS - 1) {
          # pass each elevator thread a unique elevator id
          push @elevators, threads-&gt;new(\&amp;Elevator::run, 
                                        id =&gt; $_);
      }
  }</code></pre>


<p>Threads are created by calling <code>threads-&gt;new()</code>.  The first
argument to <code>threads-&gt;new()</code> is a subroutine reference where the
new thread will begin execution.  In this case, it is the
<code>Elevator::run()</code> subroutine declared later in the program.  Anything
after the first argument is passed as an argument to this subroutine.
In this case each elevator is given a unique ID starting at 0.</p>


<p>The return value from <code>threads-&gt;new()</code> is an object representing
the created thread.  This is saved in a global variable,
<code>@elevators</code>, for use later in shutting down the simulation.</p>


<p>After the elevators are created the simulation is ready to send in
people with the <code>init_people()</code> routine:</p>


<pre><code>
  # create people threads
  sub init_people {
      our @people;
      for (0 .. $NUM_PEOPLE - 1) {
          # pass each person thread a unique person id and a random
          # destination
          push @people, threads-&gt;new(\&amp;Person::run,
                                     id   =&gt; $_, 
                                     dest =&gt; int(rand($NUM_FLOORS - 2)) + 1);</code></pre>


<pre><code>
          # pause if we've launched enough people this second
          sleep 1 unless $_ % $PEOPLE_FREQ;
      }
  }</code></pre>


<p>This routine creates <code>$PEOPLE_FREQ</code> people and then sleeps for one
second before continuing.  If this wasn't done, then all the people would
arrive at the building at the same time and the simulation would be
rather boring.  Notice that while the main thread sleeps the
simulation is proceeding in the elevator and people threads.</p>


<p>The people threads start at <code>Person::run()</code>, which will be described
later.  <code>Person::run()</code> receives two parameters - a unique ID and a
randomly chosen destination floor.  Each person will board an elevator
at the ground floor, ride to this floor, wait there for a set period
of time and then ride an elevator back down.</p>
















<h2><a name="the elevator class">The Elevator Class</a></h2>
<p>Each elevator thread contains an object of the Elevator class.  The
<code>Elevator::run()</code> routine creates this object as its first activity:</p>


<pre><code>
  # run an Elevator thread, takes a numeric id as an argument and
  # creates a new Elevator object
  sub run {
      my $self = Elevator-&gt;new(@_);</code></pre>


<p>Notice that since <code>$self</code> is <em>not</em> marked shared it is a
thread-local variable.  Thus, each elevator has its own private
<code>$self</code> object.  The <code>new()</code> method just sets up a hash with some
useful state variables and returns a blessed object:</p>


<pre><code>
  # create a new Elevator object
  sub new {
      my $pkg = shift;
      my $self = { state =&gt; STARTING,
                   floor =&gt; 0,
                   dest  =&gt; 0,
                   @_,
                 };
      return bless($self, $pkg);
  }</code></pre>


<p>All elevators start at the ground floor (floor 0) with no destination.
The <code>state</code> attribute is set to <code>STARTING</code> which comes from this set
of constants used to represent the state of the elevator:</p>


<pre><code>
  # state enumeration
  use constant STARTING   =&gt; 0;
  use constant STOPPED    =&gt; 1;
  use constant GOING_UP   =&gt; 2;
  use constant GOING_DOWN =&gt; 3;</code></pre>


<p>After setting up the object, the elevator thread enters an infinite
loop looking for button presses that will cause it to travel to a
floor.  At the top of the loop <code>$self-&gt;next_dest()</code> is called to
determine where to go:</p>


<pre><code>
    # run until simulation is finished
    while (1) {
        # get next destination
        $self-&gt;{dest} = $self-&gt;next_dest;</code></pre>


<p>The <code>next_dest()</code> method examines the shared array <code>@BUTTON</code> to
determine if any people are waiting for an elevator.  It also looks at
<code>%PANEL</code> to see if there are people inside the elevator heading to a
particular floor.  Since <code>next_dest()</code> accesses shared variables it
starts with a call to <code>lock()</code> for each shared variable:</p>


<pre><code>
  # choose the next destination floor by looking at BUTTONs and PANELs
  sub next_dest {
      my $self = shift;
      my ($id, $state, $floor) = @{$self}{('id', 'state', 'floor')};
      lock @BUTTON;
      lock %PANEL;</code></pre>


<p>Perl's <code>lock()</code> is an advisory locking mechanism, much like
<code>flock()</code>.  When a thread locks a variable it will wait for any other
threads to release their locks before proceeding.  The lock obtained
by <code>lock()</code> is lexical - that is, it lasts until the enclosing scope
is exited.  There is no <code>unlock()</code> call, so it's important to
carefully scope your calls to <code>lock()</code>.  In this case the locks on
<code>@BUTTON</code> and <code>%PANEL</code> last until <code>next_dest()</code> returns.</p>


<p><code>next_dest()</code>'s logic is simple, and largely uninteresting for the
purpose of learning about thread programming.  It does a simple scan
across <code>@BUTTON</code> and <code>%PANEL</code> looking for <code>1</code>s and takes the first
one it finds.</p>


<p>Once <code>next_dest()</code> returns the elevator has its marching orders.  By
comparing the current floor (<code>$self-&gt;{floor}</code>) to the destination
the elevator now knows whether it should stop, or travel up or down.  First, let's look at what happens when the elevator decides to
stop:</p>


<pre><code>
   # stopped?
   if ($self-&gt;{dest} == $self-&gt;{floor}) {
        # state transition to STOPPED?
        if ($self-&gt;{state} != STOPPED) {
            print &quot;Elevator $id stopped at floor $self-&gt;{dest}.\n&quot;;
            $self-&gt;{state} = STOPPED;
        }</code></pre>


<pre><code>
        # wait for passengers
        $self-&gt;open_door;
        sleep $ELEVATOR_WAIT;</code></pre>


<p>The code starts by printing a message and changing the state attribute
if the elevator was previously moving.  Then it calls the
<code>open_door()</code> method and sleeps for <code>$ELEVATOR_WAIT</code> seconds.</p>


<p>The <code>open_door()</code> method opens the elevator door.  This allows
waiting people to board to elevator.</p>


<pre><code>
  # open the elevator doors
  sub open_door {
      my $self = shift;
      lock %DOOR;
      $DOOR{&quot;$self-&gt;{id}.$self-&gt;{floor}&quot;} = 1;
      cond_broadcast(%DOOR);
  }</code></pre>


<p>Like <code>next_dest()</code>, <code>open_door()</code> manipulates a shared variable so
it starts with a call to <code>lock()</code>.  It then sets the elevator door
for the elevator on this floor to open by assigning <code>1</code> to the
appropriate entry in <code>%DOOR</code>.  Then it wakes up all waiting person
threads by calling <code>cond_broadcast()</code> on <code>%DOOR</code>.  I'll go into more
detail about <code>cond_broadcast()</code> when I show you the Person class
later on.  For now suffice it to say that the people threads wait on
the <code>%DOOR</code> variable and will be woken up by this call.</p>


<p>The other states, for going up and going down, are handled similarly:</p>


<pre><code>
  } elsif ($self-&gt;{dest} &gt; $self-&gt;{floor}) {
      # state transition to GOING UP?
      if ($self-&gt;{state} != GOING_UP) {
          print &quot;Elevator $id going up to floor $self-&gt;{dest}.\n&quot;;
          $self-&gt;{state} = GOING_UP;
          $self-&gt;close_door; 
      }</code></pre>


<pre><code>
      # travel to next floor up
      sleep $ELEVATOR_SPEED;
      $self-&gt;{floor}++;</code></pre>


<pre><code>
  } else {
      # state transition to GOING DOWN?
      if ($self-&gt;{state} != GOING_DOWN) {
          print &quot;Elevator $id going down to floor $self-&gt;{dest}.\n&quot;;
          $self-&gt;{state} = GOING_DOWN;
          $self-&gt;close_door; 
      }</code></pre>


<pre><code>
      # travel to next floor down
      sleep $ELEVATOR_SPEED;
      $self-&gt;{floor}--;
  }</code></pre>


<p>The elevator looks at the last value for <code>$self-&gt;{state}</code> to
determine whether it was already heading up or down.  If not, then it prints a
message and calls <code>$self-&gt;close_door()</code>.  Then it sleeps for
<code>$ELEVATOR_SPEED</code> seconds as it travels between floors and adjusts
its current floor accordingly.</p>


<p>The <code>close_door()</code> method simply does the inverse of <code>open_door()</code>,
but without the call to <code>cond_broadcast()</code> since there's no point
waking people up if they can't get on the elevator:</p>


<pre><code>
  # close the elevator doors
  sub close_door {
      my $self = shift;
      lock %DOOR;
      $DOOR{&quot;$self-&gt;{id}.$self-&gt;{floor}&quot;} = 0;
  }</code></pre>


<p>Finally, at the bottom of the elevator loop there is a check on the
shared variable <code>$FINISHED</code>:</p>


<pre><code>
  # simulation over?
  { lock $FINISHED; return if $FINISHED; }</code></pre>


<p>Since the elevator threads are in an infinite loop the main thread
needs a way to tell them when the simulation is over.  It uses the
shared variable <code>$FINISHED</code> for this purpose.  I'll go into more
detail about why this is necessary later.</p>


<p>That's all there is to the Elevator class code.  Elevators simply
travel from floor to floor opening and closing doors in response to
buttons being pushed by people.</p>
















<h2><a name="the person class">The Person Class</a></h2>
<p>Now that we've looked at the machinery, let's turn our attention to
the inhabitants of this building, the people.  Each person thread is
created with a goal - ride an elevator up to the assigned floor, wait
a bit and then ride an elevator back down.  Person threads are also
responsible for keeping track of how long they wait for the elevator
and how long they ride.  When they finish they report this information
back to the main thread where it is output for your edification.</p>


<p><code>Person::run()</code> starts the same way as <code>Elevator::run()</code>, by
creating a new object:</p>


<pre><code>
  # run a Person thread, takes an id and a destination floor as
  # arguments.  Creates a Person object.
  sub run {
      my $self = Person-&gt;new(@_);</code></pre>


<p>Inside <code>Person::new()</code> two attributes are setup to keep track of the
person's progress, floor and elevator:</p>


<pre><code>
  # create a new Person object
  sub new {
      my $pkg = shift;
      my $self = { @_,
                   floor    =&gt; 0,
                   elevator =&gt; 0 };
      return bless($self, $pkg);
  }</code></pre>


<p>Back in <code>Person::run()</code> the person thread begins waiting for the
elevator by calling <code>$self-&gt;wait()</code>.  The calls to <code>time()</code> will
be used later to report on how long the person waited.</p>


<pre><code>
  # wait for elevator going up
  my $wait_start1 = time;
  $self-&gt;wait;
  my $wait1 = time - $wait_start1;</code></pre>


<p>The <code>wait()</code> method is responsible for waiting until an elevator
arrives and opens its doors on this floor:</p>


<pre><code>
  # wait for an elevator
  sub wait {
      my $self = shift;</code></pre>


<pre><code>
      print &quot;Person $self-&gt;{id} waiting on floor 1 for elevator &quot;,
        &quot;to floor $self-&gt;{dest}.\n&quot;;</code></pre>


<pre><code>
      while(1) {
          $self-&gt;press_button();
          lock(%DOOR);
          cond_wait(%DOOR);
          for (0 .. $NUM_ELEVATORS - 1) {
              if ($DOOR{&quot;$_.$self-&gt;{floor}&quot;}) {
                  $self-&gt;{elevator} = $_;
                  return;
              }
          }
      }
  }</code></pre>


<pre><code>
  # signal an elevator to come to this floor
  sub press_button {
      my $self = shift;
      lock @BUTTON;
      $BUTTON[$self-&gt;{floor}] = 1;
  }</code></pre>



<p>After printing out a message, the code enters an infinite loop waiting
for the elevator.  At the top of the loop, the <code>press_button()</code>
method is called.  <code>press_button()</code> locks <code>@BUTTON</code> and sets
<code>$BUTTON[$self-&gt;{floor}]</code> to <code>1</code>.  This will tell the elevators that a
person is waiting on the ground floor.</p>


<p>The code then locks <code>%DOOR</code> and calls <code>cond_wait(%DOOR)</code>.  This has
the effect of releasing the lock on <code>%DOOR</code> and putting the thread to
sleep until another thread does a <code>cond_broadcast(%DOOR)</code> (or
<code>cond_signal(%DOOR)</code>, a variant of <code>cond_broadcast()</code> that just
wakes a single thread).  When the thread wakes up again it re-acquires
the lock on <code>%DOOR</code> and then checks to see if the door that just
opened is on this floor.  If it is the person notes the elevator and
returns from <code>wait()</code>.</p>


<p>If there's no elevator on the floor where the person is waiting, the
loop is run again.  The person presses the button again and then goes
back to sleep waiting for the elevator.  You might be wondering why
the call to <code>press_button()</code> is inside the loop instead of outside.
The reason is that it is possible for the person to wake up from
<code>cond_wait()</code> but have to wait so long to re-acquire the lock on
<code>%DOOR</code> that the elevator is already gone.</p>


<p>Once the elevator arrives, control returns to <code>run()</code> and the person
boards the elevator:</p>


<pre><code>
    # board the elevator, wait for arrival at destination floor and get off
    my $ride_start1 = time;
    $self-&gt;board;
    $self-&gt;ride;
    $self-&gt;disembark;
    my $ride1 = time - $ride_start1;</code></pre>


<p>The <code>board()</code> method is simple enough.  It just turns off the
<code>@BUTTON</code> entry used to summon the elevator and presses the
appropriate button inside the elevator's <code>%PANEL</code>:</p>


<pre><code>
  # get on an elevator
  sub board {
      my $self = shift;
      lock @BUTTON;
      lock %PANEL;
      $BUTTON[$self-&gt;{floor}] = 0;
      $PANEL{&quot;$self-&gt;{elevator}.$self-&gt;{dest}&quot;} = 1;
  }</code></pre>


<p>Next, the <code>run()</code> code calls <code>ride()</code> which does another
<code>cond_wait()</code> on <code>%DOOR</code>, this time waiting for the door in the
elevator to open on the destination floor:</p>


<pre><code>
  # ride to the destination
  sub ride {
      my $self = shift;</code></pre>


<pre><code>
      print &quot;Person $self-&gt;{id} riding elevator $self-&gt;{elevator} &quot;,
        &quot;to floor $self-&gt;{dest}.\n&quot;;</code></pre>


<pre><code>
      lock %DOOR;
      cond_wait(%DOOR) until $DOOR{&quot;$self-&gt;{elevator}.$self-&gt;{dest}&quot;};
  }</code></pre>


<p>When the elevator arrives, <code>ride()</code> will return and the person thread
calls <code>disembark()</code>, which clears the entry in <code>%PANEL</code> for this
floor and sets the current floor in <code>$self-&gt;{floor}</code>.</p>


<pre><code>
  # get off the elevator
  sub disembark {
      my $self = shift;
</code></pre>


<pre><code>

      print &quot;Person $self-&gt;{id} getting off elevator $self-&gt;{elevator} &quot;,
        &quot;at floor $self-&gt;{dest}.\n&quot;;</code></pre>


<pre><code>

      lock %PANEL;
      $PANEL{&quot;$self-&gt;{elevator}.$self-&gt;{dest}&quot;} = 0;
      $self-&gt;{floor} = $self-&gt;{dest};
  }</code></pre>


<p>After reaching the destination floor, the person thread waits for
<code>$PEOPLE_WAIT</code> seconds and then heads back down by repeating the
steps again with <code>$self-&gt;{dest}</code> set to 0:</p>


<pre><code>
    # spend some time on the destination floor and then head back
    sleep $PEOPLE_WAIT;
    $self-&gt;{dest} = 0;</code></pre>


<p>When this is complete the person has arrived at the ground floor.  The
thread ends by returning the recorded timing data with <code>return</code>:</p>


<pre><code>
    # return wait and ride times
    return ($wait1, $wait2, $ride1, $ride2);</code></pre>


<h2><a name="the grand finale">The Grand Finale</a></h2>
<p>While the simulation is running the main thread is sitting in
<code>init_people()</code> creating person threads periodically.  Once this task
is complete the <code>finish()</code> routine is called.</p>


<p>The first task of <code>finish()</code> is to collect statistics from the people
threads as they complete:</p>


<pre><code>
  # finish the simulation - join all threads and collect statistics
  sub finish {
      our (@people, @elevators);
</code></pre>


<pre><code>

      # join the people threads and collect statistics
      my ($total_wait, $total_ride, $max_wait, $max_ride) = (0,0,0,0);
      foreach my $person (@people) {
          my ($wait1, $wait2, $ride1, $ride2) = $person-&gt;join;
          $total_wait += $wait1 + $wait2;
          $total_ride += $ride1 + $ride2;
          $max_wait    = $wait1 if $wait1 &gt; $max_wait;
          $max_wait    = $wait2 if $wait2 &gt; $max_wait;
          $max_ride    = $ride1 if $ride1 &gt; $max_ride;
          $max_ride    = $ride2 if $ride2 &gt; $max_ride;
      }</code></pre>


<p>To extract return values from a finished thread the <code>join()</code> method
must be called on the thread object.  This method will wait for the
thread to end, which means that this loop won't finish until the last
person reaches the ground floor.</p>


<p>Once all the people are processed, the simulation is over.  To tell
the elevators to shutdown the shared variable <code>$FINISHED</code> is set to
1 and the elevators are joined:</p>


<pre><code>
  # tell the elevators to shut down
  { lock $FINISHED; $FINISHED = 1; }
  $_-&gt;join for @elevators;</code></pre>


<p>If this code were omitted the simulation would still end but Perl
would print a warning because the main thread exited with other
threads still running.</p>


<p>Finally, <code>finish()</code> prints out the statistics collected from the
person threads:</p>


<pre><code>
  # print out statistics
  print &quot;\n&quot;, &quot;-&quot; x 72, &quot;\n\nSimulation Complete\n\n&quot;, &quot;-&quot; x 72, &quot;\n\n&quot;;
  printf &quot;Average Wait Time: %6.2fs\n&quot;,   ($total_wait / ($NUM_PEOPLE * 2));
  printf &quot;Average Ride Time: %6.2fs\n\n&quot;, ($total_ride / ($NUM_PEOPLE * 2));
  printf &quot;Longest Wait Time: %6.2fs\n&quot;,   $max_wait;
  printf &quot;Longest Ride Time: %6.2fs\n\n&quot;, $max_ride;</code></pre>


<p>The end!</p>


<h2><a name="a few wrinkles">A Few Wrinkles</a></h2>
<p>Overall, the simulator was a fun project with few major stumbling
blocks.  However, there were a few problems or near problems that
you would do well to avoid.</p>


<p><strong>Deadlock</strong></p>


<p>All parallel programs are susceptible to deadlock, but, by virtue of
higher levels of inter-activity, threads suffer it more frequently.
Deadlock occurs when independent threads (or processes) each need a
resource the other has.</p>


<p>In the elevator simulator I avoided deadlock by always performing
multiple locks in the same order.  For example,
<code>Elevator::next_dest()</code> begins with:</p>


<pre><code>
  lock @BUTTON;
  lock %PANEL;</code></pre>


<p>And in <code>Person::board()</code> the same sequence is repeated:</p>


<pre><code>
  lock @BUTTON;
  lock %PANEL;</code></pre>

<p>If the lock calls in <code>Person::board()</code> were reversed then the
following could occur:</p>


<ol>
<li>
Elevator 2 locks <code>@BUTTON</code>.</li>


<li>
Person 3 locks <code>%PANEL</code>.</li>


<li>
Elevator 2 tries to lock <code>%PANEL</code> and blocks waiting for Person 3's lock.</li>


<li>
Person 3 tries to lock <code>@BUTTON</code> and blocks waiting for Elevator 2's lock.</li>


<li>
<em>Deadlock!</em> Neither thread can proceed and the simulation will never
end.</li>

</ol>
<p><strong>Modules</strong></p>


<p>In general, unless a module has been specifically vetted as thread
safe it cannot be used in a threaded program.  Most pure Perl modules
should be thread safe but most XS modules are not.  This goes for core
modules too!</p>


<p>An earlier version of the elevator simulator used Time::HiRes to allow
for fractional <code>sleep()</code> times.  This really helped speed up the
simulation since it meant that elevators could traverse more than one
floor per second.  However, on further investigation (and advice from
Nick Ing-Simmons) I realized that Time::HiRes is not necessarily
thread safe.  Although it seemed to work fine on my machine there's no
reason to believe that would be the case elsewhere, or even that it
wouldn't blow up at some random point in the future.  The problem with
thread safety is that it's virtually impossible to test for; either
you can prove you have it or you must assume you don't!</p>


<p><strong>Synchronized <code>rand()</code></strong></p>


<p>The first version of the simulator I wrote had the people threads
calling <code>rand()</code> inside <code>Person::run()</code> to choose the destination
floor.  I also had a call to <code>srand()</code> in the main thread, not
realizing that Perl now calls <code>srand()</code> with a good seed
automatically.  The combination resulted in every person choosing the
same destination floor.  Yikes!</p>


<p>The reason for this is that by calling <code>srand()</code> in the main thread I
set the random seed.  Then when the threads were created that seed was
copied into each thread.  The call to <code>rand()</code> then generated the
same first value in each thread.</p>


<h2><a name="resources">Resources</a></h2>
<p>Perl comes with copious threading documentation.  You can read these
docs by following the links below or by using the <code>perldoc</code> program
that comes with Perl.</p>

<ul>

<li>
<a href="/2002/09/04/examples/elevator.pl">elevator.pl</a> - Sample code from this article.
</li>

<li>
perlthrtut (<a href="http://perldoc.com/perl5.8.0/pod/perlthrtut.html">http://perldoc.com/perl5.8.0/pod/perlthrtut.html</a>) - a
threading tutorial</li>


<li>
threads (<a href="http://perldoc.com/perl5.8.0/lib/threads.html">http://perldoc.com/perl5.8.0/lib/threads.html</a>) - the
reference for the threads module</li>


<li>
threads::shared
(<a href="http://perldoc.com/perl5.8.0/lib/threads/shared.html">http://perldoc.com/perl5.8.0/lib/threads/shared.html</a>) -the
reference for the threads::shared module</li>


</ul>

                                    </div>


                                </div>
                                <div class="asset-footer">

    
                                    <div class="entry-categories">
                                        <h4>Categories<span class="delimiter">:</span></h4>
                                        <ul>
                                            <li><a href="/pub/tutorials/" rel="tag">Tutorials</a></li>
                                        </ul>
                                    </div>
    


                                    <div class="entry-tags">
                                        <h4>Tags<span class="delimiter">:</span></h4>
                                        <ul>
                                            <li><a href="javascript:void(0)" onclick="location.href='http://www.perl.com/mt-search.cgi?blog_id=2&amp;tag=elevator%20threading%20threads%20simulation&amp;limit=20';return false;" rel="tag">elevator threading threads simulation</a></li>
                                        </ul>
                                    </div>

                                </div>
                            </div>


                    
                    


                        </div>
                    </div>


                    <div id="beta">
    <div id="beta-inner">


    
    <div class="widget-what-is-perl widget">
    <div class="widget-content widget-content-what-is-perl">
       Visit the home of the  Perl programming language: <a href="http://www.perl.org/">Perl.org</a
    </div>
</div>
<div class="widget-find-out-more widget-archives widget">
    <div class="widget-content">
        <ul>
            <li><a href="http://www.perl.org/get.html">Download</a></li>
            <li><a href="http://perldoc.perl.org/">Documentation</a></li>
            <li><a href="http://blogs.perl.org/">Perl Bloggers</a></li>
            <li><a href="http://news.perlfoundation.org/">Foundation News</a></li>
        </ul>
    </div>
</div><div class="widget-tcpc widget">
<h3 class="widget-header">Sponsored by</h3>
    <div class="widget-content">
        <a href="http://training.perl.com/" alt="Perl Training" target="_blank"><img src="/i/tcpc.png" width="150" height="50"></a>
    </div>
</div>

<div class="widget-syndication widget">
    <div class="widget-content">
        <ul>
            <li><img src="/mt-static/images/status_icons/feed.gif" alt="Subscribe to feed" width="9" height="9" /> <a href="/pub/atom.xml">Subscribe to this website's feed</a></li>

        </ul>
    </div>
</div>
<div class="widget-archive-monthly widget-archive widget">
    <h3 class="widget-header">Monthly <a href="/pub/archives.html">Archives</a></h3>
    <div class="widget-content">
        <ul>
        
            <li><a href="/pub/2010/07/">July 2010 (1)</a></li>
        
    
        
            <li><a href="/pub/2008/05/">May 2008 (1)</a></li>
        
    
        
            <li><a href="/pub/2008/04/">April 2008 (2)</a></li>
        
    
        
            <li><a href="/pub/2008/03/">March 2008 (1)</a></li>
        
    
        
            <li><a href="/pub/2008/02/">February 2008 (1)</a></li>
        
    
        
            <li><a href="/pub/2008/01/">January 2008 (1)</a></li>
        
    
        
            <li><a href="/pub/2007/12/">December 2007 (2)</a></li>
        
    
        
            <li><a href="/pub/2007/09/">September 2007 (1)</a></li>
        
    
        
            <li><a href="/pub/2007/08/">August 2007 (1)</a></li>
        
    
        
            <li><a href="/pub/2007/07/">July 2007 (1)</a></li>
        
    
        
            <li><a href="/pub/2007/06/">June 2007 (1)</a></li>
        
    
        
            <li><a href="/pub/2007/05/">May 2007 (1)</a></li>
        
    
        
            <li><a href="/pub/2007/04/">April 2007 (1)</a></li>
        
    
        
            <li><a href="/pub/2007/03/">March 2007 (1)</a></li>
        
    
        
            <li><a href="/pub/2007/02/">February 2007 (1)</a></li>
        
    
        
            <li><a href="/pub/2007/01/">January 2007 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/12/">December 2006 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/11/">November 2006 (2)</a></li>
        
    
        
            <li><a href="/pub/2006/10/">October 2006 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/09/">September 2006 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/08/">August 2006 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/07/">July 2006 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/06/">June 2006 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/05/">May 2006 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/04/">April 2006 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/03/">March 2006 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/02/">February 2006 (4)</a></li>
        
    
        
            <li><a href="/pub/2006/01/">January 2006 (4)</a></li>
        
    
        
            <li><a href="/pub/2005/12/">December 2005 (4)</a></li>
        
    
        
            <li><a href="/pub/2005/11/">November 2005 (3)</a></li>
        
    
        
            <li><a href="/pub/2005/10/">October 2005 (2)</a></li>
        
    
        
            <li><a href="/pub/2005/09/">September 2005 (2)</a></li>
        
    
        
            <li><a href="/pub/2005/08/">August 2005 (9)</a></li>
        
    
        
            <li><a href="/pub/2005/07/">July 2005 (8)</a></li>
        
    
        
            <li><a href="/pub/2005/06/">June 2005 (9)</a></li>
        
    
        
            <li><a href="/pub/2005/05/">May 2005 (8)</a></li>
        
    
        
            <li><a href="/pub/2005/04/">April 2005 (7)</a></li>
        
    
        
            <li><a href="/pub/2005/03/">March 2005 (6)</a></li>
        
    
        
            <li><a href="/pub/2005/02/">February 2005 (7)</a></li>
        
    
        
            <li><a href="/pub/2005/01/">January 2005 (6)</a></li>
        
    
        
            <li><a href="/pub/2004/12/">December 2004 (8)</a></li>
        
    
        
            <li><a href="/pub/2004/11/">November 2004 (8)</a></li>
        
    
        
            <li><a href="/pub/2004/10/">October 2004 (5)</a></li>
        
    
        
            <li><a href="/pub/2004/09/">September 2004 (9)</a></li>
        
    
        
            <li><a href="/pub/2004/08/">August 2004 (6)</a></li>
        
    
        
            <li><a href="/pub/2004/07/">July 2004 (8)</a></li>
        
    
        
            <li><a href="/pub/2004/06/">June 2004 (6)</a></li>
        
    
        
            <li><a href="/pub/2004/05/">May 2004 (7)</a></li>
        
    
        
            <li><a href="/pub/2004/04/">April 2004 (8)</a></li>
        
    
        
            <li><a href="/pub/2004/03/">March 2004 (8)</a></li>
        
    
        
            <li><a href="/pub/2004/02/">February 2004 (9)</a></li>
        
    
        
            <li><a href="/pub/2004/01/">January 2004 (7)</a></li>
        
    
        
            <li><a href="/pub/2003/12/">December 2003 (4)</a></li>
        
    
        
            <li><a href="/pub/2003/11/">November 2003 (7)</a></li>
        
    
        
            <li><a href="/pub/2003/10/">October 2003 (8)</a></li>
        
    
        
            <li><a href="/pub/2003/09/">September 2003 (6)</a></li>
        
    
        
            <li><a href="/pub/2003/08/">August 2003 (7)</a></li>
        
    
        
            <li><a href="/pub/2003/07/">July 2003 (9)</a></li>
        
    
        
            <li><a href="/pub/2003/06/">June 2003 (9)</a></li>
        
    
        
            <li><a href="/pub/2003/05/">May 2003 (8)</a></li>
        
    
        
            <li><a href="/pub/2003/04/">April 2003 (8)</a></li>
        
    
        
            <li><a href="/pub/2003/03/">March 2003 (10)</a></li>
        
    
        
            <li><a href="/pub/2003/02/">February 2003 (8)</a></li>
        
    
        
            <li><a href="/pub/2003/01/">January 2003 (8)</a></li>
        
    
        
            <li><a href="/pub/2002/12/">December 2002 (5)</a></li>
        
    
        
            <li><a href="/pub/2002/11/">November 2002 (9)</a></li>
        
    
        
            <li><a href="/pub/2002/10/">October 2002 (7)</a></li>
        
    
        
            <li><a href="/pub/2002/09/">September 2002 (11)</a></li>
        
    
        
            <li><a href="/pub/2002/08/">August 2002 (8)</a></li>
        
    
        
            <li><a href="/pub/2002/07/">July 2002 (8)</a></li>
        
    
        
            <li><a href="/pub/2002/06/">June 2002 (4)</a></li>
        
    
        
            <li><a href="/pub/2002/05/">May 2002 (6)</a></li>
        
    
        
            <li><a href="/pub/2002/04/">April 2002 (6)</a></li>
        
    
        
            <li><a href="/pub/2002/03/">March 2002 (7)</a></li>
        
    
        
            <li><a href="/pub/2002/02/">February 2002 (5)</a></li>
        
    
        
            <li><a href="/pub/2002/01/">January 2002 (8)</a></li>
        
    
        
            <li><a href="/pub/2001/12/">December 2001 (7)</a></li>
        
    
        
            <li><a href="/pub/2001/11/">November 2001 (5)</a></li>
        
    
        
            <li><a href="/pub/2001/10/">October 2001 (9)</a></li>
        
    
        
            <li><a href="/pub/2001/09/">September 2001 (7)</a></li>
        
    
        
            <li><a href="/pub/2001/08/">August 2001 (13)</a></li>
        
    
        
            <li><a href="/pub/2001/07/">July 2001 (8)</a></li>
        
    
        
            <li><a href="/pub/2001/06/">June 2001 (13)</a></li>
        
    
        
            <li><a href="/pub/2001/05/">May 2001 (11)</a></li>
        
    
        
            <li><a href="/pub/2001/04/">April 2001 (9)</a></li>
        
    
        
            <li><a href="/pub/2001/03/">March 2001 (8)</a></li>
        
    
        
            <li><a href="/pub/2001/02/">February 2001 (8)</a></li>
        
    
        
            <li><a href="/pub/2001/01/">January 2001 (8)</a></li>
        
    
        
            <li><a href="/pub/2000/12/">December 2000 (6)</a></li>
        
    
        
            <li><a href="/pub/2000/11/">November 2000 (10)</a></li>
        
    
        
            <li><a href="/pub/2000/10/">October 2000 (10)</a></li>
        
    
        
            <li><a href="/pub/2000/09/">September 2000 (2)</a></li>
        
    
        
            <li><a href="/pub/2000/08/">August 2000 (2)</a></li>
        
    
        
            <li><a href="/pub/2000/07/">July 2000 (5)</a></li>
        
    
        
            <li><a href="/pub/2000/06/">June 2000 (7)</a></li>
        
    
        
            <li><a href="/pub/2000/05/">May 2000 (7)</a></li>
        
    
        
            <li><a href="/pub/2000/04/">April 2000 (3)</a></li>
        
    
        
            <li><a href="/pub/2000/03/">March 2000 (2)</a></li>
        
    
        
            <li><a href="/pub/2000/02/">February 2000 (2)</a></li>
        
    
        
            <li><a href="/pub/2000/01/">January 2000 (2)</a></li>
        
    
        
            <li><a href="/pub/1999/12/">December 1999 (6)</a></li>
        
    
        
            <li><a href="/pub/1999/11/">November 1999 (6)</a></li>
        
    
        
            <li><a href="/pub/1999/10/">October 1999 (5)</a></li>
        
    
        
            <li><a href="/pub/1999/09/">September 1999 (4)</a></li>
        
    
        
            <li><a href="/pub/1999/08/">August 1999 (3)</a></li>
        
    
        
            <li><a href="/pub/1999/07/">July 1999 (2)</a></li>
        
    
        
            <li><a href="/pub/1999/06/">June 1999 (3)</a></li>
        
    
        
            <li><a href="/pub/1999/04/">April 1999 (1)</a></li>
        
    
        
            <li><a href="/pub/1999/03/">March 1999 (1)</a></li>
        
    
        
            <li><a href="/pub/1999/01/">January 1999 (1)</a></li>
        
    
        
            <li><a href="/pub/1998/12/">December 1998 (1)</a></li>
        
    
        
            <li><a href="/pub/1998/11/">November 1998 (1)</a></li>
        
    
        
            <li><a href="/pub/1998/07/">July 1998 (2)</a></li>
        
    
        
            <li><a href="/pub/1998/06/">June 1998 (1)</a></li>
        
    
        
            <li><a href="/pub/1998/03/">March 1998 (1)</a></li>
        
        </ul>
    </div>
</div>
        
    

<div class="widget-powered widget">
    <div class="widget-content">
        <a href="http://www.movabletype.com/"><img src="/mt-static/images/bug-pbmt-white.png" alt="Powered by Movable Type 5.02" width="120" height="75" /></a>
    </div>
</div>



    </div>
</div>






                </div>
            </div>


            <div id="footer">
    <div id="footer-inner">
        <div id="footer-content">
            <div class="widget-powered widget">
                <div class="widget-content">
                    Powered by <a href="http://www.movabletype.com/" rel="generator">Movable Type Pro</a>
                </div>
            </div>

        </div>
    </div>
</div>



        </div>
    </div>
</body>
</html>
