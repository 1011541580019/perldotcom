<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" id="sixapart-standard">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="generator" content="Movable Type Pro 5.02" />
<link rel="stylesheet" href="/pub/styles.css" type="text/css" />
<link rel="start" href="/pub/" title="Home" />
<link rel="alternate" type="application/atom+xml" title="Recent Entries" href="/pub/atom.xml" />
<script type="text/javascript" src="/pub/mt.js"></script>

<script type="text/javascript">

 var _gaq = _gaq || [];
 _gaq.push(['_setAccount', 'UA-50555-22']);
 _gaq.push(['_trackPageview']);

 (function() {
   var ga = document.createElement('script'); ga.type =
   'text/javascript'; ga.async = true;
   ga.src = ('https:' == document.location.protocol ? 'https://ssl' :
   'http://www') + '.google-analytics.com/ga.js';
   var s = document.getElementsByTagName('script')[0];
   s.parentNode.insertBefore(ga, s);
 })();

</script>
    
    <link rel="prev bookmark" href="/pub/2002/11/20021121.html" title="This week on Perl 6 (11/10-11/17, 2002)" />
    <link rel="next bookmark" href="/pub/2002/11/20021127.html" title="This week on Perl 6 (11/17-11/23, 2002)" />
    
    
    <title>Class::DBI - Perl.com</title>
</head>
<body id="perl-com" class="mt-entry-archive layout-wt">
    <div id="container">
        <div id="container-inner">


            <div id="header">
    <div id="header-inner">
        <div id="header-content">
        <div id="top_advert"> 
<!-- Put any landscape advert in here -->
<a href="http://www.perlfoundation.org/" target="_new">
<img src="/i/tpf_banner.png" width="468" height="60" /></a>
        </div> 



            <div id="header-name"><a href="/pub/" accesskey="1">Perl.com</a></div>
            <div id="header-description"></div>




        </div>
    </div>
</div>



            <div id="content">
                <div id="content-inner">


                    <div id="alpha">
                        <div id="alpha-inner">


                            <div id="entry-1396" class="entry-asset asset hentry">
                                <div class="asset-header">
                                    <h1 id="page-title" class="asset-name entry-title">Class::DBI</h1>
                                    <div class="asset-meta">
                                        <span class="byline">

                                            By <span class="vcard author">Tony Bowden</span> on <abbr class="published" title="2002-11-27T00:00:00-08:00">November 27, 2002 12:00 AM</abbr>

                                        </span>


                                    </div>
                                </div>
                                <div class="asset-content entry-content">

                                    <div class="asset-body">
                                        

<p>Several articles on Perl.com, including the recent 
<a href="/pub/a/2002/10/22/phrasebook.html">Phrasebook
Design Pattern</a>, have discussed the problems faced when writing
Perl code that interacts with a database. Terrence Brannon's 
<a href="/pub/a/2001/02/dbix.html">DBIx::Recordset</a>
article attempted to show how code dealing with databases can be made
simpler, and more maintainable. In this article, I will try to show how
<code>Class::DBI</code> can make this easier still.</p>

<p><code>Class::DBI</code> prizes laziness and simplicity. Its goal is to make simple
database interactions trivial, while leaving the hard ones possible.
For many simple applications, it replaces the need for writing SQL
entirely. On the other hand, it doesn't force you to build complex data
structures to specify a complex query; if you really need the power or
expressiveness of raw SQL, then it gets out of your way and lets you drop back
to that.</p>
<p>The easiest way to see <code>Class::DBI</code> in action is to build a simple
application with it. In this article, I'll build a tool for performing
analysis on my telephone bill.</p>

<csperl file="grab" domain="on" record="b/522" template="article_sidebar2.view">

<p><a href="http://search.cpan.org/author/TMTM/Data-BT-PhoneBill-0.94/">Data::BT::PhoneBill</a>
(available from CPAN), provides a simple interface to a phone bill
downloaded from the BT Web site. So, armed with this module, and a few
recent phonebills, let's store these details in a database, and see how
to extract useful information from them.
</p>

<p><code>Class::DBI</code> works on the basis that each table in your database has a
corresponding class. Although each class could set up its own connection
information, it's a better idea to encapsulate that connection in one
class, and have all the others inherit from that. So, we set up our
database, and create the base class for our application:</p>
<pre><code>
  package My::PhoneBill::DBI;

  use base 'Class::DBI';

  __PACKAGE__-&gt;set_db('Main', 'dbi:mysql:phonebill', 'u/n', 'p/w');

  1;</code></pre>
<p>We simply inherit from <code>Class::DBI</code> and use the '<code>set_db</code>' method to set up
the connection information for our database. That's all we need in this
class for now, so next we set up our table for storing the phone call
information:</p>
<pre><code>
  CREATE TABLE call (
    callid      MEDIUMINT UNSIGNED NOT NULL PRIMARY KEY AUTO_INCREMENT,
    number      VARCHAR(20) NOT NULL,
    destination VARCHAR(255) NOT NULL,
    calldate    DATE NOT NULL,
    calltime    TIME NOT NULL,
    type        VARCHAR(50) NOT NULL,
    duration    SMALLINT UNSIGNED NOT NULL,
    cost        FLOAT(8,1)
  );</code></pre>
<p>For this, we set up a corresponding class:</p>
<pre><code>
  package My::PhoneBill::Call;

  use base 'My::PhoneBill::DBI';

  __PACKAGE__-&gt;table('call');
  __PACKAGE__-&gt;columns(All   =&gt; 
    qw/callid number destination calldate calltime type duration cost/);

  1;</code></pre>
<p>We inherit our connection information from our base class, and then
specify what table we're dealing with, and what its columns are.
Now we have enough to populate the table.</p>
<p>So, we create a simple, &quot;<em>populate_phone_bill</em>&quot; script:</p>
<pre><code>
  #!/usr/bin/perl

  use Data::BT::PhoneBill;
  use My::PhoneBill::Call;

  my $file = shift or die &quot;Need a phone bill file&quot;;
  my $bill = Data::BT::PhoneBill-&gt;new($file) or die &quot;Can't parse bill&quot;;

  while (my $call = $bill-&gt;next_call) {
    My::PhoneBill::Call-&gt;create({
      number      =&gt; $call-&gt;number,
      calldate    =&gt; $call-&gt;date,
      calltime    =&gt; $call-&gt;time,
      destination =&gt; $call-&gt;destination,
      duration    =&gt; $call-&gt;duration,
      type        =&gt; $call-&gt;type,
      cost        =&gt; $call-&gt;cost,
    });
  }</code></pre>
<p>The <code>create()</code> call runs the SQL to <code>INSERT</code> the row for each call. As we're
using <code>Class::DBI</code>, and have defined our primary key column to be
<code>AUTO_INCREMENT</code>, we don't need to specify a value for that column. On databases
that support sequences, we could also inform <code>Class::DBI</code> what sequence
should be used to provide the primary key.</p>
<p>Now that we have a table populated with calls, we can begin to run
queries against it. Let's write a simple script that reports on all the
calls to a specified number:</p>
<pre><code>
  #!/usr/bin/perl
  
  use My::PhoneBill::Call;
  
  my $number = shift or die &quot;Usage: $0 &lt;number&gt;&quot;;
  
  my @calls = My::PhoneBill::Call-&gt;search(number =&gt; $number);
  my $total_cost = 0;
  
  foreach my $call (@calls) {
    $total_cost += $call-&gt;cost;
    printf &quot;%s %s - %d secs, %.1f pence\n&quot;,
      $call-&gt;calldate, $call-&gt;calltime, $call-&gt;duration, $call-&gt;cost;
  }
  printf &quot;Total: %d calls, %d pence\n&quot;, scalar @calls, $total_cost;</code></pre>
<p>Here we can see that <code>Class::DBI</code> provides a '<code>search</code>' method for us
to use. We supply a hash of column/value pairs, and we get back all the
records that matched. Each result is an instance of the <code>Call</code> class,
and each has an accessor method corresponding to each column. (It's also
a mutator method, so we can update that record, but we're only reporting
at this stage).</p>
<p>So, if we want to see how often we're calling the Speaking Clock, then
we run</p>
<pre><code>
  &gt; perl calls_to 123
  2002-09-17 11:06:00 - 5 secs, 8.5 pence
  2002-10-19 21:20:00 - 8 secs, 8.5 pence
  Total: 2 calls, 17 pence</code></pre>
<p>Similarly, if we want to see all the calls on a given date, then we could
have a '<code>calls_on</code>' script:</p>
<pre><code>
  #!/usr/bin/perl
  
  use My::PhoneBill::Call;
  
  my $date = shift or die &quot;Usage: $0 &lt;date&gt;&quot;;
  
  my @calls = My::PhoneBill::Call-&gt;search(calldate =&gt; $date);
  my $total_cost = 0;
  
  foreach my $call (@calls) {
    $total_cost += $call-&gt;cost;
    printf &quot;%s) %s - %d secs, %.1f pence\n&quot;,
      $call-&gt;calltime, $call-&gt;number, $call-&gt;duration, $call-&gt;cost;
  }
  printf &quot;Total: %d calls, %d pence\n&quot;, scalar @calls, $total_cost;</code></pre>
<p>Running it gives:</p>
<pre><code>
  &gt; perl calls_on 2002-10-19
  ...
  18:36:00) 028 9024 4222 - 41 secs, 4.2 pence
  21:20:00) 123 - 8 secs, 8.5 pence
  ...
  Total: 7 calls, 92 pence</code></pre>
<p>As promised, we've written a database application without writing any
SQL. OK, so we haven't really done anything very complicated yet, but
even for this simplistic use <code>Class::DBI</code> makes our life much easier.</p>
<p>
</p>
<h2><a name="building_a_phone_book">Building a Phone Book</a></h2>
<p>I used to have a good memory for phone numbers. But Nokia, Ericsson, et
al, have conspired against me. By giving my cell phone a built-in address
book, they ensured that the part of my brain responsible for remembering
10 or 11 digit numbers would gradually atrophy. Now, when I look at the
output of '<code>calls_on</code>', I have no idea who &quot;028 9024 4222&quot; represents. So,
let's build an address book that can store this information, and then
change our reports to use it.</p>
<p>The first thing we should do is arrange our information a little better.
We'll take the <code>number</code> and <code>destination</code> columns, and move them to a
&quot;recipient&quot; table, to which we'll add a <code>name</code> column. &quot;Destination&quot; doesn't
make as much sense when associated with the number, rather than the call,
so we'll rename it to &quot;location&quot;.</p>
<pre><code>
  CREATE TABLE recipient (
    recipid  MEDIUMINT UNSIGNED NOT NULL PRIMARY KEY AUTO_INCREMENT,
    number   VARCHAR(20) NOT NULL,
    location VARCHAR(255) NOT NULL,
    name     VARCHAR(255),
    KEY (number)
  );</code></pre>
<p>And then we create the relevant class for this table:</p>
<pre><code>
  package My::PhoneBill::Recipient;
  
  use base 'My::PhoneBill::DBI';
  
  __PACKAGE__-&gt;table('recipient');
  __PACKAGE__-&gt;columns(All =&gt; qw/recipid number location name/);

  1;</code></pre>
<p>We also need to modify the Call table:</p>
<pre><code>
  CREATE TABLE call (
    callid    MEDIUMINT UNSIGNED NOT NULL PRIMARY KEY AUTO_INCREMENT,
 *  recipient MEDIUMINT UNSIGNED NOT NULL,
    calldate  DATE NOT NULL,
    calltime  TIME NOT NULL,
    type      VARCHAR(50) NOT NULL,
    duration  SMALLINT UNSIGNED NOT NULL,
    cost      FLOAT(8,1),
 *  KEY (recipient)
  );</code></pre>
<p>and its associated class:</p>
<pre><code>
  package My::PhoneBill::Call;
  
  use base 'My::PhoneBill::DBI';
  
  __PACKAGE__-&gt;table('call');
  __PACKAGE__-&gt;columns(All   =&gt;
 *  qw/callid recipient calldate calltime type duration cost/);
  
  1;</code></pre>
<p>Then we can modify our script that populates the database:</p>
<pre><code>
  #!/usr/bin/perl

  use Data::BT::PhoneBill;
  use My::PhoneBill::Call;
 *use My::PhoneBill::Recipient;

  my $file = shift or die &quot;Need a phone bill file&quot;;
  my $bill = Data::BT::PhoneBill-&gt;new($file) or die &quot;Can't parse bill&quot;;

 *while (my $call = $bill-&gt;next_call) {
 *  my $recipient = My::PhoneBill::Recipient-&gt;find_or_create({
 *    number      =&gt; $call-&gt;number,
 *    location    =&gt; $call-&gt;destination,
 *  });
 *  My::PhoneBill::Call-&gt;create({
 *    recipient   =&gt; $recipient-&gt;id,
      calldate    =&gt; $call-&gt;date,
      calltime    =&gt; $call-&gt;time,
      duration    =&gt; $call-&gt;duration,
      type        =&gt; $call-&gt;type,
      cost        =&gt; $call-&gt;cost,
    });
  }</code></pre>
<p>This time we need to create the <code>Recipient</code> first, so we can link to it
from the <code>Call</code>. But we don't want to create a new <code>Recipient</code> for each call -
if we've ever rang this person before, there'll already be an entry
in the recipient table: so we use <code>find_or_create</code> to give us back the
existing entry if it's there, or else create a new one.</p>
<p>With the table repopulated we can return to our reporting scripts.</p>
<p>Our <code>calls_on</code> script now fails as we can can't ask a call for its
'number'. So, we change it to:</p>
<pre><code>
  #!/usr/bin/perl
  
  use My::PhoneBill::Call;
  
  my $date = shift or die &quot;Usage: $0 &lt;date&gt;&quot;;
  
  my @calls = My::PhoneBill::Call-&gt;search(calldate =&gt; $date);
  my $total_cost = 0;
  
  foreach my $call (@calls) {
    $total_cost += $call-&gt;cost;
    printf &quot;%s) %s - %d secs, %.1f pence\n&quot;,
 *    $call-&gt;calltime, $call-&gt;recipient, $call-&gt;duration, $call-&gt;cost;
  }
  printf &quot;Total: %d calls, %d pence\n&quot;, scalar @calls, $total_cost;</code></pre>
<p>However, running it doesn't really give us what we want:</p>
<pre><code>
  &gt; perl calls_on 2002-10-19
  ...
  18:36:00) 67 - 41 secs, 4.2 pence
  21:20:00) 47 - 8 secs, 8.5 pence
  ...
  Total: 7 calls, 92 pence</code></pre>
  
  













  
<p>Instead of getting the phone number, we now get the ID from the
recipient table, which is just an auto-incrementing value.</p>
<p>To turn this into a sensible value, we add the following line to the
<code>Call</code> class:</p>
<pre><code>
  __PACKAGE__-&gt;has_a(recipient =&gt; 'My::PhoneBill::Recipient');</code></pre>
<p>This tells it that the recipient method doesn't just return a simple
value, but that that value should be automatically turned into an instance
of the Recipient class.</p>
<p>Of course, calls_on still won't be correct:</p>
<pre><code>
  &gt; perl calls_on 2002-10-19
  ...
  18:36:00) My::PhoneBill::Recipient=HASH(0x835b6b8) - 41 secs, 4.2 pence
  21:20:00) My::PhoneBill::Recipient=HASH(0x835a210) - 8 secs, 8.5 pence
  ...
  Total: 7 calls, 92 pence</code></pre>
<p>But now all it takes is a small tweak to the script:</p>
<pre><code>
    printf &quot;%s) %s - %d secs, %.1f pence\n&quot;,
      $call-&gt;calltime, $call-&gt;recipient-&gt;number, $call-&gt;duration, $call-&gt;cost;</code></pre>
<p>And now everything is working perfectly again:</p>
<pre><code>
  &gt; perl calls_on 2002-10-19
  ...
  18:36:00) 028 9024 4222 - 41 secs, 4.2 pence
  21:20:00) 123 - 8 secs, 8.5 pence
  ...
  Total: 7 calls, 92 pence</code></pre>
<p>The <code>calls_to</code> script is slightly trickier, as the initial search is now
on the recipient rather than the call.</p>
<p>So, we change the initial search to:</p>
<pre><code>
  my ($recipient) = My::PhoneBill::Recipient-&gt;search(number =&gt; $number)
    or die &quot;No calls to $number\n&quot;;</code></pre>
<p>Then we need to get all the calls to that recipient. For this, we need to
inform <code>Recipient</code> of the relationship with calls. Unlike the <code>has_a</code> we
just set up in the <code>Call</code> class, the recipient table doesn't store any value
concerned with the call table that could be inflated on demand. Instead
we need to add a <code>has_many</code> declaration to Recipient:</p>
<pre><code>
  __PACKAGE__-&gt;has_many(calls =&gt; 'My::PhoneBill::Call');</code></pre>
<p>This creates a new method <code>calls</code> for each Recipient object, returning
a list of <code>Call</code> objects whose <code>recipient</code> method is our primary key.</p>
<p>So, having found our recipient in the <code>calls_to</code> script, we can simply
ask:</p>
<pre><code>
  my @calls = $recipient-&gt;calls;</code></pre>
<p>And now the script works just as before:</p>
<pre><code>
  #!/usr/bin/perl
  
  use My::PhoneBill::Recipient;
  
  my $number = shift or die &quot;Usage: $0 &lt;number&gt;&quot;;
  
  my ($recipient) = My::PhoneBill::Recipient-&gt;search(number =&gt; $number)
    or die &quot;No calls to $number\n&quot;;
  my @calls = $recipient-&gt;calls;
  
  my $total_cost = 0;
  
  foreach my $call (@calls) {
    $total_cost += $call-&gt;cost;
    printf &quot;%s %s - %d secs, %.1f pence\n&quot;,
      $call-&gt;calldate, $call-&gt;calltime, $call-&gt;duration, $call-&gt;cost;
  }
  printf &quot;Total: %d calls, %d pence\n&quot;, scalar @calls, $total_cost;</code></pre>
<p>And now we can get the old results again:</p>
<pre><code>
  &gt; perl calls_to 123
  2002-09-17 11:06:00 - 5 secs, 8.5 pence
  2002-10-19 21:20:00 - 8 secs, 8.5 pence
  Total: 2 calls, 17 pence</code></pre>
<p>Next we need a script to give a name to a number in our address book:</p>
<pre><code>
  #!/usr/bin/perl
  
  use My::PhoneBill::Recipient;
  
  my($number, $name) = @ARGV;
  die &quot;Usage $0 &lt;number&gt; &lt;name&gt;\n&quot; unless $number and $name;
  
  my $recip = My::PhoneBill::Recipient-&gt;find_or_create({number =&gt; $number});
  my $old_name = $recip-&gt;name;
  $recip-&gt;name($name);
  $recip-&gt;commit;
  
  if ($old_name) {
    print &quot;OK. $number changed from $old_name to $name\n&quot;;
  } else {
    print &quot;OK. $number is $name\n&quot;;
  }</code></pre>
<p>This lets us associate a number to a name:</p>
<pre><code>
  &gt; perl add_phone_number 123 &quot;Speaking Clock&quot;
  OK. 123 is Speaking Clock</code></pre>
<p>And now with a tiny change to our calls_on script we can output the name
where known:</p>
<pre><code>
    printf &quot;%s) %s - %d secs, %.1f pence\n&quot;,
      $call-&gt;calltime, $call-&gt;recipient-&gt;name || $call-&gt;recipient-&gt;number,
      $call-&gt;duration, $call-&gt;cost;

  &gt; perl calls_on 2002-10-19
  ...
  18:36:00) 028 9024 4222 - 41 secs, 4.2 pence
  21:20:00) Speaking Clock - 8 secs, 8.5 pence
  ...
  Total: 7 calls, 92 pence</code></pre>
<p>To allow the <code>calls_to</code> script to work if we give it either a name or a
number, we can use:</p>
<pre><code>
  my $recipient = My::PhoneBill::Recipient-&gt;search(name =&gt; $number)
               || My::PhoneBill::Recipient-&gt;search(number =&gt; $number)
               || die &quot;No calls to $number\n&quot;;</code></pre>
<p>However, as we've called search in scalar context, rather than the
normal list context, we get back an interator rather than an individual
<code>Recipient</code> object. As one name may map to multiple numbers, we need to
iterate over each of these in turn:</p>
<pre><code>
    my @calls;
    while (my $recip = $recipient-&gt;next) {
      push @calls, $recip-&gt;calls;
    }</code></pre>
<p>(Printing individual totals for each number is left as an exercise for
the reader.)</p>
<pre><code>
  &gt; perl calls_to &quot;Speaking Clock&quot;
  2002-09-17 11:06:00 - 5 secs, 8.5 pence
  2002-10-19 21:20:00 - 8 secs, 8.5 pence
  Total: 2 calls, 17 pence</code></pre>
<p>
</p>
<h2><a name="working_with_other_modules">Working With Other Modules</a></h2>
<p>Sometimes the information we store in the database can be used to work
with non-<code>Class::DBI</code> modules. For example, if we wanted to format the
dates of our calls differently, we might like to turn them into
<code>Date::Simple</code> objects. Again, <code>Class::DBI</code> makes this easy.</p>
<p>In the <code>Call</code> class, we again use <code>has_a</code> to declare this relationship:</p>
<pre><code>
  __PACKAGE__-&gt;has_a(recipient =&gt; 'My::PhoneBill::Recipient');
 *__PACKAGE__-&gt;has_a(calldate  =&gt; 'Date::Simple');</code></pre>
<p>Now, when we fetch the <code>calldate</code> it is automatically inflated to a
<code>Date::Simple</code> object. So, we can change the output of <code>calls_to</code> to print
the date in a nicer format:</p>
<pre><code>
  printf &quot;%s %s - %d secs, %.1f pence\n&quot;,
    $call-&gt;calldate-&gt;format(&quot;%d %b&quot;), $call-&gt;calltime,
    $call-&gt;duration, $call-&gt;cost;
 
  &gt; perl calls_to &quot;Speaking Clock&quot;
  17 Sep 11:06:00 - 5 secs, 8.5 pence
  19 Oct 21:20:00 - 8 secs, 8.5 pence
  Total: 2 calls, 17 pence</code></pre>
<p><code>Class::DBI</code> assumes that any non-<code>Class::DBI</code> class is inflated through a
<code>new</code> method, and can be deflated through stringification. As both of
these are true for <code>Date::Simple</code>, we didn't need to do anything more. If
this is not the case - for example, if you wanted to use <code>Time::Piece</code> instead
of <code>Date::Simple</code> - you need to tell <code>Class::DBI</code> how to do the inflating
and deflating as the value goes in and comes out of the database.</p>
<pre><code>
  __PACKAGE__-&gt;has_a(calldate =&gt; 'Time::Piece',
    inflate =&gt; sub { Time::Piece-&gt;strptime(shift, &quot;%Y-%m-%d&quot;) },
    deflate =&gt; 'ymd'
  );</code></pre>
<p>Deflating a <code>Time::Piece</code> object back to an ISO date string suitable for
MySQL is quite simple: you can just call its <code>ymd()</code> method. Thus we can
specify this as a string. Inflating is more difficult, as it requires a
two argument call to <code>strptime()</code>. Thus we need to specify this as a
subroutine reference. When inflating, this is called with the value from
the database as its one and only argument. Thus, we can pass that to
<code>Time::Piece</code>'s <code>strptime</code> method, specifying the format to instantiate
from.</p>
<p>Using <code>Time::Piece</code> instead of <code>Date::Time</code> requires one further change to
to our output script:</p>
<pre><code>
  printf &quot;%s %s - %d secs, %.1f pence\n&quot;,
 *  $call-&gt;calldate-&gt;strftime(&quot;%d %b&quot;), $call-&gt;calltime,
    $call-&gt;duration, $call-&gt;cost;</code></pre>
<p>
</p>
<h2><a name="most_called_numbers">MOST CALLED NUMBERS</a></h2>
<p>BT provide a service that allows you to save money on 10 numbers of your
choice. So it would be useful if we were able to find out which numbers
we spend the most money calling. We'll assume that any number we've only
ever called once isn't worth adding to our list, as it was probably a
one-off call. Thus we want the 10 numbers with the highest spend that
have had more than one call.</p>
<p>As we said earlier, <code>Class::DBI</code> doesn't attempt to provide a syntax to
express any arbitrary SQL, so there's no way of asking directly for
this information. Instead, we'll try a simple approach.</p>
<p>Firstly we'll add a method to the <code>Recipient</code> class to tell us the total
we've spent on calls to that number:</p>
<pre><code>
  use List::Util 'sum';

  sub total_spend {
    my $self = shift;
    return sum map $_-&gt;cost, $self-&gt;calls;
  }</code></pre>
<p>Then we can create a <code>top_ten</code> script:</p>
<pre><code>
  #!/usr/bin/perl
  
  use My::PhoneBill::Recipient;
  
  my @recipients = My::PhoneBill::Recipient-&gt;retrieve_all;
  my @regulars = grep $_-&gt;calls &gt; 1, @recipients;
  my @sorted = sort { $b-&gt;total_spend &lt;=&gt; $a-&gt;total_spend } @regulars;
  
  foreach my $recip (@sorted[0 .. 9]) {
    printf &quot;%s - %d calls = %d pence\n&quot;,
      $recip-&gt;name || $recip-&gt;number,
      scalar $recip-&gt;calls,
      $recip-&gt;total_spend;
  }</code></pre>
<p>This is very slow, however, once you have more than a few hundred calls
stored in your database. This is mainly because we're sorting based on a
method call. Replacing the sort above with a Schwartzian Transform
speeds everything up significantly:</p>
<pre><code>
  my @sorted = map $_-&gt;[0],
    sort { $b-&gt;[1] &lt;=&gt; $a-&gt;[1] }
    map [ $_, $_-&gt;total_spend ], @regulars;</code></pre>
<p>Now, until the database gets significantly bigger, this is probably fast
enough - especially as you probably won't be running the script very
often.</p>
<p>However, if this isn't enough, then we can always drop back to SQL. Of
course, when we need to optimize for speed, we usually lose something
else - in this case, portability. In this example, we're using MySQL, so I
would add the relevant MySQL-specific query to <em>Recipient.pm</em>:</p>
<pre><code>
  __PACKAGE__-&gt;set_sql(top_ten =&gt; qq{
    SELECT recipient.recipid,
           SUM(call.cost) AS spend,
           COUNT(call.callid) AS calls
      FROM recipient, call
     WHERE recipient.recipid = call.recipient
     GROUP BY recipient.recipid
    HAVING calls &gt; 1
     ORDER BY spend DESC
     LIMIT 10
  });</code></pre>
<p>Then we can set up a method that returns the relevant objects for these:</p>
<pre><code>
  sub top_ten {
    my $class = shift;
    my $sth = $class-&gt;sql_top_ten;
       $sth-&gt;execute;
    return $class-&gt;sth_to_objects($sth);
  }</code></pre>
<p>Any SQL set up using <code>set_sql</code> can be retrieved as a readily prepared DBI
statement handle by prepending its name with <code>sql_</code> - thus we fetch back
this <code>top_ten</code> using <code>my $sth = $class-&gt;sql_top_ten</code>;</p>
<p>Although we could happily execute this and then call any of the
traditional DBI commands (<code>fetchrow_array</code> etc.), we can also take a
shortcut. As one of the columns being returned from our query is the
primary key of the Recipient, we can simply feed the results into the
underlying method in <code>Class::DBI</code> that allows searches to return a list
of objects, <code>sth_to_objects</code>.</p>
<p>So, our script becomes simply:</p>
<pre><code>
  foreach my $recip (My::PhoneBill::Recipient-&gt;top_ten) {
    printf &quot;%s - %d calls = %d pence\n&quot;,
      $recip-&gt;name || $recip-&gt;number,
      scalar $recip-&gt;calls,
      $recip-&gt;total_spend;
  }</code></pre>
<p>As we have seen, <code>Class::DBI</code> makes it possible to perform many of the
common database tasks completely trivially - without writing a single
line of SQL. But, when you really need it, it's fairly easy to 
write the SQL that you need and execute it.</p>


                                    </div>


                                </div>
                                <div class="asset-footer">

    
                                    <div class="entry-categories">
                                        <h4>Categories<span class="delimiter">:</span></h4>
                                        <ul>
                                            <li><a href="/pub/databases/" rel="tag">Databases</a></li>
                                        </ul>
                                    </div>
    


                                    <div class="entry-tags">
                                        <h4>Tags<span class="delimiter">:</span></h4>
                                        <ul>
                                            <li><a href="javascript:void(0)" onclick="location.href='http://www.perl.com/mt-search.cgi?blog_id=2&amp;tag=database%20class%20POOP%20Class%3A%3ADBI&amp;limit=20';return false;" rel="tag">database class POOP Class::DBI</a></li>
                                        </ul>
                                    </div>

                                </div>
                            </div>


                    
                    


                        </div>
                    </div>


                    <div id="beta">
    <div id="beta-inner">


    
    <div class="widget-what-is-perl widget">
    <div class="widget-content widget-content-what-is-perl">
       Visit the home of the  Perl programming language: <a href="http://www.perl.org/">Perl.org</a
    </div>
</div>
<div class="widget-find-out-more widget-archives widget">
    <div class="widget-content">
        <ul>
            <li><a href="http://www.perl.org/get.html">Download</a></li>
            <li><a href="http://perldoc.perl.org/">Documentation</a></li>
            <li><a href="http://blogs.perl.org/">Perl Bloggers</a></li>
            <li><a href="http://news.perlfoundation.org/">Foundation News</a></li>
        </ul>
    </div>
</div><div class="widget-tcpc widget">
<h3 class="widget-header">Sponsored by</h3>
    <div class="widget-content">
        <a href="http://training.perl.com/" alt="Perl Training" target="_blank"><img src="/i/tcpc.png" width="150" height="50"></a>
    </div>
</div>

<div class="widget-syndication widget">
    <div class="widget-content">
        <ul>
            <li><img src="/mt-static/images/status_icons/feed.gif" alt="Subscribe to feed" width="9" height="9" /> <a href="/pub/atom.xml">Subscribe to this website's feed</a></li>

        </ul>
    </div>
</div>
<div class="widget-archive-monthly widget-archive widget">
    <h3 class="widget-header">Monthly <a href="/pub/archives.html">Archives</a></h3>
    <div class="widget-content">
        <ul>
        
            <li><a href="/pub/2010/07/">July 2010 (1)</a></li>
        
    
        
            <li><a href="/pub/2008/05/">May 2008 (1)</a></li>
        
    
        
            <li><a href="/pub/2008/04/">April 2008 (2)</a></li>
        
    
        
            <li><a href="/pub/2008/03/">March 2008 (1)</a></li>
        
    
        
            <li><a href="/pub/2008/02/">February 2008 (1)</a></li>
        
    
        
            <li><a href="/pub/2008/01/">January 2008 (1)</a></li>
        
    
        
            <li><a href="/pub/2007/12/">December 2007 (2)</a></li>
        
    
        
            <li><a href="/pub/2007/09/">September 2007 (1)</a></li>
        
    
        
            <li><a href="/pub/2007/08/">August 2007 (1)</a></li>
        
    
        
            <li><a href="/pub/2007/07/">July 2007 (1)</a></li>
        
    
        
            <li><a href="/pub/2007/06/">June 2007 (1)</a></li>
        
    
        
            <li><a href="/pub/2007/05/">May 2007 (1)</a></li>
        
    
        
            <li><a href="/pub/2007/04/">April 2007 (1)</a></li>
        
    
        
            <li><a href="/pub/2007/03/">March 2007 (1)</a></li>
        
    
        
            <li><a href="/pub/2007/02/">February 2007 (1)</a></li>
        
    
        
            <li><a href="/pub/2007/01/">January 2007 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/12/">December 2006 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/11/">November 2006 (2)</a></li>
        
    
        
            <li><a href="/pub/2006/10/">October 2006 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/09/">September 2006 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/08/">August 2006 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/07/">July 2006 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/06/">June 2006 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/05/">May 2006 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/04/">April 2006 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/03/">March 2006 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/02/">February 2006 (4)</a></li>
        
    
        
            <li><a href="/pub/2006/01/">January 2006 (4)</a></li>
        
    
        
            <li><a href="/pub/2005/12/">December 2005 (4)</a></li>
        
    
        
            <li><a href="/pub/2005/11/">November 2005 (3)</a></li>
        
    
        
            <li><a href="/pub/2005/10/">October 2005 (2)</a></li>
        
    
        
            <li><a href="/pub/2005/09/">September 2005 (2)</a></li>
        
    
        
            <li><a href="/pub/2005/08/">August 2005 (9)</a></li>
        
    
        
            <li><a href="/pub/2005/07/">July 2005 (8)</a></li>
        
    
        
            <li><a href="/pub/2005/06/">June 2005 (9)</a></li>
        
    
        
            <li><a href="/pub/2005/05/">May 2005 (8)</a></li>
        
    
        
            <li><a href="/pub/2005/04/">April 2005 (7)</a></li>
        
    
        
            <li><a href="/pub/2005/03/">March 2005 (6)</a></li>
        
    
        
            <li><a href="/pub/2005/02/">February 2005 (7)</a></li>
        
    
        
            <li><a href="/pub/2005/01/">January 2005 (6)</a></li>
        
    
        
            <li><a href="/pub/2004/12/">December 2004 (8)</a></li>
        
    
        
            <li><a href="/pub/2004/11/">November 2004 (8)</a></li>
        
    
        
            <li><a href="/pub/2004/10/">October 2004 (5)</a></li>
        
    
        
            <li><a href="/pub/2004/09/">September 2004 (9)</a></li>
        
    
        
            <li><a href="/pub/2004/08/">August 2004 (6)</a></li>
        
    
        
            <li><a href="/pub/2004/07/">July 2004 (8)</a></li>
        
    
        
            <li><a href="/pub/2004/06/">June 2004 (6)</a></li>
        
    
        
            <li><a href="/pub/2004/05/">May 2004 (7)</a></li>
        
    
        
            <li><a href="/pub/2004/04/">April 2004 (8)</a></li>
        
    
        
            <li><a href="/pub/2004/03/">March 2004 (8)</a></li>
        
    
        
            <li><a href="/pub/2004/02/">February 2004 (9)</a></li>
        
    
        
            <li><a href="/pub/2004/01/">January 2004 (7)</a></li>
        
    
        
            <li><a href="/pub/2003/12/">December 2003 (4)</a></li>
        
    
        
            <li><a href="/pub/2003/11/">November 2003 (7)</a></li>
        
    
        
            <li><a href="/pub/2003/10/">October 2003 (8)</a></li>
        
    
        
            <li><a href="/pub/2003/09/">September 2003 (6)</a></li>
        
    
        
            <li><a href="/pub/2003/08/">August 2003 (7)</a></li>
        
    
        
            <li><a href="/pub/2003/07/">July 2003 (9)</a></li>
        
    
        
            <li><a href="/pub/2003/06/">June 2003 (9)</a></li>
        
    
        
            <li><a href="/pub/2003/05/">May 2003 (8)</a></li>
        
    
        
            <li><a href="/pub/2003/04/">April 2003 (8)</a></li>
        
    
        
            <li><a href="/pub/2003/03/">March 2003 (10)</a></li>
        
    
        
            <li><a href="/pub/2003/02/">February 2003 (8)</a></li>
        
    
        
            <li><a href="/pub/2003/01/">January 2003 (8)</a></li>
        
    
        
            <li><a href="/pub/2002/12/">December 2002 (5)</a></li>
        
    
        
            <li><a href="/pub/2002/11/">November 2002 (9)</a></li>
        
    
        
            <li><a href="/pub/2002/10/">October 2002 (7)</a></li>
        
    
        
            <li><a href="/pub/2002/09/">September 2002 (11)</a></li>
        
    
        
            <li><a href="/pub/2002/08/">August 2002 (8)</a></li>
        
    
        
            <li><a href="/pub/2002/07/">July 2002 (8)</a></li>
        
    
        
            <li><a href="/pub/2002/06/">June 2002 (4)</a></li>
        
    
        
            <li><a href="/pub/2002/05/">May 2002 (6)</a></li>
        
    
        
            <li><a href="/pub/2002/04/">April 2002 (6)</a></li>
        
    
        
            <li><a href="/pub/2002/03/">March 2002 (7)</a></li>
        
    
        
            <li><a href="/pub/2002/02/">February 2002 (5)</a></li>
        
    
        
            <li><a href="/pub/2002/01/">January 2002 (8)</a></li>
        
    
        
            <li><a href="/pub/2001/12/">December 2001 (7)</a></li>
        
    
        
            <li><a href="/pub/2001/11/">November 2001 (5)</a></li>
        
    
        
            <li><a href="/pub/2001/10/">October 2001 (9)</a></li>
        
    
        
            <li><a href="/pub/2001/09/">September 2001 (7)</a></li>
        
    
        
            <li><a href="/pub/2001/08/">August 2001 (13)</a></li>
        
    
        
            <li><a href="/pub/2001/07/">July 2001 (8)</a></li>
        
    
        
            <li><a href="/pub/2001/06/">June 2001 (13)</a></li>
        
    
        
            <li><a href="/pub/2001/05/">May 2001 (11)</a></li>
        
    
        
            <li><a href="/pub/2001/04/">April 2001 (9)</a></li>
        
    
        
            <li><a href="/pub/2001/03/">March 2001 (8)</a></li>
        
    
        
            <li><a href="/pub/2001/02/">February 2001 (8)</a></li>
        
    
        
            <li><a href="/pub/2001/01/">January 2001 (8)</a></li>
        
    
        
            <li><a href="/pub/2000/12/">December 2000 (6)</a></li>
        
    
        
            <li><a href="/pub/2000/11/">November 2000 (10)</a></li>
        
    
        
            <li><a href="/pub/2000/10/">October 2000 (10)</a></li>
        
    
        
            <li><a href="/pub/2000/09/">September 2000 (2)</a></li>
        
    
        
            <li><a href="/pub/2000/08/">August 2000 (2)</a></li>
        
    
        
            <li><a href="/pub/2000/07/">July 2000 (5)</a></li>
        
    
        
            <li><a href="/pub/2000/06/">June 2000 (7)</a></li>
        
    
        
            <li><a href="/pub/2000/05/">May 2000 (7)</a></li>
        
    
        
            <li><a href="/pub/2000/04/">April 2000 (3)</a></li>
        
    
        
            <li><a href="/pub/2000/03/">March 2000 (2)</a></li>
        
    
        
            <li><a href="/pub/2000/02/">February 2000 (2)</a></li>
        
    
        
            <li><a href="/pub/2000/01/">January 2000 (2)</a></li>
        
    
        
            <li><a href="/pub/1999/12/">December 1999 (6)</a></li>
        
    
        
            <li><a href="/pub/1999/11/">November 1999 (6)</a></li>
        
    
        
            <li><a href="/pub/1999/10/">October 1999 (5)</a></li>
        
    
        
            <li><a href="/pub/1999/09/">September 1999 (4)</a></li>
        
    
        
            <li><a href="/pub/1999/08/">August 1999 (3)</a></li>
        
    
        
            <li><a href="/pub/1999/07/">July 1999 (2)</a></li>
        
    
        
            <li><a href="/pub/1999/06/">June 1999 (3)</a></li>
        
    
        
            <li><a href="/pub/1999/04/">April 1999 (1)</a></li>
        
    
        
            <li><a href="/pub/1999/03/">March 1999 (1)</a></li>
        
    
        
            <li><a href="/pub/1999/01/">January 1999 (1)</a></li>
        
    
        
            <li><a href="/pub/1998/12/">December 1998 (1)</a></li>
        
    
        
            <li><a href="/pub/1998/11/">November 1998 (1)</a></li>
        
    
        
            <li><a href="/pub/1998/07/">July 1998 (2)</a></li>
        
    
        
            <li><a href="/pub/1998/06/">June 1998 (1)</a></li>
        
    
        
            <li><a href="/pub/1998/03/">March 1998 (1)</a></li>
        
        </ul>
    </div>
</div>
        
    

<div class="widget-powered widget">
    <div class="widget-content">
        <a href="http://www.movabletype.com/"><img src="/mt-static/images/bug-pbmt-white.png" alt="Powered by Movable Type 5.02" width="120" height="75" /></a>
    </div>
</div>



    </div>
</div>






                </div>
            </div>


            <div id="footer">
    <div id="footer-inner">
        <div id="footer-content">
            <div class="widget-powered widget">
                <div class="widget-content">
                    Powered by <a href="http://www.movabletype.com/" rel="generator">Movable Type Pro</a>
                </div>
            </div>

        </div>
    </div>
</div>



        </div>
    </div>
</body>
</html>
