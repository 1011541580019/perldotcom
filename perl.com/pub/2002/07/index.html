<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" id="sixapart-standard">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="generator" content="Movable Type Pro 5.13-en" />
<link rel="stylesheet" href="/pub/styles.css" type="text/css" />
<link rel="start" href="/pub/" title="Home" />
<link rel="alternate" type="application/atom+xml" title="Recent Entries" href="/pub/atom.xml" />
<script type="text/javascript" src="/pub/mt.js"></script>
<!--
<rdf:RDF xmlns="http://web.resource.org/cc/"
         xmlns:dc="http://purl.org/dc/elements/1.1/"
         xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#">
<Work rdf:about="/pub/">
<dc:title>Perl.com</dc:title>
<dc:description>news and views of the Perl programming language</dc:description>
<license rdf:resource="http://creativecommons.org/licenses/by-nc-nd/3.0/" />
</Work>
<License rdf:about="http://creativecommons.org/licenses/by-nc-nd/3.0/">
</License>
</rdf:RDF>
-->

<script type="text/javascript">

 var _gaq = _gaq || [];
 _gaq.push(['_setAccount', 'UA-50555-22']);
 _gaq.push(['_trackPageview']);

 (function() {
   var ga = document.createElement('script'); ga.type =
   'text/javascript'; ga.async = true;
   ga.src = ('https:' == document.location.protocol ? 'https://ssl' :
   'http://www') + '.google-analytics.com/ga.js';
   var s = document.getElementsByTagName('script')[0];
   s.parentNode.insertBefore(ga, s);
 })();

</script>
<script type='text/javascript' src='http://partner.googleadservices.com/gampad/google_service.js'></script>
<script type='text/javascript'>
GS_googleAddAdSenseService("ca-pub-4136420132070439");
GS_googleEnableAllServices();
</script>
<script type='text/javascript'>
GA_googleAddSlot("ca-pub-4136420132070439", "Perl_728x90");
</script>
<script type='text/javascript'>GA_googleFetchAds();</script>
    <title>Perl.com: July 2002 Archives</title>


    <link rel="prev" href="/pub/2002/06/" title="June 2002" />
    <link rel="next" href="/pub/2002/08/" title="August 2002" />

</head>
<body id="perl-com" class="mt-archive-listing mt-datebased-monthly-archive layout-wt">
    <div id="container">
        <div id="container-inner">


            <div id="header">
    <div id="header-inner">
        <div id="header-content">
        <span id="top_advert"> 
<!-- Put any landscape advert in here -->
<!-- Perl_728x90 -->
<script type='text/javascript'>
GA_googleFillSlot("Perl_728x90");
</script>
        </span> 



            <div id="header-name"><a href="/pub/" accesskey="1">Perl.com</a></div>
            <div id="header-description">news and views of the Perl programming language</div>




        </div>
    </div>
</div>



            <div id="content">
                <div id="content-inner">


                    <div id="alpha">
                        <div id="alpha-inner">


                            <h1 id="page-title" class="archive-title">July 2002 Archives</h1>





                            
                            <div id="entry-1328" class="entry-asset asset hentry">
    <div class="asset-header">
        <h2 class="asset-name entry-title"><a href="/pub/2002/07/30/mod_perl.html" rel="bookmark">Improving mod_perl Sites' Performance: Part 4</a></h2>
        <div class="asset-meta">
            <span class="byline">
    
                By <span class="vcard author">Stas Bekman</span> on <abbr class="published" title="2002-07-30T00:00:00-08:00">July 30, 2002 12:00 AM</abbr>
    
            </span>

            
            

        </div>
    </div>
    <div class="asset-content entry-content">

        <div class="asset-body">
            
<!-- sidebar begins -->
<!-- don't move sidebars -->
<!-- sidebar ends -->

<h3><a name="introduction">Introduction</a></h3>
<p>If your OS supports sharing of memory (and most sane systems do), you
might save a lot of RAM by sharing it between child processes. This
will allow you to run more processes and hopefully better satisfy the
client, without investing extra money into buying more memory.</p>

<p>This is only possible when you preload code at server startup.
However, during a child process' life, its memory pages tend to become
unshared. There is no way we can make Perl allocate memory so that
(dynamic) variables land on different memory pages from constants, so
the <strong>copy-on-write</strong> effect will hit you almost at random.</p>

<p>If you are pre-loading many modules, you might be able to trade off the
memory that stays shared against the time for an occasional fork by
tuning <code>MaxRequestsPerChild</code>.  Each time a child reaches this upper
limit and dies, it should release its unshared pages.  The new child
which replaces it will share its fresh pages until it scribbles on
them.</p>


<p>The ideal is a point where your processes usually restart before too
much memory becomes unshared.  You should take some measurements to
see if it makes a real difference, and to find the range of reasonable
values.  If you have success with this, tuning the value of
<code>MaxRequestsPerChild</code> will probably be peculiar to your situation and
may change with changing circumstances.</p>

<csperl file="grab" domain="on" record="b/832" template="b/article_sidebar2.view">

<p>It is very important to understand that your goal is not to have
<code>MaxRequestsPerChild</code> to be 10000. Having a child serving 300
requests on precompiled code is already a huge overall speedup, so if
it is 100 or 10000 it probably does not really matter if you can save
RAM by using a lower value.</p>

<p>Do not forget that if you preload most of your code at server startup,
the newly forked child gets ready very very fast, because it inherits
most of the preloaded code and the perl interpreter from the parent
process.</p>

<p>During the life of the child, its memory pages (which aren't really its
own to start with, it uses the parent's pages) gradually get `dirty' -
variables which were originally inherited and shared are updated or
modified -- and the <em>copy-on-write</em> happens.  This reduces the number
of shared memory pages, thus increasing the memory requirement.
Killing the child and spawning a new one allows the new child to get
back to the pristine shared memory of the parent process.</p>

<p>The recommendation is that <code>MaxRequestsPerChild</code> should not be too
large, otherwise you lose some of the benefit of sharing memory.</p>


<h3><a name="how_shared_is_my_memory">How Shared Is My Memory?</a></h3>
<p>You've probably noticed that the word shared is repeated many times in
relation to <code>mod_perl</code>.  Indeed, shared memory might save you a lot of
money, since with sharing in place you can run many more servers than
without it.</p>

<p>How much shared memory do you have?  You can see it by either using
the memory utility that comes with your system or you can deploy the
<code>GTop</code> module:</p>

<pre><code>
  use GTop ();
  print &quot;Shared memory of the current process: &quot;,
    GTop-&gt;new-&gt;proc_mem($$)-&gt;share,&quot;\n&quot;;
  
  print &quot;Total shared memory: &quot;,
    GTop-&gt;new-&gt;mem-&gt;share,&quot;\n&quot;;</code></pre>
<p>When you watch the output of the <code>top</code> utility, don't confuse the
<code>RES</code> (or <code>RSS</code>) columns with the <code>SHARE</code> column.  <code>RES</code> is
RESident memory, which is the size of pages currently swapped in.</p>















<h3><a name="calculating_real_memory_usage">Calculating Real Memory Usage</a></h3>
<p>I have shown how to measure the size of the process' shared memory,
but we still want to know what the real memory usage is.  Obviously
this cannot be calculated simply by adding up the memory size of each
process because that wouldn't account for the shared memory.</p>

<p>On the other hand we cannot just subtract the shared memory size from
the total size to get the real memory usage numbers, because in
reality each process has a different history of processed requests,
therefore the shared memory is not the same for all processes.</p>

<p>So how do we measure the real memory size used by the server we run?
It's probably too difficult to give the exact number, but I've found a
way to get a fair approximation, which was verified in the following
way. I calculated the real memory used by a technique you will
see in the moment, and then stopped the Apache server and saw
that the memory usage report indicated that the total used memory went
down by almost the same number I've calculated.  Note that some
OSs do smart memory pages caching so you may not see the memory usage
decrease as soon as it actually happens when you quit the application.</p>

<p>This is a technique I've used:</p>

<ol>
<li>
For each process sum up the difference between shared and system
memory. To calculate a difference for a single process use:
<pre><code>
  use GTop;
  my $proc_mem = GTop-&gt;new-&gt;proc_mem($$);
  my $diff     = $proc_mem-&gt;size - $proc_mem-&gt;share;
  print &quot;Difference is $diff bytes\n&quot;;</code></pre>
</li>

<li>
Now if we add the shared memory size of the process with maximum
shared memory, we will get all the memory that actually is being used
by all httpd processes, except for the parent process.
</li>

<li>
Finally, add the size of the parent process.
</li>
</ol>

<p>Please note that this might be incorrect for your system, so you use
this number on your own risk.</p>

<p>I've used this technique to display real memory usage in the module
<code>Apache::VMonitor</code> (see the previous article), so instead of trying
to manually calculate this number you can use this module to do it
automatically.  In fact in the calculations used in this module there
is no separation between the parent and child processes, they are all
counted indifferently using the following code:</p>

<pre><code>
  use GTop ();
  my $gtop = GTop-&gt;new;
  my $total_real = 0;
  my $max_shared = 0;
  # @mod_perl_pids is initialized by Apache::Scoreboard,
  # irrelevant here
  my @mod_perl_pids = some_code();
  for my $pid (@mod_perl_pids)
    my $proc_mem = $gtop-&gt;proc_mem($pid);
    my $size     = $proc_mem-&gt;size($pid);
    my $share    = $proc_mem-&gt;share($pid);
    $total_real += $size - $share;
    $max_shared  = $share if $max_shared &lt; $share;
  }
  $total_real += $max_shared;</code></pre>
<p>So as you see we that we accumulate the difference between the shared
and reported memory:</p>

<pre><code>
    $total_real  += $size-$share;</code></pre>
<p>and at the end add the biggest shared process size:</p>

<pre><code>
  $total_real += $max_shared;</code></pre>
<p>So now <code>$total_real</code> contains approximately the really used memory.</p>














<h3><a name="are_my_variables_shared">Are My Variables Shared?</a></h3>
<p>How do you find out if the code you write is shared between the
processes or not?  The code should be shared, except where it is on a
memory page with variables that change.  Some variables are read-only
in usage and never change.  For example, if you have some variables
that use a lot of memory and you want them to be read-only.  As you
know the variable becomes unshared when the process modifies its
value.</p>

<p>So imagine that you have this 10Mb in-memory database that resides in
a single variable, you perform various operations on it and want to
make sure that the variable is still shared.  For example if you do
some matching regular expression (regex) processing on this variable
and want to use the <code>pos()</code> function, will it make the variable unshared
or not?</p>

<p>The <code>Apache::Peek</code> module comes to rescue.  Let's write a module
called <em>MyShared.pm</em> which we preload at server startup, so all the
variables of this module are initially shared by all children.</p>

<pre><code>
  MyShared.pm
  ---------
  package MyShared;
  use Apache::Peek;
  
  my $readonly = &quot;Chris&quot;;
  
  sub match    { $readonly =~ /\w/g;               }
  sub print_pos{ print &quot;pos: &quot;,pos($readonly),&quot;\n&quot;;}
  sub dump     { Dump($readonly);                  }
  1;</code></pre>
  
<p>This module declares the package <code>MyShared</code>, loads the
<code>Apache::Peek</code> module and defines the lexically scoped <code>$readonly</code>
variable which is supposed to be a variable of large size (think about
a huge hash data structure), but we will use a small one to simplify
this example.</p>

<csquery path="q/21" where="cs_rid != {cs_rid}">

<p>The module also defines three subroutines: <code>match()</code> that does a simple
character matching, <code>print_pos()</code> that prints the current position of
the matching engine inside the string that was last matched and
finally the <code>dump()</code> subroutine that calls the <code>Apache::Peek</code> module's
<code>Dump()</code> function to dump a raw Perl data-type of the <code>$readonly</code>
variable.</p>

<p>Here is the script that prints the process ID (PID) and calls all
three functions.  The goal is to check whether <code>pos()</code> makes the
variable <em>dirty</em> and therefore unshared.</p>

<pre><code>
  share_test.pl
  -------------
  use MyShared;
  print &quot;Content-type: text/plain\r\n\r\n&quot;;
  print &quot;PID: $$\n&quot;;
  MyShared::match();
  MyShared::print_pos();
  MyShared::dump();</code></pre>
  
<p>Before you restart the server, in <em>httpd.conf</em> set:</p>

<pre><code>
  MaxClients 2</code></pre>
  
<p>for easier tracking.  You need at least two servers to compare the
print outs of the test program.  Having more than two can make the
comparison process harder.</p>

<p>Now open two browser windows and issue the request for this script
several times in both windows, so you get different processes PIDs
reported in the two windows and each process has processed a different
number of requests to the <em>share_test.pl</em> script.</p>

<p>In the first window you will see something like that:</p>

<pre><code>
  PID: 27040
  pos: 1
  SV = PVMG(0x853db20) at 0x8250e8c
    REFCNT = 3
    FLAGS = (PADBUSY,PADMY,SMG,POK,pPOK)
    IV = 0
    NV = 0
    PV = 0x8271af0 &quot;Chris&quot;\0
    CUR = 5
    LEN = 6
    MAGIC = 0x853dd80
      MG_VIRTUAL = &amp;vtbl_mglob
      MG_TYPE = 'g'
      MG_LEN = 1</code></pre>
      
<p>And in the second window:</p>

<pre><code>
  PID: 27041
  pos: 2
  SV = PVMG(0x853db20) at 0x8250e8c
    REFCNT = 3
    FLAGS = (PADBUSY,PADMY,SMG,POK,pPOK)
    IV = 0
    NV = 0
    PV = 0x8271af0 &quot;Chris&quot;\0
    CUR = 5
    LEN = 6
    MAGIC = 0x853dd80
      MG_VIRTUAL = &amp;vtbl_mglob
      MG_TYPE = 'g'
      MG_LEN = 2</code></pre>


<p>We see that all the addresses of the supposedly big structure are the
same (<code>0x8250e8c</code> and <code>0x8271af0</code>), therefore the variable data
structure is almost completely shared.  The only difference is in
<code>SV.MAGIC.MG_LEN</code> record, which is not shared.</p>















<p>So given that the <code>$readonly</code> variable is a big one, its value is
still shared between the processes, while part of the variable data
structure is non-shared.  But it's almost insignificant because it
takes a very little memory space.</p>

<p>Now if you need to compare more than variable, doing it by hand can be
quite time consuming and error prune.  Therefore it's better to
correct the testing script to dump the Perl data-types into files (e.g
<em>/tmp/dump.$$</em>, where <code>$$</code> is the PID of the process) and then using
<code>diff(1)</code> utility to see whether there is some difference.</p>

<p>So correcting the <code>dump()</code> function to write the info to the file will
do the job. Notice that I use <code>Devel::Peek</code> and not
<code>Apache::Peek</code>. The both are almost the same, but <code>Apache::Peek</code>
prints it output directly to the opened socket so I cannot intercept
and redirect the result to the file. Since <code>Devel::Peek</code> dumps
results to the STDERR stream I can use the old trick of saving away
the default STDERR handler, and open a new filehandler using the
STDERR. In our example when <code>Devel::Peek</code> now prints to STDERR it
actually prints to our file. When I'm done, I make sure to restore the
original STDERR filehandler.</p>

<p>So this is the resulting code:</p>

<pre><code>
  MyShared2.pm
  ---------
  package MyShared2;
  use Devel::Peek;
  
  my $readonly = &quot;Chris&quot;;
  
  sub match    { $readonly =~ /\w/g;               }
  sub print_pos{ print &quot;pos: &quot;,pos($readonly),&quot;\n&quot;;}
  sub dump{
    my $dump_file = &quot;/tmp/dump.$$&quot;;
    print &quot;Dumping the data into $dump_file\n&quot;;
    open OLDERR, &quot;&gt;&amp;STDERR&quot;;
    open STDERR, &quot;&gt;&quot;.$dump_file or die &quot;Can't open $dump_file: $!&quot;;
    Dump($readonly);
    close STDERR ;
    open STDERR, &quot;&gt;&amp;OLDERR&quot;;
  }
  1;</code></pre>


<p>When if I modify the code to use the modified module:</p>

<pre><code>
  share_test2.pl
  -------------
  use MyShared2;
  print &quot;Content-type: text/plain\r\n\r\n&quot;;
  print &quot;PID: $$\n&quot;;
  MyShared2::match();
  MyShared2::print_pos();
  MyShared2::dump();</code></pre>


<p>And run it as before (with MaxClients&nbsp;2), two dump files will be
created in the directory <em>/tmp</em>.  In our test these were created as
<em>/tmp/dump.1224</em> and <em>/tmp/dump.1225</em>. When I run diff(1):</p>

<pre><code>
  % diff /tmp/dump.1224 /tmp/dump.1225
  12c12
  &lt;       MG_LEN = 1
  ---
  &gt;       MG_LEN = 2</code></pre>


<p>We see that the two padlists (of the variable <code>readonly</code>) are
different, as we have observed before when I did a manual comparison.</p>

<p>In fact we if we think about these results again, we get to a
conclusion that there is no need for two processes to find out whether
the variable gets modified (and therefore unshared). It's enough to
check the datastructure before the script was executed and after that.
You can modify the <code>MyShared2</code> module to dump the padlists into a
different file after each invocation and than to run the <code>diff(1)</code> on
the two files.</p>

<p>If you want to watch whether some lexically scoped (with <code>my())</code>
variables in your <code>Apache::Registry</code> script inside the same process
get changed between invocations you can use the
<code>Apache::RegistryLexInfo</code> module instead.  Since it does exactly
this: it makes a snapshot of the padlist before and after the code
execution and shows the difference between the two.  This specific
module was written to work with <code>Apache::Registry</code> scripts so it
won't work for loaded modules. Use the technique I have described
above for any type of variables in modules and scripts.</p>


<p>Surely another way of ensuring that a scalar is readonly and therefore
sharable is to either use the <code>constant</code> pragma or <code>readonly</code>
pragma.  But then you won't be able to make calls that alter the
variable even a little, like in the example that I've just showen,
because it will be a true constant variable and you will get compile
time error if you try this:</p>

<pre><code>
  MyConstant.pm
  -------------
  package MyConstant;
  use constant readonly =&gt; &quot;Chris&quot;;
  
  sub match    { readonly =~ /\w/g;               }
  sub print_pos{ print &quot;pos: &quot;,pos(readonly),&quot;\n&quot;;}
  1;
  
  % perl -c MyConstant.pm
  
  Can't modify constant item in match position at MyConstant.pm line
  5, near &quot;readonly)&quot;
  MyConstant.pm had compilation errors.</code></pre>


<p>However this code is just right:</p>

<pre><code>
  MyConstant1.pm
  -------------
  package MyConstant1;
  use constant readonly =&gt; &quot;Chris&quot;;
  
  sub match { readonly =~ /\w/g; }
  1;</code></pre>















<h3><a name="preloading_perl_modules_at_server_startup">Preloading Perl Modules at Server Startup</a></h3>
<p>You can use the <code>PerlRequire</code> and <code>PerlModule</code> directives to load
commonly used modules such as <code>CGI.pm</code>, <code>DBI</code> and etc., when the
server is started.  On most systems, server children will be able to
share the code space used by these modules.  Just add the following
directives into <em>httpd.conf</em>:</p>

<pre><code>
  PerlModule CGI
  PerlModule DBI</code></pre>


<p>But an even better approach is to create a separate startup file
(where you code in plain perl) and put there things like:</p>

<pre><code>
  use DBI ();
  use Carp ();</code></pre>


<p>Don't forget to prevent importing of the symbols exported by default
by the module you are going to preload, by placing empty parentheses
<code>()</code> after a module's name.  Unless you need some of these in the
startup file, which is unlikely.  This will save you a few more memory
bits.</p>

<p>Then you <code>require()</code> this startup file in <em>httpd.conf</em> with the
<code>PerlRequire</code> directive, placing it before the rest of the mod_perl
configuration directives:</p>

<pre><code>
  PerlRequire /path/to/start-up.pl</code></pre>



<p><code>CGI.pm</code> is a special case.  Ordinarily <code>CGI.pm</code> autoloads most of
its functions on an as-needed basis.  This speeds up the loading time
by deferring the compilation phase.  When you use mod_perl, FastCGI or
another system that uses a persistent Perl interpreter, you will want
to precompile the functions at initialization time.  To accomplish
this, call the package function <code>compile()</code> like this:</p>

<pre><code>
  use CGI ();
  CGI-&gt;compile(':all');</code></pre>


<p>The arguments to <code>compile()</code> are a list of method names or sets, and
are identical to those accepted by the <code>use()</code> and <code>import()</code>
operators.  Note that in most cases you will want to replace <code>':all'</code>
with the tag names that you actually use in your code, since generally
you only use a subset of them.</p>

<p>Let's conduct a memory usage test to prove that preloading, reduces
memory requirements.</p>

<p>In order to have an easy measurement I will use only one child
process, therefore I will use this setting:</p>

<pre><code>
  MinSpareServers 1
  MaxSpareServers 1
  StartServers 1
  MaxClients 1
  MaxRequestsPerChild 100</code></pre>


<p>I'm going to use the <code>Apache::Registry</code> script <em>memuse.pl</em> which
consists of two parts: the first one preloads a bunch of modules (that
most of them aren't going to be used), the second part reports the
memory size and the shared memory size used by the single child
process that I start. and of course it prints the difference between
the two sizes.</p>

<pre><code>
  memuse.pl
  ---------
  use strict;
  use CGI ();
  use DB_File ();
  use LWP::UserAgent ();
  use Storable ();
  use DBI ();
  use GTop ();</code></pre>


<pre><code>
  my $r = shift;
  $r-&gt;send_http_header('text/plain');
  my $proc_mem = GTop-&gt;new-&gt;proc_mem($$);
  my $size  = $proc_mem-&gt;size;
  my $share = $proc_mem-&gt;share;
  my $diff  = $size - $share;
  printf &quot;%10s %10s %10s\n&quot;, qw(Size Shared Difference);
  printf &quot;%10d %10d %10d (bytes)\n&quot;,$size,$share,$diff;</code></pre>


<p>First I restart the server and execute this CGI script when none of
the above modules preloaded. Here is the result:</p>

<pre><code>
     Size   Shared     Diff
  4706304  2134016  2572288 (bytes)</code></pre>


<p>Now I take all the modules:</p>

<pre><code>
  use strict;
  use CGI ();
  use DB_File ();
  use LWP::UserAgent ();
  use Storable ();
  use DBI ();
  use GTop ();</code></pre>


<p>and copy them into the startup script, so they will get preloaded.
The script remains unchanged.  I restart the server and execute it
again. I get the following.</p>

<pre><code>
     Size   Shared    Diff
  4710400  3997696  712704 (bytes)</code></pre>


<p>Let's put the two results into one table:</p>

<pre><code>
  Preloading    Size   Shared     Diff
     Yes     4710400  3997696   712704 (bytes)
      No     4706304  2134016  2572288 (bytes)
  --------------------------------------------
  Difference    4096  1863680 -1859584</code></pre>


<p>You can clearly see that when the modules weren't preloaded the shared
memory pages size, were about 1864Kb smaller relative to the case
where the modules were preloaded.</p>

<p>Assuming that you have had 256M dedicated to the web server, if you
didn't preload the modules, you could have:</p>

<pre><code>
  268435456 = X * 2572288 + 2134016</code></pre>


<pre><code>
  X = (268435456 - 2134016) / 2572288 = 103</code></pre>


<p>103 servers.</p>

<p>Now let's calculate the same thing with modules preloaded:</p>

<pre><code>
  268435456 = X * 712704 + 3997696</code></pre>


<pre><code>
  X = (268435456 - 3997696) / 712704 = 371</code></pre>


<p>You can have almost 4 times more servers!!!</p>

<csquery path="q/21" where="cs_rid != {cs_rid}">

<p>Remember that I have mentioned before that memory pages gets dirty
and the size of the shared memory gets smaller with time? So I have
presented the ideal case where the shared memory stays
intact. Therefore the real numbers will be a little bit different, but
not far from the numbers in our example.</p>

<p>Also it's obvious that in your case it's possible that the process
size will be bigger and the shared memory will be smaller, since you
will use different modules and a different code, so you won't get this
fantastic ratio, but this example is certainly helps to feel the
difference.</p>



<h3><a name="references">References</a></h3>
<ul>
<li>
The mod_perl site's URL: <a href="http://perl.apache.org/">http://perl.apache.org/</a>
</li>
<br />
<li>
<code>GTop</code>
<p><a href="http://search.cpan.org/search?dist=GTop">http://search.cpan.org/search?dist=GTop</a></p>

<p><code>GTop</code> relies in turn on libgtop library not available for all platforms</p>

<p>Visit <a href="http://home-of-linux.org/gnome/libgtop/">http://home-of-linux.org/gnome/libgtop/</a> for more information</p>

</li>

<li>
<code>Apache::Peek</code>
<p><a href="http://search.cpan.org/search?dist=Apache-Peek">http://search.cpan.org/search?dist=Apache-Peek</a></p>

</li>

<li>
<code>Devel::Peek</code>
<p><a href="http://search.cpan.org/search?dist=Devel-Peek">http://search.cpan.org/search?dist=Devel-Peek</a></p>

</li>
</ul>

        </div>



    </div>
    <div class="asset-footer"></div>
</div>


                            
                            <div id="entry-1334" class="entry-asset asset hentry">
    <div class="asset-header">
        <h2 class="asset-name entry-title"><a href="/pub/2002/07/p6pdigest/20020723.html" rel="bookmark">This week on Perl 6 (week ending 2002-07-21)</a></h2>
        <div class="asset-meta">
            <span class="byline">
    
                By <span class="vcard author">Leon Brocard</span> on <abbr class="published" title="2002-07-23T00:00:00-08:00">July 23, 2002 12:00 AM</abbr>
    
            </span>

            
            

        </div>
    </div>
    <div class="asset-content entry-content">

        <div class="asset-body">
            

<p>Another week, another Perl 6 summary. Cunningly this week I have taken
over the summary from Piers in order to make it easier for me to
namecheck myself. It's been a good week too, with more happening in
perl6-internals than perl6-language. So that's where I'll start...</p>

<h2><a name="parrot_0.0.7">Parrot 0.0.7</a></h2>
<p>The big news for this week is that DrForr has released Parrot 0.0.7 to
the world (strange that lots of open source projects are releasing
code just before the O'Reilly Open Source conference...). This release
contains a Perl 6 grammar (with small, partial compiler!), functional
subroutine, coroutine and continuation PMCs, global variables, an
intermediate code compiler (imcc), a pure-Perl assembler and working
garbage collection. "The name is Parrot. Percy Parrot."</p>
<p><a href="http://archive.develooper.com/perl6-internals@perl.org/msg11090.html">http://archive.develooper.com/perl6-internals@perl.org/msg11090.html</a><br />
<a href="http://www.cpan.org/modules/by-authors/id/J/JG/JGOFF/parrot-0.0.7.tgz">http://www.cpan.org/modules/by-authors/id/J/JG/JGOFF/parrot-0_0_7.tgz</a></p>

<csquery path="q/20" where="cs_rid != {cs_rid}">

<p>Note that the really cool Perl 6 compiler needs at least Perl 5.6. Oh,
and check out imcc if you haven't looked at it yet.</p>

<h2><a name="retro_perl">Retro Perl</a></h2>
<p>Nicholas Clark stated that "In October 2000 I believed that 5.005
maintenance *is* important for the acceptance of perl6, and I still do
now". A first patch to the preliminary Perl 6 compiler was sent by
Leopold Toetsch to make it work on 5.005_03 and seeing as Chip
Salzenberg has restarted work on a new maintenance release of Perl
5.005 it's probably good for various parts of Parrot to run on retro
perls. Shouldn't be a major problem.</p>

<h2><a name="parrot_docs">Parrot docs</a></h2>
<p>One of the big pushes last week was for more documentation inside
Parrot. Writing documentation is always a problem for an open source
project and it hit the wall last week. The good news is that lots of
new documentation has been added to Parrot.</p>
<p>There was some discussion on the nature of documentation. The result
is that inline C documention should write up API details and that
longer discussions (say, the choice of algorithms, how to avoid
overflows in unsigned arithmetic, the pros and cons of differing
hash algorithms) would end up as .dev files inside the docs/dev/
directory, much as PDD07 "Conventions and Guidelines for Perl Source
Code" says. A few more documentation patches followed.</p>
<p>Recently the mailing list and IRC channel have been quite busy and it
seems like the new push for more documentation has attracted new
people. Bonus!</p>
<p><a href="http://archive.develooper.com/perl6-internals@perl.org/msg11080.html">http://archive.develooper.com/perl6-internals@perl.org/msg11080.html</a></p>


<h2><a name="manifestations">MANIFESTations</a></h2>
<p>The Parrot MANIFEST file tends not to be kept up-to-date with recent
additions. Andy Dougherty produced a patch to do this. Nicholas Clark
asked: "Is CVS flexible enough to let us run a manifest check on each
commit and generate warnings that get sent somewhere useful if it
fails?". Robert Spier answered that it could and with any luck he'll
get it in soon...</p>













<h2><a name="recall">RECALL</a></h2>

<p>Tanton Gibbs posted a patch to clean up a problem with our Copy on
Write strategy. He kindly explained it for me: "The basic problem is
that in perlint.pmc we have something like:</p>
<pre><code>
  void set_string( PMC* value ) {
    CHANGE_TYPE( SELF, PerlString );
    SELF-&gt;data = value-&gt;data
  }</code></pre>
<p>In other words implement a COW strategy after being changed into a
PerlString. However, in perlstring.pmc the following is performed:</p>
<pre><code>
  void set_string( PMC* value ) {
    SELF-&gt;data = string_copy( INTERP, value-&gt;data );
  }</code></pre>
<p>The RECALL command automates that so that set_string now looks like:</p>
<pre><code>
  void set_string( PMC* value ) {
    CHANGE_TYPE( pmc, PerlString );
    RECALL;
  }</code></pre>
<p>Thanks to Tanton for explaining.</p>


<h2><a name="internals_misc">Internals misc</a></h2>
<p>There were also lots of other small patches and discussions. It looks
like the push for this week is to make it easier to add new PMCs to
Parrot.</p>


<h2><a name="meanwhile,_in_perl6language">Meanwhile, in perl6-language</a></h2>
<p>It was a quiet week in the perl6-language list, which is probably a
good thing as thinking too much about hyper operators makes my head
hurt.</p>


<h2><a name="hyper_operators">Hyper operators</a></h2>
<p>There was some discussion on hyper operators this week. It didn't go
anywhere in particular, but discussed lots of syntax. Objections such
as "this code looks ugly!" came up regularly when talking about code
such as:</p>
<pre><code>
  @solution =  (^-@b + sqrt(@b^**2 ^+ 4^*@a^*@c) ) ^/ (2^*@a);</code></pre>
<p>Luke Palmer pointed out that it might be better expressed as:</p>
<pre><code>
  for @a; @b; @c; @s is rw -&gt;
    $a; $b; $c; $s {
      $s = (-$b + sqrt($b**2 - 4*$a*$c)) / (2*$a)
  }</code></pre>
<p>Karl Glazebrook explained that PDL keeps everything as objects and
does hyper operator magic without additional syntax. So Perl 6 "@y =
$a ^* @x ^+ @b" happens in PDL with the clearer "$y = $a * $x + $b".
Isn't PDL shiny?</p>


<h1><a name="whitespace">Whitespace?</a></h1>
<p>Brent Dax noticed that there might be a problem with the regular
expression modifier ":w". The words modifier, according to Apocalypse
5 , "causes an implicit match of whitespace wherever there's literal
whitespace in a pattern". He asked what the following expand to:</p>
<pre><code>
  m:w/foo [~|bar]/
  m:w/[~|bar] foo/
  m:w/[~|bar] [^|baz]/
  m:w/@foo @bar/</code></pre>
<p>Luke Palmer expanded that "In other words, it replaces every sequence
of actual whitespace in the pattern with a \s+ (between two
identifiers) or a \s* (between anything else)". Thus, the first would
expand to:</p>
<pre><code>
  m/ foo \s* [~ | bar] /</code></pre>
<p>However, it's not easy to represent, as the later cases point out. He
continues: "Perhaps :w wouldn't transform the rexex, but keep
'markers' on where there was whitespace in the regex". Nevertheless,
it's a very useful feature.</p>


<h2><a name="acknowledgements">Acknowledgements</a></h2>
<p>This summary was brought to you from the O'Reilly Open Source
conference and with the music from the intro to Buffy the Vampire
Slayer.</p>
<p>As Piers says: Once again, if you liked this, then give money to YAS,
if you didn't like it, well, then you can still give them money; maybe
they'll use it to hire a better writer. Or maybe you could write a
competing summary.</p>


        </div>



    </div>
    <div class="asset-footer"></div>
</div>


                            
                            <div id="entry-1326" class="entry-asset asset hentry">
    <div class="asset-header">
        <h2 class="asset-name entry-title"><a href="/pub/2002/07/23/review.html" rel="bookmark">Graphics Programming with Perl</a></h2>
        <div class="asset-meta">
            <span class="byline">
    
                By <span class="vcard author">Simon Cozens</span> on <abbr class="published" title="2002-07-23T00:00:00-08:00">July 23, 2002 12:00 AM</abbr>
    
            </span>

            
            

        </div>
    </div>
    <div class="asset-content entry-content">

        <div class="asset-body">
            <p>
I recently received Martien Verbruggen's long-awaited "Graphics
Programming in Perl," and I wasn't quite sure what to make of it. As he
notes himself, "I didn't think there would be enough coherent material
to write such a book, and I wasn't entirely certain there would be much
room for one." Sure, you can write a chapter or so on business graphing --
something on GraphViz -- and a few chapters on GD, Imager and
<code>Image::Magick</code>. But an entire book?
</p>

<p>
Like Martien, the more I look at this topic, the more there is to say,
and the more comfortable I am with the way Martien says it. The book
seems to concentrate primarily on <code>Image::Magick</code>, with some
examples of <code>GD</code>. 
</p>


<p>
All technical books seem to begin with a certain amount of introductory
waffle; in "Graphics Programming in Perl," the waffle is at least to some
degree relevant - there's a fundamental introduction to such things as
color spaces, including some relatively fearsome equations converting
between the various color systems. The introduction is carried on
through chapter 2, a review of graphics file formats. I can't really
categorize this as waffle, though, since a thorough understanding of
these things are fundamental to graphics programming.
</p>


<p>
The real Perl meat starts around the middle of chapter 2, with sections
on finding the size of an image and converting between images.
Unfortunately, there's more introductory material again in chapter 3,
with sections on the CPAN and descriptions on the modules that will be
used in the rest of the book. Hence, I wouldn't really say this was the
fastest-starting book around, and most people will be able to happily
skip the first 30 or 35 pages without much loss of continuity.
</p>

<p>
Chapter 4 is where we actually start using Perl to draw things, the
stated purpose of the book. We begin with drawing simple objects in GD,
which is adequately explained, but unfortunately, there's no mention of
how to save the images yet, so we can't check them or play with the
examples and examine the results!
</p>

<p>
Next, the same examples are implemented using
<code>Image::Magick</code>, a good comparison of the two modules;
there's also another good comparison in the middle of an ill-fitting
chapter on module interface design.
In the middle, there's precisely the sort of thing you'd expect for a
book of this nature: font handling, business graphs, 3D rendering,
(although a little more detail on this topic would have been nice) and
so on.
The section on designing graphics for the Web is, if you'll allow a
slight exaggeration, flawless.
</p>

<p>
I find the "bullet-point annotated code" style of explanation
gets the important points across well, and Martien has achieved a nice
balance of explanatory prose and demonstration code. The material
occasionally seems to be let down by the odd bug or two in Image::Magick, but
we can hardly blame the author for that. 
</p>

<p>
What really disappointed me about this book was the glaring and complete
omission of the <code>Imager</code> module; this is another module for
doing programmatic graphics creation, and I personally favor it
above <code>Image::Magick</code> and <code>GD</code>, which both require
an intermediary external C library on top of the various libraries for
handling graphics formats.
</p>


<p>
Similarly, much more could have been made of the interaction between
Perl and the Gimp - there were a few pages on creating animated GIFs,
but nothing about using Gimp plug-ins and the like.
</p>

<p>
Hence, in conclusion, I think if you take this book as being a complete
reference to everything you can do with graphics and Perl, you're going
to be disappointed. However, if you have certain tasks in mind and need
to know how to do them, or you're particularly interested in what you
can do with the <code>Image::Magick</code> module, then this book is for you.
</p>


<p>
<a href="http://www.manning.com/verbruggen/index.html">Graphics
Programming With Perl</a> is available from <a
href="http://www.manning.com">Manning</a> and all good computer bookshops.
</p>





        </div>



    </div>
    <div class="asset-footer"></div>
</div>


                            
                            <div id="entry-1324" class="entry-asset asset hentry">
    <div class="asset-header">
        <h2 class="asset-name entry-title"><a href="/pub/2002/07/16/mod_perl.html" rel="bookmark">Improving mod_perl Sites' Performance: Part 3</a></h2>
        <div class="asset-meta">
            <span class="byline">
    
                By <span class="vcard author">Stas Bekman</span> on <abbr class="published" title="2002-07-16T00:00:00-08:00">July 16, 2002 12:00 AM</abbr>
    
            </span>

            
            

        </div>
    </div>
    <div class="asset-content entry-content">

        <div class="asset-body">
            
<!-- sidebar begins -->
<!-- don't move sidebars -->
<!-- sidebar ends -->



<p>In this article we will continue the topic started in the previous
article. This time we talk about tools that help us with code
profiling and memory usage measuring.</p>
<p>
</p>
<h3><a name="code_profiling_techniques">Code Profiling Techniques</a></h3>
<p>The profiling process helps you to determine which subroutines or just
snippets of code take the longest time to execute and which subroutines
are called most often. You will probably just want to optimize those.</p>
<p>When do you need to profile your code? You do that when you suspect that
some part of your code is being called very often and so there may be a
need to optimize it to significantly improve the overall performance.</p>

<csquery path="q/21" where="cs_rid != {cs_rid}">

<p>For example, you might have used the <code>diagnostics</code> pragma, which
extends the terse diagnostics normally emitted by both the Perl compiler
and the Perl interpreter, augmenting them with the more verbose and
endearing descriptions found in the <code>perldiag</code> manpage. If you've ever
done so, then you know that it might slow your code down tremendously, so
let's first see whether or not it actually does.</p>
<p>We will run a benchmark, once with diagnostics enabled and once
disabled, on a subroutine called <em>test_code</em>.</p>
<p>The code inside the subroutine does an arithmetic and a numeric
comparison of two strings.  It assigns one string to another if the
condition tests true but the condition always tests false.  To
demonstrate the <code>diagnostics</code> overhead the comparison operator is
intentionally <em>wrong</em>.  It should be a string comparison, not a
numeric one.</p>
<pre><code>
  use Benchmark;
  use diagnostics;
  use strict;
  
  my $count = 50000;
  
  disable diagnostics;
  my $t1 = timeit($count,\&amp;test_code);
  
  enable  diagnostics;
  my $t2 = timeit($count,\&amp;test_code);
  
  print &quot;Off: &quot;,timestr($t1),&quot;\n&quot;;
  print &quot;On : &quot;,timestr($t2),&quot;\n&quot;;
  
  sub test_code{
    my ($a,$b) = qw(foo bar);
    my $c;
    if ($a == $b) {
      $c = $a;
    }
  }</code></pre>
<p>For only a few lines of code we get:</p>
<pre><code>
  Off:  1 wallclock secs ( 0.81 usr +  0.00 sys =  0.81 CPU)
  On : 13 wallclock secs (12.54 usr +  0.01 sys = 12.55 CPU)</code></pre>
<p>With <code>diagnostics</code> enabled, the subroutine <code>test_code()</code> is 16 times
slower than with <code>diagnostics</code> disabled!</p>
<p>Now let's fix the comparison the way it should be, by replacing <code>==</code>
with <code>eq</code>, so we get:</p>
<pre><code>
    my ($a,$b) = qw(foo bar);
    my $c;
    if ($a eq $b) {
      $c = $a;
    }</code></pre>
<p>and run the same benchmark again:</p>
<pre><code>
  Off:  1 wallclock secs ( 0.57 usr +  0.00 sys =  0.57 CPU)
  On :  1 wallclock secs ( 0.56 usr +  0.00 sys =  0.56 CPU)</code></pre>
<p>Now there is no overhead at all.  The <code>diagnostics</code> pragma slows
things down only when warnings are generated.</p>

<csperl file="grab" domain="on" record="b/832" template="b/article_sidebar2.view">

<p>After we have verified that using the <code>diagnostics</code> pragma might adds
a big overhead to execution runtime, let's use the code profiling to
understand why this happens. We are going to use <code>Devel::DProf</code> to
profile the code.  Let's use this code:</p>
<pre><code>
  diagnostics.pl
  --------------
  use diagnostics;
  print &quot;Content-type: text/html\n\n&quot;;
  test_code();
  sub test_code{
    my ($a,$b) = qw(foo bar);
    my $c;
    if ($a == $b) {
      $c = $a;
    }
  }</code></pre>
<p>Run it with the profiler enabled, and then create the profiling
stastics with the help of dprofpp:</p>
<pre><code>
  % perl -d:DProf diagnostics.pl
  % dprofpp
  
  Total Elapsed Time = 0.342236 Seconds
    User+System Time = 0.335420 Seconds
  Exclusive Times
  %Time ExclSec CumulS #Calls sec/call Csec/c  Name
   92.1   0.309  0.358      1   0.3089 0.3578  main::BEGIN
   14.9   0.050  0.039   3161   0.0000 0.0000  diagnostics::unescape
   2.98   0.010  0.010      2   0.0050 0.0050  diagnostics::BEGIN
   0.00   0.000 -0.000      2   0.0000      -  Exporter::import
   0.00   0.000 -0.000      2   0.0000      -  Exporter::export
   0.00   0.000 -0.000      1   0.0000      -  Config::BEGIN
   0.00   0.000 -0.000      1   0.0000      -  Config::TIEHASH
   0.00   0.000 -0.000      2   0.0000      -  Config::FETCH
   0.00   0.000 -0.000      1   0.0000      -  diagnostics::import
   0.00   0.000 -0.000      1   0.0000      -  main::test_code
   0.00   0.000 -0.000      2   0.0000      -  diagnostics::warn_trap
   0.00   0.000 -0.000      2   0.0000      -  diagnostics::splainthis
   0.00   0.000 -0.000      2   0.0000      -  diagnostics::transmo
   0.00   0.000 -0.000      2   0.0000      -  diagnostics::shorten
   0.00   0.000 -0.000      2   0.0000      -  diagnostics::autodescribe</code></pre>
<p>It's not easy to see what is responsible for this enormous overhead,
even if <code>main::BEGIN</code> seems to be running most of the time.  To get
the full picture we must see the OPs tree, which shows us who calls
whom, so we run:</p>
<pre><code>
  % dprofpp -T</code></pre>
<p>and the output is:</p>
<pre><code>
 main::BEGIN
   diagnostics::BEGIN
      Exporter::import
         Exporter::export
   diagnostics::BEGIN
      Config::BEGIN
      Config::TIEHASH
      Exporter::import
         Exporter::export
   Config::FETCH
   Config::FETCH
   diagnostics::unescape
   .....................
   3159 times [diagnostics::unescape] snipped
   .....................
   diagnostics::unescape
   diagnostics::import
 diagnostics::warn_trap
   diagnostics::splainthis
      diagnostics::transmo
      diagnostics::shorten
      diagnostics::autodescribe
 main::test_code
   diagnostics::warn_trap
      diagnostics::splainthis
         diagnostics::transmo
         diagnostics::shorten
         diagnostics::autodescribe
   diagnostics::warn_trap
      diagnostics::splainthis
         diagnostics::transmo
         diagnostics::shorten
        diagnostics::autodescribe</code></pre>
<p>So we see that two executions of <code>diagnostics::BEGIN</code> and 3161 of
<code>diagnostics::unescape</code> are responsible for most of the running
overhead.</p>
<p>If we comment out the <code>diagnostics</code> module, we get:</p>
<pre><code>
  Total Elapsed Time = 0.079974 Seconds
    User+System Time = 0.059974 Seconds
  Exclusive Times
  %Time ExclSec CumulS #Calls sec/call Csec/c  Name
   0.00   0.000 -0.000      1   0.0000      -  main::test_code</code></pre>
<p>It is possible to profile code running under mod_perl with the
<code>Devel::DProf</code> module, available on CPAN.  However, you must have
apache version 1.3b3 or higher and the <code>PerlChildExitHandler</code> enabled
during the httpd build process.  When the server is started,
<code>Devel::DProf</code> installs an <code>END</code> block to write the <em>tmon.out</em>
file.  This block will be called at server shutdown. Here is how to
start and stop a server with the profiler enabled:</p>
<pre><code>
  % setenv PERL5OPT -d:DProf
  % httpd -X -d `pwd` &amp;
  ... make some requests to the server here ...
  % kill `cat logs/httpd.pid`
  % unsetenv PERL5OPT
  % dprofpp</code></pre>
<p>The <code>Devel::DProf</code> package is a Perl code profiler.  It will collect
information on the execution time of a Perl script and of the subs in
that script (remember that <code>print()</code> and <code>map()</code> are just like any
other subroutines you write, but they come bundled with Perl!)</p>
<p>Another approach is to use <code>Apache::DProf</code>, which hooks
<code>Devel::DProf</code> into mod_perl.  The <code>Apache::DProf</code> module will run a
<code>Devel::DProf</code> profiler inside each child server and write the
<em>tmon.out</em> file in the directory <code>$ServerRoot/logs/dprof/$$</code> when
the child is shutdown (where <code>$$</code> is the number of the child
process).  All it takes is to add to <em>httpd.conf</em>:</p>
<pre><code>
  PerlModule Apache::DProf</code></pre>
<p>Remember that any PerlHandler that was pulled in before
<code>Apache::DProf</code> in the <em>httpd.conf</em> or <em>startup.pl</em>, will not have
its code debugging information inserted.  To run <code>dprofpp</code>, chdir to
<code>$ServerRoot/logs/dprof/$$</code> and run:</p>
<pre><code>
  % dprofpp</code></pre>
<p>(Lookup the <code>ServerRoot</code> directive's value in <em>httpd.conf</em> to figure
out what your <code>$ServerRoot</code> is.)</p>
<p>
</p>














<h3><a name="measuring_the_memory_of_the_process">Measuring the Memory of the Process</a></h3>
<p>One very important aspect of performance tuning is to make sure that your
applications don't use much memory, since if they do you cannot run
many servers and therefore in most cases under a heavy load the
overall performance degrades.</p>
<p>In addition the code may not be clean and leak memory, which is even
worse. In this case, the same process serves many requests and after
each request more memory is used. After a while all your RAM will be
used and machine will start swapping (use the swap partition) which is a
very undesirable event, since it may lead to a machine crash.</p>
<p>The simplest way to figure out how big the processes are and see
whether they grow is to watch the output of <code>top(1)</code> or <code>ps(1)</code> utilities.</p>
<p>For example the output of top(1):</p>
<pre><code>
    8:51am  up 66 days,  1:44,  1 user,  load average: 1.09, 2.27, 2.61
  95 processes: 92 sleeping, 3 running, 0 zombie, 0 stopped
  CPU states: 54.0% user,  9.4% system,  1.7% nice, 34.7% idle
  Mem:  387664K av, 309692K used,  77972K free, 111092K shrd,  70944K buff
  Swap: 128484K av,  11176K used, 117308K free                170824K cached</code></pre>
<pre><code>
     PID USER PRI NI SIZE  RSS SHARE STAT LIB %CPU %MEM   TIME COMMAND
  29225 nobody 0  0  9760 9760  7132 S      0 12.5  2.5   0:00 httpd_perl
  29220 nobody 0  0  9540 9540  7136 S      0  9.0  2.4   0:00 httpd_perl
  29215 nobody 1  0  9672 9672  6884 S      0  4.6  2.4   0:01 httpd_perl
  29255 root   7  0  1036 1036   824 R      0  3.2  0.2   0:01 top
    376 squid  0  0 15920  14M   556 S      0  1.1  3.8 209:12 squid
  29227 mysql  5  5  1892 1892   956 S N    0  1.1  0.4   0:00 mysqld
  29223 mysql  5  5  1892 1892   956 S N    0  0.9  0.4   0:00 mysqld
  29234 mysql  5  5  1892 1892   956 S N    0  0.9  0.4   0:00 mysqld</code></pre>
<p>Which starts with overall information of the system and then displays
the most active processes at the given moment. So for example if we
look at the <code>httpd_perl</code> processes we can see the size of the
resident (<code>RSS</code>) and shared (<code>SHARE</code>) memory segments. This sample
was taken on the production server running linux.</p>
<p>But of course we want to see all the apache/mod_perl processes, and
that's where <code>ps(1)</code> comes to help. The options of this utility vary
from one Unix flavor to another, and some flavors provide their own
tools. Let's check the information about mod_perl processes:</p>
<pre><code>
  % ps -o pid,user,rss,vsize,%cpu,%mem,ucomm -C httpd_perl
    PID USER      RSS   VSZ %CPU %MEM COMMAND
  29213 root     8584 10264  0.0  2.2 httpd_perl
  29215 nobody   9740 11316  1.0  2.5 httpd_perl
  29216 nobody   9668 11252  0.7  2.4 httpd_perl
  29217 nobody   9824 11408  0.6  2.5 httpd_perl
  29218 nobody   9712 11292  0.6  2.5 httpd_perl
  29219 nobody   8860 10528  0.0  2.2 httpd_perl
  29220 nobody   9616 11200  0.5  2.4 httpd_perl
  29221 nobody   8860 10528  0.0  2.2 httpd_perl
  29222 nobody   8860 10528  0.0  2.2 httpd_perl
  29224 nobody   8860 10528  0.0  2.2 httpd_perl
  29225 nobody   9760 11340  0.7  2.5 httpd_perl
  29235 nobody   9524 11104  0.4  2.4 httpd_perl</code></pre>
<p>Now you can see the resident (<code>RSS</code>) and virtual (<code>VSZ</code>) memory
segments (and shared memory segment if you ask for it) of all mod_perl
processes. Please refer to the <code>top(1)</code> and <code>ps(1)</code> man pages for more
information.</p>
<p>You probably agree that using <code>top(1)</code> and <code>ps(1)</code> are cumbersome if we
want to use memory size sampling during the benchmark test. We want to
have a way to print memory sizes during the program execution at
desired places. If you have <code>GTop</code> modules installed, which is a perl
glue to the <code>libgtop</code> library, it's exactly what we need.</p>
<p>Note: <code>GTop</code> requires the <code>libgtop</code> library but is not available for
all platforms.  Visit <a href="http://www.home-of-linux.org/gnome/libgtop/">http://www.home-of-linux.org/gnome/libgtop/</a> to
check whether your platform/flavor is supported.</p>
<p><code>GTop</code> provides an API for retrieval of information about processes
and the whole system. We are only interested in memory sampling API
methods. To print all the process related memory information we can
execute the following code:</p>



<pre><code>
  use GTop;
  my $gtop = GTop-&gt;new;
  my $proc_mem = $gtop-&gt;proc_mem($$);
  for (qw(size vsize share rss)) {
      printf &quot;   %s =&gt; %d\n&quot;, $_, $proc_mem-&gt;$_();
  }</code></pre>
<p>When executed we see the following output (in bytes):</p>
<pre><code>
      size =&gt; 1900544
     vsize =&gt; 3108864
     share =&gt; 1392640
       rss =&gt; 1900544</code></pre>
<p>So if we are interested in to print the process resident memory
segment before and after some event we just do it: For example if we
want to see how much extra memory was allocated after a variable
creation we can write the following code:</p>
<pre><code>
  use GTop;
  my $gtop = GTop-&gt;new;
  my $before = $gtop-&gt;proc_mem($$)-&gt;rss;
  my $x = 'a' x 10000;
  my $after  = $gtop-&gt;proc_mem($$)-&gt;rss;
  print &quot;diff: &quot;,$after-$before, &quot; bytes\n&quot;;</code></pre>
<p>and the output</p>
<pre><code>
  diff: 20480 bytes</code></pre>
<p>So we can see that Perl has allocated extra 20480 bytes to create
<code>$x</code> (of course the creation of <code>after</code> needed a few bytes as well,
but it's insignificant compared to a size of <code>$x</code>)</p>
<p>The <code>Apache::VMonitor</code> module with help of the <code>GTop</code> module allows
you to watch all your system information using your favorite browser
from anywhere in the world without a need to telnet to your machine.
If you are looking into what information you can retrieve with <code>GTop</code>,
you should examine <code>Apache::VMonitor</code>, as it deploys a big part of
the API that <code>GTop</code> provides.</p>
<p>If you are running a true BSD system, you may use
<code>BSD::Resource::getrusage</code> instead of <code>GTop</code>. For example:</p>
<pre><code>
  print &quot;used memory = &quot;.(BSD::Resource::getrusage)[2].&quot;\n&quot;</code></pre>
<p>For more information refer to the <code>BSD::Resource</code> manpage.</p>
<p>
</p>
<h3><a name="measuring_the_memory_usage_of_subroutines">Measuring the Memory Usage of Subroutines</a></h3>
<p>With help of <code>Apache::Status</code> you can find out the size of each
and every subroutine.</p>
<ol>
<li>
Build and install mod_perl as you always do, make sure it's version
1.22 or higher.

</li>
<li>
Configure /perl-status if you haven't already:
<pre><code>
  &lt;Location /perl-status&gt;
    SetHandler perl-script
    PerlHandler Apache::Status
    order deny,allow
    #deny from all
    #allow from ...
  &lt;/Location&gt;</code></pre>

</li>
<li>
Add to httpd.conf
<pre><code>
  PerlSetVar StatusOptionsAll On
  PerlSetVar StatusTerse On
  PerlSetVar StatusTerseSize On
  PerlSetVar StatusTerseSizeMainSummary On</code></pre>
<pre><code>
  PerlModule B::TerseSize</code></pre>

</li>
<li>
Start the server (best in httpd -X mode)

</li>
<li>
From your favorite browser fetch <a href="http://localhost/perl-status">http://localhost/perl-status</a>

</li>
<li>
Click on 'Loaded Modules' or 'Compiled Registry Scripts'

</li>
<li>
Click on the module or script of your choice (you might need
to run some script/handler before you will see it here unless it was
preloaded)

</li>
<li>
Click on 'Memory Usage' at the bottom

</li>
<li>
You should see all the subroutines and their respective sizes.
</ol>
<p>Now you can start to optimize your code, or test which of several
implementations is of the least size.</p>
<p>For example let's compare <code>CGI.pm</code>'s OO vs. procedural interfaces:</p>
<p>As you will see below the first OO script uses about 2k bytes while
the second script (procedural interface) uses about 5k.</p>
<p>Here are the code examples and the numbers:</p>
<ol>

<li>
<pre><code>
  cgi_oo.pl
  ---------
  use CGI ();
  my $q = CGI-&gt;new;
  print $q-&gt;header;
  print $q-&gt;b(&quot;Hello&quot;);</code></pre>
</li>
<li>
<pre><code>
  cgi_mtd.pl
  ---------
  use CGI qw(header b);
  print header();
  print b(&quot;Hello&quot;);</code></pre></li>
</ol>
<p>After executing each script in single server mode (-X) the results are:</p>
<ol>
<li>
<pre><code>
  Totals: 1966 bytes | 27 OPs
  
  handler 1514 bytes | 27 OPs
  exit     116 bytes |  0 OPs</code></pre></li>
<li>
<pre><code>
  Totals: 4710 bytes | 19 OPs
  
  handler  1117 bytes | 19 OPs
  basefont  120 bytes |  0 OPs
  frameset  120 bytes |  0 OPs
  caption   119 bytes |  0 OPs
  applet    118 bytes |  0 OPs
  script    118 bytes |  0 OPs
  ilayer    118 bytes |  0 OPs
  header    118 bytes |  0 OPs
  strike    118 bytes |  0 OPs
  layer     117 bytes |  0 OPs
  table     117 bytes |  0 OPs
  frame     117 bytes |  0 OPs
  style     117 bytes |  0 OPs
  Param     117 bytes |  0 OPs
  small     117 bytes |  0 OPs
  embed     117 bytes |  0 OPs
  font      116 bytes |  0 OPs
  span      116 bytes |  0 OPs
  exit      116 bytes |  0 OPs
  big       115 bytes |  0 OPs
  div       115 bytes |  0 OPs
  sup       115 bytes |  0 OPs
  Sub       115 bytes |  0 OPs
  TR        114 bytes |  0 OPs
  td        114 bytes |  0 OPs
  Tr        114 bytes |  0 OPs
  th        114 bytes |  0 OPs
  b         113 bytes |  0 OPs</code></pre></li>
</ol>
<p>Note, that the above is correct if you didn't precompile all
<code>CGI.pm</code>'s methods at server startup. Since if you did, the
procedural interface in the second test will take up to 18k and not 5k
as we saw. That's because the whole of <code>CGI.pm</code>'s namespace is
inherited and it already has all its methods compiled, so it doesn't
really matter whether you attempt to import only the symbols that you
need.  So if you have:</p>
<pre><code>
  use CGI  qw(-compile :all);</code></pre>
<p>in the server startup script. Having:</p>
<pre><code>
  use CGI qw(header);</code></pre>
<p>or</p>
<pre><code>
  use CGI qw(:all);</code></pre>
<p>is essentially the same. You will have all the symbols precompiled at
startup imported even if you ask for only one symbol.  It
seems to me like a bug, but probably that's how <code>CGI.pm</code> works.</p>
<p>BTW, you can check the number of opcodes in the code by a simple
command line run. For example comparing 'my&nbsp;%hash' vs. 'my&nbsp;%hash&nbsp;=
()'.</p>
<pre><code>
  % perl -MO=Terse -e 'my %hash' | wc -l
  -e syntax OK
      4</code></pre>
<pre><code>
  % perl -MO=Terse -e 'my %hash = ()' | wc -l
  -e syntax OK
     10</code></pre>
<p>The first one has fewer opcodes.</p>
<p>Note that you shouldn't use <code>Apache::Status</code> module on production
server as it adds quite a bit of overhead to each request.</p>
<p>
</p>
<hr />
<h1><a name="references">References</a></h1>
<ul>
<li>
The mod_perl site's URL: <a href="http://perl.apache.org">http://perl.apache.org</a></li>

<li>
<code>Devel::DProf</code>
<p><a href="http://search.cpan.org/search?dist=DProf">http://search.cpan.org/search?dist=DProf</a></p></li>

<li>
<code>Apache::DProf</code>
<p><a href="http://search.cpan.org/search?dist=Apache-DB">http://search.cpan.org/search?dist=Apache-DB</a></p></li>

<li>
<code>Apache::VMonitor</code>
<p><a href="http://search.cpan.org/search?dist=Apache-VMonitor">http://search.cpan.org/search?dist=Apache-VMonitor</a></p></li>

<li>
<code>GTop</code>
<p><a href="http://search.cpan.org/search?dist=GTop">http://search.cpan.org/search?dist=GTop</a></p>
<p>The home of the C library: <a href="http://www.home-of-linux.org/gnome/libgtop/">http://www.home-of-linux.org/gnome/libgtop/</a></p></li>

<li>
<code>BSD::Resource</code>
<p><a href="http://search.cpan.org/search?dist=BSD-Resource">http://search.cpan.org/search?dist=BSD-Resource</a></p></li>
</ul>

        </div>



    </div>
    <div class="asset-footer"></div>
</div>


                            
                            <div id="entry-1332" class="entry-asset asset hentry">
    <div class="asset-header">
        <h2 class="asset-name entry-title"><a href="/pub/2002/07/p6pdigest/20020714.html" rel="bookmark">This Week on Perl 6 (8 - 14 Jul 2002)</a></h2>
        <div class="asset-meta">
            <span class="byline">
    
                By <span class="vcard author">Piers Cawley</span> on <abbr class="published" title="2002-07-14T00:00:00-08:00">July 14, 2002 12:00 AM</abbr>
    
            </span>

            
            

        </div>
    </div>
    <div class="asset-content entry-content">

        <div class="asset-body">
            

<ul>
		<li><a href="#still_waiting_for_exegesis_5">Still waiting for Exegesis 5?</a></li>
		<li><a href="#is_parrot_a_second_system">Is Parrot a second system?</a></li>
		<li><a href="#don't_mix_labels_and_comments">Don't mix labels and comments</a></li>
		<li><a href="#perl_6_grammar,_take_5">Perl 6 grammar, take 5</a></li>
		<li><a href="#so,_what_is_imcc_then">So, what is IMCC then?</a></li>
		<li><a href="20020714.html?page=2#vtables_and_multimethod_dispatch">Vtables and multimethod dispatch</a></li>
		<li><a href="20020714.html?page=2#building_support_for_nonnative_bytecode">Building support for non-native bytecode</a></li>
		<li><a href="20020714.html?page=2#mutable_vs_immutable_strings">Mutable vs. immutable strings</a></li>
		<li><a href="20020714.html?page=2#adding_the_system_stack_to_the_rootset.">Adding the system stack to the rootset.</a></li>
		<li><a href="20020714.html?page=2#making_keyed_aggregates_really_work.">Making keyed aggregates really work.</a></li>
		<li><a href="20020714.html?page=2#parrot:_copying_arrays">Parrot: copying arrays</a></li>
		<li><a href="20020714.html?page=2#coders:_add_doco">coders: add doco</a></li>
		<li><a href="20020714.html?page=3#the_first_parrot_questions">The first PARROT QUESTIONs</a></li>
		<li><a href="20020714.html?page=3#more_docs">More docs</a></li>
		<li><a href="20020714.html?page=3#type_morphing">Type Morphing</a></li>
		<li><a href="20020714.html?page=3#glossary_requests">Glossary requests</a></li>
		<li><a href="20020714.html?page=3#meanwhile,_in_perl6language">Meanwhile, in perl6-language</a></li>
		<li><a href="20020714.html?page=3#what's_my.line">What's MY.line</a></li>
		<li><a href="20020714.html?page=3#20020714.html?page=3#in_brief">In brief</a></li>
		<li><a href="20020714.html?page=3#the_return_of_who's_who_in_perl_6">The return of "Who's Who in Perl 6"</a></li>
		<li><a href="20020714.html?page=3#acknowledgements">Acknowledgements</a></li>
	</ul>

<h1><a name="perl6_summary_for_week_ending_20020714">Perl 6 summary for week ending 20020714</a></h1>
<p>Well, what a week it's been, eh, sportsfans? Without further ado,
here's a rundown of all the excitement in the Perl 6 development
camps.</p>
<p>
</p>
<h2><a name="still_waiting_for_exegesis_5">Still waiting for Exegesis 5?</a></h2>
<p>The week before last saw a couple of fantastic postings on Perlmonks
dealing with the fun stuff in Apocalypse 5. I'm sorry I missed them
last week. Damian is still beavering away on the Exegesis, but these
(shall I call them Apocrypha?) are worth reading.</p>
<p><a href="http://www.perlmonks.org/index.pl?node_id=179555">http://www.perlmonks.org/index.pl</a></p>
<p><a href="http://www.perlmonks.org/index.pl?node_id=179755">http://www.perlmonks.org/index.pl</a></p>
<p>
</p>
<h2><a name="is_parrot_a_second_system">Is Parrot a second system?</a></h2>
<p>John Porter worried about the second-system effect, and about whether
the movement to implement a bunch of 'foreign' VM ops on Parrot was
just going to add bloat and inefficiency. Dan assured him that ``these
'add-on' bytecode interpreters don't get any special consideration in
the core.'' John was reassured.</p>
<p>I think it was decided that Parrot <em>is</em> a second system, but that
we're working it to avoid the classic problems associated with it.</p>
<p><a href="http://archive.develooper.com/perl6-internals@perl.org/msg10802.html">http://archive.develooper.com/perl6-internals@perl.org/msg10802.html</a></p>
<p>
</p>
<h2><a name="don't_mix_labels_and_comments">Don't mix labels and comments</a></h2>
<p>Simon Glover had a problem with</p>
<pre>
    A:              # prints &quot;a&quot;
        print &quot;a&quot;
        end</pre>
<p>which kills the assembler because of the presence of the comment. Tom
Hughes posted a patch to fix it, and Brian Wheeler pointed out that
the patch means you can't do <code>print &quot;#&quot;</code>, which would be bad. Tom
reckons he fixed that with his second patch.</p>
<p><a href="http://archive.develooper.com/perl6-internals@perl.org/msg10915.html">http://archive.develooper.com/perl6-internals@perl.org/msg10915.html</a>
Tom's initial fix.</p>
<p><a href="http://archive.develooper.com/perl6-internals@perl.org/msg10918.html">http://archive.develooper.com/perl6-internals@perl.org/msg10918.html</a>
And the second.</p>
<p>
</p>
<h2><a name="perl_6_grammar,_take_5">Perl 6 grammar, take 5</a></h2>
<p>Sean O'Rourke is my hero. He's still beavering away on writing a Perl
6 grammar. The latest incarnation is apparently, ``Turing-complete, if
you have a Parrot engine and a bit of spare time.'' The grammar is
still incomplete (of course), and someone pointed out that it had a
problem with code like <code>{ some_function_returning_a_hash() }</code>. Should
it give a closure? Or a hash ref. Larry hasn't commented so far.</p>
<p>Sean comments: ``The fact that I've been able to whip this up in a
couple thousand lines of code is a remarkable testament to Parrot's
maturity, and to the wealth of tools available in Perl 5.  In
particular, without The Damian's Parse::RecDescent, Melvin Smith's
IMCC, and Sarathy's Data::Dumper, it never would have been possible.''</p>
<p>Quote of the thread: ``What, this actually <em>runs</em>? Oh, my.'' -- Dan
Sugalski</p>
<p><a href="http://archive.develooper.com/perl6-internals@perl.org/msg10866.html">http://archive.develooper.com/perl6-internals@perl.org/msg10866.html</a></p>


<h2><a name="so,_what_is_imcc_then">So, What Is IMCC Then?</a></h2>
<p>I asked, they answered. Apparently, reading TFM would have been a good
place to start, though Melvin Smith didn't put it <em>quite</em> so bluntly
when he told me. Essentially, the IMCC is the Parrot intermediate
language compiler. It's a bit like an assembler but sits at a slightly
higher level and worries about the painful things like ``register
allocation, low level optimisation, and machine code generation.'' And
everyone gets to share that wealth -- Perl6, Ruby, Python, whatever --
they all need the same facilities that IMCC provides.</p>
<p>The idea is that, instead of worrying about registers, you just
provide a string of temporaries or named locals, so you can write:</p>
<pre>
    $I1 = 1
    $I2 = 2
    $I3 = $I1 + $I2
    $I5 = $I3 + 5</pre>
<p>And IMCC will notice that it only needs to use two registers when it
turns that into:</p>
<pre>
    set I0, 1
    set I1, 2
    add I0, I0, I1
    add I0, I0, 5</pre>
<p>Melvin finishes by saying: `` If people don't get anything else, they
should get this. Implementing a compiler will be twice as easy if they
target the IR instead of raw Parrot.  At a minimum, they implement
their parser, generate an AST, and walk the tree, emitting
intermediate expressions and directives.''</p>
<p>Leon Brocard, who I am constitutionally required to namecheck in
every Perl 6 summary, tells me: ``IMCC is the coolest thing. ... Please
don't quote me verbatim.'' Tee hee.</p>
<p>The fine manual is at languages/imcc/README in the Parrot source
tree.</p>













<h2><a name="vtables_and_multimethod_dispatch">Vtables and Multimethod Dispatch</a></h2>
<p>This continued from last week. For some reason this ended up with a
discussion of Pythagoras' Theorem and Manhattan Distance (this was to
do with the idea of dispatch based on distance in type space ... .)</p>
<p>John Porter worried about the cost of generating full MM dispatch
tables, quoting some scary numbers. Dan reckoned that the numbers
weren't that scary, and that the problem was limited quite neatly.</p>
<p>Quote of the thread: ``I'm not sure I want an algorithm that drives on
the sidewalks, runs red lights, and chases pedestrians ... .'' -- Dan
Sugalski (again)</p>
<p><a href="http://archive.develooper.com/perl6-internals@perl.org/msg10814.html">http://archive.develooper.com/perl6-internals@perl.org/msg10814.html</a>
is a good 'root' to start at.</p>
<p><a href="http://archive.develooper.com/perl6-internals@perl.org/msg10859.html">http://archive.develooper.com/perl6-internals@perl.org/msg10859.html</a>
Quote of the thread, in context.</p>
<p>Can I put out a plea for someone, once the dust has settled, to
summarise the state of multidispatch?</p>
<p>
</p>
<h2><a name="building_support_for_nonnative_bytecode">Building Support for Non-Native Bytecode</a></h2>
<p>Dan mapped out what would be needed to implement a non-native VM. I
think he just wants to play Zork using parrot, but I'd never actually
say that. He also said he'd have the specs for dynamic opcode and PMC
loading out within 24 hours, but I think events may have intervened.</p>
<p><a href="http://archive.develooper.com/perl6-internals@perl.org/msg10806.html">http://archive.develooper.com/perl6-internals@perl.org/msg10806.html</a></p>
<p>
</p>
<h2><a name="mutable_vs_immutable_strings">Mutable vs. Immutable Strings</a></h2>
<p>Clark C. Evans reckoned that we'd need both strings and buffers and
argued that all strings should start as mutable, but that it
should be possible to 'freeze' them. He also pointed out that there
should be no corresponding 'thaw' operation. He wondered too whether these
semantics might be useful for more than just strings. Florian
Haeglsperger wondered whether Copy on Write didn't solve the problem at a
stroke, to which the answer appears to be 'not really.' Dan thinks
that 'read-onlyness' should probably hang off PMCs rather than strings
and buffers. Dan also commented that we need to nail down some
semantics about when things can and can't be modified.</p>
<p>The discussion slowly morphed into a discussion of types in Perl and
other languages. Melvin Smith noted that ``we've built this register
based VM upon which Perl will probably be the most non-optimised
language. Things like exposing your lexical pads, eval, etc., blow
optimisation out of the water,'' but reckoned that Perl itself would
probably still see a massive speed-up.</p>
<p>Ashley Winters got scary. A paragraph that begins, ``Whenever the
compiler runs across an eval, take a continuation from within the
compiler,'' is always going to be worrying. Actually, he proposed it as
a topic for a CS master's thesis, and Dan pointed out that one Damian
Conway is looking for students.</p>
<p>Quote of the thread: A tie between Ashley's paragraph opener above and
``[Parrot] will have reflection, introspection, and Deep Meditative
Capabilities.'' -- Who else, Dan Sugalski</p>
<p><a href="http://archive.develooper.com/perl6-internals@perl.org/msg10807.html">http://archive.develooper.com/perl6-internals@perl.org/msg10807.html</a>
(re)start here.</p>
<p>
</p>
<h2><a name="adding_the_system_stack_to_the_rootset.">Adding the System Stack to the Rootset.</a></h2>
<p>One of the weird things about a system that can do continuations is
that stack frames need to come out of managed memory, you can't just
use the C stack. And if you *don't* manage stack frames using garbage
collection, then you end up with memory leaks because the stack frames
don't get released; which is where we stood.</p>
<p>Dan is in the process of making sure that system stack frames get
properly garbage collected. Mike Lambert also stepped up and did
some/most of the implementation.</p>
<p><a href="http://archive.develooper.com/perl6-internals@perl.org/msg10829.html">http://archive.develooper.com/perl6-internals@perl.org/msg10829.html</a></p>
<p><a href="http://archive.develooper.com/perl6-internals@perl.org/msg10881.html">http://archive.develooper.com/perl6-internals@perl.org/msg10881.html</a></p>
<p><a href="http://archive.develooper.com/perl6-internals@perl.org/msg10905.html">http://archive.develooper.com/perl6-internals@perl.org/msg10905.html</a>
Mike's patch.</p>
<p>
</p>
<h2><a name="making_keyed_aggregates_really_work.">Making Keyed Aggregates Really Work.</a></h2>
<p>Melvin Smith put out a call for someone to do an audit of the keyed
aggregate handling code and find out which methods are missing, which
ones aren't handled by the assembler and generally to fix them. Sean
(Her)O'Rourke has apparently done the deed.</p>


<h2><a name="parrot:_copying_arrays">Parrot: Copying Arrays</a></h2>
<p>Alberto Sim&amp;otilde;es wondered about copying and cloning arrays
and other aggregates. How deeply should one go when making a copy as
opposed to just taking a reference? This one is still awaiting an
answer.</p>
<p><a href="http://archive.develooper.com/perl6-internals@perl.org/msg10868.html">http://archive.develooper.com/perl6-internals@perl.org/msg10868.html</a></p>
<p>
</p>
<h2><a name="coders:_add_doco">Coders: Add Doco</a></h2>
<p>The internals list came close to a flame war over this one. John Porter
opened with the somewhat incendiary, ``I have to say that I am extremely
disappointed at the paucity of internal documentation,'' and went on to
make some good points, but in a tone that rather annoyed several
people.</p>
<p>Productive stuff that came out of this, and the subsequent 'Parrot
contribution' thread include:</p>
<ul>
<li>
FAQ writing should be a collaborative effort. The questions that an
experienced Parrot head has, or thinks are important, are probably not
the questions that a newbie would ask.<br />
So, if you have a question that you think belongs in the FAQ, then send a
message to the list with a subject line of 'PARROT QUESTION' and we'll
try and produce some sensible answers and add them to the FAQ.</li>
<li>
The Parrot IRC channel is a good place for some stuff but has no
'journal of record.' Something like London.pm's lovely 'scribot'
bot could prove useful. (I'm deliberately not putting pointers
to the IRC channel. If you need to know, then read the thread.)</li>
<li>
Why questions, and their answers are often really important.</li>

<li>
We really should be maintaining the .dev files associated with each
source file, as mentioned in PDD7.</li>

<li>
Dan tries to be on IRC regularly from 1300-1700EST Wednesday. ``While
it's no substitute for e-mail, and not as good a realtime
communication method as face to face communication, it's better than
no realtime communication at all.''</li>

</ul>
<p>In the end, I think we ended up generating more light than heat, but
it was touch and go for a while ... .</p>
<p><a href="http://archive.develooper.com/perl6-internals@perl.org/msg10870.html">http://archive.develooper.com/perl6-internals@perl.org/msg10870.html</a></p>
<p><a href="http://archive.develooper.com/perl6-internals@perl.org/msg10882.html">http://archive.develooper.com/perl6-internals@perl.org/msg10882.html</a></p>













<h2><a name="the_first_parrot_questions">The first PARROT QUESTIONs</a></h2>
<p>Sadly, the first PARROT QUESTION post didn't contain any actual
questions. Ashley Winters pointed out that 'test_main.c' is a rather
weird place to find parrot's main loop and wondered why parrot.c is
empty.</p>
<p>His follow-up contained the actual questions, most of which were answered in the following thread, which is still ongoing.</p>
<p>Tom Hughes told us he was trying to make sense of the current status of
keyed access at all levels, from assembler through the ops to the
vtables and is getting more confused the more he looks; which can't be
good. Melvin Smith agreed that things were confusing, but thought that
things might get a little less confusing when he'd committed Sean's
patches. Discussion is ongoing.</p>
<p><a href="http://archive.develooper.com/perl6-internals@perl.org/msg10926.html">http://archive.develooper.com/perl6-internals@perl.org/msg10926.html</a>
Ashley's background post.</p>
<p><a href="http://archive.develooper.com/perl6-internals@perl.org/msg10927.html">http://archive.develooper.com/perl6-internals@perl.org/msg10927.html</a>
Ashley's questions</p>
<p><a href="http://archive.develooper.com/perl6-internals@perl.org/msg10930.html">http://archive.develooper.com/perl6-internals@perl.org/msg10930.html</a>
Tom Hughes on keyed access</p>
<p>
</p>
<h2><a name="more_docs">More Docs</a></h2>
<p>Stephen Rawls submitted rx.dev, an overview of the regular expression
code. Brent Dax added some clarification.</p>
<p>Alberto Sim&amp;otilde;es unveiled a pile of documentation for the Array,
PerlArray and PerlHash PMCs, earning himself a few Hero Points from
me.</p>
<p>
</p>
<h2><a name="type_morphing">Type Morphing</a></h2>
<p>I'm not entirely sure I understood this thread. Sean O'Rourke
submitted some patches to fix Parrot's PMC type morphing. Mike
Lambert pointed at some ambiguities and then Sean showed some code
that seems rather counter intuitive to do with type morphing and
comparisons. He also provided a test file that shows some places
where Perl 5 and Parrot seem to disagree on semantics.</p>
<p><a href="http://archive.develooper.com/perl6-internals@perl.org/msg10940.html">http://archive.develooper.com/perl6-internals@perl.org/msg10940.html</a></p>
<p>
</p>
<h2><a name="glossary_requests">Glossary Requests</a></h2>
<p>Mike Litherland made some suggestions about what should go in the
glossary. Patches were welcomed, and Dan added some terms to the
glossary, which is visible at <a href="http://www.parrotcode.org/glossary/">http://www.parrotcode.org/glossary/</a></p>
<p>
</p>
<h2><a name="meanwhile,_in_perl6language">Meanwhile, in Perl6-language</a></h2>
<p>The game of 'find a good description of continuations' rumbled on for
a bit. I liked Mike Lambert's description involving a traveler in a
maze (that's why Dan wants a Z-machine interpreter running on
Parrot. Continuations are the 'maze of little twisty passages all
similar').</p>
<p>Anyway, Dan also posted a splendidly clear and lucid explanation of
continuations. (Oh, frabjous day! Calloo! Callay!) Peter Scott wondered
about serializing continuations, which is a tough problem because some
state really can't be serialized (filehandles for instance), which
lead Ted Zlatonov to suggest <code>FREEZE {...}</code> and <code>THAW {...}</code> blocks.</p>
<p><a href="http://archive.develooper.com/perl6-language@perl.org/msg10284.html">http://archive.develooper.com/perl6-language@perl.org/msg10284.html</a>
Mike's 'maze' analogy.</p>
<p><a href="http://archive.develooper.com/perl6-language@perl.org/msg10275.html">http://archive.develooper.com/perl6-language@perl.org/msg10275.html</a>
Dan's ``Continuations are just the stack, you know?'' version.</p>
<p>
</p>
<h2><a name="what's_my.line">What's MY.line</a></h2>
<p>Chip Salzenburg asked some hardish questions about <code>MY</code>, <code>%MY</code> and
the difference between them. Piers (continuations everywhere) Cawley,
proposed <code>$a_continuation.the_pad</code>, which should probably be
<code>$a_continuation.MY</code> on further reflection, which Dan seemed to think
wasn't utterly insane.</p>
<p>It was also proposed that things like</p>
<pre>
    [localhost:~] $ perl
    my $foo = 12;
    print $foo;
    my $foo = 'ho';
    print $foo;
    12ho[localhost:~] $</pre>
<p>which is legal (with -w a warning) in Perl 5 should be illegal in perl
6. This was left as Larry's call.</p>
<p>Quote of the thread: 'And side effects like ``I call you, you modify
me invisibly ... '' seems more like taking dangerous drugs than
programming.' -- Melvin Smith</p>
<p>On seeing the quote of the thread, Richard (madman) Clamp popped up to
point out that, with the aid of Devel::LexAlias, you could already do
that in Perl 5. Which is nice.</p>
<p><a href="http://archive.develooper.com/perl6-language@perl.org/msg10290.html">http://archive.develooper.com/perl6-language@perl.org/msg10290.html</a>
Thread starts here. Pretty much all worthwhile.</p>
<p><a href="http://archive.develooper.com/perl6-language@perl.org/msg10312.html">http://archive.develooper.com/perl6-language@perl.org/msg10312.html</a>
Quote in context</p>
<p><a href="http://archive.develooper.com/perl6-language@perl.org/msg10319.html">http://archive.develooper.com/perl6-language@perl.org/msg10319.html</a>
Richard Clamp's bombshell</p>
<p>
</p>
<h2><a name="in_brief">In Brief</a></h2>
<p><a href="http://archive.develooper.com/perl6-internals@perl.org/msg10803.html">http://archive.develooper.com/perl6-internals@perl.org/msg10803.html</a>
-- Mark M. Adkins announced a perl script that hunts down all the POD
files in the Parrot directory tree and uses that to generate an HTML
tree in a new subdirectory. It looks rather handy.</p>
<p><a href="http://arstechnica.com/paedia/c/caching/caching-1.html">http://arstechnica.com/paedia/c/caching/caching-1.html</a> -- Dan
pointed us at an explanation of CPU caches</p>
<p>Robert Spier pointed everyone at <a href="http://www.parrotcode.org">http://www.parrotcode.org</a>, specifically
the <a href="http://www.parrotcode.org/resources/">Development Resources</a>.</p>
<p>Sean O'Rourke proposed ripping a bunch of <code>set_*</code> ops out of core.ops
now that we've got 'proper' keyed access in the assembler. Dan
concurred.</p>
<p><a href="http://archive.develooper.com/perl6-internals@perl.org/msg10920.html">http://archive.develooper.com/perl6-internals@perl.org/msg10920.html</a>
Tanton Gibbs sent a patch that adds documentation and a .dev file for
byteorder.c</p>
<p>Nicholas Clark is trying to eliminate compiler warnings.</p>
<p><a href="http://archive.develooper.com/perl6-internals@perl.org/msg10925.html">http://archive.develooper.com/perl6-internals@perl.org/msg10925.html</a>
Steve Purkis has a patch to add <code>usleep(int)</code> and <code>sleep(int)</code> to
the Linux version of Parrot. Dan likes the idea, but the patch won't
go in until it can be made to work on Win32 as well.</p>
<p><a href="http://archive.develooper.com/perl6-language@perl.org/msg10270.html">http://archive.develooper.com/perl6-language@perl.org/msg10270.html</a>
Luke Palmer has a <a
href="http://fibonaci.babylonia.flatirons.org/perl6.vim">vim highlighting file</a> for Perl 6.</p>
<p>
</p>
<h2><a name="the_return_of_who's_who_in_perl_6">The return of ``Who's Who in Perl 6''</a></h2>
<p>This week, Allison Randal answered the new standard ``5Ws questionnaire''</p>
<dl>
<dt><strong><a name="item_who_are_you%3f">Who are you?</a></strong><br />
</dt>
<dd>
I'm on the IT staff at the University of Portland. In my spare time I
enjoy working on Perl 6. In my spare-spare time I like to swing in a
hammock and read and ponder the ineffability of 42.
</dd>

<dt><strong><a name="item_what_do_you_do_for%2fwith_perl_6%3f">What do you do for/with Perl 6?</a></strong><br />
</dt>
<dd>
I dream in Perl 6 ... ;)
</dd>
<dd>
<p>On the Perl 6 design team I'm the other linguist, or Damian's clone, or
the assistant cat-herder, or sometimes the Devil's Advocate. It depends
on the day, really.</p>
</dd>

<dt><strong><a name="item_where_are_you_coming_from%3f">Where are you coming from?</a></strong><br />
</dt>
<dd>
Perl 6 will be an incredible jump in power and flexibility. But it's
also a lot easier to use. I think that fact is often missed. People see a
flurry of changes, but they can't see the forest for the trees. It's not
just about making the hard things more possible, it's about making the
easy things easier. That's the message I want to carry.
</dd>
<dt><strong><a name="item_when_do_you_think_perl_6_will_be_released%3f">When do you think Perl 6 will be released?</a></strong><br />
</dt>
<dd>
February 17, 2004 at 13:42 GMT. ;) Okay, no. :) But the current
estimates of 12-18 months sound pretty reasonable, especially with the
progress we've seen in Parrot.
</dd>
<dt><strong><a name="item_why_are_you_doing_this%3f">Why are you doing this?</a></strong><br />
</dt>
<dd>
Life's too short to settle for weak coffee.
</dd>
<dd>
<p>No, really, for the most selfish reason imaginable: I want to use Perl
6. Anything I can do to make it a better language or to help it reach
production faster is well worth the effort.</p>
</dd>
<dd>
<p>And it's incredibly fun.</p>
</dd>
<dt><strong><a name="item_you_have_5_words%2e_describe_yourself%2e">You have five words. Describe yourself.</a></strong><br />
</dt>
<dd>
Extreme Geekiness in Unusual Packaging.
</dd>
<dt><strong><a name="item_do_you_have_anything_to_declare%3f">Do you have anything to declare?</a></strong><br />
</dt>
<dd>
Perl <code>rule</code>s!
</dd>
</dl>
<p>
</p>
<h2><a name="acknowledgements">Acknowledgements</a></h2>
<p>Thanks to the denizens of #perl and #parrot for their, ahem, 'mad
proofreading skeelz.' To Melvin Smith and Leon Brocard for their
explanations of IMCC.</p>
<p>This summary was brought to you with the assistance of GNER tea, and
the music of Waterson:Carthy and Gillian Welch.</p>
<p>Once again, if you liked it, then give money to
<a href="https://donate.perl-foundation.org/">YAS</a>, if you didn't like it, well, then you
can still give them money; maybe they'll use it to hire a better
writer. Or maybe you could write a competing summary.</p>





        </div>



    </div>
    <div class="asset-footer"></div>
</div>


                            
                            <div id="entry-1322" class="entry-asset asset hentry">
    <div class="asset-header">
        <h2 class="asset-name entry-title"><a href="/pub/2002/07/10/tmo.html" rel="bookmark">A Test::MockObject Illustrated Example</a></h2>
        <div class="asset-meta">
            <span class="byline">
    
                By <span class="vcard author"><a class="fn url" href="http://www.modernperlbooks.com/">chromatic</a></span> on <abbr class="published" title="2002-07-10T00:00:00-08:00">July 10, 2002 12:00 AM</abbr>
    
            </span>

            
            

        </div>
    </div>
    <div class="asset-content entry-content">

        <div class="asset-body">
            
<!-- sidebar begins -->
<!-- don't move sidebars -->
<!-- sidebar ends -->

<p>People like to find excuses to avoid writing tests for their code. One
of the most common goes something like, "It's not feasible to test this,
because it relies on external objects" - CGI code, code using the
<code>Apache</code> request object, TCP/IP servers, and so on.</p>
<p>The <code>Test::MockObject</code> module makes it much easier to isolate code that
uses such objects.  For example, if your code uses a CGI object, then you
<strong>could</strong> fiddle with query strings and faked <code>STDIN</code>, trying to
persuade <code>CGI.pm</code> to produce testable values.  It's easier to use
<code>Test::MockObject</code> to create an object that looks and behaves like
a CGI object -- but that is completely under your control.</p>
<p>This comes in handy in large software projects, where objects encapsulate
tremendous amounts of hidden behavior.  If your application follows good design
principles by hiding complexity behind well-defined interfaces, then you can replace
nearly any component with its interface equivalent.  (The internals, of course,
are free to change.  That's why this is possible.) Often, it's sufficient just
to accept certain arguments and to return specific values.</p>
<p>Using a mock object, you can test whether the code in question uses a particular
interface correctly.  It's possible to do this by hand, but <code>Test::MockObject</code>
has several utility methods to add fake methods and verify calls.  It
integrates with <code>Test::Builder</code>, so it works correctly with <code>Test::Simple</code>,
<code>Test::More</code>, and their cousins.</p>



<h2><a name="the_background_you_need_to_know">The Background You Need to Know</a></h2>
<p>I assume that you are already familiar with <code>Test::More</code>.  Perhaps you've read
<code>Test::Tutorial</code>, which comes with the <code>Test::Simple</code> distribution.  You may also
have read <a HREF="/pub/a/2001/12/04/testing.html">my earlier introduction</a> to the subject.
If not, then you may wish to do so.  (My roommate tried it out of order and hurt his
head.  If you fare any better, then the Perl QA group is interested in your natural
talent!)</p>
<p>My example comes from the unit tests for the <a href="http://everydevel.com/">Everything Engine</a>.  
I chose it for two reasons.  First, it's a
project near and dear to my heart. Second, it needs more users, testers and
developers.  More importantly, it's where I came up with the ideas that led to
<code>Test::MockObject</code>.</p>
<p>My colleague on the Engine, Darrick Brown, devised a clever technique he dubbed
Form Objects.  These are used to bind menu choices to nodes.  (Everything in
Everything is a node.  It's the base unit of data and behavior.)  Form objects
control the creation of HTML widgets, verify submitted data and ultimately
update nodes.  They all inherit strongly from <code>Everything::FormObject</code> and
operate on node objects, so they're an ideal candidate for mock objects.</p>
<p>
</p>
<h3><a name="mock_objects">Mock Objects</a></h3>
<p>This article focuses on white-box unit testing with mock objects.  "White box"
testing means that you're allowed and encouraged to look at the internals of
the thing being tested.  This is scarily possible, with Perl.  By contrast,
"black box" testing happens when you cannot know the internal details: you just
know allowed inputs and the expected outputs.  (If you don't know that, then you
can't do much testing.)</p>
<p>Unit testing, of course, is testing individual components of the program in
isolation, as far as possible.  This is different from integration testing,
which exercises the program as a whole, and acceptance testing, which explores
the desired end-user behavior of the program.  No type of testing is better or
worse than any other.  Done properly, they are complementary: Unit tests are
capable of exploring internal behaviors that are difficult to prove with
acceptance tests;  integration tests demonstrate the interoperability between
different components that unit tests usually cannot guarantee.</p>
<p>The points of a mock object is to isolate the units being tested from their
dependencies, and to give testers more complete control over the testing
environments.  This follows from standard programming principles: If you can
fake the interfaces your unit relies on, then you can control and monitor its
behavior.</p>
<p>Perl makes this particularly easy.</p>














<h1><a name="the_example">The Example</a></h1>
<p>I'm writing a test for <code>Everything::HTML::FormObject::AuthorMenu</code>.  This class
represents an HTML select box used to set the author of a node.  It has two
methods.  <code>genObject()</code> produces the HTML necessary for the select widget.  It
is called when the Engine builds a page to display to the user.  The other
method, <code>cgiVerify()</code>, is called when receiving data from a user submission.
It checks to see whether the requested author exists and has write access to the
node.</p>
<p>
</p>
<h2><a name="looking_inside">Looking Inside</a></h2>
<p>The module begins rather simply:</p>
<pre><code>
        use strict;
        use Everything;
        use Everything::HTML;
        use Everything::HTML::FormObject;

        use vars qw(@ISA);
        @ISA = (&quot;Everything::HTML::FormObject&quot;);</code></pre>
        
<p>Testing this is all very easy.  I'd like to make sure that the module continues
to load all of these modules, so I need some way to catch their use.  (Don't
laugh -- I've forgotten to load important modules before, causing really tricky
errors.  It's better to be precise.  Now you can laugh.)  Because <code>use</code> calls
<code>import()</code> behind the scenes, if I can install my own <code>import()</code> before AuthorMenu
is compiled, then I can test that these modules are actually used.  As a side
benefit, doing so prevents these other classes from loading, making it easier
to mock them.  The test starts:</p>
<pre><code>
        package Everything::HTML::FormObject::AuthorMenu;
        use vars qw( $DB );

        package main;

        use Test::More 'no_plan';</code></pre>

<p>Because I'm faking the other packages, anything the true modules would normally
import will not be imported.  The only thing that really matters at this point
is the <code>$DB</code> object, exported from the Everything package.  (I'm cheating a
little bit.  I know I'll use it later, and I know where it's defined and how
it's used.  At this point, I should probably say, ``The module will fail to
compile unless I fake it here,'' and leave it at that.)</p>
<p>Because I'm not ready to implement <code>$DB</code>, I just switch to the package to be
tested and declare it as a global variable.  When the package is compiled, it's
already there, so it'll compile successfully.  Then I return to the main
package so I don't accidentally clobber anything important and use the testing
module.</p>
<pre><code>
        my @imports;
        for ( 'Everything', 'Everything::HTML',
                'Everything::HTML::FormObject') {
                no strict 'refs';
                *{ $_ . '::import' } = sub {
                        push @imports, $_[0];
                };
                (my $modpath = $_) =~ s!::!/!g;
                $INC{ $modpath . '.pm' } = 1;
        }</code></pre>
        
<p>Here's where it starts to get tricky.  Because I want to ensure that these
three modules are loaded correctly, I have to make Perl think they're already
loaded.  <code>%INC</code> comes to the rescue.  When you <code>use()</code> or <code>require()</code> a
module successfully, Perl adds an entry to <code>%INC</code> with the module pathname,
relative to one of the directories in <code>@INC</code>.  That way, if you <code>use()</code> or
<code>require()</code> the module again, then Perl knows that it's already been loaded.</p>
<p>As mentioned before, my preferred way to check that a module is loaded is to
trap all calls to <code>import()</code>.  That's why I install fake import subroutines.
They simply save the name of the package by which they're identified.  The
tests are simple to write:</p>
<pre><code>
        use_ok( 'Everything::HTML::FormObject::AuthorMenu' );
        
        is( $imports[0], 'Everything', 'Module should use 
        	Everything' );
        is( $imports[1], 'Everything::HTML',
                'Module should use Everything::HTML' );
        is( $imports[2], 'Everything::HTML::FormObject',
                'Module should use 
                     Everything::HTML::FormObject' );
</code></pre>
                
<p>Because <code>use_ok()</code> fires at runtime, it's safe not to wrap this whole section
in a BEGIN block.  (If you're curious about this, see what <em>perlfunc</em> has to
say about <code>use()</code> and its equivalent.)</p>
<p>That works, but it's a little messy and uses some tricks that might scare (or
at least confuse) the average Perl hacker.  One of the goals of the Test::*
modules is to do away with the ``evil black magic'' you'd normally have to use.
So, now I show you a more excellent way.</p>
<p>
</p>
<h2><a name="making_that_last_bit_easier">Making That Last Bit Easier</a></h2>
<p>Having found myself writing that code way too often (at least twice), I added
it to <code>Test::MockObject</code>.  Using the module, the corresponding loop is now:</p>
<pre><code>
        my @imports;
        for ( 'Everything', 'Everything::HTML',
                'Everything::HTML::FormObject') {
                Test::MockObject-&gt;fake_module(
                        $_,
                        import =&gt; sub { push @imports,
                              $_[0] }
                );
        }
</code></pre>

<p>Behind the scenes, the module does exactly what the loop did.  The nice thing
is that you don't have to remember how to fake that a module is loaded or how
to test <code>import()</code>.  It's already done and it's nicely encapsulated in a
module.  (I inadvertently drove this point home to myself when writing this
section.  It turns out that version 0.04 of <code>Test::MockObject</code> populated <code>%ENV</code>
instead of <code>%INC</code>.  I make that typo often.  This time, it was in both the
module and the test.  Get at least version 0.08, as this article has led to
bug fixes and new conveniences. :)</p>
<p>This isn't the most important feature of <code>Test::MockObject</code>, though.  It's just a
convenient addition.  At some point, it should probably be spun off into
<code>Test::MockPackage</code> or <code>Test::MockModule</code>.  (Want to contribute?)</p>














<h2><a name="testing_an_actual_method">Testing an Actual Method</a></h2>
<p>Once the module is loaded and ready, I like to test my methods in the
order in which they appear.  This helps to keep the test suite and the module
somewhat synchronized.  The first method is <code>genObject()</code>.  It's fairly simple:</p>
<pre><code>
        my $this = shift @_;
        my ($query, $bindNode, $field, $name, $default) =
                getParamArray(
                &quot;query, bindNode, field, name, 
                     default&quot;, @_);
        
        $name ||= $field;
        
        my $html = $this-&gt;SUPER::genObject(
                $query, $bindNode, $field, $name) . 
                     &quot;\n&quot;;
        
        if(ref $bindNode)
        {
                my $author = $DB-&gt;getNode($$bindNode{$field});
                if($author &amp;&amp; $author-&gt;isOfType('user'))
                {
                        $default ||= $$author&#123;title&#125;;
                }
                elsif($author)
                {
                        $default ||= &quot;&quot;;
                }
        }

        $html .= $query-&gt;textfield(-name =&gt; $name, 
        	    -default =&gt; $default,
                -size =&gt; 15, -maxlength =&gt; 255,
                -override =&gt; 1) . &quot;\n&quot;;
                
        return $html;
</code></pre>

<p>I can see several spots that need tests.  First, I want to make sure that
<code>getParamArray()</code> is called with the proper arguments.  (This function makes
it possible to pass parameters by position or in <code>name =&gt; value</code> pair
style, similar to
<a href="http://search.cpan.org/search?dist=Sub-NamedParams">Sub::NamedParams</a>.)  Next,
I'll test that <code>SUPER::genObject()</code> is called correctly, with the proper
values.  (This call looks odder than it is, due to the way the Engine handles
node inheritance.  For a good time, read <code>Everything::Node::AUTOLOAD()</code>, or
take up bowling.)  After that, there's the conditional statement.  I'll have to
call the function at least three times to test the branches effectively.  The
function ends with a <code>textfield()</code> call I want to test, and has a return value
where I can check some other things.  It's not as complex as it looks.</p>
<p>One of the side benefits of testing is that you'll start to write smaller and
smaller functions.  This is especially evident if you write tests before you
write code to pass them.  Besides being easier to read and debug, this tends
to produce code that's more flexible and much more powerful.</p>
<p>Having identified several things to test, I next write test names.  These are
short descriptions of the intent of the tests.  When confronted with a piece of
existing code, I usually try to figure out what kinds of things can break, and
what the important behavior really is.  With experience, you can look at a
piece of well-written code and figure it out intuitively.  There's room to be
explicit when you're just starting, though.</p>
<pre><code>
        # genObject() should call getParamArray()
        # ... passing a string of desired parameters
        # ... and its arguments, minus the object
        # ... should call SUPER::genObject()
        # ... passing the important parameters
        # ... and should call textfield()
        # ... with the important parameters
        # ... returning its and its parents results
        # ... if node is bound, should call getNode()
        # ... on bound node field
        # ... checking for an author node
        # ... and setting the default to the author name
        # ... or nothing, if it is not an author node</code></pre>

<p>That's a pretty good rough draft.  Going through the list reveals the need to
make at least two more passes through the code.  Getting this in the right
order takes a little work, but once you know how to set up the mocking
conditions correctly, it's really fast and easy.  The best way I've found to
handle this is just to jump right in.</p>

<pre><code>
        can_ok( 'Everything::HTML::FormObject::AuthorMenu', 
        	'genObject' );</code></pre>

<p>First, I want to make sure this method exists.  Why?  It's part of the ``Do the
simplest thing that could possibly work'' principle.  Whenever I add a method, I
first check to see whether it exists.  It sounds too stupid to have any use, but
this is a thing that <strong>could</strong> possibly break.  First, I've been known to
misspell method names occasionally.  This'll catch that immediately.  Second,
it gives me a place to start and a test that passes with little work.
That's a nice psychological boost that moves me on to the next test.  I've kept
this habit when writing tests for existing code.</p>
<p>Next, I want to test the call to <code>getParamArray()</code>.  Since it's not a method, I
can't use a mock object.  I'll have to mock it sideways.  Though the function
comes from <code>Everything.pm</code>, it would normally be exported into this package.
I'll use a variant of the <code>import()</code>-mockery earlier:</p>

<pre><code>
        my ($gpa, @gpa);
        $mock-&gt;fake_module( $package,
            getParamArray =&gt; sub { push @gpa, \@_; return $gpa }
        );
</code></pre>

<p>I can count the elements of <code>@gpa</code> to see whether it was called, and pull the
arguments out of the array.  <code>$gpa</code> allows me to control the output.  The test
itself is easy to write:</p>

<pre><code>
        my $result = genObject();
        is( @gpa, 1, 'genObject() should call getParamArray' );
</code></pre>

<p>OK, it's a little easier to write than it should have been.  If you're paying
attention, then you should wonder why the <code>genObject()</code> call works, as I'm still in
the main package and the method is in the class.  I've just added a variable
with the tested package name, as well as an <code>AUTOLOAD()</code> function. I'm already
tired of typing the big long package name:</p>

<pre><code>
        # near the start
        use vars qw( $AUTOLOAD );
        my $package = 'Everything::HTML::FormObject::AuthorMenu';
        
        ...
        
        # way down at the end
        sub AUTOLOAD {
                my ($subname) = $AUTOLOAD =~ /([^:]+)$/;
                if (my $sub = UNIVERSAL::can( $package,
                     $subname )) {
                        $sub-&gt;( @_ );
                } else {
                        warn &quot;Cannot call &lt;$subname&gt; 
                             in ($package)\n&quot;;
                }
        }</code></pre>

<p>With all of that infrastructure in place, it's a little disappointing to
realize that the test dies.  Since I'm calling the method as a function,
there's no object on which to call <code>SUPER::genObject()</code>.  This is easily
solved.  Remember that $mock (a mock object) was created earlier?  Here's one
bit of Perl's magic that drives some OO purists crazy, but makes it oh-so-easy
to test.  <em>A method call is a function call with a special first argument.</em> If
<code>$this</code>, inside <code>genObject()</code>, can do everything that an
<code>Everything::HTML::FormObject::AuthorMenu</code> object can do, then it'll just work.
Hooray for polymorphism!</p>














<p>To make the <code>SUPER::genObject()</code> call pass, that call will also have to be
mocked.  The method resolves to <code>Everything::HTML::FormObject::genObject()</code>,
so I'll add a function of the appropriate name and package.  (This test code is
starting to look familiar.  Again, <code>Test::MockModule</code>, anyone?)</p>
<pre><code>
        my @go;
        $mock-&gt;fake_module( 'Everything::HTML::FormObject',
            genObject =&gt; sub { push @go, \@_; 
                 return 'some html' }
        );</code></pre>
<p>Now I modify the <code>genObject()</code> call, passing in my mock object:</p>
<pre><code>
        my $result = genObject( $mock );</code></pre>
<p>I get further before things fail.  Since there's nothing passed in for the
<code>$query</code> variable to hold, the <code>textfield()</code> call fails.  Now I can finally
use my mock object to good effect.  First, I'm going to change what
<code>getParamArray()</code> returns, using <code>$package</code> again to save on typing:</p>
<pre><code>
        my (%gpa, @gpa);
        $mock-&gt;fake_module( $package,
            getParamArray =&gt; sub { push @gpa, \@_; return 
            @gpa{qw( q bn f n d )}}
        );</code></pre>
<p>Since AuthorMenu expects to receive its arguments in order, I'll create a hash
where I can store them.  I might use more descriptive key names, but they seem
to make sense now.  Next, I'll make sure that 'q' returns something
controllable.  In this case, that means that it supports the <code>textfield()</code>
method and returns something sane:</p>
<pre><code>
        $mock-&gt;set_always( 'textfield', 'more html' );
        $gpa{q} = $mock;</code></pre>
<p>I could create a new mock object for this, but since there's no name collision
yet, it's not a big priority.  Whether you do this is a matter of
personal style.</p>
<p>For now, <code>genObject()</code> does not die, and all tests pass.  Whew.  Next up, I
test to see whether the first argument to <code>getParamArray()</code> is correct.</p>
<pre><code>
        is( $gpa[0][0], 'query, bindNode, field, name, default',
            '... requesting the appropriate arguments' );</code></pre>
<p>It is, so I'll make sure that it passes along the rest of the method arguments,
minus the object itself:</p>

<pre><code>
        like( join(' ', @{ $gpa[0] }), qr/1 2 3$/,
                '... with the method arguments' );
        unlike( join(' ', @{ $gpa[0] }), qr/$mock/,
                '... but not the object itself' );</code></pre>

<p>Only the first of these fails, and that's because I'm not passing any other
arguments to the method call.  I'll modify it:</p>
<pre><code>
        my $result = genObject( $mock, 1, 2, 3 );</code></pre>
        
<p>This gives me nine tests that pass.  I'm also following the test names fairly
closely.  (In between writing those and actually writing this code, a couple of
days passed.  Their similarities make me think I'm on the right track.)</p>
<p>Since the next piece of the code tries to load a bound node and I'm not passing
one in, I'll test to see that <code>getNode()</code> is <strong>not</strong> called.  Since the call is
on the <code>$DB</code> object, I'll set it to the mock object.  I'll also use the
<code>called()</code> method to make sure that nothing happens.  For that to happen, I
need to mock <code>getNode()</code>.  The code to implement all of this is pretty simple.
(Note that it must go in various places):</p>
<pre><code>
        $Everything::HTML::FormObject::AuthorMenu::DB = $mock;
        $mock-&gt;set_series( 'getNode', 0, 1, 2 );</code></pre>
<pre><code>
        # genObject() calls skipped in this example...</code></pre>
<pre><code>
        ok( ! $mock-&gt;called( 'getNode' ),
                '... should not fetch bound node without one' );</code></pre>
<p>Two things bear more explanation.  First, since I don't really know what I want
<code>getNode()</code> to return, I'll give it a dummy series.  (I'm pretty sure I'll be
using <code>set_series()</code> on it, because I've done tests like this before.  I can't
explain it much beyond intuitive experience.)  Second, I'm negating the return
value of <code>called()</code> so it will fit with <code>ok()</code>.  This can be a little hard to
see, sometimes.</p>
<p>The last few tests of the first pass all revolve around the <code>textfield()</code> call.
I've already mocked it, so now I'll see whether it was called with the correct
arguments:</p>
<pre><code>
        my ($method, $args) = $mock-&gt;next_call();
        shift @$args;
        my %args = @$args;</code></pre>
<pre><code>
        is( $method, 'textfield', '... and should create 
             a text field' );
        is( join(' ', sort keys %args ),
        join(' ', sort qw( -name -default -size 
             -maxlength -override )), '... passing the 
             essential arguments' );</code></pre>
             
<p>Several bits here stick out.  The <code>next_call()</code> method iterates through
the call stack of mocked methods, in order.  It doesn't track every method
called, just the ones you've added through one of <code>Test::MockObject</code>'s helper
methods.  <code>next_call()</code> returns the name of the method (in scalar context) or
the name of the method an an anonymous array containing the arguments (in list
context).</p>
<p>Since I want to check the arguments passed to <code>textfield()</code>, I call it in list
context.  Because the arguments are passed as key =&gt; value pairs, the most
natural comparison seems to be as a hash.  I use the join-sort idiom quite
often, as I've never quite been comfortable with the list comparison functions
of <code>Test::More</code>.  This test would probably be much simpler if I used them.</p>
<p>I explicitly sort both arrays just so a hardcoded list order won't cause
unnecessary test failures.  (This has bitten me when writing code that ought to
work on EBCDIC machines, not just ASCII ones.  Of course, if you get Everything
up and going on a mainframe, then this is probably the least of your concerns.)</p>
<p>Finally, I test to see whether the returned data is created properly:</p>
<pre><code>
        is( $result, &quot;some html\nmore html\n&quot;,
            '... returning the parent object plus the 
             new textfield html' );</code></pre>
<p>So far, all 13 of the tests succeed.  At this point, I started my second
pass through the method, but noticed that I hadn't yet tested that <code>$name</code>
would get its default value from <code>$field</code>.  I'll add 'field' to %gpa before
the first pass:</p>
<pre><code>
        $gpa{f} = 'field';</code></pre>
<p>This test ought to go before the final test in this pass, so I add it there,
too.  This finishes the first pass:</p>
<pre><code>
        is( $args{-name}, 'field',
                '... and widget name should default 
                to field name' );
</code></pre>















<p>For the second pass, I will test what happens when I provide a node to which to
bind the form object.  In an unmocked Everything, this node comes as an
argument to the function.  In the tests, I <strong>must</strong> return them from the mocked
getParamArray(), so that's where I will start.  I also set the 'field' value
in the mock object to a sentinel value I'll check for later.  Since the value
of <code>$field</code> will be 'field,' it works out nicely.  (There's room to be much
more creative on these names, especially if you're trying to sneak the name of
a friend into your software.)</p>
<pre><code>
        $gpa{bn} = $mock;
        $mock-&gt;{field} = 'bound node';</code></pre>
<p>Because <code>getNode()</code> has a series set on it and hasn't been called before, it
will return 0.  That means that <code>isOfType()</code> won't be called on the author
object, and the default choice won't be modified from its undefined value.
These tests are fairly easy:</p>
<pre><code>
        genObject( $mock );
        
        ($method, $args) = $mock-&gt;next_call();
        isnt( $method, 'isOfType',
        '... not checking bound node type if it is not found' );
        
        shift @$args;
        %args = @$args;
        is( $args{-default}, undef, '... and not modifying 
             default selection' );
            
</code></pre>

<p>As before, <code>next_call()</code> comes in handy.  Since I already know that
<code>textarea()</code> will be the first (and last, for this pass) method called, I can
make sure that <code>isOfType()</code> was <strong>not</strong> called.</p>
<p>Two tests follow.  One ensures that the code checks the node's type.  The other
makes sure that the default value becomes a blank string if the type is
incorrect.  To make this work, I had to modify the existing <code>getNode()</code> series
to return two instances of <code>$mock</code>.</p>
<pre><code>
        $mock-&gt;&#123;title&#125; = 'bound title';
        $mock-&gt;set_series( 'isOfType', 0, 1 );
        
        genObject( $mock );
        
        ($method, $args) = $mock-&gt;next_call( 2 );
        is( $method, 'isOfType', '... if bound node 
            is found, should check type' );
        is( $args-&gt;[1], 'user', '... (the user type)' );
        
        ($method, $args) = $mock-&gt;next_call();
        shift @$args;
        %args = @$args;
        is( $args{-default}, '',
            '... setting default to blank string 
                 if it is not a user' );</code></pre>

<p>The only new idea here is of passing an argument to <code>next_call()</code>.  I know
<code>getNode()</code> is the first mocked method, so I can safely skip it.  These tests
all pass.  The final testable condition is where the bound node exists and
is a 'user' type node.  The <code>set_series()</code> call in the last test block makes
<code>isOfType()</code> return true for this pass:</p>
<pre><code>
        genObject( $mock );
        ($method, $args) = $mock-&gt;next_call( 3 );
        shift @$args;
        %args = @$args;
        is( $args{-default}, 'bound title', '... but using 
             node title if it is' );</code></pre>
<p>I now have 22 successful tests.  My original test name plan had 14 tests, but
that number generally grows as I see more logic branches.  I could add more
tests, making sure that default values are not overwritten, and that the
essential (hardcoded) attributes of the <code>textfield()</code> are set, but I'm
reasonably confident in the tests as they stand.  If something breaks, then I'll add
a test to catch the bug before I fix it, but what's left is simple enough; I
doubt it will break.  (Writing that is a good way to have to eat my words
later.)</p>
<p>
</p>
<h2><a name="testing_another_method_(a_less_detailed_example)">Testing Another Method (A Less Detailed Example)</a></h2>
<p>One method remains for this form Object: <code>cgiVerify()</code>.  When the Engine
processes input from submitted Form Object forms, it must rebuild the objects.
Then, it checks the input against allowed values for the widgets.  This method
does just that.  Its code is slightly longer, and reads:</p>
<pre><code>
        my ($this, $query, $name, $USER) = @_;
        
        my $bindNode = $this-&gt;getBindNode($query, $name);
        my $author = $query-&gt;param($name);
        my $result = {};
        
        if($author)
        {
                my $AUTHOR = $DB-&gt;getNode($author, 'user');
                
                if($AUTHOR)
                {
                        # We have an author!!  Set the CGI param 
                        # so that the
                        # inherited cgiUpdate() will just do 
                        # what it needs to!
                        $query-&gt;param($name, $$AUTHOR{node_id});
                }
                else
                {
                        $$result{failed} = &quot;User '$author' 
                             does not exist!&quot;;
                }
        }
        
        if($bindNode)
        {
                $$result{node} = $bindNode-&gt;getId();
                $$result{failed} = &quot;You do not have permission&quot;
                        unless($bindNode-&gt;hasAccess($USER, 'w'));
        }
        
        return $result;</code></pre>
        
<p>Rather than describing the writing of the tests (and my steps and missteps
therein), I'll just comment on the tests themselves.</p>
<pre><code>
        my $qmock = Test::MockObject-&gt;new();
        $mock-&gt;set_series( 'getBindNode', 0, 0, 0, 
             $mock, $mock );
        $qmock-&gt;set_series( 'param', 0, 'author', 'author' );</code></pre>
<p>Because of the way this method handles things, it's clearer to create another
mock object to pass in as <code>$query</code>.  I'm also setting up the two main series
used for the several passes through this method.  While writing the tests, I
kept adding new values to these series.  This is what remained at the end.
This approach makes more sense to me than setting each mock before each pass,
but it's a matter of style, and either way will work.</p>
<pre><code>
        $result = cgiVerify( $mock, $qmock, 'boundname' );</code></pre>
<pre><code>
        ($method, $args) = $mock-&gt;next_call();
        is( $method, 'getBindNode', 'cgiVerify() should get 
             bound node' );
        is( join(' ', @$args), &quot;$mock $qmock boundname&quot;,
                '... with query object and query 
                     parameter name' );</code></pre>
<p>Here's the reason I used separate mock objects: to tell them apart as arguments
in the <code>getBindNode()</code> call.</p>













<pre><code>
        ($method, $args) = $qmock-&gt;next_call();
        is( $method, 'param', '... fetching parameter' );
        is( $args-&gt;[1], 'boundname', '... by name' );</code></pre>
<pre><code>
        isa_ok( $result, 'HASH', '... and should return a data 
             structure which' );</code></pre>
<p>The weird test name here is another of my little idioms.  <code>isa_ok()</code> adds 'isa
(reference type)' to the end of its test names, and I want them to be as clear
as possible when they're displayed.</p>
<pre><code>
        $mock-&gt;set_series( 'getNode', 0, { node_id =&gt; 
             'node_id' } );
        $result = cgiVerify( $mock, $qmock, 'boundname' );
        
        ($method, $args) = $mock-&gt;next_call( 2 );
        is( $method, 'getNode', '... fetching the node, if an 
             author is found' );
        is( join(' ', @$args), &quot;$mock author user&quot;,
                '... with the author, for the user type' );
                
        is( $result-&gt;{failed}, &quot;User 'author' does not exist!&quot;,
                '... setting a failure message on failure' );</code></pre>
                
<p>I like the approach of joining the arguments in a string and doing an <code>is()</code>
or a <code>like()</code> call on them.  The benefit of <code>like()</code> is that you can ignore
the <code>$self</code> passed as the first argument, because it's the mock object.  I
used <code>is()</code> here to make it more explicit what I'm expecting.</p>
<pre><code>
        $qmock-&gt;clear();
        $result = cgiVerify( $mock, $qmock, 'boundname' );
        ($method, $args) = $qmock-&gt;next_call( 2 );
        is( $method, 'param', '... setting parameters, 
             on success' );
        is( join(' ', @$args), &quot;$qmock boundname node_id&quot;,
             '... with the name and node id' );
        is( $result-&gt;{failed}, undef, 
             '... and no failure message' );</code></pre>
<p>This bit of code gave me trouble until I added the <code>clear()</code> call.  It's worth
remembering that a mock object's stack of mocked calls persists through passes.
I had forgotten that, and was using the first <code>param()</code> call instead of the
second.  Oops.</p>
<p>Another thing worth noting is that I pass 'undef' as the expected result to
<code>is()</code>.  Conveniently, <code>Test::More</code> silently does the right thing.</p>
<pre><code>
        $mock-&gt;set_always( 'getId', 'id' );
        $mock-&gt;set_series( 'hasAccess', 0, 1 );
        $result = cgiVerify( $mock, $qmock, 
             'boundname', 'user' );</code></pre>
<p>Here, I exercise the method's final clause.  These tests are more complex than
the code being tested!  Sometimes, it works out that way.</p>
<pre><code>
        $mock-&gt;called_pos_ok( -2 , 'getId',
                '... should get bound node id, if it exists' );
        is( $result-&gt;{node}, 'id',
                '... setting it in the resulting node field' );
                
        $mock-&gt;called_pos_ok( -1, 'hasAccess', 
             '... checking node access ');
        is( $mock-&gt;call_args_string( -1, ' ' ), 
             &quot;$mock user w&quot;, 
             '... for user with write permission' );
</code></pre>
                
<p>I've moved away from the <code>next_call()</code> approach to the older <code>Test::MockObject</code>
behavior of using positions in the call stack.  I'm still not quite pleased
with the names of these methods, but the negative subscripts are handy.
(Maybe I need to add <code>prev_call()</code>).  All I have to do is remember that
<code>hasAccess()</code> is called last, and that <code>getId()</code> should be called as the
second-to-last method.</p>
<p>The other new method here is <code>call_args_string()</code>, which simply joins the
arguments at the specified call position together.  It saves a bit of typing,
most of which is offset by the long method name.
</p>
<pre><code>

        is( $result-&gt;{failed}, 'You do not have permission',
                '... setting a failure message if user lacks 
                 write permission' );

        $result = cgiVerify( $mock, $qmock, 'boundname', 'user' );
        is( $result-&gt;{failed}, undef, '... and none if the user 
             has it' );</code></pre>

<p>These final two tests demonstrate how, at the end of a long series of tests,
the available options are whittled down.  By the final couple of passes, I'm
generally testing only one thing at a time.  That always seems mathematically
poetic, to me, as if I'm refining with Newton's method.</p>
<p>
</p>
<h2><a name="conclusion">Conclusion</a></h2>
<p>This whole exercise has produced 39 tests.  My next step is to update the test
plan with this information.</p>
<pre><code>
        # way back at the top
        use Test::More tests =&gt; 39;</code></pre>
<p>This makes it easier to see whether too many or too few tests were run.  I get
better results about failures and successes this way, too.  As it turns out,
writing the tests for <code>cgiVerify()</code> took about 20 minutes, give or take some
laundry-related distractions.  That seems about right for 17 tests on code I
haven't read in several months -- about one a minute, when you know what you're
doing.</p>
<p>It's worth noting the features of this module that lead me to consider mock
objects.  Mostly, the process of fetching and building nodes is complex enough
that I didn't really want to hook up a fake database, just so I could go
through all of the code paths required to test that an author is really an
author.  If the code had gone through some simple mathematical or textual
manipulations, then I would probably have used black-box testing.  Code that relies
on a database abstraction layer (as does Everything) generally makes me reach
for <code>Test::MockObject</code>, however.</p>
<p>For more information on what the module can do, please see its documentation.
The current stable version is 0.08, though 0.09 will probably have been
released by the time this article is stable.
</p>

<p><em>chromatic is the author of <a href="http://onyxneon.com/books/modern_perl/">Modern Perl</a>. In his spare time, he has been working on <a href="http://trendshare.org/how-to-invest/">helping novices understand stocks and investing</a>.</em></p>
        </div>



    </div>
    <div class="asset-footer"></div>
</div>


                            
                            <div id="entry-1330" class="entry-asset asset hentry">
    <div class="asset-header">
        <h2 class="asset-name entry-title"><a href="/pub/2002/07/p6pdigest/20020702.html" rel="bookmark">This week on Perl 6 ~(24-30 June 2002)</a></h2>
        <div class="asset-meta">
            <span class="byline">
    
                By <span class="vcard author">Piers Cawley</span> on <abbr class="published" title="2002-07-02T00:00:00-08:00">July  2, 2002 12:00 AM</abbr>
    
            </span>

            
            

        </div>
    </div>
    <div class="asset-content entry-content">

        <div class="asset-body">
            <h2><a name="notes">Notes</a></h2>
<p>Experimenting with a slightly different format this week (theft from
NTKnow considered sensible ...), I'll also be looking at some of the
things that've been posted on use.perl.org (and I'd really appreciate
some reports on the YAPC Perl6 chats from those who were there, so I
can summarize them for the next issue or as an appendix to this one).</p>
<p>
</p>
<h2><a name="system_calls/spawning_new_processes">System calls/spawning new processes</a></h2>
<p>A newbie seemed somewhat confused about the purpose of the
perl6-language list and asked about spawning subprocesses ... in Perl 5.
Mark J Read demonstrated admirable tact and diplomacy in both pointing
the newcomer at a better place to ask <a href="mailto:(perl-beginners@perl.org,">(perl-beginners@perl.org,</a> a
<em>great</em> mailing list) <em>and</em> providing some pointers toward an
answer.</p>
<p>The only reason this particular episode made the summary, by the way, is
because of its rarity. I've been generally impressed by the general
'on topicness' of the perl6-* lists. I hope it stays that way for
a long time to come.</p>
<p>Mailing list urls omitted to protect the innocent.</p>
<p>
</p>
<h2><a name="ruby_iterators">Ruby iterators</a></h2>
<p>Ruby interators were the subject of Erik Steven Harrison's post, which also
referred to 'pass by name' and 'the Jensen Machine,' and wanted to know
'the Perl 6 stance on the matter.' Nobody has yet stepped up to the
plate on this one and, speaking personally, I'm not entirely sure I've
understood the question.</p>
<p><a href="http://archive.develooper.com/perl6-language@perl.org/msg10175.html">http://archive.develooper.com/perl6-language@perl.org/msg10175.html</a>
has the whole question</p>
<p>
</p>
<h2><a name="fun_with_the_perl_6_grammar.">Fun With the Perl 6 Grammar.</a></h2>
<p>Sean O'Rourke asked us to ``disregard my past shoddy attempt at a Perl
6 grammar'' and presented ``a larger one that appears to capture much more of
the syntax found in Apocalypses and Exegeses 1 - 4 (5 just scares
me).'' He promises bugs and missing elements, but still earns hero
points from me.</p>
<p>Later in the week, Dan asked how the Perl 6 grammar was going, and
Ashley Winters responded that he isn't working on a grammar, but
posted a list of variable forms (and a couple of other awkward
constructs) with which he'd be testing each grammar. I particularly
liked the last three entries in his list:</p>
<pre>
   ...
   # As a final sanity check, let's chain these things</pre>
<pre>
   @.proc[$*PID].ps.{RSS};
   @proc.[$*PID].ps().{RSS};</pre>
<pre>
   # And, just to make sure your parser doesn't pass this suite</pre>
<pre>
   $foo{&quot;Do you want to try $interpolated{&quot;string&quot;}?&quot;};</pre>
<p>Sean O'Rourke responded with some comments on the legality of some of
the examples, and offered his own <code>*@$*foo</code>, a flattened, dereferenced,
global <code>$foo</code>, he thinks (and I concur). (Ooh... I just had a bad
thought. @foo^.(), AFAICT it's the same as <code>map $_.(), @foo</code>, but a
good deal more evil).</p>
<p>There was also some talk of overriding <code>[]</code> on hashes and <code>{}</code> on
arrays to do surprising things. Personally, I reckon if you're going
to do perverse stuff like that, then you should add some rules to the
grammar to make it legal, as well as writing the tie magic (or its perl
6 equivalent), but laziness meant I didn't post that to the list.</p>
<p>Oh, yes. John Porter suggested that 'maybe Damian
should write [the grammar]?' Which leads me to postulate an analog to Godwin's
Law, tailored to the Perl 6 process, stating that at some point in any thread
about the Perl 6 language, someone will suggest that Damian do it. Or
maybe Damian <em>will</em> do it. After all, Reports from YAPC seem to imply that he's
come up with a cunning way of doing things in zero time (but I'm
assuming he uses lots of space to compensate).</p>
<p>This thread kicks off at
<a href="http://archive.develooper.com/perl6-internals@perl.org/msg10705.html">http://archive.develooper.com/perl6-internals@perl.org/msg10705.html</a>.</p>
<p>Sean O'Rourke's parser is at 
<a href="http://archive.develooper.com/perl6-internals@perl.org/msg10692.html">http://archive.develooper.com/perl6-internals@perl.org/msg10692.html</a>.</p>
<p>
</p>
<h2><a name="the_increasingly_misnamed_'perl5_humor'_thread.">The Increasingly Misnamed 'Perl5 humor' Thread</a></h2>
<p>Particulary, the branch that should be titled 'Porting XS modules to
Parrot' rumbled on, mostly discussing how one would do it without
implementing the entire Perl 5 virtual machine on top of Parrot, with
a small digression about achieving flight if you waved your hands fast
enough.</p>
<p>Dan, as usual, applied the scalpel very neatly. ``Parrot's not going to
have XS as an interface -- that'd be insane,'' proposing instead an 80-20
type solution and suggested that, ``If someone wants to start a list of
<em>sensible</em> entries in Perl 5's API that should be provided, we can
work from there.'' Tim Bunce suggested starting ``with a perl script
that reads extension source code ... and spits out details of what
perlapi/guts have been used,'' feeding it a bunch of popular
extensions, and then profiling the results.</p>
<p>The implementation of such a tool was left as an exercise for the
interested reader.</p>
<p>Dave Goehrig appears to have been that interested reader, as he kicked
off the 'Possibility of XS support' thread. He took at look at some
sample XS-based modules and reckoned that getting a minimal core of XS
up would need about 50 functions to be ported. Dan thought that would
be cool (no surprise there then, it <em>would</em> be cool) and Dave (the
star) set off implementing an extension API for parrot. Dave also
pointed at the Python and Ruby extension mechanisms as examples of
good solutions to the general problem. Dan told us that he's ``trying
to kate the line between exposing the semantics of the internals and
the actual internals,'' and commented that the semantics of what XS
does are fine, but that the syntax is horrible. He also made it clear that
any XS compatibility layer would live outside the Parrot core.</p>
<p>See:
<a href="http://archive.develooper.com/perl6-internals@perl.org/msg10672.html">http://archive.develooper.com/perl6-internals@perl.org/msg10672.html</a>
for the application of the scalpel.</p>
<p><a href="http://archive.develooper.com/perl6-internals@perl.org/msg10671.html">http://archive.develooper.com/perl6-internals@perl.org/msg10671.html</a>
has the start of the 'Possibility of XS support' thread. It's all
worth reading.</p>
<p>
</p>
<h2><a name="stack_performance">Stack performance</a></h2>
<p>Tom Hughes posted a patch to the stack code. His test figures are
impressive:
                                  No overflow     Overflow
  Integer stack, before patch      0.065505s     16.589480s
  Integer stack, after patch       0.062732s      0.068460s
  Generic stack, before patch      0.161202s      5.475367s
  Generic stack, after patch       0.166938s      0.168390s</p>
<p>The test programs ``push and pop 65536 times with the first column being when
that loop doesn't cross a chunk boundary and the second being when it
does cross a chunk boundary.''</p>
<p>Dan was impressed, and subject to a couple of caveats, it looks like
the patch will be accepted.</p>
<p><a href="http://archive.develooper.com/perl6-internals@perl.org/msg10704.html">http://archive.develooper.com/perl6-internals@perl.org/msg10704.html</a>
has the patch.</p>
<p>
</p>
<h2><a name="small_stuff">Small stuff</a></h2>
<p><a href="http://archive.develooper.com/perl6-internals@perl.org/msg10703.html">http://archive.develooper.com/perl6-internals@perl.org/msg10703.html</a>
Dan added a <code>find_type</code> op to make working with noncore PMC types
much easier (no more modifying the assembler code every time ...) And a
<code>lookback</code> op for inspecting the user stack (in type safe fashion).</p>
<p><a href="http://archive.develooper.com/perl6-internals@perl.org/msg10682.html">http://archive.develooper.com/perl6-internals@perl.org/msg10682.html</a>:
Dan also took advantage of the new, mutable strings to write a
<code>string_append</code> op, and doctored copre.ops to use it for ``concat Sx,
Sy'' where x is both source and destination. The phrase ``Order of
magnitude or two'' was used, so that's probably good then.</p>
<p><a href="http://archive.develooper.com/perl6-internals@perl.org/msg10702.html">http://archive.develooper.com/perl6-internals@perl.org/msg10702.html</a>:
Brian Wheeler gave us the ``typeof op, which returns the integer type or
string type of a PMC.'' (Thanks. Applied. -- Dan)</p>
<p><a href="http://archive.develooper.com/perl6-internals@perl.org/msg10701.html">http://archive.develooper.com/perl6-internals@perl.org/msg10701.html</a>:
Simon offers ``more extensive tests for the mul_p_p op.''</p>
<p><a href="http://archive.develooper.com/perl6-internals@perl.org/msg10700.html">http://archive.develooper.com/perl6-internals@perl.org/msg10700.html</a>:
Eric Kidder provided a ``list of all the opcodes [...] that are not
documented in docs/pdds/pdd06_pasm.pod,'' and a list of all the opcodes
that are documented but not implemented.</p>
<p>Peter Cooper pointed to his review of ``Virtual Machine Implementation
in C/C++'', available at <a href="http://makeashorterlink.com/?T2EA32221">http://makeashorterlink.com/</a></p>
<p><a href="http://archive.develooper.com/perl6-internals@perl.org/msg10708.html">http://archive.develooper.com/perl6-internals@perl.org/msg10708.html</a>
Leon Brocard offers a patch to escape strings when tracing.</p>
<p>Leon also offers
<a href="http://archive.develooper.com/perl6-internals@perl.org/msg10709.html">http://archive.develooper.com/perl6-internals@perl.org/msg10709.html</a>,
the latest version of his bravura mandelbrot set generator written in
Parrot.</p>
<p>
</p>
<h2><a name="meanwhile,_away_from_the_mailing_lists...">Meanwhile, Away From the Mailing Lists ...</a></h2>
<p>Dan said in his use.perl.org journal that ``Damian's [YAS/Perl
Foundation] grant is up now, and not coming back. Mine ends at the end of
July, and barring a miracle (which means we gather more than $60,000
before the end of July), is also not being extended. A chunk of what's
left is going to hire a professional grant writer, with everything
after, up to $40,000, going to fund Larry.''</p>
<p>I'd like to extend my heartfelt thanks and best wishes to Damian
for the work he's done for Perl 6. While the more visible parts of
the work he's done have been <em>jeux d'esprits</em> like
Lingua::Romana::Perligata, Acme::Bleach and the scary talks like
Time::Space::Continuum or whatever it's called, it's also apparent
that the work that's gone on behind the scenes to help Larry make Perl
6 be the best it can be has been unceasing, and his Exegeses have
often been masterful examples of how to explain tricky concepts with
clarity.</p>
<p>Dan's work for Perl 6 has been more visible more often.  Parrot is
looking good, in large part because of Dan's efforts as programmer and
project manager. Personally, I hope the miracle happens; having Dan
full time can only be a good thing.</p>
<p><a href="http://use.perl.org/~Elian/journal/6101">http://use.perl.org/~Elian/journal/6101</a></p>
<p>
</p>
<h2><a name="colophon">Colophon</a></h2>
<p>I'm not getting paid for this, and I don't particularly <em>want</em> to get
paid for it. But if you find the summaries useful, please, please
give some money to the Perl Foundation to support the ongoing
design and development of Perl 6 and Parrot.</p>


        </div>



    </div>
    <div class="asset-footer"></div>
</div>


                            
                            <div id="entry-1320" class="entry-asset asset hentry">
    <div class="asset-header">
        <h2 class="asset-name entry-title"><a href="/pub/2002/07/02/axkit.html" rel="bookmark">Taglib TMTOWTDI</a></h2>
        <div class="asset-meta">
            <span class="byline">
    
                By <span class="vcard author">Barrie Slaymaker</span> on <abbr class="published" title="2002-07-02T00:00:00-08:00">July  2, 2002 12:00 AM</abbr>
    
            </span>

            
            

        </div>
    </div>
    <div class="asset-content entry-content">

        <div class="asset-body">
            
<!-- sidebar begins -->
<!-- don't move sidebars -->
<!-- sidebar ends -->
<p>As with many Perl systems, AxKit often provides multiple ways of doing
things.  Developers from other programming cultures may find these choices and
freedom a bit bewildering at first but this (hopefully) soon gives way to the
realization that the options provide power and freedom.  When a
tool set limits your choices too much, you end up doing things like driving
screws with a nailgun.  Of course, too many choices isn't necessarily a good
thing, but it's better than too few.</p>

<p><a href="/pub/a/2002/04/16/axkit.html">Last time</a>, we
saw how to build a weather reporting application by implementing a simple
taglib module, My::WeatherTaglib, in Perl and deploying it in <a
herf="/pub/a/2002/04/16/axkit.html#weather1_flow.png">a
pipeline</a> with other XML filters.  The pipeline approach allows one kind of
flexibility: the freedom to decompose an application in the most appropriate
manner for the requirements at hand and for the supporting organization.</p>



<p>Another kind of flexibility is the freedom to implement filters using
different technologies.  For instance, it is sometimes wise to build taglibs in
different ways.  In this article, we'll see how to build the same taglib using
two other approaches.  The first rebuild uses the technique implemented by the
Cocoon project, <a
href="http://xml.apache.org/cocoon/userdocs/xsp/logicsheet-concepts.html">LogicSheets</a>.
The second uses J&ouml;rg Walter's relatively new <a
href="http://search.cpan.org/doc/MSERGEANT/AxKit-1.51/lib/Apache/AxKit/Language/XSP/SimpleTaglib.pm">SimpleTaglib</a>
in place of the <a
href="http://search.cpan.org/doc/MSERGEANT/AxKit-1.51/lib/Apache/AxKit/Language/XSP/TaglibHelper.pm">TaglibHelper</a>
used for My::WeatherTaglib in the previous article. SimpleTaglib is a somewhat
more powerful, and, oddly, more complex module than TaglibHelper (though the
author intends to make it a bit simpler to use in the near future).</p>

<a name="CHANGES" /><h3>CHANGES</h3>

<p>AxKit v1.6 is now out with some nice bug fixes and performance
improvements, mostly by Matt Sergeant and J&ouml;rg Walter, along with several
new advanced features from Kip Hampton which we'll be covering in future
articles. 

<p>Matt has also updated his AxKit compatible <a
href="http://search.cpan.org/doc/MSERGEANT/AxKit-1.6/lib/Apache/AxKit/Language/AxPoint.pm">AxPoint</a>
PowerPoint-like HTML/PDF/etc. presentation system.  If you're going to attend any of the
big Perl conferences this season, then you're likely to see presentations built with
AxPoint. It's a nice system that's also covered in an <a
href="http://www.xml.com/pub/a/2002/06/19/perl-xml.html">XML.com article by Kip
Hampton</a>.</p>

<a name="AxTraceIntermediate" /><h4>AxTraceIntermediate</h4>

<p>The one spiffy new feature I used -- rather more often than I'd like to
admit -- in writing this article is the debugging directive
<code>AxTraceIntermediate</code>, added by J&ouml;rg Walter.  This directive
defines a directory in which AxKit will place a copy each of the intermediate
documents passed between filters in the pipeline.  So a setting like:</p>

<pre><code>    AxTraceIntermediate /home/barries/AxKit/www/axtrace
</code></pre>

<p>will place one file in the <code>axtrace</code> directory for each
intermediate document.  The full set of directives in <code>httpd.conf</code>
used for this article is <a href="/pub/a/2002/07/02/axkit.html?page=2#httpd.conf">shown later</a>.</p>

<p>Here is the axtrace directory after requesting the URIs <code>/</code>
(from the first article), <code>/02/weather1.xsp</code> (from the second
article), <code>/03/weather1.xsp</code> and <code>/03/weather2.xsp</code> (both
from this article):</p>

<pre><code>    |index.xsp.XSP         # Perl source code for /index.xsp
    |index.xsp.0           # Output of XSP filter

    |02|weather1.xsp.XSP   # Perl source code for /02/weather1.xsp
    |02|weather1.xsp.0     # Output of XSP
    |02|weather1.xsp.1     # Output of weather.xsl
    |02|weather1.xsp.2     # Output of as_html.xsl

    |03|weather1.xsp.XSP   # Perl source code for /03/weather1.xsp
    |03|weather1.xsp.0     # Output of XSP
    |03|weather1.xsp.1     # Output of weather.xsl
    |03|weather1.xsp.2     # Output of as_html.xsl

    |03|weather2.xsp.XSP   # Perl source code for /02/weather2.xsp
    |03|weather2.xsp.0     # output of my_weather_taglib.xsl
    |03|weather2.xsp.1     # Output of XSP
    |03|weather2.xsp.2     # Output of weather.xsl
    |03|weather2.xsp.3     # Output of as_html.xsl
</code></pre>

<p>Each filename is the path portion of the URI with the <code>/</code>s
replaced with <code>|</code>s and a step number (or .XSP) appended.  The
numbered files are the intermediate documents and the <code>.XSP</code> files
are the Perl source code for any XSP filters that happened to be compiled for
this request.  Compare the <code>|03|weather2.xsp.*</code> files to the <a
href="#weather2_pipeline.png">the pipeline diagram</a> for the /03/weather2.xsp
request.

<p>Watch those "<code>|</code>" characters: they force you to quote the
filenames in most shells (and thus foil any use of wildcards):</p>

<pre><code>    $ <b>xmllint --format "www/axtrace/|03|weather2.xsp.3"</b>
    &lt;?xml version="1.0" standalone="yes"?&gt;
    &lt;html&gt;
      &lt;head&gt;
        &lt;meta content="text/html; charset=UTF-8" http-equiv="Content-Type"/&gt;
        &lt;title&gt;My Weather Report&lt;/title&gt;
      &lt;/head&gt;
      &lt;body&gt;
        &lt;h1&gt;&lt;a name="title"/&gt;My Weather Report&lt;/h1&gt;
        &lt;p&gt;Hi! It's 12:43:52&lt;/p&gt;
        &lt;p&gt;The weather in Pittsburgh is Sunny
        ....
</code></pre>

<p><b>NOTE:</b> The <code>.XSP</code> files are only generated if the XSP sheet
is recompiled, so you may need to <code>touch</code> the source document or
restart the server to generate a new one.  Another gotcha is that if an error
occurs halfway down the processing pipeline, then you can end up with stale files.
In this case, the lower-numbered files (those generated by successful filters)
will be from this request, but the higher-numbered files will be stale, left
over from the previous requests.  A slightly different issue can occur when
using dynamic pipeline configurations (which we'll cover in the future): you
can end up with a shorter pipeline that only overwrites the lower-numbered
files and leaves stale higher-numbered files around.</p>

<p>These are pretty minor gotchas when compared to the usefulness of this
feature, you just need to be aware of them to avoid confusion.  When debugging
for this article, I used a Perl script that does something like:</p>

<pre><code>    rm -f www/axtrace/*
    rm www/logs/*
    www/bin/apachectl stop
    sleep 1
    www/bin/apachectl start
    GET http://localhost:8080/03/weather1.xsp
</code></pre>

<p>to start each test run with a clean fileset.</p>

<a name="UnderTheXSPHood" /><h3>Under the XSP Hood</h3>

<p>Before we move on to the examples, let's take a quick peek at how XSP pages
are handled by AxKit.  This will help us understand the tradeoffs inherent in
the different approaches.</p>

<p>AxKit implements XSP filters by compiling the source XSP page into a
<code>handler()</code> function that is called to generate the output page.
This is compiled in to Perl bytecode, which is then run to generate the XSP
output document:</p>

<a name="xsp_compiler.png" /><img src="/pub/2002/07/02/graphics/xsp_compiler.png" alt="XSP architecture" width="340" height="219" />

<p>This means that XSP page is not executed directly, but by running relatively
efficient compiled Perl code.  The bytecode is kept in memory so the overhead
of parsing and code generation is not incurred for each request.</p>

<p>There are three types of Perl code used in building the output
document: code to build the bits of static content, code that was
present verbatim in the source document -- enclosed in tags like
<code>&lt;xsp:logic&gt;</code> and
<code>&lt;xsp:expr&gt;</code> -- and code that implements tags
handled by registered taglib modules like My::WeatherTaglib
from the last article.<p>

<p>Taglib modules hook in to the XSP compiler by registering themselves
as handlers for a namespace and then coughing up snippets of code to be
compiled in to the <code>handler()</code> routine:</p>

<a name="xsp_taglib_hookin.png" /><img src="/pub/2002/07/02/graphics/xsp_taglib_hookin.png" alt="XSP with Taglib Modules Hooking in" width="351" height="372" />

<p>The snippets of code can call back into the taglib module or out to other
modules as needed.  Modules like <a
href="http://search.cpan.org/doc/MSERGEANT/AxKit-1.51/lib/Apache/AxKit/Language/XSP/TaglibHelper.pm">TaglibHelper</a>,
which we used to build My::WeatherTaglib and <a
href="http://search.cpan.org/doc/MSERGEANT/AxKit-1.51/lib/Apache/AxKit/Language/XSP/SimpleTaglib.pm">SimpleTaglib</a>,
which we use later in this article for My::SimpleWeatherTaglib, automate the
drudgery of building a taglib module so you don't need to parse XML or even
(usually) generate XML.</p>

<p>You can view the source code that AxKit generates by cranking the
<code>AxDebugLevel</code> up to 10 (which places the code in Apache's ErrorLog)
or using the <code>AxTraceIntermediate</code> directive mentioned above.  Then
you must persuade AxKit to recompile the XSP page by restarting the server and
requesting a page. If either of the necessary directives are already present in
a running server, then simply <code>touch</code>ing the file to update its
modification time will suffice.</p>

<p>This can be useful for getting a <i>really</i> good feel for what's going on
under the hood.  I encourage new taglib authors to do this to see how the code
for your taglib is actually executed.  You'll end up needing to do it to debug
anyway (trust me :).</p>

<a name="XSLT" /><h3>LogicSheets: Upstream Taglibs</h3>

<p>AxKit uses a pipeline processing model and XSP includes tags like
<code>&lt;xsp:logic&gt;</code> and <code>&lt;xsp:expr&gt;</code> that allow you
to embed Perl code in an XSP page.  This allows taglibs to be implemented as XML
filters that are placed upstream of the XSP processor.  These usually use XSLT
to and convert taglib invocations to inline code using XSP tags:</p>

<a name="logic_sheet_pipeline.png" /><img src="/pub/2002/07/02/graphics/logic_sheet_pipeline.png" alt="Upstream LogicSheets feeding the XSP processor" width="420" height="200"/>

<p>In fact, this is how XSP was originally designed to operate and Cocoon uses
this approach exclusively to this day (but with inline Java instead of Perl).
I did not show this approach in the first article because it is considerably
more awkward and less flexible than the taglib module approach offered by
AxKit.</p>

<p>The Cocoon project calls XSLT sheets that implement taglibs <a
href="http://xml.apache.org/cocoon/userdocs/xsp/logicsheet-concepts.html">LogicSheets</a>
a convention I follow in this article (I refer to the all-Perl taglib
implementation as "taglib modules").</p>

<a name="weather2.xsp" /><h4><code>weather2.xsp</code></h4>

<p>Before we look at the logicsheet version of the weather report
taglib, here is the XSP page from the last article updated to use
it:

<pre><code>
<b>&lt;?xml-stylesheet href="my_weather_taglib.xsl" type="text/xsl"?&gt;</b>
&lt;?xml-stylesheet href="NULL"                  type="application/x-xsp"?&gt;
&lt;?xml-stylesheet href="weather.xsl"           type="text/xsl"?&gt;
&lt;?xml-stylesheet href="as_html.xsl"           type="text/xsl"?&gt;

&lt;xsp:page
    xmlns:xsp="<b>http://apache.org/xsp/core/v1</b>"
    xmlns:util="http://apache.org/xsp/util/v1"
    xmlns:param="http://axkit.org/NS/xsp/param/v1"
    xmlns:weather="http://slaysys.com/axkit_articles/weather/"
&gt;
&lt;data&gt;
  &lt;title&gt;&lt;a name="title"/&gt;My Weather Report&lt;/title&gt;
  &lt;time&gt;
    &lt;util:time format="%H:%M:%S" /&gt;
  &lt;/time&gt;
  &lt;weather&gt;
    &lt;weather:report&gt;
      &lt;!-- Get the ?zip=12345 from the URI and pass it
           to the weather:report tag as a parameter --&gt;
      &lt;weather:zip&gt;&lt;param:zip/&gt;&lt;/weather:zip&gt;
    &lt;/weather:report&gt;
  &lt;/weather&gt;
&lt;/data&gt;
&lt;/xsp:page&gt;
</code></pre>

<!--  begin sidebar  -->
<table width="50%" border="0" cellspacing="8" cellpadding="8"  align="right">
<tr><td valign="top" bgcolor="#efefef">
<p class="medlist"><b>In This Series</b></p>
<p class="smalllist"><b>
<a href="/pub/a/2002/03/16/axkit.html">Introducing AxKit</a></b><br />
The first in a series of articles by Barrie Slaymaker on setting up and running AxKit. AxKit is a mod_perl application for dynamically transforming XML. In this first article, we focus on getting started with AxKit.</p>
<p class="smalllist"><b>
<a href="/pub/a/2002/04/16/axkit.html">XSP, Taglibs and Pipelines</a></b><br />
Barrie explains what a "taglib" is, and how to use them to create dynamic pages inside of AxKit.</p>
</td></tr>
</table>
<!--  end sidebar  -->
<p>The <code>&lt;?xml-stylesheet href="my_weather_taglib.xsl"
type="text/xsl"?&gt;</code> processing instruction causes
<code>my_weather_taglib.xsl</code> (which we'll cover next) to be applied to
the <code>weather2.xsp</code> page before the XSP processor sees it.  The other
three PIs are identical to the previous version: the XSP processor is invoked,
followed by the same <a
href="/pub/a/2002/04/16/axkit.html#weather.xsl"
alt="previous article">presentation</a> and <a
href="/pub/a/2002/04/16/axkit.html#as_html.xsl"
alt="previous article">HTMLification</a> XSLT stylesheets that we used last
time.</p>

<p>The only other change from the previous version is that this one uses the
corrent URI for XSP tags.  I accidently used a deprecated URI for XSP tags in
the previous article and ended up tripping over it when I used the up-to-date
URI in the LogicSheet for this one.  Such is the life of a pointy-brackets
geek.</p>

<p>The ability to switch implementations without altering (much) code is one of
XSP's advantages over things like inline Perl code: the implementation is
nicely decoupled from the API (the tags).  The only reason we had to alter
<code>weather1.xsp</code> at all is because we're switching from a more
advanced approach (a taglib module, My::WeatherTaglib) that is configured in
the <code>httpd.conf</code> file to LogicSheets, which need per-document
configuration when using <code>&lt;xml-stylesheet&gt;</code> stylesheet
specifications.  AxKit has more flexible <code>httpd.conf</code>, plugin and
Perl based stylesheet specification mechanisms which we will cover in a future
article; I'm using the processing instructions here because they are simple and
obvious.</p>

<p>The pipeline built by the processing instructions looks like:</p>

<a name="weather2_pipeline.png" /><img src="/pub/2002/07/02/graphics/weather2_pipeline.png" alt="The pipeline for weather2.xsp" width="409" height="197" />

<p>(does not show final compression stage).</p>

<a name="my_weather_taglib.xsl" /><h4><code>my_weather_taglib.xsl</code></h4>

<p>Now that we've seen the source document and the overall pipeline,
here is <a
href="/pub/a/2002/04/16/axkit.html#My::WeatherTaglib">My::WeatherTaglib</a>
recast as a LogicSheet, <code>my_weather_taglib.xsl</code>:

<pre><code>
&lt;xsl:stylesheet 
  version="1.0"
  xmlns:xsl="http://www.w3.org/1999/XSL/Transform"
  xmlns:xsp="http://apache.org/xsp/core/v1"
  xmlns:weather="http://slaysys.com/axkit_articles/weather/"
&gt;

&lt;xsl:output indent="yes" /&gt;

&lt;xsl:template match="xsp:page"&gt;
  &lt;xsl:copy&gt;
<b>    &lt;xsp:structure&gt;
      use Geo::Weather;
    &lt;/xsp:structure&gt;</b>
    &lt;xsl:apply-templates select="@*|node()"/&gt;
  &lt;/xsl:copy&gt;
&lt;/xsl:template&gt;

&lt;xsl:template match="weather:report"&gt;
<b>  &lt;xsp:logic&gt;
    my $zip = &lt;xsl:apply-templates select="weather:zip/*" /&gt;;
    my $w = Geo::Weather-&gt;new-&gt;get_weather( $zip );
    die "Could not get weather for zipcode '$zip'\n" unless ref $w;
  &lt;/xsp:logic&gt;</b>
  &lt;state&gt;<b>&lt;xsp:expr&gt;$w-&gt;{state}&lt;/xsp:expr&gt;</b>&lt;/state&gt;
  &lt;heat&gt;<b>&lt;xsp:expr&gt;$w-&gt;{heat}&lt;/xsp:expr&gt;</b>&lt;/heat&gt;
  &lt;page&gt;<b>&lt;xsp:expr&gt;$w-&gt;{page}&lt;/xsp:expr&gt;</b>&lt;/page&gt;
  &lt;wind&gt;<b>&lt;xsp:expr&gt;$w-&gt;{wind}&lt;/xsp:expr&gt;</b>&lt;/wind&gt;
  &lt;city&gt;<b>&lt;xsp:expr&gt;$w-&gt;{city}&lt;/xsp:expr&gt;</b>&lt;/city&gt;
  &lt;cond&gt;<b>&lt;xsp:expr&gt;$w-&gt;{cond}&lt;/xsp:expr&gt;</b>&lt;/cond&gt;
  &lt;temp&gt;<b>&lt;xsp:expr&gt;$w-&gt;{temp}&lt;/xsp:expr&gt;</b>&lt;/temp&gt;
  &lt;uv&gt;<b>&lt;xsp:expr&gt;$w-&gt;{uv}&lt;/xsp:expr&gt;</b>&lt;/uv&gt;
  &lt;visb&gt;<b>&lt;xsp:expr&gt;$w-&gt;{visb}&lt;/xsp:expr&gt;</b>&lt;/visb&gt;
  &lt;url&gt;<b>&lt;xsp:expr&gt;$w-&gt;{url}&lt;/xsp:expr&gt;</b>&lt;/url&gt;
  &lt;dewp&gt;<b>&lt;xsp:expr&gt;$w-&gt;{dewp}&lt;/xsp:expr&gt;</b>&lt;/dewp&gt;
  &lt;zip&gt;<b>&lt;xsp:expr&gt;$w-&gt;{zip}&lt;/xsp:expr&gt;</b>&lt;/zip&gt;
  &lt;baro&gt;<b>&lt;xsp:expr&gt;$w-&gt;{baro}&lt;/xsp:expr&gt;</b>&lt;/baro&gt;
  &lt;pic&gt;<b>&lt;xsp:expr&gt;$w-&gt;{pic}&lt;/xsp:expr&gt;</b>&lt;/pic&gt;
  &lt;humi&gt;<b>&lt;xsp:expr&gt;$w-&gt;{humi}&lt;/xsp:expr&gt;</b>&lt;/humi&gt;</b>
&lt;/xsl:template&gt;

&lt;xsl:template match="@*|node()"&gt;
  &lt;!-- Copy the rest of the doc almost verbatim --&gt;
  &lt;xsl:copy&gt;
    &lt;xsl:apply-templates select="@*|node()"/&gt;
  &lt;/xsl:copy&gt;
&lt;/xsl:template&gt;

&lt;/xsl:stylesheet&gt;
</code></pre>

<p>The first <code>&lt;xsl:template&gt;</code> inserts an
<code>&lt;xsp:structure&gt;</code> at the top of the page with some Perl code
to <code>use Geo::Weather;</code> so the Perl code in the later
<code>&lt;xsl:logic&gt;</code> element can refer to it.  You could also preload
Geo::Weather in <code>httpd.conf</code> to share it amongst httpd processes and
simplify this stylesheet, but that would introduce a bit of a maintainance
hassle: keeping the server config and the LogicSheet in synchronization.</p>

<p>The second <code>&lt;xsl:template&gt;</code> replaces all occurences of
<code>&lt;weather:report&gt;</code> (assuming the <code>weather:</code> prefix
happens to map to the taglib URI; see <a
href="http://www.jclark.com/xml/xmlns.htm">James Clark's introduction to
namespace</a> for more details).  In place of the
<code>&lt;weather:report&gt;</code> tag(s) will be some Perl code surrounded by
<code>&lt;xsp:logic&gt;</code> and <code>&lt;xsp:expr&gt;</code> tags.  The
<code>&lt;xsp:logic&gt;</code> tag is used around Perl code that is just logic:
any value the code returns is ignored.  The
<code>&lt;xsp:expr&gt;</code> tags surround Perl code that returns a value to
be emitted as text in the result document.</p>

<p>The <code>get_weather()</code> call returns a hash describing the most
recent weather oberservations somewhere close to a given zip code:</p>

<a name="hash" /><pre><code>    {
      'city'  =&gt; 'Pittsburgh',
      'state' =&gt; 'PA',
      'cond'  =&gt; 'Sunny',
      'temp'  =&gt; '77',
      ...
    };
</code></pre>

<p>All those <code>&lt;xsp:expr&gt;</code> tags extract the values from the hash one by one and build an XML data structure.  The resulting XSP document looks like:

<pre><code>    &lt;?xml version="1.0"?&gt;
    &lt;xsp:page xmlns:xsp="http://apache.org/xsp/core/v1"<br /> xmlns:util="http://apache.org/xsp/util/v1"<br /> xmlns:param="http://axkit.org/NS/xsp/param/v1"<br /> xmlns:weather="http://slaysys.com/axkit_articles/weather/"&gt;
      &lt;xsp:structure&gt;
          use Geo::Weather;
      &lt;/xsp:structure&gt;
      &lt;data&gt;
        &lt;title&gt;&lt;a name="title"/&gt;My Weather Report&lt;/title&gt;
        &lt;time&gt;
          &lt;util:time format="%H:%M:%S"/&gt;
        &lt;/time&gt;
        &lt;weather&gt;
          &lt;xsp:logic&gt;
            my $zip = &lt;param:zip/&gt;;
            my $w = Geo::Weather-&gt;new-&gt;get_weather( $zip );
            die "Could not get weather for zipcode '$zip'\n" unless ref $w;
          &lt;/xsp:logic&gt;
          &lt;state&gt;&lt;xsp:expr&gt;$w-&gt;{state}&lt;/xsp:expr&gt;&lt;/state&gt;
          &lt;heat&gt;&lt;xsp:expr&gt;$w-&gt;{heat}&lt;/xsp:expr&gt;&lt;/heat&gt;
          &lt;page&gt;&lt;xsp:expr&gt;$w-&gt;{page}&lt;/xsp:expr&gt;&lt;/page&gt;
          &lt;wind&gt;&lt;xsp:expr&gt;$w-&gt;{wind}&lt;/xsp:expr&gt;&lt;/wind&gt;
          &lt;city&gt;&lt;xsp:expr&gt;$w-&gt;{city}&lt;/xsp:expr&gt;&lt;/city&gt;
          &lt;cond&gt;&lt;xsp:expr&gt;$w-&gt;{cond}&lt;/xsp:expr&gt;&lt;/cond&gt;
          &lt;temp&gt;&lt;xsp:expr&gt;$w-&gt;{temp}&lt;/xsp:expr&gt;&lt;/temp&gt;
          &lt;uv&gt;&lt;xsp:expr&gt;$w-&gt;{uv}&lt;/xsp:expr&gt;&lt;/uv&gt;
          &lt;visb&gt;&lt;xsp:expr&gt;$w-&gt;{visb}&lt;/xsp:expr&gt;&lt;/visb&gt;
          &lt;url&gt;&lt;xsp:expr&gt;$w-&gt;{url}&lt;/xsp:expr&gt;&lt;/url&gt;
          &lt;dewp&gt;&lt;xsp:expr&gt;$w-&gt;{dewp}&lt;/xsp:expr&gt;&lt;/dewp&gt;
          &lt;zip&gt;&lt;xsp:expr&gt;$w-&gt;{zip}&lt;/xsp:expr&gt;&lt;/zip&gt;
          &lt;baro&gt;&lt;xsp:expr&gt;$w-&gt;{baro}&lt;/xsp:expr&gt;&lt;/baro&gt;
          &lt;pic&gt;&lt;xsp:expr&gt;$w-&gt;{pic}&lt;/xsp:expr&gt;&lt;/pic&gt;
          &lt;humi&gt;&lt;xsp:expr&gt;$w-&gt;{humi}&lt;/xsp:expr&gt;&lt;/humi&gt;
        &lt;/weather&gt;
      &lt;/data&gt;
    &lt;/xsp:page&gt;
</code></pre>

<p>and the output document of that XSP page looks like:</p>

<pre><code>    &lt;?xml version="1.0" encoding="UTF-8"?&gt;
    &lt;data&gt;
      &lt;title&gt;&lt;a name="title"/&gt;My Weather Report&lt;/title&gt;
      &lt;time&gt;17:06:15&lt;/time&gt;
      &lt;weather&gt;
        &lt;state&gt;PA&lt;/state&gt;
        &lt;heat&gt;77&lt;/heat&gt;
        &lt;page&gt;/search/search?what=WeatherLocalUndeclared
        &amp;where=15206&lt;/page&gt;
        &lt;wind&gt;From the Northwest at 9 gusting to 16&lt;/wind&gt;
        &lt;city&gt;Pittsburgh&lt;/city&gt;
        &lt;cond&gt;Sunny&lt;/cond&gt;
        &lt;temp&gt;77&lt;/temp&gt;
        &lt;uv&gt;4&lt;/uv&gt;
        &lt;visb&gt;Unlimited miles&lt;/visb&gt;
        &lt;url&gt;http://www.weather.com/search/search?
        what=WeatherLocalUndeclared&amp;where=15206&lt;/url&gt;
        &lt;dewp&gt;59&lt;/dewp&gt;
        &lt;zip&gt;15206&lt;/zip&gt;
        &lt;baro&gt;29.97 inches and steady&lt;/baro&gt;
        &lt;pic&gt;http://image.weather.com/web/common/wxicons/52/30.gif&lt;/pic&gt;
        &lt;humi&gt;54%&lt;/humi&gt;
      &lt;/weather&gt;
    &lt;/data&gt;
</code></pre>

<a name="LogicSheetAdvantages" /><h4>LogicSheet Advantages</h4>

<ul>

  <li>One taglib can generate XML that calls another taglib.  Taglib
  modules may call each other at the Perl level, but taglib modules are
  XSP compiler plugins and do not cascade: The XSP compiler lives in a
  pipeline environment but does not use a pipeline internally.</li>

  <li>No need to add an <code>AxAddXSPTaglib</code> directive and
  restart the Web server each time you write a tag lib.</li>

</ul>

<p>Restarting a Web server just because a taglib has changed can be
awkward in some environments, but this seems to be rare; restarting an
Apache server is usually quick enough in a development environment and
better not be necessary too often in a production environment.</p>

<p>In the Cocoon community, LogicSheets can be registered and shared somewhat
like the Perl community uses CPAN to share modules.  This is an additional
benefit when Cocooning, but does not carry much weight in the Perl world, which
already has CPAN (there are many taglib modules on CPAN).  There is no Java
equivalent to CPAN in wide use, so Cocoon logic sheets need their own
mechanism.</p>

<a name="LogicSheetDisadvantages" /><h4>LogicSheet Disadvantages</h4>

<p>There are two fundamental drwabacks with LogicSheets, each with
several symptoms.  Many of the symptoms are minor, but they add up:

<ol>

  <li>Requires inline code, usually in an XSLT stylesheet.

    <ul>

      <li>Putting Perl code in XML is awkward: You can't easily syntax check
      the code (I happen to like to run <code>perl -cw ThisFile.pm</code> a lot
      while writing Perl code) or take advantage of language-oriented editor
      features such as autoindenting, tags and syntax highlighting.</li>

      <li>The taglib author needs to work in four languages/APIs: XSLT
      (typically), XSP, Perl, and the taglib under development. XSLT and Perl
      are far from trivial, and though XSP is pretty simple, it's easy to trip
      yourself up when context switching between them.</li>

      <li>LogicSheets are far less flexible than taglib modules.  For
      instance, compare the rigidity of 
      <code>my_weather_taglib.xsl</code>'s output structure with the
      that of My::WeatherTaglib or
      My::SimpleWeatherTaglib.  The LogicSheet approach
      requires hardcoding the result values, while the two taglib
      modules simply convert whatever is in the weather report data
      structures to XML.</li>

      <li>XSLT requires a fair amount of extra boilerplate to copy
      non-taglib bits of XSP pages through.  This can usually be set up
      as boilerplate, but boilerplate in a program is just another thing
      to get in the way and require maintainance.</li>

      <li>LogicSheet are inherently single-purpose.  Taglib modules, on
      the other hand, can be used as regular Perl modules.  An
      authentication module can be used both as a taglib and as a
      regular module, for instance.</li>

      <li>LogicSheets need a working Web server for even the most basic
      functional testing since they need to be run in an XSP environment and
      AxKit does not yet support XSP outside a Web server.  Writing taglib
      modules allows simple test suites to be written to vet the taglib's code
      without needing a working Web server.</li>

      <li>Writing LogicSheets works best in an XML editor, otherwise
      you'll need to escape all your <code>&lt;</code> characters, at
      least, and reading / writing XML-escaped Perl and Java code
      can be irksome.</li>

      <li>Embracing and extending a LogicSheet is difficult to do:
      The source XSP page needs to be aware of the fact that the taglib
      it's using is using the base taglib and declare both of their
      namespaces.  With taglib modules, Perl's standard function
      import mechanism can be used to releive XSP authors of this
      duty.</li>

    </ul>
  </li>

  <li>Requires an additional stylesheet to process, usually XSLT.  This
  means:

    <ul>

      <li>A more complex processing chain, which leads to XSP page complexity
      (and thus more likelihood of bugs) because each page must declare both
      the namespace for the taglib tags <b>and</b> a processing instruction to
      run the taglib. As an example of a gotcha in this area, I used an
      outdated version of the XSP namespace URI in <code>weather2.xsp</code>
      and the current URI in <code>my_weather_taglib.xsl</code>.  This
      caused me a bit of confusion, but the <code>AxTraceIntermediate</code>
      directive helped shed some light on it.</li>

      <li>More disk files to check for changes each time an XSP page
      is served.  Since each LogicSheet affects the output, each
      LogicSheet must be <code>stat()</code>ed to see if it has changed
      since the last time the XSP page was compiled.</li>

    </ul>
  
  </li>

</ol>

<p>As you can probably tell, I feel that LogicSheets are a far more awkward and
less flexible approach than writing taglibs as Perl modules using one of the
helper libraries.  Still, using upstream LogicSheets is a valid and perhaps
occasionally useful technique for writing AxKit taglibs.</p>











<a name="UpstreamGoodFor" /><h3>Upstream Filters good for?</h3>

<p>So what is XSLT upstream of an XSP processor good for?  You can do many
things with it other than implementing LogicSheets.  One use is to implement
branding: altering things like logos, site name, and perhaps colors, or other
customization, like administrator's mail addresses on a login page that is
shared by several sub-sites.</p>

<p>A key advantage of doing transformations upstream of the XSP processor is
that the XSP process caches the results of upstream transformations.  XSP
converts whatever document it receives in to Perl bytecode in memory and then
just runs that bytecode if none of the upstream documents have changed.</p>

<p>Another use is to convert source documents that declare what should
be on a page to XSP documents that implement the machinery of a page.
For instance, a survey site might have the source documents declare what
questions to ask:</p>

<pre><code>    &lt;survey&gt;
      &lt;question&gt;
        &lt;text&gt;Have you ever eaten a Balut&lt;/text&gt;
        &lt;response&gt;Yes&lt;/response&gt;
        &lt;response&gt;No&lt;/response&gt;
        &lt;response&gt;Eeeewww&lt;/response&gt;
      &lt;/question&gt;
      &lt;question&gt;
        &lt;text&gt;Ok, then, well how about a nice haggis&lt;/text&gt;
        &lt;response&gt;Yes&lt;/response&gt;
        &lt;response&gt;No&lt;/response&gt;
        &lt;response&gt;Now that's more like it!&lt;/response&gt;
      &lt;/question&gt;
      ...
    &lt;/survey&gt;
</code></pre>

<p>XSLT can be used to transform the survey definition in to an XSP page that
uses the <a
href="http://search.cpan.org/doc/MSERGEANT/AxKit-XSP-PerForm-1.6/PerForm.pm">PerForm
taglib</a> to automate form filling, etc.  This approach allows pages to be
defined in terms of what they are instead of how they should work.</p>

<p>You can also use XSLT upstream of the XSP processor to do other things, like
translate from a limited or simpler domain-specific tagset to a more complex or
general purpose taglib written as a taglib module.  This can allow you to
define taglibs that are easier to use in terms of more powerful (but scary!)
taglibs that are loaded in to the XSP processor.</p>

<a name="My::SimpleWeatherTaglib" /><h3>My::SimpleWeatherTaglib</h3>

<p>A new-ish taglib helper module has been bundled in recent AxKit releases:
J&ouml;rg Walter's <a
href="http://search.cpan.org/doc/MSERGEANT/AxKit-1.51/lib/Apache/AxKit/Language/XSP/SimpleTaglib.pm">SimpleTaglib</a>
(the full module name is Apache::AxKit::Language::XSP::SimpleTaglib).  This
module performs roughly the same function as Steve Willer's <a
href="http://search.cpan.org/doc/MSERGEANT/AxKit-1.51/lib/Apache/AxKit/Language/XSP/TaglibHelper.pm">TaglibHelper</a>,
but supports namespaces and uses a feature new to Perl, subroutine attributes,
to specify the parameters and result formatting instead of a string.</p>

<p>Here is My::SimpleWeatherTaglib:

<pre><code>    package My::SimpleWeatherTaglib;

    use Apache::AxKit::Language::XSP::SimpleTaglib;

    $NS = "http://slaysys.com/axkit_articles/weather/";

    package My::SimpleWeatherTaglib::Handlers;

    use strict;
    require Geo::Weather;

    ## Return the whole report for fixup later in the processing pipeline
    sub report :  child(zip) struct({}) {
        return 'Geo::Weather-&gt;new-&gt;get_weather( $attr_zip );'
    }

    1;
</code></pre>

<p>The <code>$NS</code> variable defines the namespace for this taglib.  This
module uses the same namespace as <code>my_weather_taglib.xsl</code> and
My::WeatherTaglib, because all three implement the same taglib (this
repetetiveness is to demonstrate the differences between the approaches).  See
the <a href="#MixingAndMatching">Mixing and Matching Taglibs</a> section to see how My::WeatherTaglib and
My::SimpleWeatherTaglib can both be used in the same server instance.</p>

<p>My::SimpleWeatherTaglib then shifts gears in to a new <code>package</code>,
My::SimpleWeatherTaglib::Handlers to define the subroutines for the taglib
tags.  Using a virgin package like this provides a clean place with which to declare
the tag handlers.  SimpleTaglib looks for the modules in the Foo::Handlers
package if it's <code>use()</code>d in the Foo package (don't use
<code>require</code> for this!).

<p>My::SimpleWeatherTaglib <code>require</code>s Geo::Weather and declares a
single tag, which handles the <code>&lt;weather:report&gt;</code> tag in
<code>weather1.xsp</code> (which we'll show in a moment).</p>

<p>The <code>require Geo::Weather;</code> instead of <code>use
Geo::Weather;</code> is to avoid importing subroutines in to our otherwise
<code>...::Handlers</code> namespace which might look like a handler.</p>

<p>There's something new afoot in the declaration for <code>sub report</code>:
subroutine attributes.  Subroutine attributes are a new feature of Perl (as of
perl5.6) that allow us to hang additional little bits of information on the
subroutine declaration that describe it a bit more.  <a
href="http://search.cpan.org/doc/JHI/perl-5.7.3/pod/perlsub.pod"><code>perldoc
perlsub</code></a> for the details of this syntax.  Some attributes are
predefined by Perl, but modules may define others for their own purposes. In
this case, the SimpleTaglib module defines a handful of attributes, some of
which describe what parameters the taglib tag can take and others which
describe how to convert the result value from the taglib implementation into
XML output.<p>

<p>The <code>child(zip)</code> subroutine attribute tells the SimpleTaglib
module that this handler expects a single child element named <code>zip</code>
in the taglib's namespace.  In <code>weather1.xsp</code>, this ends up looking
like:</p>

<pre><code>
    &lt;weather:report&gt;
      &lt;!-- Get the ?zip=12345 from the URI and pass it
           to the weather:report tag as a parameter --&gt;
      <b>&lt;weather:zip&gt;&lt;param:zip/&gt;&lt;/weather:zip&gt;</b>
    &lt;/weather:report&gt;
</code></pre>

<p>The text from the <code>&lt;weather:zip&gt;</code> element (which will be
filled in from the URI query string using the <code>param:</code> taglib) will
be made available in a variable named <code>$attr_zip</code> at request time.
The fact that the text from an element shows up in a variable beginning with
<code>$attr_</code> is confusing, but it does actually work that way.</p>

<p>The <code>struct({})</code> attribute specifies that the result of this tag
will be returned as a Perl data structure that will be converted into XML.
<code>Geo::Weather-&gt;new-&gt;get_weather( $zip )</code> returns a HASH reference that looks like:</p>

<a name="hash_2" /><pre><code>    {
      'city'  =&gt; 'Pittsburgh',
      'state' =&gt; 'PA',
      'cond'  =&gt; 'Sunny',
      'temp'  =&gt; '77',
      ...
    };
</code></pre>

<p>The <code>struct</code> attribute tells SimpleTaglib to turn this in to XML
like:</p>

<pre><code>
    &lt;city&gt;Pittsburgh&lt;/city&gt;
    &lt;state&gt;PA&lt;/state&gt;
    &lt;cond&gt;Sunny&lt;/cond&gt;
    &lt;temp&gt;77&lt;/temp&gt;
    ....
</code></pre>

<p>The <code>{}</code> in the <code>struct({})</code> attribute specifies that
the result nodes should be not be in a namespace (and thus have no namespace
prefix), just like the static portions of our <code>weather1.xsp</code>
document.  This is one of the advantages that SimpleTaglib has over other
methods: It's easier to emit nodes in different namespaces.  To emit nodes in a
specific namespace, put the namespace URI for that namespace inside the
curlies: <code>struct({http://my.namespace.com/foo/bar})</code>.  The
<code>{}</code> notation is referred to as <a
href="http://www.jclark.com/xml/xmlns.htm">James Clark (or jclark)
notation</a>.<p>

<p>Now, the tricky bit.  Harkening back to our <a
href="/pub/a/2002/07/axkit.html?page=1#UnderTheXSPHood">discussion of how XSP is implemented</a>, remember that
the XSP processor compiles the XSP document into Perl code that is executed
to build the output document.  As XSP compiles the page, it keeps a lookout
for tags in namespaces handled by taglib modules that have been configured in
with <code>AxAddXSPTaglib</code>.  When XSP sees one of these tags, it calls in
to the taglib module--My::SimpleWeatherTaglib here--for that namespace and
requests a chunk of Perl source code to compile in place of the tag.</p>

<p>Taglibs implemented with the SimpleTaglib module covered here declare
handlers for each taglib tag (<code>sub report</code>, for instance).  That
handler subroutine is called at parse time, not at request time.  Its job is to
return the chunk of code that will be compiled and then run
later, at request time, to generate the output.  So <code>report()</code>
returns a string containing a snippet of Perl code that calls
into Geo::Weather.  This Perl code will be compiled once, then
run for each request.</p>

<p>This is a key difference between the TaglibHelper module that
My::WeatherTaglib used in the previous article and the SimpleTaglib module used
here.  SimpleTaglib calls My::SimpleWeatherTaglib's <code>report()</code>
subroutine at compile time whereas TaglibHelper quietly, automatically arranges
to call My::WeatherTaglib's <code>report()</code> subroutine at request time.<p>

<p>This difference makes SimpleTaglib not so simple unless you are used to
writing code that generates code that will be compiled and run later.  On the
other hand, "Programs that write programs are the happiest programs in the
world" (Andrew Hume, according to a few places on the net).  This is true here
because we are able to return whatever code is appropriate for the task at
hand.  In this case, the code is so simple that we can return it directly.  If
the work to be done was more complicated, then we could also return a call to a
subroutine of our own devising.  So, while a good deal less simple than the
approach taken by TaglibHelper, this approach does offer a bit more
flexibility.</p>

<p>SimpleTaglib's author does promise that a new version of SimpleTaglib will
offer the "call this subroutine at request time" API which I (and I suspect
most others) would prefer most of the time.</p>

<p>I will warn you that the documentation for SimpleTaglib does not stand on
its own, so you need to have the source code for an example module or two to put
it all together.  Beyond the overly simple example presented here, the
documentation refers you to a couple of others.  Mind you, I'm casting stones
while in my glass house here, because nobody has ever accused me of fully
documenting my own modules.</p>

<p>For reference, here is the <code>weather1.xsp</code> from the previous
article, which we are reusing verbatim for this example:

<pre><code>    &lt;?xml-stylesheet href="NULL"        type="application/x-xsp"?&gt;
    &lt;?xml-stylesheet href="weather.xsl" type="text/xsl"?&gt;
    &lt;?xml-stylesheet href="as_html.xsl" type="text/xsl"?&gt;

    &lt;xsp:page
        xmlns:xsp="http://www.apache.org/1999/XSP/Core"
        xmlns:util="http://apache.org/xsp/util/v1"
        xmlns:param="http://axkit.org/NS/xsp/param/v1"
        <b>xmlns:weather="http://slaysys.com/axkit_articles/weather/"</b>
    &gt;
    &lt;data&gt;
      &lt;title&gt;&lt;a name="title"/&gt;My Weather Report&lt;/title&gt;
      &lt;time&gt;
        &lt;util:time format="%H:%M:%S" /&gt;
      &lt;/time&gt;
      &lt;weather&gt;
        <b>&lt;weather:report&gt;
          &lt;!-- Get the ?zip=12345 from the URI and pass it
               to the weather:report tag as a parameter --&gt;
          &lt;weather:zip&gt;&lt;param:zip/&gt;&lt;/weather:zip&gt;
        &lt;/weather:report&gt;</b>
      &lt;/weather&gt;
    &lt;/data&gt;
    &lt;/xsp:page&gt;
</code></pre>

<p>The processing pipeline and intermediate files are also identical to those
from the <a
href="/pub/a/2002/04/16/axkit.html">previous article</a>, so we won't repeat them here.

<a name="MixingAndMatching" /><h3>Mixing and Matching Taglibs using
<code>httpd.conf</code></h3>

<p>As detailed in <a href="/pub/a/2002/03/12/axkit.html">the first article</a> in this series, AxKit
integrates tightly with Apache and Apache's configuration engine.
Apache allows different files and directories to have different
configurations applied, including what taglibs are used.  In the real
world, for instance, it is sometimes necessary to have part of a site
to use a new version of a taglib that might break an old portion.</p>

<p>In the server I used to build the examples for this article, for instance,
the <code>02/</code> directory still uses My::WeatherTaglib from the last
article, while the <code>03/</code> directory uses the
<code>my_weather_taglib.xsl</code> for one of this article's examples and
My::SimpleWeatherTaglib for the other. This is done by combining Apache's
<code>&lt;Directory&gt;</code> sections with the <code>AxAddXSPTaglib</code>
directive:</p>

<a name="httpd.conf" /><pre><code>    ##
    ## Init the httpd to use our "private install" libraries
    ##
    PerlRequire startup.pl

    ##
    ## AxKit Configuration
    ##
    PerlModule AxKit

    &lt;Directory "/home/me/htdocs"&gt;
        Options -All +Indexes +FollowSymLinks

        # Tell mod_dir to translate / to /index.xml or /index.xsp
        DirectoryIndex index.xml index.xsp
        AddHandler axkit .xml .xsp

        AxDebugLevel 10

        AxTraceIntermediate /home/me/axtrace

        AxGzipOutput Off

        AxAddXSPTaglib AxKit::XSP::Util
        AxAddXSPTaglib AxKit::XSP::Param

        AxAddStyleMap application/x-xsp \\
                      Apache::AxKit::Language::XSP

        AxAddStyleMap text/xsl \\
                      Apache::AxKit::Language::LibXSLT
    &lt;/Directory&gt;

    &lt;Directory "/home/me/htdocs/02"&gt;
    <b>    AxAddXSPTaglib My::WeatherTaglib</b>
    &lt;/Directory&gt;

    &lt;Directory "/home/me/htdocs/03"&gt;
    <b>    AxAddXSPTaglib My::SimpleWeatherTaglib</b>
    &lt;/Directory&gt;
</code></pre>

<p>See <a href="http://httpd.apache.org/docs/sections.html" alt="Apache
httpd documentation">How
Directory, Location and Files sections work</a> from the apache
httpd documentation (v1.3 or 2.0) for the details of how to use
<a href="http://httpd.apache.org/docs/mod/core.html#directory"
alt="Apache documentation"><code>&lt;Directory&gt;</code></a> and other
httpd.conf sections to do this sort of thing.</p>

<a name="help" /><h3>Help and thanks</h3>

<p>J&ouml;rg Walter as well as Matt Sergeant were of great help in writing this
article, especially since I don't do LogicSheets.  J&ouml;rg also fixed a bug
in absolutely no time and wrote the SimpleTaglib module and the <code>AxTraceIntermediate</code> feature.</p>

<p>In case of trouble, have a look at some of the <a
href="/pub/a/2002/03/12/axkit.html?page=3#help">helpful resources we
listed in the first article</a>.</p>

<p>Copyright 2002, Robert Barrie Slaymaker, Jr.  All Rights Reserved.


        </div>



    </div>
    <div class="asset-footer"></div>
</div>




                            <div class="content-nav">
                                <a href="/pub/2002/06/">&laquo; June 2002</a> |
                                <a href="/pub/">Main Index</a> |
                                <a href="/pub/archives.html">Archives</a>
                                | <a href="/pub/2002/08/">August 2002 &raquo;</a>
                            </div>


                        </div>
                    </div>


                    <div id="beta">
    <div id="beta-inner">


    
    <div class="widget-what-is-perl widget">
    <div class="widget-content widget-content-what-is-perl">
       Visit the home of the  Perl programming language: <a href="http://www.perl.org/">Perl.org</a
    </div>
</div>
<div class="widget-find-out-more widget-archives widget">
    <div class="widget-content">
        <ul>
            <li><a href="http://www.perl.org/get.html">Download</a></li>
            <li><a href="http://perldoc.perl.org/">Documentation</a></li>
            <li><a href="http://blogs.perl.org/">Perl Bloggers</a></li>
            <li><a href="http://news.perlfoundation.org/">Foundation News</a></li>
        </ul>
    </div>
</div><div class="widget-tcpc widget">
<h3 class="widget-header">Sponsored by</h3>
    <div class="widget-content">
        <a href="http://training.perl.com/" alt="Perl Training" target="_blank"><img src="/i/tcpc.png" width="150" height="50"></a>
    </div>
</div>

<div class="widget-syndication widget">
    <div class="widget-content">
        <ul>
            <li><img src="/mt-static/images/status_icons/feed.gif" alt="Subscribe to feed" width="9" height="9" /> <a href="/pub/atom.xml">Subscribe to this website's feed</a></li>

        </ul>
    </div>
</div>
<div class="widget-archive-monthly widget-archive widget">
    <h3 class="widget-header">Monthly <a href="/pub/archives.html">Archives</a></h3>
    <div class="widget-content">
        <ul>
        
            <li><a href="/pub/2014/02/">February 2014 (1)</a></li>
        
    
        
            <li><a href="/pub/2014/01/">January 2014 (1)</a></li>
        
    
        
            <li><a href="/pub/2013/10/">October 2013 (1)</a></li>
        
    
        
            <li><a href="/pub/2013/01/">January 2013 (1)</a></li>
        
    
        
            <li><a href="/pub/2012/12/">December 2012 (1)</a></li>
        
    
        
            <li><a href="/pub/2012/11/">November 2012 (1)</a></li>
        
    
        
            <li><a href="/pub/2012/10/">October 2012 (2)</a></li>
        
    
        
            <li><a href="/pub/2012/08/">August 2012 (2)</a></li>
        
    
        
            <li><a href="/pub/2012/06/">June 2012 (11)</a></li>
        
    
        
            <li><a href="/pub/2012/05/">May 2012 (18)</a></li>
        
    
        
            <li><a href="/pub/2012/04/">April 2012 (17)</a></li>
        
    
        
            <li><a href="/pub/2012/02/">February 2012 (1)</a></li>
        
    
        
            <li><a href="/pub/2011/12/">December 2011 (1)</a></li>
        
    
        
            <li><a href="/pub/2011/09/">September 2011 (1)</a></li>
        
    
        
            <li><a href="/pub/2011/08/">August 2011 (2)</a></li>
        
    
        
            <li><a href="/pub/2011/06/">June 2011 (1)</a></li>
        
    
        
            <li><a href="/pub/2011/05/">May 2011 (3)</a></li>
        
    
        
            <li><a href="/pub/2011/04/">April 2011 (1)</a></li>
        
    
        
            <li><a href="/pub/2011/03/">March 2011 (1)</a></li>
        
    
        
            <li><a href="/pub/2011/02/">February 2011 (1)</a></li>
        
    
        
            <li><a href="/pub/2011/01/">January 2011 (1)</a></li>
        
    
        
            <li><a href="/pub/2010/11/">November 2010 (1)</a></li>
        
    
        
            <li><a href="/pub/2010/10/">October 2010 (2)</a></li>
        
    
        
            <li><a href="/pub/2010/09/">September 2010 (1)</a></li>
        
    
        
            <li><a href="/pub/2010/08/">August 2010 (3)</a></li>
        
    
        
            <li><a href="/pub/2010/07/">July 2010 (2)</a></li>
        
    
        
            <li><a href="/pub/2010/04/">April 2010 (2)</a></li>
        
    
        
            <li><a href="/pub/2010/03/">March 2010 (4)</a></li>
        
    
        
            <li><a href="/pub/2008/05/">May 2008 (1)</a></li>
        
    
        
            <li><a href="/pub/2008/04/">April 2008 (2)</a></li>
        
    
        
            <li><a href="/pub/2008/03/">March 2008 (1)</a></li>
        
    
        
            <li><a href="/pub/2008/02/">February 2008 (1)</a></li>
        
    
        
            <li><a href="/pub/2008/01/">January 2008 (1)</a></li>
        
    
        
            <li><a href="/pub/2007/12/">December 2007 (2)</a></li>
        
    
        
            <li><a href="/pub/2007/09/">September 2007 (1)</a></li>
        
    
        
            <li><a href="/pub/2007/08/">August 2007 (1)</a></li>
        
    
        
            <li><a href="/pub/2007/07/">July 2007 (1)</a></li>
        
    
        
            <li><a href="/pub/2007/06/">June 2007 (1)</a></li>
        
    
        
            <li><a href="/pub/2007/05/">May 2007 (1)</a></li>
        
    
        
            <li><a href="/pub/2007/04/">April 2007 (1)</a></li>
        
    
        
            <li><a href="/pub/2007/03/">March 2007 (1)</a></li>
        
    
        
            <li><a href="/pub/2007/02/">February 2007 (1)</a></li>
        
    
        
            <li><a href="/pub/2007/01/">January 2007 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/12/">December 2006 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/11/">November 2006 (2)</a></li>
        
    
        
            <li><a href="/pub/2006/10/">October 2006 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/09/">September 2006 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/08/">August 2006 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/07/">July 2006 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/06/">June 2006 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/05/">May 2006 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/04/">April 2006 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/03/">March 2006 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/02/">February 2006 (4)</a></li>
        
    
        
            <li><a href="/pub/2006/01/">January 2006 (4)</a></li>
        
    
        
            <li><a href="/pub/2005/12/">December 2005 (4)</a></li>
        
    
        
            <li><a href="/pub/2005/11/">November 2005 (3)</a></li>
        
    
        
            <li><a href="/pub/2005/10/">October 2005 (2)</a></li>
        
    
        
            <li><a href="/pub/2005/09/">September 2005 (2)</a></li>
        
    
        
            <li><a href="/pub/2005/08/">August 2005 (9)</a></li>
        
    
        
            <li><a href="/pub/2005/07/">July 2005 (8)</a></li>
        
    
        
            <li><a href="/pub/2005/06/">June 2005 (9)</a></li>
        
    
        
            <li><a href="/pub/2005/05/">May 2005 (8)</a></li>
        
    
        
            <li><a href="/pub/2005/04/">April 2005 (7)</a></li>
        
    
        
            <li><a href="/pub/2005/03/">March 2005 (6)</a></li>
        
    
        
            <li><a href="/pub/2005/02/">February 2005 (7)</a></li>
        
    
        
            <li><a href="/pub/2005/01/">January 2005 (6)</a></li>
        
    
        
            <li><a href="/pub/2004/12/">December 2004 (8)</a></li>
        
    
        
            <li><a href="/pub/2004/11/">November 2004 (8)</a></li>
        
    
        
            <li><a href="/pub/2004/10/">October 2004 (5)</a></li>
        
    
        
            <li><a href="/pub/2004/09/">September 2004 (9)</a></li>
        
    
        
            <li><a href="/pub/2004/08/">August 2004 (6)</a></li>
        
    
        
            <li><a href="/pub/2004/07/">July 2004 (8)</a></li>
        
    
        
            <li><a href="/pub/2004/06/">June 2004 (6)</a></li>
        
    
        
            <li><a href="/pub/2004/05/">May 2004 (7)</a></li>
        
    
        
            <li><a href="/pub/2004/04/">April 2004 (8)</a></li>
        
    
        
            <li><a href="/pub/2004/03/">March 2004 (8)</a></li>
        
    
        
            <li><a href="/pub/2004/02/">February 2004 (9)</a></li>
        
    
        
            <li><a href="/pub/2004/01/">January 2004 (7)</a></li>
        
    
        
            <li><a href="/pub/2003/12/">December 2003 (4)</a></li>
        
    
        
            <li><a href="/pub/2003/11/">November 2003 (7)</a></li>
        
    
        
            <li><a href="/pub/2003/10/">October 2003 (8)</a></li>
        
    
        
            <li><a href="/pub/2003/09/">September 2003 (6)</a></li>
        
    
        
            <li><a href="/pub/2003/08/">August 2003 (7)</a></li>
        
    
        
            <li><a href="/pub/2003/07/">July 2003 (9)</a></li>
        
    
        
            <li><a href="/pub/2003/06/">June 2003 (9)</a></li>
        
    
        
            <li><a href="/pub/2003/05/">May 2003 (8)</a></li>
        
    
        
            <li><a href="/pub/2003/04/">April 2003 (8)</a></li>
        
    
        
            <li><a href="/pub/2003/03/">March 2003 (10)</a></li>
        
    
        
            <li><a href="/pub/2003/02/">February 2003 (8)</a></li>
        
    
        
            <li><a href="/pub/2003/01/">January 2003 (8)</a></li>
        
    
        
            <li><a href="/pub/2002/12/">December 2002 (5)</a></li>
        
    
        
            <li><a href="/pub/2002/11/">November 2002 (9)</a></li>
        
    
        
            <li><a href="/pub/2002/10/">October 2002 (7)</a></li>
        
    
        
            <li><a href="/pub/2002/09/">September 2002 (11)</a></li>
        
    
        
            <li><a href="/pub/2002/08/">August 2002 (8)</a></li>
        
    
        
            <li><a href="/pub/2002/07/">July 2002 (8)</a></li>
        
    
        
            <li><a href="/pub/2002/06/">June 2002 (4)</a></li>
        
    
        
            <li><a href="/pub/2002/05/">May 2002 (6)</a></li>
        
    
        
            <li><a href="/pub/2002/04/">April 2002 (6)</a></li>
        
    
        
            <li><a href="/pub/2002/03/">March 2002 (7)</a></li>
        
    
        
            <li><a href="/pub/2002/02/">February 2002 (5)</a></li>
        
    
        
            <li><a href="/pub/2002/01/">January 2002 (8)</a></li>
        
    
        
            <li><a href="/pub/2001/12/">December 2001 (7)</a></li>
        
    
        
            <li><a href="/pub/2001/11/">November 2001 (5)</a></li>
        
    
        
            <li><a href="/pub/2001/10/">October 2001 (9)</a></li>
        
    
        
            <li><a href="/pub/2001/09/">September 2001 (7)</a></li>
        
    
        
            <li><a href="/pub/2001/08/">August 2001 (13)</a></li>
        
    
        
            <li><a href="/pub/2001/07/">July 2001 (8)</a></li>
        
    
        
            <li><a href="/pub/2001/06/">June 2001 (13)</a></li>
        
    
        
            <li><a href="/pub/2001/05/">May 2001 (11)</a></li>
        
    
        
            <li><a href="/pub/2001/04/">April 2001 (9)</a></li>
        
    
        
            <li><a href="/pub/2001/03/">March 2001 (8)</a></li>
        
    
        
            <li><a href="/pub/2001/02/">February 2001 (8)</a></li>
        
    
        
            <li><a href="/pub/2001/01/">January 2001 (8)</a></li>
        
    
        
            <li><a href="/pub/2000/12/">December 2000 (6)</a></li>
        
    
        
            <li><a href="/pub/2000/11/">November 2000 (10)</a></li>
        
    
        
            <li><a href="/pub/2000/10/">October 2000 (10)</a></li>
        
    
        
            <li><a href="/pub/2000/09/">September 2000 (2)</a></li>
        
    
        
            <li><a href="/pub/2000/08/">August 2000 (2)</a></li>
        
    
        
            <li><a href="/pub/2000/07/">July 2000 (5)</a></li>
        
    
        
            <li><a href="/pub/2000/06/">June 2000 (7)</a></li>
        
    
        
            <li><a href="/pub/2000/05/">May 2000 (7)</a></li>
        
    
        
            <li><a href="/pub/2000/04/">April 2000 (3)</a></li>
        
    
        
            <li><a href="/pub/2000/03/">March 2000 (2)</a></li>
        
    
        
            <li><a href="/pub/2000/02/">February 2000 (2)</a></li>
        
    
        
            <li><a href="/pub/2000/01/">January 2000 (2)</a></li>
        
    
        
            <li><a href="/pub/1999/12/">December 1999 (6)</a></li>
        
    
        
            <li><a href="/pub/1999/11/">November 1999 (6)</a></li>
        
    
        
            <li><a href="/pub/1999/10/">October 1999 (5)</a></li>
        
    
        
            <li><a href="/pub/1999/09/">September 1999 (4)</a></li>
        
    
        
            <li><a href="/pub/1999/08/">August 1999 (3)</a></li>
        
    
        
            <li><a href="/pub/1999/07/">July 1999 (2)</a></li>
        
    
        
            <li><a href="/pub/1999/06/">June 1999 (3)</a></li>
        
    
        
            <li><a href="/pub/1999/04/">April 1999 (1)</a></li>
        
    
        
            <li><a href="/pub/1999/03/">March 1999 (1)</a></li>
        
    
        
            <li><a href="/pub/1999/01/">January 1999 (1)</a></li>
        
    
        
            <li><a href="/pub/1998/12/">December 1998 (1)</a></li>
        
    
        
            <li><a href="/pub/1998/11/">November 1998 (1)</a></li>
        
    
        
            <li><a href="/pub/1998/07/">July 1998 (2)</a></li>
        
    
        
            <li><a href="/pub/1998/06/">June 1998 (1)</a></li>
        
    
        
            <li><a href="/pub/1998/03/">March 1998 (1)</a></li>
        
        </ul>
    </div>
</div>
        
    

<div class="widget-powered widget">
    <div class="widget-content">
        <a href="http://www.movabletype.com/"><img src="/mt-static/images/bug-pbmt-white.png" alt="Powered by Movable Type 5.13-en" width="120" height="75" /></a>
    </div>
</div>



    </div>
</div>






                </div>
            </div>


            <div id="footer">
    <div id="footer-inner">
        <div id="footer-content">
            <div class="widget-powered widget">
                <div class="widget-content">
                    Powered by <a href="http://www.movabletype.com/" rel="generator">Movable Type Pro</a>
                </div>
            </div>

            <div class="widget-creative-commons widget">
                <div class="widget-content">
                    This blog is licensed under a <a href="http://creativecommons.org/licenses/by-nc-nd/3.0/">Creative Commons License</a>.
                </div>
            </div>

        </div>
    </div>
</div>



        </div>
    </div>
</body>
</html>
