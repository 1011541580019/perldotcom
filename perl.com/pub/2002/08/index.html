<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" id="sixapart-standard">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="generator" content="Movable Type Pro 5.13-en" />
<link rel="stylesheet" href="/pub/styles.css" type="text/css" />
<link rel="start" href="/pub/" title="Home" />
<link rel="alternate" type="application/atom+xml" title="Recent Entries" href="/pub/atom.xml" />
<script type="text/javascript" src="/pub/mt.js"></script>
<!--
<rdf:RDF xmlns="http://web.resource.org/cc/"
         xmlns:dc="http://purl.org/dc/elements/1.1/"
         xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#">
<Work rdf:about="/pub/">
<dc:title>Perl.com</dc:title>
<dc:description>news and views of the Perl programming language</dc:description>
<license rdf:resource="http://creativecommons.org/licenses/by-nc-nd/3.0/" />
</Work>
<License rdf:about="http://creativecommons.org/licenses/by-nc-nd/3.0/">
</License>
</rdf:RDF>
-->

<script type="text/javascript">

 var _gaq = _gaq || [];
 _gaq.push(['_setAccount', 'UA-50555-22']);
 _gaq.push(['_trackPageview']);

 (function() {
   var ga = document.createElement('script'); ga.type =
   'text/javascript'; ga.async = true;
   ga.src = ('https:' == document.location.protocol ? 'https://ssl' :
   'http://www') + '.google-analytics.com/ga.js';
   var s = document.getElementsByTagName('script')[0];
   s.parentNode.insertBefore(ga, s);
 })();

</script>
<script type='text/javascript' src='http://partner.googleadservices.com/gampad/google_service.js'></script>
<script type='text/javascript'>
GS_googleAddAdSenseService("ca-pub-4136420132070439");
GS_googleEnableAllServices();
</script>
<script type='text/javascript'>
GA_googleAddSlot("ca-pub-4136420132070439", "Perl_728x90");
</script>
<script type='text/javascript'>GA_googleFetchAds();</script>
    <title>Perl.com: August 2002 Archives</title>


    <link rel="prev" href="/pub/2002/07/" title="July 2002" />
    <link rel="next" href="/pub/2002/09/" title="September 2002" />

</head>
<body id="perl-com" class="mt-archive-listing mt-datebased-monthly-archive layout-wt">
    <div id="container">
        <div id="container-inner">


            <div id="header">
    <div id="header-inner">
        <div id="header-content">
        <span id="top_advert"> 
<!-- Put any landscape advert in here -->
<!-- Perl_728x90 -->
<script type='text/javascript'>
GA_googleFillSlot("Perl_728x90");
</script>
        </span> 



            <div id="header-name"><a href="/pub/" accesskey="1">Perl.com</a></div>
            <div id="header-description">news and views of the Perl programming language</div>




        </div>
    </div>
</div>



            <div id="content">
                <div id="content-inner">


                    <div id="alpha">
                        <div id="alpha-inner">


                            <h1 id="page-title" class="archive-title">August 2002 Archives</h1>





                            
                            <div id="entry-1346" class="entry-asset asset hentry">
    <div class="asset-header">
        <h2 class="asset-name entry-title"><a href="/pub/2002/08/27/filtering.html" rel="bookmark">Mail Filtering</a></h2>
        <div class="asset-meta">
            <span class="byline">
    
                By <span class="vcard author">Michael Stevens</span> on <abbr class="published" title="2002-08-27T00:00:00-08:00">August 27, 2002 12:00 AM</abbr>
    
            </span>

            
            

        </div>
    </div>
    <div class="asset-content entry-content">

        <div class="asset-body">
            
<p>There are many ways to filter your e-mail with Perl. Two of the
more popular and interesting ways are to use <code>PerlMx</code> or <code>Mail::Audit</code>.
I took a long look at both, and this is what I thought of them.</p>

<h3><a name="perlmx"><code>PerlMx</code></a></h3>

<p><code>PerlMx</code> is a server product from ActiveState that uses the milter
support in recent versions of sendmail to hook in at almost every
stage of the mail-handling process.</p>

<p><code>PerlMx</code> comes with its own copy of Perl, and all the supporting modules
it needs - it can't run from a normal Perl, as it needs Perl to be
built with various options such as ithreads support and multiplicity.
This means you need to install any modules you want to use with <code>PerlMx</code>
twice if you already have them installed somewhere else on your system.</p>

<p><code>PerlMx</code> provides a persistent daemon that processes e-mail for an
entire mail-server - it avoids the overhead of starting a Perl
process to handle each e-mail by running forever, and by using threads
to ensure it can service more than one e-mail at a time.</p>



<p><code>PerlMx</code> ships with two main filters - the Spam and Virus filters. The
Virus filtering looks interesting, but ultimately I don't receive that
many viruses in e-mail, so I was unable to test it beyond establishing
that it didn't mangle my e-mail.</p>

<p> The Spam filtering in PerlMX is much more interesting - it seems to
be based on <a href="http://www.spamassassin.org/">Mail::SpamAssassin</a>, a popular
spam filtering module often used with Mail::Audit, procmail, or other
ways of processing e-mail.</p><p>In two weeks of testing with <code>PerlMx</code>, using it to process a copy of
all my personal e-mail, I found a lot useful functionality, and a
few minor problems.</p>

<p>The first hassles were setup - I don't normally use sendmail, but 
<code>PerlMx</code> requires it for the milter API, so I installed sendmail, set
it up, and hooked it into <code>PerlMx</code>.</p>
<p>Once you have sendmail setup, and built with milter support (as
the default build from Debian Linux I used was), it's easy to add
a connection to <code>PerlMx</code> with one line in your sendmail.mc file:</p>

<pre><code>
INPUT_MAIL_FILTER(`C&lt;PerlMx&gt;', `S=inet:3366@localhost, F=T, 
     T=S:3m;R:3m;E:8m'')</code></pre>

<p><code>PerlMx</code> essentially works out of the box - it asks a number of simple
questions when you install and set it up, and assuming you get these
right, no further configuration will be required.</p>

<p>The <code>INPUT_MAIL_FILTER</code> line also sets several key options, including
the timeouts for communication between sendmail and <code>PerlMx</code> - I had to
raise these significantly to deal with a problem I found where 
<code>PerlMx</code> was taking too much time to process spam (it appear to be doing
DNS lookups), sendmail was timing out the connection to <code>PerlMx</code>, and
refusing to accept mail.</p>

<p>In <code>PerlMx</code> 2.1, it even ships with its own sendmail install, pre-configured
for use with <code>PerlMx</code>, but you can choose to ignore this and use an
existing system sendmail.</p>

<p>Once you've done this, suddenly all the mail that goes through your
mail-server is spam filtered, and virus checked. Mail that looks
likely to be spam, or that contains a virus is stopped and held in a
quarantine queue, the rest are sent to the user, possibly with a spam
header added to indicate a score representing how likely to be spam
they are. The quarantine queue is a systemwide collection of messages
which, for one reason or another, weren't appropriate to deliver
to the user - this will be normally as they are either suspected to
contain viruses or spam.</p>

<p>If the filters supplied with <code>PerlMx</code> aren't to your tastes, then it comes
supplied with an extension API, and extensive documentation and samples
to allow you to write your own.</p>

<p>While testing <code>PerlMx</code>, I never managed to bounce or accidentally lose
my e-mail - I made many configuration errors, which meant mail wasn't
processed and a lot of stuff was somewhat over-enthusiastically marked
as spam when it was actually valid. But as far as I can tell, nothing
bounced or disappeared into the system - this is pretty impressive,
as when configuring most new bits of e-mail I usually manage to delete
everything I send to it in the first few attempts, or, worse, make
myself look stupid by sending errors back to random people unfortunate
enough to be on the same mailing list as me.</p>

<h3><a name="mail::audit"><code>Mail::Audit</code></a></h3>

<p><code>Mail::Audit</code> is very different from <code>PerlMx</code>. For starters, once you've 
installed it, by default it doesn't do anything.  <code>Mail::Audit</code> is
just a Perl module - it's a powerful tool for implementing mail
filters, but mostly you have to write them yourself. <code>PerlMx</code> ships
with spam filtering and virus checking configured by default, 
<code>Mail::Audit</code> provides duplicate killing, a mailing list processing
module (based on Mail::ListDetector), and a few simple spam
filtering options based on Realtime Blackhole Lists or Vipul's Razor.</p>

<p><code>Mail::Audit</code> is not designed to be used with an entire mail-server
in the same way as <code>PerlMx</code>. Instead, it allows you to easily write
little e-mail filter programs that can be triggered from the <em>.forward</em>
file of a particular user. <code>Mail::Audit</code> can be easily configured and
used on a per-user basis, whereas <code>PerlMx</code> takes over an entire mail-server
and is an all-or-nothing choice.</p>

<p>The default <code>Mail::Audit</code> configuration starts one Perl process for each
mail handled - normally this won't be a problem, but if you're
processing large volumes of mail, or have a system which is already at
or near capacity, it may be enough to tip the balance and cause
performance problems (Translation: Long ago I installed <code>Mail::Audit</code> on
an old, spare machine I was using as a mail-server, received 200 e-mails
in less than a minute, and spent quite a while waiting for the system to
stop gazing at its navel and start responding to the outside world
again). If your mail comes to you via POP3, or can be made to do so
(possibly by installing a POP3 daemon if you do not have one already),
then a simple script supplied with <code>Mail::Audit</code> called <em>popread</em> provides
a base you can use to feed articles from a POP3 server into
<code>Mail::Audit</code> in a single Perl process, improving performance. I didn't
do this myself, as I wanted to use what appeared to be the
'recommended' approach to <code>Mail::Audit</code> setup - the one that is, if not
actively promoted in the documentation, most strongly suggested by it,
of running a <code>Mail::Audit</code> script from a user's .forward file.</p>

<p>A popular <code>Mail::Audit</code> addition is SpamAssassin (the
same codebase as <code>PerlMx</code>'s mail processing is loosely based on) - this
comes as a <code>Mail::Audit</code> plugin, among other forms.</p>

<p><code>Mail::Audit</code> makes it easy to write mail filters that work on a
per-user basis, whereas <code>PerlMx</code> by default applies to all mail
processed on a given mailserver.</p>

<p>
If you wanted to install <code>Mail::Audit</code> systemwide, then many mail-servers
(such as exim) provide a way to configure a custom local delivery agent
on flexible criteria. For example,
<a href="http://bogmog.sourceforge.net/document_show.php3?doc_id=28">this
article</a> provides
some documentation on how to do this with exim.</p>
















<h3><a name="testing... 1... 2... 3...">Testing ... 1 ... 2 ... 3 ...</a></h3>

<p>I decided to do an extended comparison of both <code>PerlMx</code> and
<code>Mail::Audit</code>. As one of the most common applications of mail filtering
tools is for spam filtering, I set up recent versions of both the tools
on my personal e-mail, by various nefarious means, ran them for
a week, and compared the results on two main criteria:</p>

<ul>
<li>
False positives (legitimate email recognized as spam)</li>

<li>
False negatives (spam not recognized as spam)</li>

</ul>
<p><code>Mail::Audit</code> doesn't come with much spam filtering technology by
default, so I decided to add SpamAssassin (http://www.spamassassin.org/)
to the testing, as it can be used as a <code>Mail::Audit</code> extension.</p>
<p>I used procmail to copy all my incoming e-mail to two pop3 mailboxes
setup for the purposes of testing - one would contain mail to be
processed by <code>Mail::Audit</code>, the other mail to be processed by
<code>PerlMx</code>'s spam filtering. fetchmail was used to pull the mail down
into the domain of <code>Mail::Audit</code> and <code>PerlMx</code>.</p>
<p>Once I had <code>Mail::Audit</code> and SpamAssassin setup, I started feeding mail
into the test box with fetchmail, and was reminded that as the <code>Mail::Audit</code>
approach of setting up a perl program to run from a .forward file
has ... unpleasant effects if you receive more than a few e-mails in
quick succession. As my test mail-server collapsed under the load,
I checked the <code>PerlMx</code> machine, started at roughly the same time, and found that
while it was working through the e-mail more slowly, it hadn't put
any serious load on the machine.</p>
<p>Due to a <code>PerlMx</code> configuration error on my part, of the first 171 messages
processed, 10 were quarantined as spam AND delivered to the inbox of
my test user. <code>PerlMx</code> runs by default in 'training mode' when processing
spam - in this mode, mail is spamchecked as normal, but even if it
is found to be spam and quarantined, it is also delivered to the
user.</p>
<p>I decided to keep track of any mail lost or mislaid during initial
setup problems, so I could see what problems could arise from the
tools being misconfigured. An important aspect of any software is not
only how it behaves when configured right, but how much it punishes
you when you get the configuration wrong.</p>
<p>Waking up the next morning, I found I'd bounced several hundred e-mails
back to the account from which I was forwarding all the test e-mails,
someone of which appeared to have gone back and forth, or found their
way into the <code>PerlMx</code> test mailbox. Most of the problems appeared to be
internal errors from within SpamAssassin. My mail-server still
hadn't recovered.</p>
<p>I later found this was because of an compatibility issue with
SpamAssassin / <code>Mail::Audit</code>, and there was a recommended fix in the
SpamAssassin FAQ involving the <em>nomime</em> option to <code>Mail::Audit</code> (but not,
sadly, in the documentation for the Mail::SpamAssassin module
itself).</p>
<p>The SpamAssassin / <code>Mail::Audit</code> script I ended up using in the end was:</p>
<pre><code>
  #!/usr/local/bin/perl -w</code></pre>
<pre><code>
  use strict;
  use C&lt;Mail::Audit&gt;;
  use Mail::SpamAssassin;</code></pre>
<pre><code>
  # create C&lt;Mail::Audit&gt; object, log to /tmp, disable mime processing
  # for SpamAssassin compatibility, and store mail in ~/emergency_mbox
  # if processing fails
  my $mail = C&lt;Mail::Audit&gt;-&gt;new(emergency=&gt;&quot;~/emergency_mbox&quot;,
                              log =&gt; '/tmp/audit.log',
                              loglevel =&gt; 4, nomime =&gt; 1);</code></pre>
<pre><code>
  my $spamtest = Mail::SpamAssassin-&gt;new;
  
  # check mail with SpamAssassin
  my $status = $spamtest-&gt;check($mail);
  
  # if it was spam, rewrite to indicate what the problem was, and 
  # store in the file ass-spam in our home directory
  if ($status-&gt;is_spam) {
          $status-&gt;rewrite_mail;
          $mail-&gt;accept(&quot;/home/spam1/ass-spam&quot;);
  # if if wasn't spam, accept it as normal mail
  } else {
          $mail-&gt;accept;
  }
  
  exit 0;
</code></pre>

<p>After clearing down all my mail, and losing two days of testing, I
started again. It was only the nature of the testing setup that meant
the bounce mail went to me and not the original sender.  So, at 23:25
on Tuesday, I had another go. This time I knew enough to limit
SpamAssassin to receiving messages in batches of five (using fetchmail) -
something I could do in testing, but wouldn't be an easy option in
most production setups. This meant my test machine could just about
cope with delivering mail using SpamAssassin.</p>
<p>At 10 p.m. Sunday, I declared the testing closed, and examined the
accuracy or otherwise of each system.</p>
<p>During the testing between Aug. 6 and 11, <code>Mail::Audit</code>
marked 16 pieces of e-mail as spam. Seven of these e-mails proved to be
false positives - mail that I had actually solicited and would have
liked to have received. Six spam emails were accepted into my Inbox.
There were 874 e-mails received in all. <code>Mail::Audit</code> appeared to receive
15 pieces of spam mail in total.</p>
<p><code>PerlMx</code> marked 14 e-mails as spam. Two of these e-mails proved to be false
positives - mail that was not spam. Impressively, it received 886
e-mails in the same period that <code>Mail::Audit</code> received 874 e-mails. I
was unable to work out the exact cause of this, although the power-cut
in the middle of the testing period will always be a major suspect.
Eleven spam messages were incorrectly allowws through into my Inbox.
<code>PerlMx</code> appeared to receive 23 pieces of spam mail in total.</p>
<p>The sample was small, as all I had was my own personal e-mail to work
with, and I get what I'm told is surprisingly little spam, but it
shows that <code>Mail::Audit</code> / SpamAssassin seems to decide more mail is
spam than <code>PerlMx</code> does, but is also wrong more of the time. <code>PerlMx</code>
marked slightly less e-mail as spam, and let more spam through,
but when it did claim e-mail was spam it was right more of the time.</p>
<p>These tests would benefit significantly from being re-run during a long
period of time on a larger mail-server, but I had neither the time
nor the mail-server available.</p>
<p>Both tools can be extensively configured in terms of what is
considered spam, and are likely to need regular updating to ensure
they keep up to date with new tricks of the spammers. Here I only
considered the behavior with the default configuration of the latest
release at the time I ran my tests.</p>

<h3><a name="feature comparison">Feature Comparison</a></h3>
<p>To help you choose, I've summarized the basic characteristics of both
systems below. Some of the points are quite subjective and are more
my impressions of the tools rather than hard facts - these are marked
separately.</p>
<table>
	<tr>
		<td></td>
		<th>PerlMX</th>
		<th>Mail::Audit</th>
	</tr>
	<tr>
		<th>Scalable</th>
		<td>Yes - persistent server</td>
		<td>Maybe - depends on config - obvious default configurations scale poorly</td>
	</tr>
	<tr>
		<th>Ships with wide range of existing filtering functionality</th>
		<td>Yes</td>
		<td>Limited range, more available from third-parties</td>
	</tr>
	<tr>
		<th>Target use</th>
		<td>System-wide mail filtering for mailservers</td>
		<td>Per-use mail filtering as a replacement for programs like procmail</td>
	</tr>
	<tr>
		<th>Extensible?</th>
		<td>Yes</td>
		<td>Yes</td>
	</tr>
	<tr>
		<th>Licensing</th>
		<td>Commercial</td>
		<td>Open-source</td>
	</tr>
	<tr>
		<th>Mail Server Compatibility</th>
		<td>Sendmail</td>
		<td>Almost any mail server</td>
	</tr>
	<tr>
		<th>Spam filtering</th>
		<td>Yes</td>
		<td>Third-party extension</td>
	</tr>
	<tr>
		<th>Virus filtering</th>
		<td>Yes</td>
		<td>No</td>
	</tr>
	<tr>
		<th>Easy to setup</th>
		<td>Yes</td>
		<td>Not so easy, requires custom code</td>
	</tr>
	<tr>
		<th>Efficient and Scalable</th>
		<td>Very scalable - easily separated from the mailserver, and no noticable performance impact during testing</td>
		<td>Performance problems during testing in default configuration</td>
	</tr>
</table>

<h3><a name="conclusions">Conclusions</a></h3>

<p>During testing, <code>PerlMx</code> was significantly more reliable, both in terms
of the amount of mail bounced due to configuration problems (none),
and in terms of the load put in the mailserver (minimal) than
<code>Mail::Audit</code>. Although <code>Mail::Audit</code> appears able to be setup for good
performance, the obvious suggested configuration showed extremely poor
scalability during testing. Also, as <code>Mail::Audit</code> requires writing some
filtering code, bugs, mostly in this code, resulted in nontrivial
quantities of mail being bounced during testing due to
code/configuration errors, a problem that simply didn't occur with
<code>PerlMx</code>'s more pre-supplied, configuration file based system.</p>

<p>Both <code>PerlMx</code> and <code>Mail::Audit</code> provide good mail filtering solutions
using Perl, but are targeted at entirely different markets.  <code>PerlMx</code>
is a systemwide solution providing drop-in functionality on
mailservers, with Perl extensibility as well, whereas <code>Mail::Audit</code> is a
more low-level tool, mostly focused on use by individuals, designed to
let users build their own mail processing tools more easily.</p>




        </div>



    </div>
    <div class="asset-footer"></div>
</div>


                            
                            <div id="entry-1344" class="entry-asset asset hentry">
    <div class="asset-header">
        <h2 class="asset-name entry-title"><a href="/pub/2002/08/22/exegesis5.html" rel="bookmark">Exegesis 5</a></h2>
        <div class="asset-meta">
            <span class="byline">
    
                By <span class="vcard author">Damian Conway</span> on <abbr class="published" title="2002-08-22T00:00:00-08:00">August 22, 2002 12:00 AM</abbr>
    
            </span>

            
            

        </div>
    </div>
    <div class="asset-content entry-content">

        <div class="asset-body">
            

<p><em>Editor's note: this document is out of date and remains here for historic interest.  See <a href="http://dev.perl.org/perl6/doc/design/syn/S05.html">Synopsis 5</a> for the current design information.</p>

<ul>

	<li><a href="#exegesis_5">Exegesis 5</a></li>
	<li><a href="#whats_the_diff">What's the diff?</a></li>
	<li><a href="#starting_gently">Starting gently</a></li>
	<li><a href="/pub/a{cs.r.file}?page=2#lay_it_out_for_me">Lay it out for me</a></li>
	<li><a href="/pub/a{cs.r.file}?page=2#interpolate_ye_not">Interpolate ye not ...</a></li>
	<li><a href="/pub/a{cs.r.file}?page=2#the_incredible_hunk">The incredible <code>$hunk</code></a></li>
	<li><a href="/pub/a{cs.r.file}?page=2#modified_modifiers">Modified modifiers</a></li>
	<li><a href="/pub/a{cs.r.file}?page=3#take_no_prisoners">Take no prisoners</a></li>
	<li><a href="/pub/a{cs.r.file}?page=3#meanwhile_back_at_the_hunk">Meanwhile, back at the <code>$hunk</code> ...</a></li>
	<li><a href="/pub/a{cs.r.file}?page=3#this_or_nothing">This or nothing</a></li>
	<li><a href="/pub/a{cs.r.file}?page=3#failing_with_style">Failing with style</a></li>
	<li><a href="/pub/a{cs.r.file}?page=3#home_home_on_the_line_range">Home, home on the (line) range</a></li>
	<li><a href="/pub/a{cs.r.file}?page=3#whats_my_line">What's my line?</a></li>
	<li><a href="/pub/a{cs.r.file}?page=3#the_final_frontier">The final frontier</a></li>
	<li><a href="/pub/a{cs.r.file}?page=3#matchmaker_matchmaker">Match-maker, match-maker ...</a></li>
	<li><a href="/pub/a{cs.r.file}?page=3#a_cleaner_approach">A cleaner approach</a></li>
	<li><a href="/pub/a{cs.r.file}?page=3#whats_in_a-name">What's in a name?</a></li>
	<li><a href="/pub/a{cs.r.file}?page=3#bad_line_no_match">Bad line! No match!</a></li>
	<li><a href="/pub/a{cs.r.file}?page=4#thinking_ahead">Thinking ahead</a></li>
	<li><a href="/pub/a{cs.r.file}?page=4#what_you_match_is_what_you_get">What you match is what you get</a></li>
	<li><a href="/pub/a{cs.r.file}?page=4#a_hypothetical_solution_to_a_very_real_problem">A hypothetical solution to a very real problem</a></li>
	<li><a href="/pub/a{cs.r.file}?page=4#the_nesting_instinct">The nesting instinct</a></li>
	<li><a href="/pub/a{cs.r.file}?page=4#extracting_the_insertions">Extracting the insertions</a></li>
	<li><a href="/pub/a{cs.r.file}?page=4#dont_just_match_there_do_something!">Don't just match there; do something!</a></li>
	<li><a href="/pub/a{cs.r.file}?page=4#smarter_alternatives">Smarter alternatives</a></li>
	<li><a href="/pub/a{cs.r.file}?page=5#rearranging_the_deckchairs">Rearranging the deck chairs</a></li>
	<li><a href="/pub/a{cs.r.file}?page=5#deriving_a_benefit">Deriving a benefit</a></li>
	<li><a href="/pub/a{cs.r.file}?page=5#different_diffs">Different diffs</a></li>
	<li><a href="/pub/a{cs.r.file}?page=5#lets_get_cooking">Let's get cooking</a></li>
</ul>
<!-- INDEX END -->

<hr />
<h3><a name="exegesis_5">Exegesis 5</a></h3>

<p><strong><a name="item_Come_gather_round_Mongers%2C_whatever_you_code"><em>Come gather round Mongers, whatever you code</em></a></strong><br />
<strong><a name="item_And_admit_that_your_forehead%27s_about_to_explode"><em>And admit that your forehead's about to explode</em></a></strong><br />
<strong><a name="item_%27Cos_Perl_patterns_induce_complete_brain_overloa"><em>'Cos Perl patterns induce complete brain overload</em></a></strong><br />
<strong><a name="item_If_there%27s_source_code_you_should_be_maintainin%"><em>If there's source code, you should be maintainin'</em></a></strong><br />
<strong><a name="item_Then_you_better_start_learnin%27_Perl_6_patterns_s"><em>Then you better start learnin' Perl 6 patterns soon</em></a></strong><br />
<strong><a name="item_For_the_regexes%2C_they_are_a%2Dchangin%27"><em>For the regexes, they are a-changin'</em></a></strong><br />
<ul>
<strong><a name="item_%2D%2D_Bob_Dylan%2C_%22The_regexes_they_are_a%2Dch">-- Bob Dylan, &ldquo;The regexes they are a-changin'&rdquo; (Perl 6 remix)</a></strong>
</ul>
</p>

<p>Apocalypse 5 marks a significant departure in the ongoing design of Perl 6.</p>
<p>Previous Apocalypses took an evolutionary approach to changing Perl's
general syntax, data structures, control mechanisms and operators. New
features were added, old features removed, and existing features were
enhanced, extended and simplified. But the changes described were
remedial, not radical.</p>
<p>Larry could have taken the same approach with regular expressions. He could
have tweaked some of the syntax, added new <code>(?...)</code> constructs, cleaned
up the rougher edges, and moved on.</p>
<p>Fortunately, however, he's taking a much broader view of Perl's future
than that. And he saw that the problem with regular expressions was <em>not</em>
that they lacked a <code>(?$var:...)</code> extension to do named captures, or 
that they needed a <code>\R</code> metatoken to denote a recursive subpattern,
or that there was a <code>[:YourNamedCharClassHere:]</code> mechanism missing.</p>

<!-- sidebar begins -->
<table width="220" border="0" cellspacing="12" cellpadding="6" align="right">
<tr>
<td valign="top" bgcolor="#efefef">
<p class="headline">Related articles:</p>
<p class="smalllist"></p>
<p class="smalllist"></p>
<p class="smalllist"></p>
<p class="smalllist"></p>
<p class="smalllist"></p>
<p class="smalllist"></p>
<p class="smalllist"></p>
<p class="smalllist"></p>
</td>
</tr>
</table>
<!-- sidebar ends -->

<p>He saw that those features, laudable as they were individually, would
just compound the real problem, which was that Perl 5 
regular expressions were already groaning under the accumulated weight
of their own metasyntax. And that a decade of accretion had left the
once-clean notation arcane, baroque, inconsistent and obscure.</p>
<p>It was time to throw away the prototype.</p>
<p>Even more importantly, as powerful as Perl 5 regexes are, they are not nearly
powerful enough. Modern text manipulation is predominantly about processing
structured, hierarchical text. And that's just plain painful with regular
expressions. The advent of modules like Parse::Yapp and Parse::RecDescent
reflects the community's widespread need for more sophisticated parsing
mechanisms. Mechanisms that should be native to Perl.</p>
<p>As Piers Cawley has so eloquently misquoted: <em>&ldquo;It is a truth universally
acknowledged that any language in possession of a rich syntax must be in
want of a rewrite.&rdquo;</em> Perl regexes are such a language. And Apocalypse 5
is precisely that rewrite.</p>

<hr />
<h3><a name="#whats_the_diff">What's the diff?</a></h3>
<p>So let's take a look at some of those new features. To do that, we'll
consider a series of examples structured around a common theme:
recognizing and manipulating data in the Unix
<em><a href="http://www.gnu.org/manual/diffutils-2.8.1/html_node/Detailed-Normal.html">diff</a></em></p>

<p>A classic diff consists of zero-or-more text transformations, each of
which is known as a &ldquo;hunk&rdquo;. A hunk consists of a modification specifier,
followed by one or more lines of context. Each hunk is either an append,
a delete, or a change, and the type of hunk is specified by a single
letter (<code>'a'</code>, <code>'d'</code>, or <code>'c'</code>). Each of these single-letter specifiers is
prefixed by the line numbers of the lines in the original document it
affects, and followed by the equivalent line numbers in the transformed
file. The context information consists of the lines of the original file
(each preceded by a <code>'&lt;'</code> character), then the lines of the
transformed file (each preceded by a <code>'&gt;'</code>). Deletes omit the
transformed context, appends omit the original context. If both contexts
appear, then they are separated by a line consisting of three hyphens.</p>
<p>Phew! You can see why natural language isn't the preferred way of 
specifying data formats.</p>
<p>The preferred way is, of course, to specify such formats as patterns.
And, indeed, we could easily throw together a few Perl 6 patterns that
collectively would match any data conforming to that format:</p>
<pre><code>    $file = rx/ ^  &lt;$hunk&gt;*  $ /;</code></pre>
<pre><code>    $hunk = rx :i { 
        [ &lt;$linenum&gt; a :: &lt;$linerange&gt; \n
          &lt;$appendline&gt;+ 
        |
          &lt;$linerange&gt; d :: &lt;$linenum&gt; \n
          &lt;$deleteline&gt;+
        |
          &lt;$linerange&gt; c :: &lt;$linerange&gt; \n
          &lt;$deleteline&gt;+
          --- \n
          &lt;$appendline&gt;+
        ]
      |
        (\N*) ::: { fail &quot;Invalid diff hunk: $1&quot; }
    };</code></pre>
<pre><code>    $linerange = rx/ &lt;$linenum&gt; , &lt;$linenum&gt;
                   | &lt;$linenum&gt;
                   /;</code></pre>
<pre><code>    $linenum = rx/ \d+ /;</code></pre>
<pre><code>    $deleteline = rx/^^ \&lt; &lt;sp&gt; (\N* \n) /;
    $appendline = rx/^^ \&gt; &lt;sp&gt; (\N* \n) /;</code></pre>
<pre><code>    # and later...</code></pre>
<pre><code>    my $text is from($*ARGS);</code></pre>
<pre><code>    print &quot;Valid diff&quot; 
        if $text =~ /&lt;$file&gt;/;</code></pre>
<hr />
<h3><a name="starting_gently">Starting gently</a></h3>
<p>There's a lot of new syntax there, so let's step through it slowly,
starting with:</p>
<pre><code>    $file = rx/ ^  &lt;$hunk&gt;*  $ /;</code></pre>
<p>This statement creates a pattern object. Or, as it's known in Perl 6, a
&ldquo;rule&rdquo;. People will probably still call them &ldquo;regular expressions&rdquo; or
&ldquo;regexes&rdquo; too (and the keyword <code>rx</code> reflects that), but Perl patterns
long ago ceased being anything like &ldquo;regular&rdquo;, so we'll try and avoid
those terms.</p>
<p>In any case, the <code>rx</code> constructor builds a new rule, which is then
stored in the <code>$file</code> variable.  The Perl 5 equivalent would be:</p>
<pre><code>    # Perl 5
    my $file = qr/ ^  (??{$hunk})*  $ /x;</code></pre>
<p>This illustrates quite nicely why the entire syntax
needed to change.</p>
<p>The name of the rule constructor has changed from <code>qr</code> to <code>rx</code>,
because in Perl 6 rule constructors <em>aren't</em> quotelike contexts.
In particular, variables don't interpolate into <code>rx</code> constructors
in the way they do for a <code>qq</code> or a <code>qx</code>. That's why we can embed the
<code>$hunk</code> variable before it's actually initialized.</p>
<p>In Perl 6, an embedded variable becomes part of the rule's implementation
rather than part of its &ldquo;source code&rdquo;. As we'll see shortly, the pattern
itself can determine how the variable is treated (i.e., whether to
interpolate it literally, treat it as a subpattern or use it as a
container).</p>
<hr />














<p><em>Editor's note: this document is out of date and remains here for historic interest.  See <a href="http://dev.perl.org/perl6/doc/design/syn/S05.html">Synopsis 5</a> for the current design information.</p>

<h3><a name="lay_it_out_for_me">Lay it out for me</a></h3>
<p>In Perl 6, each rule implicitly has the equivalent of the Perl 5 <code>/x</code> modifier
turned on, so we could lay out (and annotate) that first pattern like this:</p>
<pre><code>    $file = rx/ ^               # Must be at start of string
                &lt;$hunk&gt;         # Match what the rule in $hunk would match...
                        *       #          ...zero-or-more times
                $               # Must be at end of string (no newline allowed)
              /;</code></pre>
<p>Because <code>/x</code> is the default, the whitespace in the pattern is ignored,
which allows us to lay out the rule more readably. Comments are also honored,
which enables us to document the rule sensibly. You can even use the closing
delimiter in a comment safely:</p>
<pre><code>    $caveat = rx/ Make \s+ sure \s+ to \s+ ask
                  \s+ (mum|mom)                 # handle UK/US spelling
                  \s+ (and|or)                  # handle and/or
                  \s+ dad \s+ first
                /;</code></pre>
<p>Of course, the examples in this Exegesis <em>don't</em> represent good
comments in general, since they document what is happening,
rather than why.</p>
<p>The meanings of the <code>^</code> and <code>*</code> metacharacters are unchanged
from Perl 5. However, the meaning of the <code>$</code> metacharacter <em>has</em>
changed slightly: it no longer allows an optional newline before the end
of the string. If you want that behavior, then you need to specify it
explicitly. For example, to match a line ending in digits: <code>/ \d+ \n? $/</code></p>
<p>The compensation is that, in Perl 6, a <code>\n</code> in a pattern matches a <em>logical</em>
newline (that is any of: <code>&quot;\015\012&quot;</code> or <code>&quot;\012&quot;</code> or <code>&quot;\015&quot;</code>
or <code>&quot;\x85&quot;</code> or <code>&quot;\x2028&quot;</code>), rather than just a
<em>physical</em> ASCII newline (i.e. just <code>&quot;\012&quot;</code>). And a <code>\n</code> will always
try to match any kind of physical newline marker (not just the current system's
favorite), so it correctly matches against strings that have been
aggregated from multiple systems.</p>
<hr />
<h3><a name="interpolate_ye_not">Interpolate ye not ...</a></h3>



<p>The really new bit in the <code>$file</code> rule is the <code>&lt;$hunk&gt;</code> element.
It's a directive to grab whatever's in the <code>$hunk</code> variable (presumably
another pattern) and attempt to match it at that point in the rule. The
important point is that the contents of <code>$hunk</code> are only grabbed when
the pattern matching mechanism actually needs to match against them,
<em>not</em> when the rule is being constructed. So it's like the mysterious
<code>(??{...})</code> construct in Perl 5 regexes.</p>
<p>The angle brackets themselves are a much more general mechanism in Perl 6 rules.
They are the &ldquo;metasyntactic markers&rdquo; and replace the Perl 5 <code>(?...)</code> syntax.
They are used to specify numerous other features of Perl 6 rules, many of which
we will explore below.</p>
<p>Note that if we <em>hadn't</em> put the variable in angle-brackets, and had
just written:</p>
<pre><code>    rx/ ^  $hunk*  $ /;</code></pre>
<p>then the contents of <code>$hunk</code> would <em>still</em> not be interpolated when
the pattern was parsed. Once again, the pattern would grab the
contents of the variable when it reached that point in its match.
But, this time, without the angle brackets around <code>$hunk</code>, the
pattern would try to match the contents of the variable as an
atomic literal string (rather than as a subpattern). &ldquo;Atomic&rdquo;
means that the <code>*</code> repetition quantifier applies to everything
that's in <code>$hunk</code>, <em>not</em> just to the last character
(as it does in Perl 5).</p>
<p>In other words, a raw variable in a Perl 6 pattern is matched
as if it was a Perl 5 regex in which the interpolation had been
<code>quotemeta</code>'d and then placed in a pair of noncapturing parentheses.
That's really handy in something like:</p>
<pre><code>    # Perl 6
    my $target = &lt;&gt;;                  # Get literal string to search for
    $text =~ m/ $target* /;           # Search for them as literals</code></pre>
<p>which in Perl 5 we'd have to write as:</p>
<pre><code>    # Perl 5
    my $target = &lt;&gt;;                  # Get literal string to search for
    chomp $target;                    # No autochomping in Perl 5 
    $text =~ m/ (?:\Q$target\E)* /x;  # Search for it, quoting metas</code></pre>
<p>Raw arrays and hashes interpolate as literals, too. For example, if we
use an array in a Perl 6 pattern, then the matcher will attempt to match any
of its elements (each as a literal). So:</p>
<pre><code>    # Perl 6
    @cmd = ('get','put','try','find','copy','fold','spindle','mutilate');</code></pre>
<pre><code>    $str =~ / @cmd \( .*? \) /;     # Match a cmd, followed by stuff in parens</code></pre>
<p>is the same as:</p>
<pre><code>    # Perl 5 
    @cmd = ('get','put','try','find','copy','fold','spindle','mutilate');
    $cmd = join '|', map { quotemeta $_ } @cmd;</code></pre>
<pre><code>    $str =~ / (?:$cmd) \( .*? \) /;</code></pre>
<p>By the way, putting the array into angle brackets would cause the matcher to
try and match each of the array elements as a pattern, rather than as a literal.</p>
<hr />
<h3><a name="the_incredible_hunk">The incredible <code>$hunk</code></a></h3>
<p>The rule that <code>&lt;$hunk&gt;</code> tries to match against is the next one defined
in the program. Here's the annotated version of it:</p>
<pre><code>    $hunk = rx :i {                             # Case-insensitively...
        [                                       #   Start a non-capturing group
            &lt;$linenum&gt;                          #     Match the subrule in $linenum
            a                                   #     Match a literal 'a'
            ::                                  #     Commit to this alternative
            &lt;$linerange&gt;                        #     Match the subrule in $linerange
            \n                                  #     Match a newline
            &lt;$appendline&gt;                       #     Match the subrule in $appendline...
                          +                     #         ...one-or-more times
        |                                       #   Or...
          &lt;$linerange&gt; d :: &lt;$linenum&gt; \n       #     Match $linerange, 'd', $linenum, newline
          &lt;$deleteline&gt;+                        #     Then match $deleteline once-or-more
        |                                       #   Or...
          &lt;$linerange&gt; c :: &lt;$linerange&gt; \n     #     Match $linerange, 'c', $linerange, newline
          &lt;$deleteline&gt;+                        #     Then match $deleteline once-or-more
          --- \n                                #     Then match three '-' and a newline
          &lt;$appendline&gt;+                        #     Then match $appendline once-or-more
        ]                                       #   End of non-capturing group
      |                                         # Or...
        (                                       #   Start a capturing group
            \N*                                 #     Match zero-or-more non-newlines
        )                                       #     End of capturing group
        :::                                     #     Emphatically commit to this alternative
        { fail &quot;Invalid diff hunk: $1&quot; }        #     Then fail with an error msg
    };</code></pre>
<p>The first thing to note is that, like a Perl 5 <code>qr</code>, a Perl 6 <code>rx</code> can take
(almost) any delimiters we choose. The <code>$hunk</code> pattern uses <code>{...}</code>, but
we could have used:</p>
<pre><code>    rx/pattern/     # Standard
    rx[pattern]     # Alternative bracket-delimiter style
    rx&lt;pattern&gt;     # Alternative bracket-delimiter style
    rx&laquo;forme&raquo;       # D&eacute;limiteurs tr&egrave;s chic
    rx&gt;pattern&lt;     # Inverted bracketing is allowed too (!)
    rx&raquo;Muster&laquo;      # Begrenzungen im korrekten Auftrag
    rx!pattern!     # Excited
    rx=pattern=     # Unusual
    rx?pattern?     # No special meaning in Perl 6
    rx#pattern#     # Careful with these: they disable internal comments</code></pre>
<hr />
<h3><a name="modified_modifiers">Modified modifiers</a></h3>
<p>In fact, the only characters not permitted as <code>rx</code> delimiters are
<code>':'</code> and <code>'('</code>. That's because <code>':'</code> is the character used to
introduce pattern modifiers in Perl 6, and <code>'('</code> is the character used
to delimit any arguments that might be passed to those pattern modifiers.</p>
<p>In Perl 6, pattern modifiers are placed <em>before</em> the pattern, rather
than after it. That makes life easier for the parser, since it doesn't
have to go back and reinterpret the contents of a rule when it reaches
the end and discovers a <code>/s</code> or <code>/m</code> or <code>/i</code> or <code>/x</code>. And it makes life
easier for anyone reading the code -- for precisely the same reason.</p>
<p>The only modifier used in the <code>$hunk</code> rule is the <code>:i</code> (case-insensitivity)
modifier, which works exactly as it does in Perl 5.</p>
<p>The other rule modifiers available in Perl 6 are:</p>
<dl>
<dt><strong><a name="item_%3Ae_or_%3Aeach"><code>:e</code> or <code>:each</code></a></strong><br /></dt>
<dd>
<p>This is the replacement for Perl 5's <code>/g</code> modifier. It causes a
match (or substitution) to be attempted as many times as possible.
The name was changed because &ldquo;each&rdquo; is shorter and clearer in intent
than &ldquo;globally&rdquo;. And because the <code>:each</code> modifier can be combined with
other modifiers (see below) in such a way that it's no longer &ldquo;global&rdquo;
in its effect.
</p></dd>
<dt><strong><a name="item_x"><code>:x($count)</code></a></strong><br /></dt>
<dd>
<p>This modifier is like <code>:e</code>, in that it causes the match or substitution
to be attempted repeatedly. However, unlike <code>:e</code>, it specifies exactly
how many times the match must succeed. For example:</p>
<pre><code>    &quot;fee fi &quot;       =~ m:x(3)/ (f\w+) /;  # fails
    &quot;fee fi fo&quot;     =~ m:x(3)/ (f\w+) /;  # succeeds (matches &quot;fee&quot;,&quot;fi&quot;,&quot;fo&quot;)
    &quot;fee fi fo fum&quot; =~ m:x(3)/ (f\w+) /;  # succeeds (matches &quot;fee&quot;,&quot;fi&quot;,&quot;fo&quot;)</code></pre>
<p>Note that the repetition count doesn't have to be a constant:</p>
<pre><code>    m:x($repetitions)/ pattern /</code></pre>
<p>There is also a series of tidy abbreviations for all the constant cases:</p>
<pre><code>    m:1x/ pattern /         # same as: m:x(1)/ pattern /
    m:2x/ pattern /         # same as: m:x(2)/ pattern /
    m:3x/ pattern /         # same as: m:x(3)/ pattern /
    # etc.</code></pre><br />
</dd>
<dt><strong><a name="item_nth"><code>:nth($count)</code></a></strong><br /></dt>
<dd>
<p>This modifier causes a match or substitution to be attempted repeatedly,
but to ignore the first <code>$count-1</code> successful matches. For example:</p>
<pre><code>    my $foo = &quot;fee fi fo fum&quot;;</code></pre>
<pre><code>    $foo =~ m:nth(1)/ (f\w+) /;        # succeeds (matches &quot;fee&quot;)
    $foo =~ m:nth(2)/ (f\w+) /;        # succeeds (matches &quot;fi&quot;)
    $foo =~ m:nth(3)/ (f\w+) /;        # succeeds (matches &quot;fo&quot;)
    $foo =~ m:nth(4)/ (f\w+) /;        # succeeds (matches &quot;fum&quot;)
    $foo =~ m:nth(5)/ (f\w+) /;        # fails
    $foo =~ m:nth($n)/ (f\w+) /;       # depends on the numeric value of $n</code></pre>
<pre><code>    $foo =~ s:nth(3)/ (f\w+) /bar/;    # $foo now contains: &quot;fee fi bar fum&quot;</code></pre>
<p>Again, there is also a series of abbreviations:</p>
<pre><code>    $foo =~ m:1st/ (f\w+) /;           # succeeds (matches &quot;fee&quot;)
    $foo =~ m:2nd/ (f\w+) /;           # succeeds (matches &quot;fi&quot;)
    $foo =~ m:3rd/ (f\w+) /;           # succeeds (matches &quot;fo&quot;)
    $foo =~ m:4th/ (f\w+) /;           # succeeds (matches &quot;fum&quot;)
    $foo =~ m:5th/ (f\w+) /;           # fails</code></pre>
<pre><code>    $foo =~ s:3rd/ (f\w+) /bar/;       # $foo now contains: &quot;fee fi bar fum&quot;</code></pre>
<p>By the way, Perl isn't going to be pedantic about these &ldquo;ordinal&rdquo; versions
of repetition specifiers. If you're not a native English speaker, and you
find <code>:1th</code>, <code>:2th</code>, <code>:3th</code>, <code>:4th</code>, etc., easier to remember, then that's
perfectly OK.</p>
<p>The various types of repetition modifiers can also be combined 
by separating them with additional colons:</p>
<pre><code>    my $foo = &quot;fee fi fo feh far foo fum &quot;;</code></pre>
<pre><code>    $foo =~ m:2nd:2x/ (f\w+) /;        # succeeds (matches &quot;fi&quot;, &quot;feh&quot;)
    $foo =~ m:each:2nd/ (f\w+) /;      # succeeds (matches &quot;fi&quot;, &quot;feh&quot;, &quot;foo&quot;)
    $foo =~ m:x(2):nth(3)/ (f\w+) /;   # succeeds (matches &quot;fo&quot;, &quot;foo&quot;)
    $foo =~ m:each:3rd/ (f\w+) /;      # succeeds (matches &quot;fo&quot;, &quot;foo&quot;)
    $foo =~ m:2x:4th/ (f\w+) /;        # fails (not enough matches to satisfy :2x)
    $foo =~ m:4th:each/ (f\w+) /;      # succeeds (matches &quot;feh&quot;)</code></pre>
<pre><code>    $foo =~ s:each:2nd/ (f\w+) /bar/;  # $foo now &quot;fee bar fo bar far bar fum &quot;;</code></pre>
<p>Note that the order in which the two modifiers are specified doesn't matter.</p>
</dd>
<dt><strong><a name="item_%3Ap5_or_%3Aperl5"><code>:p5</code> or <code>:perl5</code></a></strong><br /></dt>
<dd>
<p>This modifier causes Perl 6 to interpret the contents of a rule as
a regular expression in Perl 5 syntax. This is mainly provided as a
transitional aid for porting Perl 5 code. And to mollify the
curmudgeonly.</p></dd>
<dt><strong><a name="item_%3Aw_or_%3Aword"><code>:w</code> or <code>:word</code></a></strong><br /></dt>
<dd>
<p>This modifier causes whitespace appearing in the pattern to match optional
whitespace in the string being matched. For example, instead of having
to cope with optional whitespace explicitly:</p>
<pre><code>    $cmd =~ m/ \s* &lt;keyword&gt; \s* \( [\s* &lt;arg&gt; \s* ,?]* \s* \)/;</code></pre>
<p>we can just write:</p>
<pre><code>    $cmd =~ m:w/ &lt;keyword&gt; \( [ &lt;arg&gt; ,?]* \)/;</code></pre>
<p>The <code>:w</code> modifier is also smart enough to detect those cases where
the whitespace should actually be mandatory. For example:</p>
<pre><code>    $str =~ m:w/a symmetric ally/</code></pre>
<p>is the same as:</p>
<pre><code>    $str =~ m/a \s+ symmetric \s+ ally/</code></pre>
<p>rather than:</p>
<pre><code>    $str =~ m/a \s* symmetric \s* ally/</code></pre>
<p>So it won't accidentally match strings like <code>&quot;asymmetric ally&quot;</code> or 
<code>&quot;asymmetrically&quot;</code>.</p>
</dd>
<dt><strong><a name="item_%3Aany"><code>:any</code></a></strong><br /></dt>
<dd><p>This modifier causes the rule to match a given string in every possible
way, simultaneously, and then return all the possible matches. For example:</p>
<pre><code>    my $str = &quot;ahhh&quot;;</code></pre>
<pre><code>    @matches =  $str =~ m/ah*/;         # returns &quot;ahhh&quot;
    @matches =  $str =~ m:any/ah*/;     # returns &quot;ahhh&quot;, &quot;ahh&quot;, &quot;ah&quot;, &quot;a&quot;</code></pre>
<p></p></dd>
<dt><strong><a name="item_%3Au0%2C_%3Au1%2C_%3Au2%2C_%3Au3"><code>:u0</code>, <code>:u1</code>, <code>:u2</code>, <code>:u3</code></a></strong><br /></dt>
<dd>
<p>These modifiers specify how the rule matches the dot (<code>.</code>)
metacharacter against Unicode data. If <code>:u0</code> is specified, then dot matches
a single byte; if <code>:u1</code> is specified, then dot matches a single codepoint
(i.e. one or more bytes representing a single Unicode &ldquo;character&rdquo;).
If <code>:u2</code> is specified, then dot matches a single grapheme (i.e. a base
codepoint followed by zero or more modifier codepoints, such as
accents). If <code>:u3</code> is specified, then dot matches an appropriate &ldquo;something&rdquo;
in a language-dependent manner.</p>
<p>It's OK to ignore this modifier if you're not using Unicode (and maybe even
if you are). As usual, Perl will try to do the right thing.
To that end, the default behavior of rules is <code>:u2</code>, unless an
overriding pragma (e.g. <code>use bytes</code>) is in effect.
</p></dd>
</dl>
<p>Note that the <code>/s</code>, <code>/m</code>, and <code>/e</code> modifiers are no longer available.
This is because they're no longer needed. The <code>/s</code> isn't needed because 
the <code>.</code> (dot) metacharacter now matches newlines as well. When we want
to match &ldquo;anything except a newline&rdquo;, we now use the new <code>\N</code> metatoken
(i.e. &ldquo;opposite of <code>\n</code>&rdquo;).</p>
<p>The <code>/m</code> modifier isn't required, because <code>^</code> and <code>$</code> always mean start and
end of string, respectively. To match the start and end of a line, we use 
the new <code>^^</code> and <code>$$</code> metatokens instead.</p>
<p>The <code>/e</code> modifier is no longer needed, because Perl 6 provides the
<code>$(...)</code> string interpolator (as described in Apocalypse 2). So a
substitution such as:</p>
<pre><code>    # Perl 5
    s/(\w+)/ get_val_for($1) /e;</code></pre>
<p>becomes just:</p>
<pre><code>    # Perl 6
    s/(\w+)/$( get_val_for($1) )/;</code></pre>
<hr />














<p><em>Editor's note: this document is out of date and remains here for historic interest.  See <a href="http://dev.perl.org/perl6/doc/design/syn/S05.html">Synopsis 5</a> for the current design information.</p>

<h3><a name="take_no_prisoners">Take no prisoners</a></h3>
<p>The first character of the <code>$hunk</code> rule is an opening square bracket.
In Perl 5, that denoted the start of a character class, but not in Perl 6.
In Perl 6, square brackets mark the boundaries of a noncapturing
group. That is, a pair of square brackets in Perl 6 are the same as a
<code>(?:...)</code> in Perl 5, but less line-noisy.</p>
<p>By the way, to get a character class in Perl 6, we need to put the
square brackets inside a pair of metasyntactic angle brackets. 
So the Perl 5:</p>
<pre><code>    # Perl 5
    / [A-Za-z] [0-9]+ /x          # An A-Z or a-z, followed by digits</code></pre>
<p>would become in Perl 6:</p>
<pre><code>    # Perl 6
    / &lt;[A-Za-z]&gt; &lt;[0-9]&gt;+ /       # An A-Z or a-z, followed by digits</code></pre>
<p>The Perl 5 complemented character class:</p>
<pre><code>    # Perl 5
    / [^A-Za-z]+ /x               # One-or-more chars-that-aren't-A-Z-or-a-z</code></pre>
<p>becomes in Perl 6:</p>
<pre><code>    # Perl 6
    / &lt;-[A-Za-z]&gt;+ /              #  One-or-more chars-that-aren't-A-Z-or-a-z</code></pre>
<p>The external minus sign is used (instead of an internal caret), because
Perl 6 allows proper set operations on character classes, and the minus sign is
the &ldquo;difference&rdquo; operator. So we could also create:</p>
<pre><code>    # Perl 6
    / &lt; &lt;alpha&gt; - [A-Za-z] &gt;+ /   # All alphabetics except A-Z or a-z
                                  # (i.e. the accented alphabetics)</code></pre>
<p>Explicit character classes were deliberately made a little less
convenient in Perl 6, because they're generally a bad idea in a
Unicode world. For example, the <code>[A-Za-z]</code> character class in the
above examples won't even match standard alphabetic Latin-1
characters like <code>'&Atilde;'</code>, <code>'&eacute;'</code>,
<code>'&oslash;'</code>, let alone alphabetic characters from code-sets
such as Cyrillic, Hiragana, Ogham, Cherokee, or Klingon.</p>
<hr />
<h3><a name="meanwhile_back_at_the_hunk">Meanwhile, back at the <code>$hunk</code> ...</a></h3>
<p>The noncapturing group of the <code>$hunk</code> pattern groups together three
alternatives, separated by <code>|</code> metacharacters (as in Perl 5).
The first alternative:</p>
<pre><code>    &lt;$linenum&gt; a :: &lt;$linerange&gt;
    \n                         
    &lt;$appendline&gt;+</code></pre>
<p>grabs whatever is in the <code>$linenum</code> variable, treats it as a
subpattern, and attempts to match against it. It then matches a
literal letter <code>'a'</code> (or an <code>'A'</code>, because of the <code>:i</code> modifier on the rule).
Then whatever the contents of the <code>$linerange</code> variable match. Then a
newline. Then it tries to match whatever the pattern in <code>$appendline</code>
would match, one or more times.</p>
<p>But what about that double-colon after the <code>a</code>? Shouldn't the
pattern have tried to match two colons at that point?</p>
<hr />
<h3><a name="this_or_nothing">This or nothing</a></h3>
<p>Actually, no. The double-colon is a new Perl 6 pattern-control
structure. It has no effect (and is ignored) when the pattern is
successfully matching, but if the pattern match should fail, and consequently
back-track over the double-colon -- for example, to try and rematch an
earlier repetition one fewer times -- the double-colon causes the entire
surrounding group (i.e. the surrounding <code>[...]</code> in this case) to fail as well.</p>
<p>That's a useful optimization in this case because, if we match a line
number followed by an <code>'a'</code> but subsequently fail, then there's no
point even trying either of the other two alternatives in the same
group. Because we found an <code>'a'</code>, there's no chance we could match a
<code>'d'</code> or a <code>'c'</code> instead.</p>
<p>So, in general, a double-colon means: &ldquo;At this point I'm committed to this
alternative within the current group -- don't bother with the others
if this one fails after this point&rdquo;.</p>
<p>There are other control directives like this, too. A single colon means: &ldquo;Don't
bother backtracking into the previous element&rdquo;. That's useful in a pattern
like:</p>
<pre><code>    rx:w/ $keyword [-full|-quick|-keep]+ : end /</code></pre>
<p>Suppose we successfully match the keyword (as a literal, by the way) and
one or more of the three options, but then fail to match <code>'end'</code>.
In that case, there's no point backtracking and trying to match one
fewer option, and <em>still</em> failing to find an <code>'end'</code>. And then
backtracking <em>another</em> option, and failing again, etc. By using
the colon after the repetition, we tell the matcher to give up after 
the first attempt.</p>
<p>However, the single colon isn't just a &ldquo;Greed is Good&rdquo; operator. It's
much more like a &ldquo;Resistance is Futile&rdquo; operator. That is, if the
preceding repetition had been non-greedy instead:</p>
<pre><code>    rx:w/ $keyword [-full|-quick|-keep]+? : end /</code></pre>
<p>then backtracking over the colon would prevent the <code>+?</code> from attempting
to match <em>more</em> options. Note that this means that <code>x+?:</code> is just a
baroque way of matching exactly one repetition of <code>x</code>, since the
non-greedy repetition initially tries to match the minimal number of 
times (i.e. once) and the trailing colon then prevents it from
backtracking and trying longer matches. Likewise, <code>x*?:</code>
and <code>x??:</code> are arcane ways of matching exactly zero repetitions of 
<code>x</code>.</p>
<p>Generally, though, a single colon tells the pattern matcher that there's
no point trying any other match on the preceding repetition, because
retrying (whether more or fewer repetitions) would just waste time and
would still fail.</p>
<p>There's also a three-colon directive. Three colons means: &ldquo;If we have
to backtrack past here, cause the entire rule to fail&rdquo; (i.e. not just
this group). If the double-colon in <code>$hunk</code> had been triple:</p>
<pre><code>    &lt;$linenum&gt; a ::: &lt;$linerange&gt;
    \n                         
    &lt;$appendline&gt;+</code></pre>
<p>then matching a line number and an <code>'a'</code> and subsequently failing would
cause the entire <code>$hunk</code> rule to fail immediately (though the <code>$file</code>
rule that invoked it might still match successfully in some other way).</p>
<p>So, in general, a triple-colon specifies: &ldquo;At this point I'm committed to this
way of matching the current rule -- give up on the rule completely if the
matching process fails at this point&rdquo;.</p>
<p>Four colons ... would just be silly. So, instead, there's a special named
directive: <code>&lt;commit&gt;</code>. Backtracking through a <code>&lt;commit&gt;</code>
causes the entire match to immediately fail. And if the current rule is
being matched as part of a larger rule, that larger rule will fail as
well. In other words, it's the &ldquo;Blow up this Entire Planet and Possibly
One or Two Others We Noticed on our Way Out Here&rdquo; operator.</p>
<p>If the double-colon in <code>$hunk</code> had been a <code>&lt;commit&gt;</code> instead:</p>
<pre><code>    &lt;$linenum&gt; a &lt;commit&gt; &lt;$linerange&gt;
    \n                         
    &lt;$appendline&gt;+</code></pre>
<p>then matching a line number and an <code>'a'</code> and subsequently
failing would cause the entire <code>$hunk</code> rule to fail immediately, <em>and</em>
would also cause the <code>$file</code> rule that invoked it to fail immediately.</p>
<p>So, in general, a <code>&lt;commit&gt;</code> means: &ldquo;At this point I'm
committed to this way of completing the current match -- give up
all attempts at matching anything if the matching process fails at
this point&rdquo;.</p>
<hr />
<h3><a name="failing_with_style">Failing with style</a></h3>
<p>The other two alternatives:</p>
<pre><code>    | &lt;$linerange&gt; d :: &lt;$linenum&gt; \n
      &lt;$deleteline&gt;+                 
    | &lt;$linerange&gt; c :: &lt;$linerange&gt; \n
      &lt;$deleteline&gt;+  --- \n  &lt;$appendline&gt;+</code></pre>
<p>are just variants on the first.</p>
<p>If none of the three alternatives in the square brackets matches, then the
alternative outside the brackets is tried:</p>
<pre><code>    |  (\N*) ::: { fail &quot;Invalid diff hunk: $1&quot; }</code></pre>
<p>This captures a sequence of non-newline characters (<code>\N</code> means &ldquo;not
<code>\n</code>&rdquo;, in the same way <code>\S</code> means &ldquo;not <code>\s</code>&rdquo; or <code>\W</code> means &ldquo;not
<code>\w</code>&rdquo;). Then it invokes a block of Perl code inside the pattern. The
call to <code>fail</code> causes the match to fail at that point, and sets an
associated error message that would subsequently appear in the <code>$!</code>
error variable (and which would also be accessible as part of <code>$0</code>).</p>
<p>Note the use of the triple colon after the repetition. It's needed
because the <code>fail</code> in the block will cause the pattern match to
backtrack, but there's no point backing up one character and trying
again, since the original failure was precisely what we wanted. The
presence of the triple-colon causes the entire rule to 
fail as soon as the backtracking reaches that point the first time.</p>
<p>The overall effect of the <code>$hunk</code> rule is therefore either to match one
hunk of the diff, or else fail with a relevant error message.</p>
<hr />
<h3><a name="home_home_on_the_line_range">Home, home on the (line)range</a></h3>
<p>The third and fourth rules:</p>
<pre><code>    $linerange = rx/ &lt;$linenum&gt; , &lt;$linenum&gt;
                   | &lt;$linenum&gt; 
                   /;</code></pre>
<pre><code>    $linenum = rx/ \d+ /;</code></pre>
<p>specify that a line number consists of a series of digits, and that a line
range consists of either two line numbers with a comma between them or a single
line number.  The <code>$linerange</code> rule could also have been written:</p>
<pre><code>    $linerange = rx/ &lt;$linenum&gt; [ , &lt;$linenum&gt; ]? /;</code></pre>
<p>which might be marginally more efficient, since it doesn't have to
backtrack and rematch the first <code>$linenum</code> in the second alternative.
It's likely, however, that the rule optimizer will detect such cases and
automatically hoist the common prefix out anyway, so it's probably not
worth the decrease in readability to do that manually.</p>
<hr />
<h3><a name="whats_my_line">What's my line?</a></h3>
<p>The final two rules specify the structure of individual context lines in the
diff (i.e. the lines that say what text is being added or removed by the hunk):</p>
<pre><code>    $deleteline = rx/^^ \&lt; &lt;sp&gt; (\N* \n) /
    $appendline = rx/^^ \&gt; &lt;sp&gt; (\N* \n) /</code></pre>
<p>The <code>^^</code> markers ensure that each rule starts at the beginning
of an entire line.</p>
<p>The first character on that line must be either a <code>'&lt;'</code> or a 
<code>'&gt;'</code>. Note that we have to escape these characters since angle
brackets are metacharacters in Perl 6. An alternative would be to use
the &ldquo;literal string&rdquo; metasyntax:</p>
<pre><code>    $deleteline = rx/^^ &lt;'&lt;'&gt; &lt;sp&gt; (\N* \n) /
    $appendline = rx/^^ &lt;'&gt;'&gt; &lt;sp&gt; (\N* \n) /</code></pre>
<p>That is, angle brackets with a single-quoted string inside them match
the string's sequence of characters as literals (including whitespace
and other metatokens).</p>
<p>Or we could have used the quotemeta metasyntax (<code>\Q[...]</code>):</p>
<pre><code>    $deleteline = rx/^^ \Q[&lt;] &lt;sp&gt; (\N* \n) /
    $appendline = rx/^^ \Q[&gt;] &lt;sp&gt; (\N* \n) /</code></pre>
<p>Note that Perl 5's <code>\Q...\E</code> construct is replaced in Perl 6 by 
just the <code>\Q</code> marker, which now takes a group after it.</p>
<p>We could also have used a single-letter character class:</p>
<pre><code>    $deleteline = rx/^^ &lt;[&lt;]&gt; &lt;sp&gt; (\N* \n) /
    $appendline = rx/^^ &lt;[&gt;]&gt; &lt;sp&gt; (\N* \n) /</code></pre>
<p>or even a named character (<code>\c[CHAR NAME HERE]</code>):</p>
<pre><code>    $deleteline = rx/^^ \c[LEFT ANGLE BRACKET] &lt;sp&gt; (\N* \n) /
    $appendline = rx/^^ \c[RIGHT ANGLE BRACKET] &lt;sp&gt; (\N* \n) /</code></pre>
<p>Whether any of those MTOWTDI is better than just escaping the angle bracket is,
of course, a matter of personal taste.</p>
<hr />
<h3><a name="the_final_frontier">The final frontier</a></h3>
<p>After the leading angle, a single literal space is expected. Again, we
could have specified that by escapology (<code>\&nbsp;</code>) or literalness
(<code>&lt;'&nbsp;'&gt;</code>) or quotemetaphysics (<code>\Q[&nbsp;]</code>) or character classification
(<code>&lt;[&nbsp;]&gt;</code>), or deterministic nomimalism (<code>\c[SPACE]</code>), but Perl 6
also gives us a simple <em>name</em> for the space character: <code>&lt;sp&gt;</code>.
This is the preferred option, since it reduces line-noise and makes the
significant space much harder to miss.</p>
<p>Perl 6 provides predefined names for other useful subpatterns as
well, including:</p>
<dl>
<dt><strong><a name="item_%3Cdot%3E"><code>&lt;dot&gt;</code></a></strong><br /></dt>
<dd>
<p>which matches a literal dot (<code>'.'</code>) character (i.e. it's a more elegant 
synonym for <code>\.</code>);</p></dd>
<dt><strong><a name="item_%3Clt%3E_and_%3Cgt%3E"><code>&lt;lt&gt;</code> and <code>&lt;gt&gt;</code></a></strong><br /></dt>
<dd><p>which match a literal <code>'&lt;'</code> and <code>'&gt;'</code> respectively. These
give us yet another way of writing:</p>
<pre><code>    $deleteline = rx/^^ &lt;lt&gt; &lt;sp&gt; (\N* \n) /
    $appendline = rx/^^ &lt;gt&gt; &lt;sp&gt; (\N* \n) /</code></pre>
</dd>
<dt><strong><a name="item_%3Cws%3E"><code>&lt;ws&gt;</code></a></strong><br /></dt>
<dd>
which matches any sequence of whitespace (i.e. it's a more elegant
synonym for <code>\s+</code>). Optional whitespace is, therefore, specified
as <code>&lt;ws&gt;?</code> or <code>&lt;ws&gt;*</code> (Perl 6 will accept either);</dd>
<dt><strong><a name="item_%3Calpha%3E"><code>&lt;alpha&gt;</code></a></strong><br /></dt>
<dd>
which matches a single alphabetic character (i.e. it's like the
character class <code>&lt;[A-Za-z]&gt;</code> but it handles accented characters
and alphabetic characters from non-Roman scripts as well);</dd>
<dt><strong><a name="item_%3Cident%3E"><code>&lt;ident&gt;</code></a></strong><br /></dt>
<dd>
which is a short-hand for <code>[ [&lt;alpha&gt;|_] \w* ]</code> (i.e. a
standard identifier in many languages, including Perl)</dd>
</dl>
<p>Using named subpatterns like these makes rules clearer in intent,
easier to read, and more self-documenting. And, as we'll see
<a href="#what's in a name">shortly</a>, they're fully generalizable...we
can create our own.</p>
<hr />
<h3><a name="matchmaker_matchmaker">Match-maker, match-maker...</a></h3>
<p>Finally, we're ready to actually read in and match a diff file. In Perl 5, we'd
do that like so:</p>
<pre><code>    # Perl 5</code></pre>
<pre><code>    local $/;          # Disable input record separator (enable slurp mode)
    my $text = &lt;&gt;;     # Slurp up input stream into $text</code></pre>
<pre><code>    print &quot;Valid diff&quot; 
        if $text =~ /$file/;</code></pre>
<p>We could do the same thing in Perl 6 (though the syntax would differ
slightly) and in this case that would be fine. But, in general, it's
clunky to have to slurp up the entire input before we start matching.
The input might be huge, and we might fail early. Or we
might want to match input interactively (and issue an error message as
soon as the input fails to match). Or we might be matching a series of
different formats. Or we might want to be able to leave the input stream
in its original state if the match fails.</p>
<p>The inability to do pattern matches immediately on an input stream is one of
Perl 5's few weaknesses when it comes to text processing. Sure, we can read
line-by-line and apply pattern matching to each line, but trying to
match a construct that may be laid out across an unknown number of lines
is just painful.</p>
<p>Not in Perl 6 though. In Perl 6, we can bind an input stream to a scalar
variable (i.e. like a Perl 5 tied variable) and then just match on the
characters in that stream as if they were already in memory:</p>
<pre><code>    my $text is from($*ARGS);       # Bind scalar to input stream</code></pre>
<pre><code>    print &quot;Valid diff&quot; 
        if $text =~ /&lt;$file&gt;/;      # Match against input stream</code></pre>
<p>The important point is that, after the match, only those characters that
the pattern actually matched will have been removed from the input stream.</p>
<p>It may also be possible to skip the variable entirely and just write:</p>
<pre><code>    print &quot;Valid diff&quot; 
        if $*ARGS =~ /&lt;$file&gt;/;     # Match against input stream</code></pre>
<p>or:</p>
<pre><code>    print &quot;Valid diff&quot; 
        if &lt;&gt; =~ /&lt;$file&gt;/;         # Match against input stream</code></pre>
<p>but that's yet to be decided.</p>
<hr />
<h3><a name="a_cleaner_approach">A cleaner approach</a></h3>
<p>The previous example solves the problem of recognizing a valid diff file quite
nicely (and with only six rules!), but it does so by cluttering
up the program with a series of variables storing those precompiled patterns.</p>
<p>It's as if we were to write a collection of subroutines like this:</p>
<pre><code>    my $print_name = sub ($data) { print $data{name}, &quot;\n&quot;; };
    my $print_age  = sub ($data) { print $data{age}, &quot;\n&quot;; };
    my $print_addr = sub ($data) { print $data{addr}, &quot;\n&quot;; };</code></pre>
<pre><code>    my $print_info = sub ($data) {
        $print_name($data);
        $print_age($data);
        $print_addr($data);
    };</code></pre>
<pre><code>    # and later...</code></pre>
<pre><code>    $print_info($info);</code></pre>
<p>You <em>could</em> do it that way, but it's not the right way to do it.
The right way to do it is as a collection of named subroutines or methods,
often collected together in the namespace of a class or module:</p>
<pre><code>    module Info {</code></pre>
<pre><code>        sub print_name ($data) { print $data{name}, &quot;\n&quot;; }
        sub print_age ($data)  { print $data{age}, &quot;\n&quot;; }
        sub print_addr ($data) { print $data{addr}, &quot;\n&quot;; }</code></pre>
<pre><code>        sub print_info ($data) {
            print_name($data);
            print_age($data);
            print_addr($data);
        }
    }</code></pre>
<pre><code>    Info::print_info($info);</code></pre>
<p>So it is with Perl 6 patterns. You <em>can</em> write them as a series of
pattern objects created at run-time, but they're much better specified as 
a collection of named patterns, collected together at compile-time
in the namespace of a grammar.</p>
<p>Here's the previous diff-parsing example rewritten that way
(and with a few extra bells-and-whistles added in):</p>
<pre><code>    grammar Diff {
        rule file { ^  &lt;hunk&gt;*  $ }</code></pre>
<pre><code>        rule hunk :i { 
            [ &lt;linenum&gt; a :: &lt;linerange&gt; \n
              &lt;appendline&gt;+ 
            |
              &lt;linerange&gt; d :: &lt;linenum&gt; \n
              &lt;deleteline&gt;+
            |
              &lt;linerange&gt; c :: &lt;linerange&gt; \n
              &lt;deleteline&gt;+
              --- \n
              &lt;appendline&gt;+
            ]
          |
            &lt;badline(&quot;Invalid diff hunk&quot;)&gt;
        }</code></pre>
<pre><code>        rule badline ($errmsg) { (\N*) ::: { fail &quot;$errmsg: $1&quot; }</code></pre>
<pre><code>        rule linerange { &lt;linenum&gt; , &lt;linenum&gt;
                       | &lt;linenum&gt;
                       }</code></pre>
<pre><code>        rule linenum { \d+ }</code></pre>
<pre><code>        rule deleteline { ^^ &lt;out_marker&gt; (\N* \n) }
        rule appendline { ^^ &lt;in_marker&gt;  (\N* \n) }</code></pre>
<pre><code>        rule out_marker { \&lt;  &lt;sp&gt; }
        rule in_marker  { \&gt;  &lt;sp&gt; }
    }</code></pre>
<pre><code>    # and later...</code></pre>
<pre><code>    my $text is from($*ARGS);</code></pre>
<pre><code>    print &quot;Valid diff&quot; 
        if $text =~ /&lt;Diff.file&gt;/;</code></pre>
<hr />
<h3><a name="whats_in_a_name">What's in a name?</a></h3>
<p>The <code>grammar</code> declaration creates a new namespace for rules
(in the same way a <code>class</code> or <code>module</code> declaration creates
a new namespace for methods or subroutines). If a block is
specified after the grammar's name:</p>
<pre><code>    grammar HTML {</code></pre>
<pre><code>        rule file :iw { \Q[&lt;HTML&gt;]  &lt;head&gt;  &lt;body&gt;  \Q[&lt;/HTML&gt;] }</code></pre>
<pre><code>        rule head :iw { \Q[&lt;HEAD&gt;]  &lt;head_tag&gt;+  \Q[&lt;HEAD&gt;] }</code></pre>
<pre><code>        # etc.</code></pre>
<pre><code>    } # Explicit end of HTML grammar</code></pre>
<p>then that new namespace is confined to that block. Otherwise the
namespace continues until the end of the source section of the
current file:</p>
<pre><code>    grammar HTML;</code></pre>
<pre><code>    rule file :iw { \Q[&lt;HTML&gt;]  &lt;head&gt;  &lt;body&gt;  \Q[&lt;/HTML&gt;] }</code></pre>
<pre><code>    rule head :iw { \Q[&lt;HEAD&gt;]  &lt;head_tag&gt;+  \Q[&lt;HEAD&gt;] }</code></pre>
<pre><code>    # etc.</code></pre>
<pre><code>    # Implicit end of HTML grammar
    __END__</code></pre>
<p>Note that, as with the blockless variants on <code>class</code> and <code>module</code>,
this form of the syntax is designed to simplify one-namespace-per-file
situations. It's a compile-time error to put two or more blockless
grammars, classes or modules in a single file.</p>
<p>Within the namespace, named rules are defined using the <code>rule</code>
declarator. It's analogous to the <code>sub</code> declarator within a 
module, or the <code>method</code> declarator within a class. Just like
a class method, a named rule has to be invoked through its grammar
if we refer to it outside its own namespace. That's why the actual
match became:</p>
<pre><code>    $text =~ /&lt;Diff.file&gt;/;         # Invoke through grammar</code></pre>
<p>If we want to match a named rule, we put the name in angle brackets.
Indeed, many of the constructs we've already seen -- <code>&lt;sp&gt;</code>,
<code>&lt;ws&gt;</code>, <code>&lt;ident&gt;</code>, <code>&lt;alpha&gt;</code>, <code>&lt;commit&gt;</code> --
are really just predefined named rules that come standard with Perl 6.</p>
<p>Like subroutines and methods, within their own namespace, rules don't
have to be qualified. Which is why we can write things like:</p>
<pre><code>    rule linerange { &lt;linenum&gt; , &lt;linenum&gt;
                   | &lt;linenum&gt;
                   }</code></pre>
<p>instead of:</p>
<pre><code>    rule linerange { &lt;Diff.linenum&gt; , &lt;Diff.linenum&gt;
                   | &lt;Diff.linenum&gt;
                   }</code></pre>
<p>Using named rules has several significant advantages, apart from making
the patterns look cleaner. For one thing, the compiler may be able to
optimize the embedded named rules better. For example, it could inline
the attempts to match <code>&lt;linenum&gt;</code> within the <code>linerange</code> rule. In
the <code>rx</code> version:</p>
<pre><code>    $linerange = rx{ &lt;$linenum&gt; , &lt;$linenum&gt;
                   | &lt;$linenum&gt;
                   };</code></pre>
<p>that's not possible, since the pattern matching mechanism won't know
what's in <code>$linenum</code> until it actually tries to perform the match.</p>
<p>By the way, we <em>can</em> still use interpolated <code>&lt;$subrule&gt;</code>-ish 
subpatterns in a named rule, and we can use named subpatterns
in an <code>rx</code>-ish rule. The difference between <code>rule</code> and <code>rx</code>
is just that a <code>rule</code> can have a name and must use <code>{...}</code> as its
delimiters, whereas an <code>rx</code> doesn't have a name and can use
any allowed delimiters.</p>
<hr />
<h3><a name="bad_line_no_match">Bad line! No match!</a></h3>
<p>This version of the diff parser has an additional rule, named <code>badline</code>.
This rule illustrates another similarity between rules and subroutines/methods:
rules can take arguments. The <code>badline</code> rule factors out the error message
creation at the end of the <code>hunk</code> rule. Previously that rule ended with:</p>
<pre><code>    |  (\N*) ::: { fail &quot;Invalid diff hunk: $1&quot; }</code></pre>
<p>but in this version it ends with:</p>
<pre><code>    |  &lt;badline(&quot;Invalid diff hunk&quot;)&gt;</code></pre>
<p>That's a much better abstraction of the error condition. It's easier to
understand and easier to maintain, but it does require us to be able to pass
an argument (the error message) to the new <code>badline</code> subrule. To do
that, we simply declare it to have a parameter list:</p>
<pre><code>    rule badline($errmsg) { (\N*) ::: { fail &quot;$errmsg: $1&quot; }</code></pre>
<p>Note the strong syntactic parallel with a subroutine definition:</p>
<pre><code>    sub  subname($param)  { ... }</code></pre>
<p>The argument is passed to a subrule by placing it in parentheses
after the rule name within the angle brackets:</p>
<pre><code>    |  &lt;badline(&quot;Invalid diff hunk&quot;)&gt;</code></pre>
<p>The argument can also be passed without the parentheses, but then
it is interpreted as if it were the body of a separate rule:</p>
<pre><code>    rule list_of ($pattern) { 
            &lt;$pattern&gt; [ , &lt;$pattern&gt; ]*
    }</code></pre>
<pre><code>    # and later...</code></pre>
<pre><code>    $str =~ m:w/  \[                  # Literal opening square bracket
                  &lt;list_of \w\d+&gt;     # Call list_of subrule passing rule rx/\w\d+/
                  \]                  # Literal closing square bracket
               /;</code></pre>
<p>A rule can take as many arguments as it needs to:</p>
<pre><code>    rule seplist($elem, $sep) {
            &lt;$elem&gt;  [ &lt;$sep&gt; &lt;$elem&gt; ]*
    }</code></pre>
<p>and those arguments can also be passed by name, using the standard
Perl 6 pair-based mechanism (as described in Apocalypse 3).</p>
<pre><code>    $str =~ m:w/
                \[                                      # literal left square bracket
                &lt;seplist(sep=&gt;&quot;:&quot;, elem=&gt;rx/&lt;ident&gt;/)&gt;  # colon-separated list of identifiers
                \]                                      # literal right square bracket
               /;</code></pre>
<p>Note that the list's element specifier is itself an anonymous rule,
which the <code>seplist</code> rule will subsequently interpolate as a pattern (because
the <code>$elem</code> parameter appears in angle brackets within <code>seplist</code>).</p>
<hr />













<p><em>Editor's note: this document is out of date and remains here for historic interest.  See <a href="http://dev.perl.org/perl6/doc/design/syn/S05.html">Synopsis 5</a> for the current design information.</p>

<h3><a name="thinking_ahead">Thinking ahead</a></h3>
<p>The only other change in the grammar version of the diff parser is that
the matching of the <code>'&lt;'</code> and <code>'&gt;'</code> at the start of the context 
lines has been factored out. Whereas before we had:</p>
<pre><code>    $deleteline = rx/^^ \&lt; &lt;sp&gt; (\N* \n) /
    $appendline = rx/^^ \&gt; &lt;sp&gt; (\N* \n) /</code></pre>
<p>now we have:</p>
<pre><code>    rule deleteline { ^^ &lt;out_marker&gt; (\N* \n) }
    rule appendline { ^^ &lt;in_marker&gt;  (\N* \n) }</code></pre>
<pre><code>    rule out_marker { \&lt;  &lt;sp&gt; }
    rule in_marker  { \&gt;  &lt;sp&gt; }</code></pre>
<p>That seems like a step backwards, since it complicated the grammar for
no obvious benefit, but the benefit will be reaped <a href="#different diffs">later</a>
when we discover another type of diff file that uses different
markers for incoming and outgoing lines.</p>
<hr />
<h3><a name="what_you_match_is_what_you_get">What you match is what you get</a></h3>
<p>Both the variable-based and grammatical versions of the code above do a
great job of <em>recognizing</em> a diff, but that's all they do. If we only
want syntax checking, that's fine. But, generally, if we're parsing data
what we really want is to do something useful with it: transform it into
some other syntax, make changes to its contents, or perhaps convert it
to a Perl internal data structure for our program to manipulate.</p>
<p>Suppose we did want to build a hierarchical Perl data structure
representing the diff that the above examples match. What extra
code would we need?</p>
<p>None.</p>
<p>That's right. Whenever Perl 6 matches a pattern, it <em>automatically</em>
builds a &ldquo;result object&rdquo; representing the various components of the
match.</p>
<p>That result object is named <code>$0</code> (the program's name is now
<code>$*PROG</code>) and it's lexical to the scope in which the match occurs. The
result object stores (amongst other things) the complete string matched
by the pattern, and it evaluates to that string when used in a string
context. For example:</p>
<pre><code>    if ($text =~ /&lt;Diff.file&gt;/) {
        $difftext = $0;
    }</code></pre>
<p>That's handy, but not really useful for extracting data structures.
However, in addition, any components within a match that were captured
using parentheses become elements of the object's array attribute, and are
accessible through its array index operator. So,
for example, when a pattern such as:</p>
<pre><code>    rule linenum_plus_comma { (\d+) (,?) };</code></pre>
<p>matches successfully, the array element 1 of the result object 
(i.e. <code>$0[1]</code>) is assigned the result of the first parenthesized
capture (i.e. the digits), whilst the array element 2
(<code>$0[2]</code>) receives the comma. Note that array element
zero of any result object is assigned the complete string that the pattern
matched.</p>
<p>There are also abbreviations for each of the array elements of <code>$0</code>.
<code>$0[1]</code> can also be referred to as...surprise, surprise...<code>$1</code>,
<code>$0[2]</code> can also be referred to as <code>$2</code>, <code>$0[3]</code> as <code>$3</code>, etc. 
Like <code>$0</code>, each of these numeric variables is also lexical to the scope
in which the pattern match occurred.</p>
<p>The parts of a matched string that were matched by a named
subrule become entries in the result object's hash attribute, and are
subsequently accessible through its hash lookup operator.
So, for example, when the pattern:</p>
<pre><code>    rule deleteline { ^^ &lt;out_marker&gt; (\N* \n) }</code></pre>
<p>matches, the result object's hash entry for the key <code>'out_marker'</code> (i.e.
<code>$0{out_marker}</code>) will contain the result object returned by the successful
nested match of the <code>out_marker</code> subrule.</p>
<hr />
<h3><a name="a_hypothetical_solution_to_a_very_real_problem">A hypothetical solution to a very real problem</a></h3>
<p>Named capturing into a hash is very convenient, but it doesn't work so well
for a rule like:</p>
<pre><code>    rule linerange {
          &lt;linenum&gt; , &lt;linenum&gt;
        | &lt;linenum&gt;
    }</code></pre>
<p>The problem is that the hash attribute of the rule's 
<code>$0</code> can only store one entry with the key <code>'linenum'</code>.
So if the <code>&lt;linenum&gt; , &lt;linenum&gt;</code> alternative matches,
then the result object from the second match of
<code>&lt;linenum&gt;</code> will overwrite the entry for the first 
<code>&lt;linenum&gt;</code> match.</p>
<p>The solution to this is a new Perl 6 pattern matching feature known
as &ldquo;hypothetical variables&rdquo;. A hypothetical variable is
a variable that is declared and bound within a pattern match
(i.e. inside a closure within a rule).
The variable is declared, not with a <code>my</code>, <code>our</code>, or <code>temp</code>,
but with the new keyword <code>let</code>, which was chosen because it's what
mathematicians and other philosophers use to indicate a hypothetical
assumption.</p>
<p>Once declared, a hypothetical variable is then bound using the
normal binding operator. For example:</p>
<pre><code>    rule checked_integer {
            (\d+)                   # Match and capture one-or-more digits
            { let $digits := $1 }   # Bind to hypothetical var $digits
            -                       # Match a hyphen
            (\d)                    # Match and capture one digit
            { let $check := $2 }    # Bind to hypothetical var $check
    }</code></pre>
<p>In this example, if a sequence of digits is found, then the <code>$digits</code>
variable is bound to that substring. Then, if the dash and check-digit
are matched, the digit is bound to <code>$check</code>. However, if the dash or
digit is not matched, the match will fail and backtrack through the
closure. This backtracking causes the <code>$digits</code> hypothetical variable
to be automatically <em>un-bound</em>. Thus, if a rule fails to match,
the hypothetical variables within it are not associated with any value.</p>
<p>Each hypothetical variable is really just another name for the
corresponding entry in the result object's hash attribute. So binding
a hypothetical variable like <code>$digits</code> within a rule actually sets the
<code>$0{digits}</code> element of the rule's result object.</p>
<p>So, for example, to distinguish the two line numbers within a
line range:</p>
<pre><code>    rule linerange {
          &lt;linenum&gt; , &lt;linenum&gt;
        | &lt;linenum&gt;
    }</code></pre>
<p>we could bind them to two separate hypothetical variables -- say,
<code>$from</code> and <code>$to</code> -- like so:</p>
<pre><code>    rule linerange {
          (&lt;linenum&gt;)               # Match linenum and capture result as $1
          { let $from := $1 }       # Save result as hypothetical variable
          ,                         # Match comma
          (&lt;linenum&gt;)               # Match linenum and capture result as $2
          { let $to := $2 }         # Save result as hypothetical variable
        |
          (&lt;linenum&gt;)               # Match linenum and capture result as $3
          { let $from := $3 }       # Save result as hypothetical variable
    }</code></pre>
<p>Now our result object has a hash entry <code>$0{from}</code> and (maybe) one for
<code>$0{to}</code> (if the first alternative was the one that matched). In fact,
we could <em>ensure</em> that the result always has a <code>$0{to}</code>, by
setting the corresponding hypothetical variable in the second
alternative as well:</p>
<pre><code>    rule linerange {
          (&lt;linenum&gt;)
          { let $from := $1 }
          ,         
          (&lt;linenum&gt;)
          { let $to := $2 }
        |
          (&lt;linenum&gt;)
          { let $from := $3; let $to := $from }
    }</code></pre>
<p>Problem solved.</p>
<p>But only by introducing a new problem. All that hypothesizing made our
rule ugly and complex. So Perl 6 provides a much prettier short-hand:</p>
<pre><code>    rule linerange {
          $from := &lt;linenum&gt;          # Match linenum rule, bind result to $from
          ,                           # Match comma
          $to := &lt;linenum&gt;            # Match linenum rule, bind result to $to
        |                             # Or...
          $from := $to := &lt;linenum&gt;   # Match linenum rule,
    }                                 #   bind result to both $from and $to</code></pre>
<p>or, more compactly:</p>
<pre><code>    rule linerange {
          $from:=&lt;linenum&gt; , $to:=&lt;linenum&gt;
        | $from:=$to:=&lt;linenum&gt;
    }</code></pre>
<p>If a Perl 6 rule contains a variable that is immediately followed by 
the binding operator (<code>:=</code>), that variable is never interpolated.
Instead, it is treated as a hypothetical variable, and bound to the
result of the next component of the rule (in the above examples,
to the result of the <code>&lt;linenum&gt;</code> subrule match).</p>
<p>You can also use hypothetical arrays and hashes, binding them to
a component that captures repeatedly. For example, we might choose
to name our set of hunks:</p>
<pre><code>    rule file { ^  @adonises := &lt;hunk&gt;*  $ }</code></pre>
<p>collecting all the <code>&lt;hunk&gt;</code> matches into a single array
(which would then be available after the match as <code>$0{'@adonises'}</code>. Note that
the sigil is included in the key in this case).</p>
<p>Or we might choose to bind a hypothetical hash:</p>
<pre><code>    rule config {
        %init :=            # Hypothetically, bind %init to...
            [               # Start of group
                (&lt;ident&gt;)   # Match and capture an identifier
                \h*=\h*     # Match an equals sign with optional horizontal whitespace
                (\N*)       # Match and capture the rest of the line
                \n          # Match the newline
            ]*
    }</code></pre>
<p>where each repetition of the <code>[...]*</code> grouping captures
two substrings on each repetition and converts them to a key/value pair,
which is then added to the hash. The first captured substring in each
repetition becomes the key, and the second captured substring becomes
its associated value. The hypothetical <code>%init</code> hash is also available
through the rule's result object, as <code>$0{'%init'}</code> (again, with the
sigil as part of the key).</p>
<hr />
<h3><a name="the_nesting_instinct">The nesting instinct</a></h3>
<p>Of course, those line number submatches in:</p>
<pre><code>    rule linerange {
          $from:=&lt;linenum&gt; , $to:=&lt;linenum&gt;
        | $from:=$to:=&lt;linenum&gt;
    }</code></pre>
<p>will have returned their own result objects. And it's a reference to those
nested result objects that actually gets stored in <code>linerange</code>'s
<code>$0{from}</code> and <code>$0{to}</code>.</p>
<p>Likewise, in the next higher rule:</p>
<pre><code>    rule hunk :i { 
        [ &lt;linenum&gt; a :: &lt;linerange&gt; \n
          &lt;appendline&gt;+ 
        |
          &lt;linerange&gt; d :: &lt;linenum&gt; \n
          &lt;deleteline&gt;+
        |
          &lt;linerange&gt; c :: &lt;linerange&gt; \n
          &lt;deleteline&gt;+
          --- \n
          &lt;appendline&gt;+
        ]
    };</code></pre>
<p>the match on <code>&lt;linerange&gt;</code> will return <em>its</em> <code>$0</code> object.
So, within the <code>hunk</code> rule, we could access the &ldquo;from&rdquo; digits
of the line range of the hunk as: <code>$0{linerange}{from}</code>.</p>
<p>Likewise, at the highest level:</p>
<pre><code>    rule file { ^  &lt;hunk&gt;*  $ }</code></pre>
<p>we are matching a series of hunks, so the hypothetical <code>$hunk</code>
variable (and hence <code>$0{hunk}</code>) will contain a result object whose array
attribute contains the series of result objects returned by each
individual <code>&lt;hunk&gt;</code> match.</p>
<p>So, for example, we could access the &ldquo;from&rdquo; digits of the line range of
the third hunk as: <code>$0{hunk}[2]{linerange}{from}</code>.</p>
<hr />
<h3><a name="extracting_the_insertions">Extracting the insertions</a></h3>
<p>More usefully, we could locate and print every line in the diff that was
being inserted, regardless of whether it was inserted by an &ldquo;append&rdquo; or
a &ldquo;change&rdquo; hunk. Like so:</p>
<pre><code>    my $text is from($*ARGS);</code></pre>
<pre><code>    if $text =~ /&lt;Diff.file&gt;/ {
        for @{ $0&#x7b;file}{hunk} } -&gt; $hunk
             print @{$hunk{appendline}}
                 if $hunk{appendline};
        }
    }</code></pre>
<p>Here, the <code>if</code> statement attempts to match the text against the pattern
for a diff file. If it succeeds, the <code>for</code> loop grabs the <code>&lt;hunk&gt;*</code>
result object, treats it as an array, and then iterates each hunk match
object in turn into <code>$hunk</code>. The array of append lines for each hunk
match is then printed (if there is in fact a reference to that array in
the hunk).</p>
<hr />
<h3><a name="dont_just_match_there_do_something">Don't just match there; do something!</a></h3>
<p>Because Perl 6 patterns can have arbitrary code blocks inside them, it's
easy to have a pattern actually perform syntax transformations whilst
it's parsing. That's often a useful technique because it allows
us to manipulate the various parts of a hierarchical representation
locally (within the rules that recognize them).</p>
<p>For example, suppose we wanted to &ldquo;reverse&rdquo; the diff file. That is,
suppose we had a diff that specified the changes required to 
transform file A to file B, but we needed the back-transformation
instead: from file B to file A. That's relatively easy to create.
We just turn every &ldquo;append&rdquo; into a &ldquo;delete&rdquo;, every &ldquo;delete&rdquo; into
an &ldquo;append&rdquo;, and reverse every &ldquo;change&rdquo;.</p>
<p>The following code does exactly that:</p>
<pre><code>    grammar ReverseDiff {
        rule file { ^  &lt;hunk&gt;*  $ }</code></pre>
<pre><code>        rule hunk :i { 
            [ &lt;linenum&gt; a :: &lt;linerange&gt; \n
              &lt;appendline&gt;+ 
              { @$appendline =~ s/&lt;in_marker&gt;/&lt; /;
                let $0 := &quot;${linerange}d${linenum}\n&quot;
                        _ join &quot;&quot;, @$appendline;
              }
            |
              &lt;linerange&gt; d :: &lt;linenum&gt; \n
              &lt;deleteline&gt;+
              { @$deleteline =~ s/&lt;out_marker&gt;/&gt; /;
                let $0 := &quot;${linenum}a${linerange}\n&quot;
                        _ join &quot;&quot;, @$deleteline;
              }
            |
              $from:=&lt;linerange&gt; c :: $to:=&lt;linerange&gt; \n
              &lt;deleteline&gt;+
              --- \n
              &lt;appendline&gt;+
              { @$appendline =~ s/&lt;in_marker&gt;/&lt;/;
                @$deleteline =~ s/&lt;out_marker&gt;/&gt;/;
                let $0 := &quot;${to}c${from}\n&quot;
                        _ join(&quot;&quot;, @$appendline)
                        _ &quot;---\n&quot;
                        _ join(&quot;&quot;, @$deleteline);
              }
            ]
          |
            &lt;badline(&quot;Invalid diff hunk&quot;)&gt;
        }</code></pre>
<pre><code>    rule badline ($errmsg) { (\N*) ::: { fail &quot;$errmsg: $1&quot; } }</code></pre>
<pre><code>    rule linerange { $from:=&lt;linenum&gt; , $to:=&lt;linenum&gt;
                       | $from:=$to:=&lt;linenum&gt;
                       }</code></pre>
<pre><code>    rule linenum { (\d+) }</code></pre>
<pre><code>    rule deleteline { ^^ &lt;out_marker&gt; (\N* \n) }
        rule appendline { ^^ &lt;in_marker&gt;  (\N* \n) }</code></pre>
<pre><code>    rule out_marker { \&lt;  &lt;sp&gt; }
        rule in_marker  { \&gt;  &lt;sp&gt; }
    }</code></pre>
<pre><code>    # and later...</code></pre>
<pre><code>    my $text is from($*ARGS);</code></pre>
<pre><code>    print @{ $0&#x7b;file}{hunk} }
        if $text =~ /&lt;Diff.file&gt;/;</code></pre>
<p>The rule definitions for <code>file</code>, <code>badline</code>, <code>linerange</code>, <code>linenum</code>,
<code>appendline</code>, <code>deleteline</code>, <code>in_marker</code> and <code>out_marker</code> are exactly
the same as before.</p>
<p>All the work of reversing the diff is performed in the <code>hunk</code> rule.
To do that work, we have to extend each of the three main alternatives
of that rule, adding to each a closure that changes the result object
it returns.</p>
<hr />
<h3><a name="smarter_alternatives">Smarter alternatives</a></h3>
<p>In the first alternative (which matches &ldquo;append&rdquo; hunks), we match as
before:</p>
<pre><code>    &lt;linenum&gt; a :: &lt;linerange&gt; \n
    &lt;appendline&gt;+</code></pre>
<p>But then we execute an embedded closure:</p>
<pre><code>    { @$appendline =~ s/&lt;in_marker&gt;/&lt;/;
      let $0 := &quot;${linerange}d${linenum}\n&quot;
              _ join &quot;&quot;, @$appendline;
    }</code></pre>
<p>The first line reverses the &ldquo;marker&rdquo; arrows on each line of data that
was previously being appended, using the smart-match operator to
apply the transformation to each line. Note too, that we reuse the
<code>in_marker</code> rule within the substitution.</p>
<p>Then we bind the result object (i.e. the hypothetical variable <code>$0</code>) to
a string representing the &ldquo;reversed&rdquo; append hunk. That is, we reverse the
order of the line range and line number components, put a <code>'d'</code> (for &ldquo;delete&rdquo;)
between them, and then follow that with all the reversed data:</p>
<pre><code>    let $0 := &quot;${linerange}d${linenum}\n&quot;
            _ join &quot;&quot;, @$appendline;</code></pre>
<p>The changes to the &ldquo;delete&rdquo; alternative are exactly symmetrical.
Capture the components as before, reverse the marker arrows,
reverse the <code>$linerange</code> and <code>$linenum</code>, change the <code>'d'</code> to an <code>'a'</code>,
and append the reversed data lines.</p>
<p>In the third alternative:</p>
<pre><code>    $from:=&lt;linerange&gt; c :: $to:=&lt;linerange&gt; \n
    &lt;deleteline&gt;+   
    --- \n
    &lt;appendline&gt;+
    { @$appendline =~ s/&lt;in_marker&gt;/&lt;/;
      @$deleteline =~ s/&lt;out_marker&gt;/&gt;/;
      let $0 := &quot;${to}c${from}\n&quot;
              _ join(&quot;&quot;, @$appendline)
              _ &quot;---\n&quot;
              _ join(&quot;&quot;, @$deleteline);
    }</code></pre>
<p>there are line ranges on both sides of the <code>'c'</code>. So we 
need to give them distinct names, by binding them to extra hypothetical
variables: <code>$from</code> and <code>$to</code>. We then reverse the order of two line
ranges, but leave the <code>'c'</code> as it was (because we're simply changing
something back to how it was previously). The markers on both the append
and delete lines are reversed, and then the order of the two sets of
lines is also reversed.</p>
<p>Once those transformations has been performed on each hunk (i.e. as it's
being matched!), the result of successfully matching any <code>&lt;hunk&gt;</code>
subrule will be a string in which the matched hunk has already been
reversed.</p>
<p>All that remains is to match the text against the grammar, and
print out the (modified) hunks:</p>
<pre><code>    print @{ $0{file}{hunk} }
        if $text =~ /&lt;ReverseDiff.file&gt;/;</code></pre>
<p>And, since the <code>file</code> rule is now in the ReverseDiff grammar's namespace,
we need to call the rule through that grammar. Note the way the
syntax for doing that continues the parallel with methods and classes.</p>
<hr />













<p><em>Editor's note: this document is out of date and remains here for historic interest.  See <a href="http://dev.perl.org/perl6/doc/design/syn/S05.html">Synopsis 5</a> for the current design information.</p>

<h3><a name="rearranging_the_deckchairs">Rearranging the deck-chairs</a></h3>
<p>It might have come as a surprise that we were allowed to bind
the pattern's <code>$0</code> result object directly, but there's nothing magical
about it. <code>$0</code> turns out to be just another hypothetical variable...the
one that happens to be returned when the match is complete.</p>
<p>Likewise, <code>$1</code>, <code>$2</code>, <code>$3</code>, etc. are all hypotheticals, and can also be
explicitly bound in a rule. That's very handy for ensuring that the
right substring always turns up in the right numbered variable. For
example, consider a Perl 6 rule to match simple Perl 5 method calls
(matching <em>all</em> Perl 5 method calls would, of course, require a much
more sophisticated rule):</p>
<pre><code>    rule method_call :w {
        # Match direct syntax:   $var-&gt;meth(...)
        \$  (&lt;ident&gt;)  -\&gt;  (&lt;ident&gt;)  \(  (&lt;arglist&gt;)  \)</code></pre>
<pre><code>      | # Match indirect syntax: meth $var (...)
        (&lt;ident&gt;)  \$  (&lt;ident&gt;)  [ \( (&lt;arglist&gt;) \) | (&lt;arglist&gt;) ]
    }</code></pre>
<pre><code>    my ($varname, methodname, $arglist);</code></pre>
<pre><code>    if ($source_code =~ / $0 := &lt;method_call&gt; /) {
        $varname    = $1 // $5;
        $methodname = $2 // $4;
        $arglist    = $3 // $6 // $7;
    }</code></pre>
<p>By binding the match's <code>$0</code> to the result of the <code>&lt;method_call&gt;</code>
subrule, we bind its <code>$0[1]</code>, <code>$0[2]</code>, <code>$0[3]</code>, etc. to those array
elements in <code>&lt;method_call&gt;</code>'s result object. And thereby bind
<code>$1</code>, <code>$2</code>, <code>$3</code>, etc. as well. Then it's just a matter of sorting
out which numeric variable ended up with which bit of the method call.</p>
<p>That's okay, but it would be much better if we could guarantee that
the variable name was always in <code>$1</code>, the method name in <code>$2</code>,
and the argument list in <code>$3</code>. Then we could replace the last six lines
above with just:</p>
<pre><code>    my ($varname, methodname, $arglist) =
            $source_code =~ / $0 := &lt;method_call&gt; /;</code></pre>
<p>In Perl 5 there was no way to do that, but in Perl 6 it's relatively easy.
We just modify the <code>method_call</code> rule like so:</p>
<pre><code>    rule method_call :w {
        \$  $1:=&lt;ident&gt;  -\&gt;  $2:=&lt;ident&gt;  \( $3:=&lt;arglist&gt; \)
      | $2:=&lt;ident&gt;  \$  $1:=&lt;ident&gt;  [ \( $3:=&lt;arglist&gt; \) | $3:=&lt;arglist&gt; ]
    }</code></pre>
<p>Or, annotated:</p>
<pre><code>    rule method_call :w {
        \$                          #   Match a literal $
        $1:=&lt;ident&gt;                 #   Match the varname, bind it to $1
        -\&gt;                         #   Match a literal -&gt;
        $2:=&lt;ident&gt;                 #   Match the method name, bind it to $2
        \(                          #   Match an opening paren
        $3:=&lt;arglist&gt;               #   Match the arg list, bind it to $3
        \)                          #   Match a closing paren
      |                             # Or
        $2:=&lt;ident&gt;                 #   Match the method name, bind it to $2
        \$                          #   Match a literal $
        $1:=&lt;ident&gt;                 #   Match the varname, bind it to $1
        [                           #   Either...
          \( $3:=&lt;arglist&gt; \)       #     Match arg list in parens, bind it to $3
        |                           #   Or...
             $3:=&lt;arglist&gt;          #     Just match arg list, bind it to $3
        ]
    }</code></pre>
<p>Now the rule's <code>$1</code> is bound to the variable name, regardless of which
alternative matches. Likewise <code>$2</code> is bound to the method name in
either branch of the <code>|</code>, and <code>$3</code> is associated with the argument
list, no matter which of the <em>three</em> possible ways it was matched.</p>
<p>Of course, that's still rather ugly (especially if we have to write all those
comments just so others can understand how clever we were).</p>
<p>So an even better solution is just to use proper named rules (with their
handy auto-capturing behaviour) for everything. And then slice the required
information out of the result object's hash attribute:</p>
<pre><code>    rule varname    { &lt;ident&gt; }
    rule methodname { &lt;ident&gt; }</code></pre>
<pre><code>    rule method_call :w {
        \$  &lt;varname&gt;  -\&gt;  &lt;methodname&gt;  \( &lt;arglist&gt; \)
      | &lt;methodname&gt;  \$  &lt;varname&gt;  [ \( &lt;arglist&gt; \) | &lt;arglist&gt; ]
    }</code></pre>
<pre><code>    $source_code =~ / &lt;method_call&gt; /;</code></pre>
<pre><code>    my ($varname, $methodname, $arglist) =
            $0{method_call}{&quot;varname&quot;,&quot;methodname&quot;,&quot;arglist&quot;}</code></pre>
<hr />
<h3><a name="deriving_a_benefit">Deriving a benefit</a></h3>
<p>As the above examples illustrate, using named rules in grammars provides
a cleaner syntax and a reduction in the number of variables required in a
parsing program. But, beyond those advantages, and the obvious benefits
of moving rule construction from run-time to compile-time, there's yet
another significant way to gain from placing named rules inside a grammar: we
can <em>inherit</em> from them.</p>
<p>For example, the ReverseDiff grammar is almost the same as the
normal Diff grammar. The only difference is in the <code>hunk</code> rule.
So there's no reason why we shouldn't just have ReverseDiff inherit
all that sameness, and simply redefine its notion of <code>hunk</code>-iness.
That would look like this:</p>
<pre><code>    grammar ReverseDiff is Diff {</code></pre>
<pre><code>        rule hunk :i { 
            [ &lt;linenum&gt; a :: &lt;linerange&gt; \n
              &lt;appendline&gt;+ 
              { $appendline =~ s/ &lt;in_marker&gt; /&lt;/;
                let $0 := &quot;${linerange}d${linenum}\n&quot;
                        _ join &quot;&quot;, @$appendline;
              }
            |
              &lt;linerange&gt; d :: &lt;linenum&gt; \n
              &lt;deleteline&gt;+
              { $deleteline =~ s/ &lt;out_marker&gt; /&gt;/;
                let $0 := &quot;${linenum}a${linerange}\n&quot;
                        _ join &quot;&quot;, @$deleteline;
              }
            |
              $from:=&lt;linerange&gt; c :: $to:=&lt;linerange&gt; \n
              &lt;deleteline&gt;+
              --- \n
              &lt;appendline&gt;+
              { $appendline =~ s/ &lt;in_marker&gt; /&lt;/;
                $deleteline =~ s/ &lt;out_marker&gt; /&gt;/;
                let $0 := &quot;${to}c${from}\n&quot;
                        _ join(&quot;&quot;, @$appendline)
                        _ &quot;---\n&quot;
                        _ join(&quot;&quot;, @$deleteline);
              }
            ]
          |
            &lt;badline(&quot;Invalid diff hunk&quot;)&gt;
        }
    }</code></pre>
<p>The <code>ReverseDiff is Diff</code> syntax is the standard Perl 6 way of 
inheriting behaviour. Classes will use the same notation:</p>
<pre><code>    class Hacker is Programmer {...}
    class JAPH is Hacker {...}
    # etc.</code></pre>
<p>Likewise, in the above example Diff is specified as the base grammar
from which the new ReverseDiff grammar is derived. As a result of that
inheritance relationship, ReverseDiff immediately inherits all of the
Diff grammar's rules. We then simple redefine ReverseDiff's version of
the <code>hunk</code> rule, and the job's done.</p>
<hr />
<h3><a name="different_diffs">Different diffs</a></h3>
<p>Grammatical inheritance isn't only useful for tweaking the behaviour of
a grammar's rules. It's also handy when two or more related grammars
share some characteristics, but differ in some particulars. For example,
suppose we wanted to support the &ldquo;unified&rdquo; diff format, as well as the
&ldquo;classic&rdquo;.</p>
<p>A unified diff consists of two lines of header information, followed by
a series of hunks. The header information indicates the name and
modification date of the old file (prefixing the line with three minus
signs), and then the name and modification date of the new file
(prefixing that line with three plus signs). Each hunk consists of an
offset line, followed by one or more lines representing either shared
context, or a line to be inserted, or a line to be deleted. Offset lines
start with two &ldquo;at&rdquo; signs, then consist of a minus sign followed by the
old line offset and line-count, and then a plus sign followed by the
nes line offset and line-count, and then two more &ldquo;at&rdquo; signs. Context
lines are prefixed with two spaces. Insertion lines are prefixed with a
plus sign and a space. Deletion lines are prefixed with a minus sign
and a space.</p>
<p>But that's not important right now.</p>
<p>What <em>is</em> important is that we could write another complete grammar for
that, like so:</p>
<pre><code>    grammar Diff::Unified {</code></pre>
<pre><code>        rule file { ^  &lt;fileinfo&gt;  &lt;hunk&gt;*  $ }</code></pre>
<pre><code>        rule fileinfo {
            &lt;out_marker&gt;&lt;3&gt; $oldfile:=(\S+) $olddate:=[\h* (\N+?) \h*?] \n
            &lt;in_marker&gt;&lt;3&gt;  $newfile:=(\S+) $newdate:=[\h* (\N+?) \h*?] \n
        }</code></pre>
<pre><code>        rule hunk { 
            &lt;header&gt;
            @spec := ( &lt;contextline&gt;
                     | &lt;appendline&gt;
                     | &lt;deleteline&gt;
                     | &lt;badline(&quot;Invalid line for unified diff&quot;)&gt;
                     )*
        }</code></pre>
<pre><code>        rule header {
            \@\@ &lt;out_marker&gt; &lt;linenum&gt; , &lt;linecount&gt; \h+
                 &lt;in_marker&gt;  &lt;linenum&gt; , &lt;linecount&gt; \h+
            \@\@ \h* \n
        }</code></pre>
<pre><code>        rule badline ($errmsg) { (\N*) ::: { fail &quot;$errmsg: $1&quot; } }</code></pre>
<pre><code>        rule linenum   { (\d+) }
        rule linecount { (\d+) }</code></pre>
<pre><code>        rule deleteline  { ^^ &lt;out_marker&gt; (\N* \n) }
        rule appendline  { ^^ &lt;in_marker&gt;  (\N* \n) }
        rule contextline { ^^ &lt;sp&gt; &lt;sp&gt;    (\N* \n) }</code></pre>
<pre><code>        rule out_marker { \+ &lt;sp&gt; }
        rule in_marker  {  - &lt;sp&gt; }
    }</code></pre>
<p>That represents (and can parse) the new diff format correctly,
but it's a needless duplication of effort and code. Many the rules of
this grammar are identical to those of the original diff parser. Which
suggests we could just grab them straight from the original -- by
inheriting them:</p>
<pre><code>    grammar Diff::Unified is Diff  {</code></pre>
<pre><code>        rule file { ^  &lt;fileinfo&gt;  &lt;hunk&gt;*  $ }</code></pre>
<pre><code>        rule fileinfo {
            &lt;out_marker&gt;&lt;3&gt; $newfile:=(\S+) $olddate:=[\h* (\N+?) \h*?] \n
            &lt;in_marker&gt;&lt;3&gt;  $newfile:=(\S+) $newdate:=[\h* (\N+?) \h*?] \n
        }</code></pre>
<pre><code>        rule hunk { 
            &lt;header&gt;
            @spec := ( &lt;contextline&gt;
                     | &lt;appendline&gt;
                     | &lt;deleteline&gt;
                     | &lt;badline(&quot;Invalid line for unified diff&quot;)&gt;
                     )*
        }</code></pre>
<pre><code>        rule header {
            \@\@ &lt;out_marker&gt; &lt;linenum&gt; , &lt;linecount&gt; \h+
                 &lt;in_marker&gt;  &lt;linenum&gt; , &lt;linecount&gt; \h+
            \@\@ \h* \n
        }</code></pre>
<pre><code>        rule linecount { (\d+) }</code></pre>
<pre><code>        rule contextline { ^^ &lt;sp&gt; &lt;sp&gt;  (\N* \n) }</code></pre>
<pre><code>        rule out_marker { \+ &lt;sp&gt; }
        rule in_marker  {  - &lt;sp&gt; }
    }</code></pre>
<p>Note that in this version we don't need to specify the rules for
<code>appendline</code>, <code>deleteline</code>, <code>linenum</code>, etc. They're provided
automagically by inheriting from the <code>Diff</code> grammar. So we only have to
specify the parts of the new grammar that differ from the original.</p>
<p>In particular, this is where we finally reap the reward for factoring
out the <code>in_marker</code> and <code>out_marker</code> rules. Because we did that
earlier, we can now just change the rules for matching those two markers
directly in the new grammar. As a result, the inherited <code>appendline</code> and
<code>deleteline</code> rules (which use <code>in_marker</code> and <code>out_marker</code> as
subrules) will now attempt to match the new versions of <code>in_marker</code> and
<code>out_marker</code> rules instead.</p>
<p>And if you're thinking that looks suspiciously like polymorphism, you're
absolutely right. The parallels between pattern matching and OO run
<em>very</em> deep in Perl 6.</p>
<hr />
<h3><a name="lets_get_cooking">Let's get cooking</a></h3>
<p>To sum up: Perl 6 patterns and grammars extend Perl's text matching
capacities enormously. But you don't have to start using all that extra
power right away. You can ignore grammars and embedded closures and
assertions and the other sophisticated bits until you actually need them.</p>
<p>The new rule syntax also cleans up much of the &ldquo;line-noise&rdquo; of Perl 5
regexes. But the fundamentals don't change that much. Many Perl 5
patterns will translate very simply and naturally to Perl 6.</p>
<p>To demonstrate that, and to round out this exploration of Perl 6
patterns, here are a few common Perl 5 regexes -- some borrowed from 
the <em>Perl Cookbook</em>, and others from the Regexp::Common module --
all ported to equivalent Perl 6 rules:</p>
<dl>
<dt><strong><a name="item_Match_a_C_comment%3A">Match a C comment:</a></strong><br /></dt>
<dd>
<pre><code># Perl 5
$str =~ m{ /\* .*? \*/ }xs;</code></pre>
<pre><code># Perl 6
$str =~ m{ /\* .*? \*/ };</code></pre>
</dd>
<dt><strong><a name="item_Remove_leading_qualifiers_from_a_Perl_identifier">Remove leading qualifiers from a Perl identifier</a></strong><br /></dt>
<dd>
<pre><code># Perl 5
$ident =~ s/^(?:\w*::)*//;</code></pre>
<pre><code># Perl 6
$ident =~ s/^[\w*\:\:]*//;</code></pre></dd>
<dt><strong><a name="item_Warn_of_text_with_lines_greater_than_80_characters">Warn of text with lines greater than 80 characters</a></strong><br /></dt>
<dd>
<pre><code># Perl 5
warn &quot;Thar she blows!: $&amp;&quot;
        if $str =~ m/.{81,}/;</code></pre>
<pre><code># Perl 6
warn &quot;Thar she blows!: $0&quot;
        if $str =~ m/\N&lt;81,&gt;/;</code></pre></dd>
<dt><strong><a name="item_Match_a_Roman_numeral">Match a Roman numeral</a></strong><br /></dt>
<dd>
<pre><code># Perl 5
$str =~ m/ ^ m* (?:d?c{0,3}|c[dm]) (?:l?x{0,3}|x[lc]) (?:v?i{0,3}|i[vx]) $ /ix;</code></pre>
<pre><code># Perl 6
$str =~ m:i/ ^ m* [d?c&lt;0,3&gt;|c&lt;[dm]&gt;] [l?x&lt;0,3&gt;|x&lt;[lc]&gt;] [v?i&lt;0,3&gt;|i&lt;[vx]&gt;] $ /;</code></pre></dd>
<dt><strong><a name="item_Extract_lines_regardless_of_line_terminator">Extract lines regardless of line terminator</a></strong><br /></dt>
<dd>
<pre><code># Perl 5
push @lines, $1
        while $str =~ m/\G([^\012\015]*)(?:\012\015?|\015\012?)/gc;</code></pre>
<pre><code># Perl 6
push @lines, $1
        while $str =~ m:c/ (\N*) \n /;</code></pre>
<dt><strong><a name="item_string">Match a quote-delimited string (Friedl-style), capturing contents:</a></strong><br /></dd>
<dd>
<pre><code># Perl 5
$str =~ m/ &quot; ( [^\\&quot;]* (?: \\. [^\\&quot;]* )* ) &quot; /x;</code></pre>
<pre><code># Perl 6
$str =~ m/ &quot; ( &lt;-[\\&quot;]&gt;* [ \\. &lt;-[\\&quot;]&gt;* ]* ) &quot; /;</code></pre>
<dt><strong><a name="item_Match_a_decimal_IPv4_address%3A">Match a decimal IPv4 address:</a></strong><br /></dd>
<dd>
<pre><code># Perl 5
my $quad = qr/(?: 25[0-5] | 2[0-4]\d | [0-1]??\d{1,2} )/x;</code></pre>
<pre><code>$str =~ m/ $quad \. $quad \. $quad \. $quad /x;</code></pre>
<pre><code># Perl 6
rule quad {  (\d&lt;1,3&gt;) :: { fail unless $1 &lt; 256 }  }</code></pre>
<pre><code>$str =~ m/ &lt;quad&gt; &lt;dot&gt; &lt;quad&gt; &lt;dot&gt; &lt;quad&gt; &lt;dot&gt; &lt;quad&gt; /x;</code></pre>
<pre><code># Perl 6 (same great approach, now less syntax)
rule quad {  (\d&lt;1,3&gt;) :: &lt;($1 &lt; 256)&gt;  }</code></pre>
<pre><code>$str =~ m/ &lt;quad&gt; &lt;dot&gt; &lt;quad&gt; &lt;dot&gt; &lt;quad&gt; &lt;dot&gt; &lt;quad&gt; /x;</code></pre></dd>
<dt><strong><a name="item_Match_a_floating%2Dpoint_number%2C_returning_compo">Match a floating-point number, returning components:</a></strong><br /></dt>
<dd>
<pre><code># Perl 5
($sign, $mantissa, $exponent) =
        $str =~ m/([+-]?)([0-9]+\.?[0-9]*|\.[0-9]+)(?:e([+-]?[0-9]+))?/;</code></pre>
<pre><code># Perl 6
($sign, $mantissa, $exponent) =
        $str =~ m/(&lt;[+-]&gt;?)(&lt;[0-9]&gt;+\.?&lt;[0-9]&gt;*|\.&lt;[0-9]&gt;+)[e(&lt;[+-]&gt;?&lt;[0-9]&gt;+)]?/;</code></pre></dd>
<dt><strong><a name="item_Match_a_floating%2Dpoint_number_maintainably%2C_re">Match a floating-point number <em>maintainably</em>, returning components:</a></strong><br /></dt>
<dd>
<pre><code># Perl 5
my $digit    = qr/[0-9]/;
my $sign_pat = qr/(?: [+-]? )/x;
my $mant_pat = qr/(?: $digit+ \.? $digit* | \. digit+ )/x;
my $expo_pat = qr/(?: $signpat $digit+ )? /x;</code></pre>
<pre><code>($sign, $mantissa, $exponent) =
        $str =~ m/ ($sign_pat) ($mant_pat) (?: e ($expo_pat) )? /x;</code></pre>
<pre><code># Perl 6
rule sign     { &lt;[+-]&gt;? }
rule mantissa { &lt;digit&gt;+ [\. &lt;digit&gt;*] | \. &lt;digit&gt;+ }
rule exponent { [ &lt;sign&gt; &lt;digit&gt;+ ]? }</code></pre>
<pre><code>($sign, $mantissa, $exponent) = 
        $str =~ m/ (&lt;sign&gt;) (&lt;mantissa&gt;) [e (&lt;exponent&gt;)]? /;</code></pre>
<dt><strong><a name="item_Match_nested_parentheses%3A">Match nested parentheses:</a></strong><br /></dt>
<dd>
<pre><code># Perl 5
our $parens = qr/ \(  (?: (?&gt;[^()]+) | (??{$parens}) )*  \) /x;
$str =~ m/$parens/;</code></pre>
<pre><code># Perl 6
$str =~ m/ \(  [ &lt;-[()]&gt; + : | &lt;self&gt; ]*  \) /;</code></pre></dd>
<dt><strong><a name="item_Match_nested_parentheses_maintainably%3A">Match nested parentheses <em>maintainably</em>:</a></strong><br /></dt>
<dd>
<pre><code># Perl 5
our $parens = qr/
           \(                   # Match a literal '('
           (?:                  # Start a non-capturing group
               (?&gt;              #     Never backtrack through...
                   [^()] +      #         Match a non-paren (repeatedly)
               )                #     End of non-backtracking region
           |                    # Or
               (??{$parens})    #    Recursively match entire pattern
           )*                   # Close group and match repeatedly
           \)                   # Match a literal ')'
         /x;</code></pre>
<pre><code>$str =~ m/$parens/;</code></pre>
<pre><code># Perl 6
$str =~ m/ &lt;'('&gt;                # Match a literal '('
           [                    # Start a non-capturing group
                &lt;-[()]&gt; +       #    Match a non-paren (repeatedly)
                :               #    ...and never backtrack that match
           |                    # Or
                &lt;self&gt;          #    Recursively match entire pattern
           ]*                   # Close group and match repeatedly
           &lt;')'&gt;                # Match a literal ')'
         /;</code></pre></dd>
</dl>
<br />

<hr size="1" noshade />

<p>Return to the <a href="/">Perl.com</a>.</p>



        </div>



    </div>
    <div class="asset-footer"></div>
</div>


                            
                            <div id="entry-1342" class="entry-asset asset hentry">
    <div class="asset-header">
        <h2 class="asset-name entry-title"><a href="/pub/2002/08/20/perlandlwp.html" rel="bookmark">Web Basics with LWP</a></h2>
        <div class="asset-meta">
            <span class="byline">
    
                By <span class="vcard author">Sean M. Burke</span> on <abbr class="published" title="2002-08-20T00:00:00-08:00">August 20, 2002 12:00 AM</abbr>
    
            </span>

            
            

        </div>
    </div>
    <div class="asset-content entry-content">

        <div class="asset-body">
            <!-- sidebar begins --><!-- don't move sidebars --><!-- sidebar ends --><p><em>Sean M. Burke is the author of <a href="http://www.oreilly.com/catalog/perllwp/">Perl&nbsp;&amp;&nbsp;LWP</a></em></p><h2>Introduction</h2><p>LWP (short for "Library for WWW in Perl") is a popular group of Perl modules for accessing data on the Web. Like most Perl module-distributions, each of LWP's component modules comes with documentation that is a complete reference to its interface. However, there are so many modules in LWP that it's hard to know where to look for information on doing even the simplest things.</p><p>Introducing you to using LWP would require a whole book--a book that just happens to exist, called <a href="http://www.oreilly.com/catalog/perllwp/"><i>Perl&nbsp;&amp;&nbsp;LWP</i></a>. This article offers a sampling of recipes that let you perform common tasks with LWP.</p><h3>Getting Documents with LWP::Simple</h3><p>If you just want to access what's at a particular URL, the simplest wayto do it is to use <code>LWP::Simple</code>'s functions.</p><p>In a Perl program, you can call its <code>get($url)</code> function. It will trygetting that URL's content. If it works, then it'll return the content; but if there's some error, it'll return <code>undef</code>.</p><pre><code>  my $url = 'http://freshair.npr.org/dayFA.cfm?todayDate=current';    # Just an example: the URL for the most recent /Fresh Air/ show  use LWP::Simple;  my $content = get $url;  die "Couldn't get $url" unless defined $content;  # Then go do things with $content, like this:  if($content =~ m/jazz/i) {    print "They're talking about jazz today on Fresh Air!\n";  } else {    print "Fresh Air is apparently jazzless today.\n";  }</code></pre><p>The handiest variant on <code>get</code> is <code>getprint</code>, which is useful in Perl one-liners.  If it can get the page whose URL you provide, it sends itto <code>STDOUT</code>; otherwise it complains to <code>STDERR</code>.</p><pre><code>  % perl -MLWP::Simple -e "getprint 'http://cpan.org/RECENT'"</code></pre><p>This is the URL of a plain-text file. It lists new files in CPAN inthe past two weeks.  You can easily make it part of a tidy littleshell command, like this one that mails you the list of new<code>Acme::</code> modules:</p><pre><code>  % perl -MLWP::Simple -e "getprint 'http://cpan.org/RECENT'"  \     | grep "/by-module/Acme" | mail -s "New Acme modules! Joy!" $USER</code></pre><p>There are other useful functions in <code>LWP::Simple</code>, including one function for running a <code>HEAD</code> request on a URL (useful for checking links, or getting the last-revised time of a URL), and two functions forsaving and mirroring a URL to a local file. See the <a href="http://search.cpan.org/author/GAAS/libwww-perl/lib/LWP/Simple.pm">LWP::Simpledocumentation</a> for the full details, or Chapter 2, "Web Basics" of <i>Perl&nbsp;&amp;&nbsp;LWP</i> for more examples.</p><h3>The Basics of the LWP Class Model</h3><p><code>LWP::Simple</code>'s functions are handy for simple cases, but its functionsdon't support cookies or authorization; they don't support setting headerlines in the HTTP request; and generally, they don't support reading header linesin the HTTP response (most notably the full HTTP error message, in case of anerror). To get at all those features, you'll have to use the full LWPclass model.</p><p>While LWP consists of dozens of classes, the two that you have to understand are <code>LWP::UserAgent</code> and <code>HTTP::Response</code>. <code>LWP::UserAgent</code> is a class for "virtual browsers," which you use for performing requests, and <code>HTTP::Response</code> is a class for the responses (or error messages) that you get back from those requests.</p><p>The basic idiom is <code>$response = $browser->get($url)</code>, or fullyillustrated:</p><pre><code>  # Early in your program:    use LWP 5.64; # Loads all important LWP classes, and makes                #  sure your version is reasonably recent.  my $browser = LWP::UserAgent->new;    ...    # Then later, whenever you need to make a get request:  my $url = 'http://freshair.npr.org/dayFA.cfm?todayDate=current';    my $response = $browser->get( $url );  die "Can't get $url -- ", $response->status_line   unless $response->is_success;  die "Hey, I was expecting HTML, not ", $response->content_type   unless $response->content_type eq 'text/html';     # or whatever content-type you're equipped to deal with  # Otherwise, process the content somehow:    if($response->content =~ m/jazz/i) {    print "They're talking about jazz today on Fresh Air!\n";  } else {    print "Fresh Air is apparently jazzless today.\n";  }</code></pre>There are two objects involved: <code>$browser</code>, which holds an object of the class <code>LWP::UserAgent</code>, and then the <code>$response</code> object, which is of the class <code>HTTP::Response</code>. You really need only one browser object per program; but every time you make a request, you get back a new <code>HTTP::Response</code> object, which will have some interesting attributes:<ul><li><p>A status code indicating success or failure (which you can test with <code>$response->is_success</code>).</p></li><li><p>An HTTP status line, which I hope is informative if there is a failure (which you can see with <code>$response->status_line</code>, and which returns something like "404 Not Found").</p></li><li><p>A MIME content-type like "text/html", "image/gif", "application/xml", and so on, which you can see with <code>$response->content_type</code></p></li><li><p>The actual content of the response, in <code>$response->content</code>. If the response is HTML, that's where the HTML source will be; if it's a GIF, then <code>$response->content</code> will be the binary GIF data.</p></li><li><p>And dozens of other convenient and more specific methods that are documented in the docs for <code>HTTP::Response</code>, and its superclasses,<code>HTTP::Message</code> and <code>HTTP::Headers</code>.</p></li></ul><h3>Adding Other HTTP Request Headers</h3><p>The most commonly used syntax for requests is <code>$response = $browser->get($url)</code>, but in truth, you can add extra HTTP headerlines to the request by adding a list of key-value pairs after the URL, like so:</p><pre><code>  $response = $browser->get( $url, $key1, $value1, $key2, $value2, ... );</code></pre><p>For example, here's how to send more Netscape-like headers, in caseyou're dealing with a site that would otherwise reject your request:</p><pre><code>  my @ns_headers = (   'User-Agent' => 'Mozilla/4.76 [en] (Win98; U)',   'Accept' => 'image/gif, image/x-xbitmap, image/jpeg,         image/pjpeg, image/png, */*',   'Accept-Charset' => 'iso-8859-1,*,utf-8',   'Accept-Language' => 'en-US',  );  ...    $response = $browser->get($url, @ns_headers);</code></pre><p>If you weren't reusing that array, you could just go ahead and do this: </p><pre><code>  $response = $browser->get($url,   'User-Agent' => 'Mozilla/4.76 [en] (Win98; U)',   'Accept' => 'image/gif, image/x-xbitmap, image/jpeg,         image/pjpeg, image/png, */*',   'Accept-Charset' => 'iso-8859-1,*,utf-8',   'Accept-Language' => 'en-US',  );</code></pre><p>If you were only going to change the 'User-Agent' line, you could just changethe <code>$browser</code> object's default line from "libwww-perl/5.65" (or the like)to whatever you like, using <code>LWP::UserAgent</code>'s <code>agent</code> method:</p><pre><code>   $browser->agent('Mozilla/4.76 [en] (Win98; U)');</code></pre><h3>Enabling Cookies</h3><p>A default <code>LWP::UserAgent</code> object acts like a browser with its cookiessupport turned off. There are various ways of turning it on, by settingits <code>cookie_jar</code> attribute. A "cookie jar" is an object representinga little database of all the HTTP cookies that a browser can know about. It can correspond to a file on disk (the way Netscape uses its <i>cookies.txt</i> file), or it can be just an in-memory object that starts out empty, and whose collection ofcookies will disappear once the program is finished running.</p><p>To give a browser an in-memory empty cookie jar, you set its <code>cookie_jar</code> attribute like so:</p><pre><code>  $browser->cookie_jar({});</code></pre><p>To give it a copy that will be read from a file on disk, and will be savedto it when the program is finished running, set the <code>cookie_jar</code> attributelike this:</p><pre><code>  use HTTP::Cookies;  $browser->cookie_jar( HTTP::Cookies->new(    'file' => '/some/where/cookies.lwp',        # where to read/write cookies    'autosave' => 1,        # save it to disk when done  ));</code></pre><p>That file will be an LWP-specific format. If you want to access the cookies in your Netscape cookies file, you can use the <code>HTTP::Cookies::Netscape</code> class:</p><pre><code>  use HTTP::Cookies;    # yes, loads HTTP::Cookies::Netscape too    $browser->cookie_jar( HTTP::Cookies::Netscape->new(    'file' => 'c:/Program Files/Netscape/Users/DIR-NAME-HERE/cookies.txt',        # where to read cookies  ));</code></pre><p>You could add an <code>'autosave' => 1</code> line as we did earlier, but attime of writing, it's uncertain whether Netscape might discard some of the cookies you could be writing back to disk.</p><h3>Posting Form Data</h3><p>Many HTML forms send data to their server using an HTTP POST request, whichyou can send with this syntax:</p><pre><code> $response = $browser->post( $url,   [     formkey1 => value1,      formkey2 => value2,      ...   ], );</code></pre>Or if you need to send HTTP headers:<pre><code> $response = $browser->post( $url,   [     formkey1 => value1,      formkey2 => value2,      ...   ],   headerkey1 => value1,    headerkey2 => value2,  );</code></pre><p>For example, the following program makes a search request to AltaVista(by sending some form data via an HTTP POST request), and extracts fromthe HTML the report of the number of matches:</p><pre><code>  use strict;  use warnings;  use LWP 5.64;  my $browser = LWP::UserAgent->new;    my $word = 'tarragon';    my $url = 'http://www.altavista.com/sites/search/web';  my $response = $browser->post( $url,    [ 'q' => $word,  # the Altavista query string      'pg' => 'q', 'avkw' => 'tgz', 'kl' => 'XX',    ]  );  die "$url error: ", $response->status_line   unless $response->is_success;  die "Weird content type at $url -- ", $response->content_type   unless $response->content_type eq 'text/html';  if( $response->content =~ m{AltaVista found ([0-9,]+) results} ) {    # The substring will be like "AltaVista found 2,345 results"    print "$word: $1\n";  } else {    print "Couldn't find the match-string in the response\n";  }</code></pre><h3>Sending GET Form Data</h3><p>Some HTML forms convey their form data not by sending the datain an HTTP POST request, but by making a normal <code>GET</code> request withthe data stuck on the end of the URL.  For example, if you went to<a href="http://imdb.com/"><em>imdb.com</em></a> and ran a search on <i>Blade Runner</i>, the URL you'd seein your browser window would be:</p><pre><code>  http://us.imdb.com/Tsearch?title=Blade%20Runner&restrict=Movies+and+TV</code></pre><p>To run the same search with LWP, you'd use this idiom, which involvesthe URI class:</p><pre><code>  use URI;  my $url = URI->new( 'http://us.imdb.com/Tsearch' );    # makes an object representing the URL    $url->query_form(  # And here the form data pairs:    'title'    => 'Blade Runner',    'restrict' => 'Movies and TV',  );    my $response = $browser->get($url);</code></pre><p>See Chapter 5, "Forms" of <i>Perl&nbsp;&amp;&nbsp;LWP</i> for a longer discussion of HTML forms and of form data, as well as Chapter 6 through Chapter 9 for a longer discussion of extracting data from HTML.</p><h3>Absolutizing URLs</h3><p>The URI class that we just mentioned above provides all sorts of methodsfor accessing and modifying parts of URLs (such as asking sort of URL itis with <code>$url->scheme</code>, and asking what host it refers to with <code>$url->host</code>, and so on, as described in <a href="http://search.cpan.org/author/GAAS/URI/URI.pm">the docs for the URI class</a>.  However, the methods of most immediate interestare the <code>query_form</code> method seen above, and now the <code>new_abs</code> method for taking a probably relative URL string (like "../foo.html") and gettingback an absolute URL (like "/stuff/foo.html"), asshown here:</p><pre><code>  use URI;  $abs = URI->new_abs($maybe_relative, $base);</code></pre><p>For example, consider this program that matches URLs in the HTMLlist of new modules in CPAN:</p><pre><code>  use strict;  use warnings;  use LWP 5.64;  my $browser = LWP::UserAgent->new;    my $url = 'http://www.cpan.org/RECENT.html';  my $response = $browser->get($url);  die "Can't get $url -- ", $response->status_line   unless $response->is_success;    my $html = $response->content;  while( $html =~ m/&lt;A HREF=\"(.*?)\"/g ) {          print "$1\n";    }</code></pre><p>When run, it emits output that starts out something like this:</p><pre><code>  MIRRORING.FROM  RECENT  RECENT.html  authors/00whois.html  authors/01mailrc.txt.gz  authors/id/A/AA/AASSAD/CHECKSUMS  ...</code></pre><p>However, if you actually want to have those be absolute URLs, youcan use the URI module's <code>new_abs</code> method, by changing the <code>while</code> loop to this:</p><pre><code>  while( $html =~ m/&lt;A HREF=\"(.*?)\"/g ) {          print URI->new_abs( $1, $response->base ) ,"\n";  }</code></pre><p>(The <code>$response->base</code> method from <code>HTTP::Message</code>is for returning the URL that should be used for resolving relative URLs--it's usually just the same as the URL that you requested.)</p><p>That program then emits nicely absolute URLs:</p><pre><code>  http://www.cpan.org/MIRRORING.FROM  http://www.cpan.org/RECENT  http://www.cpan.org/RECENT.html  http://www.cpan.org/authors/00whois.html  http://www.cpan.org/authors/01mailrc.txt.gz  http://www.cpan.org/authors/id/A/AA/AASSAD/CHECKSUMS  ...</code></pre><p>See Chapter 4, "URLs", of <i>Perl&nbsp;&amp;&nbsp;LWP</i> for a longer discussion of URI objects.</p><p>Of course, using a regexp to match hrefs is a bit simplistic, and formore robust programs, you'll probably want to use an HTML-parsing modulelike <code>HTML::LinkExtor</code>, or <code>HTML::TokeParser</code>, or even maybe<code>HTML::TreeBuilder</code>.</p><h3>Other Browser Attributes</h3><p><code>LWP::UserAgent</code> objects have many attributes for controlling how theywork. Here are a few notable ones:</p><ul><li><p><code>$browser->timeout(15)</code>: This sets this browser object to give up on requests that don't answer within 15 seconds.</p></li><li><p><code>$browser->protocols_allowed( [ 'http', 'gopher'] )</code>: This sets this browser object to not speak any protocols other than HTTP and gopher. If it tries accessing any other kind of URL (like an "ftp:" or "mailto:" or "news:" URL), then it won't actually try connecting, but instead will immediately return an error code 500, with a message like "Access to ftp URIs has been disabled".</p></li><li><p><code>use LWP::ConnCache; <br />$browser->conn_cache(LWP::ConnCache->new())</code>: This tells the browser object to try using the HTTP/1.1 "Keep-Alive" feature, which speeds up requests by reusing the same socket connection for multiple requests to the same server.</p></li><li><p><code>$browser->agent( 'SomeName/1.23 (more info here maybe)' )</code>: This changes how the browser object will identify itself in the default "User-Agent" line is its HTTP requests.  By default, it'll send "libwww-perl/<i>versionnumber</i>", like "libwww-perl/5.65".  You can change that to something more descriptive like this:</p><pre><code>  $browser->agent( 'SomeName/3.14 (contact@robotplexus.int)' );</code></pre><p>Or if need be, you can go in disguise, like this:</p><pre><code>  $browser->agent(      'Mozilla/4.0 (compatible; MSIE 5.12; Mac_PowerPC)' );</code></pre></li><li><p><code>push @{ $ua->requests_redirectable }, 'POST'</code>: This tells this browser to obey redirection responses to POST requests (like most modern interactive browsers), even though the HTTP RFC says that should not normally be done.</p></li></ul><p>For more options and information, see <a href="http://search.cpan.org/author/GAAS/libwww-perl/lib/LWP/UserAgent.pm">the full documentation for LWP::UserAgent</a>.</p><h3>Writing Polite Robots</h3><p>If you want to make sure that your LWP-based program respects <i>robots.txt</i> files and doesn't make too many requests too fast, you can use the <code>LWP::RobotUA</code>class instead of the <code>LWP::UserAgent</code> class.</p><p><code>LWP::RobotUA</code> class is just like <code>LWP::UserAgent</code>, and you can use it like so:</p><pre><code>  use LWP::RobotUA;  my $browser = LWP::RobotUA->new(    'YourSuperBot/1.34', 'you@yoursite.com');    # Your bot's name and your email address  my $response = $browser->get($url);</code></pre><p>But <code>HTTP::RobotUA</code> adds these features:</p><ul><li><p>If the <i>robots.txt</i> on <code>$url</code>'s server forbids you from accessing<code>$url</code>, then the <code>$browser</code> object (assuming it's of the class <code>LWP::RobotUA</code>) won't actually request it, but instead will give you back (in <code>$response</code>) a 403 errorwith a message "Forbidden by robots.txt".  That is, if you have this line: </p></li><pre><code>  die "$url -- ", $response->status_line, "\nAborted"   unless $response->is_success;</code></pre><p>then the program would die with an error message like this:</p><pre><code>  http://whatever.site.int/pith/x.html -- 403 Forbidden   by robots.txt  Aborted at whateverprogram.pl line 1234</code></pre><li><p>If this <code>$browser</code> object sees that the last time it talked to<code>$url</code>'s server was too recently, then it will pause (via <code>sleep</code>) toavoid making too many requests too often. How long it will pause for, isby default one minute--but you can control it with the <code>$browser->delay( <em>minutes</em> )</code> attribute.</p></li><p>For example, this code:</p><pre><code>  $browser->delay( 7/60 );</code></pre><p>means that this browser will pause when it needs to avoid talking toany given server more than once every 7 seconds.</p></ul><p>For more options and information, see <a href="http://search.cpan.org/author/GAAS/libwww-perl/lib/LWP/RobotUA.pm">the full documentation forLWP::RobotUA</a>.</p><h3>Using Proxies</h3><p>In some cases, you will want to (or will have to) use proxies foraccessing certain sites or for using certain protocols. This is mostcommonly the case when your LWP program is running (or could be running)on a machine that is behind a firewall.</p><p>To make a browser object use proxies that are defined in the usualenvironment variables (<code>HTTP_PROXY</code>), just call the <code>env_proxy</code> on a user-agent object before you go making any requests on it.Specifically:</p><pre><code>  use LWP::UserAgent;  my $browser = LWP::UserAgent->new;    # And before you go making any requests:  $browser->env_proxy;</code></pre><p>For more information on proxy parameters, see <a href="http://search.cpan.org/author/GAAS/libwww-perl/lib/LWP/UserAgent.pm">the LWP::UserAgentdocumentation</a>, specifically the <code>proxy</code>, <code>env_proxy</code>,and <code>no_proxy</code> methods.</p><h3>HTTP Authentication</h3><p>Many Web sites restrict access to documents by using "HTTPAuthentication". This isn't just any form of "enter your password"restriction, but is a specific mechanism where the HTTP server sends thebrowser an HTTP code that says "That document is part of a protected'realm', and you can access it only if you re-request it and add somespecial authorization headers to your request".</p><p>For example, the Unicode.org administrators stop email-harvesting bots fromharvesting the contents of their mailing list archives by protectingthem with HTTP Authentication, and then publicly stating the usernameand password (at <i>http://www.unicode.org/mail-arch/</i>)--namelyusername "unicode-ml" and password "unicode".</p>  <p>For example, consider this URL, which is part of the protectedarea of the Web site:</p><pre><code>  http://www.unicode.org/mail-arch/unicode-ml/y2002-m08/0067.html</code></pre><p>If you access that with a browser, you'll get a promptlike "Enter username and password for 'Unicode-MailList-Archives' at server'www.unicode.org'", or in a graphical browser, something like this:</p><table border="0" cellpadding="2" cellspacing="2"><tr><td width="475"><img src="/pub/2002/08/20/graphics/burke_auth_snapshot.gif" width="475" height="240" alt="Screenshot of site with Basic Auth required" /></td></tr></table><p>In LWP, if you just request that URL, like this:</p><pre><code>  use LWP 5.64;  my $browser = LWP::UserAgent->new;  my $url =   'http://www.unicode.org/mail-arch/unicode-ml/y2002-m08/0067.html';  my $response = $browser->get($url);  die "Error: ", $response->header('WWW-Authenticate') ||     'Error accessing',    #  ('WWW-Authenticate' is the realm-name)    "\n ", $response->status_line, "\n at $url\n Aborting"   unless $response->is_success;</code></pre><p>Then you'll get this error:</p><pre><code>  Error: Basic realm="Unicode-MailList-Archives"   401 Authorization Required   at http://www.unicode.org/mail-arch/unicode-ml/y2002-m08/0067.html   Aborting at auth1.pl line 9.  [or wherever]</code></pre><p>because the <code>$browser</code> doesn't know any the username and passwordfor that realm ("Unicode-MailList-Archives") at that host("www.unicode.org").  The simplest way to let the browser know about thisis to use the <code>credentials</code> method to let it know about a username andpassword that it can try using for that realm at that host.  The syntax is:</p><pre><code>  $browser->credentials(    'servername:portnumber',    'realm-name',    'username' => 'password'  );</code></pre><p>In most cases, the port number is 80, the default TCP/IP port for HTTP; andyou usually call the <code>credentials</code> method before you make any requests.For example:</p><pre><code>  $browser->credentials(    'reports.mybazouki.com:80',    'web_server_usage_reports',    'plinky' => 'banjo123'  );</code></pre><p>So if we add the following to the program above, right after the <code>$browser = LWP::UserAgent->new;</code> line:</p><pre><code>  $browser->credentials(  # add this to our $browser 's "key ring"    'www.unicode.org:80',    'Unicode-MailList-Archives',    'unicode-ml' => 'unicode'  );</code></pre><p>and then when we run it, the request succeeds, instead of causing the<code>die</code> to be called.</p><h3>Accessing HTTPS URLs</h3><p>When you access an HTTPS URL, it'll work for you just like an HTTP URLwould--if your LWP installation has HTTPS support (via an appropriateSecure Sockets Layer library).  For example:</p><pre><code>  use LWP 5.64;  my $url = 'https://www.paypal.com/';   # Yes, HTTPS!  my $browser = LWP::UserAgent->new;  my $response = $browser->get($url);  die "Error at $url\n ", $response->status_line, "\n Aborting"   unless $response->is_success;  print "Whee, it worked!  I got that ",   $response->content_type, " document!\n";</code></pre><p>If your LWP installation doesn't have HTTPS support set up, then theresponse will be unsuccessful, and you'll get this error message:</p><pre><code>  Error at https://www.paypal.com/   501 Protocol scheme 'https' is not supported   Aborting at paypal.pl line 7.   [or whatever program and line]</code></pre><p>If your LWP installation <i>does</i> have HTTPS support installed, then theresponse should be successful, and you should be able to consult<code>$response</code> just like with any normal HTTP response.</p><p>For information about installing HTTPS support for your LWPinstallation, see the helpful <i>README.SSL</i> file that comes in thelibwww-perl distribution.</p><h3>Getting Large Documents</h3><p>When you're requesting a large (or at least potentially large) document,a problem with the normal way of using the request methods (like <code>$response = $browser->get($url)</code>) is that the response object inmemory will have to hold the whole document--<i>in memory</i>. If theresponse is a 30-megabyte file, this is likely to be quite animposition on this process's memory usage.</p><p>A notable alternative is to have LWP save the content to a file on disk,instead of saving it up in memory.  This is the syntax to use:</p><pre><code>  $response = $ua->get($url,                         ':content_file' => $filespec,                      );</code></pre><p>For example,</p><pre><code>  $response = $ua->get('http://search.cpan.org/',                         ':content_file' => '/tmp/sco.html'                      );</code></pre><p>When you use this <code>:content_file</code> option, the <code>$response</code> will haveall the normal header lines, but <code>$response->content</code> will beempty.</p><p>Note that this ":content_file" option isn't supported under olderversions of LWP, so you should consider adding <code>use LWP 5.66;</code> to checkthe LWP version, if you think your program might run on systems witholder versions.</p><p>If you need to be compatible with older LWP versions, then usethis syntax, which does the same thing:</p><pre><code>  use HTTP::Request::Common;  $response = $ua->request( GET($url), $filespec );</code></pre><h3>Resources</h3><p>Remember, this article is just the most rudimentary introduction to LWP--to learn more about LWP and LWP-related tasks, you really must read from the following: </p><ul><li><p><code><a href="http://search.cpan.org/author/GAAS/libwww-perl/lib/LWP/Simple.pm">LWP::Simple</a></code>: Simple functions for getting, heading, and mirroring URLs.</p></li><li><p><code><a href="http://search.cpan.org/author/GAAS/libwww-perl/lib/LWP.pm">LWP</a></code>: Overview of the libwww-perl modules.</p></li><li><p><code><a href="http://search.cpan.org/author/GAAS/libwww-perl/lib/LWP/UserAgent.pm">LWP::UserAgent</a></code>: The class for objects that represent "virtual browsers."</p></li><li><p><code><a href="http://search.cpan.org/author/GAAS/libwww-perl/lib/HTTP/Response.pm">HTTP::Response</a></code>:The class for objects that represent the response to a LWP response, as in <code>$response = $browser->get(...)</code>.</p></li><li><p><code><a href="http://search.cpan.org/author/GAAS/libwww-perl/lib/HTTP/Message.pm">HTTP::Message</a></code> and <code><a href="http://search.cpan.org/author/GAAS/libwww-perl/lib/HTTP/Headers.pm">HTTP::Headers</a></code>: Classes that provide more methods to <code>HTTP::Response</code>.</p></li><li><p><code><a href="http://search.cpan.org/author/GAAS/URI/URI.pm">URI</a></code>: Class for objects that represent absolute or relative URLs.</p></li><li><p><code><a href="http://search.cpan.org/author/GAAS/URI/URI/Escape.pm">URI::Escape</a></code>: Functions for URL-escaping and URL-unescaping strings(like turning "this & that" to and from "this%20%26%20that").</p></li><li><p><code><a href="http://search.cpan.org/author/GAAS/HTML-Parser/lib/HTML/Entities.pm">HTML::Entities</a></code>: Functions for HTML-escaping and HTML-unescaping strings(like turning "C. & E. Bront&euml;" to and from "C. &amp;amp; E. Bront&amp;euml;").</p></li><li><p><code><a href="http://search.cpan.org/author/GAAS/HTML-Parser/lib/HTML/TokeParser.pm">HTML::TokeParser</a></code> and <code><a href="http://search.cpan.org/author/SBURKE/HTML-Tree/lib/HTML/Tree.pm">HTML::TreeBuilder</a></code>: Classes for parsing HTML.</p></li><li><p><code><a href="http://search.cpan.org/author/GAAS/HTML-Parser/lib/HTML/LinkExtor.pm">HTML::LinkExtor</a></code>: Class for finding links in HTML documents.</p></li><li><p>And last but not least, my book <a href="http://www.oreilly.com/catalog/perllwp/">Perl&nbsp;&amp;&nbsp;LWP</a>.</p></li></ul><hr size="1" noshade="noshade" /><p>Copyright &copy;2002, Sean M. Burke.  You can redistribute this document and/ormodify it, but only under the same terms as Perl itself.</p><hr size="1" noshade="noshade" />
        </div>



    </div>
    <div class="asset-footer"></div>
</div>


                            
                            <div id="entry-1350" class="entry-asset asset hentry">
    <div class="asset-header">
        <h2 class="asset-name entry-title"><a href="/pub/2002/08/p6pdigest/20020818.html" rel="bookmark">This week on Perl 6 (week ending 2002-08-18)</a></h2>
        <div class="asset-meta">
            <span class="byline">
    
                By <span class="vcard author">Piers Cawley</span> on <abbr class="published" title="2002-08-18T00:00:00-08:00">August 18, 2002 12:00 AM</abbr>
    
            </span>

            
            

        </div>
    </div>
    <div class="asset-content entry-content">

        <div class="asset-body">
            <P>The story so far... Larry, Tom, Randal, Damian, Jon, Chip, Gnat,
Ziggy, Dick and the rest of the gang were chatting with all the other
cool Perl kids about where Perl was and should be going. Then Jon
threw a coffee cup and the rest is history...</P>
<P>So, as is now traditional, we'll kick off with the goings on in
perl6-internals. Confused? You will be after this week's summary.</P>
<P>
<H3><A NAME="scratchpad.pmc">Scratchpad.pmc</A></H3>
<P>Jonathan Sillito harrassed Dan about subroutines, continuations and
and other things to do with function calls. He wondered if his
<CODE>scratchpad.pmc</CODE> patch fitted what Dan had in mind, and added a few
supplementary questions. Dan answered the supplementary questions and
apologised for not having done the docs on this bit of the design,
saying he'd try and get it out by the end of the week. Melvin Smith
(whose code was involved in some of the questions) also gave some
answers.</P>
<P><A HREF="http://groups.google.com/groups?threadm=1029179400.8276.37.camel%40localhost.localdomain">http://groups.google.com/groups</A> -- Questions</P>
<P><A HREF="http://groups.google.com/groups?threadm=a05111b14b97e57d7b23d%40%5B63.120.19.221%5D">http://groups.google.com/groups</A> -- Answers.</P>
<P><A HREF="http://groups.google.com/groups?threadm=5.1.0.14.2.20020812225655.030231f0%40pop.mindspring.com">http://groups.google.com/groups</A> -- More
answers</P>
<P>
<H3><A NAME="perl 6 regexes...">Perl 6 regexes...</A></H3>
<P>Last week Dan threw down the 'full perl 6 regex engine' gauntlet, and
this week Sean ``Hero'' O'Rourke admitted that he was working on it and
that he already had a good chunk of it working. Apparently
hypothetical variables and the various cut operators are looking a
little tricky. Dan was impressed. Simon Cozens told us that, when he said
he'd written a Perl 6 regex parser before breakfast at YAPC, he hadn't
been joking, and that he'd put it up in his CVS if people want to poke
at it. But the crowd was strangely silent.</P>
<P>Steve Fink also had some questions to ask about the regex engine.</P>
<P><A HREF="http://groups.google.com/groups?threadm=a05111b05b97cecb019c0%40%5B63.120.19.221%5D">http://groups.google.com/groups</A></P>
<P><A HREF="http://groups.google.com/groups?threadm=Pine.GSO.4.32.0208112148510.13607-100000%40gradlab.ucsd.edu">http://groups.google.com/groups</A></P>
<P><A HREF="http://groups.google.com/groups?threadm=86eld4pj4y.fsf%40squash.oucs.ox.ac.uk">http://groups.google.com/groups</A></P>
<P><A HREF="http://groups.google.com/groups?threadm=20020815204744.GB6028%40foxglove.digital-integrity.com">http://groups.google.com/groups</A></P>
<P>
<H3><A NAME="[commit] gc_debug, some gc fixes, and remaining gc bugs">[COMMIT] GC_DEBUG, Some GC Fixes, and Remaining GC Bugs</A></H3>
<P>Mike Lambert has re-added the GC_DEBUG define. The idea behind this is
to allow `various limits and settings and logic to be setup such that
GC bugs occur relatively soon after the offending code.' and generally
to let you write relatively simple code that will trip the kind of
bugs that are normally only seen when running complex code. Mike also
listed the areas where he knows there are still problems.</P>
<P>Various people have had problems using GC_DEBUG, including at least
one instance where <CODE>&lt;end</CODE>&gt; threw a segfault, but it also drew a
flurry of patches from Jason Gloudon and Steve Fink. Much of the
discussion in this thread was rather more technical than I have the
skills to summarize, so I'll just point you at the root node.</P>
<P><A HREF="http://groups.google.com/groups?threadm=Pine.LNX.4.44.0208120349360.9252-100000%40jall.org">http://groups.google.com/groups</A></P>
<P>
<H3><A NAME="[patch] quotematch speedup">[PATCH] quotematch speedup</A></H3>
<P>Joseph Ryan did some regex optimization in assemble.pl to speed up the
matching of strings. For some reason, this kicked off the longest
thread of the week, about the merits of optimizing a pure perl
assembler when we should really do it in C if we <CODE>really</CODE> wanted
speed. Or maybe we should implement the assembler in Parrot
proper. And wouldn't it be cool if we could write self modifying code
in Parrot (needed for eval, Dan's working on a design). Juergen
Boemmels spotted that the patch didn't quite work as promised and
provided a better version, but I don't think it's been applied.</P>
<P><A HREF="http://rt.perl.org/rt2/Ticket/Display.html?id=16144">http://rt.perl.org/rt2/Ticket/Display.html</A></P>
<P>
<H3><A NAME="keyed access to perlarray/perlhash">Keyed access to PerlArray/PerlHash</A></H3>
<P>Tom Hughes wondered about the semantics of indexing PerlArrays with
strings and PerlHashes with integers. He and Dan discussed it back and
forth for a while, and then Tom posted a patch, which Dan liked the
look of, but held off on applying while everyone else had a good
look. Mike Lambert had a look and raised some issues, which Tom
addressed and issued another, enormous patch.</P>
<P><A HREF="http://groups.google.com/groups?threadm=4cdafa644b.tom%40compton.compton.nu">http://groups.google.com/groups</A></P>
<P><A HREF="http://rt.perl.org/rt2/Ticket/Display.html?id=16274">http://rt.perl.org/rt2/Ticket/Display.html</A></P>
<P><A HREF="http://groups.google.com/groups?threadm=b9a604684b.tom%40compton.compton.nu">http://groups.google.com/groups</A></P>
<P>
<H3><A NAME="[pasm] problem opening / reading file">[PASM] problem opening / reading file</A></H3>
<P>Jerome Quelin has been having some problems with file I/O under parrot
0.0.7. The consensus seems to be that the current Parrot I/O system
is, ahem, not as good as it could be, mostly because people have had
other priorities. Dan asked for a volunteer to help `get I/O off of
Melvin's altogether too-full plate before his wife hunts [Dan] down
and does nasty things'. Clinton Pierce seems to have stepped up to
handle part of what Dan wants. Well done that man.</P>
<P><A HREF="http://groups.google.com/groups?threadm=3D49FF79003D8FCF%40mel-rta8.wanadoo.fr">http://groups.google.com/groups</A></P>
<P><A HREF="http://groups.google.com/groups?threadm=a05111b12b97e572a89b7%40%5B63.120.19.221%5D">http://groups.google.com/groups</A></P>
<P>
<H3><A NAME="set boolean to 2">set Boolean to 2</A></H3>
<P>Leopold Toetsch found something confusing in the perl 6 compiler which
ends up generating some unexpected byte code. Peter Gibbs reckoned
that the generated code was right, but Leopold still sounds
unconvinced.</P>
<P><A HREF="http://groups.google.com/groups?threadm=3D5BB5DE.3080109%40toetsch.at">http://groups.google.com/groups</A></P>
<P>
<H3><A NAME="[info] the first pirate parrot takes to the air">[INFO] The first pirate parrot takes to the air</A></H3>
<P>Peter Gibbs chucked a cat in amongst the parrots when he posted some
performance numbers for his own private `African Grey' version of
Parrot which utilizes some GC speed up techniques that Dan had
rejected. Peter's numbers are impressive, but the techniques used
break in some places. Peter helpfully posted pointers to his original
patches. Dan wondered which bits contributed what to the improved
performance, and explained why he had problems with the approaches
that Peter was using.</P>
<P>This thread also spawned the thread called `Stack Walk Speedups?'
which was kicked off by Mike Lambert outlining the current workings of
the GC's stack walking code and wondered if anyone could come up with
a faster way of doing it (that worked in the face of the constraints
on Parrot's GC.) Peter Gibbs offered one approach, and Jason Gloudon
pointed out that his 'stack direction' config patch would help in this
area too. Jason also offered a patch giving a 12% speedup on his
machine, which was applied. Mike Lambert is also doing some cunning
stuff to improve things using Copy On Write (COW) tricks.</P>
<P><A HREF="http://groups.google.com/groups?threadm=018501c24533%242c672100%240b01010a%40emkel.co.za">http://groups.google.com/groups</A></P>
<P><A HREF="http://groups.google.com/groups?threadm=000f01c2453d%24dec0e3e0%240b01010a%40emkel.co.za">http://groups.google.com/groups</A></P>
<P><A HREF="http://groups.google.com/groups?threadm=a05111b06b9832757422a%40%5B63.120.19.221%5D">http://groups.google.com/groups</A></P>
<P><A HREF="http://groups.google.com/groups?threadm=Pine.LNX.4.44.0208171342480.12965-100000%40jall.org">http://groups.google.com/groups</A></P>
<P><A HREF="http://rt.perl.org/rt2/Ticket/Display.html?id=16278">http://rt.perl.org/rt2/Ticket/Display.html</A></P>
<P>
<H3><A NAME="[draft pdd] external data interfaces">[DRAFT PDD] External Data Interfaces</A></H3>
<P>Brent Dax donned his Technical Author hat, and offered a draft PDD
(Parrot Design Document) covering Parrot's external data interfaces. 
Nicholas Clark offered a pile of constructive criticism and discussion
is ongoing.</P>
<P><A HREF="http://groups.google.com/groups?threadm=00b201c24641%249c7a3b30%246501a8c0%40deepblue">http://groups.google.com/groups</A></P>
<P>
<HR>
<H1><A NAME="meanwhile, over in perl6language">Meanwhile, over in perl6-language</A></H1>
<P>The strangely named `Autovivi' thread rolled on. Miko O'Sullivan asked
Larry for some clarification about the default behaviour of
pass-by-values, Larry wasn't sure because he hasn't worked out the
syntax yet. Luke Palmer suggested that copy-on-write tricks could be
used to do let us have our cake and eat it. Deven Corzine suggested
defaulting to doing pass-by-value, but Larry suspects that that might
make Perl 6 sub calls even slower than perl 5's. David Whipp wondered
about threading; nobody replied.</P>
<P>Deven managed to drag the thread back to its nominal subject of
Autovivification when he wondered if <CODE>&lt;func($x{1}{2}{3})</CODE>&gt; would
cause an implementation headache. Larry explained that it was cases
like this that made him choose the 'pass by immutable reference',
attempting to give the speed of pass by reference combined with the
guarantees of pass by value. Deven pressed his point and wondered what
would happen in the <CODE>is rw</CODE> case. Nicholas Clark explained how Perl 5
avoids autovivification in this case (but it's only one level
deep). Uri Guttman pointed out that this is a 'Hard Problem', but
Leopold Toetsch thought that the Parrot KEY operators may make it
relatively easy to solve.</P>
<P><A HREF="http://groups.google.com/groups?threadm=191690-220028213182451277%40M2W058.mail2web.com">http://groups.google.com/groups</A></P>
<P><A HREF="http://groups.google.com/groups?threadm=Pine.LNX.4.33.0208130905580.5405-100000%40escher.ties.org">http://groups.google.com/groups</A></P>
<P>
<H3><A NAME="a perl 6 class question">A Perl 6 class question</A></H3>
<P>Last week, Chris Dutton had asked about using Perl 6 to create
anonymous classes, and proposed a syntax. This week, Allison Randal
pointed him at the section of Exegesis 4 which described how to do
exactly that. Rather satisfyingly, the syntax that Chris had invented
was exactly the syntax used in the Exegesis, so the choice appears to
be natural. Trey Harris wondered about some of the other clumsinesses
in Perl 5 when defining classes, and asked some questions about class
methods. Damian confirmed that most of the clumsiness was going away,
and clarified the behaviour of <CODE>sub</CODE>s in a class definition.</P>
<P><A HREF="http://groups.google.com/groups?threadm=20020812154423.GA972%40shadowed.net">http://groups.google.com/groups</A></P>
<P>
<H3><A NAME="just reading up on pike...">Just reading up on Pike...</A></H3>
<P>Chris Dutton has been reading up on Pike, and had some observations
(whilst neglecting to explain what Pike <EM>is</EM>). Apparently pike allows
you to define combination types <CODE>&lt;private string|int bar</CODE>&gt; would mean
that <CODE>&lt;bar</CODE>&gt; could be a string or an int for instance. Damian wheeled
out his superpositions hobby horse and suggested <CODE>&lt;my any(str,int)
$bar</CODE>&gt;, as a way of doing this. Luke Palmer trumped that with <CODE>&lt;my
all(str,int) $foo</CODE>&gt; and wondered what such a construct would actually
<EM>mean</EM>. Damian suggested that it meant Luke needed some serious
therapy. Nicholas Clark got all boring and practical and wondered how
one would implement the <CODE>any</CODE> case. Damian reckons it'd just fall out
of the implementation of superpositions.</P>
<P>Somewhere in the thread, Andy Wardley asked a serious question about
what builtin types perl 6 would had, and what the results of <CODE>ref
$foo</CODE> would look like.</P>
<P><A HREF="http://groups.google.com/groups?threadm=F2A145AA-B0DA-11D6-9C86-0005020F8EB9%40mac.com">http://groups.google.com/groups</A></P>
<P><A HREF="http://groups.google.com/groups?threadm=20020818111411.B27478%40dog.ourshack.com">http://groups.google.com/groups</A></P>
<P>
<H3><A NAME="balanced matches in regexps">Balanced Matches in Regexps?</A></H3>
<P>Peter Behroozi wondered about using Apocalypse 5 rules to capture
balanced and wondered if there shouldn't be a <CODE>&lt;balanced&gt;</CODE>
directive. Brent Dax pointed Peter at the cunning recursion
capabilities that come with Apocalypse 5:</P>
<PRE>
  rule parenthesized { \( ( &lt;-[()]&gt;+ | &lt;parenthesized&gt; )* \) }</PRE>
<P>Larry commented that he was considering a builtin <CODE>&lt;self&gt;</CODE> rule
that'd allow one to refer to the current rule without having to name
it. Peter then offered his first attempt at a recursive rule to
capture nested HTML tables.</P>
<P><A HREF="http://groups.google.com/groups?threadm=1029603552.1752.58.camel%40dhcppc3">http://groups.google.com/groups</A></P>
<P>
<HR>
<H1><A NAME="in brief">In brief</A></H1>
<P>Nicholas Clark patched <CODE>assemble.pl</CODE> so that it could complete its
run before the heat death of the universe when run under perl
5.005_03.</P>
<P>Jeff Goff is back and doing cool things with Ruby in parrot.</P>
<P>Jerome Quelin asked what was wanted in a patch. Consensus seems to be
either a unified or a context diff, as a mime attachment with a name
for the patch and a short description of what it does. Tests are
always good (essential) if you're adding new functionality. So are
docs.</P>
<P>Jerome also offered a patch which implemented a <CODE>rand</CODE> operator but
wondered about portability and when to call <CODE>srand</CODE>. Jeff Goff
wondered if we shouldn't implement our own 'rand' using, say, the
Mersenne Twister
(<A HREF="http://www-personal.engin.umich.edu/~wagnerr/MersenneTwister.html">http://www-personal.engin.umich.edu/~wagnerr/MersenneTwister.html</A>)
and Dan pointed out where srand should be called.</P>
<P>Josef H&ouml;&ouml;k reworked his multidimensional arrays patch one
more time and <EM>it got applied.</EM> Well done Josef, perseverance pays
off in the end.</P>
<P>Jason Gloudon added a config patch which tests the direction of stack
growth. Applied.</P>
<P>Leopold Toetsch wondered why assembler.pl uses its own <CODE>PMC.pm</CODE> instead
of the generated <CODE>lib/Parrot/PMC.pm</CODE>. Warnock's Dilemma applies.</P>
<P>Pete Sergeant has written a `quick and dirty' PASM tokenizer and a
syntax highlighter based on it.</P>
<P>Jarkko continues his sterling work of squashing Tru64 compiler
warnings.</P>
<P>Steve Fink has had a crack at adding a <CODE>--debugging</CODE> flag to
<CODE>Configure.pl</CODE>. Warnock applies.</P>
<P>Jerome Quelin won my 'making it easy to keep a running joke going'
prize when he supplied a Befunge-93 interpreter in parrot, and
commented: ``Note to Leon Brocard: There's a lot more to do in order to
provide a Befunge-98 compliant interpreter, so don't worry! There's
still a lot of fun waiting... :o)''. Which was very good of
him. Thanks Jerome.</P>
<P>The rule/pattern/regex thing kept going. Damian explained that he'd
try and use `pattern' for the contents and `rule' for the
container. But we that we weren't to hold him to that.</P>
<P>Brent Dax has uploaded a new version of Perl6::Parameters to
CPAN. It's his attempt allowing one to declare perl 5 subroutines in a
Perl 6ish style.</P>
<P>
<HR>
<H1><A NAME="who's who in perl 6">Who's who in Perl 6</A></H1>
<DL>
<DT><STRONG><A NAME="item_Who_are_you%3F">Who are you?</A></STRONG><BR>
<DD>
Daniel Alejandro Grunblatt, 21 years university student from Argentina.
<P></P>
<DT><STRONG><A NAME="item_What_do_you_do_for%2Fwith_Perl_6%3F">What do you do for/with Perl 6?</A></STRONG><BR>
<DD>
I'm mostly doing the JIT for Parrot but occasionally move on to another
fields (like the Parrot Compiler in Parrot or the Parrot Debugger and
others).
<P></P>
<DT><STRONG><A NAME="item_Where_are_you_coming_from%3F">Where are you coming from?</A></STRONG><BR>
<DD>
My mother.
<P></P>
<DT><STRONG><A NAME="item_When_do_you_think_Perl_6_will_be_released%3F">When do you think Perl 6 will be released?</A></STRONG><BR>
<DD>
Some day.
<P></P>
<DT><STRONG><A NAME="item_Why_are_you_doing_this%3F">Why are you doing this?</A></STRONG><BR>
<DD>
I started working on the JIT to learn assembly, and I'm still learning it
(yes, I'm slow), I want to see Parrot running fast, and because it's fun.
<P></P>
<DT><STRONG><A NAME="item_You_have_5_words%2E_Describe_yourself%2E">You have 5 words. Describe yourself.</A></STRONG><BR>
<DD>
I like playing basketball, what I haven't done for while now, and used to
like playing role games.
<P></P>
<DT><STRONG><A NAME="item_Do_you_have_anything_to_declare%3F">Do you have anything to declare?</A></STRONG><BR>
<DD>
No.
<P></P></DL>
<P>
<HR>
<H1><A NAME="acknowledgements and the funding drive.">Acknowledgements and the funding drive.</A></H1>
<P>This summary was prepared with the aid of more GNER tea (on the down
train today). Sadly the GNER ham and cheese toasted sandwich has
declined; they've replaced the cheddar in the old version with
Wensleydale, which really doesn't melt as well.</P>
<P>Because I'm a bit late this week I've not had time to get the
estimable Pete Sergeant to proofread it for me, so if the spelling is
worse and the language less coherent this week, just be grateful for
Pete's sterling work on my earlier summaries.</P>
<P>Again, if your name appears in this, or any previous summary, and
you've still not sent your answers, please consider answering the
questions in the ``Perl 6 Who's who?'' section and sending your answers
to <A HREF="mailto:5Ws@bofh.org.uk.">5Ws@bofh.org.uk.</A></P>
<P>Well, so far nobody dislikes my summaries enough to post an
alternative. Which is nice. If you think my time writing this is worth
anything don't give me money, give it to the Perl Foundation
<A HREF="http://donate.perl-foundation.org">http://donate.perl-foundation.org</A> and help support the ongoing
development of Perl. Remember, suitably large donations will earn you
a plug in a future summary, but only if you tell me about it.</P>

        </div>



    </div>
    <div class="asset-footer"></div>
</div>


                            
                            <div id="entry-1340" class="entry-asset asset hentry">
    <div class="asset-header">
        <h2 class="asset-name entry-title"><a href="/pub/2002/08/13/comment.html" rel="bookmark">Acme::Comment</a></h2>
        <div class="asset-meta">
            <span class="byline">
    
                By <span class="vcard author">Jos Boumans</span> on <abbr class="published" title="2002-08-13T00:00:00-08:00">August 13, 2002 12:00 AM</abbr>
    
            </span>

            
            

        </div>
    </div>
    <div class="asset-content entry-content">

        <div class="asset-body">
            
<!-- sidebar begins -->
<!-- don't move sidebars -->
<!-- sidebar ends -->

<p></p>
<pre><code>
/*
    This is a Perl comment
*/
</code></pre>

<h3>Commenting in Perl</h3>

<p>"But what?", I hear you think, "Perl doesn't have multi-line comments!"</p>

<p>That's true. Perl doesn't have multiline comments. But why is that? What
is wrong with them? Mostly, it is because <a href="http://www.Perl.com/pub/a/2001/05/03/wall.html#rfc%20005:%20multiline%20comments%20for%20Perl">Larry
doesn't like them</a>, and reasons that we can have the same effect with
POD and Perl doesn't need Yet Another Comment Marker.
</p>

<p>To illustrate, here we are at YAPC::America::North 2002, held in
beautiful St. Louis. The weather is warm, the sun is shining, the sights
are pretty and the beer is cold. In short, it's all things we've come to
love and expect of a Perl conference. It's thursday, the conference is
winding down and <a href="http://www.Perlguy.net/images/kernel.jpg">Siv</a> is having a
barbeque at his house. So a few of us end up in a car, headed to the
barbeque. Uri Guttman is driving -- you know, the <a href="http://stemsystems.com">Stem guy</a> -- with myself riding
shotgun, and Ann and Larry in the backseat.</p>



<p>It's a friendly chatter and from one topic, it goes on to another. And
at one point, Perl6 is being discussed. Ann is asking questions about
the new operators, techniques and generally how shiny Perl6 will be. And
there, Larry explains us new and wonderous things. Some already
mentioned in 
<a href="http://www.Perl.com/pub/au/Wall_Larry">the apocalypses</a>,
some still ideas waiting to become firm concepts. And granted it does
sound good, very good... even if they are 
<a href="http://www.Perl.com/pub/a/2001/05/03/wall.html#rfc%20009:%20highlander%20variable%20types"> taking away my beloved arrow operator</a>.
Then, a question comes to mind, and I ask: "So Larry, tell me, does Perl
6 have multiline comments?"
</p>

<p>All I hear from the backseat is some grumbling and the 2 words: "use POD!";
</p>

<p>Needless to say, the tone was set, and I didn't see nor speak to Larry all evening.
</p>

<h3>Multi-line comments emulation in Perl</h3>
<p>But I disagree. I think multiline comments are good.
</p>
<p>I hate tinkering with the # sign and the 80 character-per-line limit; I write a comment over a few lines and prefix each with a #. Which of course means inserting a newline.
</p>
<p>Then I need to add a few words in the comments. The line becomes longer than 80 characters.
I need to add another newline. And add a new # sign. Remove the former # sign.
And now nothing is aligned anymore and I need to redo it.
<b>*sigh*</b>
</p>


<p>And apparently I'm not the only one who has had a gripe with this. It's been a consistent request for change through out the development of Perl 5, and here's a post on Perlmonks <a href="http://Perlmonks.org/index.pl?node_id=100344">discussing exactly this</a>
</p>
<p>The idea is to find a way of doing multi-line comments in Perl, without breaking things.
These are the four solutions they came up with to do multi-line comments, and why I think they are bad:
</p>



<p><b>1. Use POD</b>.
</p>

<p>For example, you could use:
</p>

<pre><code>
=for comment
  Commented text
=cut
</code></pre>

<p>It's POD. POD is documentation for users of your program. Pod is not
meant to display things like 'here i change <code>$var</code>' or 'this
part will only be executed if <code>$foo</code> is true, which is
determined by some_method()'; More over since the part you are
commenting <b>on</b> is not in POD format, it won't be displayed in the
first place. This will mean that the comments would be displayed in the
POD, but the piece of code they refer to, will not be. Granted, most POD
parsers are smart enough (or dumb, depending on how you look at it) that
they see that the <code>=for</code> is not something valid and ignore
it, whilst the Perl interpreter will say 'hey, it starts with
<code>=</code>, so it must be POD'; In the end, if you have the 'proper'
POD parser, you will get sort of what you want.
</p>

<p>But you are really circumventing the problem here, since you are relying
on the way any given POD parser parses POD; some might 'use warnings'
and report an invalid <code>=for</code> tag on some lines. Others will
just display them.
</p>
<p>And what we wanted was a way that would allow multi-line comments
without possibly breaking things.
</p>

<p><b>2. Any decent editor should allow you to put a # in front of n lines easily...</b>
</p>
<p>That's not an answer. We wanted multi-line comments, not an editor trick that allows me to do multiple single-line comments.
That and I'd rather not get into the 'vi is better than emacs' flamewar ;)
</p>

<p><b>3. use HERE-docs</b>
</p>
<pre><code>
&lt;&lt;'#';
this is a
multiline
comment
#

&lt;&lt; '*/';
this is a
multiline
comment
*/
</code></pre>

<p>This works, if you remembered to put a newline directly after the end
marker. Well, more accurately: it parses correctly. It's a here doc,
that means that variables WILL get interpolated if you use a double
quoted string.
</p>

<p>Meaning if you do something like this:
</p>

<pre><code>
use strict;
&lt;&lt;"#";
this is a
multiline
comment
about $foo
#
</code></pre>

<p>It will blow up right in your face with a compile time error.  Also,
when running under 'use warnings' --which you <b>should</b>-- this will
generate a '<code>Useless use of a constant in void context at foo.pl
line X</code>' warning.
</p>

<p>So not completely foolproof. Plus it looks ugly ;)
</p>

<p><b>4. use quote operators</b>
</p>

<pre><code>
q{
    some
    comment
};
</code></pre>

<p>Ok, a much more rigid solution and much more elegant.
Does it work? Yes.
</p>

<p>Well, almost. It runs under strict. But I didn't expect anything else,
since the guy who posted this (<a href="http://juerd.nl">juerd</a>) is an
experienced Perl hacker and probably knows what he's doing. <b>But</b> it does
cast warnings, just like the previous HERE-doc solution:
</p>

<pre><code>
'Useless use of a constant in void context at foo.pl line X'
</code></pre>

<p>Now, your comment is supposed to be there to help other coders, not to
be generating warnings. It's a <b>NO OP</b>! It shouldn't make them
think things are going wrong!
</p>













<h3>True multi-line comments: Acme::Comment</h3>

<p>So is there an answer to this?
</p>

<p>Well, when Ann pointed this out, I began to think there must be some way
to do multiline comments. I mean, many languages support it, why not
Perl? We claim to make everything as easy as possible, yet the easy
things aren't possible? That struck me as odd.
</p>
<p> This is where the writing of <code>Acme::Comment</code> began. First
to provide a more usable solution to multi-line commenting than the four
mentioned above, and secondly to just prove Perl doesn't have to suffer
from lack of multi-line comments.
</p>

<p>And this is how you use it:
</p>

<pre><code>
use Acme::Comment type =&gt; 'C++';

/*
    This is a comment ...

    ... C++ style!
*/
</code></pre>

<p> It's as simple as that. Now, to just do one language seemed a waste
of this idea. Many languages have nice multiline comments or even single
line comments. So, we decided to support a few more languages - in fact,
<a href="http://search.cpan.org/author/KANE/Acme-Comment/"> 44 in total
right now</a>
</p>

<p> Below are 5 styles of doing multi- or single-line comments in a
language that <code>Acme::Comment</code> supports. So let's play a game
of 'Name That Language'! (answers at the bottom)
</p>

<ul>
  <li> This language uses <code>(*</code> and <code>*)</code> as delimiters for 
    its multiline comments </li>
  <li> <code>!</code> is used to denote a single line comment in this programming 
    language </li>
  <li> Simply the word '<code>comment</code>' indicates a one line comment in 
    this language </li>
  <li> A single line comment is indicated by preceding it with: <code>DO NOTE 
    THAT</code> </li>
  <li> <code>\/\/</code> is the way to do a one line comment in this language 
  </li>
</ul>

<p>Contestants who answered all questions correct won a free subscription
to the <a href="/pub/a/2001/05/29/tides.htm"> Perl
beginners mailing list </a> at http://learn.perl.org, where they can
share their knowledge with others!
</p>

<p>Also, did you know, there were programming languages called:
Hugo, Joy, Elastic, Clean and Parrot?
</p>

<p>You can of course also create your own commenting style if you'd so desire, by saying:
</p>

<pre><code>
use Acme::Comment start =&gt; '[[', end =&gt; ']]';

[[
    This is a comment ...
    ... made by me!
]]
</code></pre>

<p>Putting the comment markers on their own line is always safest, since
that reduces the possible ambiguity, but this is totally left up to the
user. By default, you must put the comment markers on their own line
(only whitespace may also be on the same line) and you may not end a
comment marker on the line it begins.
</p>

<p>But if you were so inclined, you could also do:
</p>

<pre><code>
use Acme::Comment type =&gt; 'C++', one_line =&gt; 1, own_line =&gt; 0;

/* my comment */

/*  my
    other
    comment
*/
</code></pre>
<h3>The technology behind this</h3>

<p>So how does this all work anyway?
</p>

<p>Basically, <code>Acme::Comment</code> is a source filter. This means
that BEFORE the Perl interpreter gets to look at the source code,
<code>Acme::Comment</code> is given the chance to modify it.
</p>

<p>That means you can change <b>any</b> part of a source file into anything
else. In <code>Acme::Comment</code>'s case, it removes the comments from
the source, so they'll never be there when trying to compile.
</p>

<p> This is not something to be scared of, since comments are optimized
away during compile time anyway (the interpreter has no need for your
comments, why keep them?).
</p>

<p>Now, source filtering is not something that's terribly complicated and
is one of the immensely powerful features of recent versions of Perl.
It allows you to extend the language, simplify it it or even completely
recast it.
</p>


<p>As an example, here are two other (famous) uses of source filters in Perl:
</p>

<dl>
<dt>
    <a href="http://search.cpan.org/author/DCONWAY/Lingua-Romana-Perligata-0.50/lib/Lingua/Romana/Perligata.pm">
Lingua::Romana::Perligata</a>
</dt><dd> Which allows you to program in latin</dd>

<dt>
    <a href="http://search.cpan.org/author/DCONWAY/Switch-2.09/Switch.pm">
   Switch</a>
   </dt><dd>
    An extension to the Perl language, allowing you to use switch statements
</dd>
</dl>

<p>Now, <code>Acme::Comment</code> has a spiffy import routine that
determines what it needs to do with the options you passed it, and one
big subroutine that parses out comments (the largest part of the code is
spent on determining nested comments).
</p>

<p><code>Acme::Comment</code> uses, indirectly, the original source filter
module  called <code>Filter::Util::Call</code>. This module provides a
Perl interface to source filtering. It is very powerful, but not as
simple as it could be. It works roughly like this:
</p>
<ol>

  <li> Download, build, and install the <code>Filter::Util::Call</code> module. 
    (It comes standard with Perl 5.8.0) </li>
  <li> Then, set up a module that does a use <code>Filter::Util::Call</code>. 
  </li>
  <li> Within that module, create an <code>import</code> subroutine. </li>
  <li> Within the <code>import</code> subroutine do a call to <code>filter_add</code>, 
    passing it a subroutine reference. </li>
  <li> Within the subroutine reference, call <code>filter_read</code> or <code>filter_read_exact</code> 
    to "prime" <code>$_</code> with source code data from the source file that 
    will use your module. </li>
  <li> Check the status value returned to see if any source code was actually 
    read in. </li>
  <li> Then, process the contents of <code>$_</code> to change the source code 
    in the desired manner. </li>
  <li> Return the status value. </li>
  <li> If the act of unimporting your module (via a <code>no</code>) should cause 
    source code filtering to cease, create an <code>unimport</code> subroutine, 
    and have it call <code>filter_del</code>. </li>
  <li> Make sure that the call to <code>filter_read</code> or <code>filter_read_exact</code> 
    in step 5 will not accidentally read past the <code>no</code>. Effectively 
    this limits source code filters to line-by-line operation, unless the <code>import</code> 
    subroutine does some fancy pre-pre-parsing of the source code it's filtering. 
  </li>
</ol>

<p> As you can see, that's quite a few steps and things to think of when
writing your source filter module. Of course, to make everyone's life
easier when source filtering, <a href="http://conway.org">Damian</a>
wrote a wrapper around the <code>Filter::Util::Call</code> module,
called <code>Filter::Simple</code>. And although that limits the power you have
somewhat, the interface is much nicer. Here's what you need to do:
</p>

<ol>
  <li> Download and install the <code>Filter::Simple</code> module. (It comes standard 
    with Perl 5.8.0) </li>
  <li> Set up a module that does a <code>use Filter::Simple</code> and then calls 
    <code>FILTER { ... }</code>. </li>
  <li> Within the anonymous subroutine or block that is passed to <code>FILTER</code>, 
    process the contents of <code>$_</code> to change the source code in the desired 
    manner. </li>
</ol>
<p>And that's it.
</p>


<p> There is just one caveat to be mentioned: Due to the nature of
source filters, they will not work if you <code>eval</code> the file
the code is in.
</p>

<h3> How to make your own source filters</h3>

<p>Finally, I'll discuss some examples on how to set up your own source filters.
</p>

<pre><code>
package My::Filter;
use Filter::Simple;

### remove all that pesky 'use strict' and 'use warnings' ###
FILTER {
        s|^\s*use strict.+$||g;
        s|^\s*use warnings.+$||g;
    }
</code></pre>

<p>Now, if a module uses your My::Filter module, all mentions of 'use strict' and 'use warnings' will be removed, allowing for much easier compiling and running!
</p>

<p>Of course, <code>Filter::Simple</code> can do many more things. It can discriminate between different kinds of things it might find in source code. For example,
</p>

It can filter based on whether a part of text is:
<ul>
    <li> code (sections of source that are not quotelike, POD or __DATA__) </li>
    <li> executable (sections of source that are not POD or __DATA__) </li>
    <li> quotelike (sections that are Perl quotelikes as interpreted by Text::Balanced) 
    </li>
    <li> string (string literal parts of a Perl quotelike, like either half of 
      tr///) </li>
    <li> regex (sections of source that are regexes, like qr// and m//) </li>
    <li> all (the default, behaves the same as the FILTER block) </li>
</ul>


<p>Also, you can apply the same filter multiple times, and it will be checked in order. For example, here's a simple macro-preprocessor that is only applied within regexes, with a final debugging pass that prints the resulting source code:
</p>

<pre><code>
    use Regexp::Common;
    FILTER_ONLY
        regex =&gt; sub { s/!\[/[^/g },
    	regex =&gt; sub { s/%d/$RE{num}{int}/g },
    	regex =&gt; sub { s/%f/$RE{num}{real}/g },
    	all   =&gt; sub { print if $::DEBUG };
</code></pre>

<p>It understands the 'no My::Filter' directive and does not filter that part of the source.
</p>

<p>So you can say:
</p>
<pre><code>
    use My::Filter;

        { .. this code is filtered .. }

    no My::Filter

        { .. this code is not .. }
</code></pre>

<p>If you want to learn more about source filtering, take a look at the <a href="http://search.cpan.org/author/DCONWAY/Filter-Simple-0.78/lib/Filter/Simple.pm"><code>Filter::Simple</code> manpage</a>.
</p>
<h3>Answers to the comment game</h3>

<ol>
    <li> Bliss </li>
    <li> Fortran </li>
    <li> Focal </li>
    <li> Intercal </li>
    <li> Pilot </li>
</ol>



        </div>



    </div>
    <div class="asset-footer"></div>
</div>


                            
                            <div id="entry-1348" class="entry-asset asset hentry">
    <div class="asset-header">
        <h2 class="asset-name entry-title"><a href="/pub/2002/08/p6pdigest/20020811.html" rel="bookmark">This week on Perl 6 (week ending 2002-08-11)</a></h2>
        <div class="asset-meta">
            <span class="byline">
    
                By <span class="vcard author">Piers Cawley</span> on <abbr class="published" title="2002-08-11T00:00:00-08:00">August 11, 2002 12:00 AM</abbr>
    
            </span>

            
            

        </div>
    </div>
    <div class="asset-content entry-content">

        <div class="asset-body">
            
<!-- sidebar begins -->
<!-- don't move sidebars -->
<!-- sidebar ends -->

<p>Far out in the uncharted backwaters of the unfashionable end of the
Western Spiral arm of the Galaxy lies a small unregarded yellow
sun. Orbiting this at a distance of roughly ninety-eight million miles
is an utterly insignificant little blue-green planet whose
ape-descended life forms are so amazingly primitive that they still
think inventing programming languages is a pretty neat idea.</p>
<p>So, as one amazingly primitive life form to another, here's what's been going
on in Perl 6 development this week. As is becoming tediously
traditional, we'll start with the internals list...</p>

<h4><a name="array_vs._perlarray">Array vs. PerlArray</a></h4>
<p>Way back in the mists of a fortnight ago (that's 'two weeks' for the
unenlightened Americans among us.) Melvin Smith announced that he was thinking about
copying some of the fixes that had been made to the PerlArray PMC over
to array.pmc as well. This week, Steve Fink sent in a patch for an
alternative approach, which makes PerlArray a subclass of Array. Being
appropriately lazy, Steve also added some rather useful looking
keywords to the PMC parser, which added some shiny looking OO
features. He then delivered an extended, 3 post monologue in which he
kept replying to himself and refining his explanation of what the
patch did. When he finally stopped talking to himself Dan told him to
just commit it.</p>



<p>A side point in Steve's discussion with himself (and Sean O'Rourke off-list,
apparently) was the idea of dramatically simplifying default.pmc
so it just throws an exception for operations it doesn't know how to
deal with, rather than trying manfully to satisfy the demands of an
unreasonable programmer. Dan reckons he should go ahead and rip out
the old, obsequious code.</p>
<p><a href="http://groups.google.com/groups?selm=20020806202616.GC2114%40foxglove.digital-integrity.com">http://groups.google.com/groups</a> -- Start here</p>

<h4><a name="unifying_pmcs_and_buffers_for_gc">Unifying PMCs and Buffers for GC</a></h4>
<p>Mike Lambert had stepped up to this task and gave us a brain dump of
his plans. This week Jerome Vouillon wondered about the long term
plans for the Garbage collector, and wondered if we knew how to
implement a generational garbage collector when one has several
pools. Dan's long term plan for the outside world is that 'GC is a
black box that just works.' Internally, he doesn't care, so long as it
satisfies the 'just works' criterion. Mike Lambert thinks that a
generational collector shouldn't be too hard.</p>
<p>Josef 'how do I type "&ouml;" again?' H&ouml;&ouml;k wondered how/if
this would affect his matrix implementation, and when/whether his code
would be merged with the current tree. Dan answered that he was a
little concerned about PMCs which add code to the core, and Josef
explained that he wanted to be able to reuse some of the code in some
future multiarray.pmc</p>
<p><a href="http://groups.google.com/groups?selm=20020806133636.GB28828%40strontium.pps.jussieu.fr">http://groups.google.com/groups</a></p>
<p><a href="http://groups.google.com/groups?selm=Pine.GSO.4.21.0208050901150.4854-100000%40chicken.stacken.kth.se">http://groups.google.com/groups</a></p>

<h4><a name="register_allocation_for_the_jit">Register allocation for the JIT</a></h4>
<p>Nicholas Clark and Daniel Grunblatt held a learned discussion about
this, with particular reference to the ARM and i386
architectures. There were diagrams. And discussions of hardware
documentation. It was both scary and surprisingly easy to
understand. And a consensus was reached, which is nice.</p>
<p><a href="http://groups.google.com/groups?selm=20020805215944.GB301%40Bagpuss.unfortu.net">http://groups.google.com/groups</a></p>

<h4><a name="stack_mark_ops_&_such">Stack mark ops &amp; such</a></h4>
<p>Dan announced that he was 'about half a step from putting pushmark,
popmark, stack marks, and suchlike things into the core.' and that
this was everyone's opportunity to tell him what a bad idea it was. 
Jerome Vouillon wondered how they'd interact with continuations and
coroutines. Answer: 'Interestingly'. Jerome offered a code sample which may be
surprising, and asked Dan a hard question. Which Dan hasn't answered
yet.</p>
<p>Melvin Smith wondered if there was a real issue with continuations,
since each continuation got its own copy of the call stack. There is
an issue, but it'll likely be solved by documenting its existence.</p>
<p><a href="http://groups.google.com/groups?selm=a05111b14b973d63571a3%40%5B63.120.19.221%5D">http://groups.google.com/groups</a></p>
<p><a href="http://groups.google.com/groups?selm=20020805084317.GA24299%40strontium.pps.jussieu.fr">http://groups.google.com/groups</a></p>
<p><a href="http://groups.google.com/groups?selm=OF7220C971.8B8F54C5-ON85256C0C.00682E2A%40boulder.ibm.com">http://groups.google.com/groups</a></p>


<h4><a name="exceptions">Exceptions</a></h4>
<p>Dan posted his road map to exception handling. Or rather, he described
the two ops (<code>push</code> and <code>throw</code>) needed to do exception handling, but
punted on what an exception object should look like.</p>
<p>Florian Weimer wondered if it wouldn't be possible to handle exception
objects in the throwing context. Dan reckoned that this could be
problematic, which is why we're not going to do it 'at the moment'.</p>
<p>Jerome wondered if we really needed the <code>pushx</code> opcode at all. Tanton
Gibbs disagreed and there was some back and forth about that, and
about whether it made sense to think of a <code>return</code> as an exception
(it does, but only rarely, when you're writing your own control
structures; Damian will explain more later).</p>
<p>Dan also thought that <code>pushx</code> would be necessary, and Jerome
clarified his suggestion. Simon Glover wondered what happened when a
program didn't define an exception handler and was reassured that
there would be some kind of default (probably language specific)
handler in place, and if an exception got past that then Parrot would
handle it itself with a suitably 'big fit to STDERR' before dying in a
fit of pique.</p>
<p><a href="http://groups.google.com/groups?selm=a05111b18b97464ad4527%40%5B63.120.19.221%5D">http://groups.google.com/groups</a></p>
<p><a href="http://groups.google.com/groups?selm=20020805184917.GA25956%40strontium.pps.jussieu.fr">http://groups.google.com/groups</a> -- Discussion of
whether <code>pushx</code> is necessary starts here.</p>















<h4><a name="regex_speedup">Regex speedup</a></h4>
<p>Angel reposted his patch to the regex subsystem, this time with
appropriate diff flags. Brent Dax needed more clarification, which
Angel gave; Dan accepted that, given docs and tests, the patch could
go in. Angel made another patch with docs and tests, although Mike
Lambert then asked for more clarification, and pointed out some issues
with the <code>inline</code> keyword not being standard across all C
compilers. He also wondered if Brent's old 'Tutorial' docs could be
updated and reinstated. Angel responded with more clarification, and a
promise that the tutorial would go in when he'd rewritten it, and
commented that 'The previous Rx version had excellent documentation,
so it will take a bit of time to get there.'  I don't think this patch
has been applied yet.</p>
<p><a href="http://groups.google.com/groups?selm=200208060707.51991.afaus%40corp.vlex.com">http://groups.google.com/groups</a> -- Start here.</p>

<h4><a name="lexicals_and_globals_assembly_question">Lexicals and globals assembly question</a></h4>
<p>Brian Wheeler has been looking at <code>store_lex</code>, <code>find_lex</code>,
<code>store_global</code> and <code>find_global</code> and pointed out that the <code>store_*</code>
ops seemed to be the wrong way round, since the parrot rule is that
the destination is always the first operand. The response to this can
be summed up in one word: "Oops." Brian has patched it, and added
tests. Leopold Toetsch fixed things up in Builtins.pm.</p>
<p><a href="http://groups.google.com/groups?selm=1028600242.26459.3.camel%40thor">http://groups.google.com/groups</a></p>

<h4><a name="questions_about_pdd03_calling_conventions.pod">Questions about pdd03_calling_conventions.pod</a></h4>
<p>Jonathan Sillito asked a few questions about calling conventions, and
noticed that the <code>callcc</code> op appeared to be going the way of all
flesh. Dan answered the questions and remarked that callcc was to be
reinstated and shouldn't have disappeared in the first place. Sean
O'Rourke wondered why, since it could be replaced with calls to
<code>invoke</code> and other cleverness. Dan agreed. So <code>callcc</code> will stay
dead. (The only reason it was on the perch in the first place was
because it'd been <em>nailed</em> there.)</p>
<p><a href="http://groups.google.com/groups?selm=1028660270.5628.48.camel%40localhost.localdomain">http://groups.google.com/groups</a> -- Start here</p>

<h4><a name="hash_optimisations">Hash optimisations</a></h4>
<p>Having had a patch to remove a function call from the hash algorithm
accepted, Jason Greene offered a more comprehensive set of hash
optimisations. Dan applied the patch. Nicholas Clark and Steve Fink had a
few questions. Nicholas wondered why a constant had been changed, and
Steve worried about memory use. Dan reckoned that worrying about
memory to the tune of an unsigned int + alignment bytes at the expense
of speed was the wrong trade-off to make. However, the other subthread
had led to a different design which saved the space and only gave a
small performance hit in the less common case. Dan agreed.</p>
<p><a href="http://rt.perl.org/rt2/Ticket/Display.html?id=16032">http://rt.perl.org/rt2/Ticket/Display.html</a></p>

<h4><a name="various_pmc_issues">Various PMC issues</a></h4>
<p>Stephen Rawls is still trying to write <code>tuple.pmc</code>. Which means he's
been nosing around the sources of all the other PMCs, looking at how
they do things, so, he had a bunch of questions, mostly to do with
PerlNums and PerlInts. The answer to many of the questions appears to
be 'the problem will go away when we get multimethod dispatch'. Dan is
pouting because he had 'wanted to go with a left-side-wins scheme, but
alas correctness has trumped speed...'. Dan has promised details of
Parrot multimethods 'soonish'.</p>
<p><a href="http://groups.google.com/groups?selm=20020807132059.72848.qmail%40web14502.mail.yahoo.com">http://groups.google.com/groups</a></p>
<p><a href="http://groups.google.com/groups?selm=a05111b59b97848ff2ee9%40%5B63.120.19.221%5D">http://groups.google.com/groups</a></p>

<h4><a name="never_ending_story_keys">Never ending story Keys</a></h4>
<p>Josef wondered where we are with multi keyed access. Tom Hughes, who
has promised to have a go at fixing things wondered if he was waiting
for hell to freeze over. At which point it started 'snowing in Texas'
as Dan came through with the design. There was much rejoicing, and a
snowball fight was threatened. Tom had some questions (no surprise
there: when you're the one doing the implementation, there's almost
never enough information). Clarification was provided, as were
supplementary questions, and supplementary answers. As Blur put it so
eloquently: "Woohoo!"</p>
<p><a href="http://groups.google.com/groups?selm=Pine.GSO.4.21.0208071500540.15346-100000%40chicken.stacken.kth.se">http://groups.google.com/groups</a></p>
<p><a href="http://groups.google.com/groups?selm=a05111b55b977c7a65606%40%5B63.120.19.221%5D">http://groups.google.com/groups</a></p>

<h4><a name="hatchet_job_on_assemble.pl_/_the_fixup_table">Hatchet job on assemble.pl / the fixup table</a></h4>
<p>Brian Wheeler took an axe to the assembler and some associated files
and asked for comments on his plans. Dan liked the sound of it, so
Brian posted a patch. Leopold "How do you pronounce" Toetsch suggested
making it a standalone library so stuff could just <code>use Assembler</code>
instead of calling yet another external program. Sean O'Rourke asked
for a summary of what had changed, and Brian gave him one. (Oo er).</p>
<p><a href="http://groups.google.com/groups?selm=1028779066.11103.19.camel%40thor">http://groups.google.com/groups</a> -- proposal</p>
<p><a href="http://groups.google.com/groups?selm=1028819598.18442.1.camel%40thor">http://groups.google.com/groups</a> -- patch</p>
<p><a href="http://groups.google.com/groups?selm=1028832861.16081.19.camel%40wombat">http://groups.google.com/groups</a> -- summary</p>

<h4><a name="pmc_assignment_stuff">PMC assignment stuff</a></h4>
<p>Dan has been a positive goldmine of designs and specs this week. This
time he offered the design for a new PMC assignment opcode. We already
have <code>SET</code>, which copies the pointers and <code>CLONE</code> making a
'full clone', but we also need <code>ASSIGN</code> to 'stuff a value from one
PMC to another'. Peter Gibbs made a start on implementation and asked
for some clarification, which was forthcoming, and then supplied a
patch with his implementation, along with tests. Go Peter!</p>
<p><a href="http://groups.google.com/groups?selm=a05111b53b977b35492d3%40%5B63.120.19.221%5D">http://groups.google.com/groups</a></p>
<p><a href="http://groups.google.com/groups?selm=rt-16077-33219.1.71584723963818%40bugs6.perl.org">http://groups.google.com/groups</a></p>

<h4><a name="status_on_matrix_patch">Status on matrix patch?</a></h4>
<p>Josef is worried about what's happening to the matrix patch. Simon
Cozens used this as an opportunity to crack the worst joke yet seen on
any perl6 mailing list, but Josef appears not to have seen the film
and didn't get the joke. Anyhoo, back on the main line of the thread,
the problem seems to be that in order to have things sensibly
arranged, it made sense for Josef to break the <code>.pmc</code> file up into a
couple of .c and .h files, along with <code>matrix.pmc</code>, but there's
currently no scheme for multi-file PMC classes. Dan also thinks that
putting code into the parrot core just to facilitate code sharing
between PMCs is probably not the right answer. This appears to have
opened a can of worms. Dan is searching for a bigger can -- sorry --
designing the infrastructure that this needs.</p>
<p><a href="http://groups.google.com/groups?selm=Pine.GSO.4.21.0208090928370.24176-100000%40chicken.stacken.kth.se">http://groups.google.com/groups</a> --
Thread starts here.</p>
<p><a href="http://groups.google.com/groups?selm=86n0rwqtec.fsf%40squash.oucs.ox.ac.uk">http://groups.google.com/groups</a> -- Terrible joke...</p>

<h4><a name="constant_&_opcode_swap_ops">Constant &amp; opcode swap ops</a></h4>
<p>Dan offered designs to support multiple segment bytecodes, or at least,
to swap in constant tables. Steve Fink wondered if it might be a good
idea to wrap the interpreter in a PMC and use vtable methods to do
constant table manipulations etc. Dan thinks that's a great idea for
introspection, but worries that it'll slow things down if we make the
interpreter itself go through those hoops all the time. Nicholas Clark
also offered a few caveats ('Are you <em>sure</em> you want to do it this
way?', words to strike fear into the heart of any designer I
think). Dan isn't sure.</p>

<h4><a name="faster_assembler">Faster assembler</a></h4>
<p>Nicholas Clark offered a patch which makes
<code>Assembler::_generate_bytecode</code> faster. By around 1.5%. Dan applied
it. Sean O'Rourke offered more tweaks. Mattia Barbon had a patch which
meant that the tests could just 'use Parrot::Assembler' rather than
call assemble.pl, but the tweaks have outdated it. Dan and Nicholas
asked for the patch anyway because it would make remaking it easier.</p>
<p><a href="http://rt.perl.org/rt2/Ticket/Display.html?id=16114">http://rt.perl.org/rt2/Ticket/Display.html</a></p>

<h4><a name="perl_6_regexes...">Perl 6 regexes...</a></h4>
<p>Dan threw down the gauntlet of implementing Perl 6's regexes from
Apocalypse. Sean O'Rourke has apparently already taken it up.
I think we'll be seeing more of this thread next week...</p>
<p><a href="http://groups.google.com/groups?selm=a05111b05b97cecb019c0%40%5B63.120.19.221%5D">http://groups.google.com/groups</a></p>















<h3><a name="meanwhile,_in_perl6language">Meanwhile, in perl6-language</a></h3>
<p>The terribly named thread about different default values of true and
false rumbled on. Damian averred that code which 'relies on the poorly
specified standard values of truth and falsehood <em>deserves</em> to
break'. Damian also argues that Perl ought to have a <em>proper</em> boolean
type. After all, it has proper numeric and string types, and that they
should be used by all built ins. (Which does lead me to wonder about
code like <code>0 but true</code>). Chip reckons that the standard values of
truth and falsehood aren't <em>that</em> badly specified, it's not like
they've ever changed since perl 1, though he does agree that a 'real'
boolean would be nice. Elsewhere in the thread, Chip worried about the
scoping of operator definitions and Damian reassured him a bit.</p>
<p><a href="http://groups.google.com/groups?selm=3D4F0363.3050104%40conway.org">http://groups.google.com/groups</a></p>

<h4><a name="use_of_regular_expression_on_nonstrings">Use of regular expression on non-strings</a></h4>
<p>Threads in perl6-language seem to be longer lived than those over in
internals. I wonder why? This was another thread that started last week
and kept on going. David Whipp clarified his original question and
various people responded. Err... I'm not entirely sure how to
summarise this one, and following the threading is a tad tricky
because Mr Whipp's mailer doesn't do the <code>In-Reply-To:</code> thing.</p>
<p><a href="http://groups.google.com/groups?selm=F0DF160193C9D511B7110050DA8B7C24384755%40msexchange.intranet.fast-chip.com">http://groups.google.com/groups</a>
is probably as good a place as any to start looking.</p>

<h4><a name="autovivi">Autovivi</a></h4>
<p>Luke Palmer wondered how autovivification was going to work with
specific reference to <code>print %foo{bar}{baz}</code>. Would <code>%foo{bar}</code>
still be created if it didn't exist? Answer: "NO! Thank ghod!". Unless
Larry says otherwise.</p>
<p><a href="http://groups.google.com/groups?selm=Pine.LNX.4.33.0208051951001.10849-100000%40babylonia.flatirons.org">http://groups.google.com/groups</a></p>

<h4><a name="perl_summary_for_week_ending_20020804">Perl summary for week ending 2002-08-04</a></h4>
<p>See recursion. Miko O'Sullivan queried the throw-away comment that
regexes were now called 'rules' and wondered if the term 'regex' would
be going away. It turns out that I wasn't quite accurate, but that
Damian still reckons that 'regexes' should be deprecated in favour of
either 'rules' or 'patterns', at least in his own writing. For some
reason this ended up spinning off into a discussion of regular,
context-free and context-dependent languages and the nitty gritty
details of when an expression was regular or not. Mark J. Reed ended
up posting a fine essay to the list on the differences between the
various types.</p>
<p><a href="http://groups.google.com/groups?selm=97410-22002826122530518%40M2W089.mail2web.com">http://groups.google.com/groups</a></p>
<p><a href="http://groups.google.com/groups?selm=3D503FD2.6020405%40conway.org">http://groups.google.com/groups</a></p>
<p><a href="http://groups.google.com/groups?selm=20020808040500.GB17193%40charm.turner.com">http://groups.google.com/groups</a> -- Mark's essay.</p>

<h4><a name="while_<>_{_in_perl_6"><code>while &lt;&gt; {</code> in Perl 6</a></h4>
<p>Adam Lopresto wondered if the <code>while (&lt;</code>) {&gt; idiom (with appropriate
DWIMmery) would be necessary in Perl 6 since, given a lazy list
implementation, one could probably get by with <code>for &lt;&gt; {</code>. Trey
Harris agreed. So did Larry, sort of. He's leaning towards only having
<code>for &lt;&gt; {...}</code> do implicit topicalisation, <code>while</code> will require
you to be explicit (damn, another spamassassin trigger word...).</p>
<p><a href="http://groups.google.com/groups?selm=200208091745.g79HjnP02082%40express.cec.wustl.edu">http://groups.google.com/groups</a></p>
<p><a href="http://groups.google.com/groups?selm=Pine.LNX.4.44.0208091821370.5313-100000%40london.wall.org">http://groups.google.com/groups</a></p>

<hr />
<h3><a name="in_brief">In brief</a></h3>
<p>Piers Cawley missed the point about doing copy on write of the entire
stack when doing closuresque things. Various people explained, very
politely that he was wrong. In a moment of selfish editorial wossname,
I'll spare Piers's blushes by omitting the URL.</p>
<p>Josef added a couple of useful ops. Dan applied the patch, but wondered where
the tests were. Josef has, of course, tested the ops, but Dan wants
'Comprehensive tests in <code>t/</code> for everything' so we notice when we
break things later. Nicholas Clark raised the spectre of 'The Schwern
with the big stick.' if we failed to meet that testing goal.</p>
<p>Mike Lambert posted the first of his patches which will, eventually,
unify PMCs and buffers.</p>
<p>Steve Fink posted a patch to convert the hashtable from pointer based
to index based, making the GC system happier. Applied.</p>
<p>Angel Faus posted a 'loop discovery' patch for imcc which attempts to
avoid array spilling whilst in an inner loop. This patch was
applied. Then Leopold Toetsch pointed out a few bugs, and Angel posted
another patch, which hasn't been applied yet.</p>
<p>Andy Dougherty sent some patches to eliminate warnings under Solaris
8. Applied.</p>
<p>Jarkko sent in more warnings patches. Applied.</p>
<p>Sean O'Rourke offered a patch to hashes to do deep cloning. Dan asked
him to hold on a sec, adding that if he hadn't addressed the issue
inside a day or to we should nudge him. Dan, consider yourself
heartily nudged.</p>
<p>Peter Gibbs has removed the <code>set_string_unicode</code> and
<code>set_string_other</code> vtable methods, which are, frankly,
unnecessary. Leopold caught <code>perlundef.pmc</code>, which had been missed
from the original purge.</p>
<p>Jonathan Sillito offered a patch to give scratchpads a pointer to
their parent pads, and ended up with a new Scratchpad PMC. Warnock's
Dilemma applies.</p>
<p>Peter Gibbs offers <code>perlscalar.pmc</code>, Aldo Calpini asked a few
questions, and Warnock currently applies.</p>
<p>Daniel Grunblatt announced that the PPC JIT is now working.</p>
<p>Dan noted that there are some size restriction -- we need to make sure
that our chosen INTVAL is at least as big as a pointer. Andy Dougherty
pointed out some possible caveats and noted that his warnings patch
gave some assistance in this area.</p>
<p>Nicholas Clark found a bug in the assembler under perl 5.005_03. Simon
Glover agreed it was a bug, but nobody is quite sure how to fix
it. Nicholas is working on it though.</p>
<p>Boris "Thank heavens for cut and paste" Tschirschwitz wondered if the
headers of the various PDD (Parrot Design Documents) were kept up to
date, and if he could, in general, trust the docs to be accurate. Dan
reckons they should be mostly up to date. Patches are almost certainly
welcome.</p>
<p>In perl6-language, Chris Dutton wondered if we'd be able to create
anonymous classes ( <code>my $foo = class {...}</code> ) in the same way as we
currently create anonymous subs. Personally, I hope so. Chris worries
slightly about <code> my $foo_class $foo_obj = $foo_class.new </code>, but I
think he's getting his compile time and runtime constructs mixed
up. But what do I know?</p>
<p>SpamAssassin marked last weeks summary as spam in some mailboxes. John
Porter suggested that 'Maybe people should add SpamAssassin rule that
deducts 5 points if the message contains /leon brocard/ ?'</p>

<hr />
<h3><a name="who's_who_in_perl_6">Who's who in Perl 6</a></h3>
<dl>
<dt><strong><a name="item_who_are_you%3f">Who are you?</a></strong>
</dt>
<dd>
Dave Mitchell. I work for a small UK-based software company.
</dd>

<dt><strong><a name="item_what_do_you_do_for%2fwith_perl_6%3f">What do you do for/with Perl 6?</a></strong>
</dt>
<dd>
I wrote PDD7 (coding standards), then got sidetracked into fixing perl 5
instead. I intend to get more involved in Perl 6 post 5.8.0 release.
</dd>

<dt><strong><a name="item_where_are_you_coming_from%3f">Where are you coming from?</a></strong>
</dt>
<dd>
Sheffield?
</dd>

<dt><strong><a name="item_when_do_you_think_perl_6_will_be_released%3f">When do you think Perl 6 will be released?</a></strong>
</dt>
<dd>
In about 2 years, then ready for production use in a further year.
</dd>

<dt><strong><a name="item_why_are_you_doing_this%3f">Why are you doing this?</a></strong>
</dt>
<dd>
Because I love Perl and want to contribute to OSS development
</dd>

<dt><strong><a name="item_you_have_5_words%2e_describe_yourself%2e">You have 5 words. Describe yourself.</a></strong>
</dt>
<dd>
Lazy, apathetic, enjoyerofbugfixing, unsufferinggladlyoffools,
rabidsceptic.
</dd>

<dt><strong><a name="item_do_you_have_anything_to_declare%3f">Do you have anything to declare?</a></strong>
</dt>
<dd>
My lack of genius?
</dd>
</dl>
<hr />
<h3><a name="acknowledgements,_corrections,_threats_and_funding_drives">Acknowledgements, corrections, threats and funding drives</a></h3>

<csquery path="q/20" where="cs_rid != {cs_rid}">

<p>Nicholas Clark would just like to clarify that, as far as right shifts
of signed integers go, we should offer both arithmetic and logical
right shifts. He doesn't appear to have any preference about which
should be the default.</p>
<p>This summary was again prepared with the aid of GNER tea, supplemented
this week by a ham and cheese toasted sandwich, the toasted sandwich
of the gods (though their bacon and tomato toastie also has its
adherents I remain faithful to good old ham and cheese.)</p>
<p>Thanks are also due to the wonderful Pete Sergeant, and to a certain
person who I'll not mention again (but his favourite colour is orange)
for their excellent proofreading skills. Anything which may have snuck
past them (especially in this paragraph) is, of course, entirely my
fault.</p>
<p>If your name appears in this, or any previous summary and you've still
not sent me your answers to the perl6 questionnaire, please consider
doing so. My "Perl 6 Who's who?" archive hasn't run out yet, but it'd
be good to know that I'd got a good supply to fall back on.</p>
<p>Still no T?iBook, but this week's haul of egoboo is well up there. Many
thanks to the flatterers in <a href="mailto:perl-golf@perl.org.">perl-golf@perl.org.</a></p>
<p>If you didn't like this summary, write your own. Go on, I dare you. If
you did like it, send money to the Perl Foundation at
<a href="http://donate.perl-foundation.org/">http://donate.perl-foundation.org/</a> and remember, suitably large
donations will earn you or your company a plug in a future
summary. (You have to let me know though). See last week for
details. And you'll be helping to fund the next generation of Perl,
which will give you the warm fuzzies and a general feeling of virtue
and well being. In the words of Mrs Doyle, "Go on, go on, go on, go on!"</p>


        </div>



    </div>
    <div class="asset-footer"></div>
</div>


                            
                            <div id="entry-1338" class="entry-asset asset hentry">
    <div class="asset-header">
        <h2 class="asset-name entry-title"><a href="/pub/2002/08/07/proxyobject.html" rel="bookmark">Proxy Objects</a></h2>
        <div class="asset-meta">
            <span class="byline">
    
                By <span class="vcard author">Matt Sergeant</span> on <abbr class="published" title="2002-08-07T00:00:00-08:00">August  7, 2002 12:00 AM</abbr>
    
            </span>

            
            

        </div>
    </div>
    <div class="asset-content entry-content">

        <div class="asset-body">
            

<p>In your time as a Perl programmer, it becomes almost inevitable that
at some point you will have to manage in-memory tree structures of some
sort. When you do this, it becomes important to be aware of how Perl
manages memory, and when you might come up against a situation where
Perl will not free its memory -- a situation that can happen easily ... as we'll see below.</p>

<p>In writing the <a href="http://search.cpan.org/search?dist=XML-XPath"><code>XML::XPath</code></a>
module, (a library that implements some of the XML Document Object
Model, or DOM) I came across a particular problem with Perl's memory-management mechanism. In this article, I will detail the problem
and demonstrate a technique for building data structures that do not
exhibit this problem.</p>

<p>The problem is circular references.</p>
<h4><a name="What is a circular reference?">What Is a Circular Reference?</a></h4>

<p>Circular references are simply self-referential data structures
-- a complex data structure that at some point contains a reference to
a part of itself further up in the hierarchy. They are a useful idiom when
you need two parts of a structure to be able to refer to each other --
often we see them used in parent/child relationships, where a child
object might need access to the methods in the parent:</p>

<img src="/pub/2002/08/07/graphics/circular_ref.png" alt="figure 1" /> 
<p>The case we're concerned with here is an XML tree, where we have a
root node, and each node can have one or more children. In an XML DOM,
the child nodes need the ability to refer back to their parents:</p>

<pre><code>my $parent_name = $node-&gt;getParentNode()-&gt;getNodeName();</code></pre>

<p>While it is often extremely useful to encode this type of
relationship in your code, it is rather problematic for Perl.</p>

<h4><a name="Reference Counting" id="Reference Counting">Reference Counting</a></h4>

<p>Before we see why circular references are problematic, first we need
to understand how Perl's memory management works. In order to return
memory for use by other parts of your program when it becomes available,
Perl uses a technique called &quot;reference counted garbage
collection&quot;.</p>

<p>By using a count on each variable within Perl of the number of
references to that variable (the number of other things in your program
that refer to it), Perl's garbage collector can ensure timely
destruction of lexical variables (those created with <code>my</code>).
Each time the Perl interpreter sees something referencing that
variable, it increments the variable's internal reference count. When
the reference count goes down to zero, that variable's memory is freed,
and its destructor is called.</p>

<p>You can see the reference count of a variable using the
<code>Devel::Peek</code> module:</p>

<pre><code>use Devel::Peek;
my $x = &quot;Hello&quot;;
my $y = \$x;
Dump($x);</code></pre>
<p>Which outputs:</p>
<pre><code>SV = PV(0x804b85c) at 0x8057620
  REFCNT = 2
  FLAGS = (PADBUSY,PADMY,POK,pPOK)
  PV = 0x805d800 &quot;Hello&quot;\0
  CUR = 5
  LEN = 6</code></pre>

<p>The important field for these purposes is the REFCNT field, which
shows us there are two references to our variable - one for the
<i>main</i> copy of the variable (the one we see as <code>$x</code>) and
one for the <i>reference</i> that <code>$y</code> holds.</p>

<h4><a name="Reference Counting with Circular References">Reference Counting with Circular References</a></h4>

<p>Reference counting works well until you need to build self-referencing data structures. Let's look again at the design of our XML
DOM library, where children need access to their parent nodes. The DOM
specification requires you to maintain a two-way relationship between
the parent and the child nodes. This leads to our <i>circular
reference</i> -- the parent holds a reference to the child, and the
child holds a reference to the parent.</p>

<h5><a name="Circular References in Detail">Circular References in
Detail</a></h5>

<p>Circular references occur when a variable either directly or
indirectly refers to itself somehow. We can easily show this using hash
references and Devel::Peek again:</p>

<pre><code>use Devel::Peek;
for (1..1) { # enter scope here
  my %x = ();
  my %y = ();
  $x{child} = \%y;
  $y{parent} = \%x;
  Dump(\%x);
} # leave scope here</code></pre>

<p>Now we can see that both variables have a refcount of 2 (the 3 for %x
is because we have to take an extra reference in order to
<code>Dump()</code> it):</p>

<pre><code>...
SV = PVHV(0x8060b40) at 0x805702c
  REFCNT = 3               ### This is %x
  ...
  Elt &quot;child&quot; HASH = 0x77420b6
  SV = RV(0x8063008) at 0x804b494
    REFCNT = 1
    FLAGS = (ROK)
    RV = 0x8056fe4
    SV = PVHV(0x8060ba0) at 0x8056fe4
      REFCNT = 2           ### This is %y
      ...
      Elt &quot;parent&quot; HASH = 0xcc03940
      SV = RV(0x806300c) at 0x8056f84
        REFCNT = 1
        FLAGS = (ROK)
        RV = 0x805702c</code></pre>

<p>Now problems arise. When <code>%y</code> goes out of scope, it
cannot be completely garbage collected, because its reference count was
2, not 1. <code>%x</code> also cannot be garbage collected (if it could,
then it would free the extra reference to <code>%y</code>) for the same
reason. So we end up with two zombie variables, which can neither be
garbage collected nor freed back to the system. This is why we get what
appears to be memory leaks when we use circular references. Had we
modified our <code>for ()</code> loop to repeat more than once, we would
see our memory usage steadily growing.</p>

<p>Rather than proving this by watching our memory grow though, we can
demonstrate what his happening with <i>objects</i>. We can create a
simple object and output something in its <code>DESTROY</code> method:</p>

<pre><code>package CircObj;
sub new { bless {}, shift }
sub parent { my $self = shift; @_ ? $self-&gt;{parent} = 
    shift : $self-&gt;{parent} }
sub child { my $self = shift; @_ ? $self-&gt;{child} = 
    shift : $self-&gt;{child} }
sub DESTROY { warn(&quot;CircObj::DESTROY\n&quot;) }</code></pre>

<p>Now a normal instance of this will output the destroy method as soon
as its scope exits:</p>

<pre><code>{
  my $x = CircObj-&gt;new();
  warn(&quot;Leaving scope\n&quot;);
}
warn(&quot;Scope left\n&quot;);</code></pre>
<p>Results in the following output:</p>
<pre><code>Leaving scope
CircObj::DESTROY
Scope left</code></pre>
<p>However, if we fill in our circular references, then we get a different result:</p>
<pre><code>for (1..1) {
  my $parent = CircObj-&gt;new;
  my $child = CircObj-&gt;new;
  $parent-&gt;child($child);
  $child-&gt;parent($parent);
  warn(&quot;Leaving scope\n&quot;);
}
warn(&quot;Scope left\n&quot;);</code></pre>
<p>And we see the output:</p>
<pre><code>Leaving scope
Scope left
CircObj::DESTROY
CircObj::DESTROY</code></pre>

<p>What this means is our variables are only getting
<code>DESTROY</code>ed when the Perl interpreter does its global
cleanup -- at the time our program exits, not in the timely manner we
are used to with normal objects. This may not be too problematic for
some scripts, but if you're running any sort of large program, or a long-running persistent interpreter like <code>mod_perl</code>, then you will see
your memory steadily grow as you do this repeatedly.</p>

<p>A common way to &quot;fix&quot; this problem is to use a manual
destructor -- a method or function call that breaks the circle somehow.
In our original hashes example, this is as simple as adding <code>delete
$x{child}</code> to our code (deleting <code>$y{parent}</code> is
optional then, as the circle is already broken), and in the object
example we can supply a <code>destroy()</code> method that the user can
call before exiting the scope. But neither of those options is terribly
user friendly, and I believe in letting people who use my modules to
expect it to &quot;just work&quot;.</p>
















<h3><a name="Fixing Circular References - with Perl 5.6+" id="Fixing Circular References - with Perl 5.6+">Fixing Circular References - with Perl 5.6+</a></h3>

<p>Perl 5.6.0 introduced a new feature to &quot;fix&quot; all of the
problems with circular references. This feature is called
<i>weakrefs</i>. The basic idea is to flag a reference as
<i>weakened</i>, so as to not include it in the reference counting. In
order to use weakrefs, you need to install the <a href="http://search.cpan.org/doc/GBARR/Scalar-List-Utils-1.0701/lib/Scalar/Util.pm">Scalar::Util</a>
module (which is included with Perl 5.8.0). It is simple to use.
Let's see what happens with our example above:</p>

<pre><code>package CircObj;
  use Scalar::Util qw(weaken);
  sub new { bless {}, shift }
  sub parent { my $self = shift; @_ ? <b>weaken</b>($self-&gt;{parent} = 
       shift) : $self-&gt;{parent} }
  sub child { my $self = shift; @_ ? $self-&gt;{child} = 
       shift : $self-&gt;{child} 
  }
  sub DESTROY { warn(&quot;CircObj::DESTROY\n&quot;) }
  
  for (1..1) {
  &nbsp;&nbsp;my $parent = CircObj-&gt;new;
  &nbsp;&nbsp; my $child = CircObj-&gt;new;
  &nbsp;&nbsp; $parent-&gt;child($child);
  &nbsp;&nbsp; $child-&gt;parent($parent);
  &nbsp;&nbsp; warn(&quot;Leaving scope\n&quot;);
  }
warn(&quot;Scope left\n&quot;);</code></pre>

<p>It's important to note that we only need to weaken our parent reference -- since one reference is OK. But this time, it outputs the expected:</p>
<pre><code>Leaving scope
CircObj::DESTROY
CircObj::DESTROY
Scope left</code></pre>
<p>The <code>weaken</code> method is well-proven, and is a stable way to ensure that circular references don't mess up the operation of Perl's garbage collector. You should definitely use them if you can -- for example in your in-house code.</p>
<p>However, that still leaves CPAN module authors and those stuck with Perl 5.005 with a problem: what do we do with older versions of Perl?</p>
<h3><a name="Fixing Circular References - with Perl 5.00503 and lower" id="Fixing Circular References - with Perl 5.00503 and lower">Fixing Circular References - with Perl 5.00503 and Lower</a></h3>

<p>Anyone who works for a large company, or who puts out open-source
Perl modules, will know that there are still an awful lot of people using
Perl 5.00503 -- upgrading takes time, and many people are running older
OS's that only come with Perl 5.00503.</p>

<p>So we have to get inventive -- we need some proxy objects.</p>

<p>Proxy objects are a way to access objects indirectly via another
object. The term proxy object is from the Design Patterns book (<a href="http://hillside.net/patterns/DPBook/DPBook.html">http://hillside.net/patterns/DPBook/DPBook.html</a>).
A proxy object works by being an intermediary between an object and its
methods -- passing all communication on to the real object, perhaps
after doing something based on the method called. We can implement a
basic proxy object in Perl using AUTOLOAD:</p>

<pre><code>package ProxyObject;

sub new {
  my $class = shift;
  my $real_obj = shift;
  my $self = { real_obj =&gt; $real_obj };
  return bless $self, $class;
}

sub AUTOLOAD {
  my $self = shift;
  my $method = $AUTOLOAD;
  $method =~ s/.*:://;
  warn(&quot;Proxying: $method\n&quot;);
  $self-&gt;{real_obj}-&gt;$method(@_);
}

1;</code></pre>
<p>And we can use that as follows:</p>
<pre><code>use ProxyObject;
use Time::localtime;
my $time = localtime();  
### Create a localtime object
my $proxy = ProxyObject-&gt;new($time);  
### Create a proxy to that object
print $time-&gt;hour, &quot; is the same as &quot;, $proxy-&gt;hour, &quot;\n&quot;;</code></pre>
<p>Which gives us the output:</p>
<pre><code>Proxying: hour
14 is the same as 14
Proxying: DESTROY</code></pre>
<p>So, this all looks very interesting, but you're probably wondering
how that helps with circular references. Well, let's look at a circular-reference example that uses ProxyObject:</p>
<pre><code>package CircObj;
sub new { bless {}, shift }
sub parent { my $self = shift; @_ ? $self-&gt;{parent} = 
     shift : $self-&gt;{parent} }
sub child { my $self = shift; @_ ? $self-&gt;{child} = 
     shift : $self-&gt;{child} }
sub DESTROY { warn(&quot;CircObj::DESTROY\n&quot;) }

use ProxyObject;
for (1..1) {
  my $parent = CircObj-&gt;new;
  my $child = CircObj-&gt;new;
  my $proxy = ProxyObject-&gt;new($parent);
  $parent-&gt;child($child);
  $child-&gt;parent($parent);
  warn(&quot;Leaving scope\n&quot;);
}
warn(&quot;Scope left\n&quot;);</code></pre>
<p>Now what we see from our output is:</p>
<pre><code>Leaving scope
Proxying: DESTROY
CircObj::DESTROY
Scope left
CircObj::DESTROY
CircObj::DESTROY</code></pre>
<p>So we have made some progress; the DESTROY method on our <code>$parent</code> variable is now called, albeit twice. But what we can do now is use that call to DESTROY to break our reference loop. To do this, we implement a small DESTROY method in our class that clears out the circular reference:</p>
<pre><code>package CircObj;
...
sub DESTROY {
  my $self = shift;
  warn(&quot;CircObj::DESTROY\n&quot;);
  if ($self-&gt;{child}) {
    $self-&gt;{child}-&gt;parent(undef); 
	# set child's parent to undef, breaking the loop
  }
}</code></pre>
<p>Which finally leads to the desired output:</p>
<pre><code>Leaving scope
Proxying: DESTROY
CircObj::DESTROY
CircObj::DESTROY
CircObj::DESTROY
Scope left</code></pre>
<p>Of course, this being Perl, it is possible to wrap all of this up into a fairly simple class, which I'll demonstrate in the next section.</p>
<h4><a name="Problems With This Technique" id="Problems With This Technique">Problems With This Technique</a></h4>

<p>There is one major problem with this technique: It's possible to
confuse the garbage collector with it. The easiest way to see this
happen is if you build a tree using the above technique, and then hold
onto a sub-tree while letting the root of the tree go out of scope. All
of a sudden you'll find your data structure has become untangled, like
so much wool from a snagged jumper. Unfortunately, there's little
you can do about this, except perhaps for allowing the use of a
proxy object as an option, and providing a method for freeing the tree
that manually breaks the links. This is what XML::XPath does: By
specifying <code>$XML::XPath::SafeMode = 1</code> at runtime, you can
switch this behavior on and off.</p>

<p>Another problem is that every property access now needs to go through
method calls. If you have the proxy object (which is just a simple hash
ref in this example, but could be a scalar ref), then you can't try and access
the hash entries directly and expect to get those in the object we are
proxying to. You may be able to get this working via the TIE mechanism,
but it doesn't come for free. So we potentially lose some speed this
way, though you should be using methods anyway for the sake of
encapsulation.</p>
















<h3><a name="Doing The Right Thing" id="Doing The Right Thing">Doing the Right Thing</a></h3>

<p>What we can now do (in true Blue Peter fashion) is create a module
that has totally transparent weak-references support on Perl 5.6, while
still allowing garbage collection on lower Perl versions. This is a
little more complex than the scenario above, but here's how it works.
First, we create a base class that our complex data-structure classes
can subclass:</p>

<pre><code># base class for all circular reffing classes 
# rename this before use
package BaseClass;
use strict;</code></pre>
<p>In that class we do some compile-time checking for Scalar::Util:</p>
<pre><code>BEGIN {
  eval &quot;use Scalar::Util qw(weaken);&quot;;
  if ($@) {
    $BaseClass::WeakRefs = 0;
  }
  else {
    $BaseClass::WeakRefs = 1;
  }
}</code></pre>
<p>Next, we create a clever constructor. This constructor turns our class name (e.g. &quot;XML::MyDOM::Node&quot;) into an implementation class name (&quot;XML::MyDOM::NodeImpl&quot;), and constructs an object of that type. Then if weak refs are available, then it returns that object, otherwise it constructs a proxy object that proxies to that object, and returns the proxy object instead:</p>
<pre><code>sub new {
  my $class = shift;
  no strict 'refs';
  my $impl = $class . &quot;Impl&quot;;
  my $this = $impl-&gt;new(@_);
  if ($BaseClass::WeakRefs) {
    return $this;
  }
  my $self = \$this;
  return bless $self, $class;
}</code></pre>
<p>Finally, we have a more advanced version of our proxy object's AUTOLOAD method. This does some error checking to ensure that unknown methods are detected correctly, and that methods on this class are executed in the correct way. But otherwise it's doing exactly the same job as our original:</p>
<pre><code>sub AUTOLOAD {
  my $method = $AUTOLOAD;
  $method =~ s/.*:://; # strip the package name
  no strict 'refs';
  *{$AUTOLOAD} = sub {
    my $self = shift;
    my $olderror = $@; # store previous exceptions
    my $obj = eval { $$self };
    if ($@) {
      if ($@ =~ /Not a SCALAR reference/) {
        croak(&quot;No such method $method in &quot; . ref($self));
      }
      croak $@;
    }
    if ($obj) {
      # make sure $@ propogates if this method call was the result
      # of losing scope because of a die().
      if ($method =~ /^(DESTROY|del_parent_link)$/) {
        $obj-&gt;$method(@_);
        $@ = $olderror if $olderror;
        return;
      }
      return $obj-&gt;$method(@_);
    }
  };
  goto &amp;$AUTOLOAD;
}

package BaseClassImpl; # Implementation class

sub new { die &quot;Virtual base class&quot; }

# All base class methods go below here

1;</code></pre>
<p>Now, all classes derived from that need to look like this:</p>
<pre><code>package CircRefClass;
@ISA = ('BaseClass');

package CircRefClassImpl;
@ISA = ('BaseClassImpl', 'CircRefClass');

sub new {
  my $class = shift;
  # ordinary constructor here
  my $self = bless {}, $class;
  # ... yada yada yada
  return $self;
}

sub DESTROY {
  my $self = shift;
  # Break child's link to me here
  $self-&gt;child-&gt;del_parent_link();
}

sub set_parent {
  my $self = shift;
  if ($BaseClass::WeakRefs) {
    Scalar::Util::weaken($self-&gt;{parent} = shift);
  }
  else {
    $self-&gt;{parent} = shift;
  }
}

sub del_parent_link {
  my $self = shift;
  $self-&gt;{parent} = undef;
}

# All class methods here

1;</code></pre> <p>And that's about all you need to change. The rest of your
methods can remain the same, as long as they are moved to the
<code>Package<b>Impl</b></code> class, rather than the
<code>Package</code> class. And this will auto-detect the presence of
Scalar::Util's <code>weakref()</code> method and use it accordingly if
it's available.</p>

<p>The complicated work is in the <code>AUTOLOAD</code> class in the
<code>BaseClass</code> package. The reason it looks so complex is
because it implements a method cache for autoloaded methods, ensuring
that this implementation won't slow down your program.</p>

<p>Also note that you can rename the <code>del_parent_link</code> and
<code>set_parent</code> methods if those names aren't appropriate for
your application. They just happen to work for a tree structure.</p>

<h3><a name="Conclusions">Conclusions</a></h3>
<p>Circular references are a useful tool, and sometimes a neccessary evil. 
By using methods available to Perl 5.6 and up, combined with a custom proxying technique, we 
can create classes that implement circular references while still managing to be garbage collected 
on all versions of Perl. This is a powerful design to add to your Perl programmer's toolbox.</p>



        </div>



    </div>
    <div class="asset-footer"></div>
</div>


                            
                            <div id="entry-1336" class="entry-asset asset hentry">
    <div class="asset-header">
        <h2 class="asset-name entry-title"><a href="/pub/2002/07/p6pdigest/20020805.html" rel="bookmark">This week on Perl 6 (week ending 2002-08-04)</a></h2>
        <div class="asset-meta">
            <span class="byline">
    
                By <span class="vcard author">Piers Cawley</span> on <abbr class="published" title="2002-08-05T00:00:00-08:00">August  5, 2002 12:00 AM</abbr>
    
            </span>

            
            

        </div>
    </div>
    <div class="asset-content entry-content">

        <div class="asset-body">
            

<p>Back on the regular schedule complete with new and improved article
links via those lovely people at Google groups. Hopefully, we'll be
staying on this schedule for the foreseeable future.</p>
<p>As usual, we'll kick off with perl6-internals, which was, once again,
the busiest group this week.</p>

<h3><a name="we_need_more_ops">We Need More Ops</a></h3>
<p>This thread rumbled on (slowly) with a mixture of serious and
humorous messages. Melvin Smith worried that parrot would turn into
"a Linux kernel and forever accumulates custom ops, PMCs."</p>
<p>The appropriately named Eric Kidder proposed ':-) the Positivity
operator. Nobody threw peanuts.</p>
<p><a href="http://groups.google.com/groups?selm=OF2F640760.61E2BEAB-ON85256C06.00629F21%40boulder.ibm.com">http://groups.google.com/groups</a></p>
<p><a href="http://groups.google.com/groups?selm=Pine.LNX.4.33.0207291440190.31214-100000%40persian.evilkitten.org">http://groups.google.com/groups</a></p>

<h3><a name="of_mops,_jit_and_perl6">Of Mops, JIT and perl6</a></h3>
<p>This thread kicked off the week before, but carried on into this
week. Leopold Toetsch had got some MOPS numbers for various bits of
parrot, including the perl6 mini language. Dan wondered whether the perl6
numbers included the time to generate the assembly and assemble it,
because the assembler is 'rather slow.' Sean reckoned that, compared
to the parser, the assembler was quick and that he suspects that even
without that the perl6 numbers "would suck, since the compiler does
some pretty heavy pessimization." Melvin Smith reckoned that imcc may
have had something to do with the slowness as well, because it didn't
do the right thing with loop invariants, but that "things can only get
better."</p>
<p>Leopold then told us that the numbers were pure runtime and that the
compilation phase added 2.3 seconds to the whole
process. Ick. However, following a bugfix to perlarray.pmc he posted
new numbers that were "not that abysmal," and that we already have the
same MOPS as perl5 ... .</p>
<p><a href="http://groups.google.com/groups?selm=3D43AEF1.5070203%40toetsch.at">http://groups.google.com/groups</a></p>
<p><a href="http://groups.google.com/groups?selm=Pine.GSO.4.33.0207291943160.11486-100000%40beowulf.ucsd.edu">http://groups.google.com/groups</a></p>
<p><a href="http://groups.google.com/groups?selm=3D464CEA.3040407%40toetsch.at">http://groups.google.com/groups</a></p>

<h3><a name="dan_sugalski_is_back">Dan Sugalski Is Back</a></h3>
<p>And it's like he never went away. At the top of his list is catching
up with his mail, sorting out keys, defining the extension mechanism,
the exception infrastructure, ruthless efficiency and a fanatical
devotion to the Pope.</p>
<p>He also suggested that if someone were to implement the <code>cmpi</code> and
<code>cmps</code> ops for integer and string comparison, then that would be a
good thing. Sean O'Rourke asked questions about that, and
the semantics of <code>2 &lt; $i++ &lt; 23</code> were discussed</p>
<p><a href="http://groups.google.com/groups?selm=a05111b0ab96b50e9cb64%40%5B192.168.0.190%5D">http://groups.google.com/groups</a> -- Start here.</p>

<h3><a name="regex_speedup">Regex Speedup</a></h3>
<p>Angel Faus has been working on the regex engine and provided a patch
for it, "designed with the single goal of seriously cheating for
speed." Dan applauded and claimed to be feeling "decidedly
superfluous", but wondered whether Angel could use the -u or -c switches to
diff next time.</p>
<p>Also on the regex front, Stephen Rawls offered some better
documentation of the regex subsystem.</p>
<p><a href="http://rt.perl.org/rt2/Ticket/Display.html?id=15797">http://rt.perl.org/rt2/Ticket/Display.html</a></p>
<p><a href="http://rt.perl.org/rt2/Ticket/Display.html?id=15876">http://rt.perl.org/rt2/Ticket/Display.html</a></p>

<h3><a name="arm_jit_v2">ARM JIT v2</a></h3>
<p>Nicholas Clark released a "very minimal" ARM JIT framework. The
initial version only JITed a small number of trivial ops, but it's
the framework that was important. Daniel Grunblatt sent Nicholas a
copy of the work he'd done in that area and we ended up with a new,
unified patch that handled a whole lot more ops, and which wondered
where the PPC JIT had got to. It turns out that Daniel is working on
that, too. Go Daniel.</p>
<p>On the subject of JITs, Jarkko Hietaniemi, fresh from his trials as
the perl 5.8 pumpking popped up with a survey of the state of the JIT
art in parrot. Apparently we're still missing PPC and POWER, MIPS,
HPPA and IA64. Jarkko intends to "do nothing on these except raise
gui^H^H^Hawareness :-)". Which is nice of him.</p>
<p>Nicholas also wondered whether he was "allowed to write ancillary functions
I want the JIT to call in assembler?" Dan reckoned that, in a JIT,
"evil things for speed reasons are almost obligatory."</p>
<p><a href="http://groups.google.com/groups?selm=20020729220305.GC354%40Bagpuss.unfortu.net">http://groups.google.com/groups</a></p>
<p><a href="http://groups.google.com/groups?selm=20020803214000.GD7878%40Bagpuss.unfortu.net">http://groups.google.com/groups</a></p>
<p><a href="http://groups.google.com/groups?selm=20020730200100.M22826%40alpha.hut.fi">http://groups.google.com/groups</a></p>
<p><a href="http://groups.google.com/groups?selm=20020801204207.GB378%40Bagpuss.unfortu.net">http://groups.google.com/groups</a></p>

<h3><a name="lexical_scope_ops,_test_and_example">Lexical Scope Ops, Test and Example</a></h3>
<p>Jonathan Sillito offered a patch that implements lexical pads and
some ops to manipulate them. Stephen Rawls pointed out a bug in the
implementation, and Dan agreed that it was a bug but that once that
was fixed the patch should go in, because "it gets a good chunk of the
semantics we need." (Speaking as someone who keeps making noises about
implementing Scheme in parrot, having parrot native lexicals will be
a *huge* win.) So, Jonathan fixed it, and Melvin applied it.</p>
<p>This led Jerome Vouillon to wonder whether we actually needed explicit
lexicals and scratchpads. The thread is rather tricky to summarize, so
I'll just point you at it. However, Dan chimed in to say that, for now
at least, he'd rather keep the separate interface to lexicals and
globals because it would make changing the implementation possible
without breaking existing bytecode.</p>
<p><a href="http://rt.perl.org/rt2/Ticket/Display.html?id=15800">http://rt.perl.org/rt2/Ticket/Display.html</a></p>
<p><a href="http://rt.perl.org/rt2/Ticket/Display.html?id=15846">http://rt.perl.org/rt2/Ticket/Display.html</a></p>
<p><a href="http://groups.google.com/groups?selm=20020731162554.GA6430%40strontium.pps.jussieu.fr">http://groups.google.com/groups</a></p>

<h3><a name="unifying_pmcs_and_buffers_for_gc.">Unifying PMCs and Buffers for GC.</a></h3>
<p>Dan has accepted that we need to unify PMCs and strings/buffers for GC
purposes, and asked for volunteers. Mike Lambert stepped forward (or
maybe everyone else took one pace back). Again, this thread is hard to
summarize because it's so information dense. If you're interested, then you
should read the whole thread.</p>
<p><a href="http://groups.google.com/groups?selm=a05111b01b96dcf8d857a%40%5B63.120.19.221%5D">http://groups.google.com/groups</a></p>
















<h3><a name="negative_indices_in_arrays.">Negative Indices in Arrays.</a></h3>
<p>Stephen Rawls wondered about what happened when someone did <code>@foo =
(1,2); @foo[-3]</code>. This is an error in Perl5. As Dan put it, so
elegantly, "Larry? Semantic call for you on the white telephone."
Larry has, so far, not responded.</p>
<p><a href="http://groups.google.com/groups?selm=20020801134633.57340.qmail%40web14501.mail.yahoo.com">http://groups.google.com/groups</a></p>

<h3><a name="resize_array_(perlarray)">resize_array (PerlArray)</a></h3>
<p>Aldo Calpini discovered that the parrot equivalent of <code> @foo = (1,2);
print @foo[9999];</code> would magically extend <code>@foo</code> to contain 10,000
elements -- which isn't exactly ideal. This spun off into a discussion
of autovivification, especially with nested arrays. Dan pointed out
that Perl 5's current behavior when you, for example, <code>print
$a[10000][0]</code> is an artifact of the way multidimensional arrays work
in Perl 5, and that most people would be happy if it went away in Perl
6. (Personally, I'd be happy if it went away in perl 5.9, but that's
another mailing list.)</p>
<p><a href="http://groups.google.com/groups?selm=180-1602283812.20020801172812%40alos.it">http://groups.google.com/groups</a></p>

<h3><a name="sub/continuation/dlsym/coroutine_cleanup">sub/continuation/dlsym/coroutine cleanup</a></h3>
<p>Sean O'Rourke offered a patch that "implements native extensions and
continuations as PMCs. It also cleans up the existing "Sub and
Coroutine types," and removes a load of now obsolete ops that are now
handled through <code>invoke</code>. For some bizarre reason, SpamAssassin
thought his message was infected with Klez -- which isn't good.</p>
<p>The patch doesn't handle lexicals automatically yet. This may be good
or bad, we haven't reached consensus yet, and Dan hasn't settled on a
position either. Jerome Vouillon suggested a couple of changes, and
Sean O'Rourke agreed. Nicholas Clark wondered whether this meant that loop
variables would only have to be allocated once; which looked nice.</p>
<p><a href="http://groups.google.com/groups?selm=Pine.GSO.4.33.0207302056330.12563-101000%40beowulf.ucsd.edu">http://groups.google.com/groups</a></p>

<h3><a name="meanwhile,_over_in_perl6language">Meanwhile, Over in Perl6-language</a></h3>
<p>Phew. I always like it when I get to switch lists. It generally means
the finish line is in sight because perl6-language is usually much
quieter than p6i. (My how times have changed; I'm <em>really</em> glad I
wasn't writing the summaries back in the RFC days ... .)</p>

<h3><a name="a_light_and_refreshing_summer_fruit_salad">"A Light and Refreshing Summer Fruit Salad"</a></h3>
<p>That's how Miko O'Sullivan described his collection of ideas for the
Perl6 language. At least one of his proposals is already implemented
in perl5, but it still sparked a lively and generally interesting
thread. Especially when Damian started doing tricks with operator
definitions and grammar munging. Trey Harris proposed the rather
wonderful <code>no strict 'physics'</code>, which made <em>me</em> smile. Damian also
points out in this thread that the new, Perl6 word for `regex' will be
`rule' because, well, they're no longer regular, and they'll often
live in grammars.</p>
<p>Damian also mentioned that there was some thought of making composite
objects the topic within their subscript brackets, which would enable
some powerful slicing operations: <code>@public = %hash{ /^(&lt;-[_]+&gt;.*)/
};</code> anyone? There's some debate as to whether this would violate the
principle of least surprise though.</p>
<p><a href="http://groups.google.com/groups?selm=001d01c239a7%2418517b30%24040a0a0a%40mosullivan">http://groups.google.com/groups</a></p>
<p><a href="http://groups.google.com/groups?selm=3D4B05E4.4050909%40conway.org">http://groups.google.com/groups</a></p>
<p><a href="http://groups.google.com/groups?selm=3D49E127.302%40conway.org">http://groups.google.com/groups</a></p>

<h3><a name="use_of_regular_expressions_on_non_strings.">Use of Regular Expressions on Nonstrings.</a></h3>
<p>David Whipp wondered about using regular expressions (that's `rules'
now, of course ...) on none strings, and wondered about using them to
query databases. (It would appear to me that, if you tied a database
to a hash, then Damian's proposed slicing syntax above would be a
start down that road, implementation could be tricky though ...)</p>

<h3><a name="in_brief...">In Brief ...</a></h3>
<p>Sean O'Rourke told us that the his perl6 parser/compiler/all round
groovy thing, now works with perl 5.005_03 and with 5.6.1, but that it
didn't play well with 5.6.0.</p>
<p>Remember RECALL, and how it got renamed to AVOID? Well, actually, it
didn't. It got renamed to AGAIN, but Tanton Gibbs had a brain fade
when he typed the subject line of the submitted patch.</p>
<p><a href="http://rt.perl.org/rt2/Ticket/Display.html?id=15802">http://rt.perl.org/rt2/Ticket/Display.html</a> -- Stephen
Rawls offers patches for <code>genclass.pl</code> and introduces an
<code>addclass.pl</code> script, intended to make the business of setting up a
new PMC type that much easier.</p>
<p><a href="http://groups.google.com/groups?selm=019501c23790%24cc614420%240600a8c0%40MLAMBERT">http://groups.google.com/groups</a>
Michel Lambert offered a 'Getting Started' FAQ</p>
<p>Simon Glover posted some code that makes GC segfault. Richard Cameron
fixed it. Mike Lambert applied it.</p>
<p>Angel Faus offered a patch to make imcc take into account the
data-flow info it gathered. Melvin Smith applied it.</p>
<p>Jarkko has been doing sterling work on getting parrot to compile on
SGIs, and generally tidying up code.</p>
<p>Brian Ingerson patched <code>assemble.pl</code> to allow it to accept code on
STDIN. Applied.</p>
<p>Jason Gloudon offered a patch that revised the JIT docs, and added
some stuff to the SPARC JIT overview. He also changed the way the x86
JIT invokes functions. Applied</p>
<p>Josef H&ouml;&ouml;k offered a matrix implementation. Warnock's
dilemma applies. You can find the patch at
<a href="http://rt.perl.org/rt2/Ticket/Display.html?id=15923">http://rt.perl.org/rt2/Ticket/Display.html</a> if you're
interested.</p>
<p>Sean O'Rourke pointed to
<a href="http://lambda.weblogs.com/discuss/msgReader$3850">http://lambda.weblogs.com/discuss/msgReader$3850</a>.</p>
<p>Aldo Calpini offered docs for the parrot debugger. 
<a href="http://groups.google.com/groups?selm=35-1525343312.20020802145032%40alos.it">http://groups.google.com/groups</a></p>
<p>"Mr. Nobody" has patched things to allow Configure to run on Windows
9x. Applied.</p>
<p>Nicholas Clark wondered what to do about right shifting signed
integers. Nicholas reckoned that sign extending signed types when
doing right shifts was the Right Thing.</p>
<p>Daniel Grunblatt has committed a register allocator for the JIT. Not
optimal yet, but it's a start. Nicholas Clark was impressed. So were
the rest of us, probably.</p>
<p>Simon Glover has added some more tests of the GC ops. Applied.</p>
<p>Mark J. Reed gave the language crowd and update on Unicode, UTF-16 and
Java. <a href="http://groups.google.com/groups?selm=20020731202640.GB25676%40charm.turner.com">http://groups.google.com/groups</a></p>
<p>Leon Brocard, who I thought I wasn't going to be able to mention this
week, announced the publication of his targeting parrot slides to the
list. But I told you about those last week, so maybe I shouldn't have
mentioned Leon this week after all. Hmm ...</p>

<h3><a name="who's_who_in_perl6">Who's Who in Perl6</a></h3>
<dl>
<dt><strong><a name="item_who_are_you%3f">Who are you?</a></strong><br />
</dt>
<dd>
Josef H&ouml;&ouml;k
</dd>

<dt><strong><a name="item_what_do_you_do_for%2fwith_perl_6%3f">What do you do for/with Perl 6?</a></strong><br />
</dt>
<dd>
Working with matrix and multidimensional array implementation in
parrot.
</dd>

<dt><strong><a name="item_where_are_you_coming_from%3f">Where are you coming from?</a></strong><br />
</dt>
<dd>
Sweden
</dd>

<dt><strong><a name="item_when_do_you_think_perl_6_will_be_released%3f">When do you think Perl 6 will be released?</a></strong><br />
</dt>
<dd>
1 year
</dd>

<dt><strong><a name="item_why_are_you_doing_this%3f">Why are you doing this?</a></strong><br />
</dt>
<dd>
It's fun and i learn a lot.
</dd>

<dt><strong><a name="item_you_have_5_words%2e_describe_yourself%2e">You have five words. Describe yourself.</a></strong><br />
</dt>
<dd>
icant, that was only 2words
</dd>

<dt><strong><a name="item_do_you_have_anything_to_declare%3f">Do you have anything to declare?</a></strong><br />
</dt>
<dd>
nope
</dd>
</dl>

<hr size="1" noshade="noshade" />
<h3><a name="acknowledgements,_threats_and_funding_drives.">Acknowledgements, Threats and Funding Drives.</a></h3>
<p>This summary was once again prepared with the aid of GNER tea, and
with the unwitting assistance of the fine folks at Google who
provided me with a way of generating links to articles that <em>don't</em>
require me to surf the fine Web in order to work out what the URLs
should be.</p>
<p>Once again, if you didn't like this, then don't read it. If you did,
then consider donating some of your hard-earned money (or your employer's
hard-earned money) to the Perl Foundation at
<a href="http://donate.perl-foundation.org/">http://donate.perl-foundation.org/</a> and help support the ongoing
development of Perl 6. If you're going to donate $100 or more in
response to this summary, then please let me know and I'll give you a
mention in the acknowledgements. If you're going to donate $250 or
more, again, let me know and you'll get a "This week's summary was
sponsored by Joe Bloggs" (for appropriate values of "Joe Bloggs") at
the top of the summary.</p>
<p>Sadly, nobody has yet sent me a TiBook, which is probably a good
thing; I'd only want a pony next.</p>
<p>Google is almost certainly a trademark. I should probably mention that
shouldn't I?</p>




        </div>



    </div>
    <div class="asset-footer"></div>
</div>




                            <div class="content-nav">
                                <a href="/pub/2002/07/">&laquo; July 2002</a> |
                                <a href="/pub/">Main Index</a> |
                                <a href="/pub/archives.html">Archives</a>
                                | <a href="/pub/2002/09/">September 2002 &raquo;</a>
                            </div>


                        </div>
                    </div>


                    <div id="beta">
    <div id="beta-inner">


    
    <div class="widget-what-is-perl widget">
    <div class="widget-content widget-content-what-is-perl">
       Visit the home of the  Perl programming language: <a href="http://www.perl.org/">Perl.org</a
    </div>
</div>
<div class="widget-find-out-more widget-archives widget">
    <div class="widget-content">
        <ul>
            <li><a href="http://www.perl.org/get.html">Download</a></li>
            <li><a href="http://perldoc.perl.org/">Documentation</a></li>
            <li><a href="http://blogs.perl.org/">Perl Bloggers</a></li>
            <li><a href="http://news.perlfoundation.org/">Foundation News</a></li>
        </ul>
    </div>
</div><div class="widget-tcpc widget">
<h3 class="widget-header">Sponsored by</h3>
    <div class="widget-content">
        <a href="http://training.perl.com/" alt="Perl Training" target="_blank"><img src="/i/tcpc.png" width="150" height="50"></a>
    </div>
</div>

<div class="widget-syndication widget">
    <div class="widget-content">
        <ul>
            <li><img src="/mt-static/images/status_icons/feed.gif" alt="Subscribe to feed" width="9" height="9" /> <a href="/pub/atom.xml">Subscribe to this website's feed</a></li>

        </ul>
    </div>
</div>
<div class="widget-archive-monthly widget-archive widget">
    <h3 class="widget-header">Monthly <a href="/pub/archives.html">Archives</a></h3>
    <div class="widget-content">
        <ul>
        
            <li><a href="/pub/2014/02/">February 2014 (1)</a></li>
        
    
        
            <li><a href="/pub/2014/01/">January 2014 (1)</a></li>
        
    
        
            <li><a href="/pub/2013/10/">October 2013 (1)</a></li>
        
    
        
            <li><a href="/pub/2013/01/">January 2013 (1)</a></li>
        
    
        
            <li><a href="/pub/2012/12/">December 2012 (1)</a></li>
        
    
        
            <li><a href="/pub/2012/11/">November 2012 (1)</a></li>
        
    
        
            <li><a href="/pub/2012/10/">October 2012 (2)</a></li>
        
    
        
            <li><a href="/pub/2012/08/">August 2012 (2)</a></li>
        
    
        
            <li><a href="/pub/2012/06/">June 2012 (11)</a></li>
        
    
        
            <li><a href="/pub/2012/05/">May 2012 (18)</a></li>
        
    
        
            <li><a href="/pub/2012/04/">April 2012 (17)</a></li>
        
    
        
            <li><a href="/pub/2012/02/">February 2012 (1)</a></li>
        
    
        
            <li><a href="/pub/2011/12/">December 2011 (1)</a></li>
        
    
        
            <li><a href="/pub/2011/09/">September 2011 (1)</a></li>
        
    
        
            <li><a href="/pub/2011/08/">August 2011 (2)</a></li>
        
    
        
            <li><a href="/pub/2011/06/">June 2011 (1)</a></li>
        
    
        
            <li><a href="/pub/2011/05/">May 2011 (3)</a></li>
        
    
        
            <li><a href="/pub/2011/04/">April 2011 (1)</a></li>
        
    
        
            <li><a href="/pub/2011/03/">March 2011 (1)</a></li>
        
    
        
            <li><a href="/pub/2011/02/">February 2011 (1)</a></li>
        
    
        
            <li><a href="/pub/2011/01/">January 2011 (1)</a></li>
        
    
        
            <li><a href="/pub/2010/11/">November 2010 (1)</a></li>
        
    
        
            <li><a href="/pub/2010/10/">October 2010 (2)</a></li>
        
    
        
            <li><a href="/pub/2010/09/">September 2010 (1)</a></li>
        
    
        
            <li><a href="/pub/2010/08/">August 2010 (3)</a></li>
        
    
        
            <li><a href="/pub/2010/07/">July 2010 (2)</a></li>
        
    
        
            <li><a href="/pub/2010/04/">April 2010 (2)</a></li>
        
    
        
            <li><a href="/pub/2010/03/">March 2010 (4)</a></li>
        
    
        
            <li><a href="/pub/2008/05/">May 2008 (1)</a></li>
        
    
        
            <li><a href="/pub/2008/04/">April 2008 (2)</a></li>
        
    
        
            <li><a href="/pub/2008/03/">March 2008 (1)</a></li>
        
    
        
            <li><a href="/pub/2008/02/">February 2008 (1)</a></li>
        
    
        
            <li><a href="/pub/2008/01/">January 2008 (1)</a></li>
        
    
        
            <li><a href="/pub/2007/12/">December 2007 (2)</a></li>
        
    
        
            <li><a href="/pub/2007/09/">September 2007 (1)</a></li>
        
    
        
            <li><a href="/pub/2007/08/">August 2007 (1)</a></li>
        
    
        
            <li><a href="/pub/2007/07/">July 2007 (1)</a></li>
        
    
        
            <li><a href="/pub/2007/06/">June 2007 (1)</a></li>
        
    
        
            <li><a href="/pub/2007/05/">May 2007 (1)</a></li>
        
    
        
            <li><a href="/pub/2007/04/">April 2007 (1)</a></li>
        
    
        
            <li><a href="/pub/2007/03/">March 2007 (1)</a></li>
        
    
        
            <li><a href="/pub/2007/02/">February 2007 (1)</a></li>
        
    
        
            <li><a href="/pub/2007/01/">January 2007 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/12/">December 2006 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/11/">November 2006 (2)</a></li>
        
    
        
            <li><a href="/pub/2006/10/">October 2006 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/09/">September 2006 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/08/">August 2006 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/07/">July 2006 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/06/">June 2006 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/05/">May 2006 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/04/">April 2006 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/03/">March 2006 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/02/">February 2006 (4)</a></li>
        
    
        
            <li><a href="/pub/2006/01/">January 2006 (4)</a></li>
        
    
        
            <li><a href="/pub/2005/12/">December 2005 (4)</a></li>
        
    
        
            <li><a href="/pub/2005/11/">November 2005 (3)</a></li>
        
    
        
            <li><a href="/pub/2005/10/">October 2005 (2)</a></li>
        
    
        
            <li><a href="/pub/2005/09/">September 2005 (2)</a></li>
        
    
        
            <li><a href="/pub/2005/08/">August 2005 (9)</a></li>
        
    
        
            <li><a href="/pub/2005/07/">July 2005 (8)</a></li>
        
    
        
            <li><a href="/pub/2005/06/">June 2005 (9)</a></li>
        
    
        
            <li><a href="/pub/2005/05/">May 2005 (8)</a></li>
        
    
        
            <li><a href="/pub/2005/04/">April 2005 (7)</a></li>
        
    
        
            <li><a href="/pub/2005/03/">March 2005 (6)</a></li>
        
    
        
            <li><a href="/pub/2005/02/">February 2005 (7)</a></li>
        
    
        
            <li><a href="/pub/2005/01/">January 2005 (6)</a></li>
        
    
        
            <li><a href="/pub/2004/12/">December 2004 (8)</a></li>
        
    
        
            <li><a href="/pub/2004/11/">November 2004 (8)</a></li>
        
    
        
            <li><a href="/pub/2004/10/">October 2004 (5)</a></li>
        
    
        
            <li><a href="/pub/2004/09/">September 2004 (9)</a></li>
        
    
        
            <li><a href="/pub/2004/08/">August 2004 (6)</a></li>
        
    
        
            <li><a href="/pub/2004/07/">July 2004 (8)</a></li>
        
    
        
            <li><a href="/pub/2004/06/">June 2004 (6)</a></li>
        
    
        
            <li><a href="/pub/2004/05/">May 2004 (7)</a></li>
        
    
        
            <li><a href="/pub/2004/04/">April 2004 (8)</a></li>
        
    
        
            <li><a href="/pub/2004/03/">March 2004 (8)</a></li>
        
    
        
            <li><a href="/pub/2004/02/">February 2004 (9)</a></li>
        
    
        
            <li><a href="/pub/2004/01/">January 2004 (7)</a></li>
        
    
        
            <li><a href="/pub/2003/12/">December 2003 (4)</a></li>
        
    
        
            <li><a href="/pub/2003/11/">November 2003 (7)</a></li>
        
    
        
            <li><a href="/pub/2003/10/">October 2003 (8)</a></li>
        
    
        
            <li><a href="/pub/2003/09/">September 2003 (6)</a></li>
        
    
        
            <li><a href="/pub/2003/08/">August 2003 (7)</a></li>
        
    
        
            <li><a href="/pub/2003/07/">July 2003 (9)</a></li>
        
    
        
            <li><a href="/pub/2003/06/">June 2003 (9)</a></li>
        
    
        
            <li><a href="/pub/2003/05/">May 2003 (8)</a></li>
        
    
        
            <li><a href="/pub/2003/04/">April 2003 (8)</a></li>
        
    
        
            <li><a href="/pub/2003/03/">March 2003 (10)</a></li>
        
    
        
            <li><a href="/pub/2003/02/">February 2003 (8)</a></li>
        
    
        
            <li><a href="/pub/2003/01/">January 2003 (8)</a></li>
        
    
        
            <li><a href="/pub/2002/12/">December 2002 (5)</a></li>
        
    
        
            <li><a href="/pub/2002/11/">November 2002 (9)</a></li>
        
    
        
            <li><a href="/pub/2002/10/">October 2002 (7)</a></li>
        
    
        
            <li><a href="/pub/2002/09/">September 2002 (11)</a></li>
        
    
        
            <li><a href="/pub/2002/08/">August 2002 (8)</a></li>
        
    
        
            <li><a href="/pub/2002/07/">July 2002 (8)</a></li>
        
    
        
            <li><a href="/pub/2002/06/">June 2002 (4)</a></li>
        
    
        
            <li><a href="/pub/2002/05/">May 2002 (6)</a></li>
        
    
        
            <li><a href="/pub/2002/04/">April 2002 (6)</a></li>
        
    
        
            <li><a href="/pub/2002/03/">March 2002 (7)</a></li>
        
    
        
            <li><a href="/pub/2002/02/">February 2002 (5)</a></li>
        
    
        
            <li><a href="/pub/2002/01/">January 2002 (8)</a></li>
        
    
        
            <li><a href="/pub/2001/12/">December 2001 (7)</a></li>
        
    
        
            <li><a href="/pub/2001/11/">November 2001 (5)</a></li>
        
    
        
            <li><a href="/pub/2001/10/">October 2001 (9)</a></li>
        
    
        
            <li><a href="/pub/2001/09/">September 2001 (7)</a></li>
        
    
        
            <li><a href="/pub/2001/08/">August 2001 (13)</a></li>
        
    
        
            <li><a href="/pub/2001/07/">July 2001 (8)</a></li>
        
    
        
            <li><a href="/pub/2001/06/">June 2001 (13)</a></li>
        
    
        
            <li><a href="/pub/2001/05/">May 2001 (11)</a></li>
        
    
        
            <li><a href="/pub/2001/04/">April 2001 (9)</a></li>
        
    
        
            <li><a href="/pub/2001/03/">March 2001 (8)</a></li>
        
    
        
            <li><a href="/pub/2001/02/">February 2001 (8)</a></li>
        
    
        
            <li><a href="/pub/2001/01/">January 2001 (8)</a></li>
        
    
        
            <li><a href="/pub/2000/12/">December 2000 (6)</a></li>
        
    
        
            <li><a href="/pub/2000/11/">November 2000 (10)</a></li>
        
    
        
            <li><a href="/pub/2000/10/">October 2000 (10)</a></li>
        
    
        
            <li><a href="/pub/2000/09/">September 2000 (2)</a></li>
        
    
        
            <li><a href="/pub/2000/08/">August 2000 (2)</a></li>
        
    
        
            <li><a href="/pub/2000/07/">July 2000 (5)</a></li>
        
    
        
            <li><a href="/pub/2000/06/">June 2000 (7)</a></li>
        
    
        
            <li><a href="/pub/2000/05/">May 2000 (7)</a></li>
        
    
        
            <li><a href="/pub/2000/04/">April 2000 (3)</a></li>
        
    
        
            <li><a href="/pub/2000/03/">March 2000 (2)</a></li>
        
    
        
            <li><a href="/pub/2000/02/">February 2000 (2)</a></li>
        
    
        
            <li><a href="/pub/2000/01/">January 2000 (2)</a></li>
        
    
        
            <li><a href="/pub/1999/12/">December 1999 (6)</a></li>
        
    
        
            <li><a href="/pub/1999/11/">November 1999 (6)</a></li>
        
    
        
            <li><a href="/pub/1999/10/">October 1999 (5)</a></li>
        
    
        
            <li><a href="/pub/1999/09/">September 1999 (4)</a></li>
        
    
        
            <li><a href="/pub/1999/08/">August 1999 (3)</a></li>
        
    
        
            <li><a href="/pub/1999/07/">July 1999 (2)</a></li>
        
    
        
            <li><a href="/pub/1999/06/">June 1999 (3)</a></li>
        
    
        
            <li><a href="/pub/1999/04/">April 1999 (1)</a></li>
        
    
        
            <li><a href="/pub/1999/03/">March 1999 (1)</a></li>
        
    
        
            <li><a href="/pub/1999/01/">January 1999 (1)</a></li>
        
    
        
            <li><a href="/pub/1998/12/">December 1998 (1)</a></li>
        
    
        
            <li><a href="/pub/1998/11/">November 1998 (1)</a></li>
        
    
        
            <li><a href="/pub/1998/07/">July 1998 (2)</a></li>
        
    
        
            <li><a href="/pub/1998/06/">June 1998 (1)</a></li>
        
    
        
            <li><a href="/pub/1998/03/">March 1998 (1)</a></li>
        
        </ul>
    </div>
</div>
        
    

<div class="widget-powered widget">
    <div class="widget-content">
        <a href="http://www.movabletype.com/"><img src="/mt-static/images/bug-pbmt-white.png" alt="Powered by Movable Type 5.13-en" width="120" height="75" /></a>
    </div>
</div>



    </div>
</div>






                </div>
            </div>


            <div id="footer">
    <div id="footer-inner">
        <div id="footer-content">
            <div class="widget-powered widget">
                <div class="widget-content">
                    Powered by <a href="http://www.movabletype.com/" rel="generator">Movable Type Pro</a>
                </div>
            </div>

            <div class="widget-creative-commons widget">
                <div class="widget-content">
                    This blog is licensed under a <a href="http://creativecommons.org/licenses/by-nc-nd/3.0/">Creative Commons License</a>.
                </div>
            </div>

        </div>
    </div>
</div>



        </div>
    </div>
</body>
</html>
