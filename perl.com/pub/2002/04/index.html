<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" id="sixapart-standard">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="generator" content="Movable Type Pro 5.13-en" />
<link rel="stylesheet" href="/pub/styles.css" type="text/css" />
<link rel="start" href="/pub/" title="Home" />
<link rel="alternate" type="application/atom+xml" title="Recent Entries" href="/pub/atom.xml" />
<script type="text/javascript" src="/pub/mt.js"></script>
<!--
<rdf:RDF xmlns="http://web.resource.org/cc/"
         xmlns:dc="http://purl.org/dc/elements/1.1/"
         xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#">
<Work rdf:about="/pub/">
<dc:title>Perl.com</dc:title>
<dc:description>news and views of the Perl programming language</dc:description>
<license rdf:resource="http://creativecommons.org/licenses/by-nc-nd/3.0/" />
</Work>
<License rdf:about="http://creativecommons.org/licenses/by-nc-nd/3.0/">
</License>
</rdf:RDF>
-->

<script type="text/javascript">

 var _gaq = _gaq || [];
 _gaq.push(['_setAccount', 'UA-50555-22']);
 _gaq.push(['_trackPageview']);

 (function() {
   var ga = document.createElement('script'); ga.type =
   'text/javascript'; ga.async = true;
   ga.src = ('https:' == document.location.protocol ? 'https://ssl' :
   'http://www') + '.google-analytics.com/ga.js';
   var s = document.getElementsByTagName('script')[0];
   s.parentNode.insertBefore(ga, s);
 })();

</script>
<script type='text/javascript' src='http://partner.googleadservices.com/gampad/google_service.js'></script>
<script type='text/javascript'>
GS_googleAddAdSenseService("ca-pub-4136420132070439");
GS_googleEnableAllServices();
</script>
<script type='text/javascript'>
GA_googleAddSlot("ca-pub-4136420132070439", "Perl_728x90");
</script>
<script type='text/javascript'>GA_googleFetchAds();</script>
    <title>Perl.com: April 2002 Archives</title>


    <link rel="prev" href="/pub/2002/03/" title="March 2002" />
    <link rel="next" href="/pub/2002/05/" title="May 2002" />

</head>
<body id="perl-com" class="mt-archive-listing mt-datebased-monthly-archive layout-wt">
    <div id="container">
        <div id="container-inner">


            <div id="header">
    <div id="header-inner">
        <div id="header-content">
        <span id="top_advert"> 
<!-- Put any landscape advert in here -->
<!-- Perl_728x90 -->
<script type='text/javascript'>
GA_googleFillSlot("Perl_728x90");
</script>
        </span> 



            <div id="header-name"><a href="/pub/" accesskey="1">Perl.com</a></div>
            <div id="header-description">news and views of the Perl programming language</div>




        </div>
    </div>
</div>



            <div id="content">
                <div id="content-inner">


                    <div id="alpha">
                        <div id="alpha-inner">


                            <h1 id="page-title" class="archive-title">April 2002 Archives</h1>





                            
                            <div id="entry-1294" class="entry-asset asset hentry">
    <div class="asset-header">
        <h2 class="asset-name entry-title"><a href="/pub/2002/04/30/cpants.html" rel="bookmark">Becoming a CPAN Tester with CPANPLUS</a></h2>
        <div class="asset-meta">
            <span class="byline">
    
                By <span class="vcard author">Autrijus Tang</span> on <abbr class="published" title="2002-04-30T00:00:00-08:00">April 30, 2002 12:00 AM</abbr>
    
            </span>

            
            

        </div>
    </div>
    <div class="asset-content entry-content">

        <div class="asset-body">
            

<blockquote><i>
 &quot;This is a great war long-planned,<br/>
  and we are but one piece in it,<br/>
  whatever pride may say.<br/>
  ... And now, all realms shall be put to the test.&quot;<br/>
                -- Beregond, &lt;&lt;Lord of the Rings&gt;&gt;</i></blockquote>
<h3><a name="introduction">Introduction</a></h3>
<p>In <a href="/pub/a{cs.r.file}?page=2#f1"><em>CPANPLUS -- Like CPAN.pm only better?</em></a>, Jos Boumans recounted
the tale of how his <strong>CPANPLUS</strong> project came to be; one of the original
goals was to provide a modular backend to <em>CPANTS</em>, the CPAN Testing
Service, so modules can be automatically built and tested on multiple
platforms.</p>

<p>Although the initial <strong>CPANPLUS</strong> release did not support testing-related
features, Jos considered them important enough to be listed near the top
of his <em>Current and Future Developments</em> wish list, and quoted Michael
Schwern's opinion on their potential benefits<a href="/pub/a{cs.r.file}?page=2#f2"><sup>*</sup></a>:</p>
<blockquote><i>
 It would alter the way free software is distributed.
 It would get a mark of quality; it would be tested and
 reviewed.  And gosh darnit, it would be good.
 </i></blockquote>
<p>At that time, despite having participated in CPANPLUS's development for
more than four months, I was blissfully unaware of the project's
original vision.  But it seemed like a worthwhile goal to pursue, so I
quickly jotted down several pieces that need to work together:</p>
<ul>
<li>
Check test reports of modules before installation.
<p></p>
<li>
Report <code>make test</code> results to the author, and make them available
for other users to check.
<p></p>
<li>
Tools to batch-test modules with or without human intervention.
<p></p>
<li>
A clean API for other programs to perform tests, reporting and queries.
<p></p></ul>
<p>Today, with the 0.032 release of <strong>CPANPLUS</strong>, all the above pieces are
completed.  This article will show you how to configure and use these
tools, as well as describing some important new features in <strong>CPANPLUS</strong>
that made them possible.</p>
<h3><a name="setting up the environment">Setting Up the Environment</a></h3>
<p>First, you need a copy of <strong>CPANPLUS</strong> 0.032 or above.  I recommend the
tarball automatically built from the <em>distribution branch</em>, available
at <a href="http://egb.elixus.org/cpanplus-dist.tar.gz">http://egb.elixus.org/cpanplus-dist.tar.gz</a>; it should contain
the latest bug-fixes and features marked as <em>stable</em>.</p>
<p>Since Jos' article and README already contain install instructions,
I will not repeat the details.  However, please note that the
dependency detection logic in <em>Makefile.PL</em> has been changed since
Jos' previous article, which means when faced with this prompt:</p>
<pre>
 [CPAN Test reporting]
 - Mail::Send           ...failed! (needs 0.01)
 - File::Temp           ...loaded. (0.13 &gt;= 0.01)
 ==&gt; Do you wish to install the 1 optional module(s)? [n]</pre>
<p>You should generally answer <code>y</code> here, as only modules that can safely
install on your machine are displayed.  The default <code>n</code> does not mean
we don't recommend it; it merely means it isn't mandatory for the
bare-bone <strong>CPANPLUS</strong> to function.</p>
<p>For this article's purpose, you need to answer <code>y</code> to all such
questions, since we will be using <strong>LWP</strong>, <strong>Mail::Send</strong> and <strong>IPC::Run</strong>
extensively in testing-related functions.</p>
<p>After running <em>Makefile.PL</em>, you should run <code>make test</code><a href="/pub/a{cs.r.file}?page=2#f3"><sup>*</sup></a> like every
good user; if any dependent modules were selected in the previous step,
then you will have to run <code>make test</code> as root, so it can fetch and install
these modules automatically before testing itself.</p>
<p>After the comforting <code>All tests successful</code> message appears on your
screen, just do a <code>make install</code>, and we are ready to go.</p>

<h3><a name="why is testing important">Why Is Testing Important?</a></h3>

<p>... or not.  What if, instead of <code>All tests successful</code>, you see a
series of cryptic messages:</p>
<pre>
 % sudo make test
 /usr/bin/perl Makefile.PL --config=-target,skiptest
 --installdeps=Term::Size,0.01
 *** Installing dependencies...
 *** Installing Term::Size...
 Can't bless nonreference value at lib/CPANPLUS/Internals/Module.pm
 line 239.
 Compilation failed in require at Makefile.PL line 20.
 make: *** [installdeps] Error 255</pre>
 
<p>An experienced Perl user will probably take the following steps:</p>
<ul>
<li>
Look at <em>lib/CPANPLUS/Internals/Module.pm</em> and see whether it's a trivial
mistake.  Unfortunately, it is not.</li>

<li>
Search README for the project's mailing list address.  Discovering that
it's hosted in SourceForge, check Geocrawler (or any search engine) for
existing bug reports and discussions.  Unfortunately, there are none.</li>

<li>
Copy-and-paste the error message into a bug-reporting e-mail to the
mailing list, including your operating system name and version, Perl
version, and wait for a fix.
</li></ul>
<p>Apparently, the above is exactly what Juerd Waalboer (the bug's
original reporter) did when he ran into this trouble.  Thanks, Juerd!</p>
<p>However, there are a number of problems with the procedure above.
It might be thwarted at every step:</p>
<ul>
<li>
What if Juerd had been less experienced, and unaware of this
bug-reporting procedure?
<p></p>
<li>
What if he decided to kluge around it by commenting out line 239,
instead of taking the laborious copy-and-paste path to report it?
</li>
<li>
<strong>CPANPLUS</strong> has a mailing list; other modules might not.  Worse, they
may not even have a working contact address -- maybe the author is on
vacation.
</li>
<li>
He might not have the sense to provide adequate debug-related data,
and simply wrote <code>CPANPLUS didn't work! It can't install!#!@#@#!</code>
in red-colored blinking HTML email, wasting bandwidth and causing
developers to ignore his mail completely.
</li>
<li>
Even after a fix was made available, and posted as a patch on the
mailing list, other people about to install <strong>CPANPLUS</strong> 0.03 still
have no way to find out about it beforehand.  Thus, when the same
problem occurs again, they may forget to search in the archives,
resulting in duplicate bug reports, or (worse) more dissatisfied
users.
</li>
<li>
Actually, we had not mentioned the very likely scenario: What if
Juerd didn't run <code>make test</code> at all? If so, the developers will
have no way to know that this bug has ever happened.
</li>
<li>
Finally, while <strong>CPANPLUS</strong> (like most CPAN modules) includes a
regression test suite, some modules may omit their tests altogether.
Users may not feel comfortable to mail the author to request a test
script to accompany the distribution; consequently, bugs will surface
in harder-to-detect ways, and may never get fixed.
</li></ul>

<p>As you can see, both authors and users can certainly benefit a lot
from an improved test reporting system -- one that simplifies the
process of reporting a failed (or successful) installation, and allows
users to check for existing reports before downloading a module.</p>
<p>Such a system already exists; it's called <em>CPAN Testers</em>.</p>
<h3><a name="what is cpan testers">What Is <em>CPAN Testers</em>?</a></h3>
<p>When most people run <code>make test</code>, it's immediately followed by a
<code>make install</code>; that is, people only test modules that they are going
to use.  But they may not have the time or inclination to report the
outcome, for various reasons listed above.</p>
<p><em>CPAN Testers</em> (<a href="http://testers.cpan.org/">http://testers.cpan.org/</a>) is an effort to set up a
<em>Quality Assurance</em> (<em>QA</em>) team for CPAN modules.  As its homepage
states:</p>
<pre>
 The objective of the group is to test as many of the
 distributions on CPAN as possible, on as many platforms
 as possible.</pre>
<pre>
 The ultimate goal is to improve the portability of the
 distributions on CPAN, and provide good feedback to the
 authors.</pre>
<p>Central to its operation is a mailing list, <em><a href="mailto:cpan-testers@perl.org">cpan-testers@perl.org</a></em>,
and a small program, <em>cpantest</em>.  The program is a convenient way to
report a distribution's test result, which is sent to the mailing list
using an uniform format.  For example:</p>
<pre>
 # test passed, send a report automatically (no comments)
 cpantest -g pass -auto -p CPANPLUS-0.032
 # test failed, launch an editor to edit the report, and cc to kane
 cpantest -g fail -p CPANPLUS-0.032 kane@cpan.org</pre>
<p>The argument (<code>pass</code>/<code>fail</code>) after the <strong>-g</strong> option is called the
<em>grade</em> -- the overall result of a test run.  It may also be <code>na</code>
(not available), which means the module is not expected to work on this
platform at all (<strong>Win32::Process</strong> on FreeBSD, for example), and
<code>unknown</code> in the case that no tests are provided in the distribution.</p>
<p>All recent CPAN uploads, as well as all test results, are forwarded
to the <code>cpan-testers</code> mailing list's subscribers -- CPAN testers.
After a distribution's release on CPAN, one or more testers will
pick it up, test it, then feed the result back to the author and to
the list.  The testers don't have to know what the module is about;
all they do is to ensure it's working as advertised.</p>
<p>Test reports on the mailing list are automatically recorded in a
ever-growing database.  <a href="http://testers.cpan.org/search?request=search">http://testers.cpan.org/search</a>
is its search interface, where you can query by distribution name,
version, or the testing platform.</p>
<p>Theoretically, you can query that database before installing any CPAN
module, to see whether it works on your platform, and check for associated
bug reports.  The same information is also present at each module's
page in <a href="http://search.cpan.org/">http://search.cpan.org/</a>, and maybe <a href="http://rt.cpan.org/">http://rt.cpan.org/</a>
in the near future.</p>
<p>Alas, while this system certainly works, it is far from perfect.  Here
are some of its shortcomings:</p>
<ul>
<li>
The integration between Web site and mailing list hadn't extended to the
<em>CPAN.pm</em> shell, so checking for test results requires an additional
step to navigate the Web browser.
</li>
<li>
People who aren't subscribed to the <code>cpan-testers</code> list rarely submit
test reports, so coverage of platforms is limited to a few popular ones;
a heavily used module may still be tested in only two or three platforms,
hardly representing its entire user base.
</li>
<li>
There are no <em>smoking</em> (automatic cross-platform testing) mechanisms;
all testers must manually fetch, extract, test and submit their test
reports, including the same copy-and-paste toil we described earlier.
This entry barrier has seriously limited the number of active volunteer
testers.
</li></ul>
<p>Fortunately, <strong>CPANPLUS</strong> addressed most of these issues, and made it
significantly easier to participate in testing-related activities.
Let's walk through them in the following sections.</p>
<h3><a name="checking test reports">Checking test reports</a></h3>
<p>CPANPLUS offers a straightforward way to check existing reports.
Simply enter <code>cpanp -c ModuleName</code> in the command line:</p>
<pre>
 % cpanp -c CPANPLUS
 [/K/KA/KANE/CPANPLUS-0.032.tar.gz]
 PASS freebsd 4.5-release i386-freebsd</pre>
<p>As you can see, this reports the most recent version of <strong>CPANPLUS</strong>,
which passed its tests on FreeBSD as of this writing.</p>
<p>You can also specify a particular version of some distribution.  For
example, the version Juerd was having problems with is 0.03, so he
can do this:</p>
<pre>
 % cpanp -c CPANPLUS-0.03
 [/K/KA/KANE/CPANPLUS-0.03.tar.gz]
     FAIL freebsd 4.2-stable i386-freebsd (*)
     PASS freebsd 4.5-release i386-freebsd (*)
     PASS linux 2.2.14-5.0 i686-linux
 ==&gt; <a
 href="http://testers.cpan.org/search?request=dist&dist=CPANPLUS">http://testers.cpan.org/search?request=dist&dist=CPANPLUS</A></pre>
<p>As you can see, there are three reports, two of which contain
additional details (marked with <code>*</code>), available at the URL listed
above.  The failed one's says:</p>
<pre>
 This bug seems to be present in machines upgrading to 0.03
 from 0.01/0.02 releases.
 (It has since been fixed in the upcoming 0.031 release.)</pre>
<p>Which exactly addressed Juerd's original problem.</p>
<p>Another useful trick is using the <code>o</code> command in the CPANPLUS
Shell to list newer versions of installed modules on CPAN, and
check on them all with <code>c *</code>:</p>
<pre>
 % cpanp
 CPAN Terminal&gt; o
 1   0.14     0.15   DBD::SQLite        MSERGEANT
 2   2.1011   2.1014 DBD::mysql         JWIED</pre>
<pre>
 CPAN Terminal&gt; c *
 [/M/MS/MSERGEANT/DBD-SQLite-0.15.tar.gz]
     FAIL freebsd 4.5-release i386-freebsd (*)
     PASS linux 2.2.14-5.0 i686-linux
     PASS solaris 2.8 sun4-solaris
 ==&gt; <a href="http://testers.cpan.org/search?request=dist&dist=DBD-SQLite">http://testers.cpan.org/search?request=dist&dist=DBD-SQLite</a></pre>
<pre>
 [/J/JW/JWIED/DBD-mysql-2.1014.tar.gz]
     FAIL freebsd 4.5-release i386-freebsd (*)
     PASS freebsd 4.5-release i386-freebsd
 ==&gt; <a
 href="http://testers.cpan.org/search?request=dist&dist=DBD-mysql">http://testers.cpan.org/search?request=dist&dist=DBD-mysql</a></pre>
<p>This way, you can safely upgrade your modules, confident in the
knowledge that the newer version won't break the system.</p>













<h3><a name="reporting test results">Reporting Test Results</a></h3>
<p>Despite the handy utility of the <code>c</code> command, there will be no reports
if nobody submits them.  <strong>CPANPLUS</strong> allows you to send a report whenever
you've done a <code>make test</code> in the course of installing a module; to
enable this feature, please turn on the <code>cpantest</code> configuration
variable:</p>
<pre>
 CPAN Terminal&gt; s cpantest 1
 CPAN Terminal&gt; s save
 Your CPAN++ configuration info has been saved!</pre>
<p>Afterward, just use CPANPLUS as usual.  You will be prompted during an
installation, like below:</p>
<pre>
 CPAN Terminal&gt; i DBD::SQLite
 Installing: DBD::SQLite
 # ...
 t/30insertfetch....ok
 t/40bindparam......FAILED test 25
     Failed 1/28 tests, 96.43% okay
 t/40blobs..........dubious
     Test returned status 2 (wstat 512, 0x200)
     DIED.  FAILED tests 8-11
     Failed 4/11 tests, 63.64% okay
 Failed 2/19 test scripts, 89.47% okay.
 5/250 subtests failed, 98.00% okay.
 *** Error code 9
 Report DBD-SQLite-0.15's testing result (FAIL)? [y/N]: y</pre>
<p>It always defaults to <code>n</code>, so you won't send out bogus reports by
mistake.  If you enter <code>y</code>, then different actions will happen, depending
on the test's outcome:</p>
<ul>
<li>
For modules that passed their tests, a <code>pass</code> report is sent out
immediately to the <code>cpan-testers</code> list.
</li>
<li>
For modules that didn't define a test, an <code>unknown</code> report is sent to
the author and <code>cpan-testers</code>; the report will include a simple test
script, encourage the module author to include it in the next release,
and contain a URL of Michael Schwern's <strong>Test::Tutorial</strong> manpage.
</li>
<li>
If the module fails at any point (<code>perl Makefile.PL</code>, <code>make</code>, or
<code>make test</code>), then the default editor is launched to edit its <code>fail</code>
report, which includes the point of failure and the captured error
buffer.
<p>You are free to add any text below the <code>Additional comments</code> line;
to cancel a report, just delete everything and save an empty file.</p>
</li></ul>
<p>Before sending out a <code>fail</code> report, be sure to double-check if it is
really the module's problem.  For example, if there's no <em>libgtk</em>
on your system, then please don't send a report about failing to install
<strong>Gtk</strong>.</p>
<p>Also, be prepared to follow up with additional information when asked.
The author may ask you to apply some patches, or to try out an
experimental release; do help the author whenever you can.</p>
<p>
<h3><a name="batch testing and cpansmoke">Batch Testing and <em>cpansmoke</em></a></h3>
<p>While regular users can test modules as they install via the <code>cpantest</code>
option, and often provide important first-hand troubleshooting
information, we still need dedicated testers -- they can broaden the
coverage of available platforms, and may uncover problems previously
unforeseen by the author.  Dedicated testing and regular reports are
complementary to each other.</p>
<p>Historically, CPAN testers would watch for notices of recent <em>PAUSE</em>
uploads posted on the <code>cpan-testers</code> list, grab them, test them
manually, and run the <em>cpantest</em> script, as we've seen in
<a href="#what is i<cpan testers>">What is <em>CPAN Testers</em>?</a>.  That script is bundled with <strong>CPANPLUS</strong>;
please refer to its POD documentation for additional options.  
</p>
However, normally you won't be using it directly, as <b>CPANPLUS</b> offers
the <i>cpansmoke</i> wrapper, which consolidates the <i>download => test => copy buffer => run cpantest => file report</i> procedure into
a single command:
<pre>
 % cpansmoke Mail::Audit Mail::SpamAssassin          # by module
 % cpansmoke Mail-Audit-2.1 Mail-SpamAssassin-2.20   # by distname
 % cpansmoke /S/SI/SIMON/Mail-Audit-2.1.tar.gz       # or full name</pre>
<p>Due to the need of testing new distributions as they are uploaded,
<em>cpansmoke</em> will use <a href="http://www.cpan.org/">http://www.cpan.org/</a> as its primary host,
instead of the local mirror configured in your <strong>CPANPLUS</strong> settings.
This behavior may be overridden with the <strong>-l</strong> flag.</p>
<p>Since <em>cpansmoke</em> will stop right after <code>make test</code> rather than
installing any modules, it can test modules with different versions
than the ones installed on the system.  However, since it won't
resolve prerequisites by default, you'll need to specify the <strong>-p</strong>
flag to test and report them.</p>
<p>The <strong>-d</strong> flag will display previous results before testing each module;
similarly, <strong>-s</strong> will skip testing altogether if the module was already
tested on the same platform.  The latter should only be used with
automated test (to reduce spamming), since the same platform can have
different results.</p>
<p>There are numerous other flags available; please consult <em>cpansmoke</em>'s
manpage for further information.</p>
<h3><a name="automatic testing">Automatic Testing</a></h3>
<p>Besides interactive batch-testing, <em>cpansmoke</em> also provides the
capability of <em>unattended testing</em>; this concept is also covered by
Mozilla Project's <strong>Tinderbox</strong> toolkit, as explained in its homepage:</p>
<pre>
 There is a flock of dedicated build machines that do
 nothing but continually check out the source tree and
 build it, over and over again.</pre>
<p>Essentially, if you have a machine with plenty of hard disk space and
adequate bandwidth, you can set up <em>cpansmoke</em> so it tests each new module as it is uploaded.</p>
<p>The <strong>-a</strong> option lets <em>cpansmoke</em> enter the non-interactive mode.  In
this mode, only failures during <code>make test</code> are reported, because
errors that occured during <code>Makefile.PL</code> or <code>make</code> are more likely
the machine's problem, not the module's.</p>
<p>Additionally, you should specify the <em>-s</em> flag to avoid duplicate
reports, and <em>-p</em> to avoid false-negatives caused by unsatisfied
dependencies.</p>
<p>Setting up an auto-smoking machine is simple, using a mail
filtering mechanism; just join the CPAN Testers list by sending an
empty email to <em><a href="mailto:cpan-testers-subscribe@perl.org">cpan-testers-subscribe@perl.org</a></em>, and add the lines
below to your <A HREF="/pub/a{cs.r.file}?page=2#f4"><strong>Mail::Audit</strong>
filter</A>:</p>
<pre>
 fork || exec(&quot;sleep 40000 &amp;&amp; cpansmoke -aps $1 &gt;/dev/null 2&gt;&amp;1&quot;)
     if $mail-&gt;subject =~ /^CPAN Upload: (.*)$/;</pre>
<p>This rule will fork out a new <em>cpansmoke</em> process for each incoming
mail about a CPAN upload.  Note that it works only if incoming mail
arrives no less than once every hour; otherwise it might fork-bomb your
system to a grinding halt.</p>
<p>In case you're wondering, the <code>sleep 40000</code> line is due to the fact
that a PAUSE upload needs several hours to appear on <em>www.cpan.org</em>.
Michael Schwern suggested that using a <em>smoke queue</em> would be a better
solution, since it allows error-checking and logging; implementations
are welcome.</p>
<p>If you are stuck with <strong>procmail</strong>, then here's the recipe that does the same
(but do consider upgrading to <strong>Mail::Audit</strong>):</p>
<pre>
 :0hc
 * ^Subject: CPAN Upload:
 |sh -c &quot;sleep 40000 &amp;&amp; grep Subject|cut -f4 -d' '|xargs cpansmoke -aps &gt;/dev/null 2&gt;&amp;1&quot;</pre>
<p>If you have suggestions on how to make this work on non-unix systems,
please do let me know.</p>

<h3><a name="testingrelated apis">Testing-Related APIs</a></h3>
<p>A programmable interface is the primary strength of <strong>CPANPLUS</strong>.  All
features listed above are available as separate methods of the
<strong>CPANPLUS::Backend</strong> object.  Since the module's manpage already
contains detailed information, I'll just list some sample snippets
below.</p>
<p>To show all reports of <strong>Acme::*</strong> on FreeBSD:</p>
<pre>
 use CPANPLUS::Backend;
 my $cp = CPANPLUS::Backend-&gt;new;
 my $reports = $cp-&gt;reports( modules =&gt; [ map $_-&gt;{package}, values(
     %{ $cp-&gt;search(type =&gt; 'module', list =&gt; ['^Acme::\b']) }
 ) ] );</pre>
<pre>
 while ( my ($name, $href) = each (%$reports) ) {
     next unless $href;
     my @entries = grep { $_-&gt;{platform} =~ /\bfreebsd\b/ } @$href;
     next unless @entries;</pre>
<pre>
     print &quot;[$name]\n&quot;;
     for my $rv (@entries) {
         printf &quot;%8s %s%s\n&quot;, @{$rv}{'grade', 'platform'},
                              ($rv-&gt;{detail} ? ' (*)' : '');
     }
 }</pre>
<p>To test all <strong>Acme::*</strong> modules, but install all needed prerequisites:</p>
<pre>
 use CPANPLUS::Backend;
 my $cp = CPANPLUS::Backend-&gt;new;
 $cp-&gt;configure_object-&gt;set_conf( cpantest =&gt; 1 );
 $cp-&gt;install(
     modules =&gt; [ map $_-&gt;{package}, values(
         %{ $cp-&gt;search(type =&gt; 'module', list =&gt; ['^Acme::\b']) }
     ) ], 
     target        =&gt; 'test',
     prereq_target =&gt; 'install',
 );</pre>
<p>If you need to fine-tune various aspects during testing (timeout,
prerequisite handling, etc.), then please consult the source code of
<em>cpansmoke</em>; most tricks involved are documented in comments.</p>
<p>Unfortunately, the process of editing and sending out reports
remains as the only non-programmable part, since the <em>cpantest</em>
script doesn't exist as a module.  Although Skud has a
<strong>CPAN::Test::Reporter</strong> on CPAN, its format is sadly out-of-sync
with <em>cpantest</em>, and may generate invalid reports (as of version
<code>0.02</code>).  Any offers to back-port the <em>cpantest</em> script into
that module would be greatly appreciated.</p>

<h3><a name="conclusion">Conclusion</a></h3>
<p>As <a href="#f5"><em>purl</em></a> said, ``CPAN is a cultural mechanism.'' It is not an
abstraction filled with code, but rather depends on people caring enough
to share code, as well as sharing useful feedback in order to improve
each other's code.</p>
<p>With the advent of <a href="#f6">bug-tracking service</a> and automatic testing,
the social collaboration aspect of CPAN is greatly extended, and could
be developed further into a full-featured Tinderbox system, or linked
with each module's source-control repositories.</p>
<p>Also, since <strong>CPANPLUS</strong> is designed to accommodate different package
formats and distribution systems, it provides a solid foundation for
projects like <strong>Module::Build</strong> (<code>make</code>-less installs), <strong>NAPC</strong>
(distributed CPAN) and <strong>ExtUtils::AutoInstall</strong> (feature-based
dependency probing)... the possibilities are staggering, and you
certainly won't be disappointed in finding an interesting project to
work on.  Happy hacking!</p>

<h3><a name="acknowledgements">Acknowledgements</a></h3>
<p>Although I have done some modest work in integrating <strong>CPANPLUS</strong> with
CPAN testing, the work is really built on contributions from several
brilliant individuals:</p>
<p>First, I'd like to dedicate this article to Elaine -HFB- Ashton, for
her tireless efforts on Perl advocacy, and for sponsoring my works as
described in this article.</p>
<p>Thanks also goes to Graham Barr and Chris Nandor, for establishing the
CPAN Testers at the first place, and coming up with two other important
cultural mechanisms: <em>CPAN Search</em> and <em>Use Perl;</em> respectively.</p>
<p>To Jos Boumans, Joshua Boschert, Ann Barcomb and everybody in
the <strong>CPANPLUS</strong> team -- you guys rock!  Special thanks for another
team member, Michael Schwern, for reminding everybody constantly
that <em>Kwalitee Is Job One</em>.</p>
<p>To Paul Schinder, the greatest tester of all time, who submitted
10551 reports by hand out of 23203 to date, and kept CPAN Testers alive
for a long time.  And thanks for every fellow CPAN Tester who have
committed their valuable time -- I hope <em>cpansmoke</em> can shoulder your
burden a little bit.</p>
<p>To Simon Cozens, for his swiss-nuke <strong>Mail::Audit</strong> module, and for
keep asking me to write 'something neat' for <em>perl.com</em>. :-)</p>
<p>To Jarkko Hietaniemi, for establishing <strong>CPAN</strong>; and to Andreas J.
Koenig, for maintaining <strong>PAUSE</strong> and showing us what is possible
with <strong>CPAN.pm</strong>.</p>
<p>Finally, if you decide to follow the steps in this article and
participate in the testing process, then you have my utmost gratitude;
let's make the world a better place.</p>

<h3><a name="footnotes">Footnotes</a></h3>
<ol>
<li><a name="f1">
It's an introductory text for the <strong>CPANPLUS</strong> project, available at
<a href="/pub/a/2002/03/26/cpanplus.html">http://www.perl.com/pub/a/2002/03/26/cpanplus.html</a>.
</li>
<li><a name="f2">
Jos later confessed that these are not exactly Schwern's words; he just
made the quote up for dramatic effect.
</li>
<li><a name="f3">
With ActivePerl on Windows, simply replace all <code>make</code> with <code>nmake</code>.
If you don't have <em>nmake.exe</em> in your <code>%PATH</code>, our <em>Makefile.PL</em> is
 smart enough to fetch and install it for you.
</li>
<li><a name="f5">
Purl, the magnet #perl infobot, is also a cultural mechanism herself;
see <a href="http://www.infobot.org/">http://www.infobot.org/</a> for additional information.
</li>
<li><a name="f6">
That's Jesse Vincent's <a href="http://rt.cpan.org/">http://rt.cpan.org/</a>, which tracks bugs in
every distribution released through CPAN.
</li></ol>

        </div>



    </div>
    <div class="asset-footer"></div>
</div>


                            
                            <div id="entry-1292" class="entry-asset asset hentry">
    <div class="asset-header">
        <h2 class="asset-name entry-title"><a href="/pub/2002/04/25/review.html" rel="bookmark">mod_perl Developer's Cookbook</a></h2>
        <div class="asset-meta">
            <span class="byline">
    
                By <span class="vcard author">Simon Cozens</span> on <abbr class="published" title="2002-04-25T00:00:00-08:00">April 25, 2002 12:00 AM</abbr>
    
            </span>

            
            

        </div>
    </div>
    <div class="asset-content entry-content">

        <div class="asset-body">
            <p>I always feel uneasy getting review copies of books like this; review
copies of books are for me to look through, tell people how good or bad
they are, and then sit on the shelf looking pretty. This book,
essentially, is far too useful just to be a review copy, and has been
extremely useful for me in my daily work.</p>
<p>Based very much on the style of the Perl Cookbook, this new offering
from SAMS provides question-and-answer guides to many areas of mod_perl.
Whereas the Eagle Book (<a href="http://www.oreilly.com/catalog/wrapmod/">Writing Apache Modules with Perl and C</a>) provides
an in-depth tutorial on using and programming mod_perl, the mod_perl
Developer's Cookbook is much more useful for dipping into when you have
specific problems to solve.</p>
<p>The down side of this, of course, is that within the recipes, there
isn't a large-scale example. The book is excellent if you already know
what you need to do but not how to do it; it's not so great if you need
your hands holded. In this sense, I think it's best used as a companion
book to the Eagle; use the Eagle to get an idea of what you can do, and
use the Developer's Cookbook when you get stuck.</p>
<p>The range of material covered is pretty staggering, even for a book this
thick - there's good coverage of the various Perl handlers in mod_perl,
invaluable information on tuning Apache with mod_perl, and even,
refreshingly, recipes for creating test suites. As well as the mod_perl
API itself, applications of mod_perl such as AxKit, Template::Toolkit
and the use of technologies such as SOAP are discussed.</p>
<p>Some of the organization of this material is a little suspect, though;
for instance, there's a recipe for timing the lifetime of a request, but
this is hidden away in Chapter 11, "The PerlInitHandler'', rather than in
the chapter on tuning. While this makes sense if you know that timing
involves a PerlInitHandler, this doesn't jive well with a book teaching
you to do things you don't know how to do. In a similar vein, there's a
recipe titled ``Using AxKit'', for if ``you want to use AxKit in a mod_perl
environment'' - with no description of why you might want to use AxKit in
the first place.</p>
<p>Unfortunately, this isn't helped by a deficient index - in fact, I'd
encourage readers to use the table of contents as if it were the index,
as that seems to be a much easier way to find relevant recipes.</p>
<p>Stylistically, the code presented is impeccable. The authors are
well-versed in both Perl and mod_perl idiom, and are not afraid to share
this with the reader. At the same time, the prose is crisp and concise,
but not skimpy. Discussions following on from the recipes are quite
thorough.</p>
<p>The appendices seem to be less useful than they might first appear; I
would have preferred to have seen a summary of the mod_perl API here.
However, these are minor details, and if that's all I can complain
about, I might as well say it: I consider this book to be an invaluable
companion to the Eagle if you're ever doing any serious work with
mod_perl. It's helped me out on several occasions so far, and I expect
it to do so many times in the future.</p>




        </div>



    </div>
    <div class="asset-footer"></div>
</div>


                            
                            <div id="entry-1290" class="entry-asset asset hentry">
    <div class="asset-header">
        <h2 class="asset-name entry-title"><a href="/pub/2002/04/23/mod_perl.html" rel="bookmark">The Perl You Need To Know</a></h2>
        <div class="asset-meta">
            <span class="byline">
    
                By <span class="vcard author">Stas Bekman</span> on <abbr class="published" title="2002-04-23T00:00:00-08:00">April 23, 2002 12:00 AM</abbr>
    
            </span>

            
            

        </div>
    </div>
    <div class="asset-content entry-content">

        <div class="asset-body">
            
<!-- sidebar begins -->
<!-- don't move sidebars -->
<!-- sidebar ends -->


<h3><a name="introduction">Introduction</a></h3>
<p>Before I delve into the details of mod_perl programming, it's probably a good idea to review some important
Perl basics. You will discover these invaluable when you start coding
for mod_perl. I will start with pure Perl notes and gradually move to
explaining the peculiarities of coding for mod_perl, presenting the
traps one might fall into and explaining things obvious for some of us
but may be not for the others.</p>


<h3><a name="using global variables and sharing them between modules/packages">Using Global Variables and Sharing Them Between Modules/Packages</a></h3>

<p>It helps when you code your application in a structured way, using the
perl packages, but as you probably know once you start using packages
it's much harder to share the variables between the various
packagings. A configuration package comes to mind as a good example of
the package that will want its variables to be accessible from the
other modules.</p>

<p>Of course, using the Object Oriented (OO) programming is the best way
to provide an access to variables through the access methods. But if
you are not yet ready for OO techniques, then you can still benefit from
using the techniques I'm going to talk about.</p>

<csperl file="grab" domain="on" record="b/832" template="b/article_sidebar2.view">

<h3><a name="making variables global">Making Variables Global</a></h3>


<p>When you first wrote <code>$x</code> in your code, you created a (package) global
variable.  It is visible everywhere in your program, although if used
in a package other than the package in which it was declared
(<code>main::</code> by default), then it must be referred to with its fully
qualified name, unless you have imported this variable with
import(). This will work only if you do not use <code>strict</code> pragma; but
it's important to use this pragma if you want to run your scripts
under mod_perl.</p>

<h3><a name="making variables global with strict pragma on">Making Variables Global With strict Pragma On</a></h3>
<p>First you use :</p>
<pre><code>
  use strict;</code></pre>
<p>Then you use:</p>
<pre><code>
 use vars qw($scalar %hash @array);</code></pre>
 
<p>This declares the named variables as package globals in the current
package.  They may be referred to within the same file and package
with their unqualified names; and in different files/packages with
their fully qualified names.</p>
<p>With perl5.6 you can use the <code>our</code> operator instead:</p>
<pre><code>
  our ($scalar, %hash, @array);</code></pre>
<p>If you want to share package global variables between packages, then here
is what you can do.</p>

<h3><a name="using exporter.pm to share global variables">Using Exporter.pm to Share Global Variables</a></h3>

<p>Assume that you want to share the <code>CGI.pm</code> object (I will use <code>$q</code>)
between your modules. For example, you create it in <code>script.pl</code>, but
you want it to be visible in <code>My::HTML</code>. First, you make <code>$q</code>
global.</p>
<pre><code>
  script.pl:
  ----------------
  use vars qw($q);
  use CGI;
  use lib qw(.); 
  use My::HTML qw($q); # My/HTML.pm is in the same dir as script.pl
  $q = CGI-&gt;new;
  My::HTML::printmyheader();</code></pre>
<p>Note that I have imported <code>$q</code> from <code>My::HTML</code>. And <code>My::HTML</code> does
the export of <code>$q</code>:</p>
<pre><code>
  My/HTML.pm
  ----------------
  package My::HTML;
  use strict;

  BEGIN {
    use Exporter ();

    @My::HTML::ISA         = qw(Exporter);
    @My::HTML::EXPORT      = qw();
    @My::HTML::EXPORT_OK   = qw($q);

  }
  use vars qw($q);
  sub printmyheader{
    # Whatever you want to do with $q... e.g.
    print $q-&gt;header();
  }
  1;</code></pre>
<p>So the <code>$q</code> is shared between the <code>My::HTML</code> package and
<code>script.pl</code>. It will work vice versa as well, if you create the
object in <code>My::HTML</code> but use it in <code>script.pl</code>. You have true
sharing, since if you change <code>$q</code> in <code>script.pl</code>, then it will be changed
in <code>My::HTML</code> as well.</p>
<p>What if you need to share <code>$q</code> between more than two packages? For
example you want My::Doc to share <code>$q</code> as well.</p>
<p>You leave <code>My::HTML</code> untouched, and modify <em>script.pl</em> to include:</p>
<pre><code>
 use My::Doc qw($q);</code></pre>
<p>Then you add the same <code>Exporter</code> code that I used in <code>My::HTML</code>,
into <code>My::Doc</code>, so that it also exports <code>$q</code>.</p>
<p>One possible pitfall is when you want to use <code>My::Doc</code> in both
<code>My::HTML</code> and <em>script.pl</em>. Only if you add</p>
<pre><code>
  use My::Doc qw($q);</code></pre>
<p>into <code>My::HTML</code> will <code>$q</code> be shared. Otherwise <code>My::Doc</code> will not
share <code>$q</code> any more. To make things clear here is the code:</p>
<pre><code>
  script.pl:
  ----------------
  use vars qw($q);
  use CGI;
  use lib qw(.); 
  use My::HTML qw($q); # My/HTML.pm is in the same dir as script.pl
  use My::Doc  qw($q); # Ditto
  $q = new CGI;

  My::HTML::printmyheader();  
  
  My/HTML.pm
  ----------------
  package My::HTML;
  use strict;

  BEGIN {
    use Exporter ();
    @My::HTML::ISA         = qw(Exporter);
    @My::HTML::EXPORT      = qw();
    @My::HTML::EXPORT_OK   = qw($q);
  }
  use vars     qw($q);
  use My::Doc  qw($q);
  sub printmyheader{
    # Whatever you want to do with $q... e.g.
    print $q-&gt;header();
    My::Doc::printtitle('Guide');
  }
  1;  
  
  My/Doc.pm
  ----------------
  package My::Doc;
  use strict;

  BEGIN {
    use Exporter ();
    @My::Doc::ISA         = qw(Exporter);
    @My::Doc::EXPORT      = qw();
    @My::Doc::EXPORT_OK   = qw($q);
  }
  use vars qw($q);
  sub printtitle{
    my $title = shift || 'None';
    print $q-&gt;h1($title);
  }
  1;</code></pre>













<h3><a name="using the perl aliasing feature to share global variables">Using the Perl Aliasing Feature to Share Global Variables</a></h3>
<p>As the title says, you can import a variable into a script or module
without using <code>Exporter.pm</code>. I have found it useful to keep all the
configuration variables in one module <code>My::Config</code>. But then I have
to export all the variables in order to use them in other modules,
which is bad for two reasons: polluting other packages' name spaces
with extra tags which increases the memory requirements; and adding
the overhead of keeping track of what variables should be exported
from the configuration module and what imported, for some particular
package.  I solve this problem by keeping all the variables in one
hash <code>%c</code> and exporting that. Here is an example of <code>My::Config</code>:</p>
<pre><code>
  package My::Config;
  use strict;
  use vars qw(%c);
  %c = (
    # All the configs go here
    scalar_var =&gt; 5,

    array_var  =&gt; [qw(foo bar)],
    hash_var   =&gt; {
                   foo =&gt; 'Foo',
                   bar =&gt; 'BARRR',
                  },
  );
  1;</code></pre>
<p>Now in packages that want to use the configuration variables I have
either to use the fully qualified names such as <code>$My::Config::test</code>,
which I dislike, or import them as described in the previous section.
But hey, since I have only one variable to handle, I can make things
even simpler and save the loading of the <code>Exporter.pm</code> package. I
will use the Perl aliasing feature for exporting and saving the
keystrokes:</p>
<pre><code>
  package My::HTML;
  use strict;
  use lib qw(.);
    # Global Configuration now aliased to global %c
  use My::Config (); # My/Config.pm in the same dir as script.pl
  use vars qw(%c);
  *c = \%My::Config::c;

    # Now you can access the variables from the My::Config
  print $c{scalar_var};
  print $c{array_var}[0];
  print $c{hash_var}{foo};</code></pre>

<table cellspacing="12" cellpadding="0" border="0" align="right" width="200"><tr><td>
<center><img src="/images/pixel-hub.gif" width="200" height="2" hspace="0" vspace="10" border="0" alt=" " /><br />
<center><a href="http://conferences.oreilly.com/oscon/"><img src="/images/os2002/oscon-sidebar.gif" alt="O'Reilly Open Source Convention -- July 22-26, San Diego, CA." width="143" height="78" border="0" /></a></center>
<p class="smalllist"><strong>From the Frontiers of Research to the Heart of the Enterprise</strong></p>
</center>
<p class="secondary"><a href="http://conferences.oreillynet.com/cs/os2002/view/e_sess/3032">mod_perl 2.0, the Next Generation</a>
Stas Bekman will provide an overview of what's new in mod_perl 2.0 and what else is planned for the future in his talk at the upcoming <a href="http://conferences.oreillynet.com/os2002/">O'Reilly Open Source Convention</a>, this July 22-26, in San Diego.</p>
<center><img src="/images/pixel-hub.gif" width="200" height="2" hspace="0" vspace="0" border="0" alt=" " /></center>
</td></tr></table>
<p>Of course, $c is global when you use it as described above, and
if you change it, then it will affect any other packages you have
aliased <code>$My::Config::c</code> to.</p>
<p>Note that aliases work either with global or <code>local()</code> vars - you
cannot write:</p>
<pre><code>
  my *c = \%My::Config::c; # ERROR!</code></pre>
<p>Which is an error. But you can write:</p>
<pre><code>
  local *c = \%My::Config::c;</code></pre>
<p>For more information about aliasing, refer to the Camel book, second
edition, pages 51-52.</p>
<h3><a name="using nonhardcoded configuration module names">Using Non-Hardcoded Configuration Module Names</a></h3>
<p>You have just seen how to use a configuration module for configuration
centralization and an easy access to the information stored in this
module. However, there is somewhat of a chicken-and-egg problem: how
to let your other modules know the name of this file? Hardcoding the
name is brittle -- if you have only a single project, then it should be fine. If you have more projects that use different configurations and
you will want to reuse their code, then you will have to find all instances
of the hardcoded name and replace it.</p>
<p>Another solution could be to have the same name for a configuration
module, like <code>My::Config</code> but putting a different copy of it into
different locations. But this won't work under mod_perl because of the
namespace collision. You cannot load different modules that use the
same name; only the first one will be loaded.</p>
<p>Luckily, there is another solution that allows us to be flexible.
<code>PerlSetVar</code> comes to rescue. Just like with environment variables,
you can set server's global Perl variables that can be retrieved from
any module and script. Those statements are placed into the
<em>httpd.conf</em> file. For example</p>
<pre><code>
  PerlSetVar FooBaseDir       /home/httpd/foo
  PerlSetVar FooConfigModule  Foo::Config</code></pre>
<p>Now I <code>require()</code> the file where the above configuration will be used.</p>
<pre><code>
  PerlRequire /home/httpd/perl/startup.pl</code></pre>
<p>In the <em>startup.pl</em> I might have the following code:</p>
<pre><code>
    # retrieve the configuration module path
  use Apache:
  my $s             = Apache-&gt;server;
  my $base_dir      = $s-&gt;dir_config('FooBaseDir')      || '';
  my $config_module = $s-&gt;dir_config('FooConfigModule') || '';
  die &quot;FooBaseDir and FooConfigModule aren't set in httpd.conf&quot; 
    unless $base_dir and $config_module;

    # build the real path to the config module
  my $path = &quot;$base_dir/$config_module&quot;;
  $path =~ s|::|/|;
  $path .= &quot;.pm&quot;;
    # I have something like &quot;/home/httpd/foo/Foo/Config.pm&quot;
    # now I can pull in the configuration module
  require $path;</code></pre>
<p>Now I know the module name and it's loaded, so for example if I need
to use some variables stored in this module to open a database
connection, then I will do:</p>
<pre><code>
  Apache::DBI-&gt;connect_on_init
  (&quot;DBI:mysql:${$config_module.'::DB_NAME'}::${$config_module.'::SERVER'}&quot;,
   ${$config_module.'::USER'},
   ${$config_module.'::USER_PASSWD'},
   {
    PrintError =&gt; 1, # warn() on errors
    RaiseError =&gt; 0, # don't die on error
    AutoCommit =&gt; 1, # commit executes immediately
   }
  );</code></pre>
<p>Where variable like:</p>
<pre><code>
  ${$config_module.'::USER'}</code></pre>
<p>In my example are really:</p>
<pre><code>
  $Foo::Config::USER</code></pre>
<p>If you want to access these variable from within your code at the run
time, instead accessing to the server object <code>$c</code>, then use the request
object <code>$r</code>:</p>
<pre><code>
  my $r = shift;
  my $base_dir      = $r-&gt;dir_config('FooBaseDir')      || '';
  my $config_module = $r-&gt;dir_config('FooConfigModule') || '';</code></pre>













<h3><a name="the scope of the special perl variables">The Scope of the Special Perl Variables</a></h3>
<p>Now let's talk about Special Perl Variables.</p>
<p>Special Perl variables like <code>$|</code> (buffering), <code>$^T</code> (script's start
time), <code>$^W</code> (warnings mode), <code>$/</code> (input record separator), <code>$\</code>
(output record separator) and many more are all true global variables;
they do not belong to any particular package (not even <code>main::</code>) and
are universally available. This means that if you change them, then you
change them anywhere across the entire program; furthermore you cannot
scope them with my(). However, you can local()ize them, which means that
any changes you apply will only last until the end of the enclosing
scope. In the mod_perl situation where the child server doesn't
usually exit, if in one of your scripts you modify a global variable, then
it will be changed for the rest of the process' life and will affect
all the scripts executed by the same process. Therefore, localizing
these variables is highly recommended; I'd say even mandatory.</p>
<p>I will demonstrate the case on the input record separator variable. If
you undefine this variable, then the diamond operator (readline) will suck
in the whole file at once if you have enough memory. Remembering this
you should never write code like the example below.</p>
<pre><code>
  $/ = undef; # BAD!
  open IN, &quot;file&quot; ....
    # slurp it all into a variable
  $all_the_file = &lt;IN&gt;;</code></pre>
<p>The proper way is to have a <code>local()</code> keyword before the special
variable is changed, like this:</p>
<pre><code>
  local $/ = undef; 
  open IN, &quot;file&quot; ....
    # slurp it all inside a variable
  $all_the_file = &lt;IN&gt;;</code></pre>
<p>But there is a catch. <code>local()</code> will propagate the changed value to the
code below it.  The modified value will be in effect until the script
terminates, unless it is changed again somewhere else in the script.</p>
<p>A cleaner approach is to enclose the whole of the code that is
affected by the modified variable in a block, like this:</p>
<pre><code>
  {
    local $/ = undef; 
    open IN, &quot;file&quot; ....
      # slurp it all inside a variable
    $all_the_file = &lt;IN&gt;;
  }</code></pre>
<p>That way when Perl leaves the block it restores the original value of
the <code>$/</code> variable, and you don't need to worry elsewhere in your
program about its value being changed here.</p>
<p>Note that if you call a subroutine after you've set a global variable
but within the enclosing block, the global variable will be visible
with its new value inside the subroutine.</p>


<h3><a name="compiled regular expressions">Compiled Regular Expressions</a></h3>
<p>And finally I want to cover the pitfall many people have fallen
into. Let's talk about regular expressions use under mod_perl.</p>
<p>When using a regular expression that contains an interpolated Perl
variable, if it is known that the variable (or variables) will not
change during the execution of the program, a standard optimization
technique is to add the <code>/o</code> modifier to the regex pattern.  This
directs the compiler to build the internal table once, for the entire
lifetime of the script, rather than each time the pattern is
executed. Consider:</p>
<pre><code>
  my $pat = '^foo$'; # likely to be input from an HTML form field
  foreach( @list ) {
    print if /$pat/o;
  }</code></pre>

<table width="150" border="0" cellspacing="0" cellpadding="4" align="right">
<tr> 
<td width="150" valign="top" height="4" bgcolor="#6699cc"></td></tr> 
<tr>
<td bgcolor="#efefef">
<p class="headline" align="center">Previously in the Series
</p>
<p class="secondary">
<a href="/pub/a/2002/04/10/mod_perl.html">Installing mod_perl without superuser privileges</a><br /><br />
<a href="/pub/a/2002/03/22/modperl.html">mod_perl in 30 minutes</a><br /><br />
<a href="/pub/a/2002/02/26/whatismodperl.html">Why mod_perl?</a>


</td></tr> <tr><td width="150" valign="top" height="4" bgcolor="#6699cc"> </td></tr></table>
<p>This is usually a big win in loops over lists, or when using the
<code>grep()</code> or <code>map()</code> operators.</p>
<p>In long-lived mod_perl scripts, however, the variable may change with
each invocation and this can pose a problem. The first invocation of a
fresh httpd child will compile the regex and perform the search
correctly. However, all subsequent uses by that child will continue to
match the original pattern, regardless of the current contents of the
Perl variables the pattern is supposed to depend on. Your script will
appear to be broken.</p>
<p>There are two solutions to this problem:</p>
<p>The first is to use <code>eval q//</code>, to force the code to be evaluated
each time. Just make sure that the eval block covers the entire loop
of processing, and not just the pattern match itself.</p>
<p>The above code fragment would be rewritten as:</p>
<pre><code>
  my $pat = '^foo$';
  eval q{
    foreach( @list ) {
      print if /$pat/o;
    }
  }</code></pre>
<p>Just saying:</p>
<pre><code>
  foreach( @list ) {
    eval q{ print if /$pat/o; };
  }</code></pre>
<p>means that I recompile the regex for every element in the list, even
though the regex doesn't change.</p>
<p>You can use this approach if you require more than one pattern match
operator in a given section of code. If the section contains only one
operator (be it an <code>m//</code> or <code>s///</code>), then you can rely on the property of
the null pattern, that reuses the last pattern seen. This leads to the
second solution, which also eliminates the use of eval.</p>
<p>The above code fragment becomes:</p>
<pre><code>
  my $pat = '^foo$';
  &quot;something&quot; =~ /$pat/; # dummy match (MUST NOT FAIL!)
  foreach( @list ) {
    print if //;
  }</code></pre>
<p>The only gotcha is that the dummy match that boots the regular
expression engine must absolutely, positively succeed, otherwise the
pattern will not be cached, and the <code>//</code> will match everything. If
you can't count on fixed text to ensure the match succeeds, then you have
two possibilities.</p>
<p>If you can guarantee that the pattern variable contains no
meta-characters (things like *, +, ^, $...), then you can use the dummy
match:</p>
<pre><code>
  $pat =~ /\Q$pat\E/; # guaranteed if no meta-characters present</code></pre>
<p>If there is a possibility that the pattern can contain
meta-characters, then you should search for the pattern or the
nonsearchable \377 character as follows:</p>
<pre><code>
  &quot;\377&quot; =~ /$pat|^\377$/; # guaranteed if meta-characters present</code></pre>
<p>Another approach:</p>
<p>It depends on the complexity of the regex to which you apply this
technique.  One common usage where a compiled regex is usually more
efficient is to "<em>match any one of a group of patterns</em>'' over and
over again.</p>
<p>Maybe with a helper routine, it's easier to remember.  Here is one
slightly modified from Jeffery Friedl's example in his book
"<em>Mastering Regular Expressions</em>''.</p>
<pre><code>
  #####################################################
  # Build_MatchMany_Function
  # -- Input:  list of patterns
  # -- Output: A code ref which matches its $_[0]
  #            against ANY of the patterns given in the
  #            &quot;Input&quot;, efficiently.
  #
  sub Build_MatchMany_Function {
    my @R = @_;
    my $expr = join '||', map { &quot;\$_[0] =~ m/\$R[$_]/o&quot; } ( 0..$#R );
    my $matchsub = eval &quot;sub { $expr }&quot;;
    die &quot;Failed in building regex @R: $@&quot; if $@;
    $matchsub;
  }</code></pre>
<p>Example usage:</p>
<pre><code>
  @some_browsers = qw(Mozilla Lynx MSIE AmigaVoyager lwp libwww);
  $Known_Browser=Build_MatchMany_Function(@some_browsers);

  while (&lt;ACCESS_LOG&gt;) {
    # ...
    $browser = get_browser_field($_);
    if ( ! &amp;$Known_Browser($browser) ) {
      print STDERR &quot;Unknown Browser: $browser\n&quot;;
    }
    # ...
  }</code></pre>
<p>In the next article, I'll present a few other Perl basics directly
related to the mod_perl programming.</p>


<h3><a name="references">References</a></h3>
<ul>
<li>
The book "<em><a href="http://www.oreilly.com/catalog/regex/">Mastering Regular Expressions</a></em>'' by Jeffrey E. Friedl.
<p></p>
<li>
The book "<em><a href="http://www.oreilly.com/catalog/lperl3/">Learning Perl</a></em>'' by Randal L. Schwartz (also known as the
"<em>Llama</em>'' book, named after the llama picture on the cover of the
book).
<p></p>
<li>
The book "<em><a href="http://www.oreilly.com/catalog/pperl3/">Programming Perl</a></em>'' by L.Wall, T. Christiansen and J.Orwant
(also known as the "<em>Camel</em>'' book, named after the camel picture on
the cover of the book).
<p></p>
<li>
The <em>Exporter</em>, <em>perlre</em>, <em>perlvar</em>, <em>perlmod</em> and <em>perlmodlib</em>
man pages.
<p></p></ul>







        </div>



    </div>
    <div class="asset-footer"></div>
</div>


                            
                            <div id="entry-1288" class="entry-asset asset hentry">
    <div class="asset-header">
        <h2 class="asset-name entry-title"><a href="/pub/2002/04/16/axkit.html" rel="bookmark">XSP, Taglibs and Pipelines</a></h2>
        <div class="asset-meta">
            <span class="byline">
    
                By <span class="vcard author">Barrie Slaymaker</span> on <abbr class="published" title="2002-04-16T00:00:00-08:00">April 16, 2002 12:00 AM</abbr>
    
            </span>

            
            

        </div>
    </div>
    <div class="asset-content entry-content">

        <div class="asset-body">
            
<p>In the <a href="/pub/a/2002/03/12/axkit.html">first article</a> in
this series, we saw how to install, configure and test AxKit, and we
took a look at a simple processing pipeline.  In this article, we will
see how to write a simple 10-line XSP taglib and use it in a pipeline
along with XSLT to build dynamic pages in such a way that gets the
systems architects and coders out of the content maintenance business.
Along the way, we'll discuss <a href="#why_pipelines">the pipeline
processing model</a> that makes AxKit so powerful.</p>

<p>First though, let us catch up on some changes in the AxKit world.</p>

<h3>CHANGES</h3>

<p>Matt and company have released AxKit v1.5.1, and 1.5.2 looks as though it
will be out soon.  1.5.1 provides a few improvements and bug fixes,
especially in the XSP engine discussed in this article.  The
biggest additions are the inclusion of a set of demonstration pages that
can be used to test and experiment with AxKit's capabilities, and
another module to help with writing taglibs (Jorge Walter's <a href="http://search.cpan.org/doc/MSERGEANT/AxKit-1.51/lib/Apache/AxKit/Language/XSP/SimpleTaglib.pm">SimpleTaglib</a>,
which we'll look at in the next article).</p>

<p>There has also been a release policy change: The main AxKit
distributions (AxKit-1.5.1.tar.gz for instance) will no longer contain
the minimal set of prerequisites; these will now be bundled in a
separate tarball.  This policy change enables people to download just
AxKit (when upgrading it, for instance) and recognizes the fact that
AxKit is an <a href="http://xml.apache.org/">Apache project</a> while
the prerequisites aren't.  Until the prerequisite tarball gets
released, the <a href="/2002/04/16/examples/axkit_articles-2.0.tar.gz">source
tarball</a> that accompanies this article contains them all (though it
installs them in a local directory only, for testing purposes).  The
main AxKit tarball still includes all the core AxKit modules.</p>

<h4>XSP and taglibs</h4>

<p>We <a href="/pub/a/2002/03/12/axkit.html?page=3">touched
on</a> eXtensible Server Pages and taglibs in the last article; this
time we'll take a deeper look and try to see how <a href="http://axkit.org/docs/xsp/index.xml">XSP</a>, taglibs and XSLT
can be combined in a powerful and useful way.</p>

<blockquote>A quick taglib refresher: A taglib is a collection of XML tags in an
<a href="http://www.jclark.com/xml/xmlns.htm">XML namespace</a> that act
like conditionals or subroutine calls.
Essentially, taglibs are a way of encoding logic and dynamic content in
to pages without including raw "native" code (Perl, Java, COBOL; any of
the popular Web programming languages) in the page; each taglib provides
a set of related services and multiple taglibs may be used in the same
XSP page.</blockquote>

<p>For our example, we will build a "data driven" processing pipeline
(clicking on a blue icon or arrow will take you to the relevant
documentation or section of this article):</p>

<a name="weather1_flow.png" href="#"></a>
<img src="/pub/2002/04/16/graphics/weather1_flow.png"
    alt="weather1.xsp processing pipeline"
    border="0"
    usemap="#map" /> 
<map name="map">
<!-- #$-:Image Map file created by GIMP Imagemap Plugin -->
<!-- #$-:GIMP Imagemap Plugin by Maurits Rijk -->
<!-- #$-:Please do not edit lines starting with "#$" -->
<!-- #$VERSION:1.3 -->
<!-- #$AUTHOR:barries -->
  <area shape="rect" coords="11,78,60,139" alt="The source XSP document" href="#weather1.xsp" />
  <area shape="rect" coords="192,78,228,206" alt="The first XSLT stylesheet: weather.xsl" href="#weather.xsl" />
  <area shape="rect" coords="239,78,277,206" alt="The second XSLT stylesheet: as_html.xsl" href="#as_html.xsl" />
  <area shape="rect" coords="288,78,336,138" alt="The final document" href="#result_doc" />
  <area shape="rect" coords="181,102,191,114" alt="The output from the XSP processor" href="#XSP_out" />
  <area shape="rect" coords="230,100,239,115" alt="The output from the first XSLT processor" href="#XSLT1_out" />
  <area shape="rect" coords="102,126,150,144" alt="My::Weather code and description" href="#My::WeatherTaglib" />
  <area shape="rect" coords="77,102,126,120" alt="The Util taglib" href="http://search.cpan.org/doc/MSERGEANT/AxKit-XSP-Util-1.5/Util.pm" />
  <area shape="rect" coords="132,102,174,120" href="http://search.cpan.org/doc/MSERGEANT/AxKit-XSP-Param-1.4/Param.pm" alt="" />
</map>

<blockquote><img src="/pub/2002/04/16/graphics/weather1_flow_icon.png" alt="Example icon" border="0" align="right" />
NOTE: A little icon like this will be shown with the description of
each piece of the pipeline with that piece hilighted.  Clicking on those icons
will bring you back to this diagram.</blockquote>

<p>This pipeline has five stages:</p>

<ol>

<li>the XSP document (<a href="#weather1.xsp"><code>weather1.xsp</code></a>) defines what chunks of raw data
(current time and weather readings) are needed for this page in a simple
XML format,
</li>
<li>the XSP processor applies taglibs to assemble the raw data for the
page,
</li>
<li>the first XSLT processor and stylesheet (<a href="weather.xsl"
alt="weather.xsl code"><code>weather.xsl</code></a>)
format the raw data in to usable content,
</li>
<li>the second XSLT processor and stylesheet (<a href="#as_html.xsl"
alt="as_html.xsl code and description"><code>as_html.xsl</code></a>) lays
out and generates the final page ("Result Doc"), and
</li>
<li>the Gzip compressor automatically compresses the output if the
client can comprehend compressed content (even when an older browser is
bashful and does not announce that it can cope with gzip-encoded
content).
</li>
</ol>

<p><a name="mimicry" /></a>This multipass approach mimics those found in real 
  applications; each stage has a specific purpose and can be designed and tested 
  independently of the others.</p>

<p>In a real application, there might well be more filters: Our second
XSLT filter might be tweaked to build document without any "look and feel," and an additional filter could be used to implement the "look and feel" of the presentation after the layout is complete.  This would allow look and feel to be altered independently of the layout.</p>

<blockquote>We call this a "data driven" pipeline because the document
feeding the pipeline defines what data is needed to serve the page; it
does not actually contain any content.  Later stages add the content and
format it.  We'll look at a "document driven" pipeline, which feeds the
pipeline with the document to be served, in the next
article.</blockquote>

<a name="why_pipelines"></a>
<h4>Why pipelines?</h4>

<p>The XML pipeline-processing model used by AxKit is a powerful
approach that brings technical and social advantages to document-processing systems lsuch as Web applications.</p>

<p>On the social side, the concept of a pipeline or assembly line is
simple enough to be taught to and grasped by nonprogrammers.  Some of
the approaches used by HTML-oriented tools (like many on CPAN) are not
exactly designer-friendly: They rely on programmer-friendly concepts
such as abstract data structures, miniature programming languages,
"catch-all" pages and object-oriented techniques such as method dispatch.
To be fair, some designers can and do learn the concepts, and others
have Perl implementors who deploy these tools in simple patterns that
are readily grasped.</p>

<p>The reason that HTML-oriented tools have a hard time something as
simple as a pipeline model is that HTML is a presentation language and
does not lend itself to describing data structures or to incremental
processing.  The advantage of incremental processing is that the number
of stages can be designed to fit the application and organization; with
other tools, there's often a one- or two-stage approach where the first
stage is almost entirely in the realm of the Perl coders ("prepare thedata") and the second is halfway in the realm of the coders and halfway in the designer's realm.</p>

<p>XML can be used both to describe data structures and mark up prose
documents; this allows a pipeline to mingle data and prose in flexible
ways.  Each processing stage is XML-in, XML-out (except for the first
and last, which often consume and generate other formats).  However, the
stages aren't limited to dealing purely with XML: The taglibs we're
using show one way that stages can use Perl code (and, by extension,
many other languages; see the <a href="http://theoryx5.uwinnipeg.ca/mod_perl/cpan-search?search=Inline%3A%3A">Inline</a>
series of modules), external libraries, and almost any non-XML data as
needed.  Not only does My::WeatherTaglib integrate with Perl code, it's
also requesting data over the Internet from a remote site.</p>

<p>The use of XML as the carrier for data between the stages also
allows each stage to be debugged and unit tested.  The documents that
forwarded between the stages are often passed as internal data
structures instead of XML strings for efficiency's sake, but they can be
rendered (like the examples shown in this article) and examined, both
for teaching purposes and debugging purposes.  The uniform look and feel
of XML, whatever it's disadvantages, is at least readily understood by
any competent Web designer.</p>

<p>Pipelines are also handy mechanisms in that the individual stages are
chosen at request time; different stages can be selected to
deliver different views of the same content.  AxKit provides several
powerful mechanisms for configuring pipelines, the
<code>&lt;xml-stylesheet ...&gt;</code> approach used in this article is
merely the simplest; future articles will explore building flexible
pipelines.</p>

<p>Pipelines also make a useful distinction between the manager (AxKit)
and the processing technologies.  Not only does this allow you to mix
and match processing techniques as needed (AxKit ships with nine
"Languages", or types of XML processor, and several "Providers", or data
sources), it also allows new technologies to be incorporated in to
existing sites when a new technology is needed.</p>

<p>Moreover, technologies like XML and XSLT are standardized and are
becoming widely accepted and supported.  This means that most, if not
all the documents in our example pipeline can be handed off to non-Perl
coders without (much) fear of them mangling the code.  When they do
mangle it; tools such as xsltproc (shipped with libxslt, one of the AxKit
XSLT processors) can be used to give the designers a first line of
defense before calling in the programmers.  Even taglibs, nonstandard
though they are, leverage the XML standard to make logic and data
available to noncoders in a (relatively) safe manner.  For instance, <a href="http://www.zvon.org/xxl/XSLTutorial/Output/index.html">here's an
excellent online tutorial</a> provided by <a href="http://www.zvon.org/">ZVON.org</a>.</p>

<p>Mind you, XML and XSLT have their rough spots; the trick is that you
don't need to know all the quirky ins and outs of the XML specification
or use XSLT for things that are painful to do in it.  I mean, really,
when was the last time you dealt with a <a href="http://www.w3.org/TR/REC-xml#Notations">notation declaration</a>?
Most uses of XML use a small subset of the XML specification, and other
tools such as XSP, XPathScript and various schema languages can be used
where XSLT would only make the problem more difficult.</p>

<p>What stages are appropriate depends on the
application's requirements and those of the organization(s) involved in
building, operating and maintaining it.  In the next
article, we'll examine a "document driven" pipeline and a taglib better
suited for this approach that uses different stages.</p>

<p>All that being said there will always be a place for the non-XML and
non-pipelined solutions: XML and pipelines are <i>not</i> panaceas.  I
still use other solutions when the applications or organizations I work
with would not benefit from XML.</p>

<a name="httpd.conf"></a>
<h4><code>httpd.conf</code>: the AxKit
configuration</h4>

<p>Before we start in to the example code, let's glance at the AxKit
configuration.  Feel free to <a href="#My::WeatherTaglib">skip ahead
to the code</a> if you like; otherwise, here's the configuration we'll
use in <code>httpd.conf</code>:</p>

<a name="httpd.conf2"></a>
<pre><code>
    ##
    ## Init the httpd to use our "private install" libraries
    ##
    PerlRequire startup.pl
    
    ##
    ## AxKit Configuration
    ##
    PerlModule AxKit
    
    &lt;Directory /home/me/htdocs"&gt;
	        Options -All +Indexes +FollowSymLinks
    
        # Tell mod_dir to translate / to /index.xml or /index.xsp
        DirectoryIndex index.xml index.xsp
        AddHandler axkit .xml .xsp
    
        AxDebugLevel 10
    
        AxGzipOutput Off
    
        <b>AxAddXSPTaglib AxKit::XSP::Util</b>
        <b>AxAddXSPTaglib AxKit::XSP::Param</b>
        <b>AxAddXSPTaglib My::WeatherTaglib</b>
    
        <b>AxAddStyleMap application/x-xsp
                      Apache::AxKit::Language::XSP</b>
    
        <b>AxAddStyleMap text/xsl
                      Apache::AxKit::Language::LibXSLT</b>
    &lt;/Directory&gt;
</code></pre>

<p>This is the same configuration from the <a href="/pub/a/2002/03/12/axkit.html?page=2#testing">the last
article</a>&#8212;most of the directives and the processing model used
by Apache and AxKit for them are described in detail there.  The two
directives in <b>bold</b> have been added.  The key directives for our
example are <code>AxAddXSPTaglib</code> and <code>AxAddStyleMap</code>.</p>

<p>The <code>AxAddXSPTaglib</code> directives load three tag libraries:
Kip Hampton's <a href="http://search.cpan.org/doc/MSERGEANT/AxKit-XSP-Util-1.5/Util.pm">Util</a>
and <a href="http://search.cpan.org/doc/MSERGEANT/AxKit-XSP-Param-1.4/Param.pm">Param</a>
taglibs and our very own <a href="#My::WeatherTaglib">WeatherTaglib</a>.
Util will allow our example to get at the system time; Param will allow it
to parse URLs; and WeatherTaglib will allow us to fetch the current weather
conditions for that zip code.</p>

<p>The two <code>AxAddStyleMap</code> directives map a pair of mime
types to an XSP and an XSLT processor.  Our example source document will
refer to these mime types to configure instances of XSP and XSLT
processors in to the processing pipeline.</p>

<blockquote>We're using Apache::AxKit::Language::LibXSLT to perform XSLT
transforms, which uses the GNOME project's <a href="http://xmlsoft.org/XSLT/">libxslt</a> library under the hood.
Different XSLT engines offer different sets of features.  If you prefer,
then you can also use Apache::AxKit::Language::Sablot for XSLT work.  You can
even use them in the same pipeline by assigning them to different mime
types.  </blockquote>

<a name="My::WeatherTaglib"></a>
<h4>
<a href="#weather1_flow.png"
   name="weather1_flow_weather_taglib.png"><img
     src="/pub/2002/04/16/graphics/weather1_flow_weather_taglib.png"alt="My::WeatherTaglib's position in the weather1.xsp processing pipeline" border="0" align="right" /></a>
My::WeatherTaglib</h4>

<p>Here's a taglib that uses <a href="http://theoryx5.uwinnipeg.ca/CPAN/data/Geo-Weather/Weather.html">Geo::Weather</a>
module on CPAN to take a zip code and fetch some weather
observations from <a href="http://weather.com/">weather.com</a> and
convert them to XML:</p>

<pre><code>
    package My::WeatherTaglib;
    
    $NS = "<b>http://slaysys.com/axkit_articles/weather/</b>";
    @EXPORT_TAGLIB = ( '<b>report($zip)</b>' );
    
    use strict;
    <b>use Apache::AxKit::Language::XSP::TaglibHelper;</b>
    use Geo::Weather;
    
    sub report { Geo::Weather->new->get_weather( @_ ) }
    
    1;
</code></pre>

<p>This taglib uses Steve Willer's <a href="http://search.cpan.org/doc/MSERGEANT/AxKit-1.51/lib/Apache/AxKit/Language/XSP/TaglibHelper.pm">TaglibHelper</a>
(included with AxKit) to automate the drudgery of dealing with XML.
Because of this, our example taglib distills a lot of power into a few
lines of Perl.  Don't be fooled, though, there's a lot going on behind
the curtains with this module.</p>

<p>When a tag like <code>&lt;weather:report zip="15206"/&gt;</code> is
encountered in an XSP page, it will be translated into a call to
<code>report( "15206" )</code>, the result of the call will be converted
to XML and will replace the original tag in the XSP output document.</p>

<p>The <code>$NS</code> variable sets the <a href="http://www.jclark.com/xml/xmlns.htm">namespace URI</a> for the
taglib; this configures XSP to direct all elements within the namespace
<code>http://slaysys.com/axkit_articles/weather/</code> to
My::WeatherTaglib, as we'll see in a bit.</p>

<blockquote>When used in an XSP page, all XML elements supplied by a
taglib will have a namespace prefix.  For instance, the prefix
<code>weather:</code> is mapped to My::WeatherTaglib's namespace in the
XSP page below.  This prefix is not determined by the taglib&8212;we
could have chosen another; this section assumes that the prefix
<code>weather:</code> is used for the sake of clarity.</blockquote>

<p>The <code>@EXPORT_TAGLIB</code> specifies what functions will be exported as 
  elements in this namespace and what parameters they accept (see <a href="http://search.cpan.org/doc/MSERGEANT/AxKit-1.51/lib/Apache/AxKit/Language/XSP/TaglibHelper.pm">the 
  documentation</a> for details). The <code>report($zip)</code> export specification 
  exports a tag that is invoked like <code>&lt;weather:report zip="..."/&gt;</code> 
  or </p>
<pre><code>
    &lt;weather:report&gt;
        &lt;weather:zip&gt;15206&lt;/weather:zip&gt;
    &lt;/weather:report&gt;
</code></pre>

<p>The words "report" and "zip" in the <code>@TAGLIB_EXPORT</code>
definition are used to determine the taglib element and attribute names;
the order of the parameters in the definition determines the order they
are passed in to the function.  When invoking a taglib, the XML may
specify the parameters in any order in the XML.  The names they are
specified with are not important to or visible from the Perl code by
default (see the <a href="http://search.cpan.org/doc/MSERGEANT/AxKit-1.51/lib/Apache/AxKit/Language/XSP/TaglibHelper.pm#FUNCTION_SPECIFICATIONS">*argument
function specification</a> for how to accept an XML tree if need be).</p>

<p>All that's left for us to do is to write the "body" of the taglib by
<code>use()</code>ing <code>Geo::Weather</code> and writing the
<code>report()</code> subroutine.</p>
<p>There are two major conveniences provided by TaglibHelper. The first
is welding Perl subroutines to XML tags (via the
<code>@EXPORT_TAGLIB</code> definitions).  The second is converting the
Perl data structure returned by <code>report()</code>, a hash reference
like</p>

<pre><code>
    {
      city  =&gt; "Pittsburgh",
      state =&gt; "PA",
      cond  =&gt; "Sunny",
      temp  =&gt; 76,
      pic   =&gt; "http://image.weather.com/web/common/wxicons/52/26.gif",
      url   =&gt; "http://www.weather.com/search/search?where=15206",
      ...
    }
</code></pre>

<p>in to <a href="http://www.w3.org/TR/xml-fragment#defn-well-balanced">well balanced</a> 
  XML like: </p>
<pre><code>
      &lt;city&gt;Pittsburgh&lt;/city&gt;
      &lt;state&gt;PA&lt;/state&gt;
      &lt;cond&gt;Sunny&lt;/cond&gt;
      &lt;temp&gt;76&lt;/temp&gt;
      &lt;pic&gt;http://image.weather.com/web/common/wxicons/52/26.gif&lt;/pic&gt;
      &lt;url&gt;http://www.weather.com/search/search?where=15206&lt;/url&gt;
      ...
</code></pre>

<p>TaglibHelper allows plain strings, data structures and strings of
well-balanced XML to be returned.  By writing a single one-line
subroutine that returns a Perl data structure, we've written a taglib
that requires no Perl expertise to use (any XHTML jock could use it
safely using their favorite XML, HTML or text editor) and that can be
used to serve up "data" responses for XML-RPC-like applications or
"text" documents for human consumption.</p>

<blockquote>The <a href="http://theoryx5.uwinnipeg.ca/CPAN/data/Data-Dumper/Dumper.html">Data::Dumper</a>
module that ships with Perl is a good way to peer inside the data
structures floating around in a request.  Wehn run in AxKit, a quick
<code>warn Dumper( $foo );</code> will dump the data structure referred
to by <code>$foo</code> to the Apache error log.</blockquote>

<p>The output XML from a taglib replaces the orignal tag in the
result document.  In our case, the replacement XML is not too useful
as-is, it's just data that looks a bit XMLish.  Representing data
structures as XML may seem awkward to Perl gurus, but it's quite helpful
if you want to get the Perl code safely out of the way and allow others
to use XML tools to work with the data.</p>

<p>The "data documents" from our XSP processor will upgraded in later
processing stages to content that is presentable to the client; our XSP
page neither knows nor cares how it is to be presented.  Exporting the
raw data as XML here is intended to show how to get the Perl gurus out
of the critical path for content development by allowing site designers
and content authors to do it.</p>

<p>Emitting structured data from XSP pages is just one approach.
Taglibs can return whatever the "best fit" is for a given application,
whether that be raw data, pieces of content or an entire article.</p>

<blockquote><a href="http://xml.apache.org/cocoon/">Cocoon</a>, the
system AxKit was primarily inspired by, uses a different approach to
writing taglibs.  AxKit also supports that approach, but it tends to be
more awkward, so it will be examined in the next article. We'll also
look at Jorge Walter's new <a href="http://search.cpan.org/doc/MSERGEANT/AxKit-1.51/lib/Apache/AxKit/Language/XSP/SimpleTaglib.pm">SimpleTaglib</a>
module then, which is newer and more flexible, but less portable than
the TaglibHelper module we're looking at here.</blockquote>

<a name="weather1.xsp"></a>
<h4>
<a href="#weather1_flow.png" name="weather1_flow_weather_xsp.png"><img
     src="/pub/2002/04/16/graphics/weather1_flow_weather_xsp.png" alt="My::WeatherTaglib's position in the weather1.xsp processing pipeline" border="0" align="right"/></a>
<code>weather1.xsp</code>: Using My::WeatherTaglib</h4><br />

<p>Here's a page (<code>weather1.xsp</code>) that uses the My::WeatherTaglib and 
  the "standard" XSP <a href="http://search.cpan.org/doc/MSERGEANT/AxKit-XSP-Util-1.5/Util.pm">util taglib</a> 
  we used in the previous article</a>: </p>
<pre><code>
    &lt;?xml-stylesheet href="NULL"        type="<b>application/x-xsp</b>"?&gt;
    &lt;?xml-stylesheet href="<b>weather.xsl</b>" type="<b>text/xsl</b>"         ?&gt;
    &lt;?xml-stylesheet href="<b>as_html.xsl</b>" type="<b>text/xsl</b>"         ?&gt;
    
    &lt;xsp:page
        xmlns:xsp="http://www.apache.org/1999/XSP/Core"
        <b>xmlns:util="http://apache.org/xsp/util/v1"</b>
        <b>xmlns:param="http://axkit.org/NS/xsp/param/v1"</b>
        <b>xmlns:weather="http://slaysys.com/axkit_articles/weather/"</b>
    &gt;
    &lt;data&gt;
      &lt;title&gt;&lt;a name="title"/&gt;My weather report&lt;/title&gt;
      &lt;time&gt;
        <b>&lt;util:time format="%H:%M:%S" /&gt;</b>
      &lt;/time&gt;
      &lt;weather&gt;
        <b>&lt;weather:report&gt;
          &lt;!-- Get the ?zip=12345 from the URI and pass it
               to the weather:report tag as a parameter --&gt;
          &lt;weather:zip&gt;&lt;param:zip/&gt;&lt;/weather:zip&gt;
        &lt;/weather:report&gt;</b>
      &lt;/weather&gt;

    &lt;/data&gt;
    &lt;/xsp:page&gt;
</code></pre>

<p>When <code>weather1.xsp</code> is requested, AxKit parses the
<code>&lt;?xml-stylesheet ...?&gt;</code> processing instructions and uses
the <code>AxAddStyleMap</code>
directives to build the processing chain <a href="#weather1_flow.png">shown above</a>.</p>

<p>
<a href="#weather1_flow.png" name="weather1_flow_XSP.png">
<img src="/pub/2002/04/16/graphics/weather1_flow_XSP.png" alt="My::WeatherTaglib's position in the weather1.xsp processing pipeline" name="weather1_flow_XSP.png" border="0" align="right" /></a></p>

<p>
The XSP processor is the first processor in the pipeline.  As it parses
the page, it sends all elements with <code>util:</code>,
<code>param:</code> or <code>weather:</code> prefixes to the <a href="http://search.cpan.org/doc/MSERGEANT/AxKit-XSP-Util-1.5/Util.pm">Util</a>,
<a href="http://search.cpan.org/doc/MSERGEANT/AxKit-XSP-Param-1.4/Param.pm">Param
</a>,
and <a href="#My::WeatherTaglib">WeatherTaglib</a> taglibs.  This
mapping is defined by the <code>xmlns:...</code> attributes and by the
namespace URIs that are hardcoded into each taglib's implementation
(see the <code>$NS</code> variable in <a href="#My::WeatherTaglib">My::WeatherTaglib</a>).</p>

<p>In this page, the <code>&lt;util:time&gt;</code> element results in a
call to Util's <code>get_date()</code> and the value of the
<code>format=</code> attribute is passed in as a parameter.  The string
returned by <code>get_date()</code> is converted to XML and emitted
instead of the <code>&lt;util:time&gt;</code> element in the output
page.  This shows how to pass simple constant parameters to a taglib.</p>

<p>We're getting slightly trickier with the
<code>&lt;weather:report&gt;</code> element: This construct fetches the
zip parameter from the request URI's query string (or form field) and
passes it to WeatherTaglib's <code>report()</code> as the
<code>$zip</code> parameter.  Thanks to Kip Hampton for the help in
using AxKit::XSP::Param in this manner.</p>

<p>Because we have the <code>AxDebugLevel</code> set to <code>10</code>,
you can see these calls the compiled version of
<code>weather1.xsp</code>; the generated Perl code is written to Apache's
error log&#8212;usually <code>$SERVER_ROOT/logs/error_log</code>.</p>

<p>The <code>&lt;a name="title"/&gt;</code> in the
<code>&lt;title&gt;</code> element is a contrivance put in this page to
show off a feature later in the processing chain.  Be glad it's not the
dreaded <code>&lt;blink&gt;</code> tag!</p>

<p><a name="XSP_out" /></a><a href="#weather1_flow.png" name="weather1_flow_XSP_out.png"> 
  <img src="/pub/2002/04/16/graphics/weather1_flow_XSP_out.png"
 alt="My::WeatherTaglib's position in the weather1.xsp processing  pipeline" name="weather1_flow_XSP_out.png" border="0" align="right" /></a> 
</p>
<p>The XML document that is outputted from the XSP processor and fed to the
first XSLT processor looks like (taglib output in <b>bold</b>):</p>

<pre><code>
    &lt;?xml version="1.0" encoding="UTF-8"?&gt;
    &lt;data&gt;
      &lt;title&gt;&lt;a name="title"/&gt;My weather report&lt;/title&gt;
      &lt;time&gt;<b>16:11:55</b>&lt;/time&gt;
      &lt;weather&gt;
        <b>&lt;state&gt;PA&lt;/state&gt;
        &lt;heat&gt;N/A&lt;/heat&gt;
        &lt;page&gt;/search/search?where=15206&lt;/page&gt;
        &lt;wind&gt;From the Southwest at 10&lt;/wind&gt;
        &lt;city&gt;Pittsburgh&lt;/city&gt;
        &lt;temp&gt;76&lt;/temp&gt;
        &lt;cond&gt;Sunny&lt;/cond&gt;
        &lt;uv&gt;2&lt;/uv&gt;
        &lt;visb&gt;Unlimited&lt;/visb&gt;
        &lt;url&gt;http://www.weather.com/search/search?where=15206&lt;/url&gt;
        &lt;dewp&gt;53&lt;/dewp&gt;
        &lt;zip&gt;15206&lt;/zip&gt;
        &lt;baro&gt;29.75&lt;/baro&gt;
        &lt;pic&gt;http://image.weather.com/web/common/wxicons/52/26.gif&lt;/pic&gt;
        &lt;humi&gt;31&lt;/humi&gt;</b>
      &lt;/weather&gt;
    &lt;/data&gt;
</code></pre>

<p>This data is largely presentation-neutral&#8212;kindly overlook the
U.S. centric temperature scale&#8212;it can be styled as needed.</p>

<blockquote>To generate this intermediate document, just commenting out all but
the first <code>&lt;?xml-stylesheet ... ?&gt;</code> processing instruction and
request the page like so:
<pre><code>
    $ <b>lynx -source localhost:8080/02/weather1.xsp?zip=15206 | xmllint --format -</b>
</code></pre>

<p><code>xmllint</code> is installed with the GNOMDE <code>libxsml</code>
library used by various parts of AxKit.</p>

<p>When we cover how to build pipelines in more dynamic ways than using these
stodgy old xml-stylesheet PIs, those techniques can be used to
allow intermediate documents to be shown by varying the request URI.</p>
</blockquote>

<h4>
<a name="weather.xsl"></a><a href="#weather1_flow.png" name="weather1_flow_weather_xsl.png">
<img src="/pub/2002/04/16/graphics/weather1_flow_weather_xsl.png" alt="My::WeatherTaglib's position in the weather1.xsp processing pipeline"
 border="0" align="right"/></a>

<code>weather.xsl</code>: Converting Data to Content</h4><br />

<p>Here's how we can convert the data document emitted by the XSP
processor into more human-readable text.  As described <a href="#mimicry">above</a>, we're taking a two-step approach to simulate
a "real-world" scenario of turning our data into chunks of content in
one (reusable) step and then laying the HTML out in a second step.</p>

<p><code>weather.xsl</code> is an XSLT stylesheet that uses several
templates to convert the XSP output in to something more readable:</p>

<pre><code>
    &lt;xsl:stylesheet 
      version="1.0"
      xmlns:xsl="http://www.w3.org/1999/XSL/Transform"
    &gt;
    
    &lt;xsl:template match="<b>/data/time</b>"&gt;
      <b>&lt;time&gt;Hi! It's &lt;xsl:value-of select="/data/time" /&gt;&lt;/time&gt;</b>
    &lt;/xsl:template&gt;
    
    &lt;xsl:template match="<b>/data/weather</b>"&gt;
      <b>&lt;weather&gt;The weather in
        &lt;xsl:value-of select="/data/weather/city" /&gt;,
        &lt;xsl:value-of select="/data/weather/state"/&gt; is
        &lt;xsl:value-of select="/data/weather/cond" /&gt; and
        &lt;xsl:value-of select="/data/weather/temp" /&gt;F
        (courtesy of &lt;a href="{/data/weather/url}"&gt;The
        Weather Channel&lt;/a&gt;).
      &lt;/weather&gt;</b>
    &lt;/xsl:template&gt;
    
    &lt;xsl:template match="@*|node()"&gt;
      &lt;!-- Copy the rest of the doc verbatim --&gt;
      &lt;xsl:copy&gt;
        &lt;xsl:apply-templates select="@*|node()"/&gt;
      &lt;/xsl:copy&gt;
    &lt;/xsl:template&gt;
    
    &lt;/xsl:stylesheet&gt;
</code></pre>

<p> <a href="#weather1_flow.png" name="weather1_flow_XSLT1.png"><img src="/pub/2002/04/16/graphics/weather1_flow_XSLT1.png" alt="My::WeatherTaglib's position in the weather1.xsp processing pipeline" border="0" align="right" /></a> 
  This is applied by the first XSLT processor in the pipeline. </p>
<p>The interesting thing here is that we are using <i>two</i> templates
(shown in bold) to process different bits of the source XML.  These
templates "blurbify" the time and weather data in to presentable chunks
and, as a side-effect, throw away unused data from the weather report.</p>

<p>The third template just passes the rest through (XSLT has some
annoying qualities, one of which is that it takes a complex bit of code
to simple pass things through "as is").  However, this is
boilerplate&8212;right from the XSLT specification, in fact&8212;and
need not interfere with designers creating the two templates we actually
want in this stylesheet.</p>

<blockquote>Another annoying quality is that XSLT contructs look
visually similar to the templates themselves.  This violates the
language design principle "different things should look different,"
which is used in Perl and many other languages.  This can be ameliorated
by using an XSLT-aware editor or syntax hilighting to make the
differences between XSLT statements and "payload" XML
clear.</blockquote>

<p><a name="XSLT1_out" /></a><a href="#weather1_flow.png" name="weather1_flow_XSLT1_out.png"> 
  <img src="/pub/2002/04/16/graphics/weather1_flow_XSLT1_out.png"alt="My::WeatherTaglib's position in the weather1.xsp processing pipeline" border="0" align="right" /></a> 
  The output from the first XSLT processor looks like (template output in <b>bold</b>):</p>

<pre><code>
    &lt;?xml version="1.0"?&gt;
    &lt;data&gt;
      &lt;title&gt;&lt;a name="title"/&gt;My weather report&lt;/title&gt;
      <b>&lt;time&gt;Hi! It's 16:50:36&lt;/time&gt;</b>
      <b>&lt;weather&gt;The weather in
        Pittsburgh,
        PA is
        Sunny and
        76F
        (courtesy of &lt;a href="http://www.weather.com/search/search?where=15206"&gt;The
        Weather Channel&lt;/a&gt;)
      &lt;/weather&gt;</b>
    &lt;/data&gt;
</code></pre>

<p>Now we have a set of chunks that can be placed on a Web page.  This
technique can be used to build sidebars, newspaper headlines, abstracts,
contact lists, navigation cues, links, menus, etc., in a reusable
fashion.</p>

<a name="as_html.xsl"></a>
<h4>
<a href="#weather1_flow.png" name="weather1_flow_as_html_xsl.png">
<img src="/pub/2002/04/16/graphics/weather1_flow_as_html_xsl.png" alt="My::WeatherTaglib's position in the weather1.xsp processing pipeline" border="0" align="right" /></a>
<code>as_html.xsl</code>: Laying out the page
</h4><br />

<p>The final step in this example is to insert the chunks we've built
into a page of HTML using the <code>as_html.xsl</code>stylesheet:</p>

<pre><code>
    &lt;xsl:stylesheet 
        xmlns:xsl="http://www.w3.org/1999/XSL/Transform"
        version="1.0"&gt;

    &lt;xsl:output method="html" /&gt;

    &lt;xsl:template match="/"&gt;
      &lt;html&gt;
        &lt;head&gt;
          &lt;title&gt;<b>&lt;xsl:value-of select="/data/title" /&gt;</b>&lt;/title&gt;
        &lt;/head&gt;
        &lt;body&gt;
          &lt;h1&gt;<b>&lt;xsl:copy-of select="/data/title/node()"   /&gt;</b>&lt;/h1&gt;
          &lt;p &gt;<b>&lt;xsl:copy-of select="/data/time/node()"    /&gt;</b>&lt;/p&gt;
          &lt;p &gt;<b>&lt;xsl:copy-of select="/data/weather/node()" /&gt;</b>&lt;/p&gt;
        &lt;/body&gt;
      &lt;/html&gt;
    &lt;/xsl:template&gt;

    &lt;/xsl:stylesheet&gt;
</code></pre>

<p> <a name="result_doc" /></a> <a href="#weather1_flow.png" name="weather1_flow_result_doc.png"> 
  <img  src="/pub/2002/04/16/graphics/weather1_flow_result_doc.png"alt="My::WeatherTaglib's position in the weather1.xsp processing pipeline" border="0" align="right" /></a> 
  To generate the final HTML:</p>

<pre><code>
    &lt;html&gt;
    &lt;head&gt;
    &lt;meta content="text/html; charset=UTF-8" http-equiv="Content-Type"&gt;
    &lt;title&gt;<b>My weather report</b>&lt;/title&gt;
    &lt;/head&gt;
    &lt;body&gt;
    &lt;h1&gt;<b>&lt;a name="title"/&gt;My weather report</b>&lt;/h1&gt;
    &lt;p&gt;<b>Hi! It's 17:05:08</b>&lt;/p&gt;
    &lt;p&gt;<b>The weather in
        Pittsburgh,
        PA is
        Sunny and
        76F
        (courtesy of &lt;a href="http://www.weather.com/search/search?where=15206"&gt;The
        Weather Channel&lt;/a&gt;).</b>
    &lt;/p&gt;
    &lt;/body&gt;
    &lt;/html&gt;
</code></pre>


<p>Using the <code>/data/title</code> from the data document in two
places in the result document is a minor example of the benefit of
separating the original data generation from the final presentation.  In
the <code>&lt;title&gt;</code> element, we're using
<code>xsl:value-of</code>, which returns just the textual content; in
the <code>&lt;h1&gt;</code> element, we're using
<code>xsl:copy-of</code>, which copies the tags and the text.  This
allows the title to contain markup that we strip in one place and use in
another.</p>

<p>This is similar to the situation often found in real applications
where things like menus, buttons, location tell-tales ("Home &gt;&gt;
Articles &gt;&gt; Foo" and the like) and links to related pages often
occur in multiple places.  Widgets like these make ideal "chunks" that
the layout page can place as needed.</p>

<p>This is only one example of a "final rendering" stage; different
filters could be used instead to deliver different formats.  For
instance, we could use XSLT to deliver XML, XHTML, and/or plain text
versions, or we could use an AxKit-specific processor, XPathScript, to
convert to things like RTF, nroff, and miscellaneous documentation
formats that XML would otherwise have a hard time delivering.</p>

<blockquote>AxKit optimizes this two-stage XSLT processing by passing
the internal representation used by <code>libxslt</code> directly
between the two stages. This means that output from one stage goes
directly to the next stage without having to be reparsed.</blockquote>

<p> <a name="real_world" /></a></p>
<h4>Relating <code>weather1.xsp</code> to the real
world</h4>

<p>If you squint a little at the code in My::WeatherTaglib, then you can imagine 
  using a <a href="http://theoryx5.uwinnipeg.ca/CPAN/data/DBI/DBI.html">DBI</a> query instead 
  of having Geo::Weather query a remote Web site (Geo::Weather is used instead 
  of DBI in this article to keep the example code and tarball relatively simple). 
</p>
<p>Writing queries and other business logic in to taglibs has several major advantages: 
</p>
<ul>

<li>the XML taglib API puts a designer friendly face on the queries,
allowing the XSP page to be tweaked or maintained by non-Perl literate
folks with their preferred tools, hopefully getting you off the "please
tweak the query parms" critical path.</li>

<li>Since the taglib API is XML, standard XML editors will catch basic
syntax errors without needing to call in the taglib maintainer.
</li>
<li>Schema validators and XSLT tools can also be used to allow the
designers to check the higher-level syntax before pestering the taglib
maintainer.
</li>
<li>The query parameters and output can be touched up with Perl, making
the "high level" XML interface simpler and more idiot-proof.
</li>
<li>The output is XML, so other XML processors can be used to enhance
the content and style.  This allows, for instance, XSLT literate
designers to work on the presentation without needing to learn or even
see (and possibly corrupt) any Perl code or a new language (as is
required with most HTML templating solutions).
</li>
<li>It's quite difficult to accidently generate malformed XML using XSP:
a well-formed XSP usually generates well-formed output.
</li>
<li>The queries are decoupled from the source XML, so they can be
maintained without touching the XSP pages.
</li>
<li>The taglibs can be unit tested, unlike embedded code.
</li>
<li>Taglibs can be wrappers around existing modules, so the same Perl
code can be shared by both the web front end and any other scripts or
tools that need them.
</li>
<li>The plug-in nature of taglibs allows using many public and private
XSP taglibs facilities for rapid prototyping.  CPAN's <a href="http://search.cpan.org/search?mode=module&query=XSP%3A%3A">chock
full of 'em</a>.
</li>
<li>In addition to the "function" tags like the two demostrated above,
you can program "conditional" tags that control whether or not a block
of the XSP page is included; this gives you the ability to respond to
user preferences or rights, for instance.
</li>
</ul>

<p>The <a href="http://theoryx5.uwinnipeg.ca/CPAN/data/DBI/DBI.html">DBI</a>
module lets you work with almost any database ranging from <a href="http://theoryx5.uwinnipeg.ca/CPAN/data/DBD-CSV/DBD/CSV.html">comma
separated value</a> files (with SQL JOIN support no less) through MySQL,
PostgreSQL, Oracle, etc, etc., and returns Perl data structures just
crying out to be returned from a taglib function and turned in to XML.</p>

<p>For quick one-off pages and prototypes, the <a href="http://theoryx5.uwinnipeg.ca/CPAN/data/AxKit-XSP-ESQL/ESQL.html">ESQL</a>
taglib allows you to embed SQL directly in XSP pages.  This is not
recommended practice because it's not efficient enough for heavily
trafficed sites (the database connection is rebuilt each time), and
because mixing programming code in with the XML leads to some pretty
unreadable and hard-to-maintain pages, but it is good for one-off pages
and prototypes.</p>


<a name="help"></a>
<h4>Help and thanks</h4>

<p>In case of trouble, have a look at some of the <a href="/pub/a/2002/03/12/axkit.html?page=3#help">helpful resources we
listed last time</a>.</p>

<p>Thanks to Kip Hampton, Jeremy Mates and Martin Oldfield, for their thorough
reviews, though I'm sure I managed to sneak some bugs by them.  AxKit and many
of the Perl modules it uses are primarily written by Matt Sergeant with
extensive contributions from these good folks and others, so many thanks to all
contributors as well.</p>

<p class="secondary">Copyright 2002, Robert Barrie Slaymaker, Jr. All Rights Reserved. 
</p>
        </div>



    </div>
    <div class="asset-footer"></div>
</div>


                            
                            <div id="entry-1284" class="entry-asset asset hentry">
    <div class="asset-header">
        <h2 class="asset-name entry-title"><a href="/pub/2002/04/10/mod_perl.html" rel="bookmark">Installing mod_perl without superuser privileges</a></h2>
        <div class="asset-meta">
            <span class="byline">
    
                By <span class="vcard author">Stas Bekman</span> on <abbr class="published" title="2002-04-10T00:00:00-08:00">April 10, 2002 12:00 AM</abbr>
    
            </span>

            
            

        </div>
    </div>
    <div class="asset-content entry-content">

        <div class="asset-body">
            

<p>As you have seen from my previous articles, mod_perl enabled Apache
consists of two main components: Perl modules and Apache itself.
While installing Apache without root privileges is easy,
one should know how to install Perl modules in a nonsystem-wide
location. In this article, I'll demonstrate ways to complete this
task.</p>

<p>In the examples, I'll use <em>stas</em> as a username,
and <em>/home/stas</em> as the home directory for that user.</p>

<h3><a name="installing perl modules into a directory of choice">Installing Perl Modules Into a Directory of Choice</a></h3>

<p>Since without superuser permissions you aren't allowed to install
modules into system directories such as <em>/usr/lib/perl5</em>, you need to
find out how to install the modules under your home directory.  It's
easy.</p>
<p>First, you have to decide where to install the modules.  The simplest
approach is to simulate the portion of the <em>/</em> file system relevant
to Perl under your home directory.  Actually we need only two
directories:</p>
<pre><code>
  /home/stas/bin
  /home/stas/lib</code></pre>
<p>We don't have to create them, since that will be done automatically
when the first module is installed.  Ninety-nine percent of the files will go into the
<em>lib</em> directory.  Occasionally, when some module distribution comes
with Perl scripts, these will go into the <em>bin</em> directory.  This
directory will be created if it doesn't exist.</p>

<p>Let's install the <em>CGI.pm</em> package, which includes a few other
<code>CGI::*</code> modules.  As usual, download the package from the CPAN
repository, unpack it and <code>chdir</code> to the newly created directory.</p>
<p>Now do a standard <code>perl Makefile.PL</code> to prepare a <em>Makefile</em>, but
this time tell <code>MakeMaker</code> to use your Perl installation directories
instead of the defaults.</p>
<pre><code>
  % perl Makefile.PL PREFIX=/home/stas</code></pre>
<p><code>PREFIX=/home/stas</code> is the only part of the installation process
that is different from usual.  Note that if you don't like how
<code>MakeMaker</code> chooses the rest of the directories, or if you are using
an older version that requires an explicit declaration of all
the target directories, then do this:</p>
<pre><code>
  % perl Makefile.PL PREFIX=/home/stas \
    INSTALLPRIVLIB=/home/stas/lib/perl5 \
    INSTALLSCRIPT=/home/stas/bin \
    INSTALLSITELIB=/home/stas/lib/perl5/site_perl \
    INSTALLBIN=/home/stas/bin \
    INSTALLMAN1DIR=/home/stas/lib/perl5/man  \
    INSTALLMAN3DIR=/home/stas/lib/perl5/man3</code></pre>
<p>The rest is as usual:</p>
<pre><code>
  % make
  % make test
  % make install</code></pre>
<p><code>make install</code> installs all the files in the private repository.
Note that all the missing directories are created automatically, so
there is no need to create them.  Here (slightly
edited) is what it does :</p>
<pre><code>
  Installing /home/stas/lib/perl5/CGI/Cookie.pm
  Installing /home/stas/lib/perl5/CGI.pm
  Installing /home/stas/lib/perl5/man3/CGI.3
  Installing /home/stas/lib/perl5/man3/CGI::Cookie.3
  Writing /home/stas/lib/perl5/auto/CGI/.packlist
  Appending installation info to /home/stas/lib/perl5/perllocal.pod</code></pre>
<p>If you have to use the explicit target parameters, then instead of a single
<code>PREFIX</code> parameter, you will find it useful to create a file called,
for example, <em>~/.perl_dirs</em> (where <em>~</em> is <code>/home/stas</code> in our
example) containing:</p>
<pre><code>
    PREFIX=/home/stas \
    INSTALLPRIVLIB=/home/stas/lib/perl5 \
    INSTALLSCRIPT=/home/stas/bin \
    INSTALLSITELIB=/home/stas/lib/perl5/site_perl \
    INSTALLBIN=/home/stas/bin \
    INSTALLMAN1DIR=/home/stas/lib/perl5/man  \
    INSTALLMAN3DIR=/home/stas/lib/perl5/man3</code></pre>
<p>From now on, any time you want to install Perl modules locally, you
simply execute:</p>
<pre><code>
  % perl Makefile.PL `cat ~/.perl_dirs`
  % make
  % make test
  % make install</code></pre>
<p>Using this method, you can easily maintain several Perl module
repositories.  For example, you could have one for production Perl and
another for development:</p>
<pre><code>
  % perl Makefile.PL `cat ~/.perl_dirs.production`</code></pre>
<p>or</p>
<pre><code>
  % perl Makefile.PL `cat ~/.perl_dirs.develop`</code></pre>
  


<h3><a name="making your scripts find the locally installed modules">Making Your Scripts Find the Locally Installed Modules</a></h3>
<p>Perl modules are generally placed in four main directories.  To find
these directories, execute:</p>
<pre><code>
  % perl -V</code></pre>
<p>The output contains important information about your Perl
installation.  At the end you will see:</p>
<pre><code>
  Characteristics of this binary (from libperl):
  Built under linux
  Compiled at Apr  6 1999 23:34:07
  @INC:
    /usr/lib/perl5/5.00503/i386-linux
    /usr/lib/perl5/5.00503
    /usr/lib/perl5/site_perl/5.005/i386-linux
    /usr/lib/perl5/site_perl/5.005
    .</code></pre>
    
 
<p>It shows us the content of the Perl special variable <code>@INC</code>, which is
used by Perl to look for its modules.  It is equivalent to the <code>PATH</code>
environment variable in Unix shells that is used to find executable
programs.</p>

<csperl file="grab" domain="on" record="b/832" template="b/article_sidebar2.view">

<p>Notice that Perl looks for modules in the <em>.</em> directory too, which
stands for the current directory. It's the last entry in the above
output.</p>
<p>Of course, this example is from version <em>5.00503</em> of Perl installed on
my x86 architecture PC running Linux.  That's why you see
<em>i386-linux</em> and <em>5.00503</em>.  If your system runs a different version
of Perl, operating system, processor or chipset architecture, then
some of the directories will have different names.</p>
<p>I also have a perl-5.6.1 installed under <code>/usr/local/lib/</code> so when
I do:</p>
<pre><code>
  % /usr/local/bin/perl5.6.1 -V</code></pre>
<p>I see:</p>
<pre><code>
  @INC:
    /usr/local/lib/perl5/5.6.1/i586-linux
    /usr/local/lib/perl5/5.6.1
    /usr/local/lib/site_perl/5.6.1/i586-linux
    /usr/local/lib/site_perl</code></pre>
    
<table width="150" border="0" cellspacing="0" cellpadding="4" align="right">
<tr> 
<td width="150" valign="top" height="4" bgcolor="#6699cc"></td></tr> 
<tr>
<td bgcolor="#efefef">
<p class="headline" align="center">Previously in the Series
</p>
<p class="secondary">
<a href="/pub/a/2002/03/22/modperl.html">mod_perl in 30 minutes</a><br /><br />
<a href="/pub/a/2002/02/26/whatismodperl.html">Why mod_perl?</a>


</td></tr> <tr><td width="150" valign="top" height="4" bgcolor="#6699cc"> </td></tr></table>
 
<p>Note that it's still <em>Linux</em>, but the newer Perl version uses the
version of my Pentium processor (thus the <em>i586</em> and not <em>i386</em>).
This makes use of compiler optimizations for Pentium processors when
the binary Perl extensions are created.</p>
<p>All the platform specific files, such as compiled C files glued to
Perl with <code>XS</code> or <code>SWIG</code>, are supposed to go into the
<code>i386-linux</code>-like directories.</p>
<p><strong>Important:</strong> As we have installed the Perl modules into nonstandard
directories, we have to let Perl know where to look for the four
directories.  There are two ways to accomplish this:  You can 
set the <code>PERL5LIB</code> environment variable or you can modify the
<code>@INC</code> variable in your scripts.</p>
<p>Assuming that we use perl-5.00503, in our example the directories are:</p>
<pre><code>
    /home/sbekman/lib/perl5/5.00503/i386-linux
    /home/sbekman/lib/perl5/5.00503
    /home/sbekman/lib/perl5/site_perl/5.005/i386-linux
    /home/sbekman/lib/perl5/site_perl/5.005</code></pre>
<p>As mentioned before, you find the exact directories by executing
<code>perl -V</code> and replacing the global Perl installation's base
directory with your home directory.</p>
<p>Modifying <code>@INC</code> is quite easy.  The best approach is to use the
<code>lib</code> module (pragma), by adding the following snippet at the top of
any of your scripts that require the locally installed modules.</p>
<pre><code>
  use lib qw(/home/stas/lib/perl5/5.00503/
             /home/stas/lib/perl5/site_perl/5.005);</code></pre>
<p>Another way is to write code to modify <code>@INC</code> explicitly:</p>
<pre><code>
  BEGIN {
    unshift @INC,
      qw(/home/stas/lib/perl5/5.00503
         /home/stas/lib/perl5/5.00503/i386-linux
         /home/stas/lib/perl5/site_perl/5.005
         /home/stas/lib/perl5/site_perl/5.005/i386-linux);
        }</code></pre>
<p>Note that with the <code>lib</code> module we don't have to list the
corresponding architecture specific directories, since it adds them
automatically if they exist (to be exact, when <em>$dir/$archname/auto</em>
exists).</p>
<p>Also, notice that both approaches <em>prepend</em> the directories to be
searched to <code>@INC</code>.  This allows you to install a more recent module
into your local repository and Perl will use it instead of the older
one installed in the main system repository.</p>


<p>Both approaches modify the value of <code>@INC</code> at compilation time.  The
<code>lib</code> module uses the <em>BEGIN</em> block as well, but internally.</p>















<p>Now, let's assume the following scenario.  I have installed the <code>LWP</code>
package in my local repository.  Now I want to install another module
(e.g. mod_perl) that has <code>LWP</code> listed in its prerequisites list.  I
know that I have <code>LWP</code> installed, but when I run <code>perl Makefile.PL</code>
for the module I'm about to install I'm told that I don't have <code>LWP</code>
installed.</p>
<p>There is no way for Perl to know that we have some locally installed
modules.  All it does is search the directories listed in <code>@INC</code>, and
since the latter contains only the default four directories (plus the
<em>.</em> directory), it cannot find the locally installed <code>LWP</code> package.
We cannot solve this problem by adding code to modify <code>@INC</code>, but
changing the <code>PERL5LIB</code> environment variable will do the trick.  If
you are using <code>t?csh</code> for interactive work, then do this:</p>
<pre><code>
  setenv PERL5LIB /home/stas/lib/perl5/5.00503:
  /home/stas/lib/perl5/site_perl/5.005</code></pre>
<p>It should be a single line with directories separated by colons (<code>:</code>)
and no spaces.  If you are a <code>(ba)?sh</code> user, then do this:</p>
<pre><code>
  export PERL5LIB=/home/stas/lib/perl5/5.00503:
  /home/stas/lib/perl5/site_perl/5.005</code></pre>
<p>Again, make it a single line.  If you use bash, then you can use multi-line
commands by terminating split lines with a backslash (<code>\</code>), like this:</p>
<pre><code>
  export PERL5LIB=/home/stas/lib/perl5/5.00503:\
  /home/stas/lib/perl5/site_perl/5.005</code></pre>
<p>As with <code>use lib</code>, Perl automatically prepends the architecture
specific directories to <code>@INC</code> if those exist.</p>
<p>When you have done this, verify the value of the newly configured
<code>@INC</code> by executing <code>perl -V</code> as before.  You should see the
modified value of <code>@INC</code>:</p>
<pre><code>
  % perl -V

  Characteristics of this binary (from libperl): 
  Built under linux
  Compiled at Apr  6 1999 23:34:07
  %ENV:
    PERL5LIB=&quot;/home/stas/lib/perl5/5.00503:
    /home/stas/lib/perl5/site_perl/5.005&quot;
  @INC:
    /home/stas/lib/perl5/5.00503/i386-linux
    /home/stas/lib/perl5/5.00503
    /home/stas/lib/perl5/site_perl/5.005/i386-linux
    /home/stas/lib/perl5/site_perl/5.005
    /usr/lib/perl5/5.00503/i386-linux
    /usr/lib/perl5/5.00503
    /usr/lib/perl5/site_perl/5.005/i386-linux
    /usr/lib/perl5/site_perl/5.005
    .</code></pre>
<p>When everything works as you want it to, add these commands to your
<em>.tcshrc</em> or <em>.bashrc</em> file.  The next time you start a shell, the
environment will be ready for you to work with the new Perl.</p>
<p>Note that if you have a <code>PERL5LIB</code> setting, then you don't need to alter
the <code>@INC</code> value in your scripts.  But if, for example, someone else
(who doesn't have this setting in the shell) tries to execute your
scripts, then Perl will fail to find your locally installed modules. The
best example is a crontab script that <em>might</em> use a different SHELL
environment and, therefore, the <code>PERL5LIB</code> setting won't be available
to it.</p>
<p>So the best approach is to have both the <code>PERL5LIB</code> environment
variable and the explicit <code>@INC</code> extension code at the beginning of
the scripts as described above.</p>

<h3><a name="the cpan.pm shell and locally installed modules">The CPAN.pm Shell and Locally Installed Modules</a></h3>
<p>The <code>CPAN.pm</code> shell saves a great deal of time when dealing
with the installation of Perl modules and keeping them up to date.  It does
the job for us, even detecting the missing modules listed in
prerequisites, fetching and installing them.  So you may wonder
whether you can use <code>CPAN.pm</code> to maintain your local repository as
well.</p>
<p>When you start the <code>CPAN</code> interactive shell, it searches first for
the user's private configuration file and then for the system-wide
one.  When I'm logged as user <code>stas</code>, the two files on my setup are:</p>
<pre><code>
    /home/stas/.cpan/CPAN/MyConfig.pm
    /usr/lib/perl5/5.00503/CPAN/Config.pm</code></pre>
<p>If there is no <code>CPAN</code> shell configured on your system, then when you start
the shell for the first time it will ask you a dozen configuration
questions and then create the <em>Config.pm</em> file for you.</p>
<p>If you already have it system-wide configured, then you should have a
<code>/usr/lib/perl5/5.00503/CPAN/Config.pm</code>.  If you have a different
Perl version, then alter the path to use your Perl's version number when
looking up the file.  Create the directory (<code>mkdir -p</code> creates the
whole path at once) where the local configuration file will go:</p>
<pre><code>
  % mkdir -p /home/stas/.cpan/CPAN</code></pre>
<p>Now copy the system wide configuration file to your local one.</p>
<pre><code>
  % cp /usr/lib/perl5/5.00503/CPAN/Config.pm \
  /home/stas/.cpan/CPAN/MyConfig.pm</code></pre>
<p>The only thing left is to change the base directory of <em>.cpan</em> in
your local file to the one under your home directory.  On my machine, I
replace <code>/usr/src/.cpan</code> (that's where my system's <code>.cpan</code> directory
resides) with <code>/home/stas</code>.  I use Perl, of course!</p>
<pre><code>
  % perl -pi -e 's|/usr/src|/home/stas|' \
  /home/stas/.cpan/CPAN/MyConfig.pm</code></pre>
<p>Now you have the local configuration file ready, you have to tell it
what special parameters you need to pass when executing the <code>perl
Makefile.PL</code> stage.</p>
<p>Open the file in your favorite editor and replace line:</p>
<pre><code>
  'makepl_arg' =&gt; q[],</code></pre>
<p>with:</p>
<pre><code>
  'makepl_arg' =&gt; q[PREFIX=/home/stas],</code></pre>
<p>Now you've finished the configuration.  Assuming that you are logged
in as the same user you have prepared the local installation for
(<em>stas</em> in our example), start it like this:</p>
<pre><code>
  % perl -MCPAN -e shell</code></pre>
<p>From now on, any module you try to install will be installed locally.
If you need to install some system modules, then just become the superuser
and install them in the same way.  When you are logged in as the
superuser, the system-wide configuration file will be used instead of
your local one.</p>
<p>If you have used more than just the <code>PREFIX</code> variable, then modify
<em>MyConfig.pm</em> to use them.  For example, if you have used these
variables:</p>
<pre><code>
    perl Makefile.PL PREFIX=/home/stas \
    INSTALLPRIVLIB=/home/stas/lib/perl5 \
    INSTALLSCRIPT=/home/stas/bin \
    INSTALLSITELIB=/home/stas/lib/perl5/site_perl \
    INSTALLBIN=/home/stas/bin \
    INSTALLMAN1DIR=/home/stas/lib/perl5/man  \
    INSTALLMAN3DIR=/home/stas/lib/perl5/man3</code></pre>
<p>then replace <code>PREFIX=/home/stas</code> in the line:</p>
<pre><code>
  'makepl_arg' =&gt; q[PREFIX=/home/stas],</code></pre>
<p>with all the variables from above, so that the line becomes:</p>
<pre><code>
  'makepl_arg' =&gt; q[PREFIX=/home/stas \
    INSTALLPRIVLIB=/home/stas/lib/perl5 \
    INSTALLSCRIPT=/home/stas/bin \
    INSTALLSITELIB=/home/stas/lib/perl5/site_perl \
    INSTALLBIN=/home/stas/bin \
    INSTALLMAN1DIR=/home/stas/lib/perl5/man  \
    INSTALLMAN3DIR=/home/stas/lib/perl5/man3],</code></pre>
<p>If you arrange all the above parameters in one line, then you can remove
the backslashes (<code>\</code>).</p>













<h3><a name="making a local apache installation">Making a Local Apache Installation</a></h3>
<p>Just like with Perl modules, if you don't have permissions to install
files into the system area, then you have to install them locally under your
home directory.  It's almost the same as a plain installation, but you
have to run the server listening to a port number greater than 1024,
since only root processes can listen to lower-numbered ports.</p>
<p>Another important issue you have to resolve is how to add startup and
shutdown scripts to the directories used by the rest of the system
services.  You will have to ask your system administrator to assist
you with this issue.</p>
<p>To install Apache locally, all you have to do is to tell <code>.configure</code>
in the Apache source directory what target directories to use.  If you
are following the convention that I use, which makes your home
directory look like the <code>/</code> (base) directory, then the invocation
parameters would be:</p>
<pre><code>
  ./configure --prefix=/home/stas</code></pre>
<p>Apache will use the prefix for the rest of its target directories
instead of the default <code>/usr/local/apache</code>.  If you want to see what
they are, then before you proceed add the <em>--show-layout</em> option:</p>
<pre><code>
  ./configure --prefix=/home/stas --show-layout</code></pre>
<p>You might want to put all the Apache files under <code>/home/stas/apache</code>
following Apache's convention:</p>
<pre><code>
  ./configure --prefix=/home/stas/apache</code></pre>
<p>If you want to modify some or all of the names of the automatically
created directories:</p>
<pre><code>
  ./configure --prefix=/home/stas/apache \
    --sbindir=/home/stas/apache/sbin
    --sysconfdir=/home/stas/apache/etc
    --localstatedir=/home/stas/apache/var \
    --runtimedir=/home/stas/apache/var/run \
    --logfiledir=/home/stas/apache/var/logs \
    --proxycachedir=/home/stas/apache/var/proxy</code></pre>
<p>That's all!</p>
<p>Also remember that you can start the script only under a user and
group you belong to.  You must set the <code>User</code> and <code>Group</code> directives
in <em>httpd.conf</em> to appropriate values.</p>

<h3><a name="manual local mod_perl enabled apache installation">Manual Local mod_perl Enabled Apache Installation</a></h3>
<p>Now that we have learned how to install local Apache and Perl modules
separately, let's see how to install mod_perl enabled Apache in our
home directory.  It's almost as simple as doing each one separately,
but there is one wrinkle you need to know about that I'll mention at
the end of this section.</p>
<p>Let's say you have unpacked the Apache and mod_perl sources under
<em>/home/stas/src</em> and they look like this:</p>
<pre><code>
  % ls /home/stas/src
  /home/stas/src/apache_x.x.x
  /home/stas/src/mod_perl-x.xx</code></pre>
<p>where <em>x.xx</em> are the version numbers as usual.  You want the Perl
modules from the mod_perl package to be installed under
<em>/home/stas/lib/perl5</em> and the Apache files to go under
<em>/home/stas/apache</em>.  The following commands will do that for you:</p>
<pre><code>
  % perl Makefile.PL \
  PREFIX=/home/stas \
  APACHE_PREFIX=/home/stas/apache \
  APACHE_SRC=../apache_x.x.x/src \
  DO_HTTPD=1 \
  USE_APACI=1 \
  EVERYTHING=1
  % make &amp;&amp; make test &amp;&amp; make install 
  % cd ../apache_x.x.x
  % make install</code></pre>
<p>If you need some parameters to be passed to the <code>.configure</code> script,
as we saw in the previous section, then use <code>APACI_ARGS</code>.  For example:</p>
<pre><code>
  APACI_ARGS='--sbindir=/home/stas/apache/sbin, \
    --sysconfdir=/home/stas/apache/etc, \
    --localstatedir=/home/stas/apache/var, \
    --runtimedir=/home/stas/apache/var/run, \
    --logfiledir=/home/stas/apache/var/logs, \
    --proxycachedir=/home/stas/apache/var/proxy'</code></pre>
<p>Note that the above multi-line splitting will work only with <code>bash</code>,
<code>tcsh</code> users will have to list all the parameters on a single line.</p>
<p>Basically the installation is complete.  The only remaining problem is
the <code>@INC</code> variable.  This won't be correctly set if you rely on the
<code>PERL5LIB</code> environment variable unless you set it explicitly in a
startup file that is <code>require</code>'d before loading any other module
that resides in your local repository.  A much nicer approach is to
use the <code>lib</code> pragma as we saw before, but in a slightly different
way -- we use it in the startup file and it affects all the code that
will be executed under mod_perl handlers.  For example:</p>
<pre><code>
  PerlRequire /home/stas/apache/perl/startup.pl</code></pre>
<p>where <code>startup.pl</code> starts with:</p>
<pre><code>
  use lib qw(/home/stas/lib/perl5/5.00503/
             /home/stas/lib/perl5/site_perl/5.005);</code></pre>
<p>Note that you can still use the hard-coded <code>@INC</code> modifications in
the scripts themselves, but be aware that scripts modify <code>@INC</code> in
<code>BEGIN</code> blocks and mod_perl executes the <code>BEGIN</code> blocks only when it
performs script compilation.  As a result, <code>@INC</code> will be reset to
its original value after the scripts are compiled and the hard-coded
settings will be forgotten.</p>
<p>The only place you can alter the ``original'' value is during the server
configuration stage either in the startup file or by putting</p>
<pre><code>
  PerlSetEnv Perl5LIB \
  /home/stas/lib/perl5/5.00503/:/home/stas/lib/perl5/site_perl/5.005</code></pre>
<p>in <em>httpd.conf</em>, but the latter setting will be ignored if you use
the <code>PerlTaintcheck</code> setting, and I hope you do use it.</p>
<p>The remainder of the mod_perl configuration and use is just the same as if
you were installing mod_perl as a superuser.</p>

<h3><a name="local mod_perl enabled apache installation with cpan.pm">Local mod_perl Enabled Apache Installation with CPAN.pm</a></h3>
<p>Assuming that you have configured <code>CPAN.pm</code> to install Perl modules
locally as explained earlier in this article, the installation is 
simple.  Start the <code>CPAN.pm</code> shell, set the arguments to be passed to
<code>perl Makefile.PL</code> (modify the example setting to suit your needs),
and tell &lt;CPAN.pm&gt; to do the rest for you:</p>
<pre><code>
  % perl -MCPAN -eshell
  cpan&gt; o conf makepl_arg 'DO_HTTPD=1 USE_APACI=1 EVERYTHING=1 \
        PREFIX=/home/stas APACHE_PREFIX=/home/stas/apache'
  cpan&gt; install mod_perl</code></pre>
<p>When you use <code>CPAN.pm</code> for local installations, after the mod_perl
installation is complete, you must make sure that the value of
<code>makepl_arg</code> is restored to its original value.</p>
<p>The simplest way to do this is to quit the interactive shell by typing
<em>quit</em> and re-entering it. But if you insist, then here is how to make it work
without quitting the shell. You really want to skip this :)</p>
<p>If you want to continue working with <code>CPAN</code> *without* quitting the
shell, then you must:</p>

<table width="150" border="0" cellspacing="0" cellpadding="4" align="right">
<tr> 
<td width="150" valign="top" height="4" bgcolor="#6699cc"></td></tr> 
<tr>
<td bgcolor="#efefef">
<p class="headline" align="center">Previously in the Series
</p>
<p class="secondary">
<a href="/pub/a/2002/03/22/modperl.html">mod_perl in 30 minutes</a><br /><br />
<a href="/pub/a/2002/02/26/whatismodperl.html">Why mod_perl?</a>


</td></tr> <tr><td width="150" valign="top" height="4" bgcolor="#6699cc"> </td></tr></table>
<ol>
<li><strong><a name="item_remember_the_value_of_makepl_arg">remember the value of <code>makepl_arg</code></a></strong><br>

<li><strong><a name="item_change_it_to_suit_your_new_installation">change it to suit your new installation</a></strong><br>

<li><strong><a name="item_build_and_install_mod_perl">build and install mod_perl</a></strong><br>

<li><strong><a name="item_restore_it_after_completing_mod_perl_installation">restore it after completing mod_perl installation</a></strong><br>

</ol>
<p>this is quite a cumbersome task as of this writing, but I believe that
<code>CPAN.pm</code> will eventually be improved to handle this more easily.</p>
<p>So if you are still with me, then start the shell as usual:</p>
<pre><code>
  % perl -MCPAN -eshell</code></pre>
<p>First, read the value of the <code>makepl_arg</code>:</p>
<pre><code>
  cpan&gt; o conf makepl_arg</code></pre>
<pre><code>
  PREFIX=/home/stas</code></pre>
<p>It will be something like <code>PREFIX=/home/stas</code> if you configured
<code>CPAN.pm</code> to install modules locally.  Save this value:</p>
<pre><code>
  cpan&gt; o conf makepl_arg.save PREFIX=/home/stas</code></pre>
<p>Second, set a new value, to be used by the mod_perl installation
process.  (You can add parameters to this line, or remove them,
according to your needs.)</p>
<pre><code>
  cpan&gt; o conf makepl_arg 'DO_HTTPD=1 USE_APACI=1 EVERYTHING=1 \
        PREFIX=/home/stas APACHE_PREFIX=/home/stas/apache'</code></pre>
<p>Third, let &lt;CPAN.pm&gt; build and install mod_perl for you:</p>
<pre><code>
  cpan&gt; install mod_perl</code></pre>
<p>Fourth, reset the original value to <code>makepl_arg</code>.  We do this by
printing the value of the saved variable and assigning it to
<code>makepl_arg</code>.</p>
<pre><code>
  cpan&gt; o conf makepl_arg.save</code></pre>
<pre><code>
  PREFIX=/home/stas</code></pre>
<pre><code>
  cpan&gt; o conf makepl_arg PREFIX=/home/stas</code></pre>
<p>Not so neat, but a working solution.  You could have written the value
on a piece of paper instead of saving it to <code>makepl_arg.save</code>, but
you are more likely to make a mistake that way.</p>

<h3><a name="references">References</a></h3>
<ul>
<li>
The Apache site's URL: <a href="http://www.apache.org">http://www.apache.org</a>
<p></p>
<li>
The mod_perl site's URL: <a href="http://perl.apache.org">http://perl.apache.org</a>
<p></p>
<li>
CPAN is the Comprehensive Perl Archive Network. The Master site's URL
is <a href="http://cpan.org/.">http://cpan.org/.</a> CPAN is mirrored at more than 100 sites
worldwide. (http://cpan.org/SITES.html)
<p></p></ul>






        </div>



    </div>
    <div class="asset-footer"></div>
</div>


                            
                            <div id="entry-1280" class="entry-asset asset hentry">
    <div class="asset-header">
        <h2 class="asset-name entry-title"><a href="/pub/2002/04/01/exegesis4.html" rel="bookmark">Exegesis 4</a></h2>
        <div class="asset-meta">
            <span class="byline">
    
                By <span class="vcard author">Damian Conway</span> on <abbr class="published" title="2002-04-02T00:00:00-08:00">April  2, 2002 12:00 AM</abbr>
    
            </span>

            
            

        </div>
    </div>
    <div class="asset-content entry-content">

        <div class="asset-body">
            

<p><em>Editor's note: this document is out of date and remains here for historic interest.  See <a href="http://dev.perl.org/perl6/doc/design/syn/S04.html">Synopsis 4</a> for the current design information.</p>

<dl>
<dt><strong><a name="item_And_I%27d_se%2Dell_my%2Dy_so%2Doul_for_flow_of_con"><em>And I'd se-ell my-y so-oul for flow of con-tro-ol ... over Perl</em></a></strong></dt><br />
<dd>
<dl>
<dt><strong><a name="item_%2D%2D_The_Motels%2C_%22Total_Control%22_%28Perl_6">-- The Motels, "Total Control" (Perl 6 remix)</a></strong><br />

</dl>
</dl></dd>

<p>In <a href="/pub/a/2002/01/15/apo4.html">Apocalypse 4</a>, Larry explains the fundamental changes to
flow and block control in Perl 6. The changes bring fully integrated
exceptions; a powerful new switch statement; a coherent mechanism
for polymorphic matching; a greatly enhanced <code>for</code> loop;
and unification of blocks, subroutines and closures.</p>
<p>Let's dive right in.</p>


<h3><a name="now, witness the power of this fully operational control structure">"Now, Witness the Power of This Fully <em>Operational</em> Control Structure"</a></h3>

<p>We'll consider a simple interactive 
<a href="http://www.calculator.org/rpn.html">RPN calculator</a>. The real
thing would have many more operators and values, but that's not
important right now.</p>
<pre><code>
    class Err::BadData is Exception {...}
    
    module Calc;
    
    my class NoData is Exception {
        method warn(*@args) { die @args }
    }
    
    my %var;
    
    my sub get_data ($data) {
        given $data {
            when /^\d+$/    { return %var{""} = $_ }
            when 'previous' { return %var{""} // fail NoData }
            when %var       { return %var{""} = %var{$_} }
            default         { die Err::BadData : msg=&gt;&quot;Don't understand $_&quot; }
        }  
    }
    
    sub calc (str $expr, int $i) {
        our %operator is private //= (
            '*'  =&gt; { $^a * $^b },
            '/'  =&gt; { $^a / $^b },
            '~'  =&gt; { ($^a + $^b) / 2 },
        );
        
        my @stack;
        my $toknum = 1;
        for split /\s+/, $expr -&gt; $token {
            try {
                when %operator {
                    my @args = splice @stack, -2;
                    push @stack, %operator{$token}(*@args)
                }
                when '.', ';', '=' {
                    last
                }
                
                use fatal;
                push @stack, get_data($token);
                
                CATCH {
                    when Err::Reportable     { warn $!; continue }
                    when Err::BadData        { $!.fail(at=&gt;$toknum) }
                    when NoData              { push @stack, 0 }
                    when /division by zero/  { push @stack, Inf }
                }
            }
            
            NEXT { $toknum++ }
        }
        fail Err::BadData: msg=&gt;&quot;Too many operands&quot; if @stack &gt; 1;
        return %var{'$' _ $i} = pop(@stack) but true;
    }
    
    module main;
    
    for 1..Inf -&gt; $i {
        print &quot;$i&gt; &quot;;
        my $expr = &lt;&gt; err last;  
        print &quot;$i&gt; $( Calc::calc(i=&gt;$i, expr=&gt;$expr) )\n&quot;;
    }</code></pre>


<h3><a name="an exceptionally promising beginning">An Exceptionally Promising Beginning</a></h3>

<p>The calculator is going to handle internal and external errors using
Perl 6's OO exception mechanism. This means that we're going to need 
some classes for those OO exceptions to belong to.</p>
<p>To create those classes, the <code>class</code> keyword is used. For example:</p>
<pre><code>
    class Err::BadData is Exception {...}</code></pre>
    
 <table width="150" border="0" cellspacing="0" cellpadding="4" align="right">
<tr> 
<td width="150" valign="top" height="4" bgcolor="#006699"></td></tr> 
<tr>
<td bgcolor="#efefef">
<p class="headline" align="center">Related Articles
</p>
<p class="smalltext">
<a href="/pub/a/2002/01/15/apo4.html">Apocalypse 4</a><br />
<a href="/pub/a/2001/10/02/apocalypse3.html">Apocalypse 3</a><br />
<a href="/pub/a/2001/10/03/exegesis3.html">Exegesis 3</a><br />
<a href="/pub/a/2001/05/03/wall.html">Apocalypse 2</a><br />
<a href="/pub/a/2001/05/08/exegesis2.html">Exegesis 2</a>


</td></tr> <tr><td width="150" valign="top" height="4" bgcolor="#006699"> </td></tr></table>
    
<p>After this declaration, <code>Err::BadData</code> is a class name (or rather,
by analogy to "filehandle," it's a "classname"). Either way, it can
then be used as a type specifier wherever Perl 6 expects one. Unlike
Perl 5, that classname is not a bareword string: It's a genuine
first-class symbol in the program. In object-oriented terms, we
could think of a classname as a meta-object -- an object that describes
the attributes and behavior of other objects.</p>

<p>Modules and packages are also first class in Perl 6, so we can also refer
to their names directly, or take references to them, or look them up in the
appropriate symbol table.</p>

<p>Classes can take properties, just like variables and values. Generally, those properties will specify variations in the behavior of the class. For example:</p>
<pre><code>
    class B::Like::Me is interface;</code></pre>
<p>specifies that the B::Like::Me class defines a (Java-like) interface 
that any subclass must implement.</p>

<p>The <code>is Exception</code> is not, however, a standard property. Indeed, 
<code>Exception</code> is the name of another (standard, built-in) class. 
When a classname like this is used as if it were a property, 
the property it confers is inheritance. Specifically, <code>Err::BadData</code>  
is defined as inheriting from the <code>Exception</code> base class. 
In Perl 5, that would have been:</p>
<pre><code>
    # Perl 5 code
    package Err::BadData;
    use base 'Exception';</code></pre>

<p>So now class <code>Err::BadData</code>  will have all the exceptionally useful
properties of the <code>Exception</code> class.</p>

<p>Having classnames as "first class" symbols of the program
means that it's also important to be able to pre-declare them (to
avoid compile-time "no such class or module" errors). So we need a new syntax for declaring the existence of classes/modules/packages, without
actually defining their behavior.</p>
<p>To do that we write:</p>

<pre><code>
    class MyClass {...}</code></pre>
    
<p>That right. That's real, executable, Perl 6 code.</p>
<p>We're defining the class, but using the new Perl 6 "yada-yada-yada" operator in a block immediately after the classname. By using the "I'm-eventually-going-to-put-something-here-but-not-just-yet" marker, we indicate that this definition is only a stub or placeholder. In this way, we introduce the classname into the current scope without needing to provide the complete description of the class.</p>

<p>By the way, this is also the way we can declare other types of symbols
in Perl 6 without actually defining them:</p>

<pre><code>
    module Alpha {...}
    package Beta {...}
    method Gamma::delta(Gamma $self: $d1, $d2) {...}
    sub epsilon() {...}</code></pre>
    
<p>In our example, the <code>Err::BadData</code> classname is introduced in precisely that way:</p>
<pre><code>
    class Err::BadData is Exception {...}</code></pre>
<p>which means that we can refer to the class by name, even though it has not yet been completely defined.</p>
<p>In fact, in this example, <code>Err::BadData</code> is <em>never</em> completely
defined. So we'd get a fatal compile-time error: "Missing
definition for class Err::BadData." Then we'd realize we
either forgot to eventually define the class, or that we had 
really meant to write:</p>
<pre><code>
    class Err::BadData is Exception {}   # Define new exception class with
                                         # no methods or attributes
                                         # except those it inherits
                                         # See below.</code></pre>













<p><em>Editor's note: this document is out of date and remains here for historic interest.  See <a href="http://dev.perl.org/perl6/doc/design/syn/S04.html">Synopsis 4</a> for the current design information.</p>

<h3><a name="lexical exceptions">Lexical Exceptions</a></h3>
<p>Most of the implementation of the calculator is contained in the 
<code>Calc</code> module. In Perl 6, modules are specified using the <code>module</code> keyword:</p>
<pre><code>
    module Calc;</code></pre>

<p>which is similar in effect to a Perl 5:</p>
<pre><code>
    # Perl 5 code
    package Calc;
</code></pre>
<p>
Modules are not quite the same as packages in Perl 6. Most significantly, they have a different export mechanism: They export via a new, built-in, declarative mechanism (which will be described in a future Apocalypse) and the symbols they export are exported lexically by default.</p>

<p>The first thing to appear in the module is a class declaration:</p>

<pre><code>
    my class NoData is Exception {
        method warn(*@args) { die @args }
    }</code></pre>

<p>This is another class derived from <code>Exception</code>, but one that has two significant differences from the declaration of <code>class Err::BadData</code>:</p>
<ul>
<li>
The leading <code>my</code> makes it lexical in scope, and
</li>
<li>
the trailing braces give it an associated block in which
its attributes and methods can be specified.</li>
</ul>
<p>Let's look at each of those.</p>

<p><code>NoData</code> exceptions are only going to be used within the <code>Calc</code> module itself. So it's good software engineering to make them visible only within the module itself.</p>

<p>Why? Because if we ever attempt to refer to the exception class outside <code>Calc</code> (e.g. if we tried to catch such an exception in <code>main</code>), then we'll get a compile-time "No such class: NoData" error. Any such errors would indicate a flaw in our class design or implementation.</p>

<p>In Perl 6, classes are first-class constructs.
That is, like variables and subroutines, they are "tangible"
components of a program, denizens of a symbol table, able to
be referred to both symbolically and by explicit reference:</p>

<pre><code>
    $class = \Some::Previously::Defined::Class;
    
    # and later
    
    $obj = $class.new();</code></pre>
    
<p>Note that the back slash is actually optional in that first line, just
as it would be for an array or hash in the same position.</p>

<p>"First class" also means that classnames live in a symbol table. So it follows that they can be defined to live in the current <em>lexical</em> symbol table (i.e. <code>%MY::</code>),  by placing a <code>my</code> before them.</p>

<p>A lexical class or module is only accessible in the lexical scope
in which it's declared. Of course, like Perl 5 packages, Perl 6 classes and modules don't usually <em>have</em> an explicit lexical scope associated with their
declaration. They are implicitly associated with the surrounding lexical scope (which is normally a file scope).</p>

<p>But we can give them their own lexical scope to preside over by adding a block at the end of their declaration:</p>
<pre><code>
    class Whatever {
        # definition here
    }</code></pre>
<p>This turns out to be important. Without the ability to specify a lexical scope over which the class has effect, we would be stuck with no way to embed a "nested" lexical class:</p>
<pre><code>
    class Outer;
    # class Outer's namespace
    
    my class Inner;
    
    # From this line to the end of the file 
    # is now in class Inner's namespace</code></pre>
<p>In Perl 6, we avoid this problem by writing:</p>
<pre><code>
    class Outer;
    # class Outer's namespace
    
    my class Inner {
        # class Inner's namespace
    }
    
    # class Outer's namespace again</code></pre>
    
<p>In our example, we use this new feature to redefine <code>NoData</code>'s <code>warn</code>
method (upgrading it to a call to <code>die</code>). Of course, we could also have done that with just:</p>
<pre><code>
    my class NoData is Exception;       # Open NoData's namespace
    method warn(*@args) { die @args }   # Defined in NoData's namespace</code></pre>
    
<p>but then we would have needed to "reopen" the <code>Calc</code> module's namespace afterward:</p>
<pre><code>
    module Calc;                        # Open Calc's namespace
    
    my class NoData is Exception;       # Open NoData's (nested) namespace
    method warn(*@args) { die @args }   # Defined in NoData's namespace
    
    module Calc;                        # Back to Calc's namespace</code></pre>
    
<p>Being able to "nest" the <code>NoData</code> namespace:</p>
<pre><code>
    module Calc;                            # Open Calc's namespace
    
    my class NoData is Exception {          # Open NoData's (nested) namespace
        method warn(*@args) { die @args }   # Defined in NoData's namespace
    }
    
    # The rest of module Calc defined here.</code></pre>
<p>is much cleaner.</p>
<p>By the way, because classes can now have an associated block, they can even be anonymous:</p>
<pre><code>
    $anon_class = class { 
        # definition here
    };
    
    # and later
    
    $obj = $anon_class.new();</code></pre>
<p>which is a handy way of implementing "singleton" objects:</p>
<pre><code>
    my $allocator = class { 
                        my $.count = &quot;ID_000001&quot;;
                        method next_ID { $.count++ }
                    }.new;
                    
    # and later...
    
    for @objects {
        $_.set_id( $allocator.next_ID );
    }</code></pre>


<h3><a name="maintaining your state">Maintaining Your State</a></h3>

<p>To store the values of any variables used by the calculator, we'll use a
single hash, with each key being a variable name:</p>
<pre><code>
    my %var;</code></pre>
<p>Nothing more to see here. Let's move along.</p>


<h3><a name="it's a given">It's a Given</a></h3>

<p>The <code>get_data</code> subroutine may be given a number (i.e. a literal value),
a numerical variable name (i.e. <code>'$1'</code>, <code>'$2'</code>, etc.) , or the keyword <code>'previous'</code>.</p>
<p>It then looks up the information in the <code>%var</code> hash, using a switch statement
to determine the appropriate look-up:</p>
<pre><code>
    my sub get_data ($data) {
        given $data {</code></pre>
<p>The <code>given $data</code> evaluates its first argument (in this case, <code>$data</code>) in a scalar context, and makes the result the "topic" of each subsequent
<code>when</code> inside the block associated with the <code>given</code>. (Though, just between us, that block is merely an anonymous closure acting as the <code>given</code>'s second argument -- in Perl 6 <em>all</em> blocks are merely closures that are slumming it.)</p>

<p>Note that the <code>given $data</code> statement also makes <code>$_</code> an alias for <code>$data</code>. So, for example, if the <code>when</code> specifies a pattern:</p>
<pre><code>
    when /^\d+$/  { return %var{""} = $_ }</code></pre>
    
<p>then that pattern is matched against the contents of <code>$data</code> (i.e. against the current topic).  Likewise, caching and returning <code>$_</code> when the pattern matches is the same as caching and returning <code>$data</code>.</p>

<p>After a <code>when</code>'s block has been selected and executed, control automatically passes to the end of the surrounding <code>given</code> (or, more generally, to the end of whatever block provided the <code>when</code>'s topic). That means that <code>when</code> blocks don't "fall through" in the way that <code>case</code> statements do in C.</p>

<p>You can also explicitly send control to the end of a <code>when</code>'s surrounding <code>given</code>, using a <code>break</code> statement. For example:</p>
<pre><code>
    given $number {
        when /[02468]$/ {
            if ($_ == 2) {
                warn &quot;$_ is even and prime\n&quot;;
                break;
            }           
            warn &quot;$_ is even and composite\n&quot;;
        }
        when &amp;is_prime {
            warn &quot;$_ is odd and prime\n&quot;;
        }
        warn &quot;$_ is odd and composite\n&quot;;
    }</code></pre>
<p>Alternatively, you can explicitly tell Perl not to automatically <code>break</code> at the end of the <code>when</code> block. That is, tell it to "fall through" to the statement immediately after the <code>when</code>. That's done with a <code>continue</code> statement (which is the new name for The Statement <a href="http://dev.perl.org/perl6/apocalypse/4">Formerly</a> Known As <code>skip</code>):</p>
<pre><code>
    given $number {
        when &amp;is_prime   { warn &quot;$_ is prime\n&quot;; continue; }
        when /[13579]$/  { warn &quot;$_ is odd&quot;; }
        when /[02468]$/  { warn &quot;$_ is even&quot;; }
    }</code></pre>
<p>In Perl 6, a <code>continue</code> means: "continue executing from the next statement after the current <code>when</code>, rather than jumping out of the surrounding <code>given</code>." It has nothing to do with the old Perl 5 <code>continue</code> block, which in Perl 6 becomes <a href="/pub/a{cs.r.file}?page=5#onwards and backwards"><code>NEXT</code></a>.</p>

<p>The "topic" that <code>given</code> creates can also be aliased to a name of our own choosing (though it's <em>always</em> aliased to <code>$_</code> no matter what else we may do). To give the topic a more meaningful name, we just need to use the "topical arrow:"</p>
<pre><code>
    given check_online().{active}{names}[0] -&gt; $name {
        when /^\w+$/  { print &quot;$name's on first\n&quot; }
        when /\?\?\?/    { print &quot;Who's on first\n&quot; }
    }
</code></pre>
<p>
Having been replaced by the dot, the old Perl 5 arrow operator is given a new
role in Perl 6. When placed after the topic specifier of a control structure
(i.e. the scalar argument of a <code>given</code>, or the list of a <code>for</code>), it allows us to give an extra name (apart from <code>$_</code>) to the topic associated with that control structure.</p>


<p>In the above version, the <code>given</code> statement declares a lexical variable <code>$name</code> and makes it yet another way of referring to the current topic. That is, it aliases both <code>$name</code> and <code>$_</code> to the value specified by <code>check_online().{active}{names}[0]</code>.</p>

<p>This is a fundamental change from Perl 5, where <code>$_</code> was only aliased to the current topic in a <code>for</code> loop. In Perl 6, the current topic -- whatever
its name and however you make it the topic -- is <em>always</em> aliased to <code>$_</code>.</p>

<p>That implies that everywhere that Perl 5 used <code>$_</code> as a default (i.e. <code>print</code>, <code>chomp</code>, <code>split</code>, <code>length</code>, <code>eval</code>, etc.), Perl 6 uses the current topic:</p>
<pre><code>
    for @list -&gt; $next {        # iterate @list, aliasing each element to 
                                # $next (and to $_)
        print if length &gt; 10;   # same as: print $next if length $next &gt; 10
        %count{$next}++;
    }</code></pre>
    
<p>This is subtly different from the "equivalent" Perl 5 code:</p>
<pre><code>
    # Perl 5 code
    for my $next (@list) {      # iterate @list, aliasing each element to 
                                # $next (but not to $_)
        print if length &gt; 10;   # same as: print $_ if length $_ &gt; 10
                                # using the $_ value from *outside* the loop
        %count{$next}++;
    }</code></pre>
<p>If you had wanted this Perl 5 behavior in Perl 6, then you'd have to 
say explicitly what you meant:</p>
<pre><code>
    my $outer_underscore := $_;
    for @list -&gt; $next {
        print $outer_underscore
            if length $outer_underscore &gt; 10;
        %count{$next}++;
    }</code></pre>
<p>which is probably a good thing in code that subtle.</p>
<p>Oh, and yes: the <code>p52p6</code> translator program <em>will</em> take that new
behavior into account and correctly convert something pathological like:</p>
<pre><code>
    # Perl 5 code
    while (&lt;&gt;) {
        for my $elem (@list) {
            print if $elem % 2;
        }
    }</code></pre>
<p>to:</p>
<pre><code>
    # Perl 6 code
    for &lt;&gt; {
        my $some_magic_temporary_variable := $_;
        for @list -&gt; $elem {
            print $some_magic_temporary_variable if $elem % 2;
        }
    }</code></pre>
<p>Note that this works because, in Perl 6, a call to <code>&lt;&gt;</code> is lazily evaluated in list contexts, including the list of a <code>for</code> loop.</p>













<p><em>Editor's note: this document is out of date and remains here for historic interest.  See <a href="http://dev.perl.org/perl6/doc/design/syn/S04.html">Synopsis 4</a> for the current design information.</p>

<h3><a name="other whens">Other whens</a></h3>
<p>The remaining cases of the data look-up are handled by subsequent <code>when</code> statements. The first:</p>

<pre><code>
    when 'previous' { return %var{""} // fail NoData }</code></pre>
<p>handles the special keyword <code>&quot;previous&quot;</code>. The previous value is always stored
in the element of <code>%var</code> whose key is the empty string.</p>
<p>If, however, that previous value is undefined, then the defaulting operator -- <code>//</code> -- causes the right-hand side of the expression to be evaluated instead.
That right-hand side is a call to the <code>fail</code> method of class <code>NoData</code>
(and could equally have been written <code>NoData.fail()</code>).</p>
<p>The standard <code>fail</code> method inherited from the <code>Exception</code> class constructs an instance of the appropriate class (i.e. an exception object) and then either throws that exception (if the <code>use fatal</code> pragma is in effect) or else returns an <code>undef</code> value from the scope in which the <code>fail</code> was invoked. That is, the <code>fail</code> acts like a <code>die SomeExceptionClass</code> or a <code>return undef</code>, depending on the state of the <code>use fatal</code> pragma.</p>

<p>This is possible because, in Perl 6, <em>all</em> flow-of-control -- including the normal subroutine <code>return</code> -- is exception-based. So, when it is supposed to act like a <code>return</code>, the <code>Exception::fail</code> method simply throws the special <code>Ctl::Return</code> exception, which <code>get_data</code>'s caller will (automagically) catch and treat as a normal return.</p>

<p>So then why not just write the usual:</p>
<pre><code>
    return undef;</code></pre>
<p>instead?</p>
<p>The advantage of using <code>fail</code> is that it allows the
<em>callers</em> of <code>get_data</code> to decide how that subroutine should signal failure. As explained above, normally <code>fail</code> fails by returning <code>undef</code>. But if a <code>use fatal</code> pragma is in effect, any invocation of <code>fail</code> instead throws the corresponding exception.</p>

<p>What's the advantage in that? Well, some people feel that certain types of
failures ought to be taken deadly seriously (i.e. they should kill you unless
you explicitly catch and handle them). Others feel that the same errors
really aren't all that serious and you should be allowed to, like, chill man and just groove with the heavy consequences, dude.</p>

<p>The <code>fail</code> method allows you, the coder, to stay well out of that kind of fruitless religious debate.</p>

<p>When you use <code>fail</code> to signal failure, not only is the code nicely
documented at that point, but the mode of failure becomes caller-selectable.
Fanatics can <code>use fatal</code> and make each failure punishable by death;
hippies can say <code>no fatal</code> and make each failure just return <code>undef</code>.</p>

<p>You no longer have to get caught up in endless debate as to whether the exception-catching:</p>
<pre><code>
    try { $data = get_data($str) }
        // warn &quot;Couldn't get data&quot; }</code></pre>
        
<p>is inherently better or worse than the <code>undef</code>-sensing:</p>
<pre><code>
    do { $data = get_data($str) }
        // warn &quot;Couldn't get data&quot;;</code></pre>

<p>Instead, you can just write <code>get_data</code> such that There's More Than One Way To Fail It.</p>
<p>By the way, <code>fail</code> can fail in other ways, too: in different contexts or under different pragmas. The most obvious example would be inside a regex, where it would initiate back-tracking. More on that in Apocalypse 5.</p>


<h3><a name="still other whens">Still Other Whens</a></h3>

<p>Meanwhile, if <code>$data</code> isn't a number or the <code>&quot;previous&quot;</code> keyword, then maybe it's
the name of one of the calculator's variables. The third <code>when</code> statement of the switch tests for that:</p>
<pre><code>
    when %var   { return %var{""} = %var{$_} }</code></pre>
<p>If a <code>when</code> is given a hash, then it uses the current topic as a key in the hash and looks up the corresponding entry. If that value is true, then it executes its block. In this case, that block caches the value that was looked up (i.e. <code>%var{$_}</code>) in the "previous" slot and returns it.</p>

<p>"Aha!" you say, "that's a bug! What if the value of <code>%var{$_}</code> is false?!"
Well, if it were possible for that to ever happen, then it certainly <em>would</em> be a bug, and we'd have to write something ugly:</p>

<pre><code>
    when defined %var{$_}   { return %var{""} = %var{$_} }</code></pre>
<p>But, of course, it's much easier just to redefine Truth, so that any
literal zero value stored in <code>%var</code> is no longer false. See <a href="/pub/a{cs.r.file}?page=5#cache and return">below</a>.</p>
<p>Finally, if the <code>$data</code> isn't a literal, then a <code>&quot;previous&quot;</code>, or a variable name,
it must be an invalid token, so the default alternative in the switch statement throws an <code>Err::BadData</code> exception:</p>
<pre><code>
    default     { die Err::BadData : msg=&gt;&quot;Don't understand $_&quot; }</code></pre>
<p>Note that, here again, we are actually executing a method call to:</p>
<pre><code>
    Err::BadData.die(msg=&gt;&quot;Don't understand $_&quot;);</code></pre>
<p>as indicated by the use of the colon after the classname.</p>
<p>Of course, by using <code>die</code> instead of <code>fail</code> here, we're giving clients of the <code>get_data</code> subroutine no choice but to deal with <code>Err::BadData</code> exceptions.</p>

<h3><a name="an aside: the smart match operator">An Aside: the "Smart Match" Operator</a></h3>

<p>The rules governing how the argument of a <code>when</code> is matched against the
current topic are designed to be as DWIMish as possible. Which means that
they are actually quite complex. They're listed in Apocalypse 4, so we won't review them here.</p>
<p>Collectively, the rules are designed to provide a generic "best attempt at matching" behavior. That is, given two values (the current topic and the <code>when</code>'s first argument), they try to determine whether those values can be combined to produce a "smart match" -- for some reasonable definitions of "smart" and "match."</p>
<p>That means that one possible use of a Perl 6 switch statement is simply to test <em>whether</em> two values match without worrying about <em>how</em> those two values match:</p>
<pre><code>
    sub hey_just_see_if_dey_match_willya ($val1, $val2) {
        given $val1 {
            when $val2 { return 1 }
            default    { return 0 }
        }
    }</code></pre>
<p>That behavior is sufficiently useful that Larry wanted to make it much easier
to use. Specifically, he wanted to provide a generic "smart match" operator.</p>
<p>So he did. It's called <code>=~</code>.</p>

<p>Yes, the humble Perl 5 "match a string against a regex" operator is promoted
in Perl 6 to a "smart-match an <em>anything</em> against an <em>anything</em>" operator. So now:</p>
<pre><code>
    if ($val1 =~ $val2) {...}</code></pre>
<p>works out the most appropriate way to compare its two scalar operands. The result might be a numeric comparison (<code>$val1 == $val2</code>) or a string comparison (<code>$val1 eq $val2</code>) or a subroutine call (<code>$val1.($val2)</code>)
or a pattern match (<code>$val1 =~ /$val2/</code>) or whatever else makes the most
sense for the actual run-time types of the two operands.</p>
<p>This new turbo-charged "smart match" operator will also work on arrays, hashes and lists:</p>
<pre><code>
    if @array =~ $elem {...}        # true if @array contains $elem
    
    if $key =~ %hash {...}          # true if %hash{$key}
    
    if $value =~ (1..10) {...}      # true if $value is in the list
    
    if $value =~ ('a',/\s/,7) {...} # true if $value is eq to 'a'
                                    #   or if $value contains whitespace
                                    #   or if $value is == to 7</code></pre>
<p>That final example illustrates some of the extra intelligence that Perl 6's <code>=~</code> has: When one of its arguments is a list (<em>not</em> an array), the "smart match" operator recursively "smart matches" each element
and ORs the results together, short-circuiting if possible.</p>

<h3><a name="being calculating">Being Calculating</a></h3>
<p>The next component of the program is the subroutine that computes the
actual results of each expression that the user enters. It takes a string to be evaluated and an integer indicating the current iteration number of the main input loop (for debugging purposes):</p>
<pre><code>
    sub calc (str $expr, int $count) {</code></pre>


<h3><a name="give us a little privacy, please">Give us a little privacy, please</a></h3>

<p>Perl 5 has a really ugly idiom for creating "durable" lexical variables: variables that are lexically scoped but stick around from call to call.</p>
<p>If you write:</p>
<pre><code>
    sub whatever {
        my $count if 0;
        $count++;
        print &quot;whatever called $count times\n&quot;;
    }</code></pre>
<p>then the compile-time aspect of a <code>my $count</code> declaration causes <code>$count</code> to be declared as a lexical in the subroutine block. However, at run-time
-- when the variable would normally be (re-)allocated -- the <code>if 0</code> 
prevents that process. So the original lexical variable is not 
replaced on each invocation, and is instead shared by them all.</p>

<p>This awful <code>if 0</code> idiom works under most versions of Perl 5,
	    but it's really just a freakish accident of Perl's evolution,
	    not a carefully designed and lovingly crafted feature. So 
	  <a href="http://perl.plover.com/docs/perlsub.html#warning">just say "No!"</a>.

<p>Perl 6 allows us to do the same thing, but without feeling the need to wash afterward.</p>

<p>To understand how Perl 6 cleans up this idiom, notice that the durable variable is really much more; like a package variable that just happens to be accessible only in a particular lexical scope. That kind of restricted-access package variable is going to be quite common in Perl 6 -- as an attribute of a class.</p>

<p>So the way we create such a variable is to declare it as a package variable, but with the <code>is private</code> property:</p>
<pre><code>
    module Wherever;
    
    sub whatever {
        our $count is private;
        $count++;
        print &quot;whatever called $count times\n&quot;;
    }</code></pre>
    
<p>Adding <code>is private</code> causes Perl to recognize the existence of the variable <code>$count</code> within the <code>Wherever</code> module, but then to restrict its accessibility to the lexical scope in which it is first declared. In the above example, any attempt to refer to <code>$Wherever::count</code> outside the <code>&amp;Wherever::whatever</code> subroutine produces a compile-time error. It's still a package variable, but now you can't use it anywhere but in the nominated lexical scope.</p>
<p>Apart from the benefit of replacing an ugly hack with a clean
explicit marker on the variable, the real advantage is that Perl
6 private variables can be also be initialized:</p>
<pre><code>
    sub whatever {
        our $count is private //= 1;
        print &quot;whatever called $count times\n&quot;;
        $count++;
    }</code></pre>
<p>That initialization is performed the first time the variable declaration
is encountered during execution (because that's the only time its value is <code>undef</code>, so that's the only time the <code>//=</code> operator has any effect).</p>

<p>In our example program we use that facility to do a one-time-only
initialization of a private package hash. That hash will
then be used as a (lexically restricted) look-up table to provide the implementations for a set of operator symbols:</p>
<pre><code>
        our %operator is private //= (
            '*'  =&gt; { $^a * $^b },
            '/'  =&gt; { $^a / $^b },
            '~'  =&gt; { ($^a + $^b) / 2 },
        );</code></pre>
<p>Each key of the hash is an operator symbol and the corresponding value
is an anonymous subroutine that implements the appropriate operation.
Note the use of the "place-holder" variables (<code>$^a</code> and <code>$^b</code>) to
implicitly specify the parameters of the closures.</p>
<p>Since all the data for the <code>%operator</code> hash is constant, we could have
achieved a similar effect with:</p>
<pre><code>
        my %operator is constant = (
            '*'  =&gt; { $^a * $^b },
            '/'  =&gt; { $^a / $^b },
            '~'  =&gt; { ($^a + $^b) / 2 },
        );</code></pre>
<p>Notionally this is quite different from the <code>is private</code> version, in
that -- theoretically -- the lexical constant would be reconstructed and reinitialized on each invocation of the <code>calc</code> subroutine. Although, in practice, we would expect the compiler to notice the constant initializer and optimize the initialization out to compile-time.</p>
<p>If the initializer had been a run-time expression, then the <code>is private</code>
and <code>is constant</code> versions would behave very differently:</p>
<pre><code>
    our %operator is private //= todays_ops();   # Initialize once, the first
                                                 # time statement is reached.
                                                 # Thereafter may be changed
                                                 # at will within subroutine.

    my %operator is constant = todays_ops();     # Re-initialize every time
                                                 # statement is reached.
                                                 # Thereafter constant
                                                 # within subroutine</code></pre>


<h3><a name="let's split!">Let's Split!</a></h3>

<p>We then have to split the input expression into (whitespace-delimited) tokens,
in order to parse and execute it. Since the calculator language we're 
implementing is RPN, we need a stack to store data and interim calculations:</p>
<pre><code>
    my @stack;</code></pre>
    
<p>We also need a counter to track the current token number (for error messages):</p>
<pre><code>
    my $toknum = 1;</code></pre>

<p>Then we just use the standard <code>split</code> built-in to break up the expression 
string, and iterate through each of the resulting tokens using a <code>for</code> loop:</p>
<pre><code>
    for split /\s+/, $expr -&gt; $token {</code></pre>

<p>There are several important features to note in this <code>for</code> loop. To begin with,
there are no parentheses around the list. In Perl 6, they are not required 
(they're not needed for <em>any</em> control structure), though they are certainly 
still permissible:</p>
<pre><code>
    for (split /\s+/, $expr) -&gt; $token {</code></pre>

<p>More importantly, the declaration of the iterator variable (<code>$token</code>) is no
longer to the left of the list:</p>
<pre><code>
    # Perl 5 code
    for my $token (split /\s+/, $expr) {</code></pre>

<p>Instead, it is specified via a topical arrow to the right of the list.</p>

<p>By the way, somewhat surprisingly, the Perl 6 arrow operator <em>isn't</em> a binary
operator. (Actually, neither is the Perl 5 arrow operator, but that's
not important right now.)</p>

<p>Even more surprisingly, what the Perl 6 arrow operator is, is a synonym
for the declarator <code>sub</code>. That's right, in Perl 6 you can declare an
anonymous subroutine like so:</p>
<pre><code>
    $product_plus_one = -&gt; $x, $y { $x*$y + 1 };</code></pre>

<p>The arrow behaves like an anonymous <code>sub</code> declarator:</p>
<pre><code>
    $product_plus_one = sub($x, $y) { $x*$y + 1 };</code></pre>

<p>except that its parameter list doesn't require parentheses. That implies:</p>
<ul>
<li>
The Perl 6 <code>for</code>, <code>while</code>, <code>if</code>, and <code>given</code> statements each take two arguments: an expression that controls them and a subroutine/closure that they execute. Normally, that closure is just a block (in Perl6 <em>all</em> blocks are really closures):
<pre><code>
    for 1..10 {         # no comma needed before opening brace
        print
    }</code></pre>

<p>but you can also be explicit:</p>
<pre><code>
    for 1..10, sub {    # needs comma if a regular anonymous sub
        print
    }</code></pre>

<p>or you can be pointed:</p>
<pre><code>
    for 1..10 -&gt; {      # no comma needed with arrow notation
        print
    }</code></pre>

<p>or referential:</p>
<pre><code>
    for 1..10,          # needs comma if a regular sub reference
        &amp;some_sub;</code></pre>

<p>
<ul>
<li>
The variable after the arrow is effectively a lexical variable confined to the scope of the following block (just as a subroutine parameter is a lexical variable confined to the scope of the subroutine block). Within the block, that lexical becomes an alias for the topic (just as a subroutine parameter becomes an alias for the corresponding argument).
</li>
<li>
Topic variables created with the arrow notation are, by default, read-only aliases (because Perl 6 subroutine parameters are, by default, read-only aliases):
<pre><code>
    for @list -&gt; $i {
        if ($cmd =~ 'incr') {
            $i++;   # Error: $i is read-only
        }
    }</code></pre>
<p>Note that the rule doesn't apply to the default topic (<code>$_</code>), which is given special dispensation to be a modifiable alias (as in Perl 5).</p>
</li>
<li>
If you want a named topic to be modifiable through its alias, then you have to say so explicitly:
<pre><code>
    for @list -&gt; $i is rw {
        if ($cmd =~ 'incr') {
            $i++;   # Okay: $i is read-write
        }
    }</code></pre>
</li>
<li>
Just as a subroutine can have more than one parameter, so too we can specify more than one named iterator variable at a time:
<pre><code>
    for %phonebook.kv -&gt; $name, $number {
        print &quot;$name: $number\n&quot;
    }</code></pre>

    
<p>Note that in Perl 6, a hash in a list context returns a list of pairs, not the Perl 5-ish "key, value, key, value, ..." sequence. To get the hash contents in that format, we have to call the hash's <code>kv</code> method explicitly.</p>

<p>What actually happens in this iteration (and, in fact, in all such instances) is that the <code>for</code> loop looks at the number of arguments its closure takes and iterates that many elements at a time.</p>

<p>Note that <code>map</code> and <code>reduce</code> can do that too in Perl 6:</p>
<pre><code>
    # process @xs_and_ys two-at-a-time...
    @list_of_powers = map { $^x ** $^y } @xs_and_ys;
    
    # reduce list three-at-a-time   
    $sum_of_powers  = reduce { $^partial_sum + $^x ** $^y } 0, @xs_and_ys;</code></pre>

<p>And, of course, since <code>map</code> and <code>reduce</code> take a subroutine reference as their first argument -- instead of using the higher-order placeholder notation -- we could use the arrow notation here too:</p>
<pre><code>
    @list_of_powers = map -&gt; $x, $y { $x ** $y } @xs_and_ys;</code></pre>
<p>or even an old-fashioned anonymous subroutine:</p>
<pre><code>
    @list_of_powers = map sub($x,$y){ $x ** $y }, @xs_and_ys;</code></pre>
</li></ul>

<p>Phew. If that all makes your head hurt, then don't worry. All you really need to remember is this: If you don't want to use <code>$_</code> as the name of the current topic, then you can change it by putting an arrow and a variable name before the block of most control statements.</p>













<p><em>Editor's note: this document is out of date and remains here for historic interest.  See <a href="http://dev.perl.org/perl6/doc/design/syn/S04.html">Synopsis 4</a> for the current design information.</p>

<h3><a name="a trying situation">A Trying Situation</a></h3>

<p>Once the calculator's input has been split into tokens, the <code>for</code> loop processes each one in turn, by applying them (if they represent an operator), or jumping out of the loop (if they represent an end-of-expression marker: <code>'.'</code>, <code>';'</code>, or <code>'='</code>), or pushing them onto the stack (since anything else must be an operand):</p>
<pre><code>
    try {
        when %operator {                # apply operator
            my @args = splice @stack, -2;
            push @stack, %operator{$token}(*@args);
        }
        
        when '.', ';', '=' {           # or jump out of loop
            last;
        }
        
        use fatal;
        push @stack, get_data($token);  # or push operand</code></pre>

<p>The first two possibilities are tested for using <code>when</code> statements. Recall that a <code>when</code> tests its first argument against the current topic. In this case, however, the token was made the topic by the surrounding <code>for</code>. This is a significant feature of Perl 6: <code>when</code> blocks can implement a switch statement <em>anywhere</em> there is a valid topic, not just inside a <code>given</code>.</p>

<p>The block associated with <code>when %operator</code> will be selected if <code>%operator{$token}</code> is true (i.e. if there is an operator implementation in <code>%operator</code> corresponding to the current topic). In that case, the top two arguments are spliced from the stack and passed to the closure implementing that operation (<code>%operator{$token}(*@args)</code>). Note that there would normally be a dot (<code>.</code>) operator between the hash entry (i.e. a subroutine reference) and the subroutine call, like so:</p>
<pre><code>
    %operator{$token}.(*@args)</code></pre>
    
<p>but in Perl 6 it may be omitted since it can be inferred (just as an inferrable <code>-&gt;</code> can be omitted in Perl 5).</p>

<p>Note too that we used the flattening operator <code>(C&lt;*&gt;) </code>on <code>C&lt;@args></code>,
        because the closure returned by <code>C&lt;%operator{$token}&gt;</code> expects two
	    scalar arguments, not one array.</p>

<p>The second <code>when</code> simply exits the loop if it finds an "end-of-expression" token. In this example, the argument of the <code>when</code> is a list of strings, so the <code>when</code> succeeds if any of them matches the token.</p>

<p>Of course, since the entire body of the <code>when</code> block is a single statement, we could also have written the <code>when</code> as a statement modifier:</p>
<pre><code>
        last when '.', ';', '=';</code></pre>
        
<p>The fact that <code>when</code> has a postfix version like this should come as no surprise, since <code>when</code> is simply another control structure like <code>if</code>, <code>for</code>, <code>while</code>, etc.</p>
<p>The postfix version of <code>when</code> does have one interesting feature. Since it governs a statement, rather than a block, it does not provide the block-<code>when</code>'s automatic "<code>break</code> to the end of my topicalizing block" behavior. In this instance, it makes no difference since the <code>last</code> would do that anyway.</p>
<p>The final alternative -- pushing the token onto the stack -- is simply a regular Perl <code>push</code> command. The only interesting feature is that it calls the <a href="/pub/a{cs.r.file}?page=2#it's a given"><code>get_data</code></a> subroutine to pre-translate the token if necessary. It also specifies a <code>use fatal</code> so that <code>get_data</code> will fail by an throwing exception, rather than returning <code>undef</code>.</p>

<p>The loop tries each of these possibilities in turn. And "tries" is the operative word here, because either the application of operations or the pushing of data onto the stack may fail, resulting in an exception. To prevent that exception from propagating all the way back to the main program and terminating it, the various alternatives are placed in a <code>try</code> block.</p>

<p>A <code>try</code> block is the Perl 6 successor to Perl 5's <code>eval</code> block.
Unless it includes some explicit error handling code (see <a href="#where's the catch">Where's the catch???</a>), it acts exactly like a Perl 5 <code>eval {...}</code>, intercepting a propagating exception and converting it to an <code>undef</code> return value:</p>
<pre><code>
    try { $quotient = $numerator / $denominator } // warn &quot;couldn't divide&quot;;</code></pre>


<h3><a name="where's the catch">Where's the Catch???</a></h3>

<p>In Perl 6, we aren't limited to just blindly catching a propagating exception and then coping with an <code>undef</code>. It is also possible to set up an explicit handler to catch, identify and deal with various types of exceptions. That's done in a <code>CATCH</code> block:</p>
<pre><code>
    CATCH {
        when Err::Reportable     { warn $!; continue }
        when Err::BadData        { $!.fail(at=&gt;$toknum) }
        when NoData              { push @stack, 0 }
        when /division by zero/  { push @stack, Inf }
    }</code></pre>
<p>A <code>CATCH</code> block is like a <code>BEGIN</code> block (hence the capitalization). Its one argument is a closure that is executed if an exception ever propagates as far as the block in which the <code>CATCH</code> was declared. If the block eventually executes, then the current topic is aliased to the error variable <code>$!</code>. So the typical thing to do is to populate the exception handler's closure with a series of <code>when</code> statements that identify the exception contained in <code>$!</code> and handle the error appropriately. More on that <a href="#catch as catch can">in a moment</a>.</p>
<p>The <code>CATCH</code> block has one additional property. When its closure has executed, it transfers control to the end of the block in which it was defined. This means that exception handling in Perl 6 is non-resumptive: once an exception is handled, control passes outward, and the code that threw the exception is not automatically re-executed.</p>
<p>If we did want "try, try, try again" exception handling instead, then we'd need to explicitly code a loop around the code we're trying:</p>
<pre><code>
    # generate exceptions (sometimes)
    sub getnum_or_die {
        given &lt;&gt; {                      # readline and make it the topic
            die &quot;$_ is not a number&quot;
                unless defined &amp;&amp; /^\d+$/;
            return $_;
        }
    }</code></pre>
<pre><code>
    # non-resumptive exception handling
    sub readnum_or_cry {
        return getnum_or_die;       # maybe generate an exception
        CATCH { warn $! }           # if so, warn and fall out of sub
    }</code></pre>
<pre><code>
    # pseudo-resumptive
    sub readnum_or_retry {
        loop {                      # loop endlessly...
            return getnum_or_die;   #   maybe generate an exception
            CATCH { warn $! }       #   if so, warn and fall out of loop
        }                           #   (i.e. loop back and try again)
    }</code></pre>
<p>Note that this isn't true resumptive exception handling. Control still passes outward -- to the end of the <code>loop</code> block. But then the <code>loop</code> reiterates, sending control back into <code>getnum_or_die</code> for another attempt.</p>


<h3><a name="catch as catch can">Catch as Catch Can</a></h3>

<p>Within the <code>CATCH</code> block, the example uses the standard Perl 6 exception handling technique: a series of <code>when</code> statements. Those <code>when</code> statements compare their arguments against the current topic. In a <code>CATCH</code> block, that topic is always aliased to the error variable <code>$!</code>, which contains a reference to the propagating exception object.</p>

<p>The first three <code>when</code> statements use a classname as their argument. When matching a classname against an object, the <code>=~</code> operator (and therefore any <code>when</code> statement) will call the object's <code>isa</code> method, passing it the classname. So the first three cases of the handler:</p>
<pre><code>
    when Err::Reportable   { warn $!; continue }
    when Err::BadData      { $!.fail(at=&gt;$toknum) }
    when NoData            { push @stack, 0 }</code></pre>
    
<p>are (almost) equivalent to:</p>
<pre><code>
    if $!.isa(Err::Reportable)  { warn $! }
    elsif $!.isa(Err::BadData)  { $!.fail(at=&gt;$toknum) }
    elsif $!.isa(NoData)        { push @stack, 0 }</code></pre>
<p>except far more readable.</p>

<p>The first <code>when</code> statement simply passes the exception object to <code>warn</code>.
Since <code>warn</code> takes a string as its argument, the exception object's stringification operator (inherited from the standard <code>Exception</code> class) is invoked and returns an appropriate diagnostic string, which is printed.
The <code>when</code> block then executes a <code>continue</code> statement, which circumvents the default "<code>break</code> out of the surrounding topicalizer block" semantics of the <code>when</code>.</p>

<p>The second <code>when</code> statement calls the propagating exception's <code>fail</code> method to cause <code>calc</code> either to return or rethrow the exception, depending on whether <code>use fatal</code> was set. In addition, it passes some extra information to the exception, namely the number of the token that caused the problem.</p>

<p>The third <code>when</code> statement handles the case where there is no cached data corresponding to the calculator's <code>&quot;previous&quot;</code> keyword, by simply
pushing a zero onto the stack.</p>

<p>The final case that the handler tests for:</p>
<pre><code>
    when /division by zero/  { push @stack, Inf }</code></pre>
    
<p>uses a regex, rather than a classname. This causes the topic (i.e. the exception) to be stringified and pattern-matched against the regex. As mentioned above, by default, all exceptions stringify to their own diagnostic string. So this part of the handler simply tests whether that string includes the words "division by zero," in which case it pushes the Perl 6 infinity value onto the stack.</p>

<h3><a name="one dot only">One Dot Only</a></h3>
<p>The <code>CATCH</code> block handled bad data by calling the <code>fail</code> method of the current exception:</p>
<pre><code>
    when Err::BadData  { $!.fail(at=&gt;$toknum) }</code></pre>
<p>That's a particular instance of a far more general activity: calling a method on the current topic. Perl 6 provides a shortcut for that -- the prefix unary dot operator. Unary dot calls the method that is its single operand, using the current topic as the implicit invocant. So the <code>Err::BadData</code> handler could have been written:</p>
<pre><code>
    when Err::BadData  { .fail(at=&gt;$toknum) }</code></pre>
    
<p>One of the main uses of unary dot is to allow <code>when</code> statements to select behavior on the basis of method calls. For example:</p>
<pre><code>
    given $some_object {
        when .has_data('new') { print &quot;New data available\n&quot; }
        when .has_data('old') { print &quot;Old data still available\n&quot; }
        when .is_updating     { sleep 1 }
        when .can('die')      { .die(&quot;bad state&quot;) }    # $some_object.die(...)
        default               { die &quot;internal error&quot; } # global die
    }</code></pre>
    
<p>Unary dot is also useful within the definition of methods themselves. In a Perl 6 method, the invocant (i.e. the first argument of the method, which is a reference to the object on which the method was invoked) is always the topic, so instead of writing:</p>
<pre><code>
    method dogtag (Soldier $self) {
        print $self.rank, &quot; &quot;, $self.name, &quot;\n&quot;
            unless $self.status('covert');
    }</code></pre>
    
<p>we can just write:</p>
<pre><code>
    method dogtag (Soldier $self) {     # $self is automagically the topic
        print .rank, &quot; &quot;, .name, &quot;\n&quot;
            unless .status('covert');
    }</code></pre>
    
<p>or even just:</p>
<pre><code>
    method dogtag {                     # @_[0] is automagically the topic
        print .rank, &quot; &quot;, .name, &quot;\n&quot;
            unless .status('covert');
    }</code></pre>
    
<p>Yet another use of unary dot is as a way of abbreviating multiple accesses to hash or array elements. That is, <code>given</code> also implements the oft-coveted <code>with</code> statement. If many elements of a hash or array are to be accessed in a set of statements, then we can avoid the tedious repetition of the container name:</p>
<pre><code>
    # initialize from %options...
    
    $name  = %options{name} // %options{default_name};
    $age   = %options{age};
    $limit = max(%options{limit}, %options{rate} * %options{count});
    $count = $limit / %options{max_per_count};</code></pre>
    
<p>by making it the topic and using unary dot:</p>
<pre><code>
    # initialize from %options...
    
    given %options {
        $name  = .{name} // .{default_name};
        $age   = .{age};
        $limit = max(.{limit}, .{rate} * .{count});
        $count = $limit / .{max_per_count};
    }</code></pre>













<p><em>Editor's note: this document is out of date and remains here for historic interest.  See <a href="http://dev.perl.org/perl6/doc/design/syn/S04.html">Synopsis 4</a> for the current design information.</p>

<h3><a name="onwards and backwards">Onward and Backward</a></h3>

<p>Back in our example, after each token has been dealt with in its loop iteration, the iteration is finished. All that remains to do is increment the token number.</p>

<p>In Perl 5, that would be done in a <code>continue</code> block at the end of the loop block. In Perl 6, it's done in a <code>NEXT</code> statement <em>within</em> the loop block:</p>
<pre><code>
    NEXT { $toknum++ }</code></pre>
    
<p>Like a <code>CATCH</code>, a <code>NEXT</code> is a special-purpose <code>BEGIN</code> block that takes a closure as its single argument. The <code>NEXT</code> pushes that closure onto the end of a queue of "next-iteration" handlers, all of which are executed each time a loop reaches the end of an iteration. That is, when the loop reaches the end of its block or when it executes an explicit <code>next</code> or <code>last</code>.</p>

<p>The advantage of moving from Perl 5's external <code>continue</code> to Perl 6's internal <code>NEXT</code> is that it gives the "next-iteration" handler access to any lexical variables declared within the loop block. In addition, it allows the "next-iteration" handler to be placed anywhere in the loop that's convenient (e.g. close to the initialization it's later supposed to clean up).</p>
<p>For example, instead of having to write:</p>
<pre><code>
    # Perl 5 code
    my $in_file, $out_file;
    while (&lt;&gt;) {
        open $in_file, $_ or die;
        open $out_file, &quot;&gt; $_.out&quot; or die;
        
        # process files here (maybe next'ing out early)
    }
    continue {
        close $in_file  or die;
        close $out_file or die;
    }</code></pre>
<p>we can just write:</p>
<pre><code>
    while (&lt;&gt;) {
        my $in_file  = open $_ or die;
        my $out_file = open &quot;&gt; $_.out&quot; or die;
        NEXT {
            close $in_file  or die;
            close $out_file or die;
        }
        
        # process files here (maybe next'ing out early)
    }</code></pre>
    
<p>There's no need to declare <code>$in_file</code> and <code>$out_file</code> outside the loop,
because they don't have to be accessible outside the loop (i.e. in an external <code>continue</code>).</p>
<p>This ability to declare, access and clean up lexicals within a given scope is especially important because, in Perl 6, there is no reference counting to ensure that the filehandles close themselves automatically immediately at the end of the block. Perl 6's full incremental garbage collector <em>does</em> guarantee to eventually call the filehandle's destructors, but makes no promises about when that will happen.</p>

<p>Note that there is also a <code>LAST</code> statement, which sets up a handler that is called automatically when a block is left for the last time. For example, this:</p>
<pre><code>
    for reverse 1..10 {
        print &quot;$_...&quot; and flush;
        NEXT { sleep 1 }
        LAST { ignition() &amp;&amp; print &quot;lift-off!\n&quot; }
    }</code></pre>
<p>prints:</p>
<pre><code>
    10...9...8...7...6...5...4...3...2...1...lift-off!</code></pre>
<p>sleeping one second after each iteration (including the last one), and then calling <code>&amp;ignition</code> at the end of the countdown.</p>


<p><code>LAST</code> statements are also extremely useful in nonlooping blocks, as a way of giving the block a "destructor" with which it can clean up its state regardless of how it is exited:</p>
<pre><code>
    sub handler ($value, $was_handled is rw) {
        given $value {
            LAST { $was_handled = 1 }
            when &amp;odd { return &quot;$value is odd&quot; }
            when /0$/ { print &quot;decimal compatible&quot; }
            when /2$/ { print &quot;binary compatible&quot;; break }
            $value %= 7;
            when 1,3,5 { die &quot;odd residual&quot; }
        }
    }</code></pre>
    
<p>In the above example, no matter how the <code>given</code> block exits -- i.e. via the <code>return</code> of the first <code>when</code> block, or via the (implicit) <code>break</code> of the second <code>when</code>, or via the (explicit and redundant) <code>break</code> of the third <code>when</code>, or via the <code>&quot;odd residual&quot;</code> exception, or by falling off the end of the <code>given</code> block -- the <code>$was_handled</code> parameter is always correctly set.</p>

<p>Note that the <code>LAST</code> is essential here. It wouldn't suffice to write:</p>
<pre><code>
    sub handler ($value, $was_handled is rw) {
        given $value {
            when &amp;odd { return '$value is odd&quot; }
            when /3$/ { print &quot;ternary compatible&quot; }
            when /2$/ { print &quot;binary compatible&quot;; break }
            $value %= 7;
            when 1,3,5 { die &quot;odd residual&quot; }
        }
        $was_handled = 1;
    }</code></pre>
    
<p>because then <code>$handled</code> wouldn't be set if an exception was thrown. Of course, if that's actually the semantics you <em>wanted</em>, then you don't want <code>LAST</code> in that case.</p>


<h3><a name="why are you shouting">WHY ARE YOU SHOUTING???</a></h3>

<p>You may be wondering why <code>try</code> is in lower case but <code>CATCH</code> is in upper.
Or why <code>NEXT</code> and <code>LAST</code> blocks have those "loud" keywords.</p>

<p>The reason is simple: <code>CATCH</code>, <code>NEXT</code> and <code>LAST</code> blocks are just specialized <code>BEGIN</code> blocks that install particular types of handlers into the block in which they appear.</p>
<p>They install those handlers at compile-time so, unlike a <code>try</code> or a <code>next</code> or a <code>last</code>, they don't actually <em>do</em> anything when the run-time flow of execution reaches them. The blocks associated with them are only executed if the appropriate condition or exception is encountered within their scope. And, if that happens, then they are executed automatically, just like <code>AUTOLOAD</code>, or <code>DESTROY</code>, or <code>TIEHASH</code>, or <code>FETCH</code>, etc.</p>
<p>So Perl 6 is merely continuing the long Perl tradition of using a capitalized keyword to highlight code that is executed automatically.</p>
<p>In other words: I'M SHOUTING BECAUSE I WANT YOU TO BE AWARE THAT SOMETHING SUBTLE IS HAPPENING AT THIS POINT.</p>


<h3><a name="cache and return">Cache and Return</a></h3>
<p>Meanwhile, back in <code>calc</code>...</p>
<p>Once the loop is complete and all the tokens have been processed, the result of the calculation should be the top item on the stack. If the stack of items has more than one element left, then it's likely that the expression was wrong somehow (most probably, because there were too many original operands). So we report that:</p>
<pre><code>
    fail Err::BadData : msg=&gt;&quot;Too many operands&quot;
        if @stack &gt; 1;</code></pre>
<p>If everything is OK, then we simply pop the one remaining value off the stack and make sure it will evaluate true (even if its value is zero or <code>undef</code>) by setting its <code>true</code> property. This avoids the potential bug <a href="/pub/a{cs.r.file}?page=3#still other whens">discussed earlier</a>.</p>
<p>Finally, we record it in <code>%var</code> under the key <code>'$n'</code> (i.e. as the <em>n</em>-th result), and return it:</p>
<pre><code>
    return %var{'$' _ $i} = pop(@stack) but true;</code></pre>
<p>"But, but, but...", I hear you expostulate, "...shouldn't that be <code>pop(@stack) <b>is</b> true</code>???"</p>
<p>Once upon a time, yes. But Larry has recently decided that compile-time and run-time properties should have different keywords. Compile-time properties (i.e. those ascribed to declarations) will still be specified with the <code>is</code> keyword:</p>
<pre><code>
    class Child is interface;
    my $heart is constant = &quot;true&quot;;
    our $meeting is private;</code></pre>
<p>whereas run-time properties (i.e. those ascribed to values) will now be specified with the <code>but</code> keyword:</p>
<pre><code>
    $str = &lt;$trusted_fh&gt; but tainted(0);
    $fh = open($filename) but chomped;
    return 0 but true;</code></pre>
<p>The choice of <code>but</code> is meant to convey the fact that run-time properties will generally contradict some standard property of a value, such as its normal truth, chompedness or tainting.</p>
<p>It's also meant to keep people from writing the very natural, but very misguided:</p>
<pre><code>
    if ($x is true) {...}</code></pre>
<p>which now generates a (compile-time) error:</p>
<pre><code>
    Can't ascribe a compile-time property to the run-time value of $x.
    (Did you mean &quot;$x but true&quot; or &quot;$x =~ true&quot;?)</code></pre>


<h3><a name="the forever loop">The Forever Loop</a></h3>

<p>Once the <code>Calc</code> module has all its functionality defined, all that's required is to write the main input-process-output loop. We'll cheat a little and write it as an infinite loop, and then (in solemn Unix tradition) we'll require an EOF signal to exit.</p>

<p>The infinite loop needs to keep track of its iteration count. In Perl 5 that would be:</p>
<pre><code>
    # Perl 5 code
    for (my $i=0; 1; $i++) {</code></pre>
<p>which would translate into Perl 6 as:</p>
<pre><code>
    loop (my $i=0; 1; $i++) {</code></pre>
    
<p>since Perl 5's C-like <code>for</code> loop has been renamed <code>loop</code> in Perl 6 -- to distinguish it from the Perl-like <code>for</code> loop.</p>

<p>However, Perl 6 also allows us to create semi-infinite, lazily evaluated lists, so we can write the same loop much more cleanly as:</p>
<pre><code>
    for 0..Inf -&gt; $i {</code></pre>
<p>When <code>Inf</code> is used as the right-hand operand to <code>..</code>, it signifies that the resulting list must be lazily built, and endlessly iterable. This type of loop will probably be common in Perl 6 as an easy way of providing a loop counter.</p>

<p>If we need to iterate some list of values, as well as tracking a loop counter, then we can take advantage of another new feature of Perl 6: iteration streams.</p>

<p>A regular Perl 6 <code>for</code> loop iterates a single stream of values, aliasing the current topic to each in turn:</p>
<pre><code>
    for @stream -&gt; $topic_from_stream {
        ...
    }</code></pre>
<p>But it's also possible to specify two (or more) streams of values that the one <code>for</code> loop will step through <em>in parallel</em>:</p>
<pre><code>
    for @stream1 ; @stream2 -&gt; $topic_from_stream1 ; $topic_from_stream2 {
        ...
    }</code></pre>
<p>Each stream of values is separated by a semicolon, and each topic variable is similarly separated. The <code>for</code> loop iterates both streams in parallel, aliasing the next element of the first stream (<code>@stream1</code>) to the first topic (<code>$topic_from_stream1</code>) and the next element of the second stream (<code>@stream2</code>) to the second topic (<code>$topic_from_stream2</code>).</p>
<p>The commonest application of this will probably be to iterate a list and simultaneously provide an iteration counter:</p>
<pre><code>
    for @list; 0..@list.last -&gt; $next; $index {
        print &quot;Element $index is $next\n&quot;;
    }</code></pre>
<p>It may be useful to set that out slightly differently, to show the parallel nature of the iteration:</p>
<pre><code>
    for  @list ; 0..@list.last
     -&gt;  $next ; $index   {
        print &quot;Element $index is $next\n&quot;;
    }</code></pre>
<p>It's important to note that writing:</p>
<pre><code>
    for @a; @b -&gt; $x; $y {...}
    # in parallel, iterate @a one-at-a-time as $x, and @b one-at-a-time as $y</code></pre>
<p>is <em>not</em> the same as writing:</p>
<pre><code>
    for @a, @b -&gt; $x, $y {...}
    # sequentially iterate @a then @b, two-at-a-time as $x and $y</code></pre>
<p>The difference is that semicolons separate streams, while commas separate elements within a single stream.</p>
<p>If we were brave enough, then we could even combine the two:</p>
<pre><code>
    for @a1, @a2; @b -&gt; $x; $y1, $y2 {...}
    # sequentially iterate @a1 then @a2, one-at-a-time as $x
    # and, in parallel, iterate @b two-at-a-time as $y1 and $y2</code></pre>
<p>This is definitely a case where a different layout would help make the various iterations and topic bindings clearer:</p>
<pre><code>
    for @a1, @a2 ;  @b
     -&gt; $x       ;  $y1, $y2   {...}</code></pre>
<p>Note, however, that the normal way in Perl 6 to step through an array's values while tracking its indices will almost certainly be to use the array's <code>kv</code> method. That method returns a list of interleaved indices and values (much like the hash's <code>kv</code> method returns alternating keys and values):</p>
<pre><code>
    for @list.kv -&gt; $index, $next {
        print &quot;Element $index is $next\n&quot;;
    }</code></pre>













<p><em>Editor's note: this document is out of date and remains here for historic interest.  See <a href="http://dev.perl.org/perl6/doc/design/syn/S04.html">Synopsis 4</a> for the current design information.</p>

<h3><a name="read or die">Read or Die</a></h3>
<p>Having prompted for the next expression that the calculator will evaluate:</p>
<pre><code>
    print &quot;$i&gt; &quot;;</code></pre>
<p>we read in the expression and check for an EOF (which will cause the <code>&lt;&gt;</code> 
operator to return <code>undef</code>, in which case we escape the infinite loop):</p>
<pre><code>
    my $expr = &lt;&gt; err last;</code></pre>
<p>Err...<code>err</code>???</p>
<p>In <a href="/pub/a/2001/10/02/apocalypse3.html">Apocalypse 3</a>, Larry introduced the <code>//</code> operator, which is like a <code>||</code> that tests its left operand for
definedness rather than truth.</p>
<p>What he didn't mention (but which you probably guessed) was that there is also the low-precedence version of <code>//</code>. Its name is <code>err</code>:</p>
<pre><code>
          Operation         High Precedence       Low Precedence
          
         INCLUSIVE OR             ||                     or
         EXCLUSIVE OR             ~~                    xor
          DEFINED OR              //                    err</code></pre>
<p>But why call it <code>err</code>?</p>
<p>Well, the <code>//</code> operator looks like a skewed version of  <code>||</code>, so the low-precedence version should probably be a skewed version of <code>or</code>. We can't skew it visually (even Larry thought that using italics would be going a bit far), so we skew it phonetically instead: <code>or</code> -&gt; <code>err</code>.</p>
<p><code>err</code> also has the two handy mnemonic connotations:</p>
<ul>
<li>
That we're handling an <strong>err</strong>or marker (which a returned <code>undef</code> usually is)
<p></p>
<li>
That we're voicing a surprised double-take after something unexpected (which a returned <code>undef</code> often is).
<p></p></ul>
<p>Besides all that, it just seems to work well. That is, something like this:</p>
<pre><code>
    my $value = compute_value(@args)
        err die &quot;Was expecting a defined value&quot;;</code></pre>
<p>reads quite naturally in English (whether you think of <code>err</code> as an 
abbreviation of "on error...", or as a synonym for "oops...").</p>
<p>Note that <code>err</code> is a binary operator, just like <code>or</code>, and <code>xor</code>,
so there's no particular need to start it on a new line:</p>
<pre><code>
    my $value = compute_value(@args) err die &quot;Was expecting a defined value&quot;;</code></pre>
<p>In our example program, the <code>undef</code> returned by the <code>&lt;&gt;</code> operator at 
end-of-file is our signal to jump out of the main loop. To accomplish that we 
simply append <code>err last</code> to the input statement:</p>
<pre><code>
    my $expr = &lt;&gt; err last;</code></pre>
<p>Note that an <code>or last</code> wouldn't work here, as both the empty string and the 
string "0" are valid (i.e. non-terminating) inputs to the calculator.</p>


<h3><a name="just do it">Just Do It</a></h3>
<p>Then it's just a matter of calling <code>Calc::calc</code>, passing it the iteration 
number and the expression:</p>
<pre><code>
    Calc::calc(i=&gt;$i, expr=&gt;$expr)
</code></pre>
<p>
Note that we used named arguments, so passing them in the wrong order didn't 
matter.</p>

<p>We then interpolate the result back into the output string using the <code>$(...)</code> 
scalar interpolator:</p>
<pre><code>
    print &quot;$i&gt; $( Calc::calc(i=&gt;$i, expr=&gt;$expr) )\n&quot;;</code></pre>
<p>We could even simplify that a little further, by taking advatage of the fact 
that subroutine calls interpolate directly into strings in Perl 6, provided we 
use the <code>&amp;</code> prefix:</p>
<pre><code>
    print &quot;$i&gt; &amp;Calc::calc(i=&gt;$i, expr=&gt;$expr)\n&quot;;</code></pre>
<p>Either way, that's it: we're done.</p>


<h3><a name="summing up">Summing Up</a></h3>
<p>In terms of control structures, Perl 6:</p>
<ul>
<li>
provides far more support for exceptions and exception handling,
</li>
<li>
cleans up and extends the <code>for</code> loop syntax in several ways,
</li>
<li>
unifies the notions of blocks and closures and makes them interchangeable,
</li>
<li>
provides hooks for attaching various kinds of automatic handlers to a block/closure,
</li>
<li>
re-factors the concept of a switch statement into two far more general ideas: marking a value/variable as the current topic, and then doing "smart matching" against that topic.
</li></ul>
<p>These extensions and cleanups offer us far more power and control, and -- amazingly -- in most cases require far less syntax. For example, here's (almost) the same program, written in Perl 5:</p>
<pre><code>
    package Err::BadData; 
    use base 'Exception';   # which you'd have to write yourself
    
    package NoData;         # not lexical
    use base 'Exception';
    sub warn { die @_ }
    
    package Calc;
    
    my %var;
    
    sub get_data  {
        my $data = shift;
        if ($data =~ /^\d+$/)       { return $var{""} = $data }
        elsif ($data eq 'previous') { return defined $var{""}
                                                 ? $var{""}
                                                 : die NoData-&gt;new() 
                                    }
        elsif ($var{$data})         { return $var{""} = $var{$data} }
        else                        { die Err::BadData-&gt;new(
                                             {msg=&gt;&quot;Don't understand $data&quot;}
                                          )
                                     }
    }
    
    sub calc {
        my %data = @_;
        my ($i, $expr) = @data{'i', 'expr'};
        my %operator = (
            '*'  =&gt; sub { $_[0] * $_[1] },
            '/'  =&gt; sub { $_[0] / $_[1] },
            '~'  =&gt; sub { ($_[0] + $_[1]) / 2 },
        );
        
        my @stack;
        my $toknum = 1;
        LOOP: for my $token (split /\s+/, $expr) {
            defined eval {
                TRY: if ($operator{$token}) {
                    my @args = splice @stack, -2;
                    push @stack, $operator{$token}-&gt;(@args);
                    last TRY;
                }
                last LOOP if $token eq '.' || $token eq ';' || $token eq '=';

                push @stack, get_data($token);
            } || do {
                if ($@-&gt;isa(Err::Reportable))     { warn $@; }
                if ($@-&gt;isa(Err::BadData))        { $@-&gt;{at} = $i; die $@ }
                elsif ($@-&gt;isa(NoData))           { push @stack, 0     }
                elsif ($@ =~ /division by zero/)  { push @stack, ~0 }
            }
        }
        continue { $toknum++ }
        die Err::BadData-&gt;new(msg=&gt;&quot;Too many operands&quot;) if @stack &gt; 1;
        $var{'$'.$i} = $stack[-1] . ' but true';
        return 0+pop(@stack);
    }
    
    package main;
    
    for (my $i=1; 1; $i++) {
        print &quot;$i&gt; &quot;;
        defined( my $expr = &lt;&gt; ) or last;
        print &quot;$i&gt; ${\Calc::calc(i=&gt;$i, expr=&gt;$expr)}\n&quot;;
    }</code></pre>
    
<p>Hmmmmmmm. I know which version <em>I'd</em> rather maintain.</p>



        </div>



    </div>
    <div class="asset-footer"></div>
</div>




                            <div class="content-nav">
                                <a href="/pub/2002/03/">&laquo; March 2002</a> |
                                <a href="/pub/">Main Index</a> |
                                <a href="/pub/archives.html">Archives</a>
                                | <a href="/pub/2002/05/">May 2002 &raquo;</a>
                            </div>


                        </div>
                    </div>


                    <div id="beta">
    <div id="beta-inner">


    
    <div class="widget-what-is-perl widget">
    <div class="widget-content widget-content-what-is-perl">
       Visit the home of the  Perl programming language: <a href="http://www.perl.org/">Perl.org</a
    </div>
</div>
<div class="widget-find-out-more widget-archives widget">
    <div class="widget-content">
        <ul>
            <li><a href="http://www.perl.org/get.html">Download</a></li>
            <li><a href="http://perldoc.perl.org/">Documentation</a></li>
            <li><a href="http://blogs.perl.org/">Perl Bloggers</a></li>
            <li><a href="http://news.perlfoundation.org/">Foundation News</a></li>
        </ul>
    </div>
</div><div class="widget-tcpc widget">
<h3 class="widget-header">Sponsored by</h3>
    <div class="widget-content">
        <a href="http://training.perl.com/" alt="Perl Training" target="_blank"><img src="/i/tcpc.png" width="150" height="50"></a>
    </div>
</div>

<div class="widget-syndication widget">
    <div class="widget-content">
        <ul>
            <li><img src="/mt-static/images/status_icons/feed.gif" alt="Subscribe to feed" width="9" height="9" /> <a href="/pub/atom.xml">Subscribe to this website's feed</a></li>

        </ul>
    </div>
</div>
<div class="widget-archive-monthly widget-archive widget">
    <h3 class="widget-header">Monthly <a href="/pub/archives.html">Archives</a></h3>
    <div class="widget-content">
        <ul>
        
            <li><a href="/pub/2014/02/">February 2014 (1)</a></li>
        
    
        
            <li><a href="/pub/2014/01/">January 2014 (1)</a></li>
        
    
        
            <li><a href="/pub/2013/10/">October 2013 (1)</a></li>
        
    
        
            <li><a href="/pub/2013/01/">January 2013 (1)</a></li>
        
    
        
            <li><a href="/pub/2012/12/">December 2012 (1)</a></li>
        
    
        
            <li><a href="/pub/2012/11/">November 2012 (1)</a></li>
        
    
        
            <li><a href="/pub/2012/10/">October 2012 (2)</a></li>
        
    
        
            <li><a href="/pub/2012/08/">August 2012 (2)</a></li>
        
    
        
            <li><a href="/pub/2012/06/">June 2012 (11)</a></li>
        
    
        
            <li><a href="/pub/2012/05/">May 2012 (18)</a></li>
        
    
        
            <li><a href="/pub/2012/04/">April 2012 (17)</a></li>
        
    
        
            <li><a href="/pub/2012/02/">February 2012 (1)</a></li>
        
    
        
            <li><a href="/pub/2011/12/">December 2011 (1)</a></li>
        
    
        
            <li><a href="/pub/2011/09/">September 2011 (1)</a></li>
        
    
        
            <li><a href="/pub/2011/08/">August 2011 (2)</a></li>
        
    
        
            <li><a href="/pub/2011/06/">June 2011 (1)</a></li>
        
    
        
            <li><a href="/pub/2011/05/">May 2011 (3)</a></li>
        
    
        
            <li><a href="/pub/2011/04/">April 2011 (1)</a></li>
        
    
        
            <li><a href="/pub/2011/03/">March 2011 (1)</a></li>
        
    
        
            <li><a href="/pub/2011/02/">February 2011 (1)</a></li>
        
    
        
            <li><a href="/pub/2011/01/">January 2011 (1)</a></li>
        
    
        
            <li><a href="/pub/2010/11/">November 2010 (1)</a></li>
        
    
        
            <li><a href="/pub/2010/10/">October 2010 (2)</a></li>
        
    
        
            <li><a href="/pub/2010/09/">September 2010 (1)</a></li>
        
    
        
            <li><a href="/pub/2010/08/">August 2010 (3)</a></li>
        
    
        
            <li><a href="/pub/2010/07/">July 2010 (2)</a></li>
        
    
        
            <li><a href="/pub/2010/04/">April 2010 (2)</a></li>
        
    
        
            <li><a href="/pub/2010/03/">March 2010 (4)</a></li>
        
    
        
            <li><a href="/pub/2008/05/">May 2008 (1)</a></li>
        
    
        
            <li><a href="/pub/2008/04/">April 2008 (2)</a></li>
        
    
        
            <li><a href="/pub/2008/03/">March 2008 (1)</a></li>
        
    
        
            <li><a href="/pub/2008/02/">February 2008 (1)</a></li>
        
    
        
            <li><a href="/pub/2008/01/">January 2008 (1)</a></li>
        
    
        
            <li><a href="/pub/2007/12/">December 2007 (2)</a></li>
        
    
        
            <li><a href="/pub/2007/09/">September 2007 (1)</a></li>
        
    
        
            <li><a href="/pub/2007/08/">August 2007 (1)</a></li>
        
    
        
            <li><a href="/pub/2007/07/">July 2007 (1)</a></li>
        
    
        
            <li><a href="/pub/2007/06/">June 2007 (1)</a></li>
        
    
        
            <li><a href="/pub/2007/05/">May 2007 (1)</a></li>
        
    
        
            <li><a href="/pub/2007/04/">April 2007 (1)</a></li>
        
    
        
            <li><a href="/pub/2007/03/">March 2007 (1)</a></li>
        
    
        
            <li><a href="/pub/2007/02/">February 2007 (1)</a></li>
        
    
        
            <li><a href="/pub/2007/01/">January 2007 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/12/">December 2006 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/11/">November 2006 (2)</a></li>
        
    
        
            <li><a href="/pub/2006/10/">October 2006 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/09/">September 2006 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/08/">August 2006 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/07/">July 2006 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/06/">June 2006 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/05/">May 2006 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/04/">April 2006 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/03/">March 2006 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/02/">February 2006 (4)</a></li>
        
    
        
            <li><a href="/pub/2006/01/">January 2006 (4)</a></li>
        
    
        
            <li><a href="/pub/2005/12/">December 2005 (4)</a></li>
        
    
        
            <li><a href="/pub/2005/11/">November 2005 (3)</a></li>
        
    
        
            <li><a href="/pub/2005/10/">October 2005 (2)</a></li>
        
    
        
            <li><a href="/pub/2005/09/">September 2005 (2)</a></li>
        
    
        
            <li><a href="/pub/2005/08/">August 2005 (9)</a></li>
        
    
        
            <li><a href="/pub/2005/07/">July 2005 (8)</a></li>
        
    
        
            <li><a href="/pub/2005/06/">June 2005 (9)</a></li>
        
    
        
            <li><a href="/pub/2005/05/">May 2005 (8)</a></li>
        
    
        
            <li><a href="/pub/2005/04/">April 2005 (7)</a></li>
        
    
        
            <li><a href="/pub/2005/03/">March 2005 (6)</a></li>
        
    
        
            <li><a href="/pub/2005/02/">February 2005 (7)</a></li>
        
    
        
            <li><a href="/pub/2005/01/">January 2005 (6)</a></li>
        
    
        
            <li><a href="/pub/2004/12/">December 2004 (8)</a></li>
        
    
        
            <li><a href="/pub/2004/11/">November 2004 (8)</a></li>
        
    
        
            <li><a href="/pub/2004/10/">October 2004 (5)</a></li>
        
    
        
            <li><a href="/pub/2004/09/">September 2004 (9)</a></li>
        
    
        
            <li><a href="/pub/2004/08/">August 2004 (6)</a></li>
        
    
        
            <li><a href="/pub/2004/07/">July 2004 (8)</a></li>
        
    
        
            <li><a href="/pub/2004/06/">June 2004 (6)</a></li>
        
    
        
            <li><a href="/pub/2004/05/">May 2004 (7)</a></li>
        
    
        
            <li><a href="/pub/2004/04/">April 2004 (8)</a></li>
        
    
        
            <li><a href="/pub/2004/03/">March 2004 (8)</a></li>
        
    
        
            <li><a href="/pub/2004/02/">February 2004 (9)</a></li>
        
    
        
            <li><a href="/pub/2004/01/">January 2004 (7)</a></li>
        
    
        
            <li><a href="/pub/2003/12/">December 2003 (4)</a></li>
        
    
        
            <li><a href="/pub/2003/11/">November 2003 (7)</a></li>
        
    
        
            <li><a href="/pub/2003/10/">October 2003 (8)</a></li>
        
    
        
            <li><a href="/pub/2003/09/">September 2003 (6)</a></li>
        
    
        
            <li><a href="/pub/2003/08/">August 2003 (7)</a></li>
        
    
        
            <li><a href="/pub/2003/07/">July 2003 (9)</a></li>
        
    
        
            <li><a href="/pub/2003/06/">June 2003 (9)</a></li>
        
    
        
            <li><a href="/pub/2003/05/">May 2003 (8)</a></li>
        
    
        
            <li><a href="/pub/2003/04/">April 2003 (8)</a></li>
        
    
        
            <li><a href="/pub/2003/03/">March 2003 (10)</a></li>
        
    
        
            <li><a href="/pub/2003/02/">February 2003 (8)</a></li>
        
    
        
            <li><a href="/pub/2003/01/">January 2003 (8)</a></li>
        
    
        
            <li><a href="/pub/2002/12/">December 2002 (5)</a></li>
        
    
        
            <li><a href="/pub/2002/11/">November 2002 (9)</a></li>
        
    
        
            <li><a href="/pub/2002/10/">October 2002 (7)</a></li>
        
    
        
            <li><a href="/pub/2002/09/">September 2002 (11)</a></li>
        
    
        
            <li><a href="/pub/2002/08/">August 2002 (8)</a></li>
        
    
        
            <li><a href="/pub/2002/07/">July 2002 (8)</a></li>
        
    
        
            <li><a href="/pub/2002/06/">June 2002 (4)</a></li>
        
    
        
            <li><a href="/pub/2002/05/">May 2002 (6)</a></li>
        
    
        
            <li><a href="/pub/2002/04/">April 2002 (6)</a></li>
        
    
        
            <li><a href="/pub/2002/03/">March 2002 (7)</a></li>
        
    
        
            <li><a href="/pub/2002/02/">February 2002 (5)</a></li>
        
    
        
            <li><a href="/pub/2002/01/">January 2002 (8)</a></li>
        
    
        
            <li><a href="/pub/2001/12/">December 2001 (7)</a></li>
        
    
        
            <li><a href="/pub/2001/11/">November 2001 (5)</a></li>
        
    
        
            <li><a href="/pub/2001/10/">October 2001 (9)</a></li>
        
    
        
            <li><a href="/pub/2001/09/">September 2001 (7)</a></li>
        
    
        
            <li><a href="/pub/2001/08/">August 2001 (13)</a></li>
        
    
        
            <li><a href="/pub/2001/07/">July 2001 (8)</a></li>
        
    
        
            <li><a href="/pub/2001/06/">June 2001 (13)</a></li>
        
    
        
            <li><a href="/pub/2001/05/">May 2001 (11)</a></li>
        
    
        
            <li><a href="/pub/2001/04/">April 2001 (9)</a></li>
        
    
        
            <li><a href="/pub/2001/03/">March 2001 (8)</a></li>
        
    
        
            <li><a href="/pub/2001/02/">February 2001 (8)</a></li>
        
    
        
            <li><a href="/pub/2001/01/">January 2001 (8)</a></li>
        
    
        
            <li><a href="/pub/2000/12/">December 2000 (6)</a></li>
        
    
        
            <li><a href="/pub/2000/11/">November 2000 (10)</a></li>
        
    
        
            <li><a href="/pub/2000/10/">October 2000 (10)</a></li>
        
    
        
            <li><a href="/pub/2000/09/">September 2000 (2)</a></li>
        
    
        
            <li><a href="/pub/2000/08/">August 2000 (2)</a></li>
        
    
        
            <li><a href="/pub/2000/07/">July 2000 (5)</a></li>
        
    
        
            <li><a href="/pub/2000/06/">June 2000 (7)</a></li>
        
    
        
            <li><a href="/pub/2000/05/">May 2000 (7)</a></li>
        
    
        
            <li><a href="/pub/2000/04/">April 2000 (3)</a></li>
        
    
        
            <li><a href="/pub/2000/03/">March 2000 (2)</a></li>
        
    
        
            <li><a href="/pub/2000/02/">February 2000 (2)</a></li>
        
    
        
            <li><a href="/pub/2000/01/">January 2000 (2)</a></li>
        
    
        
            <li><a href="/pub/1999/12/">December 1999 (6)</a></li>
        
    
        
            <li><a href="/pub/1999/11/">November 1999 (6)</a></li>
        
    
        
            <li><a href="/pub/1999/10/">October 1999 (5)</a></li>
        
    
        
            <li><a href="/pub/1999/09/">September 1999 (4)</a></li>
        
    
        
            <li><a href="/pub/1999/08/">August 1999 (3)</a></li>
        
    
        
            <li><a href="/pub/1999/07/">July 1999 (2)</a></li>
        
    
        
            <li><a href="/pub/1999/06/">June 1999 (3)</a></li>
        
    
        
            <li><a href="/pub/1999/04/">April 1999 (1)</a></li>
        
    
        
            <li><a href="/pub/1999/03/">March 1999 (1)</a></li>
        
    
        
            <li><a href="/pub/1999/01/">January 1999 (1)</a></li>
        
    
        
            <li><a href="/pub/1998/12/">December 1998 (1)</a></li>
        
    
        
            <li><a href="/pub/1998/11/">November 1998 (1)</a></li>
        
    
        
            <li><a href="/pub/1998/07/">July 1998 (2)</a></li>
        
    
        
            <li><a href="/pub/1998/06/">June 1998 (1)</a></li>
        
    
        
            <li><a href="/pub/1998/03/">March 1998 (1)</a></li>
        
        </ul>
    </div>
</div>
        
    

<div class="widget-powered widget">
    <div class="widget-content">
        <a href="http://www.movabletype.com/"><img src="/mt-static/images/bug-pbmt-white.png" alt="Powered by Movable Type 5.13-en" width="120" height="75" /></a>
    </div>
</div>



    </div>
</div>






                </div>
            </div>


            <div id="footer">
    <div id="footer-inner">
        <div id="footer-content">
            <div class="widget-powered widget">
                <div class="widget-content">
                    Powered by <a href="http://www.movabletype.com/" rel="generator">Movable Type Pro</a>
                </div>
            </div>

            <div class="widget-creative-commons widget">
                <div class="widget-content">
                    This blog is licensed under a <a href="http://creativecommons.org/licenses/by-nc-nd/3.0/">Creative Commons License</a>.
                </div>
            </div>

        </div>
    </div>
</div>



        </div>
    </div>
</body>
</html>
