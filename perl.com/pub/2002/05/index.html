<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" id="sixapart-standard">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="generator" content="Movable Type Pro 5.13-en" />
<link rel="stylesheet" href="/pub/styles.css" type="text/css" />
<link rel="start" href="/pub/" title="Home" />
<link rel="alternate" type="application/atom+xml" title="Recent Entries" href="/pub/atom.xml" />
<script type="text/javascript" src="/pub/mt.js"></script>
<!--
<rdf:RDF xmlns="http://web.resource.org/cc/"
         xmlns:dc="http://purl.org/dc/elements/1.1/"
         xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#">
<Work rdf:about="/pub/">
<dc:title>Perl.com</dc:title>
<dc:description>news and views of the Perl programming language</dc:description>
<license rdf:resource="http://creativecommons.org/licenses/by-nc-nd/3.0/" />
</Work>
<License rdf:about="http://creativecommons.org/licenses/by-nc-nd/3.0/">
</License>
</rdf:RDF>
-->

<script type="text/javascript">

 var _gaq = _gaq || [];
 _gaq.push(['_setAccount', 'UA-50555-22']);
 _gaq.push(['_trackPageview']);

 (function() {
   var ga = document.createElement('script'); ga.type =
   'text/javascript'; ga.async = true;
   ga.src = ('https:' == document.location.protocol ? 'https://ssl' :
   'http://www') + '.google-analytics.com/ga.js';
   var s = document.getElementsByTagName('script')[0];
   s.parentNode.insertBefore(ga, s);
 })();

</script>
<script type='text/javascript' src='http://partner.googleadservices.com/gampad/google_service.js'></script>
<script type='text/javascript'>
GS_googleAddAdSenseService("ca-pub-4136420132070439");
GS_googleEnableAllServices();
</script>
<script type='text/javascript'>
GA_googleAddSlot("ca-pub-4136420132070439", "Perl_728x90");
</script>
<script type='text/javascript'>GA_googleFetchAds();</script>
    <title>Perl.com: May 2002 Archives</title>


    <link rel="prev" href="/pub/2002/04/" title="April 2002" />
    <link rel="next" href="/pub/2002/06/" title="June 2002" />

</head>
<body id="perl-com" class="mt-archive-listing mt-datebased-monthly-archive layout-wt">
    <div id="container">
        <div id="container-inner">


            <div id="header">
    <div id="header-inner">
        <div id="header-content">
        <span id="top_advert"> 
<!-- Put any landscape advert in here -->
<!-- Perl_728x90 -->
<script type='text/javascript'>
GA_googleFillSlot("Perl_728x90");
</script>
        </span> 



            <div id="header-name"><a href="/pub/" accesskey="1">Perl.com</a></div>
            <div id="header-description">news and views of the Perl programming language</div>




        </div>
    </div>
</div>



            <div id="content">
                <div id="content-inner">


                    <div id="alpha">
                        <div id="alpha-inner">


                            <h1 id="page-title" class="archive-title">May 2002 Archives</h1>





                            
                            <div id="entry-1308" class="entry-asset asset hentry">
    <div class="asset-header">
        <h2 class="asset-name entry-title"><a href="/pub/2002/05/29/mod_perl-opt.html" rel="bookmark">Improving mod_perl Sites' Performance: Part 1</a></h2>
        <div class="asset-meta">
            <span class="byline">
    
                By <span class="vcard author">Stas Bekman</span> on <abbr class="published" title="2002-05-29T00:00:00-08:00">May 29, 2002 12:00 AM</abbr>
    
            </span>

            
            

        </div>
    </div>
    <div class="asset-content entry-content">

        <div class="asset-body">
            
<!-- sidebar begins -->
<!-- don't move sidebars -->
<!-- sidebar ends -->

<p>In the next series of articles, we are going to talk about mod_perl
performance issues. We will try to look at as many aspects of the
mod_perl driven service as possible: hardware, software, Perl coding
and finally the mod_perl specific aspects.</p>

<h3><a name="the_big_picture">The Big Picture</a></h3>
<p>To make the user's Web browsing experience as painless as possible,
every effort must be made to wring the last drop of performance from
the server. There are many factors that affect Web site usability,
but speed is one of the most important. This applies to any Web server,
not just Apache, so it is important that you understand it.</p>
<p>How do we measure the speed of a server?  Since the user (and not the
computer) is the one that interacts with the Web site, one good speed
measurement is the time elapsed between the moment when one clicks on
a link or presses a <em>Submit</em> button to the moment when the resulting
page is fully rendered.</p>
<p>The requests and replies are broken into packets.  A request may be
made up of several packets; a reply may be many thousands.  Each
packet has to make its way from one machine to another, perhaps
passing through many interconnection nodes.  We must measure the time
starting from when the first packet of the request leaves our user's
machine to when the last packet of the reply arrives back there.</p>
<p>A Web server is only one of the entities the packets see along their
way.  If we follow them from browser to server and back again, then they
may travel by different routes through many different entities.
Before they are processed by your server, the packets might have to go
through proxy (accelerator) servers and, if the request contains more
than one packet, packets might arrive to the server by different
routes with different arrival times. Therefore, it's possible that some
packets that arrive earlier will have to wait for other packets before
they could be reassembled into a chunk of the request message that
will be then read by the server.  Then the whole process is repeated
in reverse.</p>

<csperl file="grab" domain="on" record="b/832" template="b/article_sidebar.view">

<p>You could work hard to fine-tune your Web server's performance, but a
slow Network Interface Card (NIC) or a slow network connection from
your server might defeat it all.  That's why it's important to think
about the big picture and to be aware of possible bottlenecks between
the server and the Web.</p>
<p>Of course, there is little that you can do if the user has a slow
connection.  You might tune your scripts and Web server to process
incoming requests quickly, so you will need only a small number
of working servers, but you might find that the server processes are
all busy waiting for slow clients to accept their responses.</p>
<p>But there are techniques to cope with this.  For example, you can
deliver the response compressed.  If you are delivering a
pure text respond, then gzip compression will sometimes reduce the size of
the respond by 10 times.</p>
<p>You should analyze all the involved components when you try to create
the best service for your users, and not the Web server or the code
that the Web server executes.  A Web service is like a car: If one of
the parts or mechanisms is broken, then the car may not operate smoothly and it
can even stop dead if pushed too far without fixing it.</p>
<p>Let me stress it again: If you want to be successful in the 
Web service business, then you should start worrying about the client's browsing
experience and <strong>not only</strong> how good your code benchmarks are.</p>

<h3><a name="operating_system_and_hardware_analysis">Operating System and Hardware Analysis</a></h3>

<!-- Stas Bekman mod_perl series -->
<table width="150" border="0" cellspacing="0" cellpadding="4" align="right">
<tr> 
<td width="150" valign="top" height="4" bgcolor="#6699cc"></td></tr> 
<tr>
<td bgcolor="#efefef">
<p class="headline" align="center">Previously in the Series
</p>
<p class="secondary">
<a href="http://perl.com/pub/a/2002/05/22/mod_perl-isp.html">Finding a mod_perl ISP... or Becoming One</a><br /><br />
<a href="http://perl.com/pub/a/2002/05/14/mod_perl.html">The Perl You Need To Know - Part 3</a><br /><br />
<a href="http://perl.com/pub/a/2002/05/07/mod_perl.html">The Perl You Need To Know - Part 2</a><br /><br />

<a href="/pub/a/2002/04/23/mod_perl.html">The Perl You Need To Know</a><br /><br />
<a href="/pub/a/2002/04/10/mod_perl.html">Installing mod_perl without superuser privileges</a><br /><br />
<a href="/pub/a/2002/03/22/modperl.html">mod_perl in 30 minutes</a><br /><br />
<a href="/pub/a/2002/02/26/whatismodperl.html">Why mod_perl?</a>

</td></tr> <tr><td width="150" valign="top" height="4" bgcolor="#6699cc"> </td></tr></table>
<!-- End Stas Sidebar -->

<p>Before you start to optimize server configuration and learn to write
more-efficient code, you need to consider the demands that will be
placed on the hardware and the operating System.  There is no point in
investing a lot of time and money in configuration tuning and code
optimizing, only to find that your server's performance is poor because
you did not choose a suitable platform in the first place.</p>
<p>Because hardware platforms and operating systems are developing
rapidly (even while you are reading this article), the following
advisory discussion must be in general terms, without mentioning
specific vendors names.</p>

<h3><a name="choosing_the_right_operating_system">Choosing the Right Operating System</a></h3>
<p>I will try to talk about what characteristics and features you should
be looking for to support a mod_perl enabled Apache server, then when
you know what you want from your OS, you can go out and find it.
Visit the Web sites of the operating systems you are interested in.
You can gauge user's opinions by searching the relevant discussions in
newsgroup and mailing list archives.  Deja - <a href="http://deja.com">http://deja.com</a> and
eGroups - <a href="http://egroups.com">http://egroups.com</a> are good examples.  I will leave this fan
research to you. But probably the best shot will be to ask mod_perl
users, as they know the best.</p>

<h4><a name="stability_and_robustness_requirements">Stability and Robustness Requirements</a></h4>
<p>Probably the most important features in an OS are stability and
robustness.  You are in the Internet business.  You do not keep normal
9 a.m. to 5 p.m. working hours like conventional businesses.
You are open 24 hours a day.  You cannot afford to be off-line, because
your customers will shop at another service (unless you
have a monopoly ...).  If the OS of your choice crashes every day, then first
conduct a little investigation.  There might be a simple reason that you
can fix.  There are OSs that won't work unless you reboot
them twice a day.  You don't want to use this type of OS, no
matter how good the OS' vendor sales department is.  Do not follow flushy
advertisements; follow developers' advice instead.</p>
<p>Generally, people who have used the OS for some time can tell you a
lot about its stability.  Ask them.  Try to find people who are doing
similar things to what you are planning to do, they may even be using
the same software.  There are often compatibility issues to resolve.
You may need to become familiar with patching and compiling your OS.</p>

<h4><a name="good_memory_management_importance">Good Memory-Management Importance</a></h4>


<p>You want an OS with a good memory-management implementation. Some OSs
are well-known as memory hogs.  The same code can use twice as much
memory on one OS compared to another.  If the size of the mod_perl
process is 10Mb and you have tens of these running, then it definitely adds
up!</p>
<h4><a name="say_no_to_memory_leaks">Say No to Memory Leaks</a></h4>
<p>Some OSs and/or their libraries (e.g. C runtime libraries) suffer from
memory leaks.  A leak is when some process requests a chunk of memory
for temporary storage, but then does not subsequently release it.  The
chunk of memory is not then available for any purpose until the
process that requested it dies.  You cannot afford such leaks.  A
single mod_perl process sometimes serves thousands of requests before
it terminates.  So if a leak occurs on each request, then the memory
demands could become huge.  Of course, your code can be the cause of
the memory leaks as well, but it's easy to detect and solve.
Certainly, we can reduce the number of requests to be served during the
process' life, but that can degrade performance.</p>

<h4><a name="memory_sharing_capabilities_is_a_must">Memory-Sharing Capabilities Is a Must</a></h4>
<p>You want an OS with good memory-sharing capabilities.  If you preload
the Perl modules and scripts at server startup, then they are shared
between the spawned children (at least for a part of a process' life -
memory pages can become ``dirty'' and cease to be shared).  This feature
can reduce memory consumption a lot!</p>
<p>And, of course, you don't want an OS that doesn't have memory-sharing
capabilities.</p>

<h4><a name="the_real_cost_of_support">The Real Cost of Support</a></h4>
<p>If you are in a big business, then you probably do not mind paying another
$1,000 for some fancy OS with bundled support.  But if your resources
are low, then you will look for cheaper and free OSs.  Free does not mean
bad, it can be quite the opposite.  Free OSs can have the best support
you can find.  Some do.</p>
<p>It is easy to understand - most of the people are not rich and
will try to use a cheaper or free OS first if it does the work for
them.  Since it really fits their needs, many people keep using it and
eventually know it well enough to be able to provide support for
others in trouble.  Why would they do this for free?  One reason is
for the spirit of the first days of the Internet, when there was no
commercial Internet and people helped each other, because someone
helped them in first place.  I was there, I was touched by that spirit
and I'm keen to keep that spirit alive.</p>
<p>But, let's get back to the real world.  We are living in material world,
and our bosses pay us to keep the systems running.  So if you feel
that you cannot provide the support yourself and you do not trust the
available free resources, then you must pay for an OS backed by a company,
and blame them for any problem.  Your boss wants to be able to sue
someone if the project has a problem caused by the external product
that is being used in the project.  If you buy a product and the
company selling it claims support, then you have someone to sue or at least
to put the blame on.</p>
<p>If we go with open source and it fails we do not have someone to
sue ... wrong -- in the past several years, many companies have realized how good
the open-source products are and started to provide an official
support for these products.  So your boss cannot just dismiss your
suggestion of using an open-source operating system.  You can get a
paid support just like with any other commercial OS vendor.</p>
<p>Also remember that the less money you spend on OS and software, the
more you will be able to spend on faster and stronger hardware.  Of
course, for some companies money is a nonissue, but there are many
companies for which it is a <strong>big</strong> issue.</p>














<h4><a name="ouch..._discontinued_products">Ouch ... Discontinued Products</a></h4>
<p>The OSs in this hazard group tend to be developed by a single company
or organization.</p>
<p>You might find yourself in a position where you have invested a lot of
time and money into developing some proprietary software that is
bundled with the OS you chose (say writing a mod_perl handler that
takes advantage of some proprietary features of the OS and that will
not run on any other OS).  Things are under control, the performance
is great and you sing with happiness on your way to work.  Then, one
day, the company that supplies your beloved OS goes bankrupt (not
unlikely nowadays), or they produce a newer incompatible version and
they will not support the old one (happens all the time).  You are
stuck with their early masterpiece, no support and no source code!
What are you going to do?  Invest more money into porting the software
to another OS ...</p>
<p>Free and open-source OSs are probably less susceptible to this kind of
problem.  Development is usually distributed between many companies
and developers. So if a person who developed an important part
of the kernel lost interest in continuing, then someone else will pick the
falling flag and carry on.  Of course, if tomorrow some better project
shows up, then developers might migrate there and finally drop the
development. But in practice, people are often given support on older
versions and helped to migrate to current versions.  Development tends
to be more incremental than revolutionary, so upgrades are less
traumatic, and there is usually plenty of notice of the forthcoming
changes so that you have time to plan for them.</p>
<p>Of course, with open-source OSs you can have the source code!  So
you can always have a go yourself, but do not under-estimate the
amounts of work involved.  There are many, many man-years of work in
an OS.</p>

<h4><a name="keeping_up_with_os_releases">Keeping Up with OS Releases</a></h4>
<p>Actively developed OSs generally try to keep pace with the latest
technology developments, and continually optimize the kernel and other
parts of the OS to become better and faster.  Nowadays, Internet and
networking in general are the hottest topics for system developers.
Sometimes a simple OS upgrade to the latest stable version can save
you an expensive hardware upgrade.  Also, remember that when you buy
new hardware, chances are that the latest software will make the most
of it.</p>
<p>If a new product supports an old one by virtue of backward
compatibility with previous products of the same family, then you might not
reap all the benefits of the new product's features.  Perhaps you get
almost the same functionality for much less money if you were to buy
an older model of the same product.</p>

<h3><a name="choosing_the_right_hardware">Choosing the Right Hardware</a></h3>
<p>Sometimes the most expensive machine is not the one that provides the
best performance.  Your demands on the platform hardware are based on
many aspects and affect many components.  Let's discuss some of them.</p>
<p>In the discussion I use terms that may be unfamiliar to you:</p>
<ul>
<li>
<strong>Cluster</strong>: a group of machines connected together to perform one big
or many small computational tasks in a reasonable time.  Clustering
can also be used to provide 'fail-over,' where if one machine fails, then its
processes are transferred to another without interruption of service.
And you may be able to take one of the machines down for maintenance
(or an upgrade) and keep your service running -- the main server will
simply not dispatch the requests to the machine that was taken down.</li>

<li>
<strong>Load balancing</strong>: users are given the name of one of your machines
but perhaps it cannot stand the heavy load.  You can use a clustering
approach to distribute the load over a number of machines.  The
central server, which users access initially when they type the name
of your service, works as a dispatcher.  It just redirects requests to
other machines.  Sometimes the central server also collects the
results and returns them to the users.  You can get the advantages of
clustering, too.</li>

<li>
<strong>Network Interface Card</strong> (NIC): a hardware component that allows you
to connect your machine to the network. It performs packets sending and
receiving, newer cards can encrypt and decrypt packets and perform
digital signing and verifying of the such. These are coming in
different speeds categories varying from 10Mbps to 10Gbps and
faster. The most used type of the NIC card is the one that implements
the Ethernet networking protocol.</li>

<li>
<strong>Random Access Memory</strong> (RAM): It's the memory that you have in your
computer. (Comes in units of 8Mb, 16Mb, 64Mb, 256Mb, etc.)</li>

<li>
<strong>Redundant Array of Inexpensive Disks</strong> (RAID): an array of physical
disks, usually treated by the operating system as one single disk, and
often forced to appear that way by the hardware.  The reason for using
RAID is often simply to achieve a high data transfer rate, but it may
also be to get adequate disk capacity or high reliability.  Redundancy
means that the system is capable of continued operation even if a disk
fails.  There are various types of RAID array and several different
approaches to implementing them.  Some systems provide protection
against failure of more than one drive and some (`hot-swappable')
systems allow a drive to be replaced without even stopping the OS.</li>
<p></p></ul>

<h4><a name="machine_strength_demands_according_to_expected_site_traffic">Machine Strength Demands According to Expected Site Traffic</a></h4>
<p>If you are building a fan site and you want to amaze your friends with
a mod_perl guest book, then any old 486 machine could do it.  If you are in
a serious business, then it is important to build a scalable server.
If your service is successful and becomes popular, then the traffic could
double every few days, and you should be ready to add more resources
to meet demand.  While we can define the Web server
scalability more precisely, the important thing is to make sure that
you can add more power to your <code>webserver(s)</code> without investing much
additional money in software development (you will need a little
software effort to connect your servers, if you add more of them).
This means that you should choose hardware and OSs that can talk to
other machines and become a part of a cluster.</p>
<p>On the other hand, if you prepare for a lot of traffic and buy a
monster to do the work for you, then what happens if your service doesn't
prove to be as successful as you thought?  Then you've
spent too much money, and meanwhile faster processors and other
hardware components have been released; so you lose.</p>
<p>Wisdom and prophecy, that's all it takes :)</p>

<h4><a name="single_strong_machine_vs._many_weaker_machines">Single Strong Machine vs. Many Weaker Machines</a></h4>
<p>Let's start with a claim that a 4-year-old processor is still 
powerful and can be put to a good use. Now let's say that for a given
amount of money you can probably buy either one new very strong
machine or about 10 older but very cheap machines. I claim that with
10 old machines connected into a cluster and by deploying load
balancing you will be able to serve about five times more requests
than with one single new machine.</p>
<p>Why is that?  Because generally the performance improvement on a new
machine is marginal while the price is much higher.  Ten machines will
do faster disk I/O than one single machine, even if the new disk is
quite a bit faster.  Yes, you have more administration overhead, but
there is a chance you will have it anyway, for in a short time the new
machine you have just bought might not stand the load.  Then you will
have to purchase more equipment and think about how to implement load
balancing and Web server file system distribution anyway.</p>
<p>Why I am so convinced?  Look at the busiest services on the Internet:
search engines, Web/e-mail servers and the like -- most of them use a
clustering approach.  You may not always notice it, because they hide
the real implementation details behind proxy servers.</p>













<h4><a name="getting_fast_internet_connection">Getting Fast Internet Connection</a></h4>
<p>You have the best hardware you can get, but the service is still
crawling.  Make sure you have a fast Internet connection.  Not as fast
as your ISP claims it to be, but fast as it should be.  The ISP might
have a good connection to the Internet, but put many clients on
the same line.  If these are heavy clients, then your traffic will have to
share the same line and your throughput will suffer.  Think about a
dedicated connection and make sure it is truly dedicated.  Don't trust
the ISP, check it!</p>
<p>The idea of having a connection to <strong>the Internet</strong> is a little
misleading.  Many Web hosting and co-location companies have large
amounts of bandwidth, but still have poor connectivity.  The public
exchanges, such as MAE-East and MAE-West, frequently become
overloaded, yet many ISPs depend on these exchanges.</p>
<p>Private peering means that providers can exchange traffic much
quicker.</p>
<p>Also, if your Web site is of global interest, check that the ISP has
good global connectivity.  If the Web site is going to be visited
mostly by people in a certain country or region, then your server should
probably be located there.</p>
<p>Bad connectivity can directly influence your machine's performance.
Here is a story one of the developers told on the mod_perl mailing
list:</p>
<BLOCKQUOTE><p>What relationship has 10 percent packet loss on one upstream provider got to
do with machine memory ?</p>
<p>Yes ... a lot. For a nightmare week, the box was located downstream of a
provider who was struggling with some serious bandwidth problems of
his own ... people were connecting to the site via this link, and
packet loss was such that retransmits and TCP stalls were keeping
httpd heavies around for much longer than normal ... instead of blasting
out the data at high or even modem speeds, they would be stuck at
1k/sec or stalled out ...  people would press stop and refresh, httpds
would take 300 seconds to timeout on writes to no-one ... it was a
nightmare.  Those problems didn't go away till I moved the box to a
place closer to some decent backbones.</p>
<p>Note that with a proxy, this only keeps a lightweight httpd tied up,
assuming the page is small enough to fit in the buffers.  If you are a
busy Internet site, then you always have some slow clients.  This is a
difficult thing to simulate in benchmark testing, though.</p>
</BLOCKQUOTE>
<h4><a name="tuning_i/o_performance">Tuning I/O Performance</a></h4>
<p>If your service is I/O bound (does a lot of read/write operations to
disk), then you need a very fast disk, especially if the you need a
relational database, which are the main I/O stream creators.  So you
should not spend the money on video card and monitor!  A cheap card
and a 14-inch monochrome monitor are perfectly adequate for a Web server;
you will probably access it by <code>telnet</code> or <code>ssh</code> most of the time.
Look for disks with the best price/performance ratio.  Of course, ask
around and avoid disks that have a reputation for head-crashes and
other disasters.</p>
<p>You must think about RAID or similar systems if you have an enormous
data set to serve (what is an enormous data set nowadays?  Gigabytes,
terabytes?) or you expect a really big Web traffic.</p>
<p>OK, you have a fast disk, what's next?  You need a fast disk
controller.  There may be one embedded on your computer's motherboard.
If the controller is not fast enough, then you should buy a faster one.
Don't forget that it may be necessary to disable the original
controller.</p>

<h4><a name="how_much_memory_is_enough">How Much Memory Is Enough?</a></h4>
<p>How much RAM do you need?  Nowadays, chances are that you will
hear: ``Memory is cheap, the more you buy the better.''  But how much is
enough?  The answer is pretty straightforward: <em>you do not want your
machine to swap</em>.  When the CPU needs to write something into memory,
but memory is already full, it takes the least frequently used memory
pages and swaps them out to disk.  This means you have to bear the
time penalty of writing the data to disk.  If another process then
references some of the data that happens to be on one of the pages
that has just been swapped out, then the CPU swaps it back in again,
probably swapping out some other data that will be needed very shortly
by some other process.  Carried to the extreme, the CPU and disk start
to <em>thrash</em> hopelessly in circles, without getting any real work
done.  The less RAM there is, the more often this scenario arises.
Worse, you can exhaust swap space as well, and then your troubles
really start.</p>
<p>How do you make a decision?  You know the highest rate at which your
server expects to serve pages and how long it takes on average to
serve one.  Now you can calculate how many server processes you need.
If you know the maximum size your servers can grow to, then you know how
much memory you need.  If your OS supports memory sharing, then you can
make best use of this feature by preloading the modules and scripts at
server startup, and so you will need less memory than you have
calculated.</p>
<p>Do not forget that other essential system processes need memory as
well, so you should plan not only for the Web server, but also take
into account the other players.  Remember that requests can be queued,
so you can afford to let your client wait for a few moments until a
server is available to serve it.  Most of the time your server will
not have the maximum load, but you should be ready to bear the peaks.
You need to reserve at least 20 percent of free memory for peak situations.
Many sites have crashed a few moments after a big scoop about them was
posted and an unexpected number of requests suddenly came in.  (Like
Slashdot effect.) If you are about to announce something cool, then be
aware of the possible consequences.</p>

<h4><a name="getting_a_faulttolerant_cpu">Getting a Fault-Tolerant CPU</a></h4>
<p>Make sure that the CPU is operating within its specifications.  Many
boxes are shipped with incorrect settings for CPU clock speed, power
supply voltage, etc.  Sometimes a cooling fan is not fitted.  It may be
ineffective because a cable assembly fouls the fan blades.  Like
faulty RAM, an overheating processor can cause all kinds of strange
and unpredictable things to happen.  Some CPUs are known to have bugs
that can be serious in certain circumstances.  Try not to get one of
them.</p>

<!-- Stas Bekman mod_perl series -->
<table width="150" border="0" cellspacing="0" cellpadding="4" align="right">
<tr> 
<td width="150" valign="top" height="4" bgcolor="#6699cc"></td></tr> 
<tr>
<td bgcolor="#efefef">
<p class="headline" align="center">Previously in the Series
</p>
<p class="secondary">
<a href="http://perl.com/pub/a/2002/05/22/mod_perl-isp.html">Finding a mod_perl ISP... or Becoming One</a><br /><br />
<a href="http://perl.com/pub/a/2002/05/14/mod_perl.html">The Perl You Need To Know - Part 3</a><br /><br />
<a href="http://perl.com/pub/a/2002/05/07/mod_perl.html">The Perl You Need To Know - Part 2</a><br /><br />

<a href="/pub/a/2002/04/23/mod_perl.html">The Perl You Need To Know</a><br /><br />
<a href="/pub/a/2002/04/10/mod_perl.html">Installing mod_perl without superuser privileges</a><br /><br />
<a href="/pub/a/2002/03/22/modperl.html">mod_perl in 30 minutes</a><br /><br />
<a href="/pub/a/2002/02/26/whatismodperl.html">Why mod_perl?</a>

</td></tr> <tr><td width="150" valign="top" height="4" bgcolor="#6699cc"> </td></tr></table>
<!-- End Stas Sidebar -->


<h4><a name="detecting_and_avoiding_bottlenecks">Detecting and Avoiding Bottlenecks</a></h4>
<p>You might use the most expensive components, but still get bad
performance.  Why?  Let me introduce an annoying word: bottleneck.</p>
<p>A machine is an aggregate of many components.  Almost any one of them
may become a bottleneck.</p>
<p>If you have a fast processor but a small amount of RAM, then the RAM will
probably be the bottleneck.  The processor will be under-utilized,
usually it will be waiting for the kernel to swap the memory pages in
and out, because memory is too small to hold the busiest pages.</p>
<p>If you have a lot of memory, a fast processor, a fast disk, but a slow
disk controller, then the disk controller will be the bottleneck.  The
performance will still be bad, and you will have wasted money.</p>
<p>A slow NIC can cause a bottleneck as well and make the whole service
run slow.  This is a most important component, since Web servers
are much more often network-bound than they are disk-bound
(i.e. having more network traffic than disk utilization)</p>

<h4><a name="solving_hardware_requirement_conflicts">Solving Hardware Requirement Conflicts</a></h4>
<p>It may happen that the combination of software components that you
find yourself using gives rise to conflicting requirements for the
optimization of tuning parameters.  If you can separate the components
onto different machines, then you may find that this approach (a kind of
clustering) solves the problem, at much less cost than buying faster
hardware, because you can tune the machines individually to suit the
tasks they should perform.</p>
<p>For example, if you need to run a relational database engine and
mod_perl server, then it can be wise to put the two on different machines,
since while RDBMS need a very fast disk, mod_perl processes need lots
of memory. So by placing the two on different machines it's easy to
optimize each machine at separate and satisfy the each software
components requirements in the best way.</p>

<hr />
<h1><a name="references">References</a></h1>
<ul>
<li>
The mod_perl site's URL: <a href="http://perl.apache.org">http://perl.apache.org</a></li>

<li>
For more information about RAID see the Disk-HOWTO, Module-HOWTO and
Parallel-Processing-HOWTO available from the Linux Documentation
Project and its mirrors (http://www.linuxdoc.org/docs.html#howto)</li>

<li>
For more information about clusters and high availability setups, see:</li>

<p><a href="http://linux-ha.org/">High-Availability Linux Project</a> -- the
definitive guide to load balancing techniques</p>

<p>Linux Virtual Server Project
( <a href="http://www.linuxvirtualserver.org/">http://www.linuxvirtualserver.org/</a> )</p>
<p>mod_backhand -- Load Balancing for Apache
( <a href="http://www.backhand.org/mod_backhand/">http://www.backhand.org/mod_backhand/</a> )</p>
<p>mod_redundancy -- Redundancy/Failover solution
( <a href="http://www.ask-the-guru.com">http://www.ask-the-guru.com</a> )</p>
<p>lbnamed - a Load Balancing Name Server Written in Perl
( <a href="http://www.stanford.edu/~riepel/lbnamed/">http://www.stanford.edu/~riepel/lbnamed/</a>
<a href="http://www.stanford.edu/~riepel/lbnamed/bof.talk/">http://www.stanford.edu/~riepel/lbnamed/bof.talk/</a>
<a href="http://www.stanford.edu/~schemers/docs/lbnamed/lbnamed.html">http://www.stanford.edu/~schemers/docs/lbnamed/lbnamed.html</a> )</p>
<p></p></ul>




        </div>



    </div>
    <div class="asset-footer"></div>
</div>


                            
                            <div id="entry-1306" class="entry-asset asset hentry">
    <div class="asset-header">
        <h2 class="asset-name entry-title"><a href="/pub/2002/05/29/closure.html" rel="bookmark">Achieving Closure</a></h2>
        <div class="asset-meta">
            <span class="byline">
    
                By <span class="vcard author">Simon Cozens</span> on <abbr class="published" title="2002-05-29T00:00:00-08:00">May 29, 2002 12:00 AM</abbr>
    
            </span>

            
            

        </div>
    </div>
    <div class="asset-content entry-content">

        <div class="asset-body">
            <p>Maybe you've heard about closures; they're one of those aspects of Perl -- like object-oriented programming -- that everyone raves about and you
can't really see the big deal until you play around with them and then
they just click. In this article, we're going to play around with some
closures, in the hope that they'll just click for you.</p>
<p>The nice thing about playing around with closures is that you often
don't realize you're doing it. Don't believe me? OK, here's an ordinary
piece of Perl:</p>
<pre><code>
    my $print_hello = sub { print &quot;Hello, world!&quot;; }

    $print_hello-&gt;();</code></pre>
<p>We create a subroutine reference in <code>$print_hello</code>, and then we
dereference it, calling the subroutine. I suppose we could put that into a
subroutine:</p>
<pre><code>
    sub make_hello_printer {
        return sub { print &quot;Hello, world!&quot;; }
    }

    my $print_hello = make_hello_printer();
    $print_hello-&gt;()</code></pre>
<p>Still nothing magical going on here. And it shouldn't be any surprise to
you that we can move the "message" to a separate variable, like this:</p>
<pre><code>
    sub make_hello_printer {
        my $message = &quot;Hello, world!&quot;;
        return sub { print $message; }
    }

    my $print_hello = make_hello_printer();
    $print_hello-&gt;()</code></pre>
<p>As you'd expect, that prints out the <code>Hello, world!</code> message. Nothing
special going on here, is there? Well, actually, there is. This is a
closure. Did you notice?</p>
<p>What's special is that the subroutine reference we created refers to a
lexical variable called <code>$message</code>. The lexical is defined in
<code>make_hello_printer</code>, so by rights, it shouldn't be visible outside of
<code>make_hello_printer</code>, right? We call <code>make_hello_printer</code>, <code>$message</code>
gets created, we return the subroutine reference, and then <code>$message</code>
goes away, out of scope.</p>
<p>Except it doesn't. When we call our subroutine reference, outside of
<code>make_hello_printer</code>, it can still see and receive the correct value of
<code>$message</code>. The subroutine reference forms a <em>closure</em>, ``enclosing''
the lexical variables it refers to.</p>
<p>Here's the canonical example of closures, that you'll find in
practically every Perl book:</p>
<pre><code>
    sub make_counter {
        my $start = shift;
        return sub { $start++ }
    }

    my $from_ten = make_counter(10);
    my $from_three = make_counter(3);

    print $from_ten-&gt;();       # 10
    print $from_ten-&gt;();       # 11
    print $from_three-&gt;();     # 3
    print $from_ten-&gt;();       # 12
    print $from_three-&gt;();     # 4</code></pre>


<p>We've created two "counter" subroutines, which have completely independent 
values. This happens because each time we call <code>make_counter</code>, Perl
creates a new lexical for <code>$start</code>, which gets wrapped up in the
closure we return. So <code>$from_ten</code> encloses one <code>$start</code> which is
initialized to 10, and <code>$from_three</code> encloses a <strong>totally different</strong>
<code>$start</code>, which starts at 3.</p>
<p>It's because of this property that Barrie Slaymaker calls closures
"inside-out objects:" objects are data that have some subroutines
attached to them, and closures are subroutines that have some data
attached to them.</p>
<p>Now, I said that's used in practically every Perl book, because authors
try and put off discussing closures until there's little time left
and they run out of imagination. (Well, at least that's my excuse ...)
However, it's not an entirely practical example, to say the least.
So let's try and find a better one.</p>
<p>This example is a bit more complex, but it demonstrates more clearly one
extremely useful feature of closures: They can be used to bridge the gap
between event-driven programs, which use callbacks extensively, and
ordinary procedural code. I recently had to convert a bunch of XML files
into an SQL database. Each file constituted a training course, so I
wanted to build a data structure that contained the filename plus some
of the details I'd parsed from the XML. Here's what I ended up with:</p>
<pre><code>
    use XML::Twig;
    my %courses;
    for (&lt;??.xml&gt;) {
        my $name = $_; $name =~ s/.xml//;
        my $t= XML::Twig-&gt;new( 
            TwigHandlers =&gt; {
                need =&gt; sub { 
                    push @{$courses{$name}{prereqs}}, $_-&gt;{'att'}-&gt;{course};
                },
                # ...
            }
        );
        $t-&gt;parsefile($_);
    }</code></pre>
<p>What's going on here? <code>XML::Twig</code> is a handy module that can be used
to create an XML parser -- these parsers will call "TwigHandlers" when
they meet various tags. We go through all the two-letter XML files in
the current directory, and create a parser to parse the file. When we
see something like this:</p>
<pre><code>
    &lt;need course=&quot;AA&quot;/&gt;</code></pre>
<p>our <code>need</code> handler is called to store the fact that the current course
has a prerequisite of the course coded "AA."
(<code>$_-&gt;{'att'}-&gt;{...}</code> is <code>XML::Twig</code>-speak for "retrieve the
value of the attribute called ...")</p>
<p>And that <code>need</code> handler is a closure -- it wraps up the name of the
current file we're parsing, <code>$name</code>, so that it can be referred to
whenever <code>XML::Twig</code> decides to use it.</p>
<p>There are many other things you can do with closures -- Tom Christiansen
once recommended using them for "data hiding" in object-oriented code,
since they rely on lexical variables that nothing outside of the closure
can see. In fact, some of the most
<a href="http://perl.plover.com/lambda/tpj.html">esoteric and advanced</a>
applications of Perl make heavy use of closures.</p>
<p>But as we've seen, some of the most useful uses of closures can happen
without you noticing them at all ...</p>





        </div>



    </div>
    <div class="asset-footer"></div>
</div>


                            
                            <div id="entry-1302" class="entry-asset asset hentry">
    <div class="asset-header">
        <h2 class="asset-name entry-title"><a href="/pub/2002/05/22/mod_perl-isp.html" rel="bookmark">Finding a mod_perl ISP... or Becoming One</a></h2>
        <div class="asset-meta">
            <span class="byline">
    
                By <span class="vcard author">Stas Bekman</span> on <abbr class="published" title="2002-05-22T00:00:00-08:00">May 22, 2002 12:00 AM</abbr>
    
            </span>

            
            

        </div>
    </div>
    <div class="asset-content entry-content">

        <div class="asset-body">
            <h2><a name="introduction">Introduction</a></h2>
<p>In this article we will talk about the nuances of providing <code>mod_perl</code>
services and present a few ISPs that successfully provide them.</p>
<ul>
<li>
You installed <code>mod_perl</code> on your box at home, and you fell in love with
it.  So now you want to convert your CGI scripts (which are currently
running on your favorite ISP's machine) to run under <code>mod_perl</code>.  Then
you discover that your ISP has never heard of <code>mod_perl</code>, or he refuses
to install it for you.
</li>
<li>
You are an old sailor in the ISP business, you have seen it all, you
know how many ISPs are out there, and you know that the sales margins
are too low to keep you happy.  You are looking for some new service
almost no one else provides, to attract more clients to become your
users and, hopefully, to have a bigger slice of the action than your
competitors.
</li></ul>
<p>If you are planning to become an ISP that provides <code>mod_perl</code>
services or are just looking for such a provider, this article is for
you.</p>


<h3><a name="gory_details">Gory Details</a></h3>
<p>An ISP has three choices:</p>
<ol>
<li>
ISPs probably cannot let users run scripts under <code>mod_perl</code> on the main
server.  There are many reasons for this:
<p>Scripts might leak memory, due to sloppy programming.  There will not
be enough memory to run as many servers as required, and clients will
be not satisfied with the service because it will be slow.</p>
<p>The question of file permissions is a very important issue: any user
who is allowed to write and run a CGI script can at least read (if not
write) any other files that belong to the same user and/or group under which the
Web server is running.  Note that it's impossible to run <code>suEXEC</code>
and <code>cgiwrap</code> extensions under <code>mod_perl</code>.</p>

<csperl file="grab" domain="on" record="b/832" template="b/article_sidebar2.view">

<p>Another issue is the security of the database connections.  If you use
<code>Apache::DBI</code>, by hacking the <code>Apache::DBI</code> code you can pick a
connection from the pool of cached connections, even if it was opened
by someone else and your scripts are running on the same Web server.</p>
<p>There are many more things to be aware of, so at this time you have to
say <em>no</em>.</p>
<p>Of course, as an ISP, you can run <code>mod_perl</code> internally, without allowing
your users to map their scripts, so that they will run under <code>mod_perl</code>.
If, as a part of your service, you provide scripts such as guest books,
counters, etc. that are not available for user modification, you can
still can have these scripts running very quickly.</p>
</li>


<li>
"But, hey, why can't I let my users run their own servers, so I can wash
my hands of them and don't have to worry about how dirty and sloppy
their code is? (Assuming that the users are running their servers under
their own user names, to prevent them from stealing code and data from
each other.)"
<p>This option is fine, as long as you are not concerned about your new
systems resource requirements.  If you have even very limited
experience with <code>mod_perl</code>, you will know that <code>mod_perl</code>-enabled Apache servers -- while freeing up your CPU and allowing you to run scripts much faster -- have huge memory demands (5-20 times that of plain
Apache).</p>
<p>The size of these memory demands depends on the code length, the sloppiness of the
programming, possible memory leaks the code might have, and all of that
multiplied by the number of children each server spawns.  A very
simple example: a server, serving an average number of scripts,
demanding 10MB of memory, spawns 10 children and already raises your
memory requirements by 100MB (the real requirement is actually much
smaller if your OS allows code sharing between processes, and
if programmers exploit these features in their code).  Now, multiply the
average required size by the number of server users you intend to have
and you will get the total memory requirement.</p>
<p>Since ISPs never say <em>no</em>, you'd better take the inverse approach --
think of the largest memory size you can afford, and then divide it by one
user's requirements (as I have shown in this example), and you will know
how many <code>mod_perl</code> users you can afford :)</p>
<p>But what if you cannot tell how much memory your users may use?  Their
requirements from a single server can be very modest, but do you know
how many servers they will run?  After all, they have full control of
<code>httpd.conf</code> - and it has to be this way, since this is essential for
the user running <code>mod_perl</code>.</p>
<p>All of this rumbling about memory leads to a single question: is it
possible to prevent users from using more than X memory?  Or another
variation of the question: assuming you have as much memory as you
want, can you charge users for their average memory usage?</p>
<p>If the answer to either of the above questions is <em>yes</em>, you are all
set and your clients will prize your name for letting them run
<code>mod_perl</code>!  There are tools to restrict resource usage (see, for example,
the man pages for <code>ulimit(3)</code>, <code>getrlimit(2)</code>, <code>setrlimit(2)</code>, and
<code>sysconf(3)</code>; the last three have the corresponding Perl modules
<code>BSD::Resource</code> and <code>Apache::Resource</code>).</p>
<p>If you have chosen this option, you have to provide your client with:</p>
<ul>
<li>
Shutdown and startup scripts installed together with the rest of your
daemon startup scripts (e.g., the <code>/etc/rc.d</code> directory), so that when you
reboot your machine, the user's server will be correctly shut down and
will be back online the moment your system starts up.  Also make sure
to start each server under the user name the server belongs to, or you
are going to be in big trouble!
</li>
<li>
Proxy services (in forward or httpd accelerator mode) for the user's
virtual host.  Since the user will have to run their server on an
unprivileged port (&gt;1024), you will have to forward all requests from
<code>user.given.virtual.hostname:80</code> (which is
<code>user.given.virtual.hostname</code> without the default port 80) to
<code>your.machine.ip:port_assigned_to_user</code>.  You will also have to tell
the users to code their scripts so that any self-referencing URLs are
of the form <code>user.given.virtual.hostname</code>.
<p>Letting the user run a <code>mod_perl</code> server immediately adds the requirement
that the user be able to restart and configure their own server.
Only root can bind to port 80; this is why your users have to use port
numbers greater than 1024.</p>
<p>Another solution would be to use a setuid startup script, but think
twice before you go with it, since if users can modify the scripts, sometimes they will get a root access.</p>
</li>

<table cellspacing="12" cellpadding="0" border="0" align="right" width="200"><tr><td>
<center><img src="/images/pixel-hub.gif" width="200" height="2" hspace="0" vspace="10" border="0" alt=" " /><br />
<center><a href="http://conferences.oreilly.com/oscon/"><img src="/images/os2002/oscon-sidebar.gif" alt="O'Reilly Open Source Convention -- July 22-26, San Diego, CA." width="143" height="78" border="0" /></a></center>
<p class="smalllist"><strong>From the Frontiers of Research to the Heart of the Enterprise</strong></p>
</center>
<p class="secondary"><a href="http://conferences.oreillynet.com/cs/os2002/view/e_sess/3032">mod_perl 2.0, the Next Generation</a>
Stas Bekman will provide an overview of what's new in mod_perl 2.0 and what else is planned for the future in his talk at the upcoming <a href="http://conferences.oreillynet.com/os2002/">O'Reilly Open Source Convention</a>, this July 22-26, in San Diego.</p>
<center><img src="/images/pixel-hub.gif" width="200" height="2" hspace="0" vspace="0" border="0" alt=" " /></center>
</td></tr></table>
<li>
Another problem you will have to solve is how to assign ports to
users.  Since users can pick any port above 1024 to run their server,
you will have to lay down some rules here so that multiple servers do
not conflict.
<p>A simple example will demonstrate the importance of this problem. I am
a malicious user or I am just a rival of some fellow who runs his
server on your ISP.  All I need to do is to find out what port my
rival's server is listening to (e.g. using <code>netstat(8)</code>) and
configure my own server to listen on the same port.  Although I am
unable to bind to this port, imagine what will happen when you reboot
your system and my startup script happens to be run before my rival's!
I get the port first, and now all requests will be redirected to my
server.  I'll leave to your imagination what nasty things might happen
then.</p>
<p>Of course, the ugly things will quickly be revealed, but not before the
damage has been done.</p>
</li></ul>
<p>Basically, you can preassign each user a port, without them having to
worry about finding a free one, as well as enforce <code>MaxClients</code> and
similar values, by implementing the following scenario:</p>
<p>For each user, have two configuration files: the main file,
<code>httpd.conf</code> (non-writable by user) and the user's file,
<code>username.httpd.conf</code>, where they can specify their own configuration
parameters and override the ones defined in <code>httpd.conf</code>.  Here is
what the main configuration file looks like:</p>
<pre><code>
  httpd.conf
  ----------
  # Global/default settings, the user may override some of these
  ...
  ...
  # Included so that user can set his own configuration
  Include username.httpd.conf
  
  # User-specific settings which will override any potentially
  # dangerous configuration directives in username.httpd.conf
  ...
  ...
  
  username.httpd.conf
  -------------------
  # Settings that your user would like to add/override, like
  # &lt;Location&gt; and PerlModule directives, etc.</code></pre>

<p>Apache reads the global/default settings first.  It then reads the
<code>Include</code>d <code>username.httpd.conf</code> file with whatever settings the
user has chosen, and finally, it reads the user-specific settings that
we don't want the user to override, such as the port number.  Even if
the user changes the port number in his <code>username.httpd.conf</code> file,
Apache reads our settings last, so they take precedence.  Note that
you can use &lt;<code>Perl</code>&gt; sections to make the configuration much
easier.</p>
<li>
A much better, but costly, solution is <em>co-location</em>.  Let the user
hook his (or your) stand-alone machine into your network, and forget
about this user.  Of course, either the user or you will have to
undertake all of the system administration chores and it will cost your
client more money.
<p>Who are the people who seek <code>mod_perl</code> support?  They are people who run
serious projects/businesses.  Money is not usually an obstacle.  They
can afford a standalone box, thus achieving their goal of autonomy
while keeping their ISP happy.</p>
</li></ol>
<h3><a name="isps_providing_<code>mod_perl</code>_services">ISPs Providing <code>mod_perl</code> Services</a></h1>
<p>Let's present some of the ISPs that provide <code>mod_perl</code> services.</p>
<ul>
<li>
A Canadian company called Baremetal (http://BareMetal.com/) provides
<code>mod_perl</code> services via front-end proxy and a shared <code>mod_perl</code>
backend, which, as their technical support claims, works reasonably
well for folks that write good code. They're willing to run a
dedicated backend <code>mod_perl</code> server for customers that need it. Some of
their clients mix <code>mod_cgi</code> and <code>mod_perl</code> as a simple acceleration technique.
<p>Basic service price is $30/month.</p>
<p>For more information see <a href="http://modperl-space.com/">http://modperl-space.com/</a>.</p>
</li>
<li>
BSB-Software GmbH, located in Frankfurt, Germany, provides their own
<code>mod_perl</code> applications for clients with standard requirements, thus
preventing the security risks and allowing trusted users to use their
own code, which is usually reviewed by the company's system
administrator. For the latter case, <code>httpd.conf</code> is under the control
of the ISP, so everything is monitored.
<p>Please contact the company for the updated price list.</p>
<p>For more information see <a href="http://www.bsb-software.com/">http://www.bsb-software.com/</a>.</p>
</li>
<li>
Digital Wire Consulting, an open-source-driven Ebusiness
consulting company located in Zurich, Switzerland, provides shared and standalone
<code>mod_perl</code> systems. The company operates internationally.
<p>Here are the specifics of this company:</p></li>
<table width="150" border="0" cellspacing="0" cellpadding="4" align="right">
<tr> 
<td width="150" valign="top" height="4" bgcolor="#6699cc"></td></tr> 
<tr>
<td bgcolor="#efefef">
<p class="headline" align="center">Previously in the Series
</p>
<p class="secondary">
<a href="http://perl.com/pub/a/2002/05/14/mod_perl.html">The Perl You Need To Know - Part 3</a><br /><br />
<a href="http://perl.com/pub/a/2002/05/07/mod_perl.html">The Perl You Need To Know - Part 2</a><br /><br />

<a href="/pub/a/2002/04/23/mod_perl.html">The Perl You Need To Know</a><br /><br />
<a href="/pub/a/2002/04/10/mod_perl.html">Installing mod_perl without superuser privileges</a><br /><br />
<a href="/pub/a/2002/03/22/modperl.html">mod_perl in 30 minutes</a><br /><br />
<a href="/pub/a/2002/02/26/whatismodperl.html">Why mod_perl?</a>


</td></tr> <tr><td width="150" valign="top" height="4" bgcolor="#6699cc"> </td></tr></table>


<ol>

<li>
No restrictions in terms of CPU, bandwidth, etc. (so heavy-duty
operations are better off with dedicated machines!)
</li>
<li>
The user has to understand the risk that is involved if he/she is
choosing a shared machine. Every user has their own virtual server.
</li>
<li>
They offer dedicated servers at approximately $400/month (depending on
configuration) + $500 setup.
</li>
<li>
They don't support any proxy setups. If someone is serious about
running <code>mod_perl</code> for a mission-critical application, then that person
should be willing to pay for dedicated servers!
</li>
<li>
For a shared server and a mid-size <code>mod_perl</code> Web site, they charge
roughly $100/month for hosting only!  Installation and setup are
extra and based on the time spent (one hour is $120). Please
contact the company for the updated price list.
</li>
</ol>
<p>For more information see <a href="http://www.dwc.ch/">http://www.dwc.ch/</a>.</p>

<li>
Even <em>The Bunker</em> (which claims to be UK's safest site for secure
computing) supports <code>mod_perl</code>! Their standard server can include
<code>mod_perl</code> if requested. All of their users are provided with a dedicated
machine.
<p>For more information see <a href="http://www.thebunker.net/hosting.htm">http://www.thebunker.net/hosting.htm</a>.</p>
</li>
<li>
For more ISPs supporting <code>mod_perl</code>, see <a href="http://perl.apache.org/isp.html">http://perl.apache.org/isp.html</a>
<p>If you are an ISP that supports <code>mod_perl</code> and is not listed on the above page, please contact the person who maintains the list.</p>
</li></ul>
<h3><a name="references">References</a></h3>
<ul>
<li>
<code>mod_perl</code> home page: <a href="http://perl.apache.org/">http://perl.apache.org/</a>
</li>
<li>
<code>mod_perl</code> documentation: <a href="http://perl.apache.org/#docs">http://perl.apache.org/#docs</a>
</li>
<li>
a partial list of ISPs supporting <code>mod_perl</code>: <a href="http://perl.apache.org/isp.html">http://perl.apache.org/isp.html</a>
</li></ul>







        </div>



    </div>
    <div class="asset-footer"></div>
</div>


                            
                            <div id="entry-1300" class="entry-asset asset hentry">
    <div class="asset-header">
        <h2 class="asset-name entry-title"><a href="/pub/2002/05/14/mod_perl.html" rel="bookmark">The Perl You Need To Know - Part 3</a></h2>
        <div class="asset-meta">
            <span class="byline">
    
                By <span class="vcard author">Stas Bekman</span> on <abbr class="published" title="2002-05-15T00:00:00-08:00">May 15, 2002 12:00 AM</abbr>
    
            </span>

            
            

        </div>
    </div>
    <div class="asset-content entry-content">

        <div class="asset-body">
            
<!-- sidebar begins -->
<!-- no -->
<!--sidebar ends -->
<h3><a name="introduction">Introduction</a></h3>
<p>This article is the third in our series talking about the essential
Perl basics that you should know before starting to program for
<code>mod_perl</code>.</p>


<h3><a name="variables_globally,_lexically_scoped_and_fully_qualified">Variables Globally, Lexically Scoped and Fully Qualified</a></h3>

<p>You will hear a lot about namespaces, symbol tables and lexical
scoping in Perl discussions, but little of it will make any sense
without a few key facts:</p>

<h4><a name="symbols,_symbol_tables_and_packages;_typeglobs">Symbols, Symbol Tables and Packages; Typeglobs</a></h4>
<p>There are two important types of symbols: package global and lexical.
We will talk about lexical symbols later; for now, we will talk only
about package global symbols, which we will refer to as
<em>global symbols</em>.</p>
<p>The names of pieces of your code (subroutine names) and the names of
your global variables are symbols.  Global symbols reside in one
symbol table or another.  The code itself and the data do not; the
symbols are the names of pointers that point (indirectly) to the
memory areas that contain the code and data. (Note for C/C++
programmers: We use the term `pointer' in a general sense of one piece
of data referring to another piece of data, and not in the specific sense as
used in C or C++.)</p>
<p>There is one symbol table for each package, (which is why <em>global
symbols</em> are really <em>package global symbols</em>).</p>
<p>You are always working in one package or another.</p>

<csperl file="grab" domain="on" record="b/832" template="b/article_sidebar2.view">

<p>Just as in C, where the first function you write must be called <code>main()</code>,
the first statement of your first Perl script is in package <code>main::</code>,
which is the default package.  Unless you say otherwise by using the
<code>package</code> statement, your symbols are all in package <code>main::</code>. You
should be aware that files and packages are <em>not
related</em>. You can have any number of packages in a single file; and a
single package can be in one file or spread among many files. However,
it is common to have a single package in a single file. To
declare a package you write:</p>
<pre><code>
    package mypackagename;</code></pre>
<p>From the following line you are in package <code>mypackagename</code> and any
symbols you declare reside in that package. When you create a symbol
(variable, subroutine, etc.) Perl uses the name of the package in which
you are currently working as a prefix to create the fully qualified
name of the symbol.</p>
<p>When you create a symbol, Perl creates a symbol table entry for that
symbol in the current package's symbol table (by default
<code>main::</code>). Each symbol table entry is called a <em>typeglob</em>. Each
typeglob can hold information on a scalar, an array, a hash, a
subroutine (code), a filehandle, a directory handle and a format, each
of which all have the same name.  So you see now that there are two
indirections for a global variable: the symbol (the thing's name)
points to its typeglob, and the entry in the typeglob for the 
thing's type (scalar,
array, etc.)  points to the data. If we had a scalar and an array with
the same name, then their name would point to the same typeglob, but for
each type of data the typeglob points to somewhere different. Hence,
the scalar's data and the array's data are completely separate and
independent, they just happen to have the same name.</p>
<p>Most of the time, only one part of a typeglob is used (yes, it's a bit
wasteful).  By now, you know that you distinguish between them by
using what the authors of the Camel book call a <em>funny character</em>. So
if we have a scalar called `<code>line</code>,' then we would refer to it in code as
<code>$line</code>, and if we had an array of the same name, that would be
written, <code>@line</code>. Both would point to the same typeglob (which would
be called <code>*line</code>), but because of the <em>funny character</em>, (also known
as <em>decoration</em>) Perl won't confuse the two. Of course, we might
confuse ourselves, so some programmers don't ever use the same name
for more than one type of variable.</p>
<p>Every global symbol is in some package's symbol table. To refer to a
global symbol we could write the <em>fully qualified</em> name,
e.g. <code>$main::line</code>. If we are in the same package as the symbol, then we
can omit the package name, e.g.  <code>$line</code> (unless you use the <code>strict</code>
pragma and then you will have to predeclare the variable using the
<code>vars</code> pragma). We can also omit the package name if we have imported
the symbol into our current package's namespace. If we want to refer
to a symbol that is in another package and which we haven't imported, then
we must use the fully qualified name, e.g. <code>$otherpkg::box</code>.</p>
<p>Most of the time, you do not need to use the fully qualified symbol
name, because most of the time you will refer to package variables from
within the package.  This is like C++ class variables.  You can
work entirely within package <code>main::</code> and never even know you are
using a package, nor that the symbols have package names.  In a way,
this is a pity, because you may fail to learn about packages and they
are extremely useful.</p>
<p>The exception is when you <em>import</em> the variable from another package.
This creates an alias for the variable in the <em>current</em> package, so
that you can access it without using the fully qualified name.</p>
<p>While global variables are useful for sharing data and are necessary
in some contexts, it is usually wiser to minimize their use and use
<em>lexical variables</em>, discussed next, instead.</p>
<p>Note that when you create a variable, the low-level business of
allocating memory to store the information is handled automatically by
Perl.  The intepreter keeps track of the chunks of memory to which the
pointers are pointing and takes care of undefining variables. When all
references to a variable have ceased to exist, then the Perl garbage
collector is free to take back the memory used ready for
recycling. However, Perl almost never returns back memory it has
already used to the operating system during the lifetime of the
process.</p>

<h3><a name="lexical_variables_and_symbols">Lexical Variables and Symbols</a></h3>
<p>The symbols for lexical variables (i.e. those declared using the
keyword <code>my</code>) are the only symbols that do <em>not</em> live in a symbol
table.  Because of this, they are not available from outside the block
in which they are declared.  There is no typeglob associated with a
lexical variable and a lexical variable can refer only to a scalar, an
array or a hash.</p>
<p>If you need access to the data from outside the package, then you can
return it from a subroutine, or you can create a global variable
(i.e. one that has a package prefix) that points or refers to it, and
return that.  The reference must be global so that you can
refer to it by a fully qualified name. But just like in C, try to avoid
having global variables. Using OO methods generally solves this
problem by providing methods to get and set the desired value within
the object that can be lexically scoped inside the package and passed
by reference.</p>
<p>The phrase ``lexical variable'' is a bit of a misnomer, as we are really
talking about ``lexical symbols.''  The data can be referenced by a
global symbol, too, and in such cases when the lexical symbol goes out
of scope the data will still be accessible through the global symbol.
This is perfectly legitimate and cannot be compared to the terrible
mistake of taking a pointer to an automatic C variable and returning
it from a function -- when the pointer is dereferenced there will be a
segmentation fault.  (Note for C/C++ programmers: having a function
return a pointer to an auto variable is a disaster in C or C++; the
Perl equivalent, returning a reference to a lexical variable created
in a function is normal and useful.)</p>
<table cellspacing="12" cellpadding="0" border="0" align="right" width="200"><tr><td>
<center><img src="/images/pixel-hub.gif" width="200" height="2" hspace="0" vspace="10" border="0" alt=" " /><br />
<center><a href="http://conferences.oreilly.com/oscon/"><img src="/images/os2002/oscon-sidebar.gif" alt="O'Reilly Open Source Convention -- July 22-26, San Diego, CA." width="143" height="78" border="0" /></a></center>
<p class="smalllist"><strong>From the Frontiers of Research to the Heart of the Enterprise</strong></p>
</center>
<p class="secondary"><a href="http://conferences.oreillynet.com/cs/os2002/view/e_sess/3032">mod_perl 2.0, the Next Generation</a>
Stas Bekman will provide an overview of what's new in mod_perl 2.0 and what else is planned for the future in his talk at the upcoming <a href="http://conferences.oreillynet.com/os2002/">O'Reilly Open Source Convention</a>, this July 22-26, in San Diego.</p>
<center><img src="/images/pixel-hub.gif" width="200" height="2" hspace="0" vspace="0" border="0" alt=" " /></center>
</td></tr></table>

<ul>
<li>
<code>my()</code> vs. <code>use vars</code>:
<p>With use vars(), you are making an entry in the symbol table, and you
are telling the compiler that you are going to be referencing that
entry without an explicit package name.</p>
<p>With my(), NO ENTRY IS PUT IN THE SYMBOL TABLE.  The compiler figures
out <i>at compile time</i> which <code>my()</code> variables (i.e. lexical variables)
are the same as each other, and once you hit execute time you cannot
look up those variables in the symbol table.</p>
</li>
<li>
<code>my()</code> vs. <code>local()</code>:
<p><code>local()</code> creates a temporal-limited package-based scalar, array, hash,
or glob -- that's to say, when the scope of definition is exited at runtime, the
previous value (if any) is restored.  References to such a variable
are <b>also</b> global ... only the value changes.  (Aside: that is what
causes variable suicide. :)</p>
<p><code>my()</code> creates a lexically limited nonpackage-based scalar, array, or
hash -- when the scope of definition is exited at compile-time, the
variable ceases to be accessible.  Any references to such a variable
at runtime turn into unique anonymous variables on each scope exit.</p>
</li></ul>












<h3><a name="use(),_require(),_do(),_%inc_and_@inc_explained">use(), require(), do(), %INC and @INC Explained</a></h3>
<p>
</p>
<h4><a name="the_@inc_array">The @INC Array</a></h4>
<p><code>@INC</code> is a special Perl variable that is the equivalent to the
shell's <code>PATH</code> variable. Whereas <code>PATH</code> contains a list of
directories to search for executables, <code>@INC</code> contains a list of
directories from which Perl modules and libraries can be loaded.</p>
<p>When you <code>use()</code>, <code>require()</code> or <code>do()</code> a filename or a module, Perl gets a
list of directories from the <code>@INC</code> variable and searches them for
the file it was requested to load.  If the file that you want to load
is not located in one of the listed directories, then you have to tell Perl
where to find the file.  You can either provide a path relative to one
of the directories in <code>@INC</code>, or you can provide the full path to the
file.</p>


<h4><a name="the_%inc_hash">The %INC Hash</a></h4>
<p><code>%INC</code> is another special Perl variable that is used to cache the
names of the files and the modules that were successfully loaded and
compiled by <code>use()</code>, <code>require()</code> or <code>do()</code> statements. Before attempting to
load a file or a module with <code>use()</code> or require(), Perl checks whether
it's already in the <code>%INC</code> hash. If it's there, then the loading and
therefore the compilation are not performed at all. Otherwise, the file
is loaded into memory and an attempt is made to compile it. <code>do()</code> does
unconditional loading -- no lookup in the <code>%INC</code> hash is made.</p>
<p>If the file is successfully loaded and compiled, then a new key-value pair
is added to <code>%INC</code>. The key is the name of the file or module as it
was passed to the one of the three functions we have just mentioned.
If it was found in any of the <code>@INC</code> directories except <code>&quot;.&quot;</code>,
then the value is the full path to it in the file system.</p>
<p>The following examples will make it easier to understand the logic.</p>
<p>First, let's see what are the contents of <code>@INC</code> on my system:</p>
<pre><code>
  % perl -e 'print join &quot;\n&quot;, @INC'
  /usr/lib/perl5/5.00503/i386-linux
  /usr/lib/perl5/5.00503
  /usr/lib/perl5/site_perl/5.005/i386-linux
  /usr/lib/perl5/site_perl/5.005
  .</code></pre>
<p>Notice that <code>.</code> (current directory) is the last directory in the list.</p>
<p>Now let's load the module <code>strict.pm</code> and see the contents of <code>%INC</code>:</p>
<pre><code>
  % perl -e 'use strict; print map {&quot;$_ =&gt; $INC{$_}\n&quot;} keys %INC'
  
  strict.pm =&gt; /usr/lib/perl5/5.00503/strict.pm</code></pre>
<p>Since <code>strict.pm</code> was found in <em>/usr/lib/perl5/5.00503/</em> directory
and <em>/usr/lib/perl5/5.00503/</em> is a part of <code>@INC</code>, <code>%INC</code> includes
the full path as the value for the key <code>strict.pm</code>.</p>
<p>Now let's create the simplest module in <code>/tmp/test.pm</code>:</p>
<pre><code>
  test.pm
  -------
  1;</code></pre>
<p>It does nothing, but returns a true value when loaded. Now let's load
it in different ways:</p>
<pre><code>
  % cd /tmp
  % perl -e 'use test; print map {&quot;$_ =&gt; $INC{$_}\n&quot;} keys %INC'
  
  test.pm =&gt; test.pm</code></pre>
<p>Since the file was found relative to <code>.</code> (the current directory), the
relative path is inserted as the value. If we alter <code>@INC</code> by adding
<em>/tmp</em> to the end:</p>
<pre><code>
  % cd /tmp
  % perl -e 'BEGIN{push @INC, &quot;/tmp&quot;} use test; \
  print map {&quot;$_ =&gt; $INC{$_}\n&quot;} keys %INC'
  
  test.pm =&gt; test.pm</code></pre>
<p>Here we still get the relative path, since the module was found first
relative to <code>&quot;.&quot;</code>. The directory <em>/tmp</em> was placed after <code>.</code> in the
list. If we execute the same code from a different directory, then the
<code>&quot;.&quot;</code> directory won't match,</p>
<pre><code>
  % cd /
  % perl -e 'BEGIN{push @INC, &quot;/tmp&quot;} use test; \
  print map {&quot;$_ =&gt; $INC{$_}\n&quot;} keys %INC'
  
  test.pm =&gt; /tmp/test.pm</code></pre>
<p>so we get the full path. We can also prepend the path with <code>unshift()</code>,
so it will be used for matching before <code>&quot;.&quot;</code> and therefore we will
get the full path as well:</p>
<pre><code>
  % cd /tmp
  % perl -e 'BEGIN{unshift @INC, &quot;/tmp&quot;} use test; \
  print map {&quot;$_ =&gt; $INC{$_}\n&quot;} keys %INC'
  
  test.pm =&gt; /tmp/test.pm</code></pre>
<p>The code:</p>
<pre><code>
  BEGIN{unshift @INC, &quot;/tmp&quot;}</code></pre>
<p>can be replaced with the more elegant:</p>
<pre><code>
  use lib &quot;/tmp&quot;;</code></pre>
<p>Which is almost equivalent to our <code>BEGIN</code> block and is the
recommended approach.</p>
<p>These approaches to modifying <code>@INC</code> can be labor intensive, since if
you want to move the script around in the file-system, then you have to
modify the path. This can be painful, for example, when you move your
scripts from development to a production server.</p>
<p>There is a module called <code>FindBin</code> that solves this problem in the
plain Perl world, but, unfortunately, it won't work under mod_perl,
since it's a module, and as any module, it's loaded only once. So the
first script using it will have all the settings correct, but the rest
of the scripts will not if they're in a different directory from the
first.</p>
<p>For the sake of completeness, I'll present this module anyway.</p>
<p>If you use this module, then you don't need to write a hard-coded path. The
following snippet does all the work for you (the file is
<em>/tmp/load.pl</em>):</p>
<pre><code>
  load.pl
  -------
  #!/usr/bin/perl
  
  use FindBin ();
  use lib &quot;$FindBin::Bin&quot;;
  use test;
  print &quot;test.pm =&gt; $INC{'test.pm'}\n&quot;;</code></pre>
<p>In the above example, <code>$FindBin::Bin</code> is equal to <em>/tmp</em>. If we move
the script somewhere else... e.g. <em>/tmp/x</em> in the code above
<code>$FindBin::Bin</code> equals <em>/home/x</em>.</p>
<pre><code>
  % /tmp/load.pl
  
  test.pm =&gt; /tmp/test.pm</code></pre>
<p>This is just like <code>use lib</code> except that no hard-coded path is
required.</p>
<p>You can use this workaround to make it work under mod_perl.</p>
<pre><code>
  do 'FindBin.pm';
  unshift @INC, &quot;$FindBin::Bin&quot;;
  require test;
  #maybe test::import( ... ) here if need to import stuff</code></pre>
<p>This has a slight overhead, because it will load from disk and
recompile the <code>FindBin</code> module on each request. So it may not be
worth it.</p>













<h4><a name="modules,_libraries_and_program_files">Modules, Libraries and Program Files</a></h4>
<p>Before we proceed, let's define what we mean by <em>module</em>, <em>library</em>
and <em>program file</em>.</p>
<ul>
<li><strong><a name="item_libraries">Libraries</a></strong>
</li>
These are files that contain Perl subroutines and other code.
<p>When these are used to break up a large program into manageable chunks,
they don't generally include a package declaration; when they are used
as subroutine libraries, they often do have a package declaration.</p>
<p>Their last statement returns true, a simple <code>1;</code> statement ensures
that.</p>
<p>They can be named in any way desired, but generally their extension is
<em>.pl</em>.</p>
<p>Examples:</p>
<pre><code>
  config.pl
  ----------
  # No package so defaults to main::
  $dir = &quot;/home/httpd/cgi-bin&quot;;
  $cgi = &quot;/cgi-bin&quot;;
  1;</code></pre>
<pre><code>
  mysubs.pl
  ----------
  # No package so defaults to main::
  sub print_header{
    print &quot;Content-type: text/plain\r\n\r\n&quot;;
  }
  1;</code></pre>
<pre><code>
  web.pl
  ------------
  package web ;
  # Call like this: web::print_with_class('loud',&quot;Don't shout!&quot;);
  sub print_with_class{
    my( $class, $text ) = @_ ;
    print qq{&lt;span class=&quot;$class&quot;&gt;$text&lt;/span&gt;};
  }
  1;</code></pre>

<li><strong><a name="item_modules">Modules</a></strong><br />
</li>
A file that contains Perl subroutines and other code.
<p>It generally declares a package name at the beginning.</p>
<p>Modules are generally used either as function libraries (which <em>.pl</em>
files are still but less commonly used for), or as object libraries
where a module is used to define a class and its methods.</p>
<p>Its last statement returns true.</p>
<p>The naming convention requires it to have a <em>.pm</em> extension.</p>
<p>Example:</p>
<pre><code>
  MyModule.pm
  -----------
  package My::Module;
  $My::Module::VERSION = 0.01;
  
  sub new{ return bless {}, shift;}
  END { print &quot;Quitting\n&quot;}
  1;</code></pre>

<li><strong><a name="item_program_files">Program Files</a></strong><br />
</li>
<p>Many Perl programs exist as a single file. Under Linux and other
Unix-like operating systems, the file often has no suffix since the
operating system can determine that it is a Perl script from the first
line (shebang line) or if it's Apache that executes the code, there is
a variety of ways to tell how and when the file should be executed.
Under Windows, a suffix is normally used, for example <code>.pl</code> or
<code>.plx</code>.
<p>The program file will normally <code>require()</code> any libraries and <code>use()</code>
any modules it requires for execution.</p>
<p>It will contain Perl code but won't usually have any package names.</p>
<p>Its last statement may return anything or nothing.</p>
</ul>


<h4><a name="require()"><code>require()</code></a></h4>

<table width="150" border="0" cellspacing="0" cellpadding="4" align="right">
<tr> 
<td width="150" valign="top" height="4" bgcolor="#6699cc"></td></tr> 
<tr>
<td bgcolor="#efefef">
<p class="headline" align="center">Previously in the Series
</p>
<p class="secondary">
<a href="http://perl.com/pub/a/2002/05/07/mod_perl.html">The Perl You Need To Know - Part 2</a><br /><br />

<a href="/pub/a/2002/04/23/mod_perl.html">The Perl You Need To Know</a><br /><br />
<a href="/pub/a/2002/04/10/mod_perl.html">Installing mod_perl without superuser privileges</a><br /><br />
<a href="/pub/a/2002/03/22/modperl.html">mod_perl in 30 minutes</a><br /><br />
<a href="/pub/a/2002/02/26/whatismodperl.html">Why mod_perl?</a>


</td></tr> <tr><td width="150" valign="top" height="4" bgcolor="#6699cc"> </td></tr></table>


<p><code>require()</code> reads a file containing Perl code and compiles it. Before
attempting to load the file, it looks up the argument in <code>%INC</code> to see
whether it has already been loaded. If it has, then <code>require()</code> just returns
without doing a thing. Otherwise, an attempt will be made to load and
compile the file.</p>
<p><code>require()</code> has to find the file it has to load. If the argument is a
full path to the file, then it just tries to read it. For example:</p>
<pre><code>
  require &quot;/home/httpd/perl/mylibs.pl&quot;;</code></pre>
<p>If the path is relative, then <code>require()</code> will attempt to search for the file
in all the directories listed in <code>@INC</code>.  For example:</p>
<pre><code>
  require &quot;mylibs.pl&quot;;</code></pre>
<p>If there is more than one occurrence of the file with the same name in
the directories listed in <code>@INC</code>, then the first occurrence will be used.</p>
<p>The file must return <em>TRUE</em> as the last statement to indicate
successful execution of any initialization code. Since you never know
what changes the file will go through in the future, you cannot be
sure that the last statement will always return <em>TRUE</em>. That's why
the suggestion is to put ``<code>1;</code>'' at the end of file.</p>
<p>Although you should use the real filename for most files, if the file
is a module, then you may use the following convention instead:</p>
<pre><code>
  require My::Module;</code></pre>
<p>This is equal to:</p>
<pre><code>
  require &quot;My/Module.pm&quot;;</code></pre>
<p>If <code>require()</code> fails to load the file, either because it couldn't find
the file in question or the code failed to compile, or it didn't
return <em>TRUE</em>, then the program would die().  To prevent this, the
<code>require()</code> statement can be enclosed into an <code>eval()</code> exception-handling
block, as in this example:</p>
<pre><code>
  require.pl
  ----------
  #!/usr/bin/perl -w
  
  eval { require &quot;/file/that/does/not/exists&quot;};
  if ($@) {
    print &quot;Failed to load, because : $@&quot;
  }
  print &quot;\nHello\n&quot;;</code></pre>
<p>When we execute the program:</p>
<pre><code>
  % ./require.pl
  
  Failed to load, because : Can't locate /file/that/does/not/exists in
  @INC (@INC contains: /usr/lib/perl5/5.00503/i386-linux
  /usr/lib/perl5/5.00503 /usr/lib/perl5/site_perl/5.005/i386-linux
  /usr/lib/perl5/site_perl/5.005 .) at require.pl line 3.
  
  Hello</code></pre>
<p>We see that the program didn't die(), because <em>Hello</em> was
printed. This <em>trick</em> is useful when you want to check whether a user
has some module installed. If she hasn't, then it's not critical,
because the program can run with reduced
functionality without this module.</p>
<p>If we remove the <code>eval()</code> part and try again:</p>
<pre><code>
  require.pl
  ----------
  #!/usr/bin/perl -w
  
  require &quot;/file/that/does/not/exists&quot;;
  print &quot;\nHello\n&quot;;</code></pre>
<pre><code>
  % ./require1.pl
  
  Can't locate /file/that/does/not/exists in @INC (@INC contains:
  /usr/lib/perl5/5.00503/i386-linux /usr/lib/perl5/5.00503
  /usr/lib/perl5/site_perl/5.005/i386-linux
  /usr/lib/perl5/site_perl/5.005 .) at require1.pl line 3.</code></pre>
<p>The program just die()s in the last example, which is what you want in
most cases.</p>
<p>For more information, refer to the perlfunc manpage.</p>


<h4><a name="use()"><code>use()</code></a></h4>
<p>use(), just like require(), loads and compiles files containing Perl
code, but it works with modules only.  The only way to pass a module
to load is by its module name and not its filename.  If the module is
located in <em>MyCode.pm</em>, then the correct way to <code>use()</code> it is:</p>
<pre><code>
  use MyCode</code></pre>
<p>and not:</p>
<pre><code>
  use &quot;MyCode.pm&quot;</code></pre>
<p><code>use()</code> translates the passed argument into a file name replacing <code>::</code>
with the operating system's path separator (normally <code>/</code>) and
appending <em>.pm</em> at the end. So <code>My::Module</code> becomes <em>My/Module.pm</em>.</p>
<p><code>use()</code> is equivalent to:</p>
<pre><code>
 BEGIN { require Module; Module-&gt;import(LIST); }</code></pre>
<p>Internally it calls <code>require()</code> to do the loading and compilation
chores. When <code>require()</code> finishes its job, <code>import()</code> is called unless
<code>()</code> is the second argument. The following pairs are equivalent:</p>
<pre><code>
  use MyModule;
  BEGIN {require MyModule; MyModule-&gt;import; }
  
  use MyModule qw(foo bar);
  BEGIN {require MyModule; MyModule-&gt;import(&quot;foo&quot;,&quot;bar&quot;); }
  
  use MyModule ();
  BEGIN {require MyModule; }</code></pre>
<p>The first pair exports the default tags. This happens if the module
sets <code>@EXPORT</code> to a list of tags to be exported by default. The
module's mainpage normally describes which tags are exported by
default.</p>
<p>The second pair exports only the tags passed as arguments.</p>
<p>The third pair describes the case where the caller does not want any
symbols to be imported.</p>
<p><code>import()</code> is not a built-in function, it's just an ordinary static
method call into the ``<code>MyModule</code>'' package to tell the module to
import the list of features back into the current package. See the
Exporter manpage for more information.</p>
<p>When you write your own modules, always remember that it's better to
use <code>@EXPORT_OK</code> instead of <code>@EXPORT</code>, since the former doesn't
export symbols unless it was asked to. Exports pollute the namespace
of the module user. Also avoid short or common symbol names to reduce
the risk of name clashes.</p>
<p>When functions and variables aren't exported you can still access them
using their full names, like <code>$My::Module::bar</code> or
<code>$My::Module::foo()</code>.  By convention you can use a leading underscore
on names to informally indicate that they are <em>internal</em> and not for
public use.</p>
<p>There's a corresponding ``<code>no</code>'' command that un-imports symbols
imported by <code>use</code>, i.e., it calls <code>Module-&gt;unimport(LIST)</code>
instead of <code>import()</code>.</p>
<p>
</p>
<h4><a name="do()"><code>do()</code></a></h4>
<p>While <code>do()</code> behaves almost identically to require(), it reloads the
file unconditionally. It doesn't check <code>%INC</code> to see whether the file
was already loaded.</p>
<p>If <code>do()</code> cannot read the file, then it returns <code>undef</code> and sets <code>$!</code> to
report the error.  If <code>do()</code> can read the file but cannot compile it, then it
returns <code>undef</code> and puts an error message in <code>$@</code>. If the file is
successfully compiled, then <code>do()</code> returns the value of the last expression
evaluated.</p>


<h3><a name="references">References</a></h3>
<ul>
<li>
An article by Mark-Jason Dominus about how Perl handles variables and
namespaces, and the difference between <code>use vars()</code> and <code>my()</code> -
<a href="http://www.plover.com/~mjd/perl/FAQs/Namespaces.html">http://www.plover.com/~mjd/perl/FAQs/Namespaces.html</a> .
</li>
<li>
For an in-depth explanation of Perl data types, see chapters 3 and 6
in the book <em>``Advanced Perl Programming''</em> by Sriram Srinivasan.
<p>And, of course, the ``<em>Programming Perl</em>'' by L.Wall, T. Christiansen and
J.Orwant (also known as the ``<em>Camel</em>'' book, named after the camel
picture on the cover of the book). Look at chapters 10, 11 and 21.</p>
</li>
<li>
The <em>Exporter</em>, <em>perlvar</em>, <em>perlmod</em> and <em>perlmodlib</em> man pages.
</li></ul>





        </div>



    </div>
    <div class="asset-footer"></div>
</div>


                            
                            <div id="entry-1298" class="entry-asset asset hentry">
    <div class="asset-header">
        <h2 class="asset-name entry-title"><a href="/pub/2002/05/07/optree.html" rel="bookmark">Where Wizards Fear To Tread</a></h2>
        <div class="asset-meta">
            <span class="byline">
    
                By <span class="vcard author">Simon Cozens</span> on <abbr class="published" title="2002-05-07T00:00:00-08:00">May  7, 2002 12:00 AM</abbr>
    
            </span>

            
            

        </div>
    </div>
    <div class="asset-content entry-content">

        <div class="asset-body">
            

<p>So you're a Perl master. You've got XS sorted. You know how the
internals work. Hey, there's nothing we can teach you on perl.com
that you don't already know. You think? Where Wizards Fear To Tread
brings you the information you won't find anywhere else concerning
the very top level of Perl hackery.</p>


<h3><a name="putting down your roots">Putting Down Your Roots</a></h3>

<p>This month, we look at the Perl op tree. Every Perl program is compiled
into an internal representation before it is executed. Functions,
subroutine calls, variable accesses, control structures, and all that
makes up a Perl program, are converted into a series of different
fundamental operations (<em>ops</em>) and these ops are strung together into a
tree data structure.</p>
<p>For more on the different types of ops available, how they fit together,
and how to manipulate them with the <code>B</code> compiler module, look at 
the <a href="http://www.netthink.co.uk/downloads/internals">Perl 5 internals tutorial</a>.
Right now, though, we're going to take things a step further.</p>


<h3><a name="b and beyond with b::utils">B and Beyond With B::Utils</a></h3>

<p>The <code>B</code> module allows us to get at a wealth of information about an
op, but it can become incredibly frustrating to know which op you want
to deal with, and to perform simple manipulation on a range of ops.
It also offers limited functionality for navigating around the op tree,
meaning that you need to hold onto a load of additional state about
which op is where. This gets complicated quickly. Finally,
it's not easy to get at the op trees for particular subroutines, or
indeed, all subroutines both named and anonymous.</p>

<p><code>B::Utils</code> was created at the request of Michael Schwern to address
these issues. It offers much more high-level functionality for
navigating through the tree, such as the ability to move ``upward'' or
``backward,'' to return the old name of an op that has currently been
optimized away, to get a list of the op's children, and so on. It can
return arrays of anonymous subroutines, and hashes of subroutine op
roots and starts. It also contains functions for walking through the op
tree from various starting points in various orders, optionally
filtering out ops that don't match certain conditions; while performing
actions on ops, <code>B::Utils</code> provides <code>carp</code> and <code>croak</code> routines which
perform error reporting from the point of view of the original source
code.</p>
<p>But one of the most useful functions provided by <code>B::Utils</code> is the
<code>opgrep</code> routine. This allows you to filter a series of ops based on a
pattern that represents their attributes and their position in a tree.
The major advantage over doing it yourself is that <code>opgrep</code> takes care
of making sure that the attributes are present before testing them - the
seasoned <code>B</code> user is likely to be accustomed to the carnage that
results from accidentally trying to call <code>name</code> on a <code>B::NULL</code> object.</p>
<p>For instance, we can find all the subroutine calls in a program with</p>
<pre><code>
    walkallops_filtered (
        sub { opgrep( { name =&gt; &quot;entersub&quot; }, @_) },
        sub { print &quot;Found one: $_[0]\n&quot;; }
    );</code>
</pre>
<p><code>
C&lt;opgrep&gt; supports alternation and negation of attribute queries. For
instance, here are all the scalar variable accesses, whether to globals
or lexicals:</code></p>

<pre><code>
    @svs = opgrep ( { name =&gt; [&quot;padsv&quot;, &quot;gvsv&quot;] }, @ops)</code></pre>
    
<p>And as for checking an op's position in the tree, here are all the
<code>exec</code> ops followed by a <code>nextstate</code> and then followed by something
other than <code>exit</code>, <code>warn</code> or <code>die</code>:</p>
<pre><code>
  walkallops_filtered(
      sub { opgrep( {
                        name =&gt; &quot;exec&quot;,
                        next =&gt; {
                           name    =&gt; &quot;nextstate&quot;,
                           sibling =&gt; { 
                                         name =&gt; [qw(! exit warn die)] 
                                      }
                                }
                    }, @_)},
      sub {
            carp(&quot;Statement unlikely to be reached&quot;);
            carp(&quot;\t(Maybe you meant system() when you said exec()?)\n&quot;);
      }
  )</code></pre>

<h3><a name="don't do that, do this">Don't Do That, Do This</a></h3>

<p>So, what can we do with all this? The answer is, of course, ``anything we
want.'' If you can mess about with the op tree, then you have complete control
over Perl's operation. Let's take an example.</p>
<p>Damian Conway recently released the <code>Acme::Don't</code> module, which doesn't
do anything:</p>
<pre><code>
    don't { print &quot;Something\n&quot; }</code></pre>
<p>doesn't print anything. Very clever. But not clever enough. You see, I
like double negatives:</p>
<pre><code>
    my $x = 1;
    don't { print &quot;Something\n&quot; } unless $x;</code></pre>
    

    
<p>doesn't print anything either, and if you like double negatives, then
you might agree that it should print something. But how on earth are we
going to get Perl to do something when a test proves false? By messing
about with the op tree, of course.</p>

<p>The way to solve any problem like this is to think about the op tree
that we've currently got, work out what we'd rather do instead, and work
out the differences between the op trees. Then, we write something that
looks for a given pattern in a program's op tree and modifies it to be
what we want.</p>
<p>There are several ways of achieving what we actually want to get but the
simplest one is this: add a second parameter to <code>don't</code> which, if set,
actually <em>does</em> do the code. This allows us to replace any occurrence
of</p>
<pre>
    don't { print &quot;Something\n&quot; } if (condition);</pre>
<p>with</p>
<pre><code>
    don't(sub { print &quot;Something\n&quot; }, 1) unless (condition);</code></pre>
<p>Let's now look at this in terms of op trees. Here's the relevant part of
the op tree for <code>don't { ... } if $x</code>, produced by running 
<code>perl -MO=Terse</code> and then using <code>sed</code> to trim out to unsightly hex
addresses:</p>
<pre><code>
    UNOP  null
        LOGOP  and
            UNOP  null [15]
                SVOP  *x
            UNOP  entersub [2]
                UNOP  null [141]
                    OP  pushmark
                    UNOP  refgen
                        UNOP  null [141]
                            OP  pushmark
                            SVOP  anoncode  SPECIAL #0 Nullsv
                    UNOP  null [17]
                        SVOP  *don::t</code></pre>
<p>As we can see, the <code>if</code> is represented as an <code>and</code> op internally,
which makes sense if you think about it. The two ``legs'' of the <code>and</code>,
called ``first'' and ``other,'' are a call to fetch the value of <code>$c</code>,
and a subroutine call. Look at the subroutine call closely: the
ops ``inside'' this set up a mark to say where the parameters start, 
push a reference to anonymous code (that's our <code>{ ... }</code>) onto the
stack, and then push the glob for <code>*don::t</code> on there.</p>
<p>So, we need to do two things: We need to insert another parameter
between <code>refgen</code> and the <code>null</code> attached to <code>*don::t</code>, and we need to
invert the sense of the test.</p>
<p>Now we know what we've got to do, let's start doing it - remember our
solution: stage one, write code to find the pattern.</p>
<p>This is actually pretty simple: We're looking for either an <code>and</code> or
an <code>or</code> op, and the ``other'' leg of the op is going to be a call to
<code>*don::t</code>. However, we have to be a bit clever here, since Perl
internally performs a few optimizations on the op tree that even the
<code>B::*</code> reporting modules don't tell you about. When Perl threads the
<code>next</code> pointers around an op tree, it does something special for a
short-circuiting binary op like <code>and</code> or <code>or</code> - it sets the <code>other</code>
pointer to be not the first sibling in the tree, but the first op in
execution order. In this case, that's <code>pushmark</code>, as we can see from
running <code>B::Terse,exec</code>:</p>
<pre><code>
    LOGOP (0x80fa008) and
    AND =&gt; {
        OP (0x80f9f88) pushmark
        OP (0x80f9f20) pushmark
        SVOP (0x80f9ec0) anoncode  SPECIAL #0 Nullsv
        ...</code></pre>
<p>With this knowledge, we can create a pattern to pass to <code>opgrep</code>:</p>
<pre><code>
    {
        name =&gt; [&quot;and&quot;, &quot;or&quot;],
        other =&gt; {
            name =&gt; &quot;pushmark&quot;,
            sibling =&gt; { next =&gt; { name =&gt; &quot;gv&quot; }}
        }
    }</code></pre>
<p>Unfortunately, this doesn't tell us the whole story, since we actually
need to check that the subroutine call <strong>is</strong> to <code>don't</code>, rather than
to any other given subroutine that might be called conditionally. Hence,
our filter looks like this:</p>
<pre><code>
    sub {
        my $op = shift;
        opgrep(
            {
                name =&gt; [&quot;and&quot;, &quot;or&quot;],
                other =&gt; {
                    name =&gt; &quot;pushmark&quot;,
                    sibling =&gt; { next =&gt; { name =&gt; &quot;gv&quot; }}
                }
            }, $op) or return;
        my $gv = $op-&gt;other-&gt;sibling-&gt;next-&gt;gv;
        return unless $gv-&gt;STASH-&gt;NAME eq &quot;don&quot; and $gv-&gt;NAME eq &quot;t&quot;;
        return 1;
    }</code></pre>
<p>We grab the GV (we know exactly where it's going to be because of our
pattern!) and test that it's in the <code>don</code> stash and is called <code>t</code>.</p>
<p>Part one done - we have located the ops that we want to change. Now
how on earth do we change ops in an op tree?</p>














<h3><a name="fixing it up with b::generate">Fixing It Up With B::Generate</a></h3>
<p><code>B::Generate</code> was written to allow users to create their own ops and
insert them into the op tree. The original intent was to be able to
create bytecode for other languages to be run on the Perl virtual machine,
but it's found plenty of use manipulating existing Perl op trees.</p>
<p>It provides ``constructor'' methods in all of the <code>B::*OP</code> classes, and makes
many of the accessor methods read-write instead of read-only. Let's see
how we can apply it to this problem. Remember that we want to negate the
sense of the test, and then to add another argument to the call to
<code>don't</code>.</p>
<p>For the first of these tasks, <code>B::Generate</code> provides the handy
<code>mutate</code> and <code>convert</code> methods on each <code>B::OP</code>-derived object to
change one op's type into another. The decision as to which of them use
is slightly complex: <code>mutate</code> can only be used for ops of the same type
- for instance, you cannot use it to mutate a binary op into a unary op.
However, <code>convert</code> produces a completely new op, which needs to be
threaded back into the op tree. So <code>convert</code> is much more powerful, but
<code>mutate</code> is much more convenient. In this case, since we're just
flipping between <code>and</code> and <code>or</code>, we can get away with using <code>mutate</code>:</p>
<pre><code>
    require B::Generate;
    my $op = shift;
    if ($op-&gt;name eq &quot;and&quot;) {
        $op-&gt;mutate(&quot;or&quot;);
    } else {
        $op-&gt;mutate(&quot;and&quot;);
    }</code></pre>
<p>Now to insert the additional parameter. For this, remember that <code>entersub</code>
works by popping off the top entry in the stack and calling that as a 
subroutine, and the remaining stack entries become parameters to the
subroutine. So we want to add a <code>const</code> op to put a constant on the stack.
We use the <code>B::SVOP-&gt;new</code> constructor to create a new one, and then
thread the <code>next</code> pointers so that Perl's main loop will call it between
<code>$op-&gt;other-&gt;sibling</code> (the <code>refgen</code> op) and the op after it.
(the GV which represents <code>*don::t</code>)</p>
<pre><code>
    my $to_insert = $op-&gt;other-&gt;sibling;
    my $newop = B::SVOP-&gt;new(&quot;const&quot;, 0, 1);
    $newop-&gt;next($to_insert-&gt;next);
    $to_insert-&gt;next($newop);</code></pre>
<p>All that's left is to replace the definition of <code>don't</code> so that, depending
on the parameters, it sometimes <code>do</code>es:</p>
<pre><code>
    sub don't (&amp;;$) { $_[0]-&gt;() if $_[1] }</code></pre>
<p>And there we have it:</p>
<pre><code>
    package Acme::Don't;
    CHECK {
        use B::Utils qw(opgrep walkallops_filtered);
        walkallops_filtered(
            sub {
                my $op = shift;
                opgrep(
                {
                    name =&gt; [&quot;and&quot;, &quot;or&quot;],
                    other =&gt; {
                        name =&gt; &quot;pushmark&quot;,
                        sibling =&gt; { next =&gt; { name =&gt; &quot;gv&quot; }}
                    }
                }, $op) or return;
                my $gv = $op-&gt;other-&gt;sibling-&gt;next-&gt;gv;
                return unless $gv-&gt;STASH-&gt;NAME eq &quot;don&quot; and $gv-&gt;NAME eq &quot;t&quot;;
                return 1;
            },
            sub {
                require B::Generate;
                my $op = shift;
                if ($op-&gt;name eq &quot;and&quot;) {
                    $op-&gt;mutate(&quot;or&quot;);
                } else {
                    $op-&gt;mutate(&quot;and&quot;);
                }
                
                my $to_insert = $op-&gt;other-&gt;sibling;
                my $newop = B::SVOP-&gt;new(&quot;const&quot;, 0, 1);
                $newop-&gt;next($to_insert-&gt;next);
                $to_insert-&gt;next($newop);
            }
       );
    }
    
    sub don't (&amp;;$) { $_[0]-&gt;() if $_[1] }</code></pre>
<p>This will turn</p>
<pre><code>
    $false = 0; $true = 1;
    
    don't { print &quot;Testing&quot; } if $false;
    don't { print &quot;Testing again&quot; } unless $true;</code></pre>
<p>into</p>
<pre><code>
    $false = 0; $true = 1;
    
    don't(sub { print &quot;Testing&quot; }, 1) unless $false;
    don't(sub { print &quot;Testing again&quot; }, 1) if $true;</code></pre>

<p>setting off the conditions and making <code>don't</code> do the code. 
A neat trick? We think so.</p>

<h3><a name="where to from here">Where To From Here?</a></h3>
<p>But that's not all! And, of course, this doesn't cater for
some of the more complex constructions people can create, such
as</p>
<pre><code>
    if ($x) {
        do_something();
        don't { do_the_other_thing() };
        do_something_else();
    }</code></pre>
<p>or even</p>
<pre><code>
    if ($x) {
        do_that();
        don't { do_this() }
    } else {
        do_the_other();
        don't { do_something_else() }
    }</code></pre>
<p>But this can be solved in just the same way. For instance, you want to
turn the first one into</p>
<pre><code>
    if ($x) {
        do_something();
        do_something_else();
    } else {
        don't(sub { do_the_other_thing() }, 1);
    }</code></pre>
<p>and the second into</p>
<pre><code>
    if ($x) {
        do_that();
        don't(sub { do_something_else() }, 1);
    } else {
        do_the_other();
        don't(sub { do_this() }, 1);
    }</code></pre>
<p>Both of these transformations can be done by applying the method above:
compare the op trees, work out the difference, find the pattern you want
to look for, then write some code to manipulate the op tree into the
desired output. An easy task for the interested reader ...</p>
<p>And we really haven't scratched the surface of what can be done with 
<code>B::Generate</code> and <code>B::Utils</code>; the <code>B::Generate</code> test suite shows
what sort of mayhem can be caused to existing Perl programs, and there
have been experiments using <code>B::Generate</code> to generate op trees for
other languages - a <code>B::Generate</code> port of Leon Brocard's
<a href="http://www.sourceforge.net/projects/shiny">shiny</a> Ruby interpreter
could produce Perl bytecode for simple Ruby programs; <code>chromatic</code> is
working on an idea to turn Perl programs into XML, manipulate them and
use <code>B::Generate</code> to turn them back into Perl op trees.</p>
<p>Later in our ``Where Wizards Fear To Tread'' series, we'll have articles
about Perl and Java interaction, <code>iThreads</code>, and more.</p>





        </div>



    </div>
    <div class="asset-footer"></div>
</div>


                            
                            <div id="entry-1296" class="entry-asset asset hentry">
    <div class="asset-header">
        <h2 class="asset-name entry-title"><a href="/pub/2002/05/07/mod_perl.html" rel="bookmark">The Perl You Need To Know - Part 2</a></h2>
        <div class="asset-meta">
            <span class="byline">
    
                By <span class="vcard author">Stas Bekman</span> on <abbr class="published" title="2002-05-07T00:00:00-08:00">May  7, 2002 12:00 AM</abbr>
    
            </span>

            
            

        </div>
    </div>
    <div class="asset-content entry-content">

        <div class="asset-body">
            
<!-- sidebar begins -->
<!-- no -->
<!-- sidebar ends -->
<h3><a name="introduction">Introduction</a></h3>
<p>In this article, we continue to talk about the essential Perl basics that you should know before starting to program for mod_perl.</p>


<h3><a name="tracing warnings reports">Tracing Warnings Reports</a></h3>
<p>Sometimes it's hard to understand what a warning is complaining
about.  You see the source code, but you cannot understand why some
specific snippet produces that warning.  The mystery often results from
the fact that the code can be called from different places if it's
located inside a subroutine.</p>
<p>Here is an example:</p>
<pre><code>
  warnings.pl
  -----------
  #!/usr/bin/perl -w

  use strict;

  correct();
  incorrect();

  sub correct{
    print_value(&quot;Perl&quot;);
  }

  sub incorrect{
    print_value();
  }

  sub print_value{
    my $var = shift;
    print &quot;My value is $var\n&quot;;
  }</code></pre>
<p>In the code above, <code>print_value()</code> prints the passed value.  Subroutine
<code>correct()</code> passes the value to print, but in subroutine <code>incorrect()</code> we
forgot to pass it. When we run the script:</p>
<pre><code>
  % ./warnings.pl</code></pre>
<p>we get the warning:</p>
<pre><code>
  Use of uninitialized value at ./warnings.pl line 16.</code></pre>
<p>Perl complains about an undefined variable <code>$var</code> at the line that
attempts to print its value:</p>
<pre><code>
  print &quot;My value is $var\n&quot;;</code></pre>
<p>But how do we know why it is undefined? The reason here obviously is
that the calling function didn't pass the argument. But how do we know
who was the caller? In our example, there are two possible callers, in
the general case there can be many of them, perhaps located in other
files.</p>
<p>We can use the <code>caller()</code> function, which tells who has called us, but
even that might not be enough: It's possible to have a longer sequence
of called subroutines, and not just two. For example, here it is sub
<code>third()</code> which is at fault, and putting sub <code>caller()</code> in sub <code>second()</code>
would not help:</p>
<pre><code>
  sub third{
    second();
  }
  sub second{
    my $var = shift;
    first($var);
  }
  sub first{
    my $var = shift;
   print &quot;Var = $var\n&quot;
  }</code></pre>
<p>The solution is quite simple. What we need is a full calls stack trace
to the call that triggered the warning.</p>
<p>The <code>Carp</code> module comes to our aid with its <code>cluck()</code> function. Let's
modify the script by adding a couple of lines.  The rest of the script
is unchanged.</p>
<pre><code>
  warnings2.pl
  -----------
  #!/usr/bin/perl -w

  use strict;
  use Carp ();
  local $SIG{__WARN__} = \&amp;Carp::cluck;

  correct();
  incorrect();

  sub correct{
    print_value(&quot;Perl&quot;);
  }

  sub incorrect{
    print_value();
  }

  sub print_value{
    my $var = shift;
    print &quot;My value is $var\n&quot;;
  }</code></pre>
<p>Now when we execute it, we see:</p>
<pre><code>
  Use of uninitialized value at ./warnings2.pl line 19.
    main::print_value() called at ./warnings2.pl line 14
    main::incorrect() called at ./warnings2.pl line 7</code></pre>
<p>Take a moment to understand the calls stack trace. The deepest calls
are printed first. So the second line tells us that the warning was
triggered in print_value(); the third, that <code>print_value()</code> was
called by subroutine, incorrect().</p>
<pre><code>
  script =&gt; incorrect() =&gt; print_value()</code></pre>

<table cellspacing="12" cellpadding="0" border="0" align="right" width="200"><tr><td>
<center><img src="/images/pixel-hub.gif" width="200" height="2" hspace="0" vspace="10" border="0" alt=" " /><br />
<center><a href="http://conferences.oreilly.com/oscon/"><img src="/images/os2002/oscon-sidebar.gif" alt="O'Reilly Open Source Convention -- July 22-26, San Diego, CA." width="143" height="78" border="0" /></a></center>
<p class="smalllist"><strong>From the Frontiers of Research to the Heart of the Enterprise</strong></p>
</center>
<p class="secondary"><a href="http://conferences.oreillynet.com/cs/os2002/view/e_sess/3032">mod_perl 2.0, the Next Generation</a>
Stas Bekman will provide an overview of what's new in mod_perl 2.0 and what else is planned for the future in his talk at the upcoming <a href="http://conferences.oreillynet.com/os2002/">O'Reilly Open Source Convention</a>, this July 22-26, in San Diego.</p>
<center><img src="/images/pixel-hub.gif" width="200" height="2" hspace="0" vspace="0" border="0" alt=" " /></center>
</td></tr></table>
<p>We go into <code>incorrect()</code> and indeed see that we forgot to pass the
variable. Of course, when you write a subroutine such as <code>print_value</code>, it
would be a good idea to check the passed arguments before starting
execution. We omitted that step to contrive an easily debugged example.</p>
<p>Sure, you say, I could find that problem by simple inspection of the
code!</p>
<p>Well, you're right. But I promise you that your task would be quite
complicated and time consuming if your code has some thousands of
lines.  In addition, under mod_perl, certain uses of the <code>eval</code>
operator and ``here documents'' are known to throw off Perl's line
numbering, so the messages reporting warnings and errors can have
incorrect line numbers. This can be easily fixed by helping compiler
with <code>#line</code> directive. If you put the following at the beginning of
the line in your script:</p>
<pre><code>
 #line 125</code></pre>
<p>then it will tell the compiler that the <strong>next</strong> line is number 125 for
reporting needs. Of course, the rest of the lines would be adapted as
well.</p>
<p>Getting the trace helps a lot.</p>

<h3><a name="my() scoped variable in nested subroutines"><code>my()</code> Scoped Variable in Nested Subroutines</a></h3>

<p>Before we proceed let's make the assumption that we want to develop
the code under the <code>strict</code> pragma. We will use lexically scoped
variables (with help of the <code>my()</code> operator) whenever it's possible.</p>

<h4><a name="the poison">The Poison</a></h4>
<p>Let's look at this code:</p>
<pre><code>
  nested.pl
  -----------
  #!/usr/bin/perl

  use strict;

  sub print_power_of_2 {
    my $x = shift;

    sub power_of_2 {
      return $x ** 2; 
    }

    my $result = power_of_2();
    print &quot;$x^2 = $result\n&quot;;
  }

  print_power_of_2(5);
  print_power_of_2(6);</code></pre>
<p>Don't let the weird subroutine names fool you, the <code>print_power_of_2()</code>
subroutine should print the square of the number passed to it. Let's
run the code and see whether it works:</p>
<pre><code>
  % ./nested.pl

  5^2 = 25
  6^2 = 25</code></pre>
<p>Ouch, something is wrong. May be there is a bug in Perl and it doesn't
work correctly with the number 6? Let's try again using 5 and 7:</p>
<pre><code>
  print_power_of_2(5);
  print_power_of_2(7);</code></pre>
<p>And run it:</p>
<pre><code>
  % ./nested.pl

  5^2 = 25
  7^2 = 25</code></pre>
<p>Wow, does it works only for 5? How about using 3 and 5:</p>
<pre><code>
  print_power_of_2(3);
  print_power_of_2(5);</code></pre>
<p>and the result is:</p>
<pre><code>
  % ./nested.pl

  3^2 = 9
  5^2 = 9</code></pre>
<p>Now we start to understand -- only the first call to the
<code>print_power_of_2()</code> function works correctly. This makes us think that
our code has some kind of memory for the results of the first
execution, or it ignores the arguments in subsequent executions.</p>


<h4><a name="the diagnosis">The Diagnosis</a></h4>
<p>Let's follow the guidelines and use the <code>-w</code> flag:</p>
<pre><code>
  #!/usr/bin/perl -w</code></pre>
<p>Under Perl version 5.6.0+ we use the <code>warnings</code> pragma:</p>
<pre><code>
  #!/usr/bin/perl
  use warnings;</code></pre>
<p>Now execute the code:</p>
<pre><code>
  % ./nested.pl

  Variable &quot;$x&quot; will not stay shared at ./nested.pl line 9.
  5^2 = 25
  6^2 = 25</code></pre>
<p>We have never seen such a warning message before and we don't quite
understand what it means. The <code>diagnostics</code> pragma will certainly
help us. Let's prepend this pragma before the <code>strict</code> pragma in our
code:</p>
<pre><code>
  #!/usr/bin/perl -w

  use diagnostics;
  use strict;</code></pre>
<p>And execute it:</p>
<pre><code>
  % ./nested.pl
</code></pre>
<p>
  Variable &quot;$x&quot; will not stay shared at ./nested.pl line 10 (#1)
</p>
<p>
    (W) An inner (nested) named subroutine is referencing a lexical
    variable defined in an outer subroutine.
</p>
<p>
    When the inner subroutine is called, it will probably see the value of
    the outer subroutine's variable as it was before and during the
    *first* call to the outer subroutine; in this case, after the first
    call to the outer subroutine is complete, the inner and outer
    subroutines will no longer share a common value for the variable.  In
    other words, the variable will no longer be shared.
</p>
<p>
    Furthermore, if the outer subroutine is anonymous and references a
    lexical variable outside itself, then the outer and inner subroutines
    will never share the given variable.
</p>
<p>
    This problem can usually be solved by making the inner subroutine
    anonymous, using the sub {} syntax.  When inner anonymous subs that
    reference variables in outer subroutines are called or referenced,
    they are automatically rebound to the current values of such
    variables.
<pre><code>
  5^2 = 25
  6^2 = 25</code></pre>
<p>Well, now everything is clear. We have the <strong>inner</strong> subroutine
<code>power_of_2()</code> and the <strong>outer</strong> subroutine <code>print_power_of_2()</code> in our
code.</p>
<p>When the inner <code>power_of_2()</code> subroutine is called for the first time,
it sees the value of the outer <code>print_power_of_2()</code> subroutine's <code>$x</code>
variable. On subsequent calls the inner subroutine's <code>$x</code> variable
won't be updated, no matter what new values are given to <code>$x</code> in the
outer subroutine.  There are two copies of the <code>$x</code> variable, no
longer a single one shared by the two routines.</p>














<h4><a name="the remedy">The Remedy</a></h4>
<p>The <code>diagnostics</code> pragma suggests that the problem can be solved by
making the inner subroutine anonymous.</p>
<p>An anonymous subroutine can act as a <em>closure</em> with respect to
lexically scoped variables. Basically, this means that if you define a
subroutine in a particular <strong>lexical</strong> context at a particular moment,
then it will run in that same context later, even if called from
outside that context.  The upshot of this is that when the subroutine
<strong>runs</strong>, you get the same copies of the lexically scoped variables
that were visible when the subroutine was <strong>defined</strong>.  So you can
pass arguments to a function when you define it, as well as when you
invoke it.</p>
<p>Let's rewrite the code to use this technique:</p>
<pre><code>
  anonymous.pl
  --------------
  #!/usr/bin/perl

  use strict;

  sub print_power_of_2 {
    my $x = shift;

    my $func_ref = sub {
      return $x ** 2;
    };

    my $result = &amp;$func_ref();
    print &quot;$x^2 = $result\n&quot;;
  }

  print_power_of_2(5);
  print_power_of_2(6);</code></pre>
<p>Now <code>$func_ref</code> contains a reference to an anonymous function, which
we later use when we need to get the power of two. (In Perl, a
function is the same thing as a subroutine.) Since it is anonymous,
the function will automatically be rebound to the new value of the
outer scoped variable <code>$x</code>, and the results will now be as expected.</p>
<p>Let's verify:</p>
<pre><code>
  % ./anonymous.pl

  5^2 = 25
  6^2 = 36</code></pre>
<p>So we can see that the problem is solved.</p>


<h3><a name="when you cannot get rid of the inner subroutine">When You Cannot Get Rid of the Inner Subroutine</a></h3>
<p>First, you might wonder, why in the world will someone need to define
an inner subroutine? Well, for example, to reduce some of Perl's script
startup overhead you might decide to write a daemon that will compile
the scripts and modules only once, and cache the pre-compiled code in
memory. When some script is to be executed, you just tell the daemon
the name of the script to run and it will do the rest and do it much
faster since compilation has already taken place.</p>
<p>Seems like an easy task; and it is. The only problem is once the
script is compiled, how do you execute it? Or let's put it another
way: After it was executed for the first time and it stays compiled in
the daemon's memory, how do you call it again? If you could get all
developers to code their scripts so each has a subroutine called <code>run()</code>
that will actually execute the code in the script, then we've solved
half the problem.</p>
<p>But how does the daemon know to refer to some specific script if they
all run in the <code>main::</code> name space? One solution might be to ask the
developers to declare a package in each and every script, and for the
package name to be derived from the script name. However, since there
is a chance that there will be more than one script with the same name
but residing in different directories, then in order to prevent
namespace collisions the directory has to be a part of the package
name, too. And don't forget that the script may be moved from one
directory to another, so you will have to make sure that the package
name is corrected each time the script gets moved.</p>
<p>But why enforce these strange rules on developers, when we can arrange
for our daemon to do this work? For every script that the daemon is
about to execute for the first time, the script should be wrapped
inside the package whose name is constructed from the mangled path to
the script and a subroutine called run(). For example, if the daemon is
about to execute the script <em>/tmp/hello.pl</em>:</p>
<pre><code>
  hello.pl
  --------
  #!/usr/bin/perl
  print &quot;Hello\n&quot;;</code></pre>
<p>then prior to running it, the daemon will change the code to be:</p>
<pre><code>
  wrapped_hello.pl
  ----------------
  package cache::tmp::hello_2epl;

  sub run{
    #!/usr/bin/perl 
    print &quot;Hello\n&quot;;
  }</code></pre>
<p>The package name is constructed from the prefix <code>cache::</code>, each
directory separation slash is replaced with <code>::</code>, and nonalphanumeric characters are encoded so that for example <code>.</code> (a dot)
becomes <code>_2e</code> (an underscore followed by the ASCII code for a dot in
hex representation).</p>
<pre><code>
 % perl -e 'printf &quot;%x&quot;,ord(&quot;.&quot;)'</code></pre>
<p>prints: <code>2e</code>. The underscore is the same you see in URL encoding
except the <code>%</code> character is used instead (<code>%2E</code>), but since <code>%</code> has
a special meaning in Perl (prefix of hash variable) it couldn't be
used.</p>
<p>Now when the daemon is requested to execute the script
<em>/tmp/hello.pl</em>, all it has to do is to build the package name as
before based on the location of the script and call its <code>run()</code>
subroutine:</p>
<pre><code>
  use cache::tmp::hello_2epl;
  cache::tmp::hello_2epl::run();</code></pre>
<p>We have just written a partial prototype of the daemon we wanted. The
only outstanding problem is how to pass the path to the script to the
daemon. This detail is left as an exercise for the reader.</p>
<p>If you are familiar with the <code>Apache::Registry</code> module, then you know that
it works in almost the same way. It uses a different package prefix
and the generic function is called <code>handler()</code> and not run(). The
scripts to run are passed through the HTTP protocol's headers.</p>
<p>Now you understand that there are cases where your normal subroutines
can become inner, since if your script was a simple:</p>
<pre><code>
  simple.pl
  ---------
  #!/usr/bin/perl 
  sub hello { print &quot;Hello&quot; }
  hello();</code></pre>
<p>Wrapped into a <code>run()</code> subroutine it becomes:</p>
<pre><code>
  simple.pl
  ---------
  package cache::simple_2epl;

  sub run{
    #!/usr/bin/perl 
    sub hello { print &quot;Hello&quot; }
    hello();
  }</code></pre>
<p>Therefore, <code>hello()</code> is an inner subroutine and if you have used <code>my()</code>
scoped variables defined and altered outside and used inside hello(),
it won't work as you expect starting from the second call, as was
explained in the previous section.</p>


<h4><a name="remedies for inner subroutines">Remedies for Inner Subroutines</a></h4>
<p>First of all, there is nothing to worry about, as long as you don't
forget to turn the warnings On.  If you do happen to have the <em>``my()
Scoped Variable in Nested Subroutines''</em> problem, then Perl will always
alert you.</p>
<p>Given that you have a script that has this problem, what are the ways
to solve it? There are many of them and we will discuss some of them
here.</p>
<p>We will use the following code to show the different solutions.</p>
<pre><code>
  multirun.pl
  -----------
  #!/usr/bin/perl -w

  use strict;

  for (1..3){
    print &quot;run: [time $_]\n&quot;;
    run();
  }

  sub run{
    my $counter = 0;

    increment_counter();
    increment_counter();

    sub increment_counter{
      $counter++;
      print &quot;Counter is equal to $counter !\n&quot;;
    }

  } # end of sub run</code></pre>
<p>This code executes the <code>run()</code> subroutine three times, which in turn
initializes the <code>$counter</code> variable to 0 each time it is executed
and then calls the inner subroutine <code>increment_counter()</code> twice. Sub
<code>increment_counter()</code> prints <code>$counter</code>'s value after incrementing
it. One might expect to see the following output:</p>
<pre><code>
  run: [time 1]
  Counter is equal to 1 !
  Counter is equal to 2 !
  run: [time 2]
  Counter is equal to 1 !
  Counter is equal to 2 !
  run: [time 3]
  Counter is equal to 1 !
  Counter is equal to 2 !</code></pre>
<p>But as we have already learned from the previous sections, this is not
what we are going to see. Indeed, when we run the script we see:</p>
<pre><code>
  % ./multirun.pl
  Variable &quot;$counter&quot; will not stay shared at ./nested.pl line 18.
  run: [time 1]
  Counter is equal to 1 !
  Counter is equal to 2 !
  run: [time 2]
  Counter is equal to 3 !
  Counter is equal to 4 !
  run: [time 3]
  Counter is equal to 5 !
  Counter is equal to 6 !</code></pre>
<p>Obviously, the <code>$counter</code> variable is not reinitialized on each
execution of run(). It retains its value from the previous execution,
and sub <code>increment_counter()</code> increments that.</p>
<p>One of the workarounds is to use globally declared variables, with the
<code>vars</code> pragma.</p>
<pre><code>
  multirun1.pl
  -----------
  #!/usr/bin/perl -w

  use strict;
  use vars qw($counter);

  for (1..3){
    print &quot;run: [time $_]\n&quot;;
    run();
  }

  sub run {

    $counter = 0;

    increment_counter();
    increment_counter();

    sub increment_counter{
      $counter++;
      print &quot;Counter is equal to $counter !\n&quot;;
    }

  } # end of sub run</code></pre>
<p>If you run this and the other solutions offered below, then the expected
output will be generated:</p>
<pre><code>
  % ./multirun1.pl

  run: [time 1]
  Counter is equal to 1 !
  Counter is equal to 2 !
  run: [time 2]
  Counter is equal to 1 !
  Counter is equal to 2 !
  run: [time 3]
  Counter is equal to 1 !
  Counter is equal to 2 !</code></pre>
<p>By the way, the warning we saw before has gone, and so has the
problem, since there is no <code>my()</code> (lexically defined) variable used
in the nested subroutine.</p>












<p>Another approach is to use fully qualified variables. This is better,
since less memory will be used, but it adds a typing overhead:</p>
<pre><code>
  multirun2.pl
  -----------
  #!/usr/bin/perl -w

  use strict;

  for (1..3){
    print &quot;run: [time $_]\n&quot;;
    run();
  }

  sub run {

    $main::counter = 0;

    increment_counter();
    increment_counter();

    sub increment_counter{
      $main::counter++;
      print &quot;Counter is equal to $main::counter !\n&quot;;
    }

  } # end of sub run</code></pre>
<p>You can also pass the variable to the subroutine by value and make the
subroutine return it after it was updated. This adds time and memory
overheads, so it may not be good idea if the variable can be very
large, or if speed of execution is an issue.</p>
<p>Don't rely on the fact that the variable is small during the
development of the application, it can grow quite big in situations
you don't expect. For example, a simple HTML form text entry
field can return a few megabytes of data if one of your users is bored
and wants to test how good your code is. It's not uncommon to see
users copy-and-paste 10Mb core dump files into a form's text fields
and then submit it for your script to process.</p>
<pre><code>
  multirun3.pl
  -----------
  #!/usr/bin/perl -w

  use strict;

  for (1..3){
    print &quot;run: [time $_]\n&quot;;
    run();
  }

  sub run {

    my $counter = 0;

    $counter = increment_counter($counter);
    $counter = increment_counter($counter);

    sub increment_counter{
      my $counter = shift;

      $counter++;
      print &quot;Counter is equal to $counter !\n&quot;;

      return $counter;
    }

  } # end of sub run</code></pre>
<p>Finally, you can use references to do the job. The version of
<code>increment_counter()</code> below accepts a reference to the <code>$counter</code>
variable and increments its value after first dereferencing it. When
you use a reference, the variable you use inside the function is
physically the same bit of memory as the one outside the function.
This technique is often used to enable a called function to modify
variables in a calling function.</p>
<pre><code>
  multirun4.pl
  -----------
  #!/usr/bin/perl -w

  use strict;

  for (1..3){
    print &quot;run: [time $_]\n&quot;;
    run();
  }

  sub run {

    my $counter = 0;

    increment_counter(\$counter);
    increment_counter(\$counter);

    sub increment_counter{
      my $r_counter = shift;

      $$r_counter++;
      print &quot;Counter is equal to $$r_counter !\n&quot;;
    }

  } # end of sub run</code></pre>
<p>Here is yet another and more obscure reference usage. We modify the
value of <code>$counter</code> inside the subroutine by using the fact that
variables in <code>@_</code> are aliases for the actual scalar parameters. Thus
if you called a function with two arguments, then those would be stored in
<code>$_[0]</code> and <code>$_[1]</code>. In particular, if an element <code>$_[0]</code> is
updated, then the corresponding argument is updated (or an error occurs if
it is not updatable as would be the case of calling the function with
a literal, e.g. <em>increment_counter(5)</em>).</p>
<pre><code>
  multirun5.pl
  -----------
  #!/usr/bin/perl -w

  use strict;

  for (1..3){
    print &quot;run: [time $_]\n&quot;;
    run();
  }

  sub run {

    my $counter = 0;

    increment_counter($counter);
    increment_counter($counter);

    sub increment_counter{
      $_[0]++;
      print &quot;Counter is equal to $_[0] !\n&quot;;
    }

  } # end of sub run</code></pre>
<p>The approach given above is generally not recommended because most
Perl programmers will not expect <code>$counter</code> to be changed by the
function; the example where we used <code>\$counter</code>,
i.e. pass-by-reference would be preferred.</p>
<p>Here is a solution that avoids the problem entirely by splitting the
code into two files: The first is really just a wrapper and loader,
the second file contains the heart of the code.</p>
<pre><code>
  multirun6.pl
  -----------
  #!/usr/bin/perl -w

  use strict;
  require 'multirun6-lib.pl' ;

  for (1..3){
    print &quot;run: [time $_]\n&quot;;
    run();
  }</code></pre>
<p>Separate file:</p>
<pre><code>
  multirun6-lib.pl
  ----------------
  use strict ;

  my $counter;
  sub run {
    $counter = 0;
    increment_counter();
    increment_counter();
  }

  sub increment_counter{
    $counter++;
    print &quot;Counter is equal to $counter !\n&quot;;
  }

  1 ;</code></pre>
<p>Now you have at least six workarounds to choose from.</p>
<p>For more information, please refer to perlref and perlsub manpages.</p>

<table width="150" border="0" cellspacing="0" cellpadding="4" align="right">
<tr> 
<td width="150" valign="top" height="4" bgcolor="#6699cc"></td></tr> 
<tr>
<td bgcolor="#efefef">
<p class="headline" align="center">Previously in the Series
</p>
<p class="secondary">
<a href="/pub/a/2002/04/23/mod_perl.html">The Perl You Need To Know</a><br /><br />
<a href="/pub/a/2002/04/10/mod_perl.html">Installing mod_perl without superuser privileges</a><br /><br />
<a href="/pub/a/2002/03/22/modperl.html">mod_perl in 30 minutes</a><br /><br />
<a href="/pub/a/2002/02/26/whatismodperl.html">Why mod_perl?</a>


</td></tr> <tr><td width="150" valign="top" height="4" bgcolor="#6699cc"> </td></tr></table>

<h3><a name="perldoc's rarely known but very useful options">perldoc's Rarely Known But Very Useful Options</a></h3>
<p>It's a known fact that one cannot become a Perl hacker and especially
mod_perl hacker without knowing how to read Perl documentation and
search through it.  Books are good, but an easily accessible and
searchable Perl reference at your fingertips is a great time saver. It
always has the up-to-date information for the version of perl you're
using.</p>
<p>Of course, you can use online Perl documentation at the Web. I prefer
<a href="http://theoryx5.uwinnipeg.ca/CPAN/perl/">http://theoryx5.uwinnipeg.ca/CPAN/perl/</a> to the official URL:
<a href="/pub/v/documentation">http://www.perl.com/pub/v/documentation</a> is very slow :( . The
<code>perldoc</code> utility provides you with access to the documentation
installed on your system.  To find out what Perl manpages are
available execute:</p>
<pre><code>
  % perldoc perl</code></pre>
<p>To find what functions perl has, execute:</p>
<pre><code>
  % perldoc perlfunc</code></pre>
<p>To learn the syntax and to find examples of a specific function, you
would execute (e.g. for <code>open()</code>):</p>
<pre><code>
  % perldoc -f open</code></pre>
<p>Note: In perl5.005_03 and earlier, there is a bug in this and the
<code>-q</code> options of <code>perldoc</code>.  It won't call <code>pod2man</code>, but will
display the section in POD format instead.  Despite this bug it's
still readable and very useful.</p>
<p>The Perl FAQ (<em>perlfaq</em> manpage) is in several sections.  To search
through the sections for <code>open</code> you would execute:</p>
<pre><code>
  % perldoc -q open</code></pre>
<p>This will show you all the matching question-and-answer sections,
still in POD format.</p>
<p>To read the <em>perldoc</em> manpage you would execute:</p>
<pre><code>
  % perldoc perldoc</code></pre>

<h3><a name="references">References</a></h3>
<ul>
<li>
Online documentation:
<a href="http://theoryx5.uwinnipeg.ca/CPAN/perl/">http://theoryx5.uwinnipeg.ca/CPAN/perl/</a>
<a href="/pub/v/documentation/">http://www.perl.com/pub/v/documentation/</a>
<p></p>
<li>
The book ``<em>Programming Perl</em>'' 3rd edition by L.Wall, T. Christiansen
and J.Orwant (also known as the ``<em>Camel</em>'' book, named after the camel
picture on the cover of the book). You want to refer to Chapter 8 that
talks about nested subroutines among other things.
<p></p>
<li>
The <em>perlref</em> and <em>perlsub</em> man pages.
<p></p></ul>



        </div>



    </div>
    <div class="asset-footer"></div>
</div>




                            <div class="content-nav">
                                <a href="/pub/2002/04/">&laquo; April 2002</a> |
                                <a href="/pub/">Main Index</a> |
                                <a href="/pub/archives.html">Archives</a>
                                | <a href="/pub/2002/06/">June 2002 &raquo;</a>
                            </div>


                        </div>
                    </div>


                    <div id="beta">
    <div id="beta-inner">


    
    <div class="widget-what-is-perl widget">
    <div class="widget-content widget-content-what-is-perl">
       Visit the home of the  Perl programming language: <a href="http://www.perl.org/">Perl.org</a
    </div>
</div>
<div class="widget-find-out-more widget-archives widget">
    <div class="widget-content">
        <ul>
            <li><a href="http://www.perl.org/get.html">Download</a></li>
            <li><a href="http://perldoc.perl.org/">Documentation</a></li>
            <li><a href="http://blogs.perl.org/">Perl Bloggers</a></li>
            <li><a href="http://news.perlfoundation.org/">Foundation News</a></li>
        </ul>
    </div>
</div><div class="widget-tcpc widget">
<h3 class="widget-header">Sponsored by</h3>
    <div class="widget-content">
        <a href="http://training.perl.com/" alt="Perl Training" target="_blank"><img src="/i/tcpc.png" width="150" height="50"></a>
    </div>
</div>

<div class="widget-syndication widget">
    <div class="widget-content">
        <ul>
            <li><img src="/mt-static/images/status_icons/feed.gif" alt="Subscribe to feed" width="9" height="9" /> <a href="/pub/atom.xml">Subscribe to this website's feed</a></li>

        </ul>
    </div>
</div>
<div class="widget-archive-monthly widget-archive widget">
    <h3 class="widget-header">Monthly <a href="/pub/archives.html">Archives</a></h3>
    <div class="widget-content">
        <ul>
        
            <li><a href="/pub/2014/02/">February 2014 (1)</a></li>
        
    
        
            <li><a href="/pub/2014/01/">January 2014 (1)</a></li>
        
    
        
            <li><a href="/pub/2013/10/">October 2013 (1)</a></li>
        
    
        
            <li><a href="/pub/2013/01/">January 2013 (1)</a></li>
        
    
        
            <li><a href="/pub/2012/12/">December 2012 (1)</a></li>
        
    
        
            <li><a href="/pub/2012/11/">November 2012 (1)</a></li>
        
    
        
            <li><a href="/pub/2012/10/">October 2012 (2)</a></li>
        
    
        
            <li><a href="/pub/2012/08/">August 2012 (2)</a></li>
        
    
        
            <li><a href="/pub/2012/06/">June 2012 (11)</a></li>
        
    
        
            <li><a href="/pub/2012/05/">May 2012 (18)</a></li>
        
    
        
            <li><a href="/pub/2012/04/">April 2012 (17)</a></li>
        
    
        
            <li><a href="/pub/2012/02/">February 2012 (1)</a></li>
        
    
        
            <li><a href="/pub/2011/12/">December 2011 (1)</a></li>
        
    
        
            <li><a href="/pub/2011/09/">September 2011 (1)</a></li>
        
    
        
            <li><a href="/pub/2011/08/">August 2011 (2)</a></li>
        
    
        
            <li><a href="/pub/2011/06/">June 2011 (1)</a></li>
        
    
        
            <li><a href="/pub/2011/05/">May 2011 (3)</a></li>
        
    
        
            <li><a href="/pub/2011/04/">April 2011 (1)</a></li>
        
    
        
            <li><a href="/pub/2011/03/">March 2011 (1)</a></li>
        
    
        
            <li><a href="/pub/2011/02/">February 2011 (1)</a></li>
        
    
        
            <li><a href="/pub/2011/01/">January 2011 (1)</a></li>
        
    
        
            <li><a href="/pub/2010/11/">November 2010 (1)</a></li>
        
    
        
            <li><a href="/pub/2010/10/">October 2010 (2)</a></li>
        
    
        
            <li><a href="/pub/2010/09/">September 2010 (1)</a></li>
        
    
        
            <li><a href="/pub/2010/08/">August 2010 (3)</a></li>
        
    
        
            <li><a href="/pub/2010/07/">July 2010 (2)</a></li>
        
    
        
            <li><a href="/pub/2010/04/">April 2010 (2)</a></li>
        
    
        
            <li><a href="/pub/2010/03/">March 2010 (4)</a></li>
        
    
        
            <li><a href="/pub/2008/05/">May 2008 (1)</a></li>
        
    
        
            <li><a href="/pub/2008/04/">April 2008 (2)</a></li>
        
    
        
            <li><a href="/pub/2008/03/">March 2008 (1)</a></li>
        
    
        
            <li><a href="/pub/2008/02/">February 2008 (1)</a></li>
        
    
        
            <li><a href="/pub/2008/01/">January 2008 (1)</a></li>
        
    
        
            <li><a href="/pub/2007/12/">December 2007 (2)</a></li>
        
    
        
            <li><a href="/pub/2007/09/">September 2007 (1)</a></li>
        
    
        
            <li><a href="/pub/2007/08/">August 2007 (1)</a></li>
        
    
        
            <li><a href="/pub/2007/07/">July 2007 (1)</a></li>
        
    
        
            <li><a href="/pub/2007/06/">June 2007 (1)</a></li>
        
    
        
            <li><a href="/pub/2007/05/">May 2007 (1)</a></li>
        
    
        
            <li><a href="/pub/2007/04/">April 2007 (1)</a></li>
        
    
        
            <li><a href="/pub/2007/03/">March 2007 (1)</a></li>
        
    
        
            <li><a href="/pub/2007/02/">February 2007 (1)</a></li>
        
    
        
            <li><a href="/pub/2007/01/">January 2007 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/12/">December 2006 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/11/">November 2006 (2)</a></li>
        
    
        
            <li><a href="/pub/2006/10/">October 2006 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/09/">September 2006 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/08/">August 2006 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/07/">July 2006 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/06/">June 2006 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/05/">May 2006 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/04/">April 2006 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/03/">March 2006 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/02/">February 2006 (4)</a></li>
        
    
        
            <li><a href="/pub/2006/01/">January 2006 (4)</a></li>
        
    
        
            <li><a href="/pub/2005/12/">December 2005 (4)</a></li>
        
    
        
            <li><a href="/pub/2005/11/">November 2005 (3)</a></li>
        
    
        
            <li><a href="/pub/2005/10/">October 2005 (2)</a></li>
        
    
        
            <li><a href="/pub/2005/09/">September 2005 (2)</a></li>
        
    
        
            <li><a href="/pub/2005/08/">August 2005 (9)</a></li>
        
    
        
            <li><a href="/pub/2005/07/">July 2005 (8)</a></li>
        
    
        
            <li><a href="/pub/2005/06/">June 2005 (9)</a></li>
        
    
        
            <li><a href="/pub/2005/05/">May 2005 (8)</a></li>
        
    
        
            <li><a href="/pub/2005/04/">April 2005 (7)</a></li>
        
    
        
            <li><a href="/pub/2005/03/">March 2005 (6)</a></li>
        
    
        
            <li><a href="/pub/2005/02/">February 2005 (7)</a></li>
        
    
        
            <li><a href="/pub/2005/01/">January 2005 (6)</a></li>
        
    
        
            <li><a href="/pub/2004/12/">December 2004 (8)</a></li>
        
    
        
            <li><a href="/pub/2004/11/">November 2004 (8)</a></li>
        
    
        
            <li><a href="/pub/2004/10/">October 2004 (5)</a></li>
        
    
        
            <li><a href="/pub/2004/09/">September 2004 (9)</a></li>
        
    
        
            <li><a href="/pub/2004/08/">August 2004 (6)</a></li>
        
    
        
            <li><a href="/pub/2004/07/">July 2004 (8)</a></li>
        
    
        
            <li><a href="/pub/2004/06/">June 2004 (6)</a></li>
        
    
        
            <li><a href="/pub/2004/05/">May 2004 (7)</a></li>
        
    
        
            <li><a href="/pub/2004/04/">April 2004 (8)</a></li>
        
    
        
            <li><a href="/pub/2004/03/">March 2004 (8)</a></li>
        
    
        
            <li><a href="/pub/2004/02/">February 2004 (9)</a></li>
        
    
        
            <li><a href="/pub/2004/01/">January 2004 (7)</a></li>
        
    
        
            <li><a href="/pub/2003/12/">December 2003 (4)</a></li>
        
    
        
            <li><a href="/pub/2003/11/">November 2003 (7)</a></li>
        
    
        
            <li><a href="/pub/2003/10/">October 2003 (8)</a></li>
        
    
        
            <li><a href="/pub/2003/09/">September 2003 (6)</a></li>
        
    
        
            <li><a href="/pub/2003/08/">August 2003 (7)</a></li>
        
    
        
            <li><a href="/pub/2003/07/">July 2003 (9)</a></li>
        
    
        
            <li><a href="/pub/2003/06/">June 2003 (9)</a></li>
        
    
        
            <li><a href="/pub/2003/05/">May 2003 (8)</a></li>
        
    
        
            <li><a href="/pub/2003/04/">April 2003 (8)</a></li>
        
    
        
            <li><a href="/pub/2003/03/">March 2003 (10)</a></li>
        
    
        
            <li><a href="/pub/2003/02/">February 2003 (8)</a></li>
        
    
        
            <li><a href="/pub/2003/01/">January 2003 (8)</a></li>
        
    
        
            <li><a href="/pub/2002/12/">December 2002 (5)</a></li>
        
    
        
            <li><a href="/pub/2002/11/">November 2002 (9)</a></li>
        
    
        
            <li><a href="/pub/2002/10/">October 2002 (7)</a></li>
        
    
        
            <li><a href="/pub/2002/09/">September 2002 (11)</a></li>
        
    
        
            <li><a href="/pub/2002/08/">August 2002 (8)</a></li>
        
    
        
            <li><a href="/pub/2002/07/">July 2002 (8)</a></li>
        
    
        
            <li><a href="/pub/2002/06/">June 2002 (4)</a></li>
        
    
        
            <li><a href="/pub/2002/05/">May 2002 (6)</a></li>
        
    
        
            <li><a href="/pub/2002/04/">April 2002 (6)</a></li>
        
    
        
            <li><a href="/pub/2002/03/">March 2002 (7)</a></li>
        
    
        
            <li><a href="/pub/2002/02/">February 2002 (5)</a></li>
        
    
        
            <li><a href="/pub/2002/01/">January 2002 (8)</a></li>
        
    
        
            <li><a href="/pub/2001/12/">December 2001 (7)</a></li>
        
    
        
            <li><a href="/pub/2001/11/">November 2001 (5)</a></li>
        
    
        
            <li><a href="/pub/2001/10/">October 2001 (9)</a></li>
        
    
        
            <li><a href="/pub/2001/09/">September 2001 (7)</a></li>
        
    
        
            <li><a href="/pub/2001/08/">August 2001 (13)</a></li>
        
    
        
            <li><a href="/pub/2001/07/">July 2001 (8)</a></li>
        
    
        
            <li><a href="/pub/2001/06/">June 2001 (13)</a></li>
        
    
        
            <li><a href="/pub/2001/05/">May 2001 (11)</a></li>
        
    
        
            <li><a href="/pub/2001/04/">April 2001 (9)</a></li>
        
    
        
            <li><a href="/pub/2001/03/">March 2001 (8)</a></li>
        
    
        
            <li><a href="/pub/2001/02/">February 2001 (8)</a></li>
        
    
        
            <li><a href="/pub/2001/01/">January 2001 (8)</a></li>
        
    
        
            <li><a href="/pub/2000/12/">December 2000 (6)</a></li>
        
    
        
            <li><a href="/pub/2000/11/">November 2000 (10)</a></li>
        
    
        
            <li><a href="/pub/2000/10/">October 2000 (10)</a></li>
        
    
        
            <li><a href="/pub/2000/09/">September 2000 (2)</a></li>
        
    
        
            <li><a href="/pub/2000/08/">August 2000 (2)</a></li>
        
    
        
            <li><a href="/pub/2000/07/">July 2000 (5)</a></li>
        
    
        
            <li><a href="/pub/2000/06/">June 2000 (7)</a></li>
        
    
        
            <li><a href="/pub/2000/05/">May 2000 (7)</a></li>
        
    
        
            <li><a href="/pub/2000/04/">April 2000 (3)</a></li>
        
    
        
            <li><a href="/pub/2000/03/">March 2000 (2)</a></li>
        
    
        
            <li><a href="/pub/2000/02/">February 2000 (2)</a></li>
        
    
        
            <li><a href="/pub/2000/01/">January 2000 (2)</a></li>
        
    
        
            <li><a href="/pub/1999/12/">December 1999 (6)</a></li>
        
    
        
            <li><a href="/pub/1999/11/">November 1999 (6)</a></li>
        
    
        
            <li><a href="/pub/1999/10/">October 1999 (5)</a></li>
        
    
        
            <li><a href="/pub/1999/09/">September 1999 (4)</a></li>
        
    
        
            <li><a href="/pub/1999/08/">August 1999 (3)</a></li>
        
    
        
            <li><a href="/pub/1999/07/">July 1999 (2)</a></li>
        
    
        
            <li><a href="/pub/1999/06/">June 1999 (3)</a></li>
        
    
        
            <li><a href="/pub/1999/04/">April 1999 (1)</a></li>
        
    
        
            <li><a href="/pub/1999/03/">March 1999 (1)</a></li>
        
    
        
            <li><a href="/pub/1999/01/">January 1999 (1)</a></li>
        
    
        
            <li><a href="/pub/1998/12/">December 1998 (1)</a></li>
        
    
        
            <li><a href="/pub/1998/11/">November 1998 (1)</a></li>
        
    
        
            <li><a href="/pub/1998/07/">July 1998 (2)</a></li>
        
    
        
            <li><a href="/pub/1998/06/">June 1998 (1)</a></li>
        
    
        
            <li><a href="/pub/1998/03/">March 1998 (1)</a></li>
        
        </ul>
    </div>
</div>
        
    

<div class="widget-powered widget">
    <div class="widget-content">
        <a href="http://www.movabletype.com/"><img src="/mt-static/images/bug-pbmt-white.png" alt="Powered by Movable Type 5.13-en" width="120" height="75" /></a>
    </div>
</div>



    </div>
</div>






                </div>
            </div>


            <div id="footer">
    <div id="footer-inner">
        <div id="footer-content">
            <div class="widget-powered widget">
                <div class="widget-content">
                    Powered by <a href="http://www.movabletype.com/" rel="generator">Movable Type Pro</a>
                </div>
            </div>

            <div class="widget-creative-commons widget">
                <div class="widget-content">
                    This blog is licensed under a <a href="http://creativecommons.org/licenses/by-nc-nd/3.0/">Creative Commons License</a>.
                </div>
            </div>

        </div>
    </div>
</div>



        </div>
    </div>
</body>
</html>
