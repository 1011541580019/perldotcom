<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" id="sixapart-standard">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="generator" content="Movable Type Pro 5.13-en" />
<link rel="stylesheet" href="/pub/styles.css" type="text/css" />
<link rel="start" href="/pub/" title="Home" />
<link rel="alternate" type="application/atom+xml" title="Recent Entries" href="/pub/atom.xml" />
<script type="text/javascript" src="/pub/mt.js"></script>
<!--
<rdf:RDF xmlns="http://web.resource.org/cc/"
         xmlns:dc="http://purl.org/dc/elements/1.1/"
         xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#">
<Work rdf:about="/pub/">
<dc:title>Perl.com</dc:title>
<dc:description>news and views of the Perl programming language</dc:description>
<license rdf:resource="http://creativecommons.org/licenses/by-nc-nd/3.0/" />
</Work>
<License rdf:about="http://creativecommons.org/licenses/by-nc-nd/3.0/">
</License>
</rdf:RDF>
-->

<script type="text/javascript">

 var _gaq = _gaq || [];
 _gaq.push(['_setAccount', 'UA-50555-22']);
 _gaq.push(['_trackPageview']);

 (function() {
   var ga = document.createElement('script'); ga.type =
   'text/javascript'; ga.async = true;
   ga.src = ('https:' == document.location.protocol ? 'https://ssl' :
   'http://www') + '.google-analytics.com/ga.js';
   var s = document.getElementsByTagName('script')[0];
   s.parentNode.insertBefore(ga, s);
 })();

</script>
<script type='text/javascript' src='http://partner.googleadservices.com/gampad/google_service.js'></script>
<script type='text/javascript'>
GS_googleAddAdSenseService("ca-pub-4136420132070439");
GS_googleEnableAllServices();
</script>
<script type='text/javascript'>
GA_googleAddSlot("ca-pub-4136420132070439", "Perl_728x90");
</script>
<script type='text/javascript'>GA_googleFetchAds();</script>
    <title>Perl.com: March 2001 Archives</title>


    <link rel="prev" href="/pub/2001/02/" title="February 2001" />
    <link rel="next" href="/pub/2001/04/" title="April 2001" />

</head>
<body id="perl-com" class="mt-archive-listing mt-datebased-monthly-archive layout-wt">
    <div id="container">
        <div id="container-inner">


            <div id="header">
    <div id="header-inner">
        <div id="header-content">
        <span id="top_advert"> 
<!-- Put any landscape advert in here -->
<!-- Perl_728x90 -->
<script type='text/javascript'>
GA_googleFillSlot("Perl_728x90");
</script>
        </span> 



            <div id="header-name"><a href="/pub/" accesskey="1">Perl.com</a></div>
            <div id="header-description">news and views of the Perl programming language</div>




        </div>
    </div>
</div>



            <div id="content">
                <div id="content-inner">


                    <div id="alpha">
                        <div id="alpha-inner">


                            <h1 id="page-title" class="archive-title">March 2001 Archives</h1>





                            
                            <div id="entry-1468" class="entry-asset asset hentry">
    <div class="asset-header">
        <h2 class="asset-name entry-title"><a href="/pub/2001/03/27/gnome.html" rel="bookmark">A Simple Gnome Panel Applet</a></h2>
        <div class="asset-meta">
            <span class="byline">
    
                By <span class="vcard author">Joe Nasal</span> on <abbr class="published" title="2001-03-27T00:00:00-08:00">March 27, 2001 12:00 AM</abbr>
    
            </span>

            
            

        </div>
    </div>
    <div class="asset-content entry-content">

        <div class="asset-body">
            <!-- A Simple Gnome Panel Applet -->

<br />

<p><table width="180" cellspacing="0" cellpadding="4" align="right" border="1">
<tr>
<td align="center" valign="top" bgcolor="#6699cc">
<font color="#ffffff">Table of Contents</td>
</tr>

<tr>
<td>
<p class="fine">
&#149;<a href="#overview">Program overview</a><br />
&#149;<a href="#intialization">Initialization</a><br />
&#149;<a href="#callbacks">The callbacks</a><br />
&#149;<a href="#conclusion">Conclusion</a><br />


</td>
</tr>
</p>
</table>

<p>Gnome is the desktop environment of choice on my home Linux system
because it is feature-packed and user friendly.  Gnome is also
flexible, and thanks to the Gtk-Perl module and associated desktop
toolkit bindings, I can use my favorite programming language to further
customize and extend my Gnome environment.</p>

<p>This article shows how a useful Gnome tool can be built in an
afternoon.  It is also an example of some common techniques to employ when doing this sort of GUI programming, including widget
creation, signal handling, timers, and event loops.  It also covers
some Perl basics, in review.  So, read on and you may be inspired to write some Gnome applications of your
own.</p>

<p><a href="/2001/03/27/ping_gateway.pl">Download the source code</a> referred to in this article.

<h3>Gnome</h3>

<p>On a Gnome desktop, the panel contains a variety of buttons and other
widgets which serve to launch applications, display menus, and other common functions.  It's
standard desktop fare, like the Microsoft Windows Start menu.</p>

<p>An <i>applet</i> is a particular kind of Gnome application, which resides 
within and operates on the panel itself. The Gnome distribution comes 
with several of these including a variety of clocks, the Game of Life, and system 
resource utilization monitors. The Gtk-Perl module enables a Perl 
programmer to create custom Gnome panel applets, and many
other GUI-related applications.</p>

<p>The Gnome panel applet we'll build finds the local host's default
TCP/IP gateway and displays the gateway's status on a button in the applet.  When the button is in an "off" position the gateway is not
polled (Figure 1).</p>


<p>
<img src="/pub/2001/03/27/graphics/figure1.jpg" border="0" alt="Gnome gateway not polled"><br /><br /><b>Fig. 1: Gnome Gateway in the "off" position.</b></p>

<p>When the button is on, the gateway is polled at
scheduled intervals and the button's label is updated with the result: (Figures 2a &amp; 2b)
response or non-response.</p>


<p>
<img src="/pub/2001/03/27/graphics/figure2.jpg" border="0" alt="Gnome gateway polled"><br /><br />
<b>Fig. 2a: Gnome Gateway in the "on" position.</b></p>

<img src="/pub/2001/03/27/graphics/figure2b.jpg" border="0" alt="Gnome gateway polled"><br /><br />
<b>Fig. 2b: Gnome Gateway not available.</b></p>




<p>This diagnostic may be
used to regularly and unobtrusively report the status of the local
network relative to the machine's default gateway.  Check the button's
label to see how things are faring on the upstream network.</p>

<p>The applet uses the system commands <code>netstat</code> and <code>ping</code> familiar to
Unix users, and system and network admins.</p>

<h3><a name="overview">Program overview</a></h3>

<p>The top-level code in the script is lines 1 through 21.  Lines 23
through 69 define subroutines.  One subroutine is called by our
code (<code>fetch_gateway</code>), but two others are "callbacks" (<code>check_gateway</code>
and <code>reset_state</code>).  A callback is a subroutine that will be called by
the Gnome code when something happens -- for example, a timer expires or button gets clicked.  Now, let's see what we can learn about how the application
works.</p>

<h3><a name="intialization">Initialization</a></h3>

<p>Line 3 indicates that we'll be using the Gnome module.  <code>Gnome.pm</code> is distributed with the Gtk-Perl package. The program discussed here has developed against Gtk-Perl version 0.7003.  <code>Gnome.pm</code> requires separate installation: download and unpack Gtk-Perl, install it, and then change directories into the GdkImlib and Gnome distribution and install them too.  
If you want to develop panel applets (as we're doing here) you'll need to append the build option <code>--with-panel</code> to the end of the usual <code>perl
Makefile.PL</code> portion of the install process:</p>
<pre>
  <code>perl Makefile.PL --with-panel</code>
</pre>
<p>Although <code>Gnome.pm</code> hasn't made it to Version 1.0 yet I've found it to
be stable.  The biggest problem is the lack of documentation.</p>

<p>Lines 5 and 6 initialize a new AppletWidget object in <code>$a</code>.  This object
is the container for all the doodads that will be part of our applet.
Line 8 creates a label for use when our button is in the "off" position.</p>

<p>Line 10 creates a timer.  The prototype for the <code>Gtk->timeout_add</code>
function is:</p>
<pre>
 <code> Gtk->timeout_add( $interval, \&function, @function_data );</code>
</pre>
<p>Here our interval is 20000 (this value is in milliseconds, so the
timer will go off every 20 seconds), and the function to be called
when the timer goes off is <code>check_gateway</code>.  We could use the third
parameter to pass some data into the <code>check_gateway</code> function if it were
appropriate to do so.  In this case it isn't necessary.</p>

<p>Line 11 creates a new ToggleButton object in <code>$button</code>, and labels it "off".</p>

<p>Line 12 registers the other callback in this application.  This one
will be called when a particular "signal" occurs within Gnome.  These
aren't normal Unix signals like <code>SIGINT</code> and <code>SIGCHLD</code>, but GUI events.
In this case, the event is "clicked".  The ToggleButton widget also has
the signals "pressed", "released", "enter", and "leave", each of which is
emitted in response to either actions of the mouse pointer or a function
call, such as <code>$button->pressed()</code>.  In our application, Gnome will call
<code>reset_state()</code> whenever <code>ToggleButton $button</code> is clicked.</p>

<p>Line 14 sets the size of the button to be a square with sides of 50 pixels.
This is a good fit for the default Gnome panel.  Gnome uses global theme
and style information to determine how the button
is to be drawn: line, color, shadow, etc.  Line 15 calls the button's
<code>show</code> method, indicating that we're finished setting its attributes and
that it is ready for display.  Line 16 adds the button to the applet.
Technically, we've packed the ToggleButton widget into the AppletWidget
container by invoking the AppletWidget's add method on the ToggleButton.
The ToggleButton is now a "child" of its container.  At line 17 the
applet is allowed to be visible by calling its <code>show</code> method as well.  A
widget's children will not be displayed until the parent's <code>show</code> method
is invoked.</p>

<p>Line 19 calls the <code>fetch_gateway</code> routine to gather in the local host's
default TCP/IP gateway.  In that subroutine, <code>`netstat -rn`</code> captures the
local routing table, returning all addresses in dotted quad
+notation.  The test in line 30 gets triggered by the IP address
+0.0.0.0, which indicates the default gateway. When it matches, the
+gateway's name is looked up from the IP address, and stored in the
+variable $hostname.  Finally, we translate this value to lowercase, which will look better when we finally display it on the
button.  Then <code>fetch_gateway</code> returns.</p>

<p>At line 21, we're ready to hand off to the <code>gtk_main</code> event loop, which
is responsible for drawing the application on the screen and managing
user interaction.  At this point, our only interface with the
application will be through signal handling and callback functions.
The Gnome Toolkit (GTK) is event driven: once we enter <code>gtk_main</code> the
application stays put until an event occurs (caught via a signal) and
the associated callback function is invoked.  Therefore, we should have completed all of our application setup beforehand.</p>

<h3><a name="callbacks">The callbacks</a></h3>

<p>Now let's examine the two callback functions: <code>reset_state</code>, associated

with catching a "clicked" signal on our button (line 12); and
check_gateway, associated with the timer (line 10).</p>

<p>At line 38, we query the state of the toggle button by invoking its
<code>get_active method</code>.  This returns 0 if the button is off and 1 if it is
on.  By default, the ToggleButton widget has one child -- its own label.
We label the button with the contents of <code>$off_label</code> if it is in
the OFF position or the string "Wait" if it is in the ON position (figure
3) because we know that <code>check_gateway</code> is going to be called soon
(within the next 20 seconds).  Part of <code>check_gateway</code>'s job is to
update the button with the status of our TCP/IP gateway, the whole
point of this applet.</p>
<p>
<img src="/pub/2001/03/27/graphics/figure3.jpg" border="0" alt="Gnome gateway waiting"><br /><br />
<b>Fig. 3: Gnome Gateway waiting.</b></p>


<p>Line 53 stores either the value in <code>$hostname</code> or the string
"gateway", depending upon whether or not <code>$hostname</code> is longer than eight characters (lines 47-52).  This is the number of characters that will
fit comfortably on one line within the button's label.</p>

<p>If the button is in the ON position (line 55), we go ahead and attempt
to ping the gateway with a single ICMP packet, redirecting <code>STDOUT</code> and
<code>STDERR</code> to the round-file.  We don't care about the output of the <code>ping</code>
command, only it's return value, so we execute the command via
<code>system()</code>.  <code>Ping</code> will return 0 upon success (gateway alive) and
something else if it fails (probably because the gateway is dead), so
we check the result and update the button's label appropriately in
lines 59-66.</p>

<p>We want <code>check_gateway</code> to continue to be called, every 20 seconds, until
the application terminates.  So, at line 68 the function returns a true
value.  A true return value will allow further execution of a timer's
callback function while a false return value forces the opposite
behavior.</p>

<p>Note that 20 seconds is enough time to allow the call to <code>ping</code> to 
timeout and return a value to the application.  It is also an 
appropriate level of resolution for this kind of discovery activity: If 
information about the status of my gateway is at most 20 seconds old, then I'm happy.  Your mileage may vary, of course.</p>

<h3><a name="conclusion">Conclusion</a></h3>

<p>It's easy to write Gnome applets in Perl.  This simple example showed
you the basic elements of Gnome programming, including the event model
and callbacks.  Go forth and hack your own applet!
</p>



        </div>



    </div>
    <div class="asset-footer"></div>
</div>


                            
                            <div id="entry-1478" class="entry-asset asset hentry">
    <div class="asset-header">
        <h2 class="asset-name entry-title"><a href="/pub/2001/03/p5pdigest/THISWEEK-20010326.html" rel="bookmark">This Week on p5p 2001/03/26</a></h2>
        <div class="asset-meta">
            <span class="byline">
    
                By <span class="vcard author">Simon Cozens</span> on <abbr class="published" title="2001-03-26T00:00:00-08:00">March 26, 2001 12:00 AM</abbr>
    
            </span>

            
            

        </div>
    </div>
    <div class="asset-content entry-content">

        <div class="asset-body">
            <!-- This week on perl5-porters (20-26 Mar 2001) -->

<br />
<br />
      <H3><a name="Notes">Notes</a></H3>

</P>

<P>

You can subscribe to an email version of this summary by sending an
empty message to 
<a href="mailto:perl5-porters-digest-subscribe@netthink.co.uk"><tt>perl5-porters-digest-subscribe@netthink.co.uk</tt>.</a></P>

<P>
Please send corrections and additions to 
<CODE>perl-thisweek-YYYYMM@simon-cozens.org</CODE> where 
<CODE>YYYYMM</CODE> is the current year and month.  Changes and additions to the 
<a href="http://simon-cozens.org/writings/whos-who.html">perl5-porters</a> biographies are particularly welcome.
</P>

<P>
I looked at 263 messages in total this week.
<H3><a name="glob_Cwd_etc">glob(), Cwd, etc.</a></H3>

</P>

<P>

Benjamin Stugars started running amok over anything related to
directories. Firstly, he looked at 
<CODE>POSIX::getcwd</CODE> and made it call the 
<CODE>getcwd</CODE>system call if available instead of doing
<CODE>`pwd`</CODE>, avoiding a fork.
</P>

<P>
Next, he implemented 
<CODE>Cwd</CODE> in XS; however, this can't replace the current 
<CODE>Cwd</CODE> module, because 
<CODE>miniperl</CODE> needs to use it to install things. Instead, he had 
<CODE>Cwd::fastcwd</CODE> bootstrap the XS module.
</P>

<P>
Then he turned to 
<CODE>glob</CODE>, finding that, firstly, it gives a different sorting order (ASCII
rather than case-insensitive alphabetical) from the old implementation which
merely called out to 
<CODE>csh</CODE>.
<a href="http://simon-cozens.org/writings/whos-who.html#GURUSAMY">Gurusamy Sarathy </a> fixed this up by adding an option for 
<CODE>csh</CODE> compatibility. Ben put together a test suite for it.
</P>

<P>
He also found that 
<CODE>glob</CODE> in a scalar context returns the last file found, rather than the number
 of files found, but this was deemed to be a feature.
</P>

<P>

Ben also cleaned up the docs for
<CODE>Cwd.pm</CODE>, and made 
<CODE>Encode</CODE> work under warnings and stricture. Wow. A good week's work there; thanks, Ben.
<H3><a name="use_Errno_is_broken">use Errno is broken</a></H3>

</P>

<P>

<a href="http://simon-cozens.org/writings/whos-who.html#JENNESS">Tim Jenness</a> and I discovered a bug in 
<CODE>h2xs</CODE>. When you make an XS module, one of the things you might want to do is
make a set of constants available to Perl, so that Perl programmers can
call functions with the appropriate flags or whatever. The way 
<CODE>h2xs</CODE> lets you do this is by defining an autoloaded subroutine that calls the
XS function 
<CODE>constant</CODE>. If 
<CODE>constant</CODE> returns a value, that's used. If it doesn't know anything about the
 constant in question, it sets 
<CODE>errno</CODE> to 
<CODE>EINVAL</CODE>. The autoload sub then checks whether 
<CODE>$!</CODE> is contains &quot;Invalid&quot; (not very I18N-friendly) or whether 
<CODE>$!{EINVAL}</CODE> is set.
</P>

<P>
 
<CODE>%!</CODE> is a magical hash; it maps error constant numbers, like 
<CODE>ENOBRANE</CODE>, 
<CODE>EBADF</CODE> and so on, to true or false values, depending on the value of 
<CODE>errno</CODE>. This lets you do error checking both portably and in a
local-independent manner.
</P>

<P>
It's supposed to be activated by 
<CODE>use Errno</CODE>, but the stub modules provided by 
<CODE>h2xs</CODE> didn't actually use the module; I sent in a patch to make it use 
<CODE>Errno</CODE>. 
</P>

<P>
However, Sarathy revealed that using 
<CODE>%!</CODE> in a Perl program should cause 
<CODE>Errno</CODE> to be used automagically - unfortunately, it didn't, so more hacking is
required.
<H3><a name="Lexical_Warnings">Lexical Warnings</a></H3>

</P>

<P>

<a href="http://simon-cozens.org/writings/whos-who.html#DOMINUS">Mark-Jason Dominus </a> found that lexical warnings in some cases aren't
really lexical. Specifically, a module turning warnings on can trigger a
&quot;variable used once&quot; warning in the main program. He correctly pointed
out that:
<blockquote>The documentation in warnings.pm says:
</P>

</P><PRE>
        the pragma setting will not leak across files (via `use',
        `require' or `do').
</PRE>

<P>
If it doesn't keep this promise, then there is little
benefit to be had over using
<CODE>$^W</CODE></blockquote></P>

<P>
Paul Marquess, the lexical warning pumpking, said that this was a design
decision, but couldn't remember why. After some hints from Sarathy, he
started working on a patch. The new rules are to be:
<blockquote>A variable will be checked for the &quot;use once&quot; warnings if:
<ol><li>It is in the scope of a 
<CODE>use warnings 'once'</CODE><li>It isn't in the scope of the warnings pragma at all AND 
<CODE>$^W</CODE> is set.
</ol></P>

<P>
Otherwise it won't be checked at all.
</blockquote><H3><a name="Scalar_repeat_bug">Scalar repeat bug</a></H3>

</P>

<P>

Dominus found another interesting bug: 
<CODE>scalar</CODE> and the repeat operator 
<CODE>x</CODE> don't play nice together. For instance:
</P>

</P><PRE>
    print scalar ((1,2,3)x4) # Prints "123333"
</PRE>

<P>
Robin Houston came to the rescue again with this typically brilliant analysis:
<blockquote>Really it's a perl bug, and another that goes back at least to the
earliest perl I have available (5.00404).
</P>

</P><PRE>
    perl -e 'print -((1,2)x2)'
</PRE>

<P>
will print 
<CODE>1-22</CODE>. What happens is roughly:
<ul><li>the values (1,2) are put onto the stack
<li><CODE>pp_repeat</CODE> sees that it's in a scalar context, so it changes the 
<CODE>2</CODE> on the top of the stack to 
<CODE>22</CODE>. The 
<CODE>1</CODE> remains beneath.
<li><CODE>pp_negate</CODE> negates the top of the stack, giving &quot;-22&quot;.
<li> so now the list 
<CODE>(1, -22)</CODE>  is on the stack, and is printed.
</ul></P>

<P>
The patch below makes pp_repeat drop the extraneous values, if
its context is scalar but the OPpREPEAT_DOLIST flag is set.
</blockquote><H3><a name="open_trickery">open() trickery</a></H3>

</P>

<P>

Nick Ing-Simmons
 came bearing gifts: specifically, funky new forms of 
<CODE>open</CODE>. So far he has implemented the list form of pipes, so that:
</P>

</P><PRE>
    $pid = open($fh, "-|", tac => $file);
</PRE>

<P>
will run 
<CODE>tac $file</CODE> and pipe the output to the filehandle.
</P>

<P>
Next up came duplicating filehandles and file descriptors. His examples:
</P>

</P><PRE>
     open(my $dup,"<&",$fh) # can now duplicate anonymous handles.
     open(my $num,"<&",42)  # Integers are considered file descriptors.
</PRE>

<P>
And also, something I know a lot of people have always wanted:
</P>

</P><PRE>
    open(my $fh, "<", \$string)
</PRE>

<P>
which reads from the string as if it was a file on disk. 
</P>

<P>
But no, he didn't stop there!
</P>

</P><PRE>
    open(my $tempfile, "<+", undef);
</PRE>

<P>
is going to give you an anonymous temporary file on systems that support
it. He also suggested opening different files on the read and write
halves of a filehandle. That's to say, you could copy files like this:
</P>

</P><PRE>
    open(my $fh, "<", $read_from, ">", $write_to);
    while (<$fh>) {
        print $fh $_;
    }
</PRE>

<P>
By this time I was positively squealing with excitement.
</P>

<P>
Russ Allbery suggested a brilliantly devious way of doing IO layers at
the Perl level: allow
</P>

</P><PRE>
    open (my $fh, "<", \&coderef);
</PRE>

<P>
which would call a subroutine every time more data was needed.
<H3><a name="NetPing">Net::Ping</a></H3>

</P>

<P>

Colin McMillen had some suggestions (and, heavens above, an
implementation) for some changes he wanted to make to
<CODE>Net::Ping</CODE>. I'll quote his summary here, and you can read the details in 
<a href="http://www.xray.mpe.mpg.de/mailing-lists/perl5-porters/2001-03/msg01018.html">his mail </a>.
<blockquote><ol><li>Removal of 
<CODE>alarm()</CODE> function.
<li>Incorrect returns of 
<CODE>false</CODE> removed from TCP ping
<li>Removal of unneeded warning in the module's POD
<li>Creation of a new &quot;external&quot; protocol
<li>Creation of a new &quot;auto&quot; protocol
<li>Documentation update
<li>Change in the default ping protocol
<li>Allowing for user-specified port in TCP ping
<li>UDP ping fixes?
</ol></blockquote></P>

<P>
There was some discussion of fine points; specifically, whether one
should necessarily return false when, for instance, a ping may be
blocked by a firewall. Abigail came up with a neat solution using an
overloaded value for the response; in the end, however, an
object-oriented approach was taken. Sarathy suggested that on Windows,
one can use
<CODE>system 1, ...</CODE> to spawn a child process.
</P>

<P>
Colin took away the discussion and came back with an excellent set of
patches, which got applied.
<H3><a name="New_modules_in_core">New modules in core</a></H3>

</P>

<P>

Jarkko sneaked in a few more modules to the core: 
<CODE>Digest::MD5</CODE> and 
<CODE>MIME::Base64</CODE> are in there now. There were a couple of teething problems as the tests
 for 
<CODE>MIME::QuotedPrint</CODE> were marked as binary files by Perforce, and Nick spotted an ASCI-ism
 in the code while working on yet another piece of PerlIO trickery. (He
wanted
</P>

<P>
   use MIME::QuotedPrint;
   binmode(\*STDOUT,&quot;:Object(MIME::QuotedPrint)&quot;);
   print &quot;Just my 2? on the MIME stuff \n&quot;,scalar( '_' x 80),&quot;\n&quot;;
</P>

<P>
to produce
</P>

</P><PRE>
    Just my 2=A2 on the MIME stuff=20
    ___________________________________________________________________________=
    _____
</PRE>

<P>
. Uhm, yum, I think.)
<H3><a name="YAPC_Registration">YAPC Registration</a></H3>

</P>

<P>

Rich Lafferty announced that the Third North American Yet Another Perl
Conference registeration was open. YAPC::America::North will be held at
McGill University, Monteral, Quebec from Wednesday June 13th to Friday
June 15th. 
</P>

<P>
Don't delay, 
<a href="http://na-register.yapc.org/">register today</a>!
<H3><a name="Various">Various</a></H3>

</P>

<P>

I called for 
<CODE>pack()</CODE> recipes, since I'm trying to write a tutorial about the underused
 functions 
<CODE>pack()</CODE> and 
<CODE>unpack()</CODE>. If you have any neat things you do with 
<CODE>pack()</CODE>, please send them to me.
</P>

<P>
Peter Prymmer got 5.6.1 ready to go on OS/390, with updates to the
documentation and test suites.
</P>

<P>
Chris Nandor got some more Mac portability patches in.
</P>

<P>
Radu Greab provided something I don't quite understand to work around
socket brokenness in Linux.
</P>

<P>
Paul Johnson came up with some patches for mingw32; mainly to bring it
closer towards Borland C-ness. (or, alternatively, further away from
VC++) Nick I-S queried this, as he thought mingw32 was trying to be more
VC++ compatible, but it seemed to be the right thing.
</P>

<P>
Jarkko documented how to use Third Degree and Pixie, two memory leak and
profiling tools, in 
<CODE>perlhack.pod</CODE>.
</P>

<P>
Tim Jenness
 went through the typemap file and found some oddities in it; as well as
fixing them up, he came up with an XS module to test them.
</P>

<P>
He also found that naughty, naughty Compaq shipped the Perl library
separately from the Perl binary with Digital U... uhm, I mean Tru64 v5.1. 
Unfortunately, 
<CODE>perl -V</CODE> needs 
<CODE>Config.pm</CODE>, which is in the &quot;optional subset&quot; containing the rest of the Perl
library. Oops. 
</P>

<P>
Until next week I remain, your humble and obedient servant,
</P>

<hr>

<a href="mailto:simon@brecon.co.uk">Simon Cozens</a>


<ul>
  <li><a href="#Notes">Notes</a>
  <li><a href="#glob_Cwd_etc">glob(), Cwd, etc.</a>
  <li><a href="#use_Errno_is_broken">use Errno is broken</a>
  <li><a href="#Lexical_Warnings">Lexical Warnings</a>
  <li><a href="#Scalar_repeat_bug">Scalar repeat bug</a>
  <li><a href="#open_trickery">open() trickery</a>
  <li><a href="#NetPing">Net::Ping</a>
  <li><a href="#New_modules_in_core">New modules in core</a>
  <li><a href="#YAPC_Registration">YAPC Registration</a>
  <li><a href="#Various">Various</a>
</ul>

        </div>



    </div>
    <div class="asset-footer"></div>
</div>


                            
                            <div id="entry-1462" class="entry-asset asset hentry">
    <div class="asset-header">
        <h2 class="asset-name entry-title"><a href="/pub/2001/03/dbiokay.html" rel="bookmark">DBI is OK</a></h2>
        <div class="asset-meta">
            <span class="byline">
    
                By <span class="vcard author"><a class="fn url" href="http://www.modernperlbooks.com/">chromatic</a></span> on <abbr class="published" title="2001-03-20T00:00:00-08:00">March 20, 2001 12:00 AM</abbr>
    
            </span>

            
            

        </div>
    </div>
    <div class="asset-content entry-content">

        <div class="asset-body">
            <h2>DBI is OK
</h2>

<br />

<p><table width="180" cellspacing="0" cellpadding="4" align="right" border="1">
<tr>
<td align="center" valign="top" bgcolor="#6699cc">
<font color="#ffffff">Table of Contents</td>
</tr>

<tr>
<td>
<p class="fine">
&#149;<a href="#is table mutation a big problem">Is Table Mutation a Big Problem?</a><br /><br />
&#149;<a href="#making queries easier">Making Queries Easier</a><br /><br />
&#149;<a href="#placeholders">Placeholders</a><br /><br />

&#149;<a href="#binding columns">Binding Columns</a><br /><br />

&#149;<a href="#modules built on dbi">Modules Built on DBI</a><br />

</td>
</tr>
</p>
</table>
 

<p>A <a href="/pub/2001/02/dbix.html">
recent article</a> on Perl.com recommended that most Perl programs use the
DBIx::Recordset module as the standard database interface.  The examples
cast an unfavorable light on DBI (which DBIx::Recordset uses internally).  While
choosing an interface involves trade-offs, the venerable DBI module, used 
properly, is a fine choice.  This response attempts to clear up some 
misconceptions and to demonstrate a few features that make DBI, by itself, 
powerful and attractive.</p>
<p>Since its inception in 1992, DBI has matured into a powerful and flexible
module.  It runs well on many platforms, includes drivers for most popular 
database systems and even supports flat files and virtual databases.  Its
popularity means it is well-tested and well-supported, and its modular design
provides a consistent interface across the supported backends.</p>

<h3><a name="is table mutation a big problem">Is Table Mutation a Big Problem?</a></h3>
<p>The previous article described an occurrence called ``table mutation,'' where the 
structure of a table changes.  Mr. Brannon says that the DBI does not handle 
this gracefully.  One type of mutation is field reordering.  For example, a 
table named 'user' may originally be:</p>
<pre>
        name    char(25)
        email   char(25)
        phone   char(11)</pre>
<p>At some point, the developers will discover that the 'name' field is a poor
primary key.  If a second ``John Smith'' registers, the indexing scheme will
fail.  To ensure uniqueness, the coders could add an 'id' field using an 
auto-incremented integer or a globally unique identifier built into the database.
The updated table might resemble:</p>
<pre>
        id      bigint
        name    char(25)
        email   char(25)
        phone   char(11)</pre>
<p>Mr. Brannon contends that all code that generates a SQL statement that resolves
to 'SELECT * FROM user' will break with this change.  He is correct.  Any 
database request that assumes, but does not specify, the order of results is 
susceptible.</p>
<p>The situation is not as bad as it seems.  First, DBI's <code>fetchrow_hashref()</code> method
returns results keyed on field names.  Provided the existing field names do not 
change, code using this approach will continue to work.  Unfortunately, this is
less efficient than other fetching methods.</p>
<p>More importantly, explicitly specifying the desired fields leads to clearer and 
more secure code.  It is easier to understand the purpose of code that selects 
the 'name' and 'email' fields from the 'user' table above than code that assumes
an order of results that may change between databases.  This can also improve 
performance by eliminating unnecessary data from a request.  (The less work the 
database must do, the better.  Why retrieve fields that won't be used?)</p>
<p>From a pragmatic approach, the example program will need to change when the 'id'
field is added.  The accessor code must use the new indexing approach.  Whether the accessors continue to function in the face of this change is 
irrelevant -- someone must update the code!</p>
<p>The same arguments apply to destructive mutations, where someone deletes a
field from a table.  While less likely than adding a field, this can occur 
during prototyping.  (Anyone who deletes a field in a production system will 
need an approved change plan, an extremely good excuse or a recent CV.)  A 
change of this magnitude represents a change in business rules or program 
internals.  Any system that can handle this reliably, without programmer 
intervention, is a candidate for Turing testing.  It is false laziness to 
assume otherwise.</p>
<p>Various classes of programs will handle this differently.  My preference is to 
die immediately, noisily alerting the maintainer.  Other applications and 
problem domains might prefer to insert or to store potentially tainted data for 
cleansing later.  It's even possible to store metadata as the first row of a
table or to examine the table structure before inserting data.</p>
<p>Given the hopefully rare occurrence of these mutations and the wide range of 
options in handling them, the DBI does not enforce one solution over another.
Contrary to the explanation in the prior article, this is not a failing of the
DBI.  (See a November 2000 PerlMonks discussion at 
<a href="http://www.perlmonks.org/index.pl?node_id=43748">http://www.perlmonks.org/index.pl?node_id=43748</a> for more detail.)</p>

<h3><a name="making queries easier">Making Queries Easier</a></h3>
<p>Another of Mr. Brannon's disappointments with the DBI is that it provides no 
generalized mechanism to generate SQL statements automatically.  This allows 
savvy users to write intricate queries by hand, while database neophytes can use
modules to create their statements for them.  The rest of us can choose between 
these approaches.</p>
<p>SQL statements are plain text, easily manipulated with Perl.  An example from 
the previous article created an INSERT statement with multiple fields and a
hash containing insertable data.  Where the example was tedious and hard to 
maintain, a bit of editing makes it general and powerful enough to become a 
wrapper function.  Luckily, the source hash keys correspond to the destination
database fields.  It takes only a few lines of code and two clever idioms to 
produce a sane and generalized function to insert data into a table.</p>
<pre>
        my $table = 'uregisternew';
        my @fields = qw( country firstname lastname userid password address1 city 
                state province zippostal email phone favorites remaddr gender income 
                dob occupation age );</pre>
<pre>
        my $fields = join(', ', @fields);
        my $values = join(', ', map { $dbh-&gt;quote($_) } @formdata{@fields});
        $sql = &quot;INSERT into $table ($fields) values ($values)&quot;;</pre>
<pre>
        $sth = $dbh-&gt;prepare($sql);
        $sth-&gt;execute();
        $sth-&gt;finish();</pre>
<p>We'll assume that %formdata has been declared and contains data already.  We've
already created a database handle, stored in $dbh, and it has the RaiseError
attribute set.  The first two lines declare the database table to use and
the fields into which to insert data.  These could just as well come from
function arguments.</p>
<p>The <code>join()</code> lines transforms lists of fields and values into string snippets
used in the SQL statement.  The map block simply runs each value through the 
DBI's <code>quote()</code> method, quoting special characters appropriately.  Don't quote the
fields, as they'll be treated as literals and will be returned directly.  
(Be sure to check the DBD module for your chosen database for other notes 
regarding <code>quote().)</code></p>
<p>The only tricky construct is <code>@formdata{@fields}</code>.  This odd fellow is known as
a hash slice.  Just as you can access a single value with a scalar 
($formdata{$key}), you can access a list of values with a list of keys.  Not 
only does this reduce the code that builds $values, using the same list in 
@fields ensures that the field names and the values appear in the same order.</p>

<h3><a name="placeholders">Placeholders</a></h3>
<p>A relational database must parse each new statement, preparing the query.
(This occurs when a program calls the <code>prepare()</code> method).  High-end systems often
run a query analyzer to choose the most efficient path.  Because many queries 
are repeated, some databases cache prepared queries.</p>
<p>DBI can take advantage of this with placeholders (also known as 'bind values').
This is especially handy when inserting multiple rows.  Instead of interpolating
each new row into a unique statement and forcing the database to prepare a new 
statement each time, adding placeholders to an INSERT statement allows us to
prepare the statement once, looping around the <code>execute()</code> method.</p>
<pre>
        my $fields = join(', ', @fields);
        my $places = join(', ', ('?') x @fields);
        $sql = &quot;INSERT into $table ($fields) values ($places)&quot;;</pre>
<pre>
        $sth = $dbh-&gt;prepare($sql);
        $sth-&gt;execute(@formdata{@fields});</pre>
<pre>
        $sth-&gt;finish();</pre>
<p>Given @fields containing 'name', 'phone', and 'email', the generated statement
will be:</p>
<pre>
        INSERT into users (name, phone, email) values (?, ?, ?)</pre>
<p>Each time we call <code>execute()</code> on the statement handle, we need to pass the
appropriate values in the correct order.  Again, a hash slice comes in handy.
Note that DBI automatically quotes values with this technique.</p>
<p>This example only inserts one row, but it could easily be adapted to loop over a
data source, repeatedly calling execute().  While it takes slightly more code 
than interpolating values into a statement and calling do(), the code is much 
more robust.  Additionally, preparing the statement only once confers a
substantial performance benefit.  Best of all, it's not limited to INSERT
statements.  Consult the DBI documentation for more details.</p>

<h3><a name="binding columns">Binding Columns</a></h3>
<p>In a similar vein, the DBI also supports a supremely useful feature called 
'binding columns.'  Instead of returning a list of row elements, the DBI
stores the values in bound scalars.  This is very fast, as it avoids copying
returned values, and can simplify code greatly.  From the programmer's side, it 
resembles placeholders, but it is a function of the DBI, not the underlying
database.</p>
<p>Binding columns is best illustrated by an example.  Here, we loop through all 
rows of the user table, displaying names and e-mail addresses:</p>
<pre>
        my $sql = &quot;SELECT name, email FROM users&quot;;
        my $sth = $dbh-&gt;prepare($sql);
        $sth-&gt;execute();</pre>
<pre>
        my ($name, $email);
        $sth-&gt;bind_columns(\$name, \$email);</pre>
<pre>
        while ($sth-&gt;fetch()) {
                print &quot;$name &lt;$email&gt;\n&quot;;
        }
        $sth-&gt;finish();</pre>
<p>With each call to fetch(), $name and $email will be updated with the appropriate
values for the current row.  This code does have the flaw of depending on field 
ordering hardcoded in the SQL statement.  Instead of giving up on this 
flexibility and speed, we'll use the list-based approach with a hash slice:</p>
<pre>
        my $table = 'users';
        my @fields = qw( name email );
        my %results;</pre>
<pre>
        my $fields = join(', ', @fields);</pre>
<pre>
        my $sth = $dbh-&gt;prepare(&quot;SELECT $fields FROM $table&quot;);
        $sth-&gt;execute();</pre>
<pre>
        @results{@fields} = ();
        $sth-&gt;bind_columns(map { \$results{$_} } @fields);</pre>
<pre>
        while ($sth-&gt;fetch()) {
                print &quot;$results{name} &lt;$results{email}&gt;\n&quot;;
        }
        $sth-&gt;finish();</pre>
<p>It only takes two lines of magic to bind hash values to the result set.  After
declaring the hash, we slice %results with @fields to initialize the keys we'll 
use.  Their initial value (undef) doesn't matter, as it is only necessary that
they exist.  The map block in the <code>bind_columns()</code> call creates a reference to the
hash value associated with each key in @fields.  (This is the only required step
of the example, but the value initialization in the previous line makes it more 
clear.)</p>
<p>If we only display names and addresses, this is no improvement over binding
simple lexicals.  The real power comes with more complicated tasks.  This
technique may be used in a function:</p>
<pre>
        sub bind_hash {
                my ($table, @fields) = @_;</pre>
<pre>
                my $sql = 'SELECT ' . join(', ', @fields) . &quot; FROM $table&quot;;
                my $sth = $dbh-&gt;prepare($sql);
                $sth-&gt;execute();</pre>
<pre>
                my %results;
                @results{@fields} = ();
                $sth-&gt;bind_columns(map { \$results{$_} } @fields);
                return (\%results, sub { $sth-&gt;fetch() });
        }</pre>
<p>Calling code could resemble:</p>
<pre>
        my ($res, $fetch) = bind_hash('users', qw( name email ));
        while ($fetch-&gt;()) {
                print &quot;$res->{name} &gt;$res->{email}>\n";
        }</pre>
<p>Other options include passing in references to populate or returning an object
that has a <code>fetch()</code> method of its own.</p>

<h3><a name="modules built on dbi">Modules Built on DBI</a></h3>
<p>The decision to use one module over another depends on many factors.  For 
certain classes of applications, the nuts and bolts of the underlying database 
structure is less important than ease of use or rapid development.  Some coders 
may prefer a higher level of abstraction to hide tedious details for simple 
requirements.  The drawbacks are lessened flexibility and slower access.</p>
<p>It is up to the programmer to analyze each situation, choosing the appropriate 
approach.  Perl itself encourages this.  As mentioned above, DBI does not 
enforce any behavior of SQL statement generation or data retrieval.  When the 
techniques presented here are too onerous and using a module such as Tangram or 
DBIx::Recordset makes the job easier and more enjoyable, do not be afraid to use
them.  Conversely, a bit of planning ahead and abstraction can provide the 
flexibility needed for many other applications.  There is no single best
solution, but Perl and the CPAN provide many workable options, including the
DBI.</p>

<p><em>chromatic is the author of <a href="http://onyxneon.com/books/modern_perl/">Modern Perl</a>. In his spare time, he has been working on <a href="http://trendshare.org/how-to-invest/">helping novices understand stocks and investing</a>.</em></p>

        </div>



    </div>
    <div class="asset-footer"></div>
</div>


                            
                            <div id="entry-1476" class="entry-asset asset hentry">
    <div class="asset-header">
        <h2 class="asset-name entry-title"><a href="/pub/2001/03/p5pdigest/THISWEEK-20010319.html" rel="bookmark">This Week on p5p 2001/03/19</a></h2>
        <div class="asset-meta">
            <span class="byline">
    
                By <span class="vcard author">Simon Cozens</span> on <abbr class="published" title="2001-03-19T00:00:00-08:00">March 19, 2001 12:00 AM</abbr>
    
            </span>

            
            

        </div>
    </div>
    <div class="asset-content entry-content">

        <div class="asset-body">
            </p>

<p>


<!-- This week on perl5-porters (13-19 Mar 2001) -->

<br />
<br />
      <h3><a name="Notes">Notes</a></h3>

</p>

<p>

You can subscribe to an email version of this summary by sending an
empty message to 
<a href="mailto:perl5-porters-digest-subscribe@netthink.co.uk"><tt>perl5-porters-digest-subscribe@netthink.co.uk</tt>.</a></p>

<p>
Please send corrections and additions to 
<code>perl-thisweek-YYYYMM@simon-cozens.org</code> where 
<code>YYYYMM</code> is the current year and month.  Changes and additions to the 
<a href="http://simon-cozens.org/writings/whos-who.html">perl5-porters</a> biographies are particularly welcome.
</p>

<p>
There were just under 300 messages this week.
<h3><a name="561_TRIAL3_is_out_there">5.6.1-TRIAL3 is out there</a></h3>

</p>

<p>

Just before going to press, 
<a href="http://simon-cozens.org/writings/whos-who.html#GURUSAMY">Sarathy</a> pushed trial 3 out of the door; get it from 
<a href="http://www.cpan.org/authors/id/G/GS/GSAR/perl-5.6.1-TRIAL3.tar.gz">$CPAN/authors/id/G/GS/GSAR/perl-5.6.1-TRIAL3.tar.gz</a>.
</p>

<p>
Please test it as widely as possible, run your favourite bugs through
it, and so on. If you're not one of the smoke testers, now would be a
good time to start; subscribe to 
<code>daily-build@perl.org</code> and get yourself a copy of 
<code>SmokingJacket</code> - that would be a great help for us. 
<h3><a name="Robin_Houston_vs_goto">Robin Houston vs. goto</a></h3>

</p>

<p>

Why anyone wants to maintain 
<code>goto</code> is quite beyond me, but Robin Houston's been doing it rather well this
week. The first bug he fixed was to do with lexical variables losing
their values when a 
<code>goto</code> happens in their scope:
</p>

</p><pre>
    for ($i=1; $i<=1; $i++) {
        my $var='val';
        print "before \$var='$var'\n";
        goto jump;
        jump:
        print  "after \$var='$var'\n";
    }
</pre>

<p>
Here's his analysis:
<blockquote>Wow! This is a venerable bug, dating at least back to 5.00404.
</p>

<p>
When a for(;;) is compiled, there's no nextstate immediately
before the enterloop, and so when pp_goto does this:
</p>

</p><pre>
            case CXt_LOOP:
                gotoprobe = cx->blk_oldcop->op_sibling;
                break;
</pre>

<p>
gotoprobe ends up pointing into a dead end.
</p>

<p>
That means that the label doesn't get found until the
next context up is searched; and so the loop context is
left and re-entered when the goto is executed.
</blockquote></p>

<p>
Next, he fixed a bug which meant that 
</p>

<p>
  eval { goto foo; }; die &quot;OK\n&quot;;
  foreach $i(1,2,3) { foo: die &quot;Inconclusive\n&quot;; }
</p>

<p>
would not get caught by the 
<code>eval</code>. This was because 
<code>goto</code> failed to pop the stack frames as it left an 
<code>eval</code>. 
</p>

<p>
For his hat-trick, he made 
<code>goto</code> work in nested 
<code>eval</code> structures. 
<h3><a name="my_foo_if_0">my $foo if 0</a></h3>

</p>

<p>

One of the (many) perl5-porters dirty secrets is that if you say
</p>

</p><pre>
    sub marine {
        my $scope = "up" if 0;
        return $scope++;
    }
    print marine(),"\n" for 0..10;
</pre>

<p>
you get the lexical variable 
<code>$scope</code> increasing from 0 to 10, instead of being reinitialised every time. In
effect, you get a static variable. Very nice.
</p>

<p>
Of course, this is completely undocumented and you'd be foolish to rely
on it, but it generates no warnings and passes 
<code>use strict</code> happily. It's come about completely by accident, since the optimiser
optimises away the initialisation. David Madison claimed it was a bug,
but most people seem to think of it as an unexploded feature. 
<a href="http://simon-cozens.org/writings/whos-who.html#HIETANIEMI">Jarkko </a> will be adding lexical warnings to mark it as deprecated.
<a href="http://simon-cozens.org/writings/whos-who.html#VROMANS">Johan</a> also pointed out that 
<code>open</code> with more than 3 arguments doesn't currently pass the later arguments
onto the program being called: his spectacular example was
</p>

</p><pre>
    open (FH, "-|", "deleteallfiles", "-tempfilesonly")
</pre>

<p>
which deletes all files, not just the temp files. 
<a href="http://simon-cozens.org/writings/whos-who.html#ING-SIMMONS">Nick</a> said it was on his list of things to do, and called for patches.
<h3><a name="More_POD_Nits">More POD Nits</a></h3>

</p>

<p>

Michael Stevens produced some more POD patches this week, and the
discussion about how strict 
<code>podchecker</code> can be continued from last week, spurred on by Jarkko sending Michael's
patched to the maintainers of core modules.
<a href="http://simon-cozens.org/writings/whos-who.html#ZACHAREVICH">Ilya</a>, Sarathy and others
grumbled about 
<code>podchecker</code>'s insistence on
</p>

</p><pre>
    =over 4
</pre>

<p>
instead of just `plain'
</p>

</p><pre>
    =over
</pre>

<p>
Michael patched 
<code>podchecker</code> to remove that warning, although Jarkko was impressed that
perl5-porters had managed to degenerate to squabbling over 2 bytes of
documentation. A new low. 
Not content, Ilya managed to get it down to 1 byte, by grouching about
</p>

</p><pre>
    L&lt;foo
     bar>
</pre>

<p>
being an error where
</p>

</p><pre>
    L&lt;foo bar>
</pre>

<p>
was not. Michael patched 
<code>podchecker</code> to remove that warning too, which has the nice result that you can
 reformat paragraphs in your POD (with Alt-Q or gqap, depending on
 religion) without worrying about it breaking the semantics.
<h3><a name="More_on_the_reset_bug">More on the reset bug</a></h3>

</p>

<p>

Jarkko reported that Sarathy's patch to fix the 
<a href="/pub/2001/03/p5pdigest/THISWEEK-20010305.html#Weird_Memory_Corruption">reset bug</a> of a couple of weeks ago still produced erratic results on various
platforms. 
<a href="http://simon-cozens.org/writings/whos-who.html#BURLISON">Alan </a> found the heap corruption in Purify, and reported that &quot;this bug is
unchanged since the last discussion of it on the list a couple of weeks
back.&quot; (But noted that the anon sub leak is finally fixed!) Jarkko
pointed out that this was because Sarathy's patch wasn't applied to the
repository, and that the problem was that the linked list of pattern
match operators was getting corrupted. That's to say, when you have a
regular expression like 
<code>/.a\d/</code> it contains a list of nodes: any character, a literal 
<code>a</code>, any digit. For some reason, when the regular expression was being
freed from memory, one of the nodes, let's say the literal 
<code>a</code>, was pointing not to an &quot;any digit&quot; node, but to West hyperspace. 
</p>

<p>
Radu Greab zeroed in on the problem: the regular expression was being
cleared twice. He provided the beginnings of a patch; Sarathy suggested
it was on the right lines, but wanted to reference count regular
expression nodes. His version of the patch caused all sorts of problems,
and Radu came up with something else to change the regular expression
node list into a doubly-linked list. That was still imperfect, and
Sarathy wanted to know why his patch caused all sorts of problems.
Jarkko unfortunately ran out of time to do some debugging on this.
</p>

<p>
So it's still out there, and a very, very weird bug it is too. Something
is going very wrong with the freeing of PMOPs. We've only seen it on
Linux and Tru64 when the 
<code>-DDEBUGGING</code> and 
<code>-g</code> flags are on, so far. Stranger and stranger.
<h3><a name="Distributive_arrow_operator">Distributive arrow operator</a></h3>

</p>

<p>

David Lloyd suggested that the arrow operator should be
distributive, so that:
</p>

</p><pre>
    ($foo, $bar)->baz();
</pre>

<p>
does
</p>

</p><pre>
    $foo->baz(); $bar->baz();
</pre>

<p>
Not a bad idea, although various people pulled out the old &quot;would break
old code&quot; mainstay.
</p>

<p>
He developed his idea, suggesting that
</p>

</p><pre>
    ([1,2], [3,4])->[0]
</pre>

<p>
should return 
<code>1,3</code>, and also that
</p>

</p><pre>
    ($arrayref)->[0..15]
</pre>

<p>
should return
</p>

</p><pre>
    map { $arrayref->[$_] } 0..15
</pre>

<p>
I thought this was beautiful, and tossed it over to the perl6-language
list, together with the natural extension of
</p>

</p><pre>
    @a = ($foo, $bar) . $baz     # @a = map { $_.$baz } ($foo, $baz)
</pre>

<p>
which reminded MJD of APL.
<h3><a name="Various">Various</a></h3>

</p>

<p>

I made a misattribution last week, saying that Philip Newton provided a
documentation patch for 
<code>use integer</code>. Although Philip does some storming work, that wasn't one of his - it
belonged to Robert Spier. Sorry, Robert. John Allen produced another one
this week.
</p>

<p>
Ilya made 
<code>perldoc</code> work on OS/2. John Allen suggested that we should use the subroutine
attribute syntax to extend builtins: 
<code>time :milli()</code> for hi-res time, for instance. Nothing happened. 
</p>

<p>
Charles Lane (he of the weird email address) produced a fix to tidy up
the test suite a little; tests should use 
<code>$^X</code> instead of 
<code>./perl</code> to keep VMS and other dinosaurs happy.
</p>

<p>
Kurt Starsinic has been patching up some of the standard utilities to be
warnings and strict clean; so far we've seen his patch to 
<code>h2ph</code>. 
</p>

<p>
Merijn found loads and loads of bugs in the 5.6.1 trials on AIX and
HP/UX, which Sarathy ran around cleaning up. Good work, both.
</p>

<p>
Brian Ingerson has, sadly, decided that his excellent 
<a href="http://search.cpan.org/search?dist=Inline">Inline</a> module is not going to be mature enough for 5.8.0. Still, I heartily
hope something like it ships with Perl 6. Have you played with 
<a href="http://search.cpan.org/search?dist=Inline">Inline</a> yet? No? Go and play with 
<a href="http://search.cpan.org/search?dist=Inline">Inline</a> immediately, and until next week I remain, your humble and obedient servant,
</p>

<hr>

<a href="mailto:simon@brecon.co.uk">Simon Cozens</a>


<ul>
  <li><a href="#Notes">Notes</a>
  <li><a href="#561_TRIAL3_is_out_there">5.6.1-TRIAL3 is out there</a>
  <li><a href="#Robin_Houston_vs_goto">Robin Houston vs. goto</a>
  <li><a href="#my_foo_if_0">my $foo if 0</a>
  <li><a href="#More_POD_Nits">More POD Nits</a>
  <li><a href="#More_on_the_reset_bug">More on the reset bug</a>
  <li><a href="#Distributive_arrow_operator">Distributive arrow operator</a>
  <li><a href="#Various">Various</a>
</ul>

        </div>



    </div>
    <div class="asset-footer"></div>
</div>


                            
                            <div id="entry-1464" class="entry-asset asset hentry">
    <div class="asset-header">
        <h2 class="asset-name entry-title"><a href="/pub/2001/03/embperl.html" rel="bookmark">Creating Modular Web Pages With EmbPerl</a></h2>
        <div class="asset-meta">
            <span class="byline">
    
                By <span class="vcard author">Neil Gunton</span> on <abbr class="published" title="2001-03-13T00:00:00-08:00">March 13, 2001 12:00 AM</abbr>
    
            </span>

            
            

        </div>
    </div>
    <div class="asset-content entry-content">

        <div class="asset-body">
            <!-- Using Embperl -->

<br />

<p><table width="180" cellspacing="0" cellpadding="4" align="right" border="1">
<tr>
<td align="center" valign="top" bgcolor="#6699cc">
<font color="#ffffff">Table of Contents</td>
</tr>

<tr>
<td>
<p class="fine">
&#149;<a href="#getting started">Getting Started</a><br /><br />
&#149;<a href="#Hello World">Hello World</a><br /><br />
&#149;<a href="#websiteglobal variables">Web Site Global Variables</a><br /><br />
&#149;<a href="#modular files">Modular Files</a><br /><br />
&#149;<a href="#modular file inheritance">Modular File Inheritance</a><br /><br />
&#149;<a href="#subroutines in embperlobject">Subroutines in EmbperlObject</a><br /><br />
&#149;<a href="#conclusions">Conclusions</a><br />

</td>
</tr>
</p>
</table>
<p>This tutorial is intended as a complement to the Embperl
documentation, not a replacement. We assume a basic familiarity 
with
Apache, mod_perl and Perl, and the Embperl documentation. No 
prior
experience with EmbperlObject is assumed. The real purpose 
is to
give a clearer idea of how EmbperlObject can help you build large
Web sites. We give example code that can serve as a starting
template and hints about the best practices 
that
have come out of real experience using the toolkit. As always, there
is more than one way to do it!</p>
<p>Since EmbperlObject is an evolving tool, it is likely that these
design patterns will evolve over time, and it is recommended that 
the
reader check back on the Embperl Web site for new versions.</p>
<p>
<h3><a name="motivation: constructing modular websites">Motivation: Constructing Modular Web Sites</a></h3>
<p>Embperl is a tool that allows you to embed Perl code in your 
HTML
documents. As such, it could handle just about everything
you need to do with your Web site. So what is the point of
EmbperlObject? What does it give us that we don't already get with
basic Embperl?</p>
<p>As often seems to be the case with Perl, the answer has to do with
laziness. We would all like the task of building Web sites to be as
simple as possible. Anyone who has had to build a non-trivial site
using pure HTML will have quickly experienced the irritation of 
having
to copy-and-paste common code between documents - stuff like
navigation bars and table formats. We have probably all wished for 
an
``include'' HTML tag. EmbperlObject goes a long way toward solving 
this
problem, without requiring the developer to resort to a lot of
customized Perl code.</p>
<p>In a nutshell, EmbperlObject extends Embperl by enabling the
construction of Web sites in a modular, or object-oriented, fashion. I
am using the term ``object-oriented'' (OO) loosely here in the 
context
of inheritance and overloading, but you don't really need to know
anything about the OO paradigm to benefit from EmbperlObject. As 
you
will see from this short tutorial, it is possible to benefit from
using EmbperlObject with even a minimal knowledge of Perl. With 
just a
little instruction, in fact, pure HTML coders can use it to improve
their Web site architecture. Having said that, however, 
EmbperlObject
also provides for more advanced OO functionality, as we'll see later.</p>

<h3><a name="getting started">Getting Started</a></h3>
<p>We'll assume that you've successfully installed the latest
Apache, mod_perl and Embperl on your system. That should all be
relatively painless - problems normally occur when mixing older
versions of one tool with later versions of another. If you can, try
to download the latest versions of everything.</p>
<p>Having done all that, you might want to get going with configuring a
Web site. The first thing you need to do is set up the Apache config
file, usually called <em>httpd.conf</em>.</p>
<p>
<h3><a name="configuring httpd.conf">Configuring <em>httpd.conf</em></a></h3>
<p>The following is an example configuration for a single virtual host to
use EmbperlObject. There are, as usual, different ways to do this; 
but
if you are starting from scratch, then it may be useful as a
template. It works with the later versions of Apache (1.3.6 and
up). Obviously, substitute your own IP address and domain name.</p>
<pre>
        NameVirtualHost 10.1.1.3:80
		
        &lt;VirtualHost 10.1.1.3:80&gt;
                ServerName www.mydomain.com
                ServerAdmin webmaster@mydomain.com
                DocumentRoot /www/mydomain/com/htdocs
                DirectoryIndex index.html
                ErrorLog /www/mydomain/com/logs/error_log
                TransferLog /www/mydomain/com/logs/access_log
                PerlSetEnv EMBPERL_ESCMODE 0
                PerlSetEnv EMBPERL_OPTIONS 16
                PerlSetEnv EMBPERL_MAILHOST mail.mydomain.com
                PerlSetEnv EMBPERL_OBJECT_BASE base.epl
                PerlSetEnv EMBPERL_OBJECT_FALLBACK notfound.html
                PerlSetEnv EMBPERL_DEBUG 0
        &lt;/VirtualHost&gt;
		
        # Set EmbPerl handler for main directory
        &lt;Directory &quot;/www/mydomain/com/htdocs/&quot;&gt;
                &lt;FilesMatch &quot;.*\.html$&quot;&gt;
                        SetHandler  perl-script
                        PerlHandler HTML::EmbperlObject
                        Options     ExecCGI
                &lt;/FilesMatch&gt;
                &lt;FilesMatch &quot;.*\.epl$&quot;&gt;
                        Order allow,deny
                        Deny From all
                &lt;/FilesMatch&gt;
        &lt;/Directory&gt;</pre>
<p>Note that you could change the .html file extension in the 
FilesMatch
directive; this is a personal preference issue. Personally, I use
.html for the main document files because I can edit files
using my favorite editor (emacs) and it will automatically load html
mode. Plus, this may be a minor thing - but using .html rather than 
a
special extension such as .epl adds a small amount of security to 
your
site since it provides no clue that the Web site is using Embperl. If
you're careful about the handling of error messages, then there 
never
will be any indication of this. These days, the less the script kiddies 
can
deduce about you, the better ...</p>
<p>Also, note that we have added a second FilesMatch directive, which
denies direct access to files with .epl extensions (again, you could
change this extension to another if you like, for example, .obj). This
can be helpful for cases where you have Embperl files that contain
fragments of code or HTML; you want those files to be in the 
Apache
document tree, but you don't want people to be able to request 
them
directly - these files should only included directly into other
documents from within Embperl, using Execute(). This is really a
security issue. In the following examples, we name files that are
not intended to be requested directly with the .epl extension. Files
that are intended to be directly requested are named with the
standard .html extension. This can also be helpful when scanning a
directory to see which are the main document files and which are 
the
modules. Finally, note that using the Apache FilesMatch directive 
to
restrict access does not prevent us from accessing these files (via
Execute) in Embperl.</p>
<p>So how does all this translate into a real Web site? Let's look
at the classic example, Hello World.</p>

<h3><a name="hello world">Hello World</a></h3>
<p>The file specified by the EMBPERL_OBJECT_BASE apache 
directive
(usually called <em>base.epl</em>) is the lynchpin of how EmbperlObject
operates. Whenever a request comes for any page on this 
Web site,
Emperl will look for <em>base.epl</em> - first in the same directory as the
request, and if it's not found there, then working up the directory tree to
the root directory of the Web site. For example, if a request comes for
http://www.yoursite.com/foo/bar/file.html,</a> then Embperl first looks
for <em>/foo/bar/base.epl</em>. If it doesn't find <em>base.epl</em> there, then
it looks in <em>/foo/base.epl</em>. If there's still no luck, then it finally looks in
<em>/base.epl</em>. (These paths are all relative to the document root for
the Web site). What is the point of all this?</p>
<p>In a nutshell, <em>base.epl</em> is a template for giving a common
look-and-feel to your Web pages. This file is what is used to
build the response to any request, regardless of the actual filename
that was requested. So even if <em>file.html</em> was requested,
<em>base.epl</em> is what is actually executed. <em>base.epl</em> is a normal
file containing valid HTML mixed with Perl code, but with a few
small differences. Here's a simple 'Hello World' example of this
approach:</p>
<p><em>/base.epl</em></p>
<pre>
        &lt;HTML&gt;
        &lt;HEAD&gt;
                &lt;TITLE&gt;Some title&lt;/TITLE&gt;
        &lt;/HEAD&gt;
        &lt;BODY&gt;
        Joe's Website
        &lt;P&gt;
        [- Execute ('*') -]
        &lt;/BODY&gt;
        &lt;/HTML&gt;</pre>
<p><em>/hello.html</em></p>
<pre>
        Hello world!</pre>
<p>Now, if the file http://www.yoursite.com/hello.html</a> is requested, 
then
<em>base.epl</em> is what will get executed initially. So where
does the file <em>hello.html</em> come into the picture? Well, the key is the
'*' parameter in the call to Execute(). '*' is a special filename,
only used in <em>base.epl</em>. It means, literally, ``the filename that
was actually requested.''</p>
<p>What you will see if you try this example is something like this:</p>
<pre>
        Joe's Website</pre>
<pre>
        Hello world!</pre>
<p>As you can see here, the text ``Joe's Web Site'' is from <em>base.epl</em> 
and
the ``Hello world!'' is from <em>hello.html</em>.</p>
<p>This architecture also means that only <em>base.epl</em> has to have the
boilerplate code that each HTML file normally needs to contain -
namely the &lt;HTML&gt; &lt;BODY&gt;, &lt;/HTML&gt; and so on. Since the '*' 
file is
simply inserted into the code, all it needs to contain is the actual
content that is specific to that file. Nothing else is necessary,
because <em>base.epl</em> has all the standard HTML trappings. Of 
course,
you'll probably have more interesting content, but you get the point.</p>

<h3><a name="websiteglobal variables">Web Site Global Variables</a></h3>
<p>Let's look at a more interesting example. When you 
create
Perl variables in Embperl usually their scope is the current file;
so they are effectively ``local'' to that file. When you split
your Web site into modules, however, it quickly becomes 
apparent
that it is useful to have variables that are global to the
Web site, i.e., shared between multiple files.</p>
<p>To achieve this, EmbperlObject has a special object that is
automatically passed to each page as it is executed. This object is
usually referred to as the ``Request'' object, because we get one of
these objects created for each document request that the Web 
server
receives. This object is passed in on the stack, so you can retrieve
it using the Perl ``shift'' statement. This object is also automatically
destroyed after the request, so the Request object cannot be used 
to
store data between requests. The idea is that you can store 
variables
that are local to the current request, and shared between all
documents on the current Web site; plus, as we'll see later, we can
also use it to call object methods. For example, let's say you set 
up
some variables in <em>base.epl</em>, and then use them in <em>file.html</em>:</p>
<p><em>/base.epl</em></p>
<pre>
        &lt;HTML&gt;
        &lt;HEAD&gt;
                &lt;TITLE&gt;Some title&lt;/TITLE&gt;
        &lt;/HEAD&gt;
        [- 
                $req = shift;
                $req-&gt;{webmaster} = 'John Smith'
        -]
        &lt;BODY&gt;
        [- Execute ('*') -]
        &lt;/BODY&gt;
        &lt;/HTML&gt;</pre>
<p><em>/file.html</em></p>
<pre>
        [- $req = shift -]
        Please send all suggestions to [+ $req-&gt;{webmaster} +].</pre>
<p>You can see that EmbperlObject is allowing us to set up global
variables in one place and share them throughout the Web site. If 
you
place <em>base.epl</em> in the root document directory, you can have 
any
number of other files in this and subdirectories, and they will all
get these variables whenever they are executed. No matter which 
file
is requested, <em>/base.epl</em> is executed first and then the 
requested
file.</p>
<p>You don't even need to include the requested '*' file, but typically you will
have to - it would be a bit odd to 
ignore
the requested file!</p>

<h3><a name="modular files">Modular Files</a></h3>
<p>The previous example is nice; it demonstrates the basic ability to
have Web site-wide variables set up in <em>base.epl</em> and then
automatically have them shared by all other files. Leading on from this, we
probably want to split up our files, for both maintainability and
readability. For example, a non-trivial Web site will probably define
some Web site-wide constants, perhaps some global variables, and 
maybe
also have some kind of initialization code that has to be executed
for each page (e.g. setting up a database connection). We could 
put
all of this in <em>base.epl</em>, but this file would quickly begin to look
messy. It would be nice to split this stuff out into other
files. For example:</p>
<p><em>/base.epl</em></p>
<pre>
        &lt;HTML&gt;
        [- Execute ('constants.epl')-]
        [- Execute ('init.epl')-]
        &lt;HEAD&gt;
                &lt;TITLE&gt;Some title&lt;/TITLE&gt;
        &lt;/HEAD&gt;
        &lt;BODY&gt;
        [- Execute ('*') -]
        &lt;/BODY&gt;
        [- Execute ('cleanup.epl') -]
        &lt;/HTML&gt;</pre>
<p><em>/constants.epl</em></p>
<pre>
        [-
                $req = shift;
                $req-&gt;{bgcolor} = &quot;white&quot;;
                $req-&gt;{webmaster} = &quot;John Smith&quot;;
                $req-&gt;{website_database} = &quot;mydatabase&quot;;
        -]</pre>
<p><em>/init.epl</em></p>
<pre>
        [-
                $req = shift;
                # Set up database connection
                use DBI;
                use CGI qw(:standard);
                $dsn = &quot;DBI:mysql:$req-&gt;{website_database}&quot;;
                $req-&gt;{dbh} = DBI-&gt;connect ($dsn);
        -]</pre>
<p><em>/cleanup.epl</em></p>
<pre>
        [-
                $req = shift;
                # Close down database connection
                $req-&gt;{dbh}-&gt;disconnect();
        -]</pre>
<p>You can see how this would be useful, since each page on your 
site
now has a database connection available in $req-&gt;{dbh}. Also 
notice
that we have a <em>cleanup.epl</em> file that is always executed at the
end - this is useful for cleaning up, shutting down connections
and so on.</p>

<h3><a name="modular file inheritance">Modular File Inheritance</a></h3>
<p>To recap, we have seen how we can break our site into modules 
that
are common across multiple files, because they are automatically
included by <em>base.epl</em>. Inheritance is a way in which we can 
make
our Web sites more modular.</p>
<p>Although the concept of inheritance is one that stems from the
object-oriented paradigm, you really don't need to be an OO guru to
understand it. We will demonstrate the concept through a simple
example.</p>
<p>Say you wanted different parts of your Web site to have different
&lt;TITLE&gt; tags. You could set the title in each page manually, but if
you had a number of different pages in each section, then this 
would
quickly get tiresome. We could split off the &lt;HEAD&gt; section 
into
its own file, just like <em>constants.epl</em> and <em>init.epl</em>, right? But
so far, it looks like we are stuck with a single <em>head.epl</em> file for
the entire Web site, which doesn't really help much.</p>
<p>The answer lies in subdirectories. This is the key to unlocking
inheritance and one of the most powerful features of
EmbperlObject. You may use subdirectories currently in your 
Web site
design, maybe for purposes of organization and maintenance. But 
here,
subdirectories actually enable you to override files from upper
directories. This is best demonstrated by example (simplified to 
make
this specific point clearer - assume <em>constants.epl</em>, <em>init.epl</em>
and <em>cleanup.epl</em> are the same as in the previous example):</p>
<p><em>/base.epl</em></p>
<pre>
        &lt;HTML&gt;
        [- Execute ('constants.epl')-]
        [- Execute ('init.epl')-]
        &lt;HEAD&gt;
        [- Execute ('head.epl')-]
        &lt;/HEAD&gt;
        &lt;BODY&gt;
        [- Execute ('*') -]
        &lt;/BODY&gt;
        [- Execute ('cleanup.epl') -]
        &lt;/HTML&gt;</pre>
<p><em>/head.epl</em></p>
<pre>
        &lt;TITLE&gt;Joe's Website&lt;/TITLE&gt;</pre>
<p><em>/contact/head.epl</em></p>
<pre>
        &lt;TITLE&gt;Contacting Joe&lt;/TITLE&gt;</pre>
<p>Assume that we have an <em>index.html</em> file in each directory 
that
does something useful. The main thing to focus on is
<em>head.epl</em>. You can see that we have one instance of this file in
the root directory, and one in a subdirectory, namely
<em>/contact/head.epl</em>. Here's the neat part: When a page is 
requested
from your Web site, EmbperlObject will search automatically for
<em>base.epl</em> first in the same directory as the requested page. If it
doesn't find it there, then it tracks back up the directory tree until
it finds the file. But then, when executing <em>base.epl</em>, any
files that are Executed (such as <em>head.epl</em>) are first looked for
in the <strong>original directory</strong> of the requested file. Again, if the file
is not found there, then EmbperlObject tracks back up the directory
tree.</p>
<p>So what does this mean? Well, if we have a subdirectory, 
then
we can see whether we want just the usual <em>index.html</em> file and 
nothing
else. In that case, all the files included by <em>base.epl</em> will be
found in the root document directory. But if we redefine 
<em>head.epl</em>, then EmbperlObject will pick up that version of 
the
file whenever we are in the /contact/ subdirectory.</p>
<p>That is inheritance in action. In a nutshell, subdirectories inherit
files such as <em>head.epl</em>, <em>constants.epl</em> and so on from ``parent'' directories. But if we want, we can redefine any of these
files in our subdirectories, thus specializing that functionality for
that part of our Web site. If we had 20 .html files in /contact/, then
loading any of them would automatically get
<em>/contact/head.epl</em>.</p>
<p>This is all very cool, but there is one more wrinkle. Let's say we
want to redefine <em>init.epl</em>, because there is some initialization
that is specific to the /contact/ subdirectory. That's fine since we can
create <em>/contact/init.epl</em> and that file would be loaded instead of
<em>/init.epl</em> whenever a file is requested from the /contact/
subdir. But this also means that the initialization code that is in
<em>/init.epl</em> would never get executed, right? That's bad, because 
the
base version of the file does a lot of useful set up. The answer is
simple: For cases such as this, we need to make sure to call the parent
version of the file at the start. For example:</p>
<p><em>/contact/init.epl</em></p>
<pre>
        [- Execute ('../init.epl') -]</pre>
<pre>
        [-
                # Do some setup specific to this subdirectory
        -]</pre>
<p>You can see that the first thing we do here is Execute the
parent version of the file (i.e., the one in the immediate parent
directory). Thus we can ensure the integrity of the basic
initialization that each page should receive.</p>
<p>EmbperlObject is smart about this process. For example, 
we
have a situation where we have several levels of subdirectory; then,
say we only redefine <em>init.epl</em> in one of the deeper levels, say
<em>/sub/sub/sub/init.epl</em>. Now, if this file tries to Execute
<em>../init.epl</em>, there may not be any such file in the immediate
parent directory - so EmbperlObject automatically tracks back up 
the
directories until it finds the base version, <em>/init.epl</em>. So, for
any subdirectory level in your Web site, you only have to redefine
those files that are specific to this particular area. This results
in a much cleaner Web site.</p>
<p>You can break up your files into whatever level of granularity you
want, depending on your needs. For instance, instead of just
<em>head.epl</em> you might break it down into <em>title.epl</em>,
<em>metatags.epl</em> and so on. It's up to you. The more you split it up,
the more you can specialize in each of the subdirectories. There is 
a
balance, however, because splitting things up too much results in an
overly fragmented site that can be harder to maintain. Moderation is
the key - only split out files if they contain a substantial chunk of
code, or if you know that you need to redefine them in 
subdirectories,
generally speaking.</p>

<h3><a name="subroutines in embperlobject">Subroutines in EmbperlObject</a></h3>
<p>There are two types of inheritance in EmbperlObject. The first is the
one that we described in the previous section, i.e., inheritance of
modular files via the directory hierarchy. The other type, which is closely
related, is the inheritance of subroutines (both pure Perl and
Embperl). In this context, subroutines are really object methods, as
we'll see below. As you are probably already aware, there are two
types of subroutines in Embperl, for example:</p>
<pre>
        [!
                sub perl_sub
                {
                        # Some perl code
                }
        !]
		
        [$ sub embperl_sub $]
                Some HTML
        [$ endsub $]</pre>
<p>In EmbperlObject, subroutines become object methods; the 
difference is
that you always call an object method through an object reference. 
For
example, instead of a straight subroutine call like this:</p>
<pre>
        foo();</pre>
<p>We have instead a call through some object:</p>
<pre>
        $obj-&gt;foo();</pre>
<p>EmbperlObject allows you to inherit object methods in much the 
same
way as files. Because of the way that Perl implements objects and
methods, there is just a little extra consideration needed. (Note:
This is not really a good place to introduce Perl's object
functionality. If you're not comfortable with inheritance, @ISA and
object methods, then I suggest you take a look at the book
``Programming Perl'' (O'Reilly) or ``Object Oriented Perl'' by Damien
Conway (Manning).)</p>
<p>A simple use of methods can be demonstrated using the following
example:</p>
<p><em>/base.epl</em></p>
<pre>
        [! sub title {'Joe's Website'} !]
        [- $req = shift -]
        &lt;HTML&gt;
        &lt;HEAD&gt;
        &lt;TITLE&gt;[+ $req-&gt;title() +]&lt;/TITLE&gt;
        &lt;/HEAD&gt;
        &lt;/HTML&gt;</pre>
<p><em>/contact/index.html</em></p>
<pre>
        [! sub title {'Contacting Joe'} !]
        [- $req = shift -]
        &lt;HTML&gt;
                A contact form goes here
        &lt;/HTML&gt;</pre>
<p>This is an alternative way of implementing the previous ``contact''
example, which still uses inheritance - but instead of placing the
&lt;TITLE&gt; tag in a separate file (<em>head.epl</em>), we use a method
(title()). You can see that we define this method in
<em>/base.epl</em>, so any page that is requested from the root 
directory
will get the title ``Joe's Web Site.'' This is a good default
title. Then, in <em>/foo/index.html</em> we redefine the <code>title()</code> method
to return ``Contacting Joe.'' Inheritance ensures that when the call to
<code>title()</code> occurs in <em>/base.epl</em>, the correct version of the method
will be executed. Since <em>/foo/index.html</em> has its own version of 
that
method, it will automatically be called instead of the base
version. This allows each file to potentially redefine methods
that were defined in <em>/base.epl</em>, and it works well. But, as your
Web sites get bigger, you will probably want to split off some 
routines
into their own files.</p>
<p>EmbperlObject also allows us to create special files that
contain only inheritable object methods. EmbperlObject can set up 
@ISA for
us, so that the Perl object methods will work as expected. To do 
this,
we need to access our methods through a specially created object
rather than directly through the Request object (usually called $r or
$req). This is best illustrated by the following example, which
demonstrates the code that needs to be added to <em>base.epl</em> and 

shows how we implement inheritance via a subdirectory. Once 
again,
assume that missing files such as <em>constants.epl</em> are the same 
as
the previous example (Note that the 'object' parameter to Execute only works in
1.3.1 and above).</p>
<p><em>/base.epl</em></p>
<pre>
        &lt;HTML&gt;
        [- $subs = Execute ({object =&gt; 'subs.epl'}); -]
        [- Execute ('constants.epl') -]
        [- Execute ('init.epl') -]
        &lt;HEAD&gt;
        [- Execute ('head.epl') -]
        &lt;/HEAD&gt;
        &lt;BODY&gt;
        [- Execute ('*', $subs) -]
        &lt;/BODY&gt;
        [- Execute ('cleanup.epl') -]
        &lt;/HTML&gt;</pre>
<p><em>/subs.epl</em></p>
<pre>
        [!
                sub hello
                {
                        my ($self, $name) = @_;
                        print OUT &quot;Hello, $name&quot;;
                }
        !]</pre>
<p><em>/insult/index.html</em></p>
<pre>
        [-
                $subs = $param[0];
                $subs-&gt;hello (&quot;Joe&quot;);
        -]</pre>
<p><em>/insult/subs.epl</em></p>
<pre>
        [! Execute ({isa =&gt; '../subs.epl'}) !]

        [!
                sub hello
                {
                        my ($self, $name) = @_;
                        $self-&gt;SUPER::hello ($name);
                        print OUT &quot;, you schmuck&quot;;
                }
        !]</pre>
<p>If we requested the file <em>/insult/index.html</em>, then we would see
something like:</p>
<pre>
        Hello, Joe, you schmuck</pre>
<p>So what is happening? First, note that we create a $subs
object in <em>base.epl</em>, using a special call to Execute(). We then
pass this object to files that will need it, via an <code>Execute()</code>
parameter. This can be seen with the '*' file.</p>
<p>Next, we have two versions of <em>subs.epl</em>. The first, <em>/subs.epl</em>,
is pretty straightforward. All we need to do is remember that all of
these subroutines are now object methods, and so take the extra
parameter ($self). The basic <code>hello()</code> method simply says Hello to the
name of the person passed in.</p>
<p>Then we have a subdirectory, called /insult/. Here we have another
instance of <em>subs.epl</em>, and we redefine hello(). We call the parent
version of the function, and then add the insult (``you schmuck''). 
You
don't have to call the parent version of methods you define, of
course, but it's a useful demonstration of the possibilities.</p>
<p>The file <em>/insult/subs.epl</em> has to have a call to <code>Execute()</code> that
sets up @ISA. This is the first line. You might ask why 
EmbperlObject
doesn't do this automatically; it is mainly for reasons of
efficiency. Not every file is going to contain methods that need
to inherit from the parent file, and so simply requiring this one line
seemed to be a good compromise. It also allows for more
flexibility, as you can include other arbitrary files into
the @ISA tree if you want.</p>

<h3><a name="conclusions">Conclusions</a></h3>
<p>So there you have it: an introduction to the use of EmbperlObject 
for
constructing large, modular Web sites. You will probably use it to
enable such things as Web site-wide navigation bars, table layouts 
and
whatever else needs to be modularized.</p>
<p>This document is just an introduction, to give a broad flavor of the
tool. You should refer to the actual documentation for details.</p>
<p>EmbperlObject will inevitably evolve as developers discover what is
useful and what isn't. We will try to keep this document up-to-date
with these changes, but make sure to check the Embperl 
Web site
regularly for the latest changes.</p>


        </div>



    </div>
    <div class="asset-footer"></div>
</div>


                            
                            <div id="entry-1474" class="entry-asset asset hentry">
    <div class="asset-header">
        <h2 class="asset-name entry-title"><a href="/pub/2001/03/p5pdigest/THISWEEK-20010312.html" rel="bookmark">This Week on p5p 2001/03/12</a></h2>
        <div class="asset-meta">
            <span class="byline">
    
                By <span class="vcard author">Simon Cozens</span> on <abbr class="published" title="2001-03-12T00:00:00-08:00">March 12, 2001 12:00 AM</abbr>
    
            </span>

            
            

        </div>
    </div>
    <div class="asset-content entry-content">

        <div class="asset-body">
            </P>

<P>


<!-- This week on perl5-porters (06-12 Mar 2001) -->

<br />
<br />
      <H3><a name="Notes">Notes</a></H3>

</P>

<P>

You can subscribe to an email version of this summary by sending an
empty message to 
<a href="mailto:perl5-porters-digest-subscribe@netthink.co.uk"><tt>perl5-porters-digest-subscribe@netthink.co.uk</tt>.</a></P>

<P>
Please send corrections and additions to 
<CODE>perl-thisweek-YYYYMM@simon-cozens.org</CODE> where 
<CODE>YYYYMM</CODE> is the current year and month. Changes and additions to the 
<a href="http://simon-cozens.org/writings/whos-who.html">perl5-porters biographies</a> are particularly welcome.
</P>

<P>
There were 424 messages this week.
<H3><a name="Pod_Questions">Pod Questions</a></H3>

</P>

<P>

As reported last week, Michael Stevens has been working away on
attempting to make the core Perl documentation 
<CODE>podchecker</CODE>-clean, and has succeeded in stopping it from emitting any errors.
However, he came up with quite a few weirdnesses. The most contentious
was the correct way to write:
</P>

</P><PRE>
     L&lt;New C&lt;qr//> operator>
</PRE>

<P>
since 
<CODE>L<></CODE> was seeing the slash and thinking it was a section/manpage separator.
<a href="http://simon-cozens.org/writings/whos-who.html#ALLBERY">Russ Allbery</a> said that the best way was
</P>

</P><PRE>
    L&lt;"New C&lt;qr//> operator">
</PRE>

<P>
but the problem with that is that the resulting reference gets quoted. 
And, in fact, 
<CODE>podchecker</CODE> was still unhappy with that. Russ said:
<blockquote>podchecker complains about all sorts of things that I consider to be
perfectly valid POD, such as the use of &lt; and &gt; in free text to mean
themselves when not preceeded by a capital letter.  I think making
podchecker smarter is the right solution. 
</blockquote></P>

<P>
But as Michael said, &quot;the problem is finding a clear definition of what
&quot;smarter&quot; actually is.&quot; 
</P>

<P>
I also complained that
</P>

</P><PRE>
    =head2 New C&lt;qr//> operator
</PRE>

<P>
was getting mangled by some parsers which didn't correctly restore
boldface after the code section. The example I gave, 
<CODE>pod2man</CODE>, seemed to be due to a buggy set of roff macros. 
</P>

<P>
Rob Napier came up with some 
<a href="http://www.xray.mpe.mpg.de/mailing-lists/perl5-porters/2001-03/msg00365.html">truly excellent</a> suggestions about the future of POD and how to make it more intuitive,
and Russ tried to shoo people onto the
<a href="http://lists.perl.org/showlist.cgi?name=pod-people">pod-people mailing list</a> for further discussion of what changes should be made.
<H3><a name="Patching_perlyy">Patching perly.y</a></H3>

</P>

<P>

Jeff Pinyan 
<!-- who I can no longer avoid mentioning, because this is actually Useful Information --> asked how one should go about patching the Perl grammar in 
<CODE>perly.y</CODE>; the answer, coming in three parts from myself, Peter Prymmer and 
<a href="http://simon-cozens.org/writings/whos-who.html#SUGALSKI">Dan Sugalski</a>, is:
</P>

<P>
1) Don't. You hardly ever need to.
</P>

<P>
2) Run 
<CODE>make run_byacc</CODE> which runs the 
<CODE>byacc</CODE> parser generator, and then applies a small patch to the resulting C
file which allows dynamic memory allocation.
</P>

<P>
3) Run
<CODE>vms/vms_yfix.pl</CODE> to patch up the VMS version of the parser.
</P>

<P>
4) CC 
<CODE>perl-mvs@perl.org</CODE> so that the EBCDIC people can prepare EBCDIC-aware versions of the
parser.
<H3><a name="CvOUTSIDE">CvOUTSIDE</a></H3>

</P>

<P>

<a href="http://simon-cozens.org/writings/whos-who.html#BURLISON">Alan</a> asked what 
<CODE>CvOUTSIDE</CODE> was for; it's another undocumented flag on a CV.
<a href="http://simon-cozens.org/writings/whos-who.html#GURUSAMY">Sarathy </a> knows the answer, and it's scary:
<!-- Lexicals? Scary? Who'd a thought it? --><blockquote>Every CV that references lexicals from its outer lexical scopes needs
to be able to access that outer scope's scratchpad at run time (via
<CODE>pp_anonsub()</CODE>, 
<CODE>cv_clone2()</CODE> and 
<CODE>pad_findlex()</CODE>) to capture the lexicals
that are visible at the time the cloning happens.  In fact, all CVs need
to have this whether they have outer lexicals referenced in them or
not, given that 
<CODE>eval""</CODE> requires visibility of the outer lexical scopes.
</blockquote></P>

<P>
Hence, (I think) 
<CODE>CvOUTSIDE</CODE> is a pointer to the scratchpad of the outer lexical scope. Why is this
 important? Well, Alan's Great Subroutine Memory Leak (the problem with 
<CODE>sub x { sub {} }</CODE>) has come about because there's a reference count loop. As Sarathy
explains:
<blockquote>The problem really is that there is a reference loop.  The prototype
anonymous sub holds a reference count on the outer sub via 
<CODE>CvOUTSIDE()</CODE>.
The outer sub holds a reference count on the anonymous sub prototype
via the pad entry allocated by 
<CODE>OP_ANONCODE</CODE>.  The pad entry will be
properly freed by 
<CODE>op_clear()</CODE> if it ever gets there, which it doesn't
because of the loop.
</blockquote></P>

<P>
Sarathy had a couple of attempts at fixing this, but hasn't managed to
resolve it yet.
<H3><a name="perlxstut_Documentation">perlxstut Documentation</a></H3>

</P>

<P>

Vinh Lam reminded us that 
<CODE>perlxstut</CODE> is incomplete. Examples 6, 7, 8, and 9 are still not written. Does
anyone out there want to write them?
<H3><a name="EBCDIC_and_Unicode">EBCDIC and Unicode</a></H3>

</P>

<P>

With the assistance of Merijn Broeren and Morgan Stanley Dean Witter, I
gained access to an EBCDIC mainframe and spent a happy day sanitizing
the Unicode support on EBCDIC machines. As usual, there was some small
argument over semantics,
<!-- and, as usual, some of the more vocal participants had blatantly obviously never even attempted to implement anything like this themselves --> but the major change was that EBCDIC should be 
converted to ASCII before being upgraded to UTF8, and converted back to
EBCDIC on degradation. 
<a href="http://simon-cozens.org/writings/whos-who.html#PRYMMER">Peter Prymmer</a> seemed happy enough with what we'd been doing, and the patch went in.
The patch, and its discussion, can be found 
<a href="http://www.xray.mpe.mpg.de/mailing-lists/perl5-porters/2001-03/msg00441.html">here</a>.
</P>

<P>
If you don't want to read the whole business, this is the important bit:
much of the Unicode discussion this week centered on the vexed question
of &quot;What are v-strings for?&quot;. 
<a href="http://www.xray.mpe.mpg.de/mailing-lists/perl5-porters/2001-03/msg00549.html">Here</a> is the definitive answer from Larry.
<H3><a name="PERL_DL_NONLAZY">PERL_DL_NONLAZY</a></H3>

</P>

<P>

<a href="http://simon-cozens.org/writings/whos-who.html#SCHWERN">Michael Schwern</a> asked what the mysterious
<CODE>PERL_DL_NONLAZY</CODE> environment variable was for - it's set on 
<CODE>make test</CODE> but never documented. He noted that as well as being used to alter the
dynamic linking behaviour, it's used by some test suites to determine
whether or not to produce additional information - almost certainly a
misuse.
</P>

<P>
Paul Johnson explained that it passes a flag to 
<CODE>dlopen</CODE> which attempts to ensure that all functions are relocated as soon as
the shared object is loaded. Sounds complicated? In the normal, &quot;lazy&quot;
operation of the dynamic loader, the loader doesn't actually load all
the functions from the library file into memory at one go - instead, it
merely notices that it has a bunch more functions available; when a
function is called, it loads up the appropriate part of the object into
memory, and jumps to it. (Not entirely unlike the behaviour of 
<CODE>use autouse</CODE> or 
<CODE>AutoSplit</CODE>.) 
</P>

<P>
Setting [PERL_DL_NONLAZY] forces the loader to load up all functions at
once, so that it can ensure that it really does have code for all the
functions it claims to have code for; this is usually what you want to
do when testing. 
<H3><a name="Various">Various</a></H3>

</P>

<P>

Sarathy fixed the &quot;weird reset bug&quot; of last week with a clever but
untested patch; Chris Nandor dropped a bunch of good MacPerl protability
patches. Ilya finally produced his rival UTF8 regular expressions patch,
which Jarkko has been vigorously testing.
</P>

<P>
David Madison raised the 
<CODE>my $var if $x</CODE> bugbear again. Schwern's been cleaning up 
<CODE>Test::Harness</CODE>; good work as always, there. Robin Houston fixed a strange bug
regarding 
<CODE>my</CODE> variables being cleared after a 
<CODE>goto</CODE> during a three-fingered 
<CODE>for</CODE> loop. Radu Greab fixed something strange with 
<CODE>chop</CODE> and arrays. 
</P>

<P>
 There was a small but pointless discussion of C coding styles,
which concluded that you ought to leave off braces around single-statement 
blocks to 
<CODE>if</CODE> and the like if you can. 
</P>

<P>
Tony Finch complained that 
<CODE>use integer</CODE> doesn't make 
<CODE>rand</CODE> return integers;
<a href="http://simon-cozens.org/writings/whos-who.html#NEWTON">Philip Newton</a> provided a patch.
</P>

<P>
Congratulations to Raphael Manfredi, who spawned his first child 
process this week.
</P>

<P>
Until next week I remain, your humble and obedient servant,
</P>

<hr>

<a href="mailto:simon@brecon.co.uk">Simon Cozens</a>


<ul>
  <li><a href="#Notes">Notes</a>
  <li><a href="#Pod_Questions">Pod Questions</a>
  <li><a href="#Patching_perlyy">Patching perly.y</a>
  <li><a href="#CvOUTSIDE">CvOUTSIDE</a>
  <li><a href="#perlxstut_Documentation">perlxstut Documentation</a>
  <li><a href="#EBCDIC_and_Unicode">EBCDIC and Unicode</a>
  <li><a href="#PERL_DL_NONLAZY">PERL_DL_NONLAZY</a>
  <li><a href="#Various">Various</a>
</ul>

        </div>



    </div>
    <div class="asset-footer"></div>
</div>


                            
                            <div id="entry-1466" class="entry-asset asset hentry">
    <div class="asset-header">
        <h2 class="asset-name entry-title"><a href="/pub/2001/03/gui.html" rel="bookmark">Writing GUI Applications in Perl/Tk</a></h2>
        <div class="asset-meta">
            <span class="byline">
    
                By <span class="vcard author">Nick Temple</span> on <abbr class="published" title="2001-03-06T00:00:00-08:00">March  6, 2001 12:00 AM</abbr>
    
            </span>

            
            

        </div>
    </div>
    <div class="asset-content entry-content">

        <div class="asset-body">
            <!-- Writing GUI Applications in Perl/Tk -->

<br />
<p><i>"This article originally appeared in Visual Developer Magazine"</i></p>
 
<p>Perl is officially known as the "Practical Extraction and Report Language," in part because of its extremely robust text handling abilities. Perl's author, Larry Wall, has a much more colorful name for the language: the "Pathologically Eclectic Rubbage Lister." Many people are aware of Perl's role in the Web, specifically as an easy-to-use text processing language for writing CGI scripts. What many people don't realize, however, is that Perl is a powerful general purpose programming language that can be used to do general-purpose development-- including cross-platform GUI development with the Tk tool kit originally developed for the Tcl programming language under Unix. An important advantage of using the pTk (Perl/Tk) combination is that you can write truly portable cross-platform GUI applications-- applications that will work similarly across Win32, Macintosh, Linux, and even the AS/400!</p> 

<p>In this article, I will introduce the basics of installing the Perl interpreter for Win32 and writing a visual application using the Tk (toolkit) modules. This system is geared toward the Win32 and Linux developers; however, most of the information presented pertains to other operating systems as well.</p>

<h3>A Point-of-Sale Terminal in pTk</h3>

<p>My expertise lies in electronic commerce. So when I decided to write this article, I naturally looked around to see what might be useful to others using the pTk system. One project I've worked on recently is integrating the PaymentNet credit-card processing client software into various applications. I decided that it would be great to have a system that could do all my credit-card processing from my local PC, for testing as well as for real e-commerce. So I created a pTk Point-of-Sale (POS) terminal program to do so. For many merchants, it is less expensive (and faster) to use the Internet to process their credit card (or check) transactions than to purchase additional software or terminals. 
</p>

<table border="0" cellpadding="3" cellspacing="0" align="center">
<tr>
<td valign="top">
<img src="/pub/2001/03/graphics/fig1.jpg" border="0" width="450" alt="The terminal under Windows 95">
</td>
</tr>
<tr>
<td valign="top" align="center">   
<b>Figure 1: The terminal under Windows 95.</b>
</td>
</tr>
</table>
 
<p>The example system uses a simulated credit-card authorization module that does nothing except verify that the transaction could be a valid one. Real transactions can be implemented quite easily; I'll show you how at the end of the article. Of course, the code works with any pTk system. You can see it running under both Windows 95 (Figure 1) and Linux (Figure 2).</p>

<table border="0" cellpadding="3" cellspacing="0" align="center">
<tr>
<td valign="top">
<img src="/pub/2001/03/graphics/fig2.jpg" border="0" width="450" alt="Figure 2: The terminal under Linux.">
</td>
</tr>
<tr>
<td valign="top" align="center">   
<b>Figure 2: The terminal under Linux.</b>
</td>
</tr>
</table>
   
<p>
We will cover a lot of ground very quickly in this article, and of necessity, will gloss over quite a few very important points. Perl comes with some of the best documentation available in the form of POD (plain old documentation) files, and a search/viewing program called perldoc. Whenever you get stuck, chances are the answer to your questions will be right on your local computer. For now, you can find more information by typing perldoc perldoc from the command line-- once Perl is installed, of course! I'll remind you of this a couple of times.</p>

<p>First, we'll need to install both Perl and the Tk libraries. If you are using Linux, this will mean compiling the libraries as well, though that is not at all difficult. Then we'll look at what it takes to make a pTk program: program flow, geometry management, event and variable bindings, and the event loop. I'll then do a brief walk through the code, showing examples of various widget (object) use within the system. You should then be well on your way to being an expert pTk programmer!
</p>
<h3>Installing ActiveState Perl for Win32</h3>

<p>To install the latest version of Perl for Win32, go to the ActiveState download page (<a href="http://www.activestate.com/Active-Perl/download.htm">www.activestate.com/Active-Perl/download.htm</a>). For Windows 98 and Windows NT, there are no special instructions; download the latest version (APi517e.exe as of this writing), and run the self-installer by double clicking on the file. For Windows95, however, you need to make sure that you have DCOM installed (it's already installed on Win98 and NT machines). The DCOM files and installation instructions are available from the Microsoft's Web site at <a href="http://www.microsoft.com/com/dcom/dcom95/dcom1_3.asp">www.microsoft.com/com/dcom/dcom95/dcom1_3.asp</a>. 
</p>
<h3>Installing the Perl/Tk Modules with Perl Package Manager</h3>

<p>ActiveState extended the standard CPAN modules (Comprehensive Perl Archive, which we will discuss shortly) with its own Perl Package Manager (PPM). The package manager makes installing and configuring the modules extremely easy. Note that the primary difference (other than user interface) between Perl's standard CPAN module and the PPM is that CPAN deals exclusively with source code, requiring that you compile and install both Perl and the relevant modules from a source code distribution. ActiveStates' package manager, on the other hand, deals with pre-compiled modules that install on the host platform without compiling.
</p>
<p>Assuming your Perl has been installed properly, you should now be able to go to the DOS command prompt and run the Perl Package Manager by typing PPM. You can get summary help information by typing "PPM -h". To use the PPM, you must be connected to the Internet. More PPM documentation can be found at www.activestate.com/ppm. You can also (as always) type "perldoc PPM" to get the documentation that comes with the module distribution.
</p>
<p>To download and install a single package, just type "install tk" from the PPM prompt. Be aware that the Tk module, a complete GUI development environment for Perl, is pretty big. The zip file on which the package is based is over 2MB in size, so the download can take a while, especially over a standard modem. Go ahead and install Tk, as it is required for the rest of this project. Also, if you have an older ActiveState Perl distribution (Perl5.004 or earlier), I suggest upgrading to the latest install now. If you don't, the example program may not run. Specifically, you will need Data::Dumper installed, which you can load by typing "install Data-Dumper" from the PPM prompt, if you don't already have it.
</p>
<h3>Installing Perl and Tk Under Linux</h3>

<p>One of Perl's great strengths is that there are hundreds of individual modules available for the language. All current builds of Perl come with a module-manager to be used with the Comprehensive Perl Archive Network (CPAN). Currently, CPAN lists over 260MB of source code! Windows users can also use CPAN if they've taken the time to compile their own version of Perl, rather than using ActiveState's binary distribution. 
</p>
<p>For my Linux desktop, I use the K Desktop Environment (KDE) that comes with the Caldera Open Linux 2.2 distribution. To run the system, make sure that you have both Perl and the gcc development environment installed. The following minimal packages are needed to install and run the system:</p>
<ul>
<li>Perl </li>
<li>egcs </li>
<li>glibc </li>
<li>Xfree86-devel (For X-Windows header files)</li>
</ul>

<p>To verify that the packages are installed (or to install them if they aren't):</p>
<ul>
<li>
Make sure that the Open Linux CD is in the drive. 
<li>Log in as "root". </li>
<li>Click on the icon that looks like a house, labeled "Caldera Open Administration System" (COAS).</li> 
<li>Select "Software".</li> 
<li>When the window comes up, select "Workstation | Administration | Software".</li> 
<li>Make sure that "kpackage" is checked.</li></ul> 
<p>This will install the K package manager if it isn't already installed. Now click "K | Utilities", and then select "kpackage". The kpackage tree structure is a little easier to use and provides more information than the COAS, though they both manage distribution packages. If you are missing one of the packages above, simply select new from within the kpackage tree, select the package you want to install, and then click "examine" in the bottom right panel. A new dialog will pop up, allowing you to install the selected package.</p>
</p>
<h3>Installing and Building Tk Using CPAN</h3>

<p>To install and build the Tk libraries and Perl interface, it is necessary to execute the CPAN module. Open a command window (while still logged in as root), and execute the following command:

<pre>perl -MCPAN -e shell;</pre>


<p>Perl will load the module CPAN (-MCPAN), and execute (-e) the shell subroutine contained in the module. If this is your first time executing the script, it will ask you configuration questions. If you are unsure of the answers, just hit Enter. In most cases, the defaults are appropriate for your system. Eventually, you will be dropped into a "cpan>" prompt. At this point, you can type "h" for help, or go directly to the next step. To finish configuration, there are a few optional modules you should install just to make things a little easier. (If you are on a slow connection, you might want to skip installing the optional modules steps.)
</p>
<p>Install Internet communications modules (optional):
<pre>
cpan> install Bundle::libnet
</pre>
<p>Upgrade CPAN (optional):
<pre>
install Bundle::CPAN
reload CPAN
</pre>

<p>Now, build and install Tk: 

<pre>install Tk
</pre>

<p>This should download, build, and install the Tk packages from the Internet. It's not really any more difficult from using the PPM; however, CPAN does require that a C compiler be installed, which isn't the norm for Windows users.
</p>
<p>Now that both Perl and Tk have been installed in your development environment, spend some time exploring the system. The toolkit comes with a few extremely useful example programs. A simple text editor called ptked is available, as well as ptksh (a GUI shell where you can experiment creating forms and other controls directly within the pTK environment, which is reminiscent of the BASIC command line interface). The widget program is a comprehensive demonstration and testing shell for-- you guessed it-- widget exploration. It's a really fun tool to play with, one that can get you into programming with pTk very quickly. These utilities are available on all systems with pTk installed.
</p>

<h3>pTk Core Concepts</h3>
<p>To understand a pTk program, we need to explore a few core concepts regarding the system design. In particular, you need to be familiar with the structure of the program, the way objects (widgets) are laid out on the screen (geometry management), the way communication is handled (variable and event binding), and the pTk event loop.
</p>
<p>All pTk programs are assembled in pretty much the same way:

<p>Create a main window, which is also known as the top-level window. 
Build a group of widgets (Unix-speak for controls), and arrange them inside the main window. In Perl, a widget is simply an object that contains data and methods to create some visible element of the user interface. 
Start the event loop. Events are then fired, and handled by the widgets and associated code. 
</p>
<h3>Geometry Management</h3>

<p>In a fashion similar to Java, Tk has a notion of "geometry management," which is a fancy way of saying that the software wants to decide where to put your controls for you. Basically, you define the widget, and then tell the system about where you'd like it to go (top, bottom, etc.), and it takes care of sizing and placing the widget for you. We will use the "packer" and "grid" exclusively; however, others are available for different layouts. Since each frame can have its own geometry manager, extremely sophisticated placement schemes can be created using this system.
</p>
<p>I've used the grid() manager to divide the example application into four frames: $filemenu (at the top), $left, $right, and $bottom. The grid manager works like HTML tables: you can specify the row and column for each widget, as well as a columnspan and rowspan, if necessary. The "sticky" option tells the manager where to "attach" the widget, the options being north, south, east, west in any combination. Specifying all four will center your widget within its frame. 
<pre>
my $left  = 
 $mainwindow->Frame->grid(-row => 0, -col => 0, -sticky => 'nw');
</pre>

<p>Keep in mind that a widget won't be displayed until its geometry manager is called. This can be useful to keep controls hidden until you're ready to use them; however, it can also be a source of errors. If you have created a widget but can't see it on the screen, chances are you've forgotten to set its manager.
</p>
<h3>Binding Variables</h3>

<p>Variable binding is one of the most frequently used data input/output mechanisms available to pTk programs. The concept is relatively simple: a variable is bound to a control, and when the state of that control changes, the variable is updated to reflect the new state. The reverse is true as well: changing the state of the variables within the program automagically updates the associated controls. You can see examples of this throughout the source code. Note how saveConfig just dumps the state of the $config hash, and loadConfig does the opposite; the NoteBook control is updated to reflect the state changes without additional work. This is usually accomplished by passing the -variable or -textvariable option to the widget, as well as a reference to the scalar variable you want bound:</p> 


<pre>
$left->Optionmenu (-options => \@trxtype, 
   -variable => \$trans->{TRXTYPE} )->pack();
</pre>

<p>This statement binds the variable $trans->{TRXTYPE} to a select box. Whenever you update the transaction type on the program, the variable changes to reflect the change. Note that the geometry manager (pack() in this case), is called to place the widget on its associated frame and to make it visible. This is a pattern that you will use quite a bit throughout pTk programming, and is central to the event model.</p> 

<h3>Binding Events</h3>
<p>Most action widgets have an optional parameter, "command," that allows you to specify the function that should be called whenever this widget is acted upon in some way. This is a reference to a callback function that will be called when the widget receives an action event-button click, scrollbar release, etc.
<pre>
$bottom->Button(-text => 'Process Transaction', 
        -command => \&processTransaction )
        ->grid(qw/-row 2 -column 0 -sticky nesw/);
</pre>

<p>In this case, the processTransaction function is called whenever the button is pressed. For most standard programs, this is the extent of the event management required, when combined with tied variables described in the previous section.</p>

<p>It is also possible to bind additional events to subroutines by using the bind() call. The general format for doing so is:
<pre>
$widget->bind(event, subroutine);
</pre>


<p>When an event related to your widget fires, the subroutine that has been bound to the command is called. Possible bound events include key clicks and releases, mouse motion, and window resizing. More information can be found using perldoc Tk:bind.</p>

<h3>The Event Loop</h3>
<p>Once everything is set up, the only thing left to do is call MainLoop() from within the program. This goes into an endless loop, dispatching events from the underlying operating system to your applications and updating appropriate bound variables.</p>
<pre>
MainLoop();  # never returns
</pre>

<p>Just as in the pre-Win32 days when we used the cooperative multitasking of Windows 3.1 and text-based frameworks like Turbo Vision and other non-multitasking systems, you must break up any CPU-intensive tasks into manageable chunks by using the after() or repeat() method of most widgets, which are timers used to schedule events. Other methods may work equally well. 
</p>
<p>This time-slicing problem crops up when doing a real transaction over the Internet. The system seems to "freeze" for a few seconds while processing the data, as the call to do so blocks until the data has been received. Unfortunately, this is normal behavior as the current release version of Perl is not yet threaded. However, the newest development version of Perl does incorporate a threaded architecture, so you can expect this limitation to be removed shortly. I noticed that the Perl shipped with the Caldera Open Linux 2.2 distribution has been compiled multi-threaded, though I haven't tried using the new threading features yet.
</p>
<h3>Creating the Application</h3>
<p>Dozens of widgets are available for use in your programs. For our application, I only used a few: filemenu, Optionmenu (a drop-down select box), LabEntry (a text box with related label), and NoteBook, for the configuration control.
</p>
<p>If you look through the source code, you will see the general outline of the way things are done in most pTk applications. First, I declare all the global structures that I will use. This is important, as they will need to be within the scope of the callback routines used. (See <a href="/2001/03/listing1.txt">Listing 1</a>.) I then declare a MAIN block for the program. (See <a href="/2001/03/listing2.txt">Listing 2</a>.) Within the main program, we first create the main window ($mainwindow). Every widget will attach (at some level) to this window:
<pre>
$mainwindow = MainWindow->new();
</pre>

<p>Nothing fancy here. It's best to keep your handle in a global variable, as most of the program will need access to it.
</p>
<h3>Creating the MenuBar</h3>

<p>We then create a frame for the menu bar. A frame keeps parts of the program together logically, and for geometry management, lays out your controls on the screen. If you've used Java, the concept will be familiar. Before a widget can be seen on the screen, you must call a manager to lay it out for you. Each frame can only have one type of manager for its widgets; however, each frame can have multiple frames, making possible quite complex schemes.
</p>
<p>The $menubar consists of a single menu button, $filemenu. Of course, more are possible in larger applications. Attached to $filemenu are the commands you will see in the drop-downs, each specifying the label and a command (that is, a bound subroutine.) Additional options within the menu bar widget allow you to attach colors, checkboxes, and hotkeys to the menu items, as well. 
</p>
<p>Menus under pTk are lists of actions with associated commands, usually contained within a frame. First, you need to create the menu bar frame: 
<pre>
$menubar = 
 $mainwindow->Frame()->pack(-side => 'top', -fill => 'x');
</pre>

<p>After creating the frame, we'll add one button to it:
<pre>
my $filemenu = $menubar->Menubutton(-text => 'File');
</pre>

<p>Multiple top-level items would be added the same way. Now we need to add a few commands to the menu:
<pre>
$filemenu->command( -label  => 'Open Config',
                 -command => \&loadConfig );
$filemenu->command( -label  => 'Save Config',
                 -command => \&saveConfig );
$filemenu->separator();
$filemenu->command(-label  => 'Configuration...',
                 -command => \&doConfig );
$filemenu->separator();
$filemenu->command(-label => 'Exit', -command => sub {exit;} );
</pre>

<p>Note the way commands are bound to the widgets. Whenever a user selects an item, the bound command is executed.

<h3>Building the Main Window</h3>

<p>Within the main window, I've added three additional frames in addition to the menu bar: one on the left, for data input; one on the right, for data output; and the third on the bottom for status lines and the "Process Transaction" buttons.
<pre>
my $left  = $mainwindow->Frame->grid(-row => 1,
                    -col => 0,
                    -sticky => 'nw');
my $right = $mainwindow->Frame->grid(-row => 1,
                    -col => 1,
                    -sticky => 'nw');
my $bottom = $mainwindow->Frame->grid(-row => 2,
                    -col => 0,
                    -columnspan => 3,
                    -sticky => 'nw');
</pre>

<p>The left frame is first populated with a drop-down list (called an Optionmenu), with the various transaction types available:
<pre>
$left->Optionmenu(
        -options => \@trxtype,
        -variable => \$trans->{TRXTYPE},
        )->pack(-side => "top", -anchor => "nw");
</pre>

<p>The -options parameter is a reference to an array (defined globally; refer to <a href="/2001/03/listing1.txt">Listing 1</a>) of accepted transaction types. We've seen this before when talking about bound variables. Remember that the variable $trans->{TRXTYPE} will always reflect the state of the Optionmenu, and we can change the current selected item programmatically by simply reassigning a value to the bound variable. We also create an Optionmenu for the card-type; however, it isn't used in the current implementation. The card type can be determined from the actual card number, so isn't really required except that users are used to having it available.
</p>
<p>We then populate the rest of the frame with LabEntry widgets. These little gizmos are fantastic, housing commonly used labels, entry fields, and bound variables in one convenient widget.
<pre>
$left->LabEntry(-label => "Name",
   -labelPack => [-side => "right", -anchor => "w"],
   -width => 20,
   -textvariable => \$trans->{_NAME})->pack(-side => "top", 
   -anchor => 'nw');
</pre>

<p>Like every other widget, you must call the geometry manager to make it visible. It is also pretty obvious that the LabEntry widget is calling its own geometry manager behind the scenes for us.
</p>
<p>The right-hand frame is populated with a series of Label widgets for displaying the output of the transaction. Note the grid manager used to place the labels in a column. I've also made sure to bind the second Label in each row to a variable, to be used for updating the state of the transaction later.</p>
<pre>
$right->Label(-text => 'PNRef')->
        grid(-row => 0, -column => 0,-sticky => 'nw');
$right->Label(-textvariable => \$results->{PNREF})->
        grid(-row => 0, -column => 1,-sticky => 'nw');
</pre>

<p>The bottom frame is no more complicated, and consists of only three widgets: two LabEntry widgets for showing the state of the transaction (both sent and received) and a button to actually perform the processing.
<pre>
$bottom->Button(-text => 'Process Transaction',
         -command => \&processTransaction )->
         grid(qw/-row 2 -column 0 -sticky nesw/);
</pre>

<p>The button is bound to the processTransaction routine, which is straightforward. (See <a href="/2001/03/listing3.txt">Listing 3</a>.) The only thing left to do is to start the event processing, which should look familiar by this time:
<pre>
MainLoop();  # Start the event processing
</pre>

<h3>Saving and Loading the Configuration</h3>

<p>The system binds "File | Open Config" and "File | Save Config" to the loadConfig() and saveConfig() subroutines, respectively. To configure the file dialog boxes, each routine needs a list of the file types to accept:
<pre>
my @types = (["Config Files", '.pcg', 'TEXT'],
       ["All Files", "*"] );
</pre>

<p>This creates the standard "Save As" dialog box. (See Figure 1.) You can add as many file types as you'd like. To actually execute the dialog, simply call getSaveFile:</p> 
<pre>
my $file = $mainwindow->getSaveFile(-filetypes => \@types,
      -initialfile=> 'Default',
      -defaultextension => '.pcg');
</pre>  

<table border="0" cellpadding="3" cellspacing="0" align="center">
<tr>
<td valign="top">
<img src="/pub/2001/03/graphics/fig3.jpg" border="0" alt="Figure 3: The Save As dialog.">
</td>
</tr>
<tr>
<td valign="top" align="center">   
<b>Figure 3: The Save As dialog.</b>
</td>
</tr>
</table> 

 
<p>You can specify the initial file name for the dialog, as shown above. The name of the file the user selected is returned, or an undef value if the "cancel" button was pressed. If the file exists, a second confirmation dialog ("Are you sure you want to overwrite?") is executed. Only if the user answers affirmatively will the filename be returned. Using the Open dialog is similar, just call getOpenFile instead of getSaveFile.
</p>
<p>Once we have the filename, we can then save and load the configuration. We are using an extremely simple file format, basically a mini-Perl program, thanks to the Data::Dumper module. This is where the interpreted nature of Perl shines. To write out the file, we open it, print the text provided by Dumper, and then close it. Reading it back in is simple as well. Slurp up the file, and then use the eval function to interpret the file. Be aware that this format stores all configuration information in plain text on the user's drive, so it may not be suitable for use in an open environment.
</p>
<h3>The Configuration Dialog</h3>

<table border="0" cellpadding="3" cellspacing="0" align="center">
<tr>
<td valign="top">
<img src="/pub/2001/03/graphics/fig4.jpg" border="0" alt="Figure 4: The Configuration dialog">
</td>
</tr>
<tr>
<td valign="top" align="center">   
<b>Figure 4: The Configuration dialog</b>
</td>
</tr>
</table> 
   
 
<p>One really cool widget in the pTk system is the NoteBook (see Figure 4). I've used it to implement the simple configuration dialog bound to the "File | Configuration" menu item. The doConfig() callback subroutine actually implements the system. The strategy is to create a structure ($config) to hold all the relevant information. Within doConfig, we first copy this structure to a local structure, so that changes won't be saved if the user selects "Cancel" when editing the fields. To create the actual dialog, we ask $mainwindow to do it for us:
<pre>
$f = $mainwindow->DialogBox(-title => "Configuration", 
              -buttons => ["OK", "Cancel"]);
</pre>

<p>To add the NoteBook widget to the DialogBox (which is really just a fancy Frame), use:
<pre>
$n = $f->add('NoteBook', -ipadx=>6, -ipady => 6) 
</pre>

<p>The -ipad options tell the system how much internal padding to leave around the widgets contained within the box. To actually use the NoteBook, you must now add pages to it:
<pre>
my $vendor_p = $n->add("vendor", 
         -label => "Vendor ID", -underline => 0);
my $host_p  = $n->add("host", 
         -label => "Host", -underline => 0); 
my $proxy_p = $n->add("proxy", 
         -label => "Proxy", -underline => 0);
</pre>

<p>This adds our three pages, named "vendor," "host," and "proxy." You can treat each page as a regular frame within your dialog. The rest of the method's code sets up the entry boxes we need:
<pre>
$host_p->LabEntry(-label => "Port:       ", 
         -labelPack => [-side => "left", 
         -anchor => "w"], 
         -width => 20, 
         -textvariable => 
         \$localconfig->{PORT})->pack(-side => "top",
         -anchor => "nw");
</pre>

<p>Again, we use the LabEntry widget to make a labeled text-entry box. To execute the dialog, once it's set up, is a one liner:
<pre>
$return = $f->show;
</pre>

<p>The return value is the text of the button that the user pressed to end the dialog. If the result matches, we can then copy our temporary variables back to the $config array, effectively updating our configuration.
</p>
<h3>Using the System</h3>
<p>That just about covers the example program, which is available electronically in the listings archive for this issue. To run the program under Windows, double-click on the file name (<a href="/2001/03/ptkpos.pl.txt">ptkpos.pl</a>) from Windows Explorer. The ActiveState installation program for Windows associates the .pl extension to Perl by default and runs the Perl interpreter when you double click on a .pl file. Under Linux, you first need to make the program executable.</p> 
<pre>
chmod +x ptkpos.pl
</pre>

<p>You can then use the K file manager and click on the program, or execute it from the command line directly.
</p>
<h3>Live Online Credit Card Authorizations</h3>

<p>The virtual terminal presented here is using a "stub" simulation module to do credit-card authorizations. This module simulates the transaction process by providing data that you could expect to receive if you were to send the data to a real validation system. The simulator is very basic: It does no checking on vendor ID / password, card expiration date or even ensuring that all required information is available. It does, however, check to see if the credit card could be a valid card: if so, it returns an authorization code, otherwise it will be declined. Any simulator declines any transaction type other than an "authorization" or a "sale."
</p>
<p>To use the application for real transactions, you must replace the stub with an active link to a real online gateway system. The program will automatically detect a file named call_pfpro.pl, re-evaluate it to replace the simulator, and transactions will then go to a real gateway. 
</p><p>
To configure the system, select File | Configuration from the menu bar. Fill in the User and Password fields as provided by PaymentNet, or leave it blank to use the simulator. For testing, leave test.paymentnet.com in the Host entry. Port 443 is the default and should never need to be changed. If you are processing transactions from behind a firewall (always a good idea when doing electronic commerce) you need to set the Proxy settings. Consult the PaymentNet documentation for full details on how to do this. 
</p><p>
The application supports only a limited subset of the PaymentNet system. In particular, PaymentNet supports various forms of check processing. It should be possible to support other payment gateways relatively easily, though doing so is not currently planned.
</p>
<p>You can find more information (as well as the payment-transaction module) on how to do so at the Commerce-Store.com Web site, <a href="http://www.commercestore.com/developers/VDM">www.commercestore.com/developers/VDM</a>. 

<h3>Further Exploration</h3>
<p>We've looked at the pTk event model, a couple of the more common widgets, and as well as a slice of Internet-enabled electronic commerce. As Internet access becomes more common, tools that access the Net from a desktop can inexpensively replace more traditional systems, like leased-line or dial up credit-card terminals, as we've done here. 
</p>
<p>There are quite a few exploration tools available for both Perl and pTk. I encourage you to take a look at some of the Web sites presented here, as well as the example programs that come with the distribution. 
</p>
<p>Nick Temple is an entrepreneur who has recently relocated to Silicon Valley to pursue the startup dream. The founder of The Temple Group, Ltd. and CommerceStore.com, he welcomes open discussion directed to <a href="mailto:ntemple@commercestore.com">ntemple@commercestore.com</a>.
</p>

<h3>Additional information not part of original article:</h3>

<p>Since the article was written, a number of things have changed in the online payments world. PaymentNet has changed their name to Signio, and then purchased by Verisign.  You may know them now as <a href="http://www.verisign.com/payments">Verisign Payment Services </a>. Here are instructions for "upgrading" the pTkPOS system presented in the article to handle live Internet transactions. Here are the steps that you will need to follow: 
</p><ol>
<li><a href="/2001/03/files.zip">Download and install the source code to the article</a></li>
<li><a href="http://www.verisign.com/products/payflow/trial.html">Click here</a> to register with Signio for a test account. It is free, and can be converted to a live account at a later date, if you so choose. This may take up to an hour to activate.   &lt;plug> Note that CommerceStore.com (my company) is a reseller for Verisign Payment Services, so if you wish to purchase the service I'd appreciate the business. &lt;/plug></li>
<li>Download  the latest version 2of the VPS  client. You must log into your VPS manager at https://manager.signio.com. You will need to install pfpro.exe (for NT) or pfpro (for Linux) into the same directory as the article source code.</li> 
<li>Copy & paste the call_pfpro.pl code below into a file named call_pfpro.pl, in the same directory that you've installed the articles source code. Modify line 7 by changing it to the full path name of your pfpro binary. </li>
<li>Follow the instructions in the article to install & configure Perl and the application. If you don't have a copy of the magazine, it can be found at your favorite magazine retailer. The complete text will be made available online late January, 2000. If you cannot find the magazine at your local retailer, please e-mail support@commercestore.com so that we can set you up with one.</li>
</ul>
<pre>
call_pfpro.pl 

################
# call_pfpro #
################
# Verisign Module
# NOTE: Modify the following line by using the full path to your PFPRO
#       executable file = pfpro on Linux or pfpro.exe on NT.

my $pfpro = "pfpro";
my $id ="0";
sub call_pfpro {
  my $host         = shift;
  my $port         = shift;
  my $data         = shift;
  my $timeout      = shift;
  my $proxyaddress = shift;
  my $proxyport    = shift;
  my $proxylogin   = shift;
  my $proxypass    = shift;
  
  my $cmd = "$pfpro $host $port $data $time-out $proxyaddress $proxyport $proxylogin $proxypass";
  return `$cmd`;
}

1;
</pre>
<h3>What Next?</h3>
<p>You should now be able to play around with live transaction processing, albeit in test mode. Look around the rest of the CommerceStore.com website - we offer assistance obtaining Internet enabled merchant accounts, E-Commerce products and services, as well as consulting. Be sure to mention that you saw the article on Perl.com.</p>




 


        </div>



    </div>
    <div class="asset-footer"></div>
</div>


                            
                            <div id="entry-1472" class="entry-asset asset hentry">
    <div class="asset-header">
        <h2 class="asset-name entry-title"><a href="/pub/2001/03/p5pdigest/THISWEEK-20010305.html" rel="bookmark">This Week on p5p 2001/03/05</a></h2>
        <div class="asset-meta">
            <span class="byline">
    
                By <span class="vcard author">Simon Cozens</span> on <abbr class="published" title="2001-03-05T00:00:00-08:00">March  5, 2001 12:00 AM</abbr>
    
            </span>

            
            

        </div>
    </div>
    <div class="asset-content entry-content">

        <div class="asset-body">
            </P>

<P>


<!-- This week on perl5-porters (27 Feb-05 Mar 2001) -->

<br />
<br />
      <H3><a name="Notes">Notes</a></H3>

</P>

<P>

You can subscribe to an email version of this summary by sending an
empty message to 
<a href="mailto:perl5-porters-digest-subscribe@netthink.co.uk"><tt>perl5-porters-digest-subscribe@netthink.co.uk</tt>.</a></P>

<P>
Please send corrections and additions to 
<CODE>perl-thisweek-YYYYMM@simon-cozens.org</CODE> where 
<CODE>YYYYMM</CODE> is the current year and month.
</P>

<P>
We're trying something new this week, and providing brief biographies of
some of the more prolific porters. If you have anything to add to this,
or object to something I've said about you, email me as above.
<H3><a name="Locale_Support">Locale Support</a></H3>

</P>

<P>

Andrew Pimlott filed a bug report related to 
<CODE>POSIX::tolower</CODE>; basically, it is not as locale-aware as Perl's own 
<CODE>lc</CODE>. He also found that 
<CODE>lc</CODE> failed to be locale-aware while in the debugger. 
<a href="http://simon-cozens.org/writings/whos-who.html#ING-SIMMONS">Nick Ing-Simmons</a> pointed out that 
<CODE>use locale</CODE> is lexically scoped, and the debugger is in a different scope, meaning
that it won't pick up on the pragma. Andrew thought this was probably a
bug (the debugger not assuming the debuggee's scope) but it is unclear
as to how that could be fixed. Nick wondered if the first was due to not
calling 
<CODE>setlocale</CODE>, but Andrew reported that this didn't help anything.
</P>

<P>
Andrew then went digging around in 
<CODE>POSIX.pm</CODE> and found that 
<CODE>isalpha</CODE> is perfectly locale aware, but 
<CODE>tolower</CODE> is not - this is because 
<CODE>isalpha</CODE> is written in XS, but 
<CODE>tolower</CODE> simply calls 
<CODE>lc</CODE>; because it's in a different lexical context, it doesn't pick up on
the 
<CODE>use locale</CODE>. It transpires that XS code does execute in the same lexical context as
the caller, which is quite strange. Andrew pointed out that there's no
way to make a pragma dynamically scoped. He said:
<blockquote>I think this raises some fundamental issues, but I'm not sure
exactly which.  It seems clear that one would like to be able to
write a correct tolower (ie, exactly equivalent to lc, as per the
POSIX documentation) in pure Perl.  One possibility is a TCL-like
&quot;uplevel&quot;, but I desperately hope that doesn't turn out to be the
best option.
</blockquote></P>

<P>
I asked why POSIX functions were being implemented in Perl instead of C,
and Andrew replied that in some cases it already works merely by magic:
Perl doesn't correctly turn on and off locale support lexically, so some
functions inherit the support for free. 
<a href="http://simon-cozens.org/writings/whos-who.html#HIETANIEMI">Jarkko</a> grumbled about locales in his customary manner, and said he'd take 
a look at the areas which needed 
<CODE>setlocale</CODE> calling, but then Andrew had a revelation:
<blockquote>Hmm, looks like I missed an essential point:  locale support is not
dependent on 'use locale' at all!  This seems to be intentional.
perl unconditionally calls setlocale() on startup, and never calls
it again (unless you use POSIX::setlocale() explictly).  So
POSIX::isalpha() respects $LANG by default, even if you never
mention the locale pragma.
</P>

<P>
It is only where (core) perl has a choice between calling a
locale-sensitive libc function, and doing things its own way (eg,
hard-coding character semantics), that the locale pragma currently
matters.  Since the string value of $! requires calling a
locale-sensitive function (strerror()), $! always respects locale.
</blockquote></P>

<P>
And you wonder why Jarkko throws his hands in the air at the mention of
anything locale-related...
<H3><a name="Coderef_INC">Coderef @INC</a></H3>

</P>

<P>

<a href="http://simon-cozens.org/writings/whos-who.html#CLARK">Nicholas Clark </a> provided a patch which extended the little-known coderef-in-
<CODE>@INC</CODE> feature to allow passing an object; if you pass an object instead of a
 coderef, the 
<CODE>INC</CODE> method will be called on it. This has allowed him to create an
experimental pragma, 
<a href="http://www.flirble.org/~nick/P/ex-lib-zip-0.01.tar.gz"><CODE>ex::lib::zip</CODE></a> which lets you put a module tree inside a ZIP archive and Perl will
extract the modules it needs from it.
</P>

<P>
He then also explained what it was all about, in the hope that someone
would write some proper documentation. Nobody did so, (my fault, I
promised to but didn't get around to it) but his
extremely helpful explanation of the coderef-in-
<CODE>@INC</CODE> API, and the cheap source filter API it allows can be found
<a href="http://www.xray.mpe.mpg.de/mailing-lists/perl5-porters/2001-02/msg01780.html">here</a>.
</P>

<P>
Briefly, you can do 
</P>

</P><PRE>
    BEGIN {
        push @INC, \&somesub;
        sub somesub {
            my ($owncoderef, $wanted_file) = @_;
            # Produce a filehandle somehow
            if ($got_a_handle) {
                return *FH;
            } else {
                returm undef;
            }
        }
    }
</PRE>

<P>
and have your subroutine intercept calls to 
<CODE>use</CODE>. The 
<CODE>ByteCache</CODE> module on CPAN makes use of this to cache just-in-time compiled
versions of modules.
<H3><a name="More_Memory_Leak_Hunting">More Memory Leak Hunting</a></H3>

</P>

<P>

Some people started complaining about the lateness of 5.6.1, and 
<a href="http://simon-cozens.org/writings/whos-who.html#BURLISON">Alan</a> mentioned the he probably wouldn't be able to ship 5.6.1 in
Solaris yet because of what he saw as &quot;the large number of leaks&quot;.
<a href="http://simon-cozens.org/writings/whos-who.html#GURUSAMY">Sarathy </a> disagreed:
<blockquote>I strongly suspect you'll end up shipping no version of Perl with 
Solaris, then.  Every single version of Perl out there has more
unfixed &quot;leaks&quot; than 5.6.1-to-be, and some &quot;real&quot; ones to boot.
</P>

<P>
I say &quot;leaks&quot; because these are still totally hypothetical, given your
vantage point of a -DPURIFY enabled build with the arena cleanup
repressed (which is the right vantage point for someone who has set
out to clean up all leaks, I should add).  However, this is not the
real world.  In the real world, the arena cleanup is enabled and
appears to do its thing (however ugly you or I say it is).
</blockquote></P>

<P>
There was then some similarly ugly debate about what actually
constitutes a leak: Alan considered a leak anything which allocated
memory and lost the pointer to it; Sarathy was only considering
monotonic process growth. Nick Clark suggested that he could trigger
a leak in the Sarathy sense by repeatedly 
<CODE>use</CODE>ing modules and clearing out 
<CODE>%INC</CODE>, but this wasn't the case; the leak is due to some ugly fakery that
goes on when the compiler sees 
<CODE>use Module;</CODE>. Alan could, however, trigger a leak with 
</P>

</P><PRE>
    sub X { sub {} }
</PRE>

<P>
as the inner subroutine wasn't being properly reference counted.
Alan and I scrambled around looking for the 
<CODE>use</CODE> leak, and Alan found that the two were related. I'm not aware as to
whether or not he's fixed it.
</P>

<P>
In other news, Nicholas Clark is a wicked, wicked man and managed to compile the
<a href="http://www.hpl.hp.com/personal/Hans_Boehm/gc/">Boehm Garbage Collector </a> into Perl. (As 
<a href="http://simon-cozens.org/writings/whos-who.html#SCHWARTZ">Randal </a> pointed out off-list, no more Boehm garbage!) and
 found a way to use it as a memory leak detector.
<H3><a name="Weird_Memory_Corruption">Weird Memory Corruption</a></H3>

</P>

<P>

Weird bug of the week came from Jarkko, who found that
</P>

</P><PRE>
    $ENV{BAR} = 0;
    reset;
    if (0) {
      if ("" =~ //) {
      }
    }
</PRE>

<P>
caused all kinds of merry hell - on some platforms, it ran fine, on some
it segfaulted; the problems were not consistent across platforms,
meaning that some machines with identical setups produced differing
results. This is obviously maddening. Nick Clark made it even weirder:
<blockquote>./perl will pass.
/usr/local/bin/perl will SEGV.
They are byte for byte identical.
</blockquote></P>

<P>
Jarkko thought this was a recent problem, but Nick managed to reproduce
it in 5.005_02. Alan produced an 
<a href="http://www.xray.mpe.mpg.de/mailing-lists/perl5-porters/2001-03/msg00176.html">impressive explanation</a> of what was going on, which I greatly encourage you to read if you want
to learn how to track this sort of thing down, but stopped short of an actual 
fix.
</P>

<P>
There was, of course, the usual discussion of how useless 
<CODE>reset</CODE> was anyway, including one suggestion of rewriting the op in pure Perl.
<H3><a name="Yet_More_Unicode_Wars">Yet More Unicode Wars</a></H3>

</P>

<P>

87 messages this week were spent attempting to formulate a sensible and
acceptable Unicode policy. The attempt failed. If you really want to
jump in and have a look,
<a href="http://www.xray.mpe.mpg.de/mailing-lists/perl5-porters/2001-02/msg01680.html">this</a> is as good a place to start as any.
<H3><a name="Switch_is_broken">Switch is broken</a></H3>

</P>

<P>

Jarkko reported that for some reason, Switch 2.01 from CPAN has suddenly
started failing tests on bleadperl. It would be really, really, really
great if someone out there could look into why this is happening and try
to come up with an isolated bug report. Or even better, fix it.
<H3><a name="Various">Various</a></H3>

</P>

<P>

Olaf Flebbe chimed in a bunch of EPOC fixes, for those of you running
Perl on your Psions; 
Sarathy fixed a long-standing parser bug.
Michael Stevens did some sterling work clearing up the POD markup of the
documentation. 
<a href="http://simon-cozens.org/writings/whos-who.html#BERRY">Craig Berry</a> turned in some updates to VMS's 
<CODE>configure.com</CODE>. Daniel Stutz and Ed Peschko both rewrote 
<CODE>perlcc</CODE>. 
</P>

<P>
David Mitchell deserves an honourable mention for a really useful first patch,
which lets 
<CODE>perl -Dt</CODE> tell you which variables are being accessed, as well as another debug
option, 
<CODE>-DR</CODE> which tells you the reference counts of SVs in the stack.
Very cool stuff, David, thanks.
</P>

<P>
Someone reported that 
<CODE>ExtUtils::Install</CODE> is naughty and doesn't check the return values of 
<CODE>File::Copy::copy</CODE>; this would be easy enough to fix up if anyone out there is interested.
(That's bug ID 20010227.005, by the way)
</P>

<P>
Until next week I remain, your humble and obedient servant,
</P>

<hr>

<a href="mailto:simon@brecon.co.uk">Simon Cozens</a>


<ul>
  <li><a href="#Notes">Notes</a>
  <li><a href="#Locale_Support">Locale Support</a>
  <li><a href="#Coderef_INC">Coderef @INC</a>
  <li><a href="#More_Memory_Leak_Hunting">More Memory Leak Hunting</a>
  <li><a href="#Weird_Memory_Corruption">Weird Memory Corruption</a>
  <li><a href="#Yet_More_Unicode_Wars">Yet More Unicode Wars</a>
  <li><a href="#Switch_is_broken">Switch is broken</a>
  <li><a href="#Various">Various</a>
</ul>

        </div>



    </div>
    <div class="asset-footer"></div>
</div>




                            <div class="content-nav">
                                <a href="/pub/2001/02/">&laquo; February 2001</a> |
                                <a href="/pub/">Main Index</a> |
                                <a href="/pub/archives.html">Archives</a>
                                | <a href="/pub/2001/04/">April 2001 &raquo;</a>
                            </div>


                        </div>
                    </div>


                    <div id="beta">
    <div id="beta-inner">


    
    <div class="widget-what-is-perl widget">
    <div class="widget-content widget-content-what-is-perl">
       Visit the home of the  Perl programming language: <a href="http://www.perl.org/">Perl.org</a
    </div>
</div>
<div class="widget-find-out-more widget-archives widget">
    <div class="widget-content">
        <ul>
            <li><a href="http://www.perl.org/get.html">Download</a></li>
            <li><a href="http://perldoc.perl.org/">Documentation</a></li>
            <li><a href="http://blogs.perl.org/">Perl Bloggers</a></li>
            <li><a href="http://news.perlfoundation.org/">Foundation News</a></li>
        </ul>
    </div>
</div><div class="widget-tcpc widget">
<h3 class="widget-header">Sponsored by</h3>
    <div class="widget-content">
        <a href="http://training.perl.com/" alt="Perl Training" target="_blank"><img src="/i/tcpc.png" width="150" height="50"></a>
    </div>
</div>

<div class="widget-syndication widget">
    <div class="widget-content">
        <ul>
            <li><img src="/mt-static/images/status_icons/feed.gif" alt="Subscribe to feed" width="9" height="9" /> <a href="/pub/atom.xml">Subscribe to this website's feed</a></li>

        </ul>
    </div>
</div>
<div class="widget-archive-monthly widget-archive widget">
    <h3 class="widget-header">Monthly <a href="/pub/archives.html">Archives</a></h3>
    <div class="widget-content">
        <ul>
        
            <li><a href="/pub/2014/02/">February 2014 (1)</a></li>
        
    
        
            <li><a href="/pub/2014/01/">January 2014 (1)</a></li>
        
    
        
            <li><a href="/pub/2013/10/">October 2013 (1)</a></li>
        
    
        
            <li><a href="/pub/2013/01/">January 2013 (1)</a></li>
        
    
        
            <li><a href="/pub/2012/12/">December 2012 (1)</a></li>
        
    
        
            <li><a href="/pub/2012/11/">November 2012 (1)</a></li>
        
    
        
            <li><a href="/pub/2012/10/">October 2012 (2)</a></li>
        
    
        
            <li><a href="/pub/2012/08/">August 2012 (2)</a></li>
        
    
        
            <li><a href="/pub/2012/06/">June 2012 (11)</a></li>
        
    
        
            <li><a href="/pub/2012/05/">May 2012 (18)</a></li>
        
    
        
            <li><a href="/pub/2012/04/">April 2012 (17)</a></li>
        
    
        
            <li><a href="/pub/2012/02/">February 2012 (1)</a></li>
        
    
        
            <li><a href="/pub/2011/12/">December 2011 (1)</a></li>
        
    
        
            <li><a href="/pub/2011/09/">September 2011 (1)</a></li>
        
    
        
            <li><a href="/pub/2011/08/">August 2011 (2)</a></li>
        
    
        
            <li><a href="/pub/2011/06/">June 2011 (1)</a></li>
        
    
        
            <li><a href="/pub/2011/05/">May 2011 (3)</a></li>
        
    
        
            <li><a href="/pub/2011/04/">April 2011 (1)</a></li>
        
    
        
            <li><a href="/pub/2011/03/">March 2011 (1)</a></li>
        
    
        
            <li><a href="/pub/2011/02/">February 2011 (1)</a></li>
        
    
        
            <li><a href="/pub/2011/01/">January 2011 (1)</a></li>
        
    
        
            <li><a href="/pub/2010/11/">November 2010 (1)</a></li>
        
    
        
            <li><a href="/pub/2010/10/">October 2010 (2)</a></li>
        
    
        
            <li><a href="/pub/2010/09/">September 2010 (1)</a></li>
        
    
        
            <li><a href="/pub/2010/08/">August 2010 (3)</a></li>
        
    
        
            <li><a href="/pub/2010/07/">July 2010 (2)</a></li>
        
    
        
            <li><a href="/pub/2010/04/">April 2010 (2)</a></li>
        
    
        
            <li><a href="/pub/2010/03/">March 2010 (4)</a></li>
        
    
        
            <li><a href="/pub/2008/05/">May 2008 (1)</a></li>
        
    
        
            <li><a href="/pub/2008/04/">April 2008 (2)</a></li>
        
    
        
            <li><a href="/pub/2008/03/">March 2008 (1)</a></li>
        
    
        
            <li><a href="/pub/2008/02/">February 2008 (1)</a></li>
        
    
        
            <li><a href="/pub/2008/01/">January 2008 (1)</a></li>
        
    
        
            <li><a href="/pub/2007/12/">December 2007 (2)</a></li>
        
    
        
            <li><a href="/pub/2007/09/">September 2007 (1)</a></li>
        
    
        
            <li><a href="/pub/2007/08/">August 2007 (1)</a></li>
        
    
        
            <li><a href="/pub/2007/07/">July 2007 (1)</a></li>
        
    
        
            <li><a href="/pub/2007/06/">June 2007 (1)</a></li>
        
    
        
            <li><a href="/pub/2007/05/">May 2007 (1)</a></li>
        
    
        
            <li><a href="/pub/2007/04/">April 2007 (1)</a></li>
        
    
        
            <li><a href="/pub/2007/03/">March 2007 (1)</a></li>
        
    
        
            <li><a href="/pub/2007/02/">February 2007 (1)</a></li>
        
    
        
            <li><a href="/pub/2007/01/">January 2007 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/12/">December 2006 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/11/">November 2006 (2)</a></li>
        
    
        
            <li><a href="/pub/2006/10/">October 2006 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/09/">September 2006 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/08/">August 2006 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/07/">July 2006 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/06/">June 2006 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/05/">May 2006 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/04/">April 2006 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/03/">March 2006 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/02/">February 2006 (4)</a></li>
        
    
        
            <li><a href="/pub/2006/01/">January 2006 (4)</a></li>
        
    
        
            <li><a href="/pub/2005/12/">December 2005 (4)</a></li>
        
    
        
            <li><a href="/pub/2005/11/">November 2005 (3)</a></li>
        
    
        
            <li><a href="/pub/2005/10/">October 2005 (2)</a></li>
        
    
        
            <li><a href="/pub/2005/09/">September 2005 (2)</a></li>
        
    
        
            <li><a href="/pub/2005/08/">August 2005 (9)</a></li>
        
    
        
            <li><a href="/pub/2005/07/">July 2005 (8)</a></li>
        
    
        
            <li><a href="/pub/2005/06/">June 2005 (9)</a></li>
        
    
        
            <li><a href="/pub/2005/05/">May 2005 (8)</a></li>
        
    
        
            <li><a href="/pub/2005/04/">April 2005 (7)</a></li>
        
    
        
            <li><a href="/pub/2005/03/">March 2005 (6)</a></li>
        
    
        
            <li><a href="/pub/2005/02/">February 2005 (7)</a></li>
        
    
        
            <li><a href="/pub/2005/01/">January 2005 (6)</a></li>
        
    
        
            <li><a href="/pub/2004/12/">December 2004 (8)</a></li>
        
    
        
            <li><a href="/pub/2004/11/">November 2004 (8)</a></li>
        
    
        
            <li><a href="/pub/2004/10/">October 2004 (5)</a></li>
        
    
        
            <li><a href="/pub/2004/09/">September 2004 (9)</a></li>
        
    
        
            <li><a href="/pub/2004/08/">August 2004 (6)</a></li>
        
    
        
            <li><a href="/pub/2004/07/">July 2004 (8)</a></li>
        
    
        
            <li><a href="/pub/2004/06/">June 2004 (6)</a></li>
        
    
        
            <li><a href="/pub/2004/05/">May 2004 (7)</a></li>
        
    
        
            <li><a href="/pub/2004/04/">April 2004 (8)</a></li>
        
    
        
            <li><a href="/pub/2004/03/">March 2004 (8)</a></li>
        
    
        
            <li><a href="/pub/2004/02/">February 2004 (9)</a></li>
        
    
        
            <li><a href="/pub/2004/01/">January 2004 (7)</a></li>
        
    
        
            <li><a href="/pub/2003/12/">December 2003 (4)</a></li>
        
    
        
            <li><a href="/pub/2003/11/">November 2003 (7)</a></li>
        
    
        
            <li><a href="/pub/2003/10/">October 2003 (8)</a></li>
        
    
        
            <li><a href="/pub/2003/09/">September 2003 (6)</a></li>
        
    
        
            <li><a href="/pub/2003/08/">August 2003 (7)</a></li>
        
    
        
            <li><a href="/pub/2003/07/">July 2003 (9)</a></li>
        
    
        
            <li><a href="/pub/2003/06/">June 2003 (9)</a></li>
        
    
        
            <li><a href="/pub/2003/05/">May 2003 (8)</a></li>
        
    
        
            <li><a href="/pub/2003/04/">April 2003 (8)</a></li>
        
    
        
            <li><a href="/pub/2003/03/">March 2003 (10)</a></li>
        
    
        
            <li><a href="/pub/2003/02/">February 2003 (8)</a></li>
        
    
        
            <li><a href="/pub/2003/01/">January 2003 (8)</a></li>
        
    
        
            <li><a href="/pub/2002/12/">December 2002 (5)</a></li>
        
    
        
            <li><a href="/pub/2002/11/">November 2002 (9)</a></li>
        
    
        
            <li><a href="/pub/2002/10/">October 2002 (7)</a></li>
        
    
        
            <li><a href="/pub/2002/09/">September 2002 (11)</a></li>
        
    
        
            <li><a href="/pub/2002/08/">August 2002 (8)</a></li>
        
    
        
            <li><a href="/pub/2002/07/">July 2002 (8)</a></li>
        
    
        
            <li><a href="/pub/2002/06/">June 2002 (4)</a></li>
        
    
        
            <li><a href="/pub/2002/05/">May 2002 (6)</a></li>
        
    
        
            <li><a href="/pub/2002/04/">April 2002 (6)</a></li>
        
    
        
            <li><a href="/pub/2002/03/">March 2002 (7)</a></li>
        
    
        
            <li><a href="/pub/2002/02/">February 2002 (5)</a></li>
        
    
        
            <li><a href="/pub/2002/01/">January 2002 (8)</a></li>
        
    
        
            <li><a href="/pub/2001/12/">December 2001 (7)</a></li>
        
    
        
            <li><a href="/pub/2001/11/">November 2001 (5)</a></li>
        
    
        
            <li><a href="/pub/2001/10/">October 2001 (9)</a></li>
        
    
        
            <li><a href="/pub/2001/09/">September 2001 (7)</a></li>
        
    
        
            <li><a href="/pub/2001/08/">August 2001 (13)</a></li>
        
    
        
            <li><a href="/pub/2001/07/">July 2001 (8)</a></li>
        
    
        
            <li><a href="/pub/2001/06/">June 2001 (13)</a></li>
        
    
        
            <li><a href="/pub/2001/05/">May 2001 (11)</a></li>
        
    
        
            <li><a href="/pub/2001/04/">April 2001 (9)</a></li>
        
    
        
            <li><a href="/pub/2001/03/">March 2001 (8)</a></li>
        
    
        
            <li><a href="/pub/2001/02/">February 2001 (8)</a></li>
        
    
        
            <li><a href="/pub/2001/01/">January 2001 (8)</a></li>
        
    
        
            <li><a href="/pub/2000/12/">December 2000 (6)</a></li>
        
    
        
            <li><a href="/pub/2000/11/">November 2000 (10)</a></li>
        
    
        
            <li><a href="/pub/2000/10/">October 2000 (10)</a></li>
        
    
        
            <li><a href="/pub/2000/09/">September 2000 (2)</a></li>
        
    
        
            <li><a href="/pub/2000/08/">August 2000 (2)</a></li>
        
    
        
            <li><a href="/pub/2000/07/">July 2000 (5)</a></li>
        
    
        
            <li><a href="/pub/2000/06/">June 2000 (7)</a></li>
        
    
        
            <li><a href="/pub/2000/05/">May 2000 (7)</a></li>
        
    
        
            <li><a href="/pub/2000/04/">April 2000 (3)</a></li>
        
    
        
            <li><a href="/pub/2000/03/">March 2000 (2)</a></li>
        
    
        
            <li><a href="/pub/2000/02/">February 2000 (2)</a></li>
        
    
        
            <li><a href="/pub/2000/01/">January 2000 (2)</a></li>
        
    
        
            <li><a href="/pub/1999/12/">December 1999 (6)</a></li>
        
    
        
            <li><a href="/pub/1999/11/">November 1999 (6)</a></li>
        
    
        
            <li><a href="/pub/1999/10/">October 1999 (5)</a></li>
        
    
        
            <li><a href="/pub/1999/09/">September 1999 (4)</a></li>
        
    
        
            <li><a href="/pub/1999/08/">August 1999 (3)</a></li>
        
    
        
            <li><a href="/pub/1999/07/">July 1999 (2)</a></li>
        
    
        
            <li><a href="/pub/1999/06/">June 1999 (3)</a></li>
        
    
        
            <li><a href="/pub/1999/04/">April 1999 (1)</a></li>
        
    
        
            <li><a href="/pub/1999/03/">March 1999 (1)</a></li>
        
    
        
            <li><a href="/pub/1999/01/">January 1999 (1)</a></li>
        
    
        
            <li><a href="/pub/1998/12/">December 1998 (1)</a></li>
        
    
        
            <li><a href="/pub/1998/11/">November 1998 (1)</a></li>
        
    
        
            <li><a href="/pub/1998/07/">July 1998 (2)</a></li>
        
    
        
            <li><a href="/pub/1998/06/">June 1998 (1)</a></li>
        
    
        
            <li><a href="/pub/1998/03/">March 1998 (1)</a></li>
        
        </ul>
    </div>
</div>
        
    

<div class="widget-powered widget">
    <div class="widget-content">
        <a href="http://www.movabletype.com/"><img src="/mt-static/images/bug-pbmt-white.png" alt="Powered by Movable Type 5.13-en" width="120" height="75" /></a>
    </div>
</div>



    </div>
</div>






                </div>
            </div>


            <div id="footer">
    <div id="footer-inner">
        <div id="footer-content">
            <div class="widget-powered widget">
                <div class="widget-content">
                    Powered by <a href="http://www.movabletype.com/" rel="generator">Movable Type Pro</a>
                </div>
            </div>

            <div class="widget-creative-commons widget">
                <div class="widget-content">
                    This blog is licensed under a <a href="http://creativecommons.org/licenses/by-nc-nd/3.0/">Creative Commons License</a>.
                </div>
            </div>

        </div>
    </div>
</div>



        </div>
    </div>
</body>
</html>
