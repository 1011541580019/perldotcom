<!-- This week on perl5-porters (06--12 Feb 2001) -->

<br />
<!::field::date::><br />
      <H3><a name="Notes">Notes</a></H3>

<P>

You can subscribe to an email version of this summary by sending an
empty message to 
<a href="mailto:p5p-digest-subscribe@plover.com"><tt>p5p-digest-subscribe@plover.com</tt>.</a></P>

<P>
Please send corrections and additions to 
<CODE>perl-thisweek-YYYYMM@simon-cozens.org</CODE> where 
<CODE>YYYYMM</CODE> is the current year and month.
</P>

<P>
I've been having mail problems this week, so it's possible that I've
missed one or two important things. Even so, it seems to be looking
relatively quiet out there.
<H3><a name="Perl_FAQ_updates">Perl FAQ updates</a></H3>

</P>

<P>

A number of bug reports and suggested fixes came in regarding the Perl
FAQ this week; the most contentuous one was a bug in the regular
expression for matching email addresses given in 
<CODE>perlfaq9</CODE>. Everyone agreed that there was no point trying to be completely
correct, since the RFC822 grammar for an email address is not easily
reduced into a regular expression. There are complete regular
expressions, such as the one in Abigail's 
<CODE>RFC::RFC822::Address</CODE>  module, and the one given in Jeffery Friedl's &quot;Mastering Regular
Expressions&quot;. However, the current one required some slight tweaking.
</P>

<P>
This, combined with the other bug reports both on P5P and 
<CODE>perl-friends</CODE>, led Jarkko to set up a working group to look after the FAQ. If you're
interested in helping out, see 
<a href="http://lists.perl.org/showlist.cgi?name=perlfaq-workers">the list's home page</a>.
<H3><a name="Namespace_for_IO_Layers">Namespace for IO Layers</a></H3>

</P>

<P>

Nicholas Clark asked three difficult questions about IO layers:
<blockquote></P>

<P>
1: How is it proposed to avoid namespace clashes with layers?
</P>

<P>
2: Is there a suggested namespace (eg Layer:: ?) for modules
implementing layers?
</P>

<P>
3: Is there a standard (memorable) way of passing arguments to layers?
</blockquote></P>

<P>
The other Nick said that he wanted the layer names (
<CODE>:gzip</CODE> and the like) to behave like (and possibly even converge with)
attribute names, and so generalised the problem to &quot;how do we avoid
namespace clashes with attributes?&quot;. As for question two, he suggested
the 
<CODE>PerlIO::</CODE> or 
<CODE>perlio::</CODE> namespaces. The final question caused more consternation. Nicholas
wanted to avoid problems where an argument to a layer could have meaning
to the layer system in general. It wouldn't be good, for instance, to
say
</P>

</P><PRE>
    open (FOO, ':layer(name="(test1),:gzip")', $file)
</PRE>

<P>
He first proposed a system similar to URL encoding, using 
<CODE>%XX</CODE> to escape significant characters. Nick Ing-Simmons got a little worried
at this point:
<blockquote></P>

<P>
I have a feeling that putting too much in the one string is a mistake.
I think we may need something akin to 
<CODE>ioctl()</CODE> which can call
&quot;method(s)&quot; on the &quot;layer object&quot; to allow a more extensible
approach.
</blockquote></P>

<P>
Surprisingly, this is what Ilya was saying
<a href="http://www.xray.mpe.mpg.de/mailing-lists/perl5-porters/2000-04/msg00098.html">nearly a year ago</a>.
<H3><a name="Memory_Leak_Plumbing">Memory Leak Plumbing</a></H3>

</P>

<P>

Alan has been working exceptionally hard of late on what he called the
&quot;south end of the camel&quot;: memory leaks. He's been using a software tool
called &quot;Purify&quot; that checks for leaks and illegal memory accesses. 
</P>

<P>
Firstly, he discovered something awry in 
<CODE>Perl_pmtrans</CODE>, part of the regular expression engine. This led him to issue the
following plea:
<blockquote></P>

<P>
The fact that
there isn't even a comment explaining what it is supposed to do isn't
helping - it is virtually impossible to figure out if it is working
correctly if I have no idea of what is correct behaviour.
</P>

<P>
A heartfelt plea - *please* comment your code.  Take pity on those of us
following at the south end of the camel, carrying the shovel and bucket.
</blockquote></P>

<P>
Next, he produced evidence of a leak in another part of the RE engine,
along with some code which is probably doing something exceptionally
evil indeed: it saves a way a pointer, sets it to zero, saves it again
and then re-allocates some memory for it. Obviously, when it's time for
the saved-away values to be restored, Bad Things happen. Alan says that
before he started work on 
<CODE>Perl_pmtrans</CODE> it was leaking 96% of available memory - a far cry from the usual call
that &quot;the only thing that leaks memory is failed evals&quot;.
</P>

<P>
That was, however, the next area that Alan planned to take on but it's a
very hard problem. Nick Ing-Simmons is going to take a look at it, and
Nicholas Clark came up with his favourite memory leak, which Alan duly
fixed.
</P>

<P>
He also found a rather major memory leak in the Perl destruction
process; his fixes to the SV allocation process were coming up with
strange errors about &quot;unbalanced reference counts&quot;. He thought this was
initially a problem in his patch, but eventually it became clear that
strings in environment variables or parser tokens weren't being
properly freed, because they weren't been allocated from designated
blocks of memory. (&quot;arenas&quot;) Worse, everything in stashes had problems
with circular references: the variable would contain a reference to its
parent stash, and vice versa. Just for fun, 
<CODE>%main::</CODE> refers to itself, because as it's set up, it declares itself to be its
own parent. (That's why you can do
<CODE>$main::main::main::c</CODE>)
</P>

<P>
Hopefully, Perl will be a lot less leaky in the very near future - and
you have Alan to thank for that.
<H3><a name="Shared_functions">Shared functions</a></H3>

</P>

<P>

Last week, I mentioned Doug MacEachern's experiments with shared subs.
This week, he's produced a complete patch which allows you to say (in an
XSUB):
</P>

</P><PRE>
    void
    foo()
</PRE>

</P><PRE>
      ATTRS: shared
</PRE>

<P>
and the resulting sub will be shared between interpreters. 
<CODE>Apache::*</CODE> module authors, listen up. This one could be useful for you.
</P>

<P>
There was a little concern that there was no locking provided on the
shared subroutine code, but Doug countered that the 
<CODE>GvSHARED</CODE> test combined with the 
<CODE>SvREADONLY</CODE> flag meant that if anyone messed around with the GV, they basically had
to take responsibility for their actions...
<H3><a name="Perl_6_Is_Alive">Perl 6 Is Alive!</a></H3>

</P>

<P>

Rumours of Perl 6's death have been greatly exaggerated, and devotees of
this weekly summary will be overjoyed to learn that I (together with my
merry band of volunteers) will be putting together summaries of the
<a href="http://dev.perl.org/lists">Perl 6 mailing lists</a>.
</P>

<P>
Later on this week and from next week, the summaries will be appearing on 
the front page of
<a href="http://www.perl.com/">http://www.perl.com/</a>; this week's issue is temporarily located at
<a href="http://simon-cozens.org/perl6/THISWEEK-20010211.html">http://simon-cozens.org/perl6/THISWEEK-20010211.html</a><H3><a name="Various">Various</a></H3>

</P>

<P>

Quite a few bug reports annd a few quick fixes, but nothing else of
major note.
</P>

<P>
Until next week I remain, your humble and obedient servant,
</P>