<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" id="sixapart-standard">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="generator" content="Movable Type Pro 5.02" />
<link rel="stylesheet" href="/pub/styles.css" type="text/css" />
<link rel="start" href="/pub/" title="Home" />
<link rel="alternate" type="application/atom+xml" title="Recent Entries" href="/pub/atom.xml" />
<script type="text/javascript" src="/pub/mt.js"></script>

<script type="text/javascript">

 var _gaq = _gaq || [];
 _gaq.push(['_setAccount', 'UA-50555-22']);
 _gaq.push(['_trackPageview']);

 (function() {
   var ga = document.createElement('script'); ga.type =
   'text/javascript'; ga.async = true;
   ga.src = ('https:' == document.location.protocol ? 'https://ssl' :
   'http://www') + '.google-analytics.com/ga.js';
   var s = document.getElementsByTagName('script')[0];
   s.parentNode.insertBefore(ga, s);
 })();

</script>
    
    <link rel="prev bookmark" href="/pub/2006/11/html-template-filters.html" title="Advanced HTML::Template: Filters" />
    <link rel="next bookmark" href="/pub/2007/01/painless-ppm.html" title="Painless Windows Module Installation with PPM" />
    
    
    <title>Using Java Classes in Perl - Perl.com</title>
</head>
<body id="perl-com" class="mt-entry-archive layout-wt">
    <div id="container">
        <div id="container-inner">


            <div id="header">
    <div id="header-inner">
        <div id="header-content">
        <div id="top_advert"> 
<!-- Put any landscape advert in here -->
<a href="http://www.perlfoundation.org/" target="_new">
<img src="/i/tpf_banner.png" width="468" height="60" /></a>
        </div> 



            <div id="header-name"><a href="/pub/" accesskey="1">Perl.com</a></div>
            <div id="header-description"></div>




        </div>
    </div>
</div>



            <div id="content">
                <div id="content-inner">


                    <div id="alpha">
                        <div id="alpha-inner">


                            <div id="entry-708" class="entry-asset asset hentry">
                                <div class="asset-header">
                                    <h1 id="page-title" class="asset-name entry-title">Using Java Classes in Perl</h1>
                                    <div class="asset-meta">
                                        <span class="byline">

                                            By <span class="vcard author">Andrew Hanenkamp</span> on <abbr class="published" title="2006-12-21T00:00:00-08:00">December 21, 2006 12:00 AM</abbr>

                                        </span>


                                    </div>
                                </div>
                                <div class="asset-content entry-content">

                                    <div class="asset-body">
                                        
<!-- sidebar begins -->
<!-- don't move sidebars-->
<!-- sidebar ends -->
<p>I started a new job recently to refocus my career from systems administration to web development. Part of that move meant using Java as my primary language at work and using a relatively new technology from the <a href="http://www.jcp.org/">Java Community Process</a> (JCP), the <a href="http://jcp.org/en/jsr/detail?id=170">Content Repository API for Java</a> (JCR), which is a hierarchical database standard for storing content. However, not wanting to let the skills in my favorite language waste away, I've been toying with similar technologies at home using Perl. I decided to make a direct port of the JCR to Perl and did so by making Perl use an existing Java implementation via <a href="http://search.cpan.org/~patl/Inline-Java/">Inline::Java</a>. While I ran into some snags along the way, I was happily surprised to find the process of using Java classes from Perl was fabulously easy.</p>

<h3>Bringing the JCR to Perl</h3>

<p>The key to using JCR from Perl is <code>Inline::Java</code>. This library allows a Perl program to call Java methods with very little effort. For an introduction to Inline::Java, I suggest starting where I did, Phil Crow's 2003 <a href="/pub/a/2003/11/07/java.html">Bringing Java into Perl</a> article on <a href="http://Perl.com">Perl.com</a> about Inline::Java. I also relied heavily upon the documentation for <a href="http://search.cpan.org/dist/Inline-Java/Java.pod">Inline::Java</a>, which is very complete, if not exhaustive.</p>

<p>To get started on using the JCR, I used the reference implementation, <a href="http://jackrabbit.apache.org/">Jackrabbit</a>. I downloaded the Jackrabbit JAR file, along with all the prerequisites, which I found on the Jackrabbit website under <a href="http://jackrabbit.apache.org/doc/firststeps.html">First Hops</a>. Then, I wrote a small script using <code>Inline::Java</code> to load the Java classes from Jackrabbit, create a repository, and then quit. I was able to take the First Hop with Jackrabbit in Perl as fast or faster than in Java:</p>

<pre><code>#!/usr/bin/perl
use strict; 
use warnings;
use Inline
    Java =&gt; 'STUDY',
    STUDY =&gt; [ qw(
        org.apache.jackrabbit.core.TransientRepository
        javax.jcr.Repository
    ) ],
    AUTOSTUDY =&gt; 1;

my $repository = org::apache::jackrabbit::core::TransientRepository-&gt;new;
my $session = $repository-&gt;login;
eval {
    my $user = $session-&gt;getUserID;
    my $name = $repository
        -&gt;getDescriptor($javax::jcr::Repository::REP_NAME_DESC);
    print "Logged in as $user to a $name repository.\n";
};

if ($@) {
    print STDERR "Exception: ", $@-&gt;getMessage, "n";
}

$session-&gt;logout;</code></pre>

<p>This code is a direct Perl port of the first tutorial on the Jackrabbit website. To run the code, you must make sure your class path is correct. Because I initially dropped the JCR files into my working directory, I just ran these commands to get it to work:</p>

<pre><code>% <strong>export CLASSPATH=$CLASSPATH:`echo *.jar | tr ' ' ':'`</strong>
% <strong>perl firsthop.pl</strong></code></pre>

<p>Within five minutes, I had a Perl script that could access the Jackrabbit libraries, create a repository, and login as anonymous. This answered my first question: Can I port the JCR to Perl? <em>Yes.</em></p>

<h3>First Snags</h3>

<p>After proceeding to the "Second Hop" in the Jackrabbit tutorial, I ran into my first snag. To create nodes and properties with Jackrabbit, you must log in using a username and password. However, the JCR uses an array of characters for the password argument. Because <code>Inline::Java</code> helpfully translates Java string objects into Perl scalars, I could not determine a way to do so.</p>

<p>I also realized that I did not want to use lengthy Java namespaces in my Perl code. Writing out <code>org::apache::jackrabbit::core::TransientRepository</code> or <code>javax::jcr::Repository</code> is not a very productive use of my time and makes for odd-looking Perl code.</p>

<p>In addition, I didn't want a library that depended on Jackrabbit. There are several other JCR implementations either already written or on the way. Day has <a href="http://www.day.com/crx">CRX</a>, there's another Open Source implementation named <a href="http://www.jeceira.com/">Jaceira</a> in the works, and <a href="http://docs.exoplatform.org/exo-documents/exo-jcr.site/index.html">eXo</a> has also created a JCR implementation, to name a few.</p>

<p>Given these difficulties and the potential for other problems that I knew would come up, it was time to build this project as a Perl module.</p>

<h3>Creating the Wrappers</h3>

<p>To create the abstraction I desired, it quickly became apparent that I needed a way to build wrappers around the stubs generated by <code>Inline::Java</code>. Therefore, I set about writing a script that could generate a Perl package for each library in the JCR. Each wrapper package would, in addition to helping wrap special cases, clean up the Java namespace using naming conventions that are more common to Perl code (particularly my Perl code, which is similar to Conway's conventions from <a href="http://www.oreilly.com/catalog/perlbp/"><cite>Perl Best Practices</cite></a>).</p>

<h3>Using Java Reflection</h3>

<p>I first needed to discover the classes, methods, and fields to wrap. There are more than 50 classes, interfaces, and exceptions in the JCR specification--I'm too lazy to type all that. Furthermore, the JCR is currently under revision via <a href="http://jcp.org/en/jsr/detail?id=283">JSR 283</a>, I don't want to update the class list again later. Finally, I want my wrappers to handle each method specifically because the use of <code>AUTOLOAD()</code> is evil (sometimes useful, but still evil).</p>

<p>I wrote a Java program to find all the classes in the JCR JAR file and write those class names out with additional information about methods, constructors, and fields. I used a <a href="http://www.yaml.org/">YAML</a>-formatted file to store the information. I made heavy use of the <a href="http://java.sun.com/docs/books/tutorial/reflect/index.html">Java Reflection API</a> to make this happen. You can see the <a href="http://search.cpan.org/src/HANENKAMP/Java-JCR-0.07/inc/JCRPackageGenerator.java">full source of JCR package generator</a> in the <a href="http://search.cpan.org/perldoc?Java::JCR">Java::JCR</a> distribution. Here's one entry in the <a href="http://search.cpan.org/src/HANENKAMP/Java-JCR-0.07/inc/packages.yml">YAML JCR package output file</a>:</p>

<pre><code>javax.jcr.SimpleCredentials:
  isa:
   - java.lang.Object
   - javax.jcr.Credentials
  has_constructors: 1
  methods:
    instance:
      getAttributeNames: Array:java.lang.String
      getUserID: java.lang.String
      toString: java.lang.String
      getPassword: Array:char
      getAttribute: java.lang.Object
      setAttribute: void
      removeAttribute: void</code></pre>

<p>The information I chose to place in the YAML file is mostly the outcome of experimentation with the Perl generator script. Because I wrote a generic handler to perform the required unwrapping that can handle any set of arguments, I didn't bother to remember them here. On the other hand, knowing the return type, recorded after each method name, is helpful to my implementation.</p>













<h3>Code Generation with Perl</h3>

<p>Next, I wrote a Perl script to load the information in the YAML file and generate the packages. You can see the full source for <a href="http://search.cpan.org/src/HANENKAMP/Java-JCR-0.07/inc/package-generator.pl">package-generator.pl</a> as well. This script is pretty ugly. I do all the work of generating the information in Perl with embedded here-documents. A much better way to do this would be to use a templating tool like Andy Wardley's <a href="http://www.template-toolkit.org/">Template Toolkit</a>, which is what I'd ultimately like to do.</p>

<p>Basically, this program iterates over all the entries loaded from the YAML file and generates a package for each class. It creates a Perl package name from the Java package name and a Perl package file at the appropriate location in the distribution.</p>

<p>For example, <code>javax.jcr.nodetype.ItemDefinition</code> gets a Perl package name of <code>Java::JCR::Nodetype::ItemDefinition</code> and a file location of <em>lib/Java/JCR/Nodetype/ItemDefinition.pm</em>.</p>

<p>The code injects a stock header and footer into the package file. All the real magic happens in between these.</p>

<h3>Handling Static Fields</h3>

<p>The code adds static fields by modifying the symbol table so that the wrappers point to the automatically generated stubs. For example, <code>Java::JCR::PropertyType</code> gets several entries like:</p>

<pre><code>*STRING = *Java::JCR::javax::jcr::PropertyType::STRING;
*BINARY = *Java::JCR::javax::jcr::PropertyType::BINARY;
*LONG = *Java::JCR::javax::jcr::PropertyType::LONG;</code></pre>

<p>For those who may not know, the first line makes the name <code>Java::JCR::PropertyType::STRING</code> exactly identical to using the longer name, <code>Java::JCR::javax::jcr::Property::STRING</code> by modifying the <a href="http://perldoc.perl.org/perlmod.html#Symbol-Tables-symbol-table-stash-%25%3a%3a-%25main%3a%3a-typeglob-glob-alias">symbol table</a> directly.</p>

<p>OK, looking at that, you probably want to know why all the <code>Inline::Java</code> stubs now have <code>Java::JCR</code> on the front of them. The reason is that in the generated code, I use the <code>study_classes()</code> routine to import the Java code and specify that the base package for the import should be <code>Java::JCR</code>:</p>

<pre><code>study_classes(['javax.jcr.PropertyType'], 'Java::JCR');</code></pre>

<p>Why? It's really not that critical, but I figured that because the name of the package I was putting on CPAN was <code>Java::JCR</code>, I really didn't want to drop packages into an external namespace while I was at it. Because the wrappers hide all the long names, the actual length of the internal names doesn't matter anyway.</p>

<h3>Dealing with Constructors and Methods</h3>

<p>After fields, the code checks whether the Java class provides a constructor (that is, if it's a class rather than an interface). As it turns out, I never actually use the code for dealing with constructors for two reasons:</p>

<ul>
<li><em>Exceptions</em>. For reasons I'll explain later, I don't generate the exception classes. Therefore, these constructors go unused.</li>

<li><em><code>SimpleCredentials</code></em>. The only remaining class that has a constructor is <code>java.jcr.SimpleCredentials</code>, which is the special case I've already mentioned. Therefore, I only need to cope with constructors as a special case. I'll cover the special cases later as well.</li>
</ul>

<p>After the constructor, the program runs through each method and generates both the static and instance method wrappers. Here's a typical method wrapper from <code>Java::JCR::Repository</code>:</p>

<pre><code>sub login {
    my $self = shift;
    my @args = Java::JCR::Base::_process_args(@_);

    my $result = eval { $self-&gt;{obj}-&gt;login(@args) };
    if ($@) { my $e = Java::JCR::Exception-&gt;new($@); croak $e }

    return Java::JCR::Base::_process_return($result, "javax.jcr.Session", "Java::JCR::Session");
}</code></pre>

<h3>Camel Case</h3>

<p>This particular example doesn't show it, but I also changed the camel-case Java names of every method to all lowercase with underscores, which is a much more common way of naming methods in Perl. I may add aliases using the Java names in the future, but I don't care for Java-style naming conventions in Perl code. The most interesting part of this process was handing names that include all-caps abbreviations. That required two lines of Perl:</p>

<pre><code>my $perl_method_name = $method_name;
$perl_method_name =~ s/(p{IsLu}+)/_L$1E/g;</code></pre>

<p>The <code>/(\p{IsLu}+)/</code> matches any uppercase letter or string of uppercase letters. The replacement applies the <code>\L</code> modifier to the regular expression to convert the matched snippet to all lowercase. I prepend an underscore to complete the conversion. Thus, the method named <code>getDescriptor</code> becomes <code>get_descriptor</code> and the method named <code>getNodeByUUID</code> becomes <code>get_node_by_uuid</code>. This won't work very well, by the way, if there are any names that have abbreviations before the end (for example, if there had been a <code>getUUIDNode</code>, which would become <code>get_uuidnode</code>) Fortunately, this case never shows up in the JCR API.</p>

<h3>Method Wrappers</h3>

<p><code>Java::JCR::Base::_process_arg()</code> processes the arguments passed to each method. This function looks for any of the generated wrapper objects (anything that <code>isa</code> <code>Java::JCR::Base</code>) in the list of arguments and unwraps the generated stub by pulling the <code>obj</code> key out of the blessed hash.</p>

<pre><code>sub _process_args {
    my @args;
    for my $arg (@_) {
        if (UNIVERSAL::isa($arg, 'Java::JCR::Base')) {
            push @args, $arg-&gt;{obj};
        }
        else {
            push @args, $arg;
        }
    }

    return @args; 
}</code></pre>

<p>The wrapper then executes the wrapped method on the generated stub by passing it the unwrapped arguments (as if the wrappers weren't there).</p>

<p>I make sure to wrap every call in an <code>eval</code> because <code>Inline::Java</code> passes Java exceptions as Perl exception objects. If an exception is thrown, I wrap it in a custom class named <code>Java::JCR::Exception</code>, which I wrote by hand.</p>

<p>Finally, the code returns the result. If the return type has a wrapper, as is the case in <code>login()</code>), I use <code>Java::JCR::Base::_process_return()</code> to cast the class and wrap it.</p>

<pre><code>sub _process_return {
    my $result = shift;
    my $java_package = shift;
    my $perl_package = shift;

    # Null is null
    if (!defined $result) {
        return $result;
    }

    # Process array results
    elsif ($java_package =~ /^Array:(.*)$/) {
        my $real_package = $1;
        return [
            map { bless { obj =&gt; cast($real_package, $_) }, $perl_package }
                @{ $result }
        ];
    }

    # Process scalar results
    else {
        return bless {
            obj =&gt; cast($java_package, $result),
        }, $perl_package;
    }
}</code></pre>

<p>This brings up two considerations: Why the custom exception class? Why do I need to cast the object? In both cases, I do this to handle minor issues in <code>Inline::Java</code>.</p>

<p>In the case of exceptions, the generated exception objects don't handle Perl stringification very well. Because a lot of exception handlers assume that exceptions are strings or properly stringified, this can be (and has been for me) a problem. My exception class makes sure stringification works the right way.</p>

<p>As for the cast, <code>Inline::Java</code> works on the assumption that you want to use the class in its most specific form, but if it hasn't studied that form, you get a generic object on which you cannot call any methods. Rather than engage the potentially costly <code>AUTOSTUDY</code> option to make sure <code>Inline::Java</code> studies everything and then smarten up the wrappers more, I've chosen to cast the objects into the expected return type. This does limit some of the flexibility.</p>

<h3>Loading Packages</h3>

<p>Other than the custom pieces, I needed some additional helpers to get the job done. I didn't want to write out a lot of <code>use</code> statements to use this library. As a JAPH, I like to keep things simple. Therefore, if I need to use the JCR and Jackrabbit, I just want to say:</p>

<pre><code>use Java::JCR;
use Java::JCR::Jackrabbit;</code></pre>

<p>I included a package loader in the main package, <a href="http://search.cpan.org/~hanenkamp/Java-JCR/lib/Java/JCR.pm">Java::JCR</a>, that will take care of these details and then created a package for each of the subpackages in the JCR. The loader looks like:</p>

<pre><code>sub import_my_packages {
    my ($package_name, $package_file) = caller;
    my %excludes = map { $_ =&gt; 1 } @_;

    my $package_dir = $package_file;
    $package_dir =~ s/.pm$//;
    my $package_glob = File::Spec-&gt;catfile($package_dir, '*.pm');

    for my $package (glob $package_glob) {
        $package =~ s/^$package_dir///;
        $package =~ s/.pm$//;
        $package =~ s///::/g;

        next if $excludes{$package};

        eval "use ${package_name}::$package;";
        if ($@) { carp "Error loading $package: $@" }
    }
}</code></pre>

<p>I make sure to call that method once the package has finished loading and pass in exclusions to keep it from loading all the subpackages. This needs further enhancement to allow for future extensions under the <code>Java::JCR</code> namespace, so as not to load them automatically, but this is a good starting point. I built one class for each subpackage, then, that inherits from Java::JCR and then calls this method to load each of those classes.</p>

<h3>Connecting to Jackrabbit</h3>

<p>Obviously, the next step was to create the code to connect to Jackrabbit. This was done in <a href="http://search.cpan.org/~hanenkamp/Java-JCR/lib/Java/JCR/Jackrabbit.pm">Java::JCR::Jackrabbit</a>. The initial implementation is very simple:</p>

<pre><code>use base qw( Java::JCR::Base Java::JCR::Repository );

use Inline (
    Java =&gt; 'STUDY',
    STUDY =&gt; [],
);
use Inline::Java qw( study_classes );

study_classes(['org.apache.jackrabbit.core.TransientRepository'], 'Java::JCR');

sub new {
    my $class = shift;

    return bless {
        obj =&gt; Java::JCR::org::apache::jackrabbit::core::TransientRepository
                -&gt;new(@_),
    }, $class;
}</code></pre>

<p>I extended <a href="http://search.cpan.org/~hanenkamp/Java-JCR/lib/Java/JCR/Repository.pm">Java::JCR::Repository</a> to add a constructor that calls the Jackrabbit constructor. Done.</p>













<h3>Handling Special Cases</h3>

<p>With all that work, I still couldn't make the second hop because I still hadn't resolved the whole problem of passing an array of characters. However, with the infrastructure I had in place, this was now solvable.</p>

<p>I created an additional YAML configuration file named <a href="http://search.cpan.org/src/HANENKAMP/Java-JCR-0.07/inc/specials.yml">specials.yml</a>. This file contains hand-coded alternatives to use where appropriate. I then wrote an alternative for the new constructor:</p>

<pre><code>javax.jcr.SimpleCredentials:
  new: |-
    sub new {
        my $class = shift;
        my $user = shift;
        my $password = shift;

        my $charArray = Java::JCR::PerlUtils-&gt;charArray($password);

        return bless {
            obj =&gt; Java::JCR::javax::jcr::SimpleCredentials-&gt;new($user, $charArray),
        }, $class;
    }</code></pre>

<p>Then, I reran the generator script. Fortunately, I had already improved it to use any implemented method or constructor rather than generating one automatically.</p>

<p>To perform the conversion, I also needed to embed a little extra Java code. I wrote a very small Java class called <code>PerlUtils</code> for handling the conversion:</p>

<pre><code>use Inline (
    Java =&gt; &lt;&lt;'END_OF_JAVA',

class PerlUtils {
    public static char[] charArray(String str) {
        return str.toCharArray();
    }
}

END_OF_JAVA
);</code></pre>

<p>Given a string, it returns an array of characters to pass back into the <code>SimpleCredentials</code> constructor. No other work is necessary. I could now perform the <a href="http://search.cpan.org/src/HANENKAMP/Java-JCR-0.07/ex/secondhop.pl">JCR second hop in Perl</a>. That script attaches to a Jackrabbit repository, logs in as "username" with password "password" and then creates a node.</p>

<h3>Using Handles as InputStreams</h3>

<p>The third (and final) hop of the Jackrabbit tutorial demonstrates node import using an XML file. However, in order to perform the import shown, you must pass an <code>InputStream</code> off to the <code>importXML()</code> method. While <code>Inline::Java</code> provides the ability to use Java <code>InputStream</code>s as Perl file handles, it doesn't provide the mapping in the opposite direction. Thus I needed another special handler and an additional set of helper methods.</p>

<p>The special code configuration looks like:</p>

<pre><code>javax.jcr.Session:
  import_xml: |-
    sub import_xml {
        my $self = shift;
        my $path = shift;
        my $handle = shift;
        my $behavior = shift;

        my $input_stream = Java::JCR::JavaUtils::input_stream($handle);

        $self-&gt;{obj}-&gt;importXML($path, $input_stream, $behavior);
    }</code></pre>

<p>This calls the <code>input_stream()</code> method, which is a Perl subroutine.</p>

<pre><code>sub input_stream {
    my $glob = shift;
    my $glob_val = $$glob;
    $glob_val =~ s/^\*//;
    my $glob_caller = Java::JCR::GlobCaller-&gt;new($glob_val);
    return Java::JCR::GlobInputStream-&gt;new($glob_caller);
}</code></pre>

<p>As you can see, this subroutine uses two separate Java classes to provide the interface from a Perl file handle to Java <code>InputStream</code>. The first class, <code>Java::JCR::GlobCaller</code>, performs most of the real work using the callback features provided by <code>Inline::Java</code>. It gets passed to the <code>Java::JCR::GlobInputStream</code>, which calls <code>read()</code> whenever the JCR reads from the stream:</p>

<pre><code>public int read() throws InlineJavaException, InlineJavaPerlException {
    String ch = (String) CallPerlSub(
            "Java::JCR::JavaUtils::read_one_byte", new Object[] {
                this.glob
           });
    return ch != null ? ch.charAt(0) : -1;
}</code></pre>

<p>The <code>read_one_byte()</code> function is a very basic wrapper for the Perl built-in <code>getc</code>.</p>

<pre><code>sub read_one_byte {
    my $glob = shift;
    my $c = getc $glob;
    return $c;
}</code></pre>

<p>With this in place, you can now perform the <a href="http://search.cpan.org/src/HANENKAMP/Java-JCR-0.07/ex/thirdhop.pl">third JCR hop in Perl</a>. By executing this script, you will connect to a repository, log in, and then create nodes and properties from an XML file.</p>

<h3>Getting Ready to Distribute</h3>

<p>The implementation is now, more or less, complete. You can use <code>Java::JCR</code> to connect to a Jackrabbit repository, log in, create nodes and properties, and import data from XML. There's a lot left untested, but the essentials are now present. With this done, I was ready to begin getting ready for the distribution. However, because some Java libraries are requirements to use the library, the library has some special needs to build and install easily. You should be able to install it by just running:</p>

<pre><code>% <strong>cpan Java::JCR</strong></code></pre>

<p>I needed a way to build this library. My preferred build tool is Ken Williams' <a href="http://search.cpan.org/perldoc?Module::Build">Module::Build</a>. It's in common use, compatible with the CPAN installer, and cooperates well with <em>g-cpan.pl</em>, which is a packaging tool for my favorite Linux distribution, <a href="http://www.gentoo.org/">Gentoo</a>. Finally, it's easy to extend.</p>

<p>When customizing <code>Module::Build</code>, I prefer to create a custom build module rather than by placing the extension directly inline with the <em>Build.PL</em> file. In this case, I've called the module <a href="http://search.cpan.org/src/HANENKAMP/Java-JCR-0.07/inc/Java/JCR/Build.pm">Java::JCR::Build</a>. I placed it inside a directory named <em>inc/</em> with the rest of the tools I built for generating the package.</p>

<p>After creating the basic module that extends <code>Module::Build</code>, I added a custom action to fetch the JAR files called <code>get_jars</code>. I also added the code to execute this action on build by extending the <code>code</code> ACTION:</p>

<pre><code>sub ACTION_get_jars {
    my $self = shift;

    eval "require LWP::UserAgent"
        or die "Failed to load LWP::UserAgent: $@";

    my $mirror_dir
        = File::Spec-&gt;catdir($self-&gt;blib, 'lib', 'Java', 'JCR');
    mkpath( $mirror_dir, 1);

    my $ua = LWP::UserAgent-&gt;new;

    print "Checking for needed jar files...n";
    while (my ($file, $url) = each %jars) {
        my $path = File::Spec-&gt;catfile($mirror_dir, $file);
        $self-&gt;add_to_cleanup($path);

        next if -f $path;

        my $response = $ua-&gt;mirror($url, $path);
        if ($response-&gt;is_success) {
            print "Mirroring $url to $file.n";
        }

        elsif ($response-&gt;is_error) {
            die "An error occurred fetching $url to $file: ",
                $response-&gt;status_line, "n";
        }
    }
}

sub ACTION_code {
    my $self = shift;

    $self-&gt;ACTION_get_jars;
    $self-&gt;SUPER::ACTION_code;
}</code></pre>

<p>I use Gisle Aas's <a href="http://search.cpan.org/perldoc?LWP::UserAgent">LWP::UserAgent</a> to fetch the JAR files from the public Maven repositories and drop them into the build library folder, <em>blib</em>. <code>Module::Build</code> will take care of the rest by copying those JAR files to the appropriate location during the install process.</p>

<p>I also needed some code in <code>Java::JCR</code> to set the <code>CLASSPATH</code> correctly ahead of time:</p>

<pre><code>my $classpath;
BEGIN {
    my @classpath;
    my $this_path = $INC{'Java/JCR.pm'};
    $this_path =~ s/.pm$//;
    my $jar_glob = File::Spec-&gt;catfile($this_path, "*.jar");
    for my $jar_file (glob $jar_glob) {
        push @classpath, $jar_file;
    }
    $classpath = join ':', @classpath, ($ENV{'CLASSPATH'} || '');
    $ENV{'CLASSPATH'} = $classpath;
}</code></pre>

<p>This bit of code asks Perl for the path to the location of this library, which I assume is the installed location of the JAR files. Then, I find each file ending with <em>.jar</em> in that directory and put them into the <code>CLASSPATH</code>. Unfortunately, my code assumes a Unix environment when it uses the colon as the path separator. A future revision could make sure that this works on other systems as well, but because I use only Unix-based operating systems, my motivation is lacking.</p>

<p>With all that, you can now deploy this by downloading the tarball and running:</p>

<pre><code>% <strong>perl Build.PL</strong>
% <strong>./Build</strong>
% <strong>./Build test</strong>
% <strong>./Build install</strong></code></pre>

<p>It works!</p>

<h3>Testing</h3>

<p>I haven't mentioned this yet, but during the whole process of building this library, I also built a series of test cases. You can find these in the <a href="http://search.cpan.org/src/HANENKAMP/Java-JCR-0.07/t/"><em>t</em>/</a> directory of the distribution. The first few tests are actually just variations on the Jackrabbit tutorial, as well as a test to make sure the POD documentation contains no errors (every module author should use this test; you can just copy and paste it into any project).</p>

<h3>Final Thoughts</h3>

<p>I love Perl. This port from Java to Perl was easier than I would have thought possible. I wanted to share my success in the hopes of spurring on others. Kudos go to Ken Williams and Patrick LeBoutillier and the others that have assisted them to build the tools that made this possible.</p>

<p>Cheers.</p>


                                    </div>


                                </div>
                                <div class="asset-footer">

    
                                    <div class="entry-categories">
                                        <h4>Categories<span class="delimiter">:</span></h4>
                                        <ul>
                                            <li><a href="/pub/java/" rel="tag">Java</a></li>
                                        </ul>
                                    </div>
    


                                    <div class="entry-tags">
                                        <h4>Tags<span class="delimiter">:</span></h4>
                                        <ul>
                                            <li><a href="javascript:void(0)" onclick="location.href='http://www.perl.com/mt-search.cgi?blog_id=2&amp;tag=Inline%3A%3AJava&amp;limit=20';return false;" rel="tag">Inline::Java</a><span class="delimiter">,</span></li> <li><a href="javascript:void(0)" onclick="location.href='http://www.perl.com/mt-search.cgi?blog_id=2&amp;tag=Java%20bindings&amp;limit=20';return false;" rel="tag">Java bindings</a><span class="delimiter">,</span></li> <li><a href="javascript:void(0)" onclick="location.href='http://www.perl.com/mt-search.cgi?blog_id=2&amp;tag=Java%20classes&amp;limit=20';return false;" rel="tag">Java classes</a><span class="delimiter">,</span></li> <li><a href="javascript:void(0)" onclick="location.href='http://www.perl.com/mt-search.cgi?blog_id=2&amp;tag=JCR&amp;limit=20';return false;" rel="tag">JCR</a><span class="delimiter">,</span></li> <li><a href="javascript:void(0)" onclick="location.href='http://www.perl.com/mt-search.cgi?blog_id=2&amp;tag=Perl%20bindings&amp;limit=20';return false;" rel="tag">Perl bindings</a></li>
                                        </ul>
                                    </div>

                                </div>
                            </div>


                    
                    


                        </div>
                    </div>


                    <div id="beta">
    <div id="beta-inner">


    
    <div class="widget-what-is-perl widget">
    <div class="widget-content widget-content-what-is-perl">
       Visit the home of the  Perl programming language: <a href="http://www.perl.org/">Perl.org</a
    </div>
</div>
<div class="widget-find-out-more widget-archives widget">
    <div class="widget-content">
        <ul>
            <li><a href="http://www.perl.org/get.html">Download</a></li>
            <li><a href="http://perldoc.perl.org/">Documentation</a></li>
            <li><a href="http://blogs.perl.org/">Perl Bloggers</a></li>
            <li><a href="http://news.perlfoundation.org/">Foundation News</a></li>
        </ul>
    </div>
</div><div class="widget-tcpc widget">
<h3 class="widget-header">Sponsored by</h3>
    <div class="widget-content">
        <a href="http://training.perl.com/" alt="Perl Training" target="_blank"><img src="/i/tcpc.png" width="150" height="50"></a>
    </div>
</div>

<div class="widget-syndication widget">
    <div class="widget-content">
        <ul>
            <li><img src="/mt-static/images/status_icons/feed.gif" alt="Subscribe to feed" width="9" height="9" /> <a href="/pub/atom.xml">Subscribe to this website's feed</a></li>

        </ul>
    </div>
</div>
<div class="widget-archive-monthly widget-archive widget">
    <h3 class="widget-header">Monthly <a href="/pub/archives.html">Archives</a></h3>
    <div class="widget-content">
        <ul>
        
            <li><a href="/pub/2010/07/">July 2010 (1)</a></li>
        
    
        
            <li><a href="/pub/2008/05/">May 2008 (1)</a></li>
        
    
        
            <li><a href="/pub/2008/04/">April 2008 (2)</a></li>
        
    
        
            <li><a href="/pub/2008/03/">March 2008 (1)</a></li>
        
    
        
            <li><a href="/pub/2008/02/">February 2008 (1)</a></li>
        
    
        
            <li><a href="/pub/2008/01/">January 2008 (1)</a></li>
        
    
        
            <li><a href="/pub/2007/12/">December 2007 (2)</a></li>
        
    
        
            <li><a href="/pub/2007/09/">September 2007 (1)</a></li>
        
    
        
            <li><a href="/pub/2007/08/">August 2007 (1)</a></li>
        
    
        
            <li><a href="/pub/2007/07/">July 2007 (1)</a></li>
        
    
        
            <li><a href="/pub/2007/06/">June 2007 (1)</a></li>
        
    
        
            <li><a href="/pub/2007/05/">May 2007 (1)</a></li>
        
    
        
            <li><a href="/pub/2007/04/">April 2007 (1)</a></li>
        
    
        
            <li><a href="/pub/2007/03/">March 2007 (1)</a></li>
        
    
        
            <li><a href="/pub/2007/02/">February 2007 (1)</a></li>
        
    
        
            <li><a href="/pub/2007/01/">January 2007 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/12/">December 2006 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/11/">November 2006 (2)</a></li>
        
    
        
            <li><a href="/pub/2006/10/">October 2006 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/09/">September 2006 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/08/">August 2006 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/07/">July 2006 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/06/">June 2006 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/05/">May 2006 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/04/">April 2006 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/03/">March 2006 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/02/">February 2006 (4)</a></li>
        
    
        
            <li><a href="/pub/2006/01/">January 2006 (4)</a></li>
        
    
        
            <li><a href="/pub/2005/12/">December 2005 (4)</a></li>
        
    
        
            <li><a href="/pub/2005/11/">November 2005 (3)</a></li>
        
    
        
            <li><a href="/pub/2005/10/">October 2005 (2)</a></li>
        
    
        
            <li><a href="/pub/2005/09/">September 2005 (2)</a></li>
        
    
        
            <li><a href="/pub/2005/08/">August 2005 (9)</a></li>
        
    
        
            <li><a href="/pub/2005/07/">July 2005 (8)</a></li>
        
    
        
            <li><a href="/pub/2005/06/">June 2005 (9)</a></li>
        
    
        
            <li><a href="/pub/2005/05/">May 2005 (8)</a></li>
        
    
        
            <li><a href="/pub/2005/04/">April 2005 (7)</a></li>
        
    
        
            <li><a href="/pub/2005/03/">March 2005 (6)</a></li>
        
    
        
            <li><a href="/pub/2005/02/">February 2005 (7)</a></li>
        
    
        
            <li><a href="/pub/2005/01/">January 2005 (6)</a></li>
        
    
        
            <li><a href="/pub/2004/12/">December 2004 (8)</a></li>
        
    
        
            <li><a href="/pub/2004/11/">November 2004 (8)</a></li>
        
    
        
            <li><a href="/pub/2004/10/">October 2004 (5)</a></li>
        
    
        
            <li><a href="/pub/2004/09/">September 2004 (9)</a></li>
        
    
        
            <li><a href="/pub/2004/08/">August 2004 (6)</a></li>
        
    
        
            <li><a href="/pub/2004/07/">July 2004 (8)</a></li>
        
    
        
            <li><a href="/pub/2004/06/">June 2004 (6)</a></li>
        
    
        
            <li><a href="/pub/2004/05/">May 2004 (7)</a></li>
        
    
        
            <li><a href="/pub/2004/04/">April 2004 (8)</a></li>
        
    
        
            <li><a href="/pub/2004/03/">March 2004 (8)</a></li>
        
    
        
            <li><a href="/pub/2004/02/">February 2004 (9)</a></li>
        
    
        
            <li><a href="/pub/2004/01/">January 2004 (7)</a></li>
        
    
        
            <li><a href="/pub/2003/12/">December 2003 (4)</a></li>
        
    
        
            <li><a href="/pub/2003/11/">November 2003 (7)</a></li>
        
    
        
            <li><a href="/pub/2003/10/">October 2003 (8)</a></li>
        
    
        
            <li><a href="/pub/2003/09/">September 2003 (6)</a></li>
        
    
        
            <li><a href="/pub/2003/08/">August 2003 (7)</a></li>
        
    
        
            <li><a href="/pub/2003/07/">July 2003 (9)</a></li>
        
    
        
            <li><a href="/pub/2003/06/">June 2003 (9)</a></li>
        
    
        
            <li><a href="/pub/2003/05/">May 2003 (8)</a></li>
        
    
        
            <li><a href="/pub/2003/04/">April 2003 (8)</a></li>
        
    
        
            <li><a href="/pub/2003/03/">March 2003 (10)</a></li>
        
    
        
            <li><a href="/pub/2003/02/">February 2003 (8)</a></li>
        
    
        
            <li><a href="/pub/2003/01/">January 2003 (8)</a></li>
        
    
        
            <li><a href="/pub/2002/12/">December 2002 (5)</a></li>
        
    
        
            <li><a href="/pub/2002/11/">November 2002 (9)</a></li>
        
    
        
            <li><a href="/pub/2002/10/">October 2002 (7)</a></li>
        
    
        
            <li><a href="/pub/2002/09/">September 2002 (11)</a></li>
        
    
        
            <li><a href="/pub/2002/08/">August 2002 (8)</a></li>
        
    
        
            <li><a href="/pub/2002/07/">July 2002 (8)</a></li>
        
    
        
            <li><a href="/pub/2002/06/">June 2002 (4)</a></li>
        
    
        
            <li><a href="/pub/2002/05/">May 2002 (6)</a></li>
        
    
        
            <li><a href="/pub/2002/04/">April 2002 (6)</a></li>
        
    
        
            <li><a href="/pub/2002/03/">March 2002 (7)</a></li>
        
    
        
            <li><a href="/pub/2002/02/">February 2002 (5)</a></li>
        
    
        
            <li><a href="/pub/2002/01/">January 2002 (8)</a></li>
        
    
        
            <li><a href="/pub/2001/12/">December 2001 (7)</a></li>
        
    
        
            <li><a href="/pub/2001/11/">November 2001 (5)</a></li>
        
    
        
            <li><a href="/pub/2001/10/">October 2001 (9)</a></li>
        
    
        
            <li><a href="/pub/2001/09/">September 2001 (7)</a></li>
        
    
        
            <li><a href="/pub/2001/08/">August 2001 (13)</a></li>
        
    
        
            <li><a href="/pub/2001/07/">July 2001 (8)</a></li>
        
    
        
            <li><a href="/pub/2001/06/">June 2001 (13)</a></li>
        
    
        
            <li><a href="/pub/2001/05/">May 2001 (11)</a></li>
        
    
        
            <li><a href="/pub/2001/04/">April 2001 (9)</a></li>
        
    
        
            <li><a href="/pub/2001/03/">March 2001 (8)</a></li>
        
    
        
            <li><a href="/pub/2001/02/">February 2001 (8)</a></li>
        
    
        
            <li><a href="/pub/2001/01/">January 2001 (8)</a></li>
        
    
        
            <li><a href="/pub/2000/12/">December 2000 (6)</a></li>
        
    
        
            <li><a href="/pub/2000/11/">November 2000 (10)</a></li>
        
    
        
            <li><a href="/pub/2000/10/">October 2000 (10)</a></li>
        
    
        
            <li><a href="/pub/2000/09/">September 2000 (2)</a></li>
        
    
        
            <li><a href="/pub/2000/08/">August 2000 (2)</a></li>
        
    
        
            <li><a href="/pub/2000/07/">July 2000 (5)</a></li>
        
    
        
            <li><a href="/pub/2000/06/">June 2000 (7)</a></li>
        
    
        
            <li><a href="/pub/2000/05/">May 2000 (7)</a></li>
        
    
        
            <li><a href="/pub/2000/04/">April 2000 (3)</a></li>
        
    
        
            <li><a href="/pub/2000/03/">March 2000 (2)</a></li>
        
    
        
            <li><a href="/pub/2000/02/">February 2000 (2)</a></li>
        
    
        
            <li><a href="/pub/2000/01/">January 2000 (2)</a></li>
        
    
        
            <li><a href="/pub/1999/12/">December 1999 (6)</a></li>
        
    
        
            <li><a href="/pub/1999/11/">November 1999 (6)</a></li>
        
    
        
            <li><a href="/pub/1999/10/">October 1999 (5)</a></li>
        
    
        
            <li><a href="/pub/1999/09/">September 1999 (4)</a></li>
        
    
        
            <li><a href="/pub/1999/08/">August 1999 (3)</a></li>
        
    
        
            <li><a href="/pub/1999/07/">July 1999 (2)</a></li>
        
    
        
            <li><a href="/pub/1999/06/">June 1999 (3)</a></li>
        
    
        
            <li><a href="/pub/1999/04/">April 1999 (1)</a></li>
        
    
        
            <li><a href="/pub/1999/03/">March 1999 (1)</a></li>
        
    
        
            <li><a href="/pub/1999/01/">January 1999 (1)</a></li>
        
    
        
            <li><a href="/pub/1998/12/">December 1998 (1)</a></li>
        
    
        
            <li><a href="/pub/1998/11/">November 1998 (1)</a></li>
        
    
        
            <li><a href="/pub/1998/07/">July 1998 (2)</a></li>
        
    
        
            <li><a href="/pub/1998/06/">June 1998 (1)</a></li>
        
    
        
            <li><a href="/pub/1998/03/">March 1998 (1)</a></li>
        
        </ul>
    </div>
</div>
        
    

<div class="widget-powered widget">
    <div class="widget-content">
        <a href="http://www.movabletype.com/"><img src="/mt-static/images/bug-pbmt-white.png" alt="Powered by Movable Type 5.02" width="120" height="75" /></a>
    </div>
</div>



    </div>
</div>






                </div>
            </div>


            <div id="footer">
    <div id="footer-inner">
        <div id="footer-content">
            <div class="widget-powered widget">
                <div class="widget-content">
                    Powered by <a href="http://www.movabletype.com/" rel="generator">Movable Type Pro</a>
                </div>
            </div>

        </div>
    </div>
</div>



        </div>
    </div>
</body>
</html>
