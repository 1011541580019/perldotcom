<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" id="sixapart-standard">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="generator" content="Movable Type Pro 5.13-en" />
<link rel="stylesheet" href="/pub/styles.css" type="text/css" />
<link rel="start" href="/pub/" title="Home" />
<link rel="alternate" type="application/atom+xml" title="Recent Entries" href="/pub/atom.xml" />
<script type="text/javascript" src="/pub/mt.js"></script>
<!--
<rdf:RDF xmlns="http://web.resource.org/cc/"
         xmlns:dc="http://purl.org/dc/elements/1.1/"
         xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#">
<Work rdf:about="/pub/2004/06/10/email.html">
<dc:title>The Evolution of Perl Email Handling</dc:title>
<dc:description> I spend the vast majority of my time at a computer working with email, whether it&apos;s working through the ones I send and receive each day, or working on my interest in analyzing, indexing, organizing, and mining email content....</dc:description>
<dc:creator>Simon Cozens</dc:creator>
<dc:date>2004-06-10T00:00:00-08:00</dc:date>
<license rdf:resource="http://creativecommons.org/licenses/by-nc-nd/3.0/" />
</Work>
<License rdf:about="http://creativecommons.org/licenses/by-nc-nd/3.0/">
</License>
</rdf:RDF>
-->

<script type="text/javascript">

 var _gaq = _gaq || [];
 _gaq.push(['_setAccount', 'UA-50555-22']);
 _gaq.push(['_trackPageview']);

 (function() {
   var ga = document.createElement('script'); ga.type =
   'text/javascript'; ga.async = true;
   ga.src = ('https:' == document.location.protocol ? 'https://ssl' :
   'http://www') + '.google-analytics.com/ga.js';
   var s = document.getElementsByTagName('script')[0];
   s.parentNode.insertBefore(ga, s);
 })();

</script>
<script type='text/javascript' src='http://partner.googleadservices.com/gampad/google_service.js'></script>
<script type='text/javascript'>
GS_googleAddAdSenseService("ca-pub-4136420132070439");
GS_googleEnableAllServices();
</script>
<script type='text/javascript'>
GA_googleAddSlot("ca-pub-4136420132070439", "Perl_728x90");
</script>
<script type='text/javascript'>GA_googleFetchAds();</script>
    
    <link rel="prev bookmark" href="/pub/2004/06/p6pdigest/20040606.html" title="This Week on Perl 6, Fortnight Ending 2004-06-06" />
    <link rel="next bookmark" href="/pub/2004/06/18/variables.html" title="Perl's Special Variables" />
    
    
    <title>The Evolution of Perl Email Handling - Perl.com</title>
</head>
<body id="perl-com" class="mt-entry-archive layout-wt">
    <div id="container">
        <div id="container-inner">


            <div id="header">
    <div id="header-inner">
        <div id="header-content">
        <span id="top_advert"> 
<!-- Put any landscape advert in here -->
<!-- Perl_728x90 -->
<script type='text/javascript'>
GA_googleFillSlot("Perl_728x90");
</script>
        </span> 



            <div id="header-name"><a href="/pub/" accesskey="1">Perl.com</a></div>
            <div id="header-description">news and views of the Perl programming language</div>




        </div>
    </div>
</div>



            <div id="content">
                <div id="content-inner">


                    <div id="alpha">
                        <div id="alpha-inner">


                            <div id="entry-942" class="entry-asset asset hentry">
                                <div class="asset-header">
                                    <h1 id="page-title" class="asset-name entry-title">The Evolution of Perl Email Handling</h1>
                                    <div class="asset-meta">
                                        <span class="byline">

                                            By <span class="vcard author">Simon Cozens</span> on <abbr class="published" title="2004-06-10T00:00:00-08:00">June 10, 2004 12:00 AM</abbr>

                                        </span>


                                    </div>
                                </div>
                                <div class="asset-content entry-content">

                                    <div class="asset-body">
                                        
<!-- sidebar begins -->
<!-- don't move sidebars -->
<!-- sidebar ends -->

<p>I spend the vast majority of my time at a computer working with email, whether it's working through the ones I send and receive each day,
or working on my interest in analyzing,
indexing,
organizing, and mining email content.
Naturally,
Perl helps out with this.</p>

<p>There are many modules on the CPAN for slicing and dicing email,
and we're going to take a whistlestop tour of the major ones. We'll also concentrate on an effort started by myself,
Richard Clamp,
Simon Wistow, and others,
called the Perl Email Project,
to produce simple,
efficient and accurate mail handling modules.</p>

<h3><a name="Message_handling">Message Handling</a></h3>

<p>We'll begin with those modules that represent an individual message,
giving you access to the headers and body,
and usually allowing you to modify these.</p>

<p>The granddaddy of these modules is <a href="http://search.cpan.org/perldoc?Mail::Internet"><code>Mail::Internet</code></a>,
originally created by Graham Barr and now maintained by Mark Overmeer.
This module offers a constructor that takes either an array of lines or a filehandle,
reads a message, and returns a <code>Mail::Internet</code> object representing the message.
Throughout these examples,
we'll use the variable <code>$rfc2822</code> to represent a mail message as a string.</p>

<pre><code>    my $obj = Mail::Internet-&gt;new( [ split /\n/, $rfc2822 ] );</code></pre>

<p><code>Mail::Internet</code> splits a message into a header object in the <a href="http://search.cpan.org/perldoc?Mail::Header"><code>Mail::Header</code></a> class, plus a body. You can get and set individual headers through this object:</p>

<pre><code>    my $subject = $obj-&gt;head-&gt;get(&quot;Subject&quot;);
    $obj-&gt;head-&gt;replace(&quot;Subject&quot;, &quot;New subject&quot;);</code></pre>

<p>Reading and editing the body is done through the <code>body</code> method:</p>

<pre><code>    my $old_body = $obj-&gt;body;
    $obj-&gt;body(&quot;Wasn't worth reading anyway.&quot;);</code></pre>

<p>I've not said anything about MIME yet. <code>Mail::Internet</code> is reasonably handy for simple tasks, but it doesn't handle MIME at all. Thankfully, <a href="http://search.cpan.org/perldoc?MIME::Entity"><code>MIME::Entity</code></a> is a MIME-aware subclass of <code>Mail::Internet</code>; it allows you to read individual parts of a MIME message:</p>

<pre><code>    my $num_parts = $obj-&gt;parts;
    for (0..$num_parts) {
        my $part = $obj-&gt;parts($_);
        ...
    }</code></pre>

<p>If <code>Mail::Internet</code> and <code>MIME::Entity</code> don't cut it for you, you can try Mark Overmeer's own <a href="http://search.cpan.org/perldoc?Mail::Message"><code>Mail::Message</code></a>, part of the impressive <a href="http://search.cpan.org/perldoc?Mail::Box"><code>Mail::Box</code></a> suite. <code>Mail::Message</code> is extremely featureful and comprehensive, but that is not always meant as a compliment.</p>

<p><code>Mail::Message</code> objects are usually constructed by <code>Mail::Box</code> as part of reading in an email folder, but can also be generated from an email using the <code>read</code> method:</p>

<pre><code>    $obj = Mail::Message-&gt;read($rfc2822);</code></pre>

<p>Like <code>Mail::Internet</code>, messages are split into headers and bodies; unlike <code>Mail::Internet</code>, the body of a <code>Mail::Message</code> object is also an object. We read headers like so:</p>

<pre><code>    $obj-&gt;head-&gt;get(&quot;Subject&quot;);</code></pre>

<p>Or, for <code>Subject</code> and other common headers:</p>

<pre><code>    $obj-&gt;subject;</code></pre>

<p>I couldn't find a way to set headers directly, and ended up doing this:</p>

<pre><code>    $obj-&gt;head-&gt;delete($header);
    $obj-&gt;head-&gt;add($header, $_) for @data;</code></pre>

<p>Reading the body as a string is only marginally more difficult:</p>

<pre><code>    $obj-&gt;decoded-&gt;string</code></pre>

<p>While setting the body is an absolute nightmare--we have to create a new <code>Mail::Message::Body</code> object and replace our current one with it.</p>

<pre><code>    $obj-&gt;body(Mail::Message::Body-&gt;new(data =&gt; [split /\n/, $body]));</code></pre>

<p><code>Mail::Message</code> may be slow, but it's certainly hard to use. It's also rather complex; the operations we've looked at so far involved the use of 16 classes (<code>Mail::Address</code>, <code>Mail::Box::Parser</code>, <code>Mail::Box::Parser::Perl</code>, <code>Mail::Message</code>, <code>Mail::Message::Body</code>, <code>Mail::Message::Body::File</code>, <code>Mail::Message::Body::Lines</code>, <code>Mail::Message::Body::Multipart</code>, <code>Mail::Message::Body::Nested</code>, <code>Mail::Message::Construct</code>, <code>Mail::Message::Field</code>, <code>Mail::Message::Field::Fast</code>, <code>Mail::Message::Head</code>, <code>Mail::Message::Head::Complete</code>, <code>Mail::Message::Part</code>, and <code>Mail::Reporter</code>) and 4400 lines of code. It does have a lot of features, though.</p>

<p>Foolishly, I thought that email parsing shouldn't be so complex, and so I sat down to write the simplest possible functional mail handling library. The result is <a href="http://search.cpan.org/perldoc?Email::Simple"><code>Email::Simple</code></a>, and its interface looks like this:</p>

<pre><code>    my $obj = Email::Simple-&gt;new($rfc2822);
    my $subject = $obj-&gt;header(&quot;Subject&quot;);
    $obj-&gt;header_set(&quot;Subject&quot;, &quot;A new subject&quot;);
    my $old_body = $obj-&gt;body;
    $obj-&gt;body_set(&quot;A new body\n&quot;);
    print $obj-&gt;as_string;</code></pre>

<p>It doesn't do a lot, but it does it simply and efficiently. If you need MIME handling, there's a subclass called <a href="http://search.cpan.org/perldoc?Email::MIME"><code>Email::MIME</code></a>, which adds the <code>parts</code> method.</p>

<p>Realistically, the choice of which mail handling library to use ought to be up to you, the end user, but this isn't always true. Auxilliary modules, which mess about with email at a higher level, can ask for the mail to be presented in a particular representation. For instance, until recently, the wonderful <code>Mail::ListDetector</code> module, which we'll examine later, required mails passed in to it to be <code>Mail::Internet</code> objects, since this gave it a known API to work with the objects. I don't want to work with <code>Mail::Internet</code> objects, but I want to use <code>Mail::ListDetector</code>'s functionality. What can I do?</p>

<p>In order to enable the user to have the choice again, I wrote an abstraction layer across all of the above modules, called <a href="http://search.cpan.org/perldoc?Email::Abstract"><code>Email::Abstract</code></a>. Given any of the above objects, we can say:</p>

<pre><code>     my $subject = Email::Abstract-&gt;get_header($obj, &quot;Subject&quot;);
     Email::Abstract-&gt;set_header($obj, &quot;Subject&quot;, &quot;My new subject&quot;);
     my $body = Email::Abstract-&gt;get_body($obj);
     Email::Abstract-&gt;set_body($message, &quot;Hello\nTest message\n&quot;);
     $rfc2822 = Email::Abstract-&gt;as_string($obj);</code></pre>

<p><code>Email::Abstract</code> knows how to perform these operations on the major types of mail representation objects. It also abstracts out the process of constructing a message, and allows you to change the interface of a message using the <code>cast</code> class method:</p>

<pre><code>    my $obj = Email::Abstract-&gt;cast($rfc2822, &quot;Mail::Internet&quot;);
    my $mm = Email::Abstract-&gt;cast($obj, &quot;Mail::Message&quot;);</code></pre>

<p>This allows module authors to write their mail handling libraries in an interface-agnostic way, and I'm grateful to Michael Stevens for taking up <code>Email::Abstract</code> in <code>Mail::ListDetector</code> so quickly. Now I can pass in <code>Email::Simple</code> objects to <code>Mail::ListDetector</code> and it will work fine.</p>

<p><code>Email::Abstract</code> also gives us the opportunity to create some benchmarks for all of the above modules. Here was the benchmarking code I used:</p>

<pre><code>    use Email::Abstract;
    my $message = do { local $/; &lt;DATA&gt;; };
    my @classes =
        qw(Email::MIME Email::Simple MIME::Entity Mail::Internet Mail::Message);

    eval &quot;require $_&quot; or die $@ for @classes;

    use Benchmark;
    my %h;
    for my $class (@classes) {
        $h{$class} = sub {
            my $obj = Email::Abstract-&gt;cast($message, $class);
            Email::Abstract-&gt;get_header($obj, &quot;Subject&quot;);
            Email::Abstract-&gt;get_body($obj);
            Email::Abstract-&gt;set_header($obj, &quot;Subject&quot;, &quot;New Subject&quot;);
            Email::Abstract-&gt;set_body($obj, &quot;A completely new body&quot;);
            Email::Abstract-&gt;as_string($obj);
        }
    }
    timethese(1000, \%h);

    __DATA__
    ...</code></pre>

<p>I put a short email in the <code>DATA</code> section and ran the same simple operations a thousand times: construct a message, read a header, read the body, set the header, set the body, and return the message as a string.</p>

<pre><code>    Benchmark: timing 1000 iterations of Email::MIME, Email::Simple, 
    MIME::Entity, Mail::Internet, Mail::Message...
    Email::MIME: 10 wallclock secs ( 7.97 usr +  0.24 sys =  8.21 CPU) 
        @ 121.80/s (n=1000)
    Email::Simple:  9 wallclock secs ( 7.49 usr +  0.05 sys =  7.54 CPU) 
        @ 132.63/s (n=1000)
    MIME::Entity: 33 wallclock secs (23.76 usr +  0.35 sys = 24.11 CPU) 
        @ 41.48/s (n=1000)
    Mail::Internet: 24 wallclock secs (17.34 usr +  0.30 sys = 17.64 CPU) 
        @ 56.69/s (n=1000)
    Mail::Message: 20 wallclock secs (17.12 usr +  0.27 sys = 17.39 CPU) 
        @ 57.50/s (n=1000)</code></pre>

<p>The Perl Email Project was a success: <code>Email::MIME</code> and <code>Email::Simple</code> were twice as fast as their nearest competitors. However, it should be stressed that they're both very low level; if you're doing anything more complex than the operations we've seen, you might consider one of the older <code>Mail::</code> modules.</p>













<h3><a name="Mailbox_handling">Mailbox Handling</a></h3>

<p>So much for individual messages; let's move on to handling groups of messages, or folders. We've mentioned <code>Mail::Box</code> already, and this is truly the king of folder handling, supporting local and remote folders, editing folders, and all sorts of other things besides. To use it, we first need a <code>Mail::Box::Manager</code>, which is a factory object for creating <code>Mail::Box</code>es.</p>

<pre><code>    use Mail::Box::Manager
    my $mgr = Mail::Box::Manager-&gt;new;</code></pre>

<p>Next, we need to open the folder using the manager:</p>

<pre><code>    my $folder = $mgr-&gt;open(folder =&gt; $folder_file);</code></pre>

<p>And now we can get at the individual messages as <code>Mail::Message</code> objects:</p>

<pre><code>    for ($folder-&gt;messages) {
        print $_-&gt;subject,&quot;\n&quot;;
    }</code></pre>

<p>With its more minimalist approach, my favorite mail box manager until recently was <code>Mail::Util</code>'s <code>read_mbox</code> function, which takes the name of a Unix <code>mbox</code> file, and returns a list of array references; each reference is the array of lines of a message, suitable for feeding to <code>Mail::Internet-&gt;new</code> or similar:</p>

<pre><code>    for (read_mbox($folder_file)) {
        my $obj = Mail::Internet-&gt;new($_);
        print $_-&gt;head-&gt;get(&quot;Subject&quot;),&quot;\n&quot;;
    }</code></pre>

<p>These two are both really handy, but there seemed to be room for something in between the simplicity of <code>Mail::Util</code> and the functionality of <code>Mail::Box</code>, and so the Email Project struck again with <a href="http://search.cpan.org/perldoc?Email::Folder"><code>Email::Folder</code></a> and <a href="http://search.cpan.org/perldoc?Email::LocalDelivery"><code>Email::LocalDelivery</code></a>. <code>Email::Folder</code> handles mbox and maildir folders, with more types planned, and has a reasonably simple interface:</p>

<pre><code>    my $folder = Email::Folder-&gt;new($folder_file);
    for ($folder-&gt;messages) {
        print $_-&gt;header(&quot;Subject&quot;),&quot;\n&quot;;
    }</code></pre>

<p>By default it returns <code>Email::Simple</code> objects for the messages, but this can be changed by subclassing. For instance, if we want raw RFC2822 strings, we can do this:</p>

<pre><code>    package Email::Folder::Raw; use base 'Email::Folder';
    sub bless_message { my ($self, $rfc2822) = @_; return $rfc2822; }</code></pre>

<p>Perhaps in the future, we will change <code>bless_message</code> to use <code>Email::Abstract-&gt;cast</code> to make the representation of messages easier to select without necessarily having to subclass.</p>

<p>The other side of folder handling is writing to a folder, or &quot;local delivery&quot;. <a href="http://search.cpan.org/perldoc?Email::LocalDelivery"><code>Email::LocalDelivery</code></a> was written to assist <code>Email::Filter</code>, of which more later. The problem is harder than it sounds, as it has to deal with locking, escaping mail bodies, and specific problems due to mailbox and maildir formats. <code>LocalDelivery</code> hides all of these things beneath a simple interface:</p>

<pre><code>    Email::LocalDelivery-&gt;deliver($rfc2822, @mailboxes);</code></pre>

<p>Both <code>Email::LocalDelivery</code> and <code>Email::Folder</code> use the <a href="http://search.cpan.org/perldoc?Email::FolderType"><code>Email::FolderType</code></a> helper module to determine the type of a folder based on its filename.</p>

<h3><a name="Address_handling">Address Handling</a></h3>

<p>To come down to a lower level of abstraction again, there are a number of modules for handling email addresses. The old favorite is <a href="http://search.cpan.org/perldoc?Mail::Address"><code>Mail::Address</code></a>. A mail address appearing in the fields of an email can be made up of several elements: the actual address, a phrase or name, and a comment. For instance:</p>

<pre><code>    Example user &lt;example@example.com&gt; (Not a real user)</code></pre>

<p><code>Mail::Address</code> parses these addresses, separating out the phrase and comments, allowing you to get at the individual components:</p>

<pre><code>    for (Mail::Address-&gt;parse($from_line)) {
        print $_-&gt;name, &quot;\t&quot;, $_-&gt;address, &quot;\n&quot;;
    }</code></pre>

<p>Unfortunately, like many of the mail modules, it tries really hard to be helpful.</p>

<pre><code>    my ($addr) = Mail::Address-&gt;parse('&quot;eBay, Inc.&quot; &lt;support@ebay.com&gt;');
    print $addr-&gt;name # Inc. eBay</code></pre>

<p>Which, while better than the &quot;Inc Ebay&quot; that previous versions would produce, isn't really acceptable. Casey West joined our merry band of renegades and produced <a href="http://search.cpan.org/perldoc?Email::Address"><code>Email::Address</code></a>. It has exactly the same interface as <code>Mail::Address</code>, but it works, and is about twice to three times as fast.</p>

<p>One thing we often want to do when handling mail addresses is to make sure that they're valid. If, for instance, a user is registering for content at a web site, we need to check that the address they've given is capable of receiving mail. <a href="http://search.cpan.org/perldoc?Email::Valid"><code>Email::Valid</code></a>, the original inhabitant of the <code>Email::</code> namespace before our bunch of disaffected squatters moved in, does just this. In its most simple use, we can say:</p>

<pre><code>    if (not Email::Valid-&gt;address('test@example.com')) {
        die &quot;Not a valid address&quot;
    }</code></pre>

<p>You can turn on additional checks, such as ensuring there's a valid MX record for the domain, correcting common AOL and Compuserve addressing mistakes, on so on:</p>

<pre><code>    if (not Email::Valid-&gt;address(-address =&gt; 'test@example.com',
                                  -mxcheck =&gt; 1)) {
        die &quot;Not a valid address&quot;
    }</code></pre>

<h3><a name="Mail_munging">Mail Munging</a></h3>

<p>Once we have our emails, what are we going to do with them? A lot of what I've been looking at has been textual analysis of email, and there are three modules that particularly help with this.</p>

<p>This first is <code>Text::Quoted</code>; it takes the body text of an email message, or any other text really, and tries to figure out which parts of the message are quotations from other messages. It then separates these out into a nested data structure. For instance, if we have</p>

<pre><code>    $message = &lt;&lt;EOF
    &gt; foo
    &gt; # Bar
    &gt; baz

    quux
    EOF</code></pre>

<p>Then running <code>extract($message)</code> will return a data structure like this:</p>

<pre><code>    [
      [
        { text =&gt; 'foo', quoter =&gt; '&gt;', raw =&gt; '&gt; foo' },
        [ 
            { text =&gt; 'Bar', quoter =&gt; '&gt; #', raw =&gt; '&gt; # Bar' } 
        ],
        { text =&gt; 'baz', quoter =&gt; '&gt;', raw =&gt; '&gt; baz' }
      ],

      { empty =&gt; 1 },
      { text =&gt; 'quux', quoter =&gt; '', raw =&gt; 'quux' }
    ];</code></pre>

<p>This is extremely useful for highlighting different levels of quoting in different colors when displaying a message. A similar concept is <a href="http://search.cpan.org/perldoc?Text::Original"><code>Text::Original</code></a>, which looks for the start of original, non-quoted content in an email. It knows about many kinds of attribution lines, so with:</p>

<pre><code>    $message = &lt;&lt;EOF
    You wrote:
    &gt; Why are there so many different mail modules?

    There's more than one way to do it! Different modules have different
    focuses, and operate at different levels; some lower, some higher.
    EOF</code></pre>

<p>the <code>first_sentence($message)</code> would be <code>There's more than one way to do it!</code>. The Mariachi mailing list archiver uses this technique to give a &quot;prompt&quot; for each message in a thread.</p>

<p>And speaking of threads, the <a href="http://search.cpan.org/perldoc?Mail::Thread"><code>Mail::Thread</code></a> module is a Perl implementation of Jamie Zawinski's mail threading algorithm, as used by Mozilla as well as many other mail clients since then. It's also used by Mariachi, and has recently been updated to use <code>Email::Abstract</code> to handle any kind of mail object you want to throw at it:</p>

<pre><code>    my $threader = Mail::Thread-&gt;new(@mails);
    $threader-&gt;thread; # Compute threads
    for ($threader-&gt;rootset) { # Original mails in a thread
        dump_thread($_);
    }</code></pre>

<h3><a name="Mail_filtering">Mail Filtering</a></h3>

<p>The classic Perl mail filtering tool is <a href="http://search.cpan.org/perldoc?Mail::Audit"><code>Mail::Audit</code></a>, and I've written articles here about using Mail::Audit on its own (<a href='http://www.perl.com/pub/a/2001/07/17/mailfiltering.html'>http://www.perl.com/pub/a/2001/07/17/mailfiltering.html</a>) and using it in conjunction with <a href="http://search.cpan.org/perldoc?Mail::SpamAssassin"><code>Mail::SpamAssassin</code></a> (<a href='http://www.perl.com/pub/a/2002/03/06/spam.html'>http://www.perl.com/pub/a/2002/03/06/spam.html</a>).</p>

<p>We've mentioned <a href="http://search.cpan.org/perldoc?Mail::ListDetector"><code>Mail::ListDetector</code></a> a couple of times already, and I use this with <code>Mail::Audit</code> to do most of the filtering automatically for me. The <code>Mail::Audit::List</code> plugin uses <code>ListDetector</code> to look for mailing list headers in a message; these are things like <code>List-Id</code>, <code>X-Mailman-Version</code>, and the like, which identify a mail as having come through a mailing list. This means I can filter out all mailing list posts to their own folders, like so:</p>

<pre><code>    my $list = Mail::ListDetector-&gt;new($obj);
    if ($list) {
        my $name = $list-&gt;listname;
        $item-&gt;accept(&quot;mail/$name.-$date&quot;);
    }</code></pre>

<p>However, <code>Mail::Audit</code> itself is getting a little long in the tooth, and so new installations are encouraged to use the Email Project's <a href="http://search.cpan.org/perldoc?Email::Filter"><code>Email::Filter</code></a> instead; it has the same interface for the most part, although not all of the same features, and it uses the new-fangled <code>Email::Simple</code> mail representation for speed and cleanliness.</p>

<h3><a name="Mail_mining">Mail Mining</a></h3>

<p>Finally, the most high-level thing I do with email is develop frameworks to automatically categorize, organize, and index mail into a database, and attempt to analyze it for interesting nuggets of information.</p>

<p>My first module to do this with was <a href="http://search.cpan.org/perldoc?Mail::Miner"><code>Mail::Miner</code></a>, which consists of three major parts. The first part takes an email, removes any attachments, and stores the lot in a database. The second looks over the email and runs a set of &quot;Recogniser&quot; modules on it; these find addresses, phone numbers, keywords and phrases, and so on, and store them in a separate database table. The third part is a command-line tool to query the database for mail and information.</p>

<p>For instance, if I need to find Tim O'Reilly's postal address, I ask the query tool, <code>mm</code>, to find addresses in emails from him:</p>

<pre><code> % mm --from &quot;Tim O&quot; --address              
 Address found in message 1835 from &quot;Tim O'Reilly&quot; &lt;tim@oreilly.com&gt;:
 Tim O'Reilly @ O'Reilly &amp; Associates, Inc.
 1005 Gravenstein Highway North, Sebastopol, CA 95472</code></pre>

<p>To retrieve the whole email, I'd say</p>

<pre><code> % mm --id 1835</code></pre>

<p>And if it originally contained an attachment, we'd see something like this as part of the email:</p>

<pre><code> [ text/xml attachment something.xml detached - use
   mm --detach 208
   to recover ]</code></pre>

<p>I paste that middle line <code>mm --detach 208</code> into a shell, and hey presto, <em>something.xml</em> is written to disk.</p>

<p>Now <code>Mail::Miner</code> is all very well, but having the three ideas in one tight package--filing mail, mining mail, and interfacing to the database--makes it difficult to develop and extend any one of them. And of course, it uses the old-school <code>Mail::</code> modules.</p>

<p>This brings us to our final module on the mail modules tour, and the most recently released: <a href="http://search.cpan.org/perldoc?Email::Store"><code>Email::Store</code></a>. This is a framework, based on <a href="http://search.cpan.org/perldoc?Class::DBI"><code>Class::DBI</code></a>, for storing email in a database and indexing it in various ways:</p>

<pre><code>   use Email::Store 'dbi:SQLite:mail.db';
   Email::Store-&gt;setup;
   Email::Store::Mail-&gt;store($rfc2822);</code></pre>

<p>And then later...</p>

<pre><code>   my ($name) = Email::Store::Name-&gt;search( name =&gt; &quot;Simon Cozens&quot; )
   @mails_from_simon = $name-&gt;addressings( role =&gt; &quot;From&quot; )-&gt;mails;</code></pre>

<p>It can be used to build a mailing list archive tool such as Mariachi, or a data mining setup like <code>Mail::Miner</code>. It's still very much in development, and makes use of a new idea in module extensibility.</p>

<p>I'll be bringing more information when we've written the first mail archiving and searching tool using <code>Email::Store</code>, which I'm going to be doing as a new interface to the Perl mailing lists at <code>perl.org</code>.</p>

<h3><a name="Conclusion">Conclusion</a></h3>

<p>We've looked at the major modules for mail handling on CPAN, and there are many more. I am obviously biased towards those which I wrote, and particularly the Perl Email Project modules in the <code>Email::*</code> namespace. These modules are specifically designed to be simple, efficient, and correct, but may not always be a good substitute for the more thorough <code>Mail::*</code> modules, particularly <code>Mail::Box</code>. However, I hope you're now a little more aware of the diversity of mail handling tools out there, and know where to look next time you need to manipulate email with Perl.</p>




                                    </div>


                                </div>
                                <div class="asset-footer">


                                    <div class="entry-tags">
                                        <h4>Tags<span class="delimiter">:</span></h4>
                                        <ul>
                                            <li><a href="javascript:void(0)" onclick="location.href='http://www.perl.com/mt-search.cgi?IncludeBlogs=2&amp;tag=email&amp;limit=20';return false;" rel="tag">email</a><span class="delimiter">,</span></li> <li><a href="javascript:void(0)" onclick="location.href='http://www.perl.com/mt-search.cgi?IncludeBlogs=2&amp;tag=filtering&amp;limit=20';return false;" rel="tag">filtering</a><span class="delimiter">,</span></li> <li><a href="javascript:void(0)" onclick="location.href='http://www.perl.com/mt-search.cgi?IncludeBlogs=2&amp;tag=mail&amp;limit=20';return false;" rel="tag">mail</a><span class="delimiter">,</span></li> <li><a href="javascript:void(0)" onclick="location.href='http://www.perl.com/mt-search.cgi?IncludeBlogs=2&amp;tag=spamassassin&amp;limit=20';return false;" rel="tag">spamassassin</a></li>
                                        </ul>
                                    </div>

                                </div>
                            </div>


                    
                    


                        </div>
                    </div>


                    <div id="beta">
    <div id="beta-inner">


    
    <div class="widget-what-is-perl widget">
    <div class="widget-content widget-content-what-is-perl">
       Visit the home of the  Perl programming language: <a href="http://www.perl.org/">Perl.org</a
    </div>
</div>
<div class="widget-find-out-more widget-archives widget">
    <div class="widget-content">
        <ul>
            <li><a href="http://www.perl.org/get.html">Download</a></li>
            <li><a href="http://perldoc.perl.org/">Documentation</a></li>
            <li><a href="http://blogs.perl.org/">Perl Bloggers</a></li>
            <li><a href="http://news.perlfoundation.org/">Foundation News</a></li>
        </ul>
    </div>
</div><div class="widget-tcpc widget">
<h3 class="widget-header">Sponsored by</h3>
    <div class="widget-content">
        <a href="http://training.perl.com/" alt="Perl Training" target="_blank"><img src="/i/tcpc.png" width="150" height="50"></a>
    </div>
</div>

<div class="widget-syndication widget">
    <div class="widget-content">
        <ul>
            <li><img src="/mt-static/images/status_icons/feed.gif" alt="Subscribe to feed" width="9" height="9" /> <a href="/pub/atom.xml">Subscribe to this website's feed</a></li>

        </ul>
    </div>
</div>
<div class="widget-archive-monthly widget-archive widget">
    <h3 class="widget-header">Monthly <a href="/pub/archives.html">Archives</a></h3>
    <div class="widget-content">
        <ul>
        
            <li><a href="/pub/2014/02/">February 2014 (1)</a></li>
        
    
        
            <li><a href="/pub/2014/01/">January 2014 (1)</a></li>
        
    
        
            <li><a href="/pub/2013/10/">October 2013 (1)</a></li>
        
    
        
            <li><a href="/pub/2013/01/">January 2013 (1)</a></li>
        
    
        
            <li><a href="/pub/2012/12/">December 2012 (1)</a></li>
        
    
        
            <li><a href="/pub/2012/11/">November 2012 (1)</a></li>
        
    
        
            <li><a href="/pub/2012/10/">October 2012 (2)</a></li>
        
    
        
            <li><a href="/pub/2012/08/">August 2012 (2)</a></li>
        
    
        
            <li><a href="/pub/2012/06/">June 2012 (11)</a></li>
        
    
        
            <li><a href="/pub/2012/05/">May 2012 (18)</a></li>
        
    
        
            <li><a href="/pub/2012/04/">April 2012 (17)</a></li>
        
    
        
            <li><a href="/pub/2012/02/">February 2012 (1)</a></li>
        
    
        
            <li><a href="/pub/2011/12/">December 2011 (1)</a></li>
        
    
        
            <li><a href="/pub/2011/09/">September 2011 (1)</a></li>
        
    
        
            <li><a href="/pub/2011/08/">August 2011 (2)</a></li>
        
    
        
            <li><a href="/pub/2011/06/">June 2011 (1)</a></li>
        
    
        
            <li><a href="/pub/2011/05/">May 2011 (3)</a></li>
        
    
        
            <li><a href="/pub/2011/04/">April 2011 (1)</a></li>
        
    
        
            <li><a href="/pub/2011/03/">March 2011 (1)</a></li>
        
    
        
            <li><a href="/pub/2011/02/">February 2011 (1)</a></li>
        
    
        
            <li><a href="/pub/2011/01/">January 2011 (1)</a></li>
        
    
        
            <li><a href="/pub/2010/11/">November 2010 (1)</a></li>
        
    
        
            <li><a href="/pub/2010/10/">October 2010 (2)</a></li>
        
    
        
            <li><a href="/pub/2010/09/">September 2010 (1)</a></li>
        
    
        
            <li><a href="/pub/2010/08/">August 2010 (3)</a></li>
        
    
        
            <li><a href="/pub/2010/07/">July 2010 (2)</a></li>
        
    
        
            <li><a href="/pub/2010/04/">April 2010 (2)</a></li>
        
    
        
            <li><a href="/pub/2010/03/">March 2010 (4)</a></li>
        
    
        
            <li><a href="/pub/2008/05/">May 2008 (1)</a></li>
        
    
        
            <li><a href="/pub/2008/04/">April 2008 (2)</a></li>
        
    
        
            <li><a href="/pub/2008/03/">March 2008 (1)</a></li>
        
    
        
            <li><a href="/pub/2008/02/">February 2008 (1)</a></li>
        
    
        
            <li><a href="/pub/2008/01/">January 2008 (1)</a></li>
        
    
        
            <li><a href="/pub/2007/12/">December 2007 (2)</a></li>
        
    
        
            <li><a href="/pub/2007/09/">September 2007 (1)</a></li>
        
    
        
            <li><a href="/pub/2007/08/">August 2007 (1)</a></li>
        
    
        
            <li><a href="/pub/2007/07/">July 2007 (1)</a></li>
        
    
        
            <li><a href="/pub/2007/06/">June 2007 (1)</a></li>
        
    
        
            <li><a href="/pub/2007/05/">May 2007 (1)</a></li>
        
    
        
            <li><a href="/pub/2007/04/">April 2007 (1)</a></li>
        
    
        
            <li><a href="/pub/2007/03/">March 2007 (1)</a></li>
        
    
        
            <li><a href="/pub/2007/02/">February 2007 (1)</a></li>
        
    
        
            <li><a href="/pub/2007/01/">January 2007 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/12/">December 2006 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/11/">November 2006 (2)</a></li>
        
    
        
            <li><a href="/pub/2006/10/">October 2006 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/09/">September 2006 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/08/">August 2006 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/07/">July 2006 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/06/">June 2006 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/05/">May 2006 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/04/">April 2006 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/03/">March 2006 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/02/">February 2006 (4)</a></li>
        
    
        
            <li><a href="/pub/2006/01/">January 2006 (4)</a></li>
        
    
        
            <li><a href="/pub/2005/12/">December 2005 (4)</a></li>
        
    
        
            <li><a href="/pub/2005/11/">November 2005 (3)</a></li>
        
    
        
            <li><a href="/pub/2005/10/">October 2005 (2)</a></li>
        
    
        
            <li><a href="/pub/2005/09/">September 2005 (2)</a></li>
        
    
        
            <li><a href="/pub/2005/08/">August 2005 (9)</a></li>
        
    
        
            <li><a href="/pub/2005/07/">July 2005 (8)</a></li>
        
    
        
            <li><a href="/pub/2005/06/">June 2005 (9)</a></li>
        
    
        
            <li><a href="/pub/2005/05/">May 2005 (8)</a></li>
        
    
        
            <li><a href="/pub/2005/04/">April 2005 (7)</a></li>
        
    
        
            <li><a href="/pub/2005/03/">March 2005 (6)</a></li>
        
    
        
            <li><a href="/pub/2005/02/">February 2005 (7)</a></li>
        
    
        
            <li><a href="/pub/2005/01/">January 2005 (6)</a></li>
        
    
        
            <li><a href="/pub/2004/12/">December 2004 (8)</a></li>
        
    
        
            <li><a href="/pub/2004/11/">November 2004 (8)</a></li>
        
    
        
            <li><a href="/pub/2004/10/">October 2004 (5)</a></li>
        
    
        
            <li><a href="/pub/2004/09/">September 2004 (9)</a></li>
        
    
        
            <li><a href="/pub/2004/08/">August 2004 (6)</a></li>
        
    
        
            <li><a href="/pub/2004/07/">July 2004 (8)</a></li>
        
    
        
            <li><a href="/pub/2004/06/">June 2004 (6)</a></li>
        
    
        
            <li><a href="/pub/2004/05/">May 2004 (7)</a></li>
        
    
        
            <li><a href="/pub/2004/04/">April 2004 (8)</a></li>
        
    
        
            <li><a href="/pub/2004/03/">March 2004 (8)</a></li>
        
    
        
            <li><a href="/pub/2004/02/">February 2004 (9)</a></li>
        
    
        
            <li><a href="/pub/2004/01/">January 2004 (7)</a></li>
        
    
        
            <li><a href="/pub/2003/12/">December 2003 (4)</a></li>
        
    
        
            <li><a href="/pub/2003/11/">November 2003 (7)</a></li>
        
    
        
            <li><a href="/pub/2003/10/">October 2003 (8)</a></li>
        
    
        
            <li><a href="/pub/2003/09/">September 2003 (6)</a></li>
        
    
        
            <li><a href="/pub/2003/08/">August 2003 (7)</a></li>
        
    
        
            <li><a href="/pub/2003/07/">July 2003 (9)</a></li>
        
    
        
            <li><a href="/pub/2003/06/">June 2003 (9)</a></li>
        
    
        
            <li><a href="/pub/2003/05/">May 2003 (8)</a></li>
        
    
        
            <li><a href="/pub/2003/04/">April 2003 (8)</a></li>
        
    
        
            <li><a href="/pub/2003/03/">March 2003 (10)</a></li>
        
    
        
            <li><a href="/pub/2003/02/">February 2003 (8)</a></li>
        
    
        
            <li><a href="/pub/2003/01/">January 2003 (8)</a></li>
        
    
        
            <li><a href="/pub/2002/12/">December 2002 (5)</a></li>
        
    
        
            <li><a href="/pub/2002/11/">November 2002 (9)</a></li>
        
    
        
            <li><a href="/pub/2002/10/">October 2002 (7)</a></li>
        
    
        
            <li><a href="/pub/2002/09/">September 2002 (11)</a></li>
        
    
        
            <li><a href="/pub/2002/08/">August 2002 (8)</a></li>
        
    
        
            <li><a href="/pub/2002/07/">July 2002 (8)</a></li>
        
    
        
            <li><a href="/pub/2002/06/">June 2002 (4)</a></li>
        
    
        
            <li><a href="/pub/2002/05/">May 2002 (6)</a></li>
        
    
        
            <li><a href="/pub/2002/04/">April 2002 (6)</a></li>
        
    
        
            <li><a href="/pub/2002/03/">March 2002 (7)</a></li>
        
    
        
            <li><a href="/pub/2002/02/">February 2002 (5)</a></li>
        
    
        
            <li><a href="/pub/2002/01/">January 2002 (8)</a></li>
        
    
        
            <li><a href="/pub/2001/12/">December 2001 (7)</a></li>
        
    
        
            <li><a href="/pub/2001/11/">November 2001 (5)</a></li>
        
    
        
            <li><a href="/pub/2001/10/">October 2001 (9)</a></li>
        
    
        
            <li><a href="/pub/2001/09/">September 2001 (7)</a></li>
        
    
        
            <li><a href="/pub/2001/08/">August 2001 (13)</a></li>
        
    
        
            <li><a href="/pub/2001/07/">July 2001 (8)</a></li>
        
    
        
            <li><a href="/pub/2001/06/">June 2001 (13)</a></li>
        
    
        
            <li><a href="/pub/2001/05/">May 2001 (11)</a></li>
        
    
        
            <li><a href="/pub/2001/04/">April 2001 (9)</a></li>
        
    
        
            <li><a href="/pub/2001/03/">March 2001 (8)</a></li>
        
    
        
            <li><a href="/pub/2001/02/">February 2001 (8)</a></li>
        
    
        
            <li><a href="/pub/2001/01/">January 2001 (8)</a></li>
        
    
        
            <li><a href="/pub/2000/12/">December 2000 (6)</a></li>
        
    
        
            <li><a href="/pub/2000/11/">November 2000 (10)</a></li>
        
    
        
            <li><a href="/pub/2000/10/">October 2000 (10)</a></li>
        
    
        
            <li><a href="/pub/2000/09/">September 2000 (2)</a></li>
        
    
        
            <li><a href="/pub/2000/08/">August 2000 (2)</a></li>
        
    
        
            <li><a href="/pub/2000/07/">July 2000 (5)</a></li>
        
    
        
            <li><a href="/pub/2000/06/">June 2000 (7)</a></li>
        
    
        
            <li><a href="/pub/2000/05/">May 2000 (7)</a></li>
        
    
        
            <li><a href="/pub/2000/04/">April 2000 (3)</a></li>
        
    
        
            <li><a href="/pub/2000/03/">March 2000 (2)</a></li>
        
    
        
            <li><a href="/pub/2000/02/">February 2000 (2)</a></li>
        
    
        
            <li><a href="/pub/2000/01/">January 2000 (2)</a></li>
        
    
        
            <li><a href="/pub/1999/12/">December 1999 (6)</a></li>
        
    
        
            <li><a href="/pub/1999/11/">November 1999 (6)</a></li>
        
    
        
            <li><a href="/pub/1999/10/">October 1999 (5)</a></li>
        
    
        
            <li><a href="/pub/1999/09/">September 1999 (4)</a></li>
        
    
        
            <li><a href="/pub/1999/08/">August 1999 (3)</a></li>
        
    
        
            <li><a href="/pub/1999/07/">July 1999 (2)</a></li>
        
    
        
            <li><a href="/pub/1999/06/">June 1999 (3)</a></li>
        
    
        
            <li><a href="/pub/1999/04/">April 1999 (1)</a></li>
        
    
        
            <li><a href="/pub/1999/03/">March 1999 (1)</a></li>
        
    
        
            <li><a href="/pub/1999/01/">January 1999 (1)</a></li>
        
    
        
            <li><a href="/pub/1998/12/">December 1998 (1)</a></li>
        
    
        
            <li><a href="/pub/1998/11/">November 1998 (1)</a></li>
        
    
        
            <li><a href="/pub/1998/07/">July 1998 (2)</a></li>
        
    
        
            <li><a href="/pub/1998/06/">June 1998 (1)</a></li>
        
    
        
            <li><a href="/pub/1998/03/">March 1998 (1)</a></li>
        
        </ul>
    </div>
</div>
        
    

<div class="widget-powered widget">
    <div class="widget-content">
        <a href="http://www.movabletype.com/"><img src="/mt-static/images/bug-pbmt-white.png" alt="Powered by Movable Type 5.13-en" width="120" height="75" /></a>
    </div>
</div>



    </div>
</div>






                </div>
            </div>


            <div id="footer">
    <div id="footer-inner">
        <div id="footer-content">
            <div class="widget-powered widget">
                <div class="widget-content">
                    Powered by <a href="http://www.movabletype.com/" rel="generator">Movable Type Pro</a>
                </div>
            </div>

            <div class="widget-creative-commons widget">
                <div class="widget-content">
                    This blog is licensed under a <a href="http://creativecommons.org/licenses/by-nc-nd/3.0/">Creative Commons License</a>.
                </div>
            </div>

        </div>
    </div>
</div>



        </div>
    </div>
</body>
</html>
