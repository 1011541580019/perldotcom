<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" id="sixapart-standard">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="generator" content="Movable Type Pro 5.13-en" />
<link rel="stylesheet" href="/pub/styles.css" type="text/css" />
<link rel="start" href="/pub/" title="Home" />
<link rel="alternate" type="application/atom+xml" title="Recent Entries" href="/pub/atom.xml" />
<script type="text/javascript" src="/pub/mt.js"></script>
<!--
<rdf:RDF xmlns="http://web.resource.org/cc/"
         xmlns:dc="http://purl.org/dc/elements/1.1/"
         xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#">
<Work rdf:about="/pub/">
<dc:title>Perl.com</dc:title>
<dc:description>news and views of the Perl programming language</dc:description>
<license rdf:resource="http://creativecommons.org/licenses/by-nc-nd/3.0/" />
</Work>
<License rdf:about="http://creativecommons.org/licenses/by-nc-nd/3.0/">
</License>
</rdf:RDF>
-->

<script type="text/javascript">

 var _gaq = _gaq || [];
 _gaq.push(['_setAccount', 'UA-50555-22']);
 _gaq.push(['_trackPageview']);

 (function() {
   var ga = document.createElement('script'); ga.type =
   'text/javascript'; ga.async = true;
   ga.src = ('https:' == document.location.protocol ? 'https://ssl' :
   'http://www') + '.google-analytics.com/ga.js';
   var s = document.getElementsByTagName('script')[0];
   s.parentNode.insertBefore(ga, s);
 })();

</script>
<script type='text/javascript' src='http://partner.googleadservices.com/gampad/google_service.js'></script>
<script type='text/javascript'>
GS_googleAddAdSenseService("ca-pub-4136420132070439");
GS_googleEnableAllServices();
</script>
<script type='text/javascript'>
GA_googleAddSlot("ca-pub-4136420132070439", "Perl_728x90");
</script>
<script type='text/javascript'>GA_googleFetchAds();</script>
    <title>Perl.com: April 2004 Archives</title>


    <link rel="prev" href="/pub/2004/03/" title="March 2004" />
    <link rel="next" href="/pub/2004/05/" title="May 2004" />

</head>
<body id="perl-com" class="mt-archive-listing mt-datebased-monthly-archive layout-wt">
    <div id="container">
        <div id="container-inner">


            <div id="header">
    <div id="header-inner">
        <div id="header-content">
        <span id="top_advert"> 
<!-- Put any landscape advert in here -->
<!-- Perl_728x90 -->
<script type='text/javascript'>
GA_googleFillSlot("Perl_728x90");
</script>
        </span> 



            <div id="header-name"><a href="/pub/" accesskey="1">Perl.com</a></div>
            <div id="header-description">news and views of the Perl programming language</div>




        </div>
    </div>
</div>



            <div id="content">
                <div id="content-inner">


                    <div id="alpha">
                        <div id="alpha-inner">


                            <h1 id="page-title" class="archive-title">April 2004 Archives</h1>





                            
                            <div id="entry-922" class="entry-asset asset hentry">
    <div class="asset-header">
        <h2 class="asset-name entry-title"><a href="/pub/2004/04/p6pdigest/20040425.html" rel="bookmark">This Week on Perl 6, Week Ending 2004-04-25</a></h2>
        <div class="asset-meta">
            <span class="byline">
    
                By <span class="vcard author">Piers Cawley</span> on <abbr class="published" title="2004-04-29T00:00:00-08:00">April 29, 2004 12:00 AM</abbr>
    
            </span>

            
            

        </div>
    </div>
    <div class="asset-content entry-content">

        <div class="asset-body">
            
<!-- sidebar begins -->
<!-- don't move sidebars -->
<!-- sidebar ends -->

<p>And we&#39;re back on a weekly schedule again (unless the Mayday bank holiday knocks me for six next week).
As I expected,
the Apocalypse has brought out a rash of prophets and prognosticators in perl6&#45;language,
but perl6&#45;internals is still ahead on number of messages per week.</p>

<h4><a name="Constant_Strings">Constant Strings</a></h4>

<p>I confess I&#39;m not sure I quite understand the constant strings patches that Leo T&#246;tsch and Jeff Clites were discussing.
I understand the bottom line though &#45;&#45; they make parrot a lot quicker when comparing constant strings.
Huzzah!</p>

<p>Then it turned into a discussion of Unicode (or at least,
Parrot string handling which is almost,
but not quite,
the same thing).</p>

<p><a href='http://groups.google.com/groups?selm=A14A6816&#45;91DA&#45;11D8&#45;8CC6&#45;000393A6B9DA@mac.com'>http://groups.google.com/</a></p>

<h4><a name="Parrot_m4_0.0.4">Parrot m4 0.0.4</a></h4>

<p>Bernhard Schmalhofer posted a patch to bring his parrot implementation of m4 up to what he&#39;s calling version 0.0.4</p>

<p><a href='http://groups.google.com/groups?selm=rt&#45;3.0.8&#45;28971&#45;85658.6.53100225472009@perl.org'>http://groups.google.com/</a></p>

<h4><a name="SDL_Parrot_status">SDL Parrot status</a></h4>

<p>Portland Parrot stalwart,
chromatic,
posted a link to a SDL Parrot site he&#39;s set up with current status,
downloadable snapshots and other good SDL Parrot related things.</p>

<p><a href='http://wgz.org/chromatic/parrot/sdl/'>http://wgz.org/chromatic/parrot/sdl/</a></p>

<h4><a name="Passing_arrays_of_structs_to_NCI_subs">Passing arrays of structs to NCI subs</a></h4>

<csperl file="grab" domain="on" record="b/940" template="b/article_sidebar.view">

<p>That man chromatic again,
this time he asked if there was a secret syntax for passing and retrieving arrays of things to and from NCI.
Leo noted that,
according to the docs,
there is no secret syntax,
it&#39;s all documented but unimplemented.</p>

<p><a href='http://groups.google.com/groups?selm=1082432832.32682.127.camel@localhost'>http://groups.google.com</a></p>

<h4><a name="PMC_Constants">PMC Constants</a></h4>

<p>Last week,
Leo asked for comments on his proposal for PMC constants.
This week,
Dan replied.
Essentially he&#39;s all for the idea,
but wasn&#39;t sure which implementation strategy was the best choice.</p>

<p><a href='http://groups.google.com/groups?selm=a06100501bca9c8cae4e0@[172.24.18.98]'>http://groups.google.com</a></p>

<h4><a name="Assign_and_set">Assign and set</a></h4>

<p>Leo announced some changes he&#39;d made to the behaviour of the <code lang='und' xml:lang='und'>set</code> and <code lang='und' xml:lang='und'>assign</code> opcodes.
Jens Rieks pointed out a case that he&#39;d missed.</p>

<p><a href='http://groups.google.com/groups?selm=4084D4F2.50800@toetsch.at'>http://groups.google.com</a></p>

<h4><a name="hyper_op_&#45;_proof_of_concept"><code lang='und' xml:lang='und'>hyper</code> op &#45; proof of concept</a></h4>

<p>Leo also implemented what he described as a rather hackish and incomplete new opcode called <code lang='und' xml:lang='und'>hyper</code>.
Dan liked it enough to suggest that we should go the whole hog and add a hyper vtable to PMCs,
with hyper versions of all the standard vtable entries.
He and Dan had a long discussion of this,
with contributions from various luminaries including Larry.
There was some debate as to whether we really needed overridable hyper ops,
but Dan&#39;s adamant that whatever happens they&#39;ll be implemented in a vtable to allow for potential optimizations in some cases.</p>

<p><a href='http://groups.google.com/groups?selm=408533A9.80909@toetsch.at'>http://groups.google.com</a></p>

<h4><a name="Separating_allocation_and_initialization_of_objects">Separating allocation and initialization of objects</a></h4>

<p>Last week,
Leo posted the latest object benchmarks,
and things were fast.
But there was one test where Python was faster.
Analysis of the results and the code seemed to point the finger at Parrot&#39;s combined allocation and initialization.
This week Dan confessed that he was leaning towards separating the two because that would allow for a standard PCC call into the initialization code.
He pointed out that there were still a few issues,
but that appears to be the way he&#39;s thinking.</p>

<p><a href='http://groups.google.com/groups?selm=a06100500bca98610f2e6@[10.0.1.2]'>http://groups.google.com</a></p>

<h4><a name="Another_config_task">Another config task</a></h4>

<p>Dan pointed out that the current config scheme relies rather heavily on flags set in the current perl install,
which isn&#39;t ideal.
He suggested that people might like to look into making Parrot&#39;s config step rather less Perl dependent and pointed at things like &#39;metaconfig&#39;.</p>

<p><a href='http://groups.google.com/groups?selm=a06100509bcab3286d112@[10.0.1.2]'>http://groups.google.com</a></p>

<h4><a name="Problems_with_the_Perl_6_Compiler">Problems with the Perl 6 Compiler</a></h4>

<p>Allison Randal noted that <em lang='und' xml:lang='und'>languages/perl6/</em> was failing all its tests.
The issue arose because the Perl 6 test module inherits from Parrot::Test,
and Parrot::Test&#39;s behaviour got changed recently.
She wondered why the changes had been made.
After some discussion,
Allison provided a patch to make things work with the new Test module.</p>

<p><a href='http://groups.google.com/groups?selm=20040421071822.GA13915@shadowed.net'>http://groups.google.com</a></p>

<h4><a name="IMCC_temp_optimizations...">IMCC temp optimizations...</a></h4>

<p>Dan is possibly the only person using Parrot in a commercial (mission critical?) environment,
using a compiler from a legacy language to Parrot.
He&#39;s currently experiencing problems with IMCC taking a long time to compile the PIR generated by his compiler.
Apparently it&#39;s because he&#39;s using a lot of <code lang='und' xml:lang='und'>.local</code>s and temps.
He and Leo discussed it back and forth to try and find optimizations (both of IMCC and of Dan&#39;s compiler) for the issue.
(Dramatic) progress was made.</p>

<p><a href='http://groups.google.com/groups?selm=a06100502bcacaa698e2c@[172.24.18.98]'>http://groups.google.com</a></p>

<h4><a name="Korean_character_set_information">Korean character set information</a></h4>

<p>Last week,
Dan had wished he had access to anyone who knew anything about Korean.
This week kj provided some information.
The ensuing discussion of Unicode (again,
maybe I&#39;m going to have to extend my &#34;I don&#39;t cover the Unicode arguments&#34; policy from perl6&#45;language to the internals list too) led Jarkko Hietaniemi to propose that Parrot&#39;s standard character set be cuneiform,
with Phaistos disc symbols for variable names.</p>

<p>I think he was joking.</p>

<p><a href='http://groups.google.com/groups?selm=6C95D067&#45;93F0&#45;11D8&#45;BA46&#45;000393583E38@cpan.org'>http://groups.google.com</a></p>

<h4><a name="Containers_and_Values">Containers and Values</a></h4>

<p>The difference between containers and values cropped up again (for the first time in a while actually).
It got kicked off by a discussion of what</p>

<pre lang='und' xml:lang='und'>    my Joe $foo;
    $foo = 12; </pre>

<p>meant. It turns out that the <code lang='und' xml:lang='und'>my Joe $foo;</code> part sets up a lexical variable (called <code lang='und' xml:lang='und'>$foo</code>), which points to a container (in this case a Perl Scalar), which is constrained to contain either undef or a Joe objects. I believe it&#39;s somewhat open as to whether <code lang='und' xml:lang='und'>$foo = 12</code> is legal and, if it isn&#39;t, when the decision about the legality of the assignment would be made. Simon Cozens asked if the type declaration information went with the variable or the value and the answer was &#39;neither&#39;, it goes with the container that the variable points to. (Actually, that&#39;s not quite true, variables also know what type the containers they point to should be constrained to holding, otherwise</p>

<pre lang='und' xml:lang='und'>    my Dog $spot;
    my $feline = RSPCA.get_stray(Cat);
    $spot := $feline</pre>

<p>wouldn&#39;t throw an exception.) Dan noted that, right now, there is a &#39;muddled split&#39; between values and containers in Parrot, which may well come back to bite us in the future.</p>

<p><a href='http://groups.google.com/groups?selm=a06100510bcaebf236823@[10.0.1.2]'>http://groups.google.com</a></p>

<h4><a name="Dan_Does_Unicode">Dan Does Unicode</a></h4>

<p>After struggling manfully against the slings and arrows of outrageous text representations, Dan finally choked down the Unicode bolus and declared Unicode the &#34;One True Character String Encoding Set Stuff Thingie&#34;. Not long after this he posted the shiny new, all Unicode, all the time (ahem) strings design document.</p>

<p><a href='http://groups.google.com/groups?selm=a0610050fbcae19ec1dcd@[10.0.1.2]'>http://groups.google.com</a></p>

<p><a href='http://groups.google.com/groups?selm=a06100505bcaf3db4412b@[172.24.18.98]'>http://groups.google.com</a></p>

<h3><a name="Meanwhile,_in_perl6&#45;language">Meanwhile, in perl6&#45;language</a></h3>

<h4><a name="Backticks">Backticks</a></h4>

<p>Last week&#39;s thread rumbled on. Larry eventually made a ruling in favour of <i>not</i> using <code lang='und' xml:lang='und'>`</code> as an operator. He mentioned that the current backticks behaviour &#39;probably needs to be completely rethought anyway&#39;, and promised to cover it in a future Apocalypse. This didn&#39;t stop Austin Hastings speculating, but a p6l without Austin speculating wouldn&#39;t be the p6l we all know and love.</p>

<p><a href='http://groups.google.com/groups?selm=20040420175551.GA16162@wall.org'>http://groups.google.com</a></p>

<h4><a name="Spaces_in_method_calls">Spaces in method calls</a></h4>

<p>Late last week, Abhijit A Mahabal had wondered about one of the examples of using method calls without brackets given in Apocalypse 12. In particular, he wondered why</p>

<pre lang='und' xml:lang='und'>    $obj.method ($x + $y) + $z</pre>

<p>was equivalent to</p>

<pre lang='und' xml:lang='und'>    $obj.method(($x + $y) + $z) </pre>

<p>rather than</p>

<pre lang='und' xml:lang='und'>    $obj.method($x + $y) + $z</pre>

<p>Larry was forthcoming with an explanation. He hoped it would be possible to unambiguously define what is ambiguous.</p>

<p><a href='http://groups.google.com/groups?selm=Pine.GSO.4.58.0404171300130.13070@prickly.cs.indiana.edu'>http://groups.google.com</a></p>

<h4><a name="Returning_from_Rules">Returning from Rules</a></h4>

<p>Luke Palmer noticed a common pattern in his grammar writing, where he did a great deal of assigning a value to $0. He proposed that <code lang='und' xml:lang='und'>&#60;{ some_thing() }&#62;</code> be redefined to assign the result from the block to <code lang='und' xml:lang='und'>$0</code>. Warnock applies.</p>

<p><a href='http://groups.google.com/groups?selm=20040419070629.GA32185%luke@luqui.org'>http://groups.google.com</a></p>

<h4><a name="Hyper_mutating_methods">Hyper mutating methods</a></h4>

<p>Matthew Walton wondered if the new <code lang='und' xml:lang='und'>@things&#187;.method()</code> hyperized method syntax also worked with mutating methods (<code lang='und' xml:lang='und'>@things&#187;.=method()</code>). Answer: Yes.</p>

<p><a href='http://groups.google.com/groups?selm=40839579.6020501@alledora.co.uk'>http://groups.google.com</a></p>

<h4><a name="Placeholder_attachment">Placeholder attachment</a></h4>

<p>Trey Harris asked for an explanation of placeholder attachment. Being the gentleman he so obviously is, he even came up with a few thorny examples. Larry answered that the rule of placeholders is simple: Placeholders bind to the most closely surrounding closure. That is all. If you want anything more complicated then arrow blocks (<code lang='und' xml:lang='und'>-&#62; $a, $b, $c { ... }</code>) are what you should be using.</p>

<p><a href='http://groups.google.com/groups?selm=20040418121909.U45731@bowser.eecs.harvard.edu'>http://groups.google.com</a></p>

<h4><a name="Lvalue_methods">Lvalue methods</a></h4>

<p>John Siracusa is after a neat way of overriding the assignment side of an <code lang='und' xml:lang='und'>is rw</code> attribute. Various proposals were batted about, including using a different metaclass. Larry insisted that the <code lang='und' xml:lang='und'>$obj.foo($value)</code> was the wrong way of doing what <code lang='und' xml:lang='und'>$obj.foo = $value</code> does in A12 and repeated his reasoning for this. It looks like John was reasonably happy with the &#39;different metaclass&#39; approach though.</p>

<p><a href='http://groups.google.com/groups?selm=041920042047.19015.40843AE60007FF9E00004A472200734076FF8D9E9898969DD19ED1948D9E@comcast.net'>http://groups.google.com/</a></p>

<h4><a name="Required_Named_Parameters_Strike_Back">Required Named Parameters Strike Back</a></h4>

<p>Way back in the mists of time, John Siracusa had argued forcefully for required named parameters; required arguments to a function (or method) that must be supplied as pairs rather than positionally. Apocalypse 12 gave him some grist for this particular mill and he reopened the discussion with a long recap and extension of his argument.</p>

<p>Larry&#39;s response is a masterpiece of conciseness:</p>

<pre lang='und' xml:lang='und'>   Well, actually, we saved you last summer when we decided to make +
   mean that the parameter must be named.</pre>

<p>Discussion continued after this of course, but it was mostly concerned with making sure things worked as expected.</p>

<p><a href='http://groups.google.com/groups?selm=BCA98151.8DF37%siracusa@mindspring.com'>http://groups.google.com</a></p>

<h4><a name="Conflicting_Attributes_in_Roles">Conflicting Attributes in Roles</a></h4>

<p>Jonathan Lang appeared to be shooting for the most cryptic question of the week award when he simply posted a chunk of code. Austin thought he understood it and essayed an answer. The resulting thread generated all sorts of interesting stuff. Which is odd, because on rereading Jonathan&#39;s original post, I don&#39;t think the code he wrote does what he thinks it does.</p>

<p><a href='http://groups.google.com/groups?selm=20040421073558.43637.qmail@web40809.mail.yahoo.com'>http://groups.google.com</a></p>

<h4><a name="Syntax_to_call_attributes.">Syntax to call attributes.</a></h4>

<p>Jonathan Lang also wondered what the syntax was for accessing a list attribute from a scalar object. Answer: The same was as you would access any other attribute of that object; by calling a sigil free method. (Which seems to imply that you either can&#39;t have all of <code lang='und' xml:lang='und'>$.foo</code>, <code lang='und' xml:lang='und'>@.foo</code> and <code lang='und' xml:lang='und'>%.foo</code> as attributes in the same class. Which in turn looks like plain common sense to me.)</p>

<p><a href='http://groups.google.com/groups?selm=20040421074613.14250.qmail@web40807.mail.yahoo.com'>http://groups.google.com</a></p>

<h4><a name="Lower_case_magic_methods?">Lower case magic methods?</a></h4>

<p>Aldo Calpini worried that &#39;implicit&#39; methods like <code lang='und' xml:lang='und'>meta</code>, <code lang='und' xml:lang='und'>dispatch</code>, etc seem to break the rule that implicit things get UPPER CASE (and some of the implicit methods have names that a programmer might want for something else &#45;&#45; especially <code lang='und' xml:lang='und'>dispatch</code>). Larry confessed that the names were chosen for the very strong reason that he &#34;hadn&#39;t thought about the issue yet&#34;. He went on to discuss things that go into the Apocalypses as &#39;placeholders&#39; &#45;&#45; he knows that more design is needed, and there wants to be <i>something</i> there, but he hasn&#39;t necessarily got the name right yet. He went on to make like a disabled octopus, offering six hands worth of reasons for choosing different rules for naming the various structural methods. No decision yet, but now we know that Larry&#39;s thinking about it...</p>

<p><a href='http://groups.google.com/groups?selm=1082708715.7321.165.camel@localhost'>http://groups.google.com</a></p>

<h4><a name="Subtypes_that_lack_methods_or_roles">Subtypes that lack methods or roles</a></h4>

<p>Jonathan Lang wanted to know how to declare a &#34;subtype of a class which messes with the dispatching mechanism to exclude certain methods and/or roles from it&#34;. I want to know whether the class he&#39;s subtyping is the one that messes with the dispatching, of if the new class is the one that does the messing. I appear not to have been the only one confused by the question: Larry asked Jonathan for some sample code, which he did. Only to have the underlying design criticised by Dov Wasserman and chromatic, who argued that what Jonathan was asking how to do was exactly the thing that Roles were designed to avoid in the first place by pulling orthogonal behaviour out into roles and then composing them in classes.</p>

<p><a href='http://groups.google.com/groups?selm=20040423220723.74937.qmail@web40802.mail.yahoo.com'>http://groups.google.com</a></p>

<h4><a name="Delegation_using_arrays">Delegation using arrays</a></h4>

<p>Austin Hastings voiced his misgivings about the A12 magic for delegating to an array attribute. After a short discussion with Larry, a light went on over Austin&#39;s head.</p>

<p><a href='http://groups.google.com/groups?selm=ICELKKFHGNOHCNCCCBKFCEPBCLAA.Austin_Hastings@Yahoo.com'>http://groups.google.com</a></p>

<h4><a name="Typed_undef">Typed undef</a></h4>

<p>Austin Hastings had a few things to say about typed undefs (the things that get made when you do <code lang='und' xml:lang='und'>my Dog $spot</code>), he liked the idea of being able to call class methods on a typed undef for instance. The thread went on to discuss other tricks with flavoured undefs, like undefs that contain unthrown exceptions so that, when someone finally checks their return value, they can examine the exception to find out what it was that failed in the first place.</p>

<p><a href='http://groups.google.com/groups?selm=ICELKKFHGNOHCNCCCBKFGEPCCLAA.Austin_Hastings@Yahoo.com'>http://groups.google.com</a></p>

<h4><a name="Universal_Exports">Universal Exports</a></h4>

<p>Aaron Sherman had questions about the new export syntax discussed at the end of A12. In particular, he wondered how he&#39;d go about reexporting a symbol that a module imports from somewhere else. Discussion and sketchy design occurred in the ensuing thread.</p>

<p><a href='http://groups.google.com/groups?selm=1082757015.2899.589.camel@pps'>http://groups.google.com</a></p>

<h4><a name="MethodMaker_techniques_in_Perl_6">MethodMaker techniques in Perl 6</a></h4>

<p>John Siracusa wondered how he&#39;d go about writing a Class::MethodMaker equivalent in Perl6. (Personally, I&#39;d roll my own subclass of Class and MetaClass). Discussion followed, but I don&#39;t think they came up with any implementation techniques yet.</p>

<p><a href='http://groups.google.com/groups?selm=1082909712.21945.1516.camel@localhost.localdomain'>http://groups.google.com</a></p>

<h3><a name="Announcements,_Acknowledgements,_Apologies">Announcements, Acknowledgements, Apologies</a></h3>

<p>I&#39;m sorry, but there&#39;s no announcements this week.</p>

<p>If you find these summaries useful or enjoyable, please consider contributing to the Perl Foundation to help support the development of Perl. You might also like to send me feedback at <a href='mailto:pdcawley@bofh.org.uk'>mailto:pdcawley@bofh.org.uk</a></p>

<p><a href='http://donate.perl&#45;foundation.org/'>http://donate.perl&#45;foundation.org/</a> -- The Perl Foundation</p>

<p><a href='http://dev.perl.org/perl6/'>http://dev.perl.org/perl6/</a> -- Perl 6 Development site</p>

        </div>



    </div>
    <div class="asset-footer"></div>
</div>


                            
                            <div id="entry-916" class="entry-asset asset hentry">
    <div class="asset-header">
        <h2 class="asset-name entry-title"><a href="/pub/2004/04/29/maypole.html" rel="bookmark">Rapid Web Application Deployment with Maypole : Part 2</a></h2>
        <div class="asset-meta">
            <span class="byline">
    
                By <span class="vcard author">Simon Cozens</span> on <abbr class="published" title="2004-04-29T00:00:00-08:00">April 29, 2004 12:00 AM</abbr>
    
            </span>

            
            

        </div>
    </div>
    <div class="asset-content entry-content">

        <div class="asset-body">
            
<!-- sidebar begins -->
<!-- don't move sidebars -->
<!-- sidebar ends -->

<p>When we <a href="/pub/a/2004/04/15/maypole.html">last</a> left our intrepid web developer,
he had successfully set up an online sales catalogue in 11 lines of code.
Now,
however,
he has to move on to turning this into a sales site with a shopping cart and all the usual trimmings.
It's time to see some of that flexibility we talked about last week; unfortunately this means we're going to have to write some more code,
but we can't have everything.</p>

<h3><a name="Who_Am_I?">Who Am I?</a></h3>

<p>In order to add the shopping cart to the site,
we need to introduce the concept of a current user.
This will allow viewers of the site to log in and have their own cart.
We will be adding two new tables to the database,
a table to store details about the user, and one to represent the cart.
Our tables will look like so:</p>

<pre><code>  CREATE TABLE user (
    id int not null auto_increment primary key,
    first_name varchar(64),
    last_name varchar(64),
    email varchar(255),
    password varchar(64),
    address1 varchar(255),
    address2 varchar(255),
    state varchar(255),
    postal_code varchar(64),
    country varchar(64)
  );
  
  CREATE TABLE cart_item (
    id int not null auto_increment primary key,
    user int,
    item int
  );</code></pre>

<p>As before, Maypole automatically creates classes for the tables. We use <code>Class::DBI</code> relationships to tell Maypole what's going on with these tables:</p>

<pre><code>  ISellIt::User-&gt;has_many( &quot;cart_items&quot; =&gt; &quot;ISellIt::BasketItem&quot;);
  ISellIt::BasketItem-&gt;has_a( &quot;user&quot; =&gt; &quot;ISellit::User&quot; );
  ISellIt::BasketItem-&gt;has_a( &quot;item&quot; =&gt; &quot;ISellit::Product&quot; );</code></pre>

<p>We now need a way to tell our application about the current user.
There's a long explanation of Maypole's authentication system in
the
<a href="http://maypole.simon-cozens.org/doc/authentication.html">Maypole documentation</a>,
but one of the easiest ways to do add the concept of the current user is
with the <code>Maypole::Authentication::UserSessionCookie</code>
module.</p>

<p>As its name implies, this module takes care of associating a user with a session, and issuing a cookie to the user's browser. It also manages validating the user's login credentials, by default by looking up the user name and password in a database table; precisely what we need!</p>

<p>Maypole provides an authentication method for us to override, and it's here that we're going to intercept any request that requires a user -- viewing the shopping cart, adding items to an order, and so on:</p>

<pre><code>  sub authenticate {
    my ($self, $r) = @_;
    unless ($r-&gt;{table} eq &quot;cart&quot; or $r-&gt;{action} eq &quot;buy&quot;) {
      return OK;
    }

    # Else we need a user
    $r-&gt;get_user;
    if (!$r-&gt;{user}) {
      $r-&gt;template(&quot;login&quot;);
    }
    return OK;
   }</code></pre>

<p>The <code>get_user</code> method, which does all the work of setting the cookie and setting the credentials, is provided by the <code>UserSessionCookie</code> module. The only thing we need to tell it is that we're going to use the user's email address and password as login credentials, rather than some arbitrary user name. We can do this in the configuration for our application, as described in the <code>UserSessionCookie</code> documentation:</p>

<pre><code>  ISellIt-&gt;{config}-&gt;{auth}-&gt;{user_field} = &quot;email&quot;;</code></pre>

<p>Next, we set up a login template, which will present the users with a
form to enter their credentials; there's one in the Maypole manual,
in the <a href="http://maypole.simon-cozens.org/doc/Request.html">Request
chapter</a>, which we can modify to suit our needs:</p>

<pre><code>  [% INCLUDE header %]

    &lt;h2&gt; You need to log in before buying anything &lt;/h2&gt;

  &lt;DIV class=&quot;login&quot;&gt;
  [% IF login_error %]
     &lt;FONT COLOR=&quot;#FF0000&quot;&gt; [% login_error %] &lt;/FONT&gt;
  [% END %]
    &lt;FORM ACTION=&quot;/[% request.path%]&quot; METHOD=&quot;post&quot;&gt;
  Email Address:
    &lt;INPUT TYPE=&quot;text&quot; NAME=&quot;email&quot;&gt; &lt;BR&gt;
  Password: &lt;INPUT TYPE=&quot;password&quot; NAME=&quot;password&quot;&gt; &lt;BR&gt;
  &lt;INPUT TYPE=&quot;submit&quot;&gt;
  &lt;/FORM&gt;
  &lt;/DIV&gt;</code></pre>

<p>And now logging in is sorted out; if a user presents the correct credentials, <code>get_user</code> will put the user's <code>ISellIt::User</code> object in the Maypole request object as <code>$r-&gt;{user}</code>, and the user's request will continue to where it was going.</p>

<p>Now, of course, since we have a user object we can play with, we can use the user's information in other contexts:</p>

<pre><code>  [% IF request.user %]
    &lt;DIV class=&quot;messages&quot;&gt;
    Welcome back, [% request.user.first_name %]!
    &lt;/DIV&gt;
  [% END %]</code></pre>

<p>Since we're going to be referring to the user a lot, we pass it to the template as an additional argument, <code>my</code>. Maypole has an open-ended &quot;hook&quot; method, <code>additional_data</code>, which is perfect for doing just this.</p>

<pre><code>  sub additional_data {
    my $r = shift;
    $r-&gt;{template_args}{my} = $r-&gt;{user};
  }</code></pre>

<p>We call it <code>my</code> so that we can say, for instance:</p>

<pre><code>    &lt;DIV class=&quot;messages&quot;&gt;
    Welcome back, [% my.first_name %]!
    &lt;/DIV&gt;</code></pre>

<p>So now we have a user. We can add a new action, <code>order</code>, to add an item to the user's shopping cart:</p>

<pre><code>  package ISellIt::Product;

  sub order :Exported {
    my ($self, $r, $product) = @_;
    $r-&gt;{user}-&gt;add_to_cart_items({ item =&gt; $product });
    $r-&gt;{template} = &quot;view&quot;;
  }</code></pre>

<p>This adds an entry in the <code>cart_item</code> table associating the item with the user, and then sends us back to viewing the item.</p>

<p>We've sent our user back shopping without an indication that we actually did add an item to his shopping cart; we can give such an indication by passing information into the template:</p>

<pre><code>  sub order :Exported {
    my ($self, $r, $product) = @_;
    $r-&gt;{user}-&gt;add_to_cart_items({ item =&gt; $product });
    $r-&gt;{template} = &quot;view&quot;;
    $r-&gt;{template_args}{bought} = 1;
  }</code></pre>

<p>And then displaying it:</p>

<pre><code>  [% IF bought %]
  &lt;DIV class=&quot;messages&quot;&gt;
    We've just added this item to your shopping cart. To complete
    your transaction, please &lt;A HREF=&quot;/user/view_cart&quot;&gt;view your
    cart&lt;/A&gt; and check out.
  &lt;/DIV&gt;
  [% END %]</code></pre>

<p>So now we need to allow the user to view a cart.</p>

<h3><a name="Displaying_the_Cart">Displaying the Cart</a></h3>

<p>This also turns out to be relatively easy -- most things in Maypole are -- involving an action on the user class. We need to fill our Maypole request object with the items in the user's cart:</p>

<pre><code>  package ISellIt::User;

  sub view_cart :Exported {
    my ($self, $r) = @_;
    $r-&gt;{objects} = [ $r-&gt;{user}-&gt;cart_items ];
  }</code></pre>

<p>And then we need to produce a <em lang='und' xml:lang='und'>user/view_cart</em> template that displays them:</p>

<pre><code>  [% PROCESS header %]

  &lt;h2&gt; Your Shopping Cart &lt;/h2&gt;

  &lt;TABLE&gt;
  &lt;TR&gt; &lt;TH&gt; Product &lt;/TH&gt; &lt;TH&gt; Price &lt;/TH&gt; &lt;/TR&gt;
  [% SET count = 0;
  FOR item = objects;
    SET count = count + 1;
    &quot;&lt;tr&quot;;
    ' class=&quot;alternate&quot;' IF count % 2;
    &quot;&gt;&quot;;
  %]
    &lt;TD&gt; [% item.product.name %] &lt;/TD&gt;
    &lt;TD&gt; [% item.product.price %] &lt;/TD&gt;
    &lt;TD&gt; 
      &lt;FORM ACTION=&quot;/cart_item/delete/[% item.id %]&quot;&gt;
      &lt;INPUT TYPE=&quot;submit&quot; VALUE=&quot;Remove from cart&quot;&gt;
      &lt;/FORM&gt;
    &lt;/TD&gt;
  &lt;/tr&gt;
  [% END %]
  &lt;/TABLE&gt;

  &lt;A HREF=&quot;/user/checkout&quot;&gt; Check out! &lt;/A&gt;</code></pre>

<p>Once again, the HTML isn't great, but it gives us something we can pass to the design people to style up nicely. Now on to checking out the cart...</p>














<h3><a name="Check_out">Check Out</a></h3>

<p>The hardest part about building an e-commerce application is interacting with the payment and credit-card fulfillment service. We'll use the <a href="http://search.cpan.org/perldoc?Business::OnlinePayment"><code>Business::OnlinePayment</code></a> module to handle that side of things, and handle the order fulfillment by simply sending an email.</p>

<p>The actual check-out page needs to collect credit card and delivery information, and so it doesn't actually need any objects; the only object we actually need is the <code>ISellIt::User</code>, and that was stashed away in the request object by the authentication routine. However, we do want to display the total cost. So to make things easier we'll add an action and compute this in Perl. We make the total cost a method on the user, so we can use this later:</p>

<pre><code>  package ISellIt::User;
  use List::Util qw(sum);
  sub basket_cost {
    my $self = shift;
    sum map { $_-&gt;item-&gt;price }
    $self-&gt;basket_items
  }</code></pre>

<p>And define <code>checkout</code> to add this total to our template:</p>

<pre><code>  sub checkout :Exported {
    my ($self, $r) = @_;
    $r-&gt;{template_args}{total_cost} = $r-&gt;{user}-&gt;basket_cost;
  }</code></pre>

<p>Now we write our <em lang='und' xml:lang='und'>user/checkout</em> template:</p>

<pre><code>  [% PROCESS header %]
  &lt;h2&gt; Check out &lt;/h2&gt;

  &lt;p&gt; Please enter your credit card and delivery details. &lt;/p&gt;

  &lt;form method=&quot;post&quot; action=&quot;https://www.isellit.com/user/do_checkout&quot;&gt;
    &lt;P&gt;
    First name: &lt;input name=&quot;first_name&quot; value=&quot;[% my.first_name %]&quot;&gt;&lt;BR&gt;
    Last name: &lt;input name=&quot;last_name&quot; value=&quot;[% my.last_name %]&quot;&gt;&lt;/P&gt;
    &lt;P&gt;
    Street address: &lt;input name=&quot;address&quot; value=&quot;[% my.address1 %]&quot;&gt;&lt;BR&gt;
    City: &lt;input name=&quot;city&quot; value=&quot;[% my.address2 %]&quot;&gt;&lt;BR&gt;
    State: &lt;input name=&quot;state&quot; value=&quot;[% my.state %]&quot;&gt;
    Zip: &lt;input name=&quot;zip&quot; value=&quot;[% my.postal_code %]&quot;&gt;
    &lt;/P&gt;

    &lt;P&gt;
    Card type: &lt;select name=&quot;type&quot;&gt;
      &lt;option&gt;Visa&lt;/option&gt;
      &lt;option&gt;Mastercard&lt;/option&gt;
      ...
    &lt;/select&gt;

    Card number: &lt;input name=&quot;card_number&quot;&gt; 
    Expiration: &lt;input name=&quot;expiration&quot;&gt; &lt;BR&gt;
    Total: $ [% total_price %]
    &lt;/P&gt;
    &lt;P&gt;
    Please click &lt;B&gt;once&lt;/B&gt; and wait for the payment to be
    authorised.... &lt;input type=&quot;submit&quot; value=&quot;order&quot;&gt;
  &lt;/form&gt;</code></pre>

<p>What happens when this data is sent to the <code>do_checkout</code> action? (Over SSL, you'll notice.) First of all, we'll check if the user has entered address details for the first time, and if so, store them in the database. Perhaps unnecessary in this day of browsers that auto-fill forms, but it's still a convenience. Maypole stores the POST'ed in parameters in <code>params</code>:</p>

<pre><code>  sub do_checkout :Exported {
    my ($self, $r) = @_;
    my %params = %{$r-&gt;{params}};
    my $user = $r-&gt;{user};

    $user-&gt;address1($params{address}) unless $user-&gt;address1;
    $user-&gt;address2($params{city})  unless $user-&gt;address2;
    $user-&gt;state($params{state})    unless $user-&gt;state;
    $user-&gt;postal_code($params{zip})  unless $user-&gt;postal_code;</code></pre>

<p>We need to construct a request to go out via <code>Business::OnlinePayment</code>; thankfully, the form parameters we've received are going to be precisely in the format that <code>OnlinePayment</code> wants, thanks to careful form design. All we need to do is to insert our account details and the total:</p>

<pre><code>    my $tx = new Business::OnlinePayment(&quot;TCLink&quot;);
    $tx-&gt;content(%params,
      type   =&gt; &quot;cc&quot;,
      login  =&gt; VENDOR_LOGIN,
      password =&gt; VENDOR_PASSWORD,
      action   =&gt; 'Normal Authorization'
      amount   =&gt; $r-&gt;{user}-&gt;basket_total
    );</code></pre>

<p>Now we can submit the payment and see what happens. If there's a problem, we add a message to the template and send the user back again:</p>

<pre><code>    $tx-&gt;submit;
    if (!$tx-&gt;is_success) {
      $r-&gt;{template_args}{message} = 
        &quot;There was a problem authorizing your transaction: &quot;.
        $tx-&gt;error_message;
      $r-&gt;{template} = &quot;checkout&quot;;
      return;
    }</code></pre>

<p>Otherwise, we have our money; we probably want to tell the box-shifters about it, or we lose customers fast:</p>

<pre><code>    fulfill_order(
      address_details =&gt; $r-&gt;{params},
      order_details   =&gt; [ map { $_-&gt;item } $r-&gt;{user}-&gt;cart_items ],
      cc_auth     =&gt; $tx-&gt;authorization
    );</code></pre>

<p>And now we empty the shopping cart, and send the user on his way:</p>

<pre><code>    $_-&gt;delete for $r-&gt;{user}-&gt;cart_items;
    $r-&gt;{template} = &quot;frontpage&quot;;
  }</code></pre>

<p>Done! We've taken a user from logging in, adding goods to the cart, credit card validation, and checkout. But... wait. How did we get our user in the first place?</p>

<h3><a name="Registering_a_User">Registering a User</a></h3>

<p>We have to find a way to sign a user up. This is actually not that
hard, particularly since we can use the example of <a
  href="http://search.cpan.org/~simon/Maypole/doc/Flox.pod">Flox</a> in the Maypole manual. First, we'll add a &quot;register&quot; link to our login template:</p>

<pre><code>  &lt;P&gt;New user? &lt;A HREF=&quot;/user/register&quot;&gt;Sign up!&lt;/A&gt;&lt;/P&gt;</code></pre>

<p>This page doesn't require any objects to be loaded up, since it's just going to display a registration form; we can just add our template in <em lang='und' xml:lang='und'>/user/register</em>:</p>

<pre><code>  [% INCLUDE header %]
  &lt;P&gt;Welcome to buying with iSellIt!&lt;/P&gt;

  &lt;P&gt;To set up your account, we only need a few details from you:
  &lt;/P&gt;

  &lt;FORM METHOD=&quot;POST&quot; ACTION=&quot;/user/do_register&quot;&gt;
    &lt;P&gt;Your name:
    &lt;input name=&quot;first_name&quot;&gt; 
    &lt;input name=&quot;last_name&quot;&gt; &lt;/P&gt;
    &lt;P&gt;Your email address: &lt;input name=&quot;email&quot;&gt; &lt;/P&gt;
    &lt;P&gt;Please choose a password: &lt;input name=&quot;password&quot;&gt; &lt;/P&gt;
    &lt;input type=&quot;submit&quot; name=&quot;Register&quot; value=&quot;Register&quot;&gt;
  &lt;/FORM&gt;</code></pre>

<p>As before, we need to explain to <a href="http://search.cpan.org/perldoc?Class::DBI::FromCGI"><code>Class::DBI::FromCGI</code></a> how these fields are to be edited:</p>

<pre><code>  ISellIt::User-&gt;untaint_columns(
    printable =&gt; [qw/first_name last_name password/],
    email   =&gt; [qw/email/],
  );</code></pre>

<p>And now we can write our <code>do_register</code> event, using the <code>FromCGI</code> style:</p>

<pre><code>  sub do_register :Exported {
    my ($self, $r) = @_;
    my $h = CGI::Untaint-&gt;new(%{$r-&gt;{params}});
    my $user = $self-&gt;create_from_cgi($h);</code></pre>

<p>If there were any problems, we send them back to the register form again:</p>

<pre><code>    if (my %errors = $obj-&gt;cgi_update_errors) {
      $r-&gt;{template_args}{cgi_params} = $r-&gt;{params};
      $r-&gt;{template_args}{errors} = \%errors;
      $r-&gt;{template} = &quot;register&quot;;
      return;
    }</code></pre>

<p>Otherwise, we now have a user; we need to issue the cookie as if the user had logged in normally. Again, this is something that <code>UserSessionCookie</code> looks after for us:</p>

<pre><code>    $r-&gt;{user} = $user;
    $r-&gt;login_user($user-&gt;id);</code></pre>

<p>And finally we send the user on his or her way again:</p>

<pre><code>    $r-&gt;{template} = &quot;frontpage&quot;;
  }</code></pre>

<p>There we go: now we can create new users; provision of a password reminder function is an exercise for the interested reader.</p>

<h3><a name="Maypole_Summary">Maypole Summary</a></h3>

<p>We've done it -- we've created an e-commerce store in a very short space of time and with a minimal amount of code. One of the things that I like about Maypole is the extent to which you only need to code your business logic; all of the display templates can be mocked up and then shipped off to professionals, and the rest of the work is just handled magically behind the scenes by Maypole.</p>

<p>Thanks to the TPF funding of Maypole, we now have an extensive user manual with several case studies (this one included), and a lively user and developer community. I hope you too will be joining it soon!</p>





        </div>



    </div>
    <div class="asset-footer"></div>
</div>


                            
                            <div id="entry-920" class="entry-asset asset hentry">
    <div class="asset-header">
        <h2 class="asset-name entry-title"><a href="/pub/2004/04/p6pdigest/20040418.html" rel="bookmark">This Fortnight on Perl 6, Weeks Ending 2004-04-18</a></h2>
        <div class="asset-meta">
            <span class="byline">
    
                By <span class="vcard author">Piers Cawley</span> on <abbr class="published" title="2004-04-22T00:00:00-08:00">April 22, 2004 12:00 AM</abbr>
    
            </span>

            
            

        </div>
    </div>
    <div class="asset-content entry-content">

        <div class="asset-body">
            
<!-- sidebar begins -->
<!-- don't move sidebars -->
<!-- sidebar ends -->

<p>The only problem with summarizing two week&#39;s worth of Perl 6 happenings is that there&#39;s twice as much stuff to summarize.
Still, there&#39;s no way I could have made the time to write a summary last week so I&#39;ll take my lumps.
I am exceedingly grateful that Apocalypse 12 (Objects) wasn&#39;t released the Thursday <i>before</i> Easter though,
as now I can clear the decks for the expected perl6&#45;language explosion next week.</p>

<p>We&#39;ll start with perl6&#45;internals as usual.</p>


<h2>Initializers, Finalizers and Fallbacks</h2>

<p>There was some discussion of the various functions that get called by object initialization/destruction, and so on.
Dan wondered what he&#39;d been thinking when he declared that there would be distinct <code lang='und' xml:lang='und'>FINALIZE</code>,
<code lang='und' xml:lang='und'>DELETE</code>, and <code lang='und' xml:lang='und'>CLEANUP</code> properties. (Instead of declaring that a function must be called, say, <code lang='und' xml:lang='und'>FINALIZE</code>,
you can mark any function with a <code lang='und' xml:lang='und'>FINALIZE</code> property,
and Parrot will recognize that as the function to call at finalization time).
Andy Wardley quibbled about American/British spelling,
but Tim Bunce pointed out that the &#39;ize&#39; form is preferred by the <i>Oxford English Dictionary</i> (and your humble summarizer).</p>

<p>Leo, meanwhile, made a (Warnocked) proposal for a new init scheme.</p>

<p><a href='http://groups.google.com/groups?selm=a06010207bc988256b491@[172.24.18.98]'>http://groups.google.com/groups?selm=a06010207bc988256b491@[172.24.18.98]</a></p>

<p><a href='http://groups.google.com/groups?selm=200404060833.i368Xou16545@thu8.leo.home'>http://groups.google.com/groups?selm=200404060833.i368Xou16545@thu8.leo.home</a></p>


<h2>New SDL Parrot Bindings</h2>

<p>Taking advantage of Parrot&#39;s new,
improved object system,
chromatic updated us all on his efforts to provide a shiny OO interface to the SDL library.
Jens Rieks wondered about chromatic&#39;s implementation choices,
and posted a few suggestions and questions.
Dan reckoned he&#39;d prefer it if the SDL bindings used Parrots internal events systems.
The catch being that Parrot doesn&#39;t actually have an internal events system yet...</p>

<p>Later in the fortnight,
chromatic posted an initial release and promised to post his notes and slides from the Portland Perl Mongers meeting where he was showing it off.
There&#39;s no sign of &#39;em yet though.</p>

<p><a href='http://groups.google.com/groups?selm=1081225995.12079.27.camel@localhost'>http://groups.google.com/groups?selm=1081225995.12079.27.camel@localhost</a></p>

<p><a href='http://groups.google.com/groups?selm=1081317984.19190.2.camel@localhost'>http://groups.google.com/groups?selm=1081317984.19190.2.camel@localhost</a></p>


<h2><a name="new_method"
><code lang='und' xml:lang='und'>new</code> Method</a></h2>

<p>Jens Rieks and chromatic were unsure of the best name for a constructor method.
They&#39;d like to be able to write a method called <code lang='und' xml:lang='und'>new</code>,
but IMCC wouldn&#39;t allow it.
Leo T&#246;tsch pointed out that there&#39;s already a default constructor method: <code lang='und' xml:lang='und'>__init</code>.
However,
chromatic wasn&#39;t too keen on it because he wanted to be able to pass arguments to the constructor.
Leo pointed out that,
although it wasn&#39;t officially supported,
you could pass arguments in the same was as if you were making a normal parrot function call.</p>

<p>Dan pointed out that our current initialization system is some way from being the final one (which will use properties to mark constructor methods).
What we have now is more like an allocator than a real constructor.</p>

<p><a href='http://groups.google.com/groups?selm=200404041830.09293.parrot@jensbeimsurfen.de'>http://groups.google.com/groups?selm=200404041830.09293.parrot@jensbeimsurfen.de</a></p>


<h2>Overriding <code lang='und' xml:lang='und'>__find_method</code> in PASM?</h2>

<p>Noting that,
according to PDD15,
defining a method called __find_method should allow Perl 5 AUTOLOAD&#45;like behavior,
chromatic wondered if it was workable yet and,
if it wasn&#39;t,
how he should go about adding it.
Leo confessed that what was in the docs was a cut and paste error and AUTOLOAD behavior hadn&#39;t yet been defined.
He suggested a workaround using exceptions (which turned out to be overkill for what chromatic needed,
but it looks interesting.)</p>

<p><a href='http://groups.google.com/groups?selm=1081138355.7995.26.camel@localhost'>http://groups.google.com/groups?selm=1081138355.7995.26.camel@localhost</a></p>


<h2>Language Interoperability</h2>

<p>Randy W.
Sims popped over from the Module&#45;Build mailing list,
where they&#39;ve been discussing plugin architectures to allow for the modification and extension of Module::Build&#39;s capabilities.
One of the desiderata is that,
once the transition to Parrot is underway,
it should be possible to write plugins in any language supported by Parrot.
(Mmm...
a build system written in Befunge,
it&#39;s what the world&#39;s been crying out for I tell you).
There are currently two competing schemes,
one involving manipulating the class hierarchy at runtime and the other involving plugins held in particular directories and a formal API.
Randy wondered if there were any technical reasons to choose one scheme or another.</p>

<p>Dan reckoned that there were no particular technical reasons,
but the inheritance based scheme rather offended his sensibilities,
going so far as to say &#34;No way in hell it&#39;ll ever make it in as parrot&#39;s standard module building system if you do it [the inheritance munging solution]&#34;.</p>

<p><a href='http://groups.google.com/groups?selm=406FDFAB.3050008@thepierianspring.org'>http://groups.google.com/groups?selm=406FDFAB.3050008@thepierianspring.org</a></p>


<h2>Save the Return Continuation!</h2>

<csperl file="grab" domain="on" record="b/940" template="b/article_sidebar.view">

<p>The ongoing discussion about continuations seems to be fizzling slightly.
Piers Cawley had proposed moving the return continuation out of P1 and held &#39;somewhere else&#39; (possibly the control stack) and then,
when a routine needed to do cunning things with the current continuation it could access it with some op (say <code lang='und' xml:lang='und'>get_current_cont</code>).
Dan reckoned he was okay with the idea,
and Luke Palmer voted in favor of a special RC register.
Dan asked for further discussion and the whole thing got tossed onto the horns of Warnock&#39;s Dilemma.</p>

<p><a href='http://groups.google.com/groups?selm=a06010205bc987b530fde@[172.24.18.98]'>http://groups.google.com/groups?selm=a06010205bc987b530fde@[172.24.18.98]</a></p>


<h2>Rounding Up Pending Objects</h2>

<p>Dan asked for a list of pending issues with objects so he could get things nailed down and finished so we could move on.
Jarkko Hietaniemi,
chromatic and Leo all chimed in with suggestions.</p>

<p><a href='http://groups.google.com/groups?selm=a06010206bc9880273177@[172.24.18.98]'>http://groups.google.com/groups?selm=a06010206bc9880273177@[172.24.18.98]</a></p>


<h2>Release the Streams!</h2>

<p>Jens Rieks posted a &#34;working version&#34; of his new Stream library,
promising more documentation later in the month.
Leo and Dan looked on it,
saw that it was good,
and granted Jens commit privileges.
Congratulations are in order.</p>

<p>Later,
Leo found some bugs around continuation and context handling and set about tracking it down.
(Jens had thought it was an issue with string handling.)</p>

<p><a href='http://groups.google.com/groups?selm=200404062141.12274.parrot@jensbeimsurfen.de'>http://groups.google.com/groups?selm=200404062141.12274.parrot@jensbeimsurfen.de</a></p>


<h2>Parrot Libraries</h2>

<p>Leo pointed out that we currently have two different places to find Parrot runtime stuff: <em lang='und' xml:lang='und'>runtime/parrot/*</em> and <em lang='und' xml:lang='und'>library/</em>.
He proposed we pick one,
add some support for handling library search paths,
work out a scheme to organize library paths and add some library tests.
Dan decided everything should go in <em lang='und' xml:lang='und'>runtime/parrot</em> and mused about handling library metadata.</p>

<p><a href='http://groups.google.com/groups?selm=4073A4CC.7010006@toetsch.at'>http://groups.google.com/groups?selm=4073A4CC.7010006@toetsch.at</a></p>


<h2>Splitting <em lang='und' xml:lang='und'>interpreter.c</em></h2>

<p>Apparently <em lang='und' xml:lang='und'>interpreter.c</em> runs to rather more than 2500 lines.
Leo proposed splitting it into multiple files.
Dan told him to go for it.</p>

<p><a href='http://groups.google.com/groups?selm=4073BAAC.5030806@toetsch.at'>http://groups.google.com/groups?selm=4073BAAC.5030806@toetsch.at</a></p>


<h2>Incorporating ICU</h2>

<p>I have a rule of thumb about Unicode: Nobody likes it.
Nor does anyone dislike it enough to come up with something better.</p>

<p>Jeff Clites dropped the list a line to let everyone know that he&#39;s still working on integrating the ICU Unicode library into Parrot.
(A thankless task if ever there was one.) With some encouragement from Dan he posted his (huge) patch.
After some debate,
Dan checked it in giving a baseline to start dealing with any issues.</p>

<p>Jeff explained the rationale of his approach (which I have to confess I skimmed,
I don&#39;t care how strings work,
so long as they work).
Jarkko liked it,
noting that other approaches lead &#34;into combinatorial explosion and instant insanity&#34;.
Jarkko went on to share his Unicode pain and generally back Jeff up in discussions with Leo.
If you&#39;re interested in the gory details of Unicode implementation,
I commend this thread to you.
Or you can just trust Jeff,
Jarkko,
Leo,
Larry and Dan to get it right (which is what I&#39;m doing).</p>

<p><a href='http://groups.google.com/groups?selm=CFB7F3BE&#45;88B8&#45;11D8&#45;ADF3&#45;000393A6B9DA@mac.com'>http://groups.google.com/groups?selm=CFB7F3BE&#45;88B8&#45;11D8&#45;ADF3&#45;000393A6B9DA@mac.com</a></p>

<p><a href='http://groups.google.com/groups?selm=612F0D93&#45;8A6A&#45;11D8&#45;ADF3&#45;000393A6B9DA@mac.com'>http://groups.google.com/groups?selm=612F0D93&#45;8A6A&#45;11D8&#45;ADF3&#45;000393A6B9DA@mac.com</a> &#45;&#45; Jeff&#39;s explanations</p>


<h2>Tracking JIT Down</h2>

<p>In another of his ongoing series of simple Perl tasks for the interested,
Dan asked for a script to generate a list of all the ops that aren&#39;t JITted (along with a few extra goodies that would be nice).
Stefan Lidman was the man with the script,
which was rapidly checked in.</p>

<p><a href='http://groups.google.com/groups?selm=a0610050ebc9a03e47738@[10.0.1.2]'>http://groups.google.com/groups?selm=a0610050ebc9a03e47738@[10.0.1.2]</a></p>


<h2>Diamond Inheritance Is Broken</h2>

<p>If you&#39;ve ever sung bass in choir you&#39;ll be aware that sometimes a bass line is sung on one note for rather a long time.
For the past two weeks perl6&#45;internals&#39; repetitive bass note has been the failure of test 17 in <em lang='und' xml:lang='und'>t/pmc/object&#45;meths.t</em>.
Should you find yourself building a CVS parrot and get caught by this,
please be aware that we know about the problem it&#39;s just Dan&#39;s suffering from a tuit shortage and there are other important strings he&#39;s concentrating on.</p>


<h2>New Libraries</h2>

<p>Jens &#34;The librarian&#34; Rieks released another set of libraries,
&#34;Data::Sort&#34;,
&#34;Data::Replace&#34; and &#34;Data::Escape&#34;.
Tim Bunce wasn&#39;t that keen on his choice of names (and indeed functionality).
The current front runners for new names for these are &#34;PMC::DeepReplace&#34;,
&#34;PMC::Printable&#34;,
&#34;PMC::Sort&#34; and &#34;PMC::Dumper&#34;.</p>

<p><a href='http://groups.google.com/groups?selm=200404082028.49211.parrot@jensbeimsurfen.de'>http://groups.google.com/groups?selm=200404082028.49211.parrot@jensbeimsurfen.de</a></p>


<h2>Attribute Questions</h2>

<p>Mark Sparshatt wondered how to handle class attributes,
with particular reference to implementing Ruby.
Dan reckons we&#39;ll get proper class attributes once he&#39;s sorted out metaclasses.
Mark muddied the water somewhat by pointing out that Ruby has two kinds of class attributes; ones that are hung off metaclasses and those that are (I think) held in the class namespace.
Annoyingly they have two distinct behaviors.</p>

<p><a href='http://groups.google.com/groups?selm=4075919F.30905@yahoo.co.uk'>http://groups.google.com/groups?selm=4075919F.30905@yahoo.co.uk</a></p>


<h2>Tcl PMCs</h2>

<p>Will Coleda posted his first cut at a set of PMCs to support TCL semantics.
He apparently had problems with the Array PMC&#39;s assumption that &#39;empty&#39; slots contained PerlUndefs,
which meant he had to implement a custom TclArray PMC.
For the rest of the thread Will and Leo worked out how to re&#45;jig the patch so the PMCs could be dynamically loaded before Leo checked it into the repository.</p>

<p><a href='http://groups.google.com/groups?selm=rt&#45;3.0.8&#45;28393&#45;84164.14.5997263059787@perl.org'>http://groups.google.com/groups?selm=rt&#45;3.0.8&#45;28393&#45;84164.14.5997263059787@perl.org</a></p>















<h2>Parrot Everywhere</h2>

<p>I&#39;ve not really mentioned his work in recent summaries,
but Marcus Thiesen has been doing sterling work helping to get Parrot up and running on a bewildering variety of systems.
Thanks for the sterling work Marcus.</p>

<p><a href='http://www.luusa.org/~marcus/parrottest'>http://www.luusa.org/~marcus/parrottest</a> &#45;&#45; Marcus&#39;s Smoker</p>


<h2>Warnocked</h2>

<p>Bryan C.
Warnock posted a patch to Parrot&#39;s <em lang='und' xml:lang='und'>CREDITS</em>,
correcting a long defunct email address.
You might enjoy the patch:</p>

<pre lang='und' xml:lang='und'>    N: Bryan C. Warnock
   +D: Little things here and there in pre&#45;Parrot days.
   +D: And, yes, {sigh}, *that* Warnock.
   +E: bwarnock@raba.com</pre>

<p>He&#39;s too modest of course, Bryan started off writing the Perl 6 Summaries. When he stopped doing them due (I presume) to a lack of time, I missed them so much I started writing my own. So don&#39;t blame me for these, blame Bryan.</p>

<p>Rather appropriately, nobody commented on the patch.</p>

<p><a href='http://groups.google.com/groups?selm=rt&#45;3.0.8&#45;28383&#45;84147.3.00438339593441@perl.org'>http://groups.google.com/groups?selm=rt&#45;3.0.8&#45;28383&#45;84147.3.00438339593441@perl.org</a></p>


<h2>Unicode Step By Step</h2>

<p>Leo T&#246;tsch posted a quick overview of steps to get Unicode support into Parrot. Right now, if you turn Unicode on, your (at least) first build is going to take a looong time.</p>

<p>Debate centered on whether or not the Parrot distribution should include the full ICU distribution. (It&#39;s looking like a qualified yes, but we will attempt to use an existing installation of ICU if we can find it.)</p>

<p><a href='http://groups.google.com/groups?selm=4077F315.6060200@toetsch.at'>http://groups.google.com/groups?selm=4077F315.6060200@toetsch.at</a></p>


<h2>Disappearing PASM Files in the Test Directory</h2>

<p>Leo wondered what had happened to the generated .pasm files in <em lang='und' xml:lang='und'>t/*/</em> (he wasn&#39;t alone in this, but he was the person who posted). Will Coleda confessed that he&#39;d doctored Parrot::Test so that they ended up in <em lang='und' xml:lang='und'>/tmp</em> (probably). He didn&#39;t say why.</p>

<p><a href='http://groups.google.com/groups?selm=4077EC4D.3040806@toetsch.at'>http://groups.google.com/groups?selm=4077EC4D.3040806@toetsch.at</a></p>


<h2>ICU Build Pains</h2>

<p>I don&#39;t normally discuss issues people have with building Parrot on various different machines either (the threads usually die out quite quickly: &#34;Did you do this?&#34; &#34;Oh! Thanks, that worked.&#34;) but the ICU check in seems to have caused no small amount of pain on Linux systems for some reason.</p>

<p>Alberto Manuel Brandao Simoes posted an error log for a failing build. Jeff Clites, our Guru of ICU set about helping him to track the problem down with incomplete success. Dan pointed everyone at Debian&#39;s patches to get ICU to build, and suggested that people wait for his patch to allow the use of an existing ICU installation.</p>

<p>Various other threads continued the discussion, at the end of which Dan had checked in a patch that seemed to solve the problems.</p>

<p><a href='http://groups.google.com/groups?selm=40784BF0.20608@alfarrabio.di.uminho.pt'>http://groups.google.com/groups?selm=40784BF0.20608@alfarrabio.di.uminho.pt</a></p>

<p><a href='http://groups.google.com/groups?selm=a06100503bca05b379e6f@[10.0.1.2]'>http://groups.google.com/groups?selm=a06100503bca05b379e6f@[10.0.1.2]</a></p>

<p><a href='http://groups.google.com/groups?selm=a06100505bca05f409099@[10.0.1.2]'>http://groups.google.com/groups?selm=a06100505bca05f409099@[10.0.1.2]</a></p>


<h2>Tangled Strings</h2>

<p>Dan posted the beginnings of his plan for how strings are going to work in Parrot. On the face of it, not a contentious issue. However, strings are text, and text is a human cultural artifact, which means there&#39;s politics and really, really, really ugly complexities to deal with if you want to Do It Right (assuming you can decide what Right is). There was much discussion. And then there was some more. The trouble is, this stuff is Important (and it&#39;s very important that we get it right *before* we start implementing the matching engine, otherwise some of the assumptions it might make about how fast various string manipulations are might turn out to be very wrong indeed...) and Hard. Because it&#39;s Hard it&#39;s rather tricky to summarize, so I&#39;m going to punt and just give you the root message.</p>

<p><a href='http://groups.google.com/groups?selm=a06100500bca0384ce81c@[10.0.1.2]'>http://groups.google.com/groups?selm=a06100500bca0384ce81c@[10.0.1.2]</a></p>


<h2>Basic Library Paths</h2>

<p>Dan finally got &#39;round to designing how Parrot was going to handle searching for libraries and such. Oh, and he and Jarkko engaged in some unseemly bragging about VMS which has had all this stuff fixed for ages. There was a fair bit of discussion, but the response was generally positive.</p>

<p><a href='http://groups.google.com/groups?selm=a06100500bca449931036@[10.0.1.2]'>http://groups.google.com/groups?selm=a06100500bca449931036@[10.0.1.2]</a></p>


<h2>Alternative Object Initializer Calling Scheme</h2>

<p>Leo announced that he&#39;d added a new, property based scheme for object initialization. Instead of initializing an object automagically with the <code lang='und' xml:lang='und'>__init</code> method, you mark any method with the <code lang='und' xml:lang='und'>BUILD</code> property and Parrot handles calling it for you. You do have to set the <code lang='und' xml:lang='und'>CALL__BUILD</code> environment variable before starting Parrot to make use of it though.</p>

<p><a href='http://groups.google.com/groups?selm=40768F70.1010106@toetsch.at'>http://groups.google.com/groups?selm=40768F70.1010106@toetsch.at</a></p>


<h2>Joseph H&#246;&#246;k Is Back</h2>

<p>Long time no see Joseph.</p>

<p><a href='http://groups.google.com/groups?selm=381&#45;220044011141848685@kth.se'>http://groups.google.com/groups?selm=381&#45;220044011141848685@kth.se</a></p>


<h2>Version Bump Time?</h2>

<p>Dan suggested that, once the ICU patch is properly nailed down, it could be time to start the push to a 0.1.1 (or even 0.2.0) release.</p>

<p><a href='http://groups.google.com/groups?selm=a06100502bc9cbc80e445@[172.24.18.98]'>http://groups.google.com/groups?selm=a06100502bc9cbc80e445@[172.24.18.98]</a></p>


<h2>Lies, Damned Lies, and Benchmarks</h2>

<p>Leo posted a set of benchmark timings for the OO examples when run with all current optimizations. The numbers are looking rather good: Parrot&#39;s faster than everything on all but one test, where it&#39;s outperformed by Python. Of course, these aren&#39;t the benchmarks that&#39;ll determine whether Dan gets a Pie at OSCON...</p>

<p><a href='http://groups.google.com/groups?selm=408009CE.2070804@toetsch.at'>http://groups.google.com/groups?selm=408009CE.2070804@toetsch.at</a></p>


<h2>PMC Constants</h2>

<p>Leo asked for comments on a proposal for dealing with PMC constants. No comments so far.</p>

<p><a href='http://groups.google.com/groups?selm=407FF01A.2080102@toetsch.at'>http://groups.google.com/groups?selm=407FF01A.2080102@toetsch.at</a></p>


<p><b>Meanwhile, in perl6&#45;language...</b></p>


<h2>Backticks</h2>

<p>A proposal for a new use of backticks was made (because the proposer didn&#39;t think the current semantics deserved their privileged place in the language&#39;s Huffman table). Some people disagreed. Some people disagreed rather strongly. Toys were thrown out of prams. People called each other narrow minded. It wasn&#39;t pretty. With any luck people are going to calm down, apologize to each other for getting so aerated over something so trivial, and the list can settle down to the more rewarding task of dealing with the implications of Apocalypse 12.</p>

<p><a href='http://groups.google.com/groups?selm=20040414121848.GJ3645@c4.convolution.nl'>http://groups.google.com/groups?selm=20040414121848.GJ3645@c4.convolution.nl</a></p>


<h2>Compatibility with Perl 5</h2>

<p>Dave Cantrell wondered how Perl 6 would spot legacy code. Everyone forgot to refer him to the appropriate section of Apocalypse 1 in which Larry lays down the two rules:</p>

<ul>
<li>Files that are pulled in with <code lang='und' xml:lang='und'>require</code> etc will be deemed to be Perl 6 unless they contain a <code lang='und' xml:lang='und'>package</code> declaration.</li><p class="pad"></p>
<li>Files that are run as scripts (<code lang='und' xml:lang='und'>perl some_script.pl</code>) are treated as Perl 5 unless it&#39;s obviously Perl 6. The proposed way of making this obvious would be to begin the script with <code lang='und' xml:lang='und'>module Main</code>.</li><p class="pad"></p>
</ul>

<p>Easy eh? It didn&#39;t stop the thread running and running though (not helped by someone getting the rules of thumb rather badly wrong in the early stages).</p>

<p><a href='http://groups.google.com/groups?selm=20040413121602.GA5213@bytemark.barnyard.co.uk'>http://groups.google.com/groups?selm=20040413121602.GA5213@bytemark.barnyard.co.uk</a></p>


<h2>Oooh, Look, It&#39;s an Apocalypse</h2>

<p>Apocalypse 12 finally stepped out of the drafty shadows into the glare of publicity. It&#39;s very long. I expect next week will be rather busy on p6l.</p>

<p><a href='http://www.perl.com/pub/a/2004/04/16/a12.html'>http://www.perl.com/pub/a/2004/04/16/a12.html</a></p>


<h2>And We&#39;re Done</h2>

<p>A reminder to everyone on perl6&#45;language: Play nice.</p>

<p>If you find these summaries useful or enjoyable, please consider contributing to the Perl Foundation to help support the development of Perl. You might also like to send me feedback at <a href='mailto:p6summarizer@bofh.org.uk'>mailto:p6summarizer@bofh.org.uk</a>.</p>

<p><a href='http://donate.perl&#45;foundation.org/'>http://donate.perl&#45;foundation.org/</a> &#45;&#45; The Perl Foundation</p>

<p><a href='http://dev.perl.org/perl6/'>http://dev.perl.org/perl6/</a> &#45;&#45; Perl 6 Development site</p>


        </div>



    </div>
    <div class="asset-footer"></div>
</div>


                            
                            <div id="entry-912" class="entry-asset asset hentry">
    <div class="asset-header">
        <h2 class="asset-name entry-title"><a href="/pub/2004/04/15/maypole.html" rel="bookmark">Rapid Web Application Deployment with Maypole</a></h2>
        <div class="asset-meta">
            <span class="byline">
    
                By <span class="vcard author">Simon Cozens</span> on <abbr class="published" title="2004-04-22T00:00:00-08:00">April 22, 2004 12:00 AM</abbr>
    
            </span>

            
            

        </div>
    </div>
    <div class="asset-content entry-content">

        <div class="asset-body">
            
<!-- sidebar begins -->
<!-- don't move sidebars -->
<!-- sidebar ends -->

<p>You have a database.
You have a web server.
You have a deadline.</p>

<p>Whether it&#39;s bringing up an e-commerce storefront for a new venture, implementing a new front-end to HR's employee database,
or even providing a neat way to track citations for U.S. English slang terms, it's always the same story -- and the deadline is always yesterday.</p>

<p>For this month of April,
I'm working on a Perl Foundation sponsorship to develop a project of mine called Maypole,
which enables Perl programmers to get web front-ends to databases,
as well as complex web-based applications, up and running quickly.</p>

<p>Extremely quickly,
and with very little Perl coding required.
I&#39;ve used Maypole to set up an Intranet portal,
a database and display system for choosing menus and recipes,
song lyric and chord sheet projection software,
an open-source social network site,
and a web database of beer-tasting notes; and that just was in the past two weeks.</p>

<p>Maypole&#39;s flexibility stems from three fundamentals:</p>

<ul>
  <li><a href="#Separation_of_concerns">Clear separation of concerns</a></li>
  <p class="pad"></p>
  <li><a href="maypole.html?page=2#Sensible_defaults">Intelligent defaults</a></li>
  <p class="pad"></p>
  <li><a href="maypole.html?page=2#Ease_of_Extensibility">Ease of extensibility</a></li>
  <p class="pad"></p>
</ul>

<p>To demonstrate these three principles,
we&#39;re going to look at a bread-and-butter web application -- an online shop&#39;s product catalogue -- and see how quickly we can put it together with Maypole.</p>

<h2><a name="Separation_of_concerns">Separation of Concerns</a></h2>

<p>Maypole was originally called <code lang='und' xml:lang='und'>Apache::MVC</code>,
reflecting its basis in the Model-View-Controller design pattern.
(I had to change it firstly because Maypole isn&#39;t tied to Apache,
and secondly because <code lang='und' xml:lang='und'>Apache::MVC</code> is a really dull name.) It&#39;s the same design pattern that forms the foundation of similar projects in other languages,
such as Java&#39;s Struts framework.</p>

<p>This design pattern is found primarily in graphical applications; the idea is that you have a Model class that represents and manipulates your data,
a View class that is responsible for displaying that data to the user,
and a Controller class that controls the other classes in response to events triggered by the user.
This analogy doesn&#39;t correspond precisely to a web-based application,
but we can take an important principle from it.
As Andy Wardley explains:</p>

<blockquote>What the MVC-for-the-web crowd is really trying to achieve is a clear
    separation of concerns.  Put your database code in one place, your 
    application code in another, your presentation code in a third place.  
    That way, you can chop and change different elements at will,
    hopefully without affecting the other parts (depending on how well your
    concerns are separated, of course).  This is common sense and good practice.
    MVC achieves this separation of concerns as a byproduct of clearly 
    separating inputs (controls) and outputs (views). </blockquote>

<p>This is what Maypole does. It has a number of database drivers, a number of front-end drivers, and a number of templating presentation drivers. In common cases, Maypole provides precisely what you need for all of these areas, and you get to concentrate on writing just the business logic of your application. This is one of the reasons why Maypole lets you develop so rapidly -- because most of the time, you don&#39;t need to do any development at all.</p>

<p>Let&#39;s begin, then, by choosing what elements are going to make up our product database. We will actually be using what is by far the most common configuration of model, view, and controller classes: Maypole provides a model class based on <code lang='und' xml:lang='und'>Class::DBI</code>, a view class based on <code lang='und' xml:lang='und'>Template::Toolkit</code>, and a controller class based on Apache <code lang='und' xml:lang='und'>mod_perl</code>. We&#39;ll come to what all of this means in a second, but because this configuration is so common, it is the default; no code is required to set that up.</p>

<p>We will, however, need a database. Our client is going to be <code lang='und' xml:lang='und'>iSellIt</code>, a fictitious supplier of computer components and software. We will have database tables for products, manufacturers, and categories of stuff, and subcategories of categories. Here&#39;s what that database might look like.</p>

<pre lang='und' xml:lang='und'>    CREATE TABLE product (
        id int NOT NULL auto_increment primary key,
        category int,
        subcategory int,
        manufacturer int,
        part_number varchar(50),
        name varchar(50),
        cost decimal(6,2),
        description text
    );

    CREATE TABLE manufacturer (
        id int NOT NULL auto_increment primary key,
        name varchar(50),
        url varchar(255),
        notes text
    );

    CREATE TABLE category (
        id int NOT NULL auto_increment primary key,
        name varchar(50)
    );

    CREATE TABLE subcategory (
        id int NOT NULL auto_increment primary key,
        name varchar(50),
        category integer
    );</pre>

<p>We&#39;re going to assume that we&#39;ve loaded some data into this database already, but we&#39;re going to want the sales people to update it themselves over a web interface.</p>

<csperl file="grab" domain="on" record="sc/1252" field="html">

<p>In order to use Maypole, we need what&#39;s called a driver module. This is a very short Perl module that defines the application we're working with. I say it&#39;s a Perl module, and that may make you think this is about writing code, but to be honest, most of it is actually configuration in disguise. Here&#39;s the driver module for our ISellIt application. (The client may be called <code lang='und' xml:lang='und'>iSellIt</code>, but many years exposure to Perl module names makes me allergic to starting one with a lowercase letter.)</p>

<pre lang='und' xml:lang='und'>    package ISellIt;
    use base &#39;Apache::MVC&#39;;
    use Class::DBI::Loader::Relationship;

    ISellIt-&#62;setup(&#34;dbi:mysql:isellit&#34;);
    ISellIt-&#62;config-&#62;{uri_base} = &#34;http://localhost/isellit&#34;;
    ISellIt-&#62;config-&#62;{rows_per_page} = 10;
    ISellIt-&#62;config-&#62;{loader}-&#62;relationship($_) for 
        (&#34;a manufacturer has products&#34;, &#34;a category has products&#34;,
         &#34;a subcategory has products&#34;, &#34;a category has subcategories&#34;);

    1;</pre>

<p>Ten lines of code; that&#39;s the sort of size you should expect a Maypole application to be. Let&#39;s take it apart, a line at a time:</p>

<pre lang='und' xml:lang='und'>    package ISellIt;</pre>

<p>This is the name of our application, and it&#39;s what we&#39;re going to tell Apache to use as the Perl handler for our web site.</p>

<pre lang='und' xml:lang='und'>    use base &#39;Apache::MVC&#39;;</pre>

<p>This says that we&#39;re using the Apache front-end to Maypole, and so we&#39;re writing a <code lang='und' xml:lang='und'>mod_perl</code> application.</p>

<pre lang='und' xml:lang='und'>    use Class::DBI::Loader::Relationship;</pre>

<p>Now we use a Perl module that I wrote to help put together Maypole driver classes. It allows us to declare the relationships between our database tables in a straightforward way.</p>

<pre lang='und' xml:lang='und'>    ISellIt-&#62;setup(&#34;dbi:mysql:isellit&#34;);</pre>

<p>We tell <code lang='und' xml:lang='und'>ISellIt</code> to go connect to the database and work out the tables and columns in our application. In addition, because we haven&#39;t changed any class defaults, it&#39;s assumed that we&#39;re going to use <code lang='und' xml:lang='und'>Class::DBI</code> and Template Toolkit. We could have said that we want to use <code lang='und' xml:lang='und'>Apache::MVC</code> with <code lang='und' xml:lang='und'>DBIx::SearchBuilder</code> and <code lang='und' xml:lang='und'>HTML::Mason</code>, but we don&#39;t.</p>

<p>Maypole&#39;s <code lang='und'
    xml:lang='und'>Class::DBI</code>-based class uses <a
    href="http://search.cpan.org/perldoc?Class::DBI::Loader"><code>Class::DBI::Loader</code></a>
to investigate the structure of the database, and then map the <code
    lang='und' xml:lang='und'>product</code> table onto a <code
    lang='und' xml:lang='und'>ISellIt::Product</code> class, and so on.
You can read more about how <code lang='und'
    xml:lang='und'>Class::DBI</code>&#39;s table-class mapping works
in <a href='http://www.perl.com/pub/a/2002/11/27/classdbi.html'>Tony's
    article about it</a>.</p>

<pre lang='und' xml:lang='und'>    ISellIt-&#62;config-&#62;{uri_base} = &#34;http://localhost/isellit&#34;;</pre>

<p><code lang='und' xml:lang='und'>ISellIt</code> sometimes needs to know where it lives, so that it can properly produce links to other pages inside the application.</p>

<pre lang='und' xml:lang='und'>    ISellIt-&#62;config-&#62;{rows_per_page} = 10;</pre>

<p>This says that we don&#39;t want to display the whole product list on one page; there&#39;ll be a maximum of 10 items on a page, before we get a page-view of the list.</p>

<pre lang='und' xml:lang='und'>    ISellIt-&#62;config-&#62;{loader}-&#62;relationship($_) for 
        (&#34;a manufacturer has products&#34;, &#34;a category has products&#34;,
         &#34;a subcategory has products&#34;, &#34;a category has subcategories&#34;);</pre>

<p>Now we define our relationship constraints, in reasonably natural syntax: a manufacturer has a number of products, and a category will delimit a collection of products, and so on.</p>

<p>Ten lines of code. What has it got us?</p>



















<h2><a name="Sensible_defaults">Sensible Defaults</a></h2>

<p>The second foundation of Maypole is its use of sensible defaults. It has a system of generic templates that &#34;do the right thing&#34; for viewing and editing data in a database. In many cases, web application programmers won&#39;t need to change the default behavior at all; in the majority of cases, they only need to change a few of the templates, and in the best cases, they can declare that the templating is the web design group&#39;s problem and not need to do any work at all.</p>

<p>So, if we install the application and the default templates, and go to our site, <code lang='und' xml:lang='und'>http://localhost/isellit</code>; we should see this:</p>

<img src="/pub/2004/04/21/graphics/maypole1.png"/>

<p>Which is only fair for 10 lines of code. But it gets better, because if we click on, say, the product listing, we get a screen like so:</p>

<img src="/pub/2004/04/21/graphics/maypole2.png"/>

<p>Now that&#39;s something we could probably give to the sales team with no further alterations needed, and they could happily add, edit, and delete products.</p>

<p>Similarly, if we then click on a manufacturer in that products table, we see a handy page about the manufacturer, their products, and so on:</p>

<img src="/pub/2004/04/21/graphics/maypole3.png"/>

<p>Now I think we are getting some worth from our 10 lines. Next, we give the templates to the web designers. Maypole searches for templates in three different places: first, it looks for a template specific to a class; then it looks for a custom template for the whole application; finally, it looks in the <em lang='und' xml:lang='und'>factory</em> directory to use the totally generic, do-the-right-thing template.</p>

<p>So, to make a better manufacturer view, we tell them to copy the <em lang='und' xml:lang='und'>factory/view</em> template into <em lang='und' xml:lang='und'>manufacturer/view</em> and customize it. We copy <em lang='und' xml:lang='und'>factory/list</em> into <em lang='und' xml:lang='und'>product/list</em> and customize it as a listing of products; we copy <em lang='und' xml:lang='und'>factory/header</em> and <em lang='und' xml:lang='und'>factory/footer</em> into the <em lang='und' xml:lang='und'>custom/</em> directory, and turn them into the boilerplate HTML surrounding every page, and so on.</p>

<p>Now, I am not very good at HTML design, which is why I like Maypole -- it makes it someone else&#39;s problem -- but this means I&#39;m not very good at showing you what sort of thing you can do with the templates. But here&#39;s a mock-up; I created <code lang='und' xml:lang='und'>product/view</code> with the following template:</p>

<pre lang='und' xml:lang='und'>    [% INCLUDE header %]
    [% PROCESS macros %]

    &#60;DIV class=&#34;nav&#34;&#62; You are in: [% maybe_link_view(product.category) %] &#62; 
    [% maybe_link_view(product.subcategory) %] &#60;/DIV&#62;

    &#60;h2&#62; [% product.name %]&#60;/h2&#62;
    &#60;DIV class=&#34;manufacturer&#34;&#62; By [% maybe_link_view(product.manufacturer) %] 
    &#60;/DIV&#62;
    &#60;DIV class=&#34;description&#34;&#62; [% product.description %] &#60;/DIV&#62;

    &#60;TABLE class=&#34;view&#34;&#62;
    &#60;TR&#62;
        &#60;TD class=&#34;field&#34;&#62; Price (ex. VAT) &#60;/TD&#62; 
        &#60;TD&#62; &#38;pound; [% product.cost %] &#60;/TD&#62;
    &#60;/TR&#62;
    &#60;TR&#62;
        &#60;TD class=&#34;field&#34;&#62; Part number  &#60;/TD&#62; 
        &#60;TD&#62; [% product.part_number %] &#60;/TD&#62;
    &#60;/TR&#62;
    &#60;/TABLE&#62;

    [% button(product, &#34;order&#34;) %]</pre>

<p>Producing the following screenshot. It may not look better, but at least it proves things can be made to look different.</p>

<img src="/pub/2004/04/21/graphics/maypole4.png"/>

<p>We&#39;ve written a Template Toolkit template; the parts surrounded
in <code lang='und' xml:lang='und'>[% ... %]</code> are templating
directives. If you&#39;re not too familiar with the Template Toolkit,
the Maypole manual&#39;s <a href='http://maypole.simon-cozens.org/doc/View.html'>
view documentation</a> has a good introduction to TT in the Maypole context.</p>

<p>Maypole provides a number of default Template macros, such as <code lang='und' xml:lang='und'>maybe_link_view</code>, which links an object to a page viewing that object, although all of these can be overridden. It also passes in the object <code lang='und' xml:lang='und'>product</code>, which it knows to be the one we&#39;re talking about.</p>

<p>In fact, that&#39;s what Maypole is really about: we&#39;ve described it in terms of putting a web front-end onto a database, but fundamentally, it&#39;s responsible for using the URL <code lang='und' xml:lang='und'>/product/view/210</code> to load up the <code lang='und' xml:lang='und'>product</code> object with ID <code lang='und' xml:lang='und'>210</code>, call the <code lang='und' xml:lang='und'>view</code> method on its class, and pass it to the <code lang='und' xml:lang='und'>view</code> template. Similarly, <code lang='und' xml:lang='und'>/product/list</code> calls the <code lang='und' xml:lang='und'>list</code> method on the product class, which populates the template with a page full of products.</p>

<p>The interesting thing about this template is that very last line:</p>

<pre lang='und' xml:lang='und'>    [% button(product, &#34;order&#34;) %]</pre>

<p>This produces a button which will produce a POST to the URL <code lang='und' xml:lang='und'>/product/order/210</code>, which does the same as <code lang='und' xml:lang='und'>view</code> except this time calls the <code lang='und' xml:lang='und'>order</code> method. But Maypole doesn&#39;t yet know how to <code lang='und' xml:lang='und'>order</code> a product. This is OK, because we can tell it.</p>

<h2><a name="Ease_of_Extensibility">Ease of Extensibility</a></h2>

<p>Maypole&#39;s third principle is ease of extensibility. That is to say, Maypole makes it very easy to go from a simple database front-end to a full-fledged web application. Which is just as well; as has been simulated above, once the templates come back from the web designers, you find that what you thought was just going to be a product database has become an online shop. And you&#39;ve still got a deadline.</p>

<p>But before we start extending our catalogue application to take on the new specifications (which we&#39;ll do in the second article about this), let&#39;s take a look at what we&#39;ve achieved so far and what we need immediately.</p>

<p>We&#39;ve got a way to list all the products, manufacturers, categories, and subcategories in our database; we have a way to add, edit and delete all of these things; we can search for products by manufacturer, price, and so on. What&#39;s to stop us deploying this as a customer-facing web site, as well as for Intranet updates to the product catalogue?</p>

<p>The immediate problem is security. We can add, edit, and delete products -- but so can anyone else. We want to allow those coming from the outside world only to view, list and search; for everything else, we require the user to be coming from an IP address in our internal range. (For now; we&#39;ll add the concept of a user when we&#39;re adding the shopping cart, and the idea of privileged user won&#39;t be far off that.)</p>

<p>Unfortunately, now we want some user-defined behavior, we have to start writing code. Thankfully, we don&#39;t have to write much of it. We add a few lines to our driver class, first to define our private IP address space as a <code lang='und' xml:lang='und'>NetAddr::IP</code> object, since that provides a handy way of determining if an address is in a network:</p>

<pre lang='und' xml:lang='und'>    use constant INTERNAL_RANGE =&#62; &#34;10.0.0.0/8&#34;;
    use NetAddr::IP;
    my $range = NetAddr::IP-&#62;new(INTERNAL_RANGE);</pre>

<p>Now we write our authentication method; Maypole&#39;s default <code lang='und' xml:lang='und'>authenticate</code> allows everyone access to everything, so we need to override this.</p>

<pre lang='und' xml:lang='und'>    use Maypole::Constants;
    sub authenticate {
        my ($self, $r) = @_;

        # Everyone can view, search, list
        return OK if $r-&#62;action =~ /^(view|search|list)$/;

        # Else they have to be in the internal network
        my $ip = NetAddr-&#62;IP-&#62;new($r-&#62;{ar}-&#62;connection-&#62;remote_ip);
        return OK if $ip-&#62;within($range);
        return DECLINED;
    }</pre>

<p>The <code lang='und' xml:lang='und'>authenticate</code> class method gets passed a Maypole request object; this is like an Apache request object, but at a much, much higher level -- it contains information about the web request, the class that&#39;s going to be used to fulfill the request, the method we need to call on the class, the template that&#39;s going to be processed, any objects, form parameters, and query parameters, and so on.</p>

<p>At this point, Maypole has already parsed the URI into its component database table, action, and additional arguments, so we first check to see if the action is one of the universally permitted ones.</p>

<p>If not, we extract the <code lang='und' xml:lang='und'>Apache::Request</code> object stashed inside the Maypole object, and ask it for the remote IP address. If it&#39;s in the private range, we can do everything. If not, we can do nothing. Simple enough.</p>

<p>It&#39;s almost ready to go live, when the design guys tell you that they&#39;d really love to put a picture alongside the description of a product. No problem.</p>

<p>There&#39;s two ways to do this; the way that seems really easy uses the file system to store the pictures, and has you put something like this in the template:</p>

<pre lang='und' xml:lang='und'>    &#60;IMG SRC=&#34;/static/product_pictures/[% product.id %].png&#34;&#62;</pre>

<p>But while that&#39;s very simple for viewing pictures, and makes a great mockup, it&#39;s not that easy to upload pictures. So you decide to put the pictures in the database. You add a &#34;picture&#34; binary column to the product table, and then you consult the Maypole manual.</p>

<p>One of the great things about this Perl Foundation sponsorship is
that it&#39;s allowing me to put together a really great manual, which
contains all sorts of tricks for dealing with Maypole; the <a
    href="http://maypole.simon-cozens.org/doc/Request.html">Request</a> chapter contains a couple of recipes for uploading and displaying photos.</p>

<p>What we need to do is create some new actions -- one to upload a picture, and one to display it again. We&#39;ll only show the one to display a picture, since you can get them both from the manual, and because looking at this turns out to be a handy way to understand how to extend Maypole more generally.</p>

<p>It&#39;s useful to visualize what we&#39;re going to end up with, and work backwards. We&#39;ll have a URL like <code lang='und' xml:lang='und'>/product/view_picture/210</code> producing an <code lang='und' xml:lang='und'>image/png</code> or similar page with the product&#39;s image. This allows us to put in our templates:</p>

<pre lang='und' xml:lang='und'>    &#60;IMG SRC=&#34;/product/view_picture/[% product.id %]/&#34;&#62;</pre>

<p>And have the image displayed on our product view page. In fact, we&#39;re more likely to want to say:</p>

<pre lang='und' xml:lang='und'>    [% IF product.picture %]
    &#60;IMG SRC=&#34;/product/view_picture/[% product.id %]/&#34;&#62;
    [% ELSE %]
    &#60;IMG SRC=&#34;/static/no_picture.png&#34;&#62;
    [% END %]</pre>

<p>Now, we&#39;ve explained that Maypole turns URLs into method calls, so we&#39;re going to be putting a <code lang='und' xml:lang='und'>view_picture</code> method in the product&#39;s class; this class is <code lang='und' xml:lang='und'>ISellIt::Product</code>, so we begin like this:</p>

<pre lang='und' xml:lang='und'>    package ISellIt::Product;
    sub view_picture {
        my ($self, $r) = @_;
        # ...
    }</pre>

<p>This has a big problem. We don&#39;t actually want people to be able to call any method on our class over the web; that would be unwise. Maypole will refuse to do this. So in order to tell Maypole that we&#39;re allowed to call this method remotely, we decorate it with an attribute:</p>

<pre lang='und' xml:lang='und'>    sub view_picture :Exported {
        my ($self, $r) = @_;
    }</pre>

<p>At this point, we can call <code lang='und' xml:lang='und'>view_picture</code> over the Web; we now need to make it populate the Maypole request with the appropriate data:</p>

<pre lang='und' xml:lang='und'>    sub view_picture :Exported {
        my ($self, $r, $product) = @_;
        if ($product) {
            $r-&#62;{content_type} = &#34;image/png&#34;;
            $r-&#62;{content} = $product-&#62;picture;
        }
    }</pre>

<p>This is a slightly unusual Maypole method, because we&#39;re bypassing the whole view class processing and templating stages, and generating content manually, but it serves to illustrate one thing: Maypole arranges for the appropriate object to be passed into the method; we&#39;ve gone from URL to object without requiring any code of our own.</p>

<p>When we come to implementing ordering, in our next article, we&#39;ll be adding more actions like this to place the product in a user&#39;s shopping cart, check out, validate his credit card and so on. But this should be good enough for now: a templated, web-editable product database, with pictures, without stress, without too much code, and within the deadline. Well, almost.</p>

<h2><a name="Summary">Summary</a></h2>

<p>Maypole is evolving rapidly, thanks primarily to the Perl Foundation who have enabled me to work on it for this month; it&#39;s allowed me to write many thousands of words of articles, sample applications, and Maypole-related code, and this has helped Maypole to become an extremely useful framework for developing web applications.</p>




        </div>



    </div>
    <div class="asset-footer"></div>
</div>


                            
                            <div id="entry-914" class="entry-asset asset hentry">
    <div class="asset-header">
        <h2 class="asset-name entry-title"><a href="/pub/2004/04/16/a12.html" rel="bookmark">Apocalypse 12</a></h2>
        <div class="asset-meta">
            <span class="byline">
    
                By <span class="vcard author">Larry Wall</span> on <abbr class="published" title="2004-04-16T00:00:00-08:00">April 16, 2004 12:00 AM</abbr>
    
            </span>

            
            

        </div>
    </div>
    <div class="asset-content entry-content">

        <div class="asset-body">
            
<!-- sidebar begins -->
<!-- don't move sidebars -->
<!-- sidebar ends -->

<p><em>Editor's Note: this Apocalypse is out of date and remains here for historic reasons.  See <a href="http://dev.perl.org/perl6/doc/design/syn/S12.html">Synopsis 12</a> for the latest information.</em></p>

<ul>
	<!-- page 2 -->
    <li><a href="/pub/a/2004/04/16/a12.html?page=2#some_of_the_problems_with_perl_5_oo">Some of the Problems 
        with Perl 5 OO</a> 
        <ul>
            <li><a href="/pub/a/2004/04/16/a12.html?page=2#a_little_too_orthogonal">A little too orthogonal</a></li>
            <li><a href="/pub/a/2004/04/16/a12.html?page=2#not_quite_orthogonal_enough">Not quite orthogonal 
                enough</a></li>
            <li><a href="/pub/a/2004/04/16/a12.html?page=2#forced_nonencapsulation">Forced non-encapsulation</a></li>
            <li><a href="/pub/a/2004/04/16/a12.html?page=2#a_little_too_minimal">A little too minimal</a></li>
            <li><a href="/pub/a/2004/04/16/a12.html?page=2#too_much_keyword_reuse">Too much keyword reuse</a></li>
            <li><a href="/pub/a/2004/04/16/a12.html?page=2#too_difficult_to_capture_metadata">Too difficult 
                to capture metadata</a></li>
            <li><a href="/pub/a/2004/04/16/a12.html?page=2#insideout_interfaces">Inside-out interfaces</a></li>
            <li><a href="/pub/a/2004/04/16/a12.html?page=2#not_enough_convention">Not enough convention</a></li>
            <li><a href="/pub/a/2004/04/16/a12.html?page=2#wrong_conventions">Wrong conventions</a></li>
            <li><a href="/pub/a/2004/04/16/a12.html?page=2#everything_possible,_but_difficult">Everything 
                possible, but difficult</a></li>
        </ul>
    </li>
    <li><a href="/pub/a/2004/04/16/a12.html?page=2#perl_5_nonproblems">Perl 5 Non-Problems</a> 
        <ul>
            <li><a href="/pub/a/2004/04/16/a12.html?page=2#generating_class_by_running_code_at_compile_time">Generating 
                class by running code at compile time</a></li>
            <li><a href="/pub/a/2004/04/16/a12.html?page=2#there_are_many_roads_to_polymorphism">There are 
                many roads to polymorphism</a></li>
            <li><a href="/pub/a/2004/04/16/a12.html?page=2#people_using_a_class_shouldn't_have_to_think_hard">People 
                using a class shouldn't have to think hard</a></li>
        </ul>
    </li>
    <li><a href="/pub/a/2004/04/16/a12.html?page=2#trust_in_convention,_but_keep_your_powder_dry">Trust in 
        Convention, But Keep Your Powder Dry</a></li>
    <li><a href="/pub/a/2004/04/16/a12.html?page=2#an_easy_example">An Easy Example</a></li>
<!-- page 3 -->
    <li><a href="/pub/a/2004/04/16/a12.html?page=3#classes">Classes</a> 
        <ul>
            <li><a href="/pub/a/2004/04/16/a12.html?page=3#declaration_of_classes">Declaration of classes</a> 
                <ul>
                    <li><a href="/pub/a/2004/04/16/a12.html?page=3#class_traits">Class traits</a></li>
                </ul>
            </li>
            <li><a href="/pub/a/2004/04/16/a12.html?page=3#use_of_classes">Use of classes</a></li>
            <li><a href="/pub/a/2004/04/16/a12.html?page=3#class_name_semantics">Class name semantics</a></li>
<!-- page 4 -->
            <li><a href="/pub/a/2004/04/16/a12.html?page=4#private_classes">Private classes</a></li>
        </ul>
    </li>
    <li><a href="/pub/a/2004/04/16/a12.html?page=4#methods">Methods</a> 
        <ul>
            <li><a href="/pub/a/2004/04/16/a12.html?page=4#declaration_of_methods">Declaration of methods</a></li>
            <li><a href="/pub/a/2004/04/16/a12.html?page=4#use_of_methods">Use of methods</a> 
                <ul>
                    <li><a href="/pub/a/2004/04/16/a12.html?page=4#the_dot_notation">The dot notation</a></li>
<!-- page 5 -->
                    <li><a href="/pub/a/2004/04/16/a12.html?page=5#the_indirect_object_notation">The "indirect 
                        object" notation</a></li>
                    <li><a href="/pub/a/2004/04/16/a12.html?page=5#calling_private_methods">Calling private 
                        methods</a></li>
                </ul>
            </li>
        </ul>
    </li>
    <li><a href="/pub/a/2004/04/16/a12.html?page=5#class_methods">Class Methods</a> 
        <ul>
            <li><a href="/pub/a/2004/04/16/a12.html?page=5#class_invocant">Class invocant</a></li>
            <li><a href="/pub/a/2004/04/16/a12.html?page=5#class|object_invocant">Class|object invocant</a></li>
        </ul>
    </li>
    <li><a href="/pub/a/2004/04/16/a12.html?page=5#submethods">Submethods</a></li>
<!-- page 6 -->
    <li><a href="/pub/a/2004/04/16/a12.html?page=6#attributes">Attributes</a> 
        <ul>
            <li><a href="/pub/a/2004/04/16/a12.html?page=6#declaration_of_attributes">Declaration of attributes</a></li>
            <li><a href="/pub/a/2004/04/16/a12.html?page=6#use_of_attributes">Use of attributes</a></li>
            <li><a href="/pub/a/2004/04/16/a12.html?page=6#default_values">Default values</a></li>
        </ul>
    </li>

<csperl file="grab" domain="on" record="b/940" template="b/article_sidebar.view">	

<!-- page 7 -->
    <li><a href="/pub/a/2004/04/16/a12.html?page=7#class_attributes">Class Attributes</a></li>
    <li><a href="/pub/a/2004/04/16/a12.html?page=7#object_construction">Object Construction</a> 
        <ul>
            <li><a href="/pub/a/2004/04/16/a12.html?page=7#the_default_constructor">The default constructor</a> 
                <ul>
                    <li><a href="/pub/a/2004/04/16/a12.html?page=7#the_default_cloner">The default cloner</a></li>
                </ul>
            </li>
            <li><a href="/pub/a/2004/04/16/a12.html?page=7#create">CREATE</a></li>
            <li><a href="/pub/a/2004/04/16/a12.html?page=7#buildall">BUILDALL</a></li>
            <li><a href="/pub/a/2004/04/16/a12.html?page=7#build">BUILD</a></li>
<!-- page 8 -->
            <li><a href="/pub/a/2004/04/16/a12.html?page=8#eliminating_redundancy_in_constructor_calls">Eliminating 
                redundancy in constructor calls</a></li>
        </ul>
    </li>
    <li><a href="/pub/a/2004/04/16/a12.html?page=8#object_deconstruction">Object Deconstruction</a> 
        <ul>
            <li><a href="/pub/a/2004/04/16/a12.html?page=8#destroyall">DESTROYALL</a></li>
            <li><a href="/pub/a/2004/04/16/a12.html?page=8#destroy">DESTROY</a></li>
        </ul>
    </li>
    <li><a href="/pub/a/2004/04/16/a12.html?page=8#dispatch_mechanisms">Dispatch Mechanisms</a> 
        <ul>
            <li><a href="/pub/a/2004/04/16/a12.html?page=8#single_dispatch">Single dispatch</a></li>
            <li><a href="/pub/a/2004/04/16/a12.html?page=8#calling_superclasses,_and_notsosuperclasses">Calling 
                superclasses, and not-so-superclasses</a></li>
<!-- page 9 -->
            <li><a href="/pub/a/2004/04/16/a12.html?page=9#parallel_dispatch">Parallel dispatch</a></li>
            <li><a href="/pub/a/2004/04/16/a12.html?page=9#walkclass_and_walkmeth_caching">WALKCLASS and 
                WALKMETH caching</a></li>
        </ul>
    </li>
    <li><a href="/pub/a/2004/04/16/a12.html?page=9#multiple_dispatch">Multiple Dispatch</a> 
        <ul>
            <li><a href="/pub/a/2004/04/16/a12.html?page=9#declaration_of_multiple_dispatch_routines">Declaration 
                of multiple dispatch routines</a> 
                <ul>
                    <li><a href="/pub/a/2004/04/16/a12.html?page=9#multi_sub">multi sub</a></li>
                    <li><a href="/pub/a/2004/04/16/a12.html?page=9#multi_sub_*_(tradition_multimethods)">multi 
                        sub * (tradition multimethods)</a></li>
                    <li><a href="/pub/a/2004/04/16/a12.html?page=9#multi_method">multi method</a></li>
                    <li><a href="/pub/a/2004/04/16/a12.html?page=9#multi_submethod">multi submethod</a></li>
                    <li><a href="/pub/a/2004/04/16/a12.html?page=9#multi_rule">multi rule</a></li>
                    <li><a href="/pub/a/2004/04/16/a12.html?page=9#multi_submethod_build">multi submethod 
                        BUILD</a></li>
                    <li><a href="/pub/a/2004/04/16/a12.html?page=9#multi_method_constructors">multi method 
                        constructors</a></li>
                </ul>
            </li>
<!-- page 10 -->
            <li><a href="/pub/a/2004/04/16/a12.html?page=10#calling_via_multiple_dispatch">Calling via multiple 
                dispatch</a> 
                <ul>
                    <li><a href="/pub/a/2004/04/16/a12.html?page=10#multiple_dispatch_semantics">Multiple 
                        dispatch semantics</a></li>
                    <li><a href="/pub/a/2004/04/16/a12.html?page=10#single_dispatch_semantics">Single dispatch 
                        semantics</a></li>
                    <li><a href="/pub/a/2004/04/16/a12.html?page=10#indirect_objects">Indirect objects</a></li>
                </ul>
            </li>
            <li><a href="/pub/a/2004/04/16/a12.html?page=10#meaning_of_next_method">Meaning of "next METHOD"</a></li>
            <li><a href="/pub/a/2004/04/16/a12.html?page=10#making_fiends,_er,_friends.">Making fiends, er, 
                friends</a></li>
        </ul>
    </li>
	
<!-- page 11 -->
    <li><a href="/pub/a/2004/04/16/a12.html?page=11#overloading">Overloading</a> 
        <ul>
            <li><a href="/pub/a/2004/04/16/a12.html?page=11#binary_ops">Binary ops</a></li>
        </ul>
    </li>
    <li><a href="/pub/a/2004/04/16/a12.html?page=11#class_composition_with_roles">Class Composition with Roles</a> 
        <ul>
<!-- page 12 -->
            <li><a href="/pub/a/2004/04/16/a12.html?page=12#declaration_of_roles">Declaration of roles</a> 
                <ul>
                    <li><a href="/pub/a/2004/04/16/a12.html?page=12#parametric_types">Parametric types</a></li>
                    <li><a href="/pub/a/2004/04/16/a12.html?page=12#interfaces">Interfaces</a></li>
                    <li><a href="/pub/a/2004/04/16/a12.html?page=12#private_interfaces">Private interfaces</a></li>
                    <li><a href="/pub/a/2004/04/16/a12.html?page=12#encapsulated_attributes">Encapsulated 
                        attributes</a></li>
                    <li><a href="/pub/a/2004/04/16/a12.html?page=12#encapsulated_private_attributes">Encapsulated 
                        private attributes</a></li>
                    <li><a href="/pub/a/2004/04/16/a12.html?page=12#encapsulated_delegation">Encapsulated 
                        delegation</a></li>
                    <li><a href="/pub/a/2004/04/16/a12.html?page=12#encapsulated_inheritance">Encapsulated 
                        inheritance</a></li>
                </ul>
            </li>
            <li><a href="/pub/a/2004/04/16/a12.html?page=12#use_of_roles_at_compile_time">Use of roles at 
                compile time</a> 
                <ul>
                    <li><a href="/pub/a/2004/04/16/a12.html?page=12#conflict_resolution">Conflict resolution</a></li>
                </ul>
            </li>
			
<!-- page 13 -->
            <li><a href="/pub/a/2004/04/16/a12.html?page=13#use_of_roles_at_run_time_(mixins)">Use of roles 
                at runtime (mixins)</a></li>
        </ul>
    </li>
    <li><a href="/pub/a/2004/04/16/a12.html?page=13#traits">Traits</a></li>
<!-- page 14 -->
    <li><a href="/pub/a/2004/04/16/a12.html?page=14#delegation">Delegation</a> 
        <ul>
            <li><a href="/pub/a/2004/04/16/a12.html?page=14#wildcard_delegation">Wildcard delegation</a></li>
            <li><a href="/pub/a/2004/04/16/a12.html?page=14#renaming_delegated_methods">Renaming delegated 
                methods</a></li>
            <li><a href="/pub/a/2004/04/16/a12.html?page=14#delegation_without_an_attribute">Delegation without 
                an attribute</a></li>
            <li><a href="/pub/a/2004/04/16/a12.html?page=14#delegation_of_handlers">Delegation of handlers</a></li>
            <li><a href="/pub/a/2004/04/16/a12.html?page=14#hashbased_redispatch">Hash-based redispatch</a></li>
<!-- page 15 -->			
            <li><a href="/pub/a/2004/04/16/a12.html?page=15#relationship_to_roles">Relationship to roles</a></li>
            <li><a href="/pub/a/2004/04/16/a12.html?page=15#anonymous_delegation_for_isa_emulation">Anonymous 
                delegation for ISA emulation</a></li>
        </ul>
    </li>
    <li><a href="/pub/a/2004/04/16/a12.html?page=15#types_and_subtypes">Types and Subtypes</a></li>
    <li><a href="/pub/a/2004/04/16/a12.html?page=15#enums">Enums</a></li>
<!-- page 16 -->
    <li><a href="/pub/a/2004/04/16/a12.html?page=16#open_vs_closed_classes">Open vs. Closed Classes</a></li>
    <li><a href="/pub/a/2004/04/16/a12.html?page=16#interface_consistency">Interface Consistency</a></li>
<!-- page 17 -->
    <li><a href="/pub/a/2004/04/16/a12.html?page=17#collections_of_classes">Collections of Classes</a> 
        <ul>
            <li><a href="/pub/a/2004/04/16/a12.html?page=17#in_classes">In classes</a></li>
            <li><a href="/pub/a/2004/04/16/a12.html?page=17#in_modules">In modules</a></li>
        </ul>
    </li>
    <li><a href="/pub/a/2004/04/16/a12.html?page=17#versioning">Versioning</a> 
        <ul>
            <li><a href="/pub/a/2004/04/16/a12.html?page=17#version_declarations">Version declarations</a></li>
<!-- page 18 -->
            <li><a href="/pub/a/2004/04/16/a12.html?page=18#use_of_version_and_author_wildcards">Use of version 
                and author wildcards</a></li>
        </ul>
    </li>
    <li><a href="/pub/a/2004/04/16/a12.html?page=18#introspection">Introspection</a></li>
<!-- page 19 -->
    <li><a href="/pub/a/2004/04/16/a12.html?page=19#other_nonoo_decisions">Other Non-OO Decisions</a> 
        <ul>
            <li><a href="/pub/a/2004/04/16/a12.html?page=19#exportation">Exportation</a></li>
            <li><a href="/pub/a/2004/04/16/a12.html?page=19#the_gather/take_construct">The gather/take construct</a></li>
            <li><a href="/pub/a/2004/04/16/a12.html?page=19#:foo()_adverbs"><code>:foo()</code> adverbs</a></li>
            <li><a href="/pub/a/2004/04/16/a12.html?page=19#special_quoting_of_identifiers_inside_curlies_going_away!">Special 
                quoting of identifiers inside curlies going away</a></li>
            <li><a href="/pub/a/2004/04/16/a12.html?page=19#vector_operators_renamed_back_to_hyper_operators">Vector 
                operators renamed back to "hyper" operators</a></li>
            <li><a href="/pub/a/2004/04/16/a12.html?page=19#unary_hyper_operators_now_use_one_quote_rather_than_two">Unary 
                hyper operators now use one quote rather than two</a></li>
            <li><a href="/pub/a/2004/04/16/a12.html?page=19#$thumb.twiddle_no_longer_requires_parens_when_interpolated"><code>$thumb.twiddle</code> no longer requires parens when interpolated</a></li>
            <li><a href="/pub/a/2004/04/16/a12.html?page=19#the_=:=_identity_operator">The =:= identity operator</a></li>
            <li><a href="/pub/a/2004/04/16/a12.html?page=19#new_grammatical_categories">New grammatical categories</a></li>
<!-- page 20 -->
            <li><a href="/pub/a/2004/04/16/a12.html?page=20#assignment_to_state_variable_declaration_now_does_first_semantics.">Assignment 
                to <code>state</code> variable declaration now does "first" 
                semantics</a></li>
            <li><a href="/pub/a/2004/04/16/a12.html?page=20#the_length()_function_is_gone">The <code>length()</code> 
                function is gone</a></li>
            <li><a href="/pub/a/2004/04/16/a12.html?page=20#string_positions">String positions</a></li>
            <li><a href="/pub/a/2004/04/16/a12.html?page=20#the_new_&_separator_in_regexen">The new "&amp;" 
                separator in Regexen</a></li>
        </ul>
    </li>
    <li><a href="/pub/a/2004/04/16/a12.html?page=20#optional_mandatory_crossdisciplinary_joke_for_people_tired_of_dogs">Optional 
        Mandatory Cross-Disciplinary Joke for People Tired of Dogs</a></li>
    <li><a href="/pub/a/2004/04/16/a12.html?page=20#future_directions">Future Directions</a></li>
    <li><a href="/pub/a/2004/04/16/a12.html?page=20#references...er,_reference...">References...er, Reference...</a></li>
</ul>













<p><em>Editor's Note: this Apocalypse is out of date and remains here for historic reasons.  See <a href="http://dev.perl.org/perl6/doc/design/syn/S12.html">Synopsis 12</a> for the latest information.</em></p>

<p>The official, unofficial slogan of Perl 6 is "Second System Syndrome Done 
    Right!". After you read this Apocalypse you will at least be certain 
    that we got the "Second System" part down pat. But we've also put in 
    a little bit of work on the "Done Right" part, which we hope you'll 
    recognize. The management of complexity is complex, but only if you 
    think about it. The goal of Perl 6 is to discourage you from thinking 
    about it unnecessarily.</p>
<p>Speaking of thinking unnecessarily, please don't think that everything 
    we write here is absolutely true. We expect some things to change as 
    people point out various difficulties. That's the way all the other 
    Apocalypses have worked, so why should this one be different?</p>
<p>When I say "we", I don't just mean "me". I mean everyone who has participated 
    in the design, including the Perl 6 cabal, er, design team, the readers 
    (and writers) of the perl6-language mailing list, and all the participants 
    who wrote or commented on the original RFCs. For this Apocalypse we've 
    directly considered the following RFCs:</p>
<pre><code>
    RFC  PSA  Title
    ===  ===  =====
    032  abb  A Method of Allowing Foreign Objects in Perl
    067  abb  Deep Copying, a.k.a., Cloning Around
    092  abb  Extensible Meta-Object Protocol
    095  acc  Object Classes
    101  bcc  Apache-Like Event and Dispatch Handlers
    126  aaa  Ensuring Perl's Object-Oriented Future
    137  bdd  Overview: Perl OO Should &lt;Not&gt; Be Fundamentally Changed
    147  rr   Split Scalars and Objects/References into Two Types
    152  bdd  Replace Invocant in @_ with self() builtin
    163  bdd  Objects: Autoaccessors for Object Data Structures
    171  rr   My Dog $spot Should Call a Constructor Implicitly
    174  bdd  Improved Parsing and Flexibility of Indirect Object Syntax
    187  abb  Objects : Mandatory and Enhanced Second Argument to C&lt;bless&gt;
    188  acc  Objects : Private Keys and Methods
    189  abb  Objects : Hierarchical Calls to Initializers and Destructors
    190  acc  Objects : NEXT Pseudoclass for Method Redispatch
    193  acc  Objects : Core Support for Method Delegation
    223  bdd  Objects: C&lt;use invocant&gt; Pragma
    224  bdd  Objects : Rationalizing C&lt;ref&gt;, C&lt;attribute::reftype&gt;, and
                C&lt;builtin:blessed&gt;
    244  cdr  Method Calls Should Not Suffer from the Action on a Distance
    254  abb  Class Collections: Provide the Ability to Overload Classes
    256  abb  Objects : Native Support for Multimethods
    265  abc  Interface Polymorphism Considered Lovely
    277  bbb  Method Calls Should Suffer from Ambiguity by Default
    307  rr   PRAYER: What Gets Said When You C&lt;bless&gt; Something
    335  acc  Class Methods Introspection: What Methods Does this Object
                Support?
    336  bbb  Use Strict 'objects': A New Pragma for Using Java-Like
                Objects in Perl</code></pre>
				
<p>These RFCs contain many interesting ideas, and many more "cries for help". 
    Usually in these Apocalypses, I discuss the design with respect to each 
    of the RFCs. However, in this case I won't, because most of these RFCs 
    fail in exactly the same way--they assume the Perl 6 object model to 
    be a set of extensions to the Perl 5 object model. But as it turns out, 
    that would have been a great way to end up with Second System Syndrome 
    Done Wrong. Perl 5's OO system is a great workbench, but it has some 
    issues that have to be dealt with systematically rather than piecemeal.</p>
<h4><a name="some_of_the_problems_with_perl_5_oo">Some of the Problems with 
    Perl 5 OO</a></h4>
<h5><a name="a_little_too_orthogonal">A little too orthogonal</a></h5>
<p>It has often been claimed that Perl 5 OO was "bolted on", but that's 
    inaccurate. It was "bolted through", at right angles to all other reference 
    types, such that any reference could be blessed into being an object. 
    That's way cool, but it's often a little <em>too</em> cool.</p>
<h5><a name="not_quite_orthogonal_enough">Not quite orthogonal enough</a></h5>
<p>It's too hard to treat built-in types as objects when you want to. Perl 
    5's <code>tie</code> interface helps, but is suboptimal in several ways, 
    not the least of which is that it only works on variables, not values.</p>
<h5><a name="forced_nonencapsulation">Forced non-encapsulation</a></h5>
<p>Because of the ability to turn (almost) anything into an object, a derived 
    class had to be aware of the internal data type of its base class. Even 
    after convention settled on hashes as the appropriate default data structure, 
    one had to be careful not to stomp on the attributes of one's base class.</p>
<h5><a name="a_little_too_minimal">A little too minimal</a></h5>
<p>Some people will be surprised to hear it, but Perl is a minimalist language 
    at heart. It's just minimalistic about weird things compared to your 
    average language. Just as the binding of parameters to <code>@_</code> 
    was a minimalistic approach, so too the entire Perl 5 object system 
    was an attempt to see how far you could drive a few features. But many 
    of the following difficulties stem from that.</p>
<h5><a name="too_much_keyword_reuse">Too much keyword reuse</a></h5>
<p>In Perl 5, a class is just a package, a method is just a subroutine, 
    and an object is just a blessed referent. That's all well and good, 
    and it is still fundamentally true in Perl 6. However, Perl 5 made the 
    mistake of reusing the same keywords to express similar ideas. That's 
    not how natural languages work--we often use different words to express 
    similar ideas, the better to make subtle distinctions.</p>
<h5><a name="too_difficult_to_capture_metadata">Too difficult to capture 
    metadata</a></h5>
<p>Because Perl 5 reused keywords and treated parameter binding as something 
    you do via a list assignment at runtime, it was next to impossible 
    for the compiler to tell which subroutines were methods and which ones 
    were really just subroutines. Because hashes are mutable, it was difficult 
    to tell at compile time what the attribute names were going to be.</p>
<h5><a name="insideout_interfaces">Inside-out interfaces</a></h5>
<p>The Perl 5 solution to the previous problem was to declare more things 
    at compile time. Unfortunately, since the main way to do things at compile 
    time was to invoke <code>use</code>, all the compile-time interfaces 
    were shoehorned into <code>use</code>'s syntax, which, powerful though 
    it may be, is often completely inside-out from a reasonable interface. 
    For instance, overloading is done by passing a list of pairs to <code>use</code>, 
    when it would be much more natural to simply declare appropriate methods 
    with appropriate names and traits. The <code>base</code> and <code>fields</code> 
    pragmas are also kludges.</p>
<h5><a name="not_enough_convention">Not enough convention</a></h5>
<p>Because of the flexibility of the Perl 5 approach, there was never any 
    "obvious" way to do it. So best practices had to be developed by each 
    group, and of course, everyone came up with a slightly different solution. 
    Now, we're not going to be like some folks and confuse "obvious" with 
    "the only way to do it". This is still Perl, after all, and the flexibility 
    will still be there if you need it. But by convention, there needs to 
    be a standard look to objects and classes so that they can interoperate. 
    There's more than one way to do it, but one of those is the standard 
    way.</p>
<h5><a name="wrong_conventions">Wrong conventions</a></h5>
<p>The use of arrow where most of the rest of the world uses dot was confusing.</p>
<h5><a name="everything_possible,_but_difficult">Everything possible, but 
    difficult</a></h5>
<p>The upshot of the previous problems was that, while Perl 5 made it easy 
    to <em>use</em> objects and classes, it was difficult to try to define 
    classes or derive from them.</p>
<h4><a name="perl_5_nonproblems">Perl 5 Non-Problems</a></h4>
<p>While there are plenty of problems with Perl 5's OO system, there are 
    some things it did right.</p>
<h5><a name="generating_class_by_running_code_at_compile_time">Generating 
    class by running code at compile time</a></h5>
<p>One of the big advances in Perl 5 was that a program could be in charge 
    of its own compilation via <code>use</code> statements and <code>BEGIN</code> 
    blocks. A Perl program isn't a passive thing that a compiler has its 
    way with, willy-nilly. It's an active thing that negotiates with the 
    compiler for a set of semantics. In Perl 6 we're not shying away from 
    that, but taking it further, and at the same time hiding it in a more 
    declarative style. So you need to be aware that, although many of the 
    things we'll be talking about here <em>look</em> like declarations, 
    they trigger Perl code that runs during compilation. Of such methods 
    are metaclasses made. (While these methods are often triggered by grammar 
    rule reductions, remember from Apocalypse 5 that all these grammar rules 
    are also running under the user's control. You can tweak the language 
    without the crude ax of source filtering.)</p>
<h5><a name="there_are_many_roads_to_polymorphism">There are many roads 
    to polymorphism</a></h5>
<p>In looking for an "obvious" way to conventionalize Perl's object system, 
    we shouldn't overlook the fact that there's more than one obvious way, 
    and different approaches work better in different circumstances. Inheritance 
    is one way (and typically the most overused), but we also need good 
    support for composition, delegation, and parametric types. Cutting across 
    those techniques are issues of interface, implementation, and mixtures 
    of interface and implementation. There are multiple strategies for ambiguity 
    resolution as well, and no single strategy is always right. (Unless 
    the boss says so.)</p>
<h5><a name="people_using_a_class_shouldn't_have_to_think_hard">People using 
    a class shouldn't have to think hard</a></h5>
<p>In making it easier to define and derive classes, we must be careful 
    not to make it harder to <em>use</em> classes.</p>
<h4><a name="trust_in_convention,_but_keep_your_powder_dry">Trust in Convention, 
    But Keep Your Powder Dry</a></h4>
<p>So to summarize this summary, what we're proposing to develop is a set 
    of conventions for how object orientation ought to work in Perl 6--by 
    default. But there should also be enough hooks to customize things to 
    your heart's content, hopefully without undue impact on the sensibilities 
    of others.</p>
<p>And in particular, there's enough flexibility in the new approach that, 
    if you want to, you can still program in a way much like the old Perl 
    5 approach. There's still a <code>bless</code> method, and you can still 
    pretend that an object is a hash--though it isn't anymore.</p>
<p>However, as with all the rest of the design of Perl 6, the overriding 
    concern has been that the language scale well. That means Perl has to 
    scale down as well as up. Perl has to work well both as a first language 
    and as a last language. We believe our design fulfills this goal--though, 
    of course, only time will tell.</p>
<p>One other note: if you haven't read the previous Apocalypses and Exegeses, 
    a lot of this is going to be complete gobbledygook to you. (Of course, 
    even if you <em>have</em> read them, this might still be gobbledygook. 
    You take your chances in life...)</p>

<h3><a name="an_easy_example">An Easy Example</a></h3>
<p>Before we start talking about all the hard things that should be possible, 
    let's look at an example of some of the easy things that should be easy. 
    Suppose we define a Point object that (for some strange reason) allows 
    you to adjust the y-axis but not the x-axis.</p>
<pre><code>
    class Point {
        has $.x;
        has $.y is rw;</code></pre>
<pre><code>
        method clear () { $.x = 0; $.y = 0; }
    }</code></pre>
<pre><code>
    my $point = Point.new(x =&gt; 2, y =&gt; 3);</code></pre>
<pre><code>
    $a = $point.y;      # okay
    $point.y = 42;      # okay</code></pre>
<pre><code>
    $b = $point.x;      # okay
    $point.x = -1;      # illegal, default is read-only</code></pre>
<pre><code>
    $point.clear;       # reset to 0,0</code></pre>
<p>If you compare that to how it would have to be written in Perl 5, you'll 
    note a number of differences:</p>
<ul>
    <li> It uses the keywords <code>class</code> and <code>method</code> 
        rather than <code>package</code> and <code>sub</code>. </li>
    <li> The attributes are named in explicit declarations rather than implicit 
        hash keys. </li>
    <li> It is impossible to confuse the attribute variables with ordinary 
        variables because of the extra dot (which also associates the attributes 
        visually with method calls). </li>
    <li> Perhaps most importantly, we did not have to commit to using a 
        hash (or any other external data structure) for the object's values.</li></li> 
    <li> We didn't have to write a constructor. </li>
    <li> The implicit constructor automatically knows how to map named arguments 
        to the attribute names. </li>
    <li> We didn't have to write the accessor methods. </li>
    <li> The accessors are by default read-only outside the class, and you 
        can't get at the attributes from outside the class without an accessor. 
        (Inside the class you can use the attributes directly.) </li>
    <li> The invocant of the <code>clear</code> method is implicit. </li>
    <li> And perhaps most obviously, Perl 6 uses <code>.</code> instead 
        of <code>-&gt;</code> to dereference an object. </li>
</ul>
<p>Now suppose we want to derive from Point, and add a z-axis. That's just:</p>
<pre><code>
    class Point3d is Point {
        has $:z = 123;
        method clear () { $:z = 0; next; }
    }
    my $point3d = Point3d.new(x =&gt; 2, y =&gt; 3, z =&gt; 4);
    $c = $point3d.z;    # illegal, $:z is invisible</code></pre>
<p>The implicit constructor automatically sorts out the named arguments 
    to the correct initializers for you. If you omit the z value, it will 
    default to 123. And the new <code>clear</code> method calls the old 
    clear method merely by invoking <code>next</code>, without the dodgy 
    "super" semantics that break down under MI. We also declared the <code>$:z</code> 
    attribute to be completely private by using a colon instead of a dot. 
    No accessor for it is visible outside the class. (And yes, OO purists, 
    our other attributes should probably have been private in the first 
    place...that's why we're making it just as easy to write a private attribute 
    as a public one.)</p>
<p>If any of that makes your head spin, I'm sure the following will clear 
    it right up. <code>:-)</code></p>














<p><em>Editor's Note: this Apocalypse is out of date and remains here for historic reasons.  See <a href="http://dev.perl.org/perl6/doc/design/syn/S12.html">Synopsis 12</a> for the latest information.</em></p>

<h3><a name="classes">Classes</a></h3>
<p>A class is what provides a name and a place for the abstract behavior 
    of a set of objects said to belong to the class.</p>
<p>As in Perl 5, a class is still "just a funny package", structurally speaking. 
    Syntactically, however, a class is now distinct from a package or a 
    module. And the body of a class definition now runs in the context of 
    a metaclass, which is just a way of saying that it has a metaclass instance 
    as its (undeclared) invocant. (An "invocant" is what we call the object 
    or class on behalf of which a method is being called.) Hence class definitions, 
    though apparently declarative, are also executing code to build the 
    class definition, and the various declarations within the class are 
    also running bits of code. By convention classes will use a standard 
    metaclass, but that's just convention. (A very strong convention, we 
    hope.)</p>
<p>The primary role of a class is to manage instances, that is, objects. 
    So a class must worry about object creation and destruction, and everything 
    that happens in between. Classes have a secondary role as units of software 
    reuse, in that they can be inherited from or delegated to. However, 
    because this is a secondary role, and because of weaknesses in models 
    of inheritance, composition, and delegation, Perl 6 will split out the 
    notion of software reuse into a separate class-like entity called a 
    "role". Roles are an abstraction mechanism for use by classes that don't 
    care about the secondary aspects of software reuse, or that (looking 
    at it the other way) care so much about it that they want to encapsulate 
    any decisions about implementation, composition, delegation, and maybe 
    even inheritance. Sounds fancy, but just think of them as includes of 
    partial classes, with some safety checks. Roles don't manage objects. 
    They manage interfaces and other abstract behavior (like default implementations), 
    and they help classes manage objects. As such, a role may only be composed 
    into a class or into another role, never inherited from or delegated 
    to. That's what classes are for.</p>
<p>Classes are arranged in an inheritance hierarchy by their "isa" relationships. 
    Perl 6 supports multiple inheritance, but makes it easy to program in 
    a single-inheritance style, insofar as roles make it easy to mix in 
    (or delegate, or parameterize) private implementation details that don't 
    belong in the public inheritance tree.</p>
<p>In those cases where MI is used, there can be ambiguities in the pecking 
    order of classes in different branches. Perl 6 will have a canonical 
    way to disambiguate these, but by design the dispatch policy is separable 
    from inheritance, so that you can change the rules for a given set of 
    classes. (Certainly the rules can change when we call into another language's 
    class hierarchy, for instance.)</p>
<p>Where possible, class names are treated polymorphically, just as method 
    names are. This powerful feature makes it possible to inherit systems 
    of classes in parallel. (These classes might be inner classes, or they 
    might be inner aliases to outer classes.) By making the class names 
    "virtual", the base classes can refer to the appropriate derived classes 
    without knowing their full name. That sounds complicated, but it just 
    means that if you do the normal thing, Perl will call the right class 
    instead of the one you thought it was going to call. <code>:-)</code></p>
<p>(As in C++ culture, we use the term "virtual" to denote a method that 
    dispatched based on the actual runtime type of the object rather than 
    the declared type of the variable. C++ classes have to declare their 
    methods to be virtual explicitly. All of Perl's public methods are virtual 
    implicitly.)</p>
<p>You may derive from any built-in class. For high-level object classes 
    such as <code>Int</code> or <code>Num</code> there are no restrictions 
    on how you derive. For low-level representational classes like <code>int</code> 
    or <code>num</code>, you may not change the representation of the value; 
    you may only add behaviors. (If you want to change the representation, 
    you should probably be using composition instead of inheritance. Or 
    define your own low-level type.) Apart from this, you don't need to 
    worry about the difference between <code>int</code> and <code>Int</code>, 
    or <code>num</code> and <code>Num</code>, since Perl 6 will do autoboxing.</p>
<h4><a name="declaration_of_classes">Declaration of Classes</a></h4>
<p>Class declarations may be either file scoped or block scoped. A file-scoped 
    declaration must be the first thing in the file, and looks like this:</p>
<pre><code>
    class Dog is Mammal;
    has Limb @.paws;
    method walk () { .paws&raquo;.move() }</code></pre>
<p>That has the advantage of avoiding the use of one set of braces, letting 
    you put everything up against left margin. It is otherwise identical 
    to a block-scoped class, which looks like this:</p>
<pre><code>
    class Dog is Mammal {
        has Limb @.paws;
        method walk () { .paws&raquo;.move() }
    }</code></pre>
<p>An incomplete class definition makes use of the <code>...</code> ("yada, 
    yada, yada") operator:</p>
<pre><code>
    class Dog is Mammal {...}</code></pre>
<p>The declaration of a class name introduces the name as a valid bare identifier 
    or name. In the absence of such a declaration, the name of a class in 
    an expression must be introduced with the <code>::</code> class sigil, 
    or it will be considered a bareword and rejected, since Perl 6 doesn't 
    allow barewords. Once the name is declared however, it may be used as 
    an ordinary term in an expression. Unlike in Perl 5, you should not 
    view it as a bareword string. Rather, you should view it as a parameterless 
    subroutine that returns a class object, which conveniently stringifies 
    to the name of the class for Perl 5 compatibility. But when you say</p>
<pre><code>
    Dog.new()</code></pre>
<p>the invocant of <code>new</code> is an object of type <code>Class</code>, 
    not a string as in Perl 5.</p>
<p>Unmodified, a class declaration always declares a global name. But if 
    you prefix it with <code>our</code>, you're defining an inner class:</p>
<pre><code>
    class Cell {
        our class Golgi {...}
        ...
    }</code></pre>
<p>The full name of the inner class is <code>Cell::Golgi</code>, and that 
    name can be used outside of <code>Cell</code>, since <code>Golgi</code> 
    is declared in the <code>Cell</code> package. (Classes may be declared 
    private, however. More later.)</p>
<h5><a name="class_traits">Class traits</a></h5>
<p>A class declaration may apply various traits to the class. (A trait is 
    a property applied at compile time.) When you apply a trait, you're 
    accepting whatever it is that that trait does to your class, which could 
    be pretty much anything. Traits do things <em>to</em> classes. Do not 
    confuse traits with roles, which are sworn to play a subservient role 
    to the class. Traits can do whatever they jolly well please to your 
    class's metadata.</p>
<p>Now, the usual thing to do to a class's metadata is to insert another 
    class into its ISA metadata. So we use trait notation to install a superclass:</p>
<pre><code>
    class Dog is Mammal {...}</code></pre>
<p>To specify multiple inheritance, just add another trait:</p>
<pre><code>
    class Dog is Mammal is Pet {...}</code></pre>
<p>But often you'll want a role instead, specified with <code>does</code>:</p>
<pre><code>
    class Dog is Mammal does Pet {...}</code></pre>
<p>More on that later. But remember that traits are evil. You can have traits 
    like:</p>
<pre><code>
    class Moose is Mammal is stuffed is really(Hatrack) is spy(Russian) {...}</code></pre>
<p>So what if you actually want to derive from <code>stuffed</code>? That's 
    a good question, which we will answer later. (The short answer is, you 
    don't.)</p>
<p>Now as it happens, you can also use <code>is</code> from within the class. 
    You can also put the <code>does</code> inside to include various roles:</p>
<pre><code>
    class Dog {
        is Mammal;
        does Pet;
        does Servant;
        does Best::Friend[Man];
        does Drool;
        ...
    }</code></pre>
<p>In fact, there's no particular reason to put any of these outside the 
    braces except to make them more obvious to the casual reader. If we 
    take the view that inheritance is just one form of implementation, then 
    a simple</p>
<pre><code>
    class Dog {...}</code></pre>
<p>is sufficient to establish that there's a <code>Dog</code> class defined 
    out there somewhere. We shouldn't really care about the implementation 
    of <code>Dog</code>, only its interface--which is usually pretty slobbery.</p>
<p>That being said, you can know more about the interface at compile time 
    once you know the inheritance, so it's good to have pulled in a definition 
    of the class as well as a declaration. Since this is typically done 
    with <code>use</code>, the inheritance tree is generally available even 
    if you don't mark your class declaration externally with the inheritance. 
    (But in any event, the actual inheritance tree doesn't have to be available 
    till runtime, since that's when methods are dispatched. (Though as 
    is often the case, certain optimizations work better when you give them 
    more data earlier...))</p>
<h4><a name="use_of_classes">Use of Classes</a></h4>
<p>A class is used directly by calling class methods, and indirectly by 
    calling methods of an object of that class (or of a derived class that 
    doesn't override the methods in question).</p>
<p>Classes may also be used as objects in their own right, as instances 
    of a metaclass, the class <code>MetaClass</code> by default. When you 
    declare class <code>Dog</code>, you're actually calling a metaclass 
    class method that constructs a metaclass instance (i.e., the <code>Dog</code> 
    class) and then calls the associated closure (i.e., the body of the class) 
    as a method on the instance. (With a little grammatical magic thrown 
    in so that <code>Dog</code> isn't considered a bareword.)</p>
<p>The class <code>Dog</code> is an instance of the class <code>MetaClass</code>, 
    but it's also an instance of the type <code>Class</code> when you're 
    thinking of it as a dispatcher. That is, a class object is really allomorphic. 
    If you treat one as an instance of Class, it behaves as if it were the 
    user's view of the class, and the user thinks the class is there only 
    to dispatch to the user's own class and instance methods. If, however, 
    you treat the object as an instance of <code>MetaClass</code>, you get 
    access to all its metaclass methods rather than the user-defined methods. 
    Another way to look at it is that the metaclass object is a separate 
    object that manages the class object. In any event, you can get from 
    the ordinary class object to its corresponding metaclass object via 
    the <code>.meta</code> method, which every object supports.</p>
<p>By the way, a <code>Class</code> is a <code>Module</code>, which in turn 
    is a <code>Package</code>, which in turn is an <code>Object</code>. Or 
    something like that. So a class can always be used as if it were a mere 
    module or package. But modules and packages don't have a <code>.dispatch</code> 
    method...</p>
<p>By default, classes in Perl are left open. That is, you can add more 
    methods later. (However, an application may close them.) For discussion 
    of this, see the section on "Open vs. Closed Classes".</p>
<h4><a name="class_name_semantics">Class Name Semantics</a></h4>
<p>Class names (and module names) are just package names.</p>
<p>Unlike in Perl 5, when you mention a package name in Perl 6 it doesn't 
    always mean a global name, since Perl 6 knows about inner classes and 
    lexically scoped packages and such. As with other entities in Perl such 
    as variables and methods, a scan is made for who thinks they have the 
    best definition of the name, going out from lexical scopes to package 
    scope to global scope in the case of static class names, and via method 
    inheritance rules in the case of virtual class names.</p>
<p>Note that <code>::MyClass</code> and <code>MyClass</code> mean the same 
    thing. In Perl 6, an initial <code>::</code> is merely an optional sigil 
    for when the name of the package would be misconstrued as something 
    else. It specifically does not mean (as it does in Perl 5) that it is 
    a top-level package. To refer to the top-level package, you would need 
    to say something like <code>::*MyClass</code> (or just <code>*MyClass</code> 
    in places where the <code>*</code> unary operator would not be expected.) 
    But also note that the <code>*</code> package in Perl is not the "<code>main</code>" 
    package in the Perl 5 sense.</p>
<p>Likewise, the presence of <code>::</code> within a package name like 
    <code>Fish::Carp</code> does not make it a global package name necessarily. 
    Again, it scans out through various scopes, and only if no local scopes 
    define package <code>Fish::Carp</code> do you get the global definition. 
    And again, you can force it by saying <code>::*Fish::Carp</code>. (Or 
    just <code>*Fish::Carp</code> in places where the <code>*</code> unary 
    operator is not expected.)</p>
<p>You can interpolate a parenthesized expression within a package name 
    after any <code>::</code>. So, these are all legal package names (or 
    module names, or class names):</p>
<pre><code>
    ::($alice)
    ::($alice)::($bob)
    ::($alice::($bob))
    ::*::($alice)::Bob
    ::('*')::($alice ~ '_misc')::Bob
    ::(get_my_dir())
    ::(@multilevel)</code></pre>
<p>And any of those package names could be part of a variable or sub name:</p>
<pre><code>
    $::($alice)::name
    @::($alice)::($bob)::elems[1,2,3]
    %::*::($alice)::Bob::map{'xyz'}
    &amp;::('*')::($alice ~ '_misc')::Bob::doit(1,2,3)
    $::(get_my_dir())::x
    $::(@multilevel)</code></pre>
<p>Note in the last example that the final element of <code>@multilevel</code> 
    is taken to be the variable name. This may be illegal under <code>use 
    strict refs</code>, since it amounts to a symbolic reference. (Not that 
    the others aren't symbolic, but the rules may be looser for package 
    names than for variable names, depending on how strict our strictures 
    get.)</p>
	
	











<p><em>Editor's Note: this Apocalypse is out of date and remains here for historic reasons.  See <a href="http://dev.perl.org/perl6/doc/design/syn/S12.html">Synopsis 12</a> for the latest information.</em></p>
	
<h4><a name="private_classes">Private Classes</a></h4>
<p>A class named with a single initial colon is a private class name:</p>
<pre><code>
    class :MyPrivateClass {...}</code></pre>
<p>It is completely ignored outside of the current class. Since the name 
    is useful only in the current package, it makes no sense to try to qualify 
    it with a package name. While it's an inner class of sorts, it does 
    not override any class name from any other class because it lives in 
    its own namespace (a subnamespace of the current package), and there's 
    no way to tell if the class you're deriving from declares its own private 
    class of the same name (apart from digging through the reflection interfaces).</p>
<p>The colon is orthogonal to the scoping. What's actually going on in this 
    example is that the name is stored in the package with the leading colon, 
    because the colon is part of the name. But if you declared "<code>my 
    class :Golgi</code>" the private name would go into the lexical namespace 
    with the colon. The colon functions a bit like a "private" trait, but 
    isn't really a trait. Wherever you might use a private name, the colon 
    in the name effectively creates a private subspace of names, just as 
    if you'd prefixed it with "_" in the good old days.</p>
<p>But if were only that, it would just be encapsulation by convention. 
    We're trying to do a little better than that. So the language needs 
    to actively prevent people from accessing that private subspace from 
    outside the class. You might think that that's going to slow down all 
    the dispatchers, but probably not. The ordinary dispatch of <code>Class.method</code> 
    and <code>$obj.method</code> don't have to worry about it, because they 
    use bare identifiers. It's only when people start doing <code>::($class)</code> 
    or <code>$obj.$method</code> that we have to trap illegal references 
    to colonic names.</p>
<p>Even though the initial colon isn't really a trait, if you interrogate 
    the "<code>.private</code>" property of the class, it will return true. 
    You don't have to parse the name to get that info.</p>
<p>We'll make more of this when we talk about private methods and attributes. 
    Speaking of methods...</p>

<h3><a name="methods">Methods</a></h3>
<p>Methods are the actions that a class knows how to invoke on behalf of 
    an object of that type (or on behalf of itself, as a class object). 
    But you knew that already.</p>
<p>As in Perl 5, a method is still "just a funny subroutine", but in Perl 
    6 we use a different keyword to declare it, both because it's better 
    documentation, and because it captures the metadata for the class at 
    compile time. Ordinary methods may be declared only within the scope 
    of a class definition. (Multimethods are exempt from this restriction, 
    however.)</p>
<h4><a name="declaration_of_methods">Declaration of Methods</a></h4>
<p>To declare a method, use the <code>method</code> keyword just as you 
    would use <code>sub</code> for an ordinary subroutine. The declaration 
    is otherwise almost identical:</p>
<pre><code>
    method doit ($a, $b, $c) { ... }</code></pre>
<p>The one other difference is that a method has an <em>invocant</em> on 
    behalf of which the method is called. In the declaration above, that 
    invocant is implicit. (It is implicitly typed to be the same as the 
    current surrounding class definition.) You may, however, explicitly 
    declare the invocant as the first argument. The declaration knows you're 
    doing that because you put a colon between the invocant and the rest 
    of the arguments:</p>
<pre><code>
    method doit ($self: $a, $b, $c) { ... }</code></pre>
<p>In this case, we didn't specify the type of <code>$self</code>, so it's 
    an untyped variable. To make the exact equivalent of the implicit declaration, 
    put the current class:</p>
<pre><code>
    method doit (MyClass $self: $a, $b, $c) { ... }</code></pre>
<p>or more generically using the <code>::_</code> "current class" pronoun:</p>
<pre><code>
    method doit (::_ $self: $a, $b, $c) { ... }</code></pre>
<p>In any case, the method sets the current invocant as the topic, which 
    is also known as the <code>$_</code> variable. However, the topic can 
    change depending on the code inside the method. So you might want to 
    declare an explicit invocant when the meaning of <code>$_</code> might 
    change. (For further discussion of topics see Apocalypse 4. For a small 
    writeup on sub signatures see Apocalypse 6.)</p>
<p>A private method is declared with a colon on the front:</p>
<pre><code>
    method :think (Brain $self: $thought)</code></pre>
<p>Private methods are callable only by the class itself, and by trusted 
    "friends". More about that when we talk about attributes.</p>
<h4><a name="use_of_methods">Use of Methods</a></h4>
<p>As in Perl 5, there are two notations for calling ordinary methods. They 
    are called the "dot" notation and the "indirect object" notation.</p>
<h5><a name="the_dot_notation">The dot notation</a></h5>
<p>Perl 6's "dot" notation is just the industry-standard way to call a method 
    these days. (This used to be <code>-&gt;</code> in Perl 5.)</p>
<pre><code>
    $object.doit(&quot;a&quot;, &quot;b&quot;, &quot;c&quot;);</code></pre>
<p>If the object in question is the current topic, <code>$_</code>, then 
    you can use the unary form of the dot operator:</p>
<pre><code>
    for @objects {
        .doit(&quot;a&quot;, &quot;b&quot;, &quot;c&quot;);
    }</code></pre>
<p>A simple variable may be used for an indirectly named method:</p>
<pre><code>
    my $dosomething = &quot;doit&quot;;
    $object.$dosomething(&quot;a&quot;, &quot;b&quot;, &quot;c&quot;);</code></pre>
<p>As in Perl 5, if you want to do anything fancier, use a temporary variable.</p>
<p>The parentheses may also be omitted when the following code is unambiguously 
    a term or operator, so you can write things like this:</p>
<pre><code>
    @thumbs.each { .twiddle }   # same as @thumbs.each({.twiddle})
    $thumb.twiddle + 1          # same as $thumb.twiddle() + 1
    .mode 1                     # same as $_.mode(1)</code></pre>
<p>(Parens are always required around the argument list when a method call 
    with arguments is interpolated into a string.)</p>
<p>The parser <em>will</em> make use of whitespace at this point to decide 
    some things. For instance</p>
<pre><code>
    $obj.method + 1</code></pre>
<p>is obviously a method with no arguments, while</p>
<pre><code>
    $obj.method +1</code></pre>
<p>is obviously a method with an argument. However, the dwimmery only goes 
    as far as the typical person's visual intuition. Any construct too ambiguous 
    is simply rejected. So</p>
<pre><code>
    $obj.method+1</code></pre>
<p>produces a parse error.</p>
<p>In particular, curlies, brackets, or parens would be interpreted as postfix 
    subscripts or argument lists if you leave out the space. In other words, 
    Perl 6 distinguishes:</p>
<pre><code>
    $obj.method ($x + $y) + $z  # means $obj.method(($x + $y) + $z)</code></pre>
<p>from</p>
<pre><code>
    $obj.method($x + $y) + $z   # means ($obj.method($x + $y)) + $z</code></pre>
<p>Yes, this is different from Perl 5. And yes, I know certain people hate 
    it. They can write their own grammar.</p>
<p>While it's always possible to disambiguate with parentheses, sometimes 
    that is just too unsightly. Many methods want to be parsed as if they 
    were list operators. So as an alternative to parenthesizing the entire 
    argument list, you can disambiguate by putting a colon between the method 
    call and the argument list:</p>
<pre><code>
    @thumbs.each: { .twiddle }  # same as @thumbs.each({.twiddle})
    $thumb.twiddle: + 1         # same as $thumb.twiddle(+ 1)
    .mode: 1                    # same as $_.mode(1)
    $obj.for: 1,2,3 -&gt; $i { ... }</code></pre>
<p>If a method is declared with the trait "<code>is rw</code>", it's an 
    lvalue method, and you can assign to it just as if it were an ordinary 
    variable:</p>
<pre><code>
    method mystate is rw () { return $:secretstate }</code></pre>
<pre><code>
    $object.mystate = 42;
    print $object.mystate;      # prints 42</code></pre>
<p>In fact, it's a general rule that you can use an argumentless "<code>rw</code>" 
    method call anywhere you might use a variable:</p>
<pre><code>
    temp $state.pi = 3;
    $tailref = \$fido.tail;</code></pre>
<p>(Though occasionally you might need to supply parentheses to disambiguate, 
    since the compiler can't always know at compile time whether the method 
    has any arguments.)</p>
<p>Method calls on container objects are obviously directed to the container 
    object itself, not to the contents of the container:</p>
<pre><code>
    $elems = @array.elems;
    @keys  = %hash.keys;
    $sig   = &amp;sub.signature;</code></pre>
<p>However, with scalar variables, methods are always directed to the object 
    pointed to by the reference contained in the scalar:</p>
<pre><code>
    $scalar = @array;           # (implied \ in scalar context)
    $elems = $scalar.elems;     # returns @array.elems</code></pre>
<p>or for value types, the appropriate class is called as if the value were 
    a reference to a "real" object.</p>
<pre><code>
    $scalar = &quot;foo&quot;;
    $chars = $scalar.chars;     # calls Str::chars or some such</code></pre>
<p>In order to talk to the scalar container itself, use the <code>tied()</code> 
    pseudo-function as you would in Perl 5:</p>
<pre><code>
    if tied($scalar).constant {...}</code></pre>
<p>(You may recall, however, that in Perl 6 it's illegal to tie any variable 
    without first declaring it as tie-able, or (preferably) tying it directly 
    in the variable's declaration. Otherwise the optimizer would have to 
    assume that every variable has semantics that are unknowable in advance, 
    and we would have to call it a pessimizer rather than an optimizer.)</p>
	










	

<p><em>Editor's Note: this Apocalypse is out of date and remains here for historic reasons.  See <a href="http://dev.perl.org/perl6/doc/design/syn/S12.html">Synopsis 12</a> for the latest information.</em></p>
	
<h5><a name="the_indirect_object_notation">The "indirect object" notation</a></h5>
<p>The other form of method call is known as the "indirect object" syntax, 
    although it differs from Perl 5's syntax in that a colon is required 
    between the indirect object (the invocant) and its arguments:</p>
<pre><code>
    doit $object: &quot;a&quot;, &quot;b&quot;, &quot;c&quot;</code></pre>
<p>The colon may be omitted if there are no arguments (besides the invocant):</p>
<pre><code>
    twiddle $thumb;
    $x = new X;</code></pre>
<p>Note that indirect object calls may not be directly interpolated into 
    a string, since they don't start with a sigil. You can always use the 
    <code>$()</code> expression interpolater though:</p>
<pre><code>
    say &quot;$(greet $lang), world!&quot;;</code></pre>
<p>As in Perl 5, the indirect object syntax is valid only if you haven't 
    declared a subroutine locally that overrides the method lookup. That 
    was a bit of a problem in Perl 5 since, if there happened to be a <code>new</code> 
    constructor in your class, it would call that instead dispatching to 
    the class you wanted it to. That's much less of a problem in Perl 6, 
    however, because Perl 6 cannot confuse a method declaration with a subroutine 
    declaration. (Which is yet another reason for giving methods their own 
    keyword.)</p>
<p>Another factor that makes indirect objects work better in Perl 6 is that 
    the class name in "<code>new X</code>" is a predeclared object, not 
    a bare identifier. (Perl 5 just had to guess when it saw two bare identifiers 
    in a row that you were trying to call a class method.)</p>
<p>The indirect object syntax may not be used with a variable for the methodname. 
    You must use dot notation for that.</p>
<p>Because of precedence, the indirect object notation may not be used as 
    an lvalue unless you parenthesize it:</p>
<pre><code>
    (mystate $object) = 42;
    (findtail Dog: &quot;fido&quot;) = Wagging::on;</code></pre>
<p>You may parenthesize an argumentless indirect object method to make it 
    look like a function:</p>
<pre><code>
    mystate($object) = 42;
    twiddle($thumb);</code></pre>
<p>The dispatch rules for methods and global multi subs conspire to keep 
    these unambiguous, so the user really doesn't have to worry about whether</p>
<pre><code>
    close($handle);</code></pre>
<p>is implemented as a global multi sub or a method on a <code>$handle</code> 
    object. In essence, the multimethod dispatching rules degenerate to 
    ordinary method dispatch when there are no extra arguments to consider 
    (and sometimes even when there are arguments). This is particularly 
    important because Perl uses these rules to tell the difference between</p>
<pre><code>
    print &quot;Howdy, world!\n&quot;;    # global multi sub</code></pre>
<p>and</p>
<pre><code>
    print $*OUT;                # ordinary filehandle method</code></pre>
<p>However, you must still put the colon after the invocant if there are 
    other arguments. The colon tells the parser whether to look for the 
    arguments inside:</p>
<pre><code>
    doit($object: &quot;a&quot;, &quot;b&quot;, &quot;c&quot;)</code></pre>
<p>or outside:</p>
<pre><code>
    doit($object): &quot;a&quot;, &quot;b&quot;, &quot;c&quot;</code></pre>
<p>If you do say</p>
<pre><code>
    doit($object, &quot;a&quot;, &quot;b&quot;, &quot;c&quot;)</code></pre>
<p>the first comma forces it to be interpreted as a sub call rather than 
    a method call.</p>
<p>(We could have decided to say that whenever Perl can't find a <code>doit()</code> 
    sub definition at runtime, it should assume you meant the entire parenthesized 
    list to be the indirect object, which, since it's in scalar context 
    would automatically generate a list reference and call <code>[$object,&quot;a&quot;,&quot;b&quot;,&quot;c&quot;].doit()</code>, 
    which is unlikely to be what you mean, or even work. (Unless, of course, 
    that's how you really meant it to work.) But I think it's much more 
    straightforward to simply disallow comma lists at the top level of an 
    indirect object. The old "if it looks like a function" rule applies 
    here. Oddly, though, function syntax is how you call multisubs in Perl 
    6. And as it happens, the way the multisub/multimethod dispatch rules 
    are defined, it could still end up calling <code>$object.doit(&quot;a&quot;, 
    &quot;b&quot;, &quot;c&quot;)</code> if that is deemed to be the best 
    choice among all the candidates. But syntactically, it's not an indirect 
    object. More on dispatch rule interactions later.)</p>
<p>The comma still doesn't work if you go the other way and leave out the 
    parens entirely, since</p>
<pre><code>
    doit $object, &quot;a&quot;, &quot;b&quot;, &quot;c&quot;;</code></pre>
<p>would always (in the absence of a prior sub declaration) be parsed as</p>
<pre><code>
    (doit $object:), &quot;a&quot;, &quot;b&quot;, &quot;c&quot;;</code></pre>
<p>So a print with both an indirect object and arguments has to look like 
    one of these:</p>
<pre><code>
    print $*OUT: &quot;Howdy, world!\n&quot;;
    print($*OUT: &quot;Howdy, world!\n&quot;);
    print($*OUT): &quot;Howdy, world!\n&quot;;</code></pre>
<p>Note that the old Perl 5 form using curlies:</p>
<pre><code>
    print {some_hairy_expression()} &quot;Howdy, world!\n&quot;;</code></pre>
<p>should instead now be written with parentheses:</p>
<pre><code>
    print (some_hairy_expression()): &quot;Howdy, world!\n&quot;;</code></pre>
<p>though, in fact, in this case the parens are unnecessary:</p>
<pre><code>
    print some_hairy_expression(): &quot;Howdy, world!\n&quot;;</code></pre>
<p>You'd only need the parens if the invocant expression contained operators 
    lower in precedence than comma (comma itself not being allowed). Basically, 
    if it looks confusing to you, you can expect it to look confusing to 
    the compiler, and to make the compiler look confused. But it's a feature 
    for the compiler to look confused when it actually <em>is</em> confused. 
    (In Perl 5 this was not always so.)</p>
<p>Note that the disambiguating colon associates with the closest method 
    call, whether direct or indirect. So</p>
<pre><code>
    print $obj.meth: &quot;Howdy, world!\n&quot;;</code></pre>
<p>passes "<code>Howdy, world!\n</code>" to <code>$obj.meth</code> rather 
    than to <code>print</code>. That's a case where you ought to have parenthesized 
    the indirect object for clarity anyway:</p>
<pre><code>
    print ($obj.meth): &quot;Howdy, world!\n&quot;;</code></pre>
<h5><a name="calling_private_methods">Calling private methods</a></h5>
<p>A private method does not participate in normal method dispatch. It is 
    not listed in the class's public methods. The <code>.can</code> method 
    does not see it. Calling it via normal dispatch raises a "no such method" 
    exception. It is, in essence, invisible to the outside world. It does 
    not hide a base class's method of the same name--even in the current 
    class! It's fair to ask for warnings about name collisions, of course. 
    But we're not following the C++ approach of making private methods visible 
    but uncallable, because that would violate encapsulation, and in particular, 
    <a href="http://en.wikipedia.org/wiki/Liskov_substitution_principle">Liskov 
    substitutability</a>. Instead, we separate the namespaces completely 
    by distinguishing the public dot operator from the private dot-colon 
    operator. That is:</p>
<pre><code>
    $mouth.say(&quot;Yes!&quot;)          # always calls public .say method
          .say(&quot;Yes!&quot;)          # unary form
    $brain.:think(&quot;No!&quot;)        # always calls private :think method
          .:think(&quot;No!&quot;)        # unary form</code></pre>
<p>The inclusion of the colon prevents any kind of "virtual" behavior. Calling 
    a private method is illegal except under two very specific conditions. 
    You can call a private method <code>:think</code> on an object <code>$brain</code> 
    only if:</p>
<ol>
    <li> The class of <code>$brain</code> is explicitly declared, and the 
        declared class is either the class definition that we are in or 
        a class that has explicitly granted trust to our current class, 
        and the declared class contains a private <code>:think</code> method. 
        Or...</li>
    <li> The class of the <code>$brain</code> is not declared, and the current 
        class contains a private <code>:think</code> method.</li>
</ol>
<p>The upshot of these rules is that a private method call is essentially 
    a subroutine call with a method-like syntax. But the private method 
    we're going to call can be determined at compile time, just like a subroutine.</p>

<h3><a name="class_methods">Class Methods</a></h3>
<p>Class methods are called on the class as a whole rather than on any particular 
    instance object of the class. They are distinguished from ordinary methods 
    only by the declared type of the invocant. Since an implicit invocant 
    would be typed as an object of the class and not as the class itself, 
    the invocant declaration is <em>not</em> optional in a class method 
    declaration if you wish to specify the type of the invocant. (Untyped 
    explicit invocants are allowed to "squint", however.)</p>
<h4><a name="class_invocant">Class Invocant</a></h4>
<p>To declare an ordinary class method, such as a constructor, you say something 
    like:</p>
<pre><code>
    method new (Class $class: *@args) { ... }</code></pre>
<p>Such a method may only be called with an invocant that "isa" <code>Class</code>, 
    that is, an object of type <code>Class</code>, or derived from type 
    <code>Class</code>.</p>
<h4><a name="class|object_invocant">Class|Object Invocant</a></h4>
<p>It is possible to write a method that can be called with an invocant 
    that is either a <code>Class</code> or an object of that current class. 
    You can declare the method with a type junction:</p>
<pre><code>
    method new (Class|Dog $classorobj: *@args) { ... }</code></pre>
<p>Or to be completely non-specific, you can leave out the type entirely:</p>
<pre><code>
    method new ($something: *@args) { ... }</code></pre>
<p>That's not as dangerous as it looks, since almost by definition the dispatcher 
    only calls methods that are consistent with the inheritance tree. You 
    just can't say:</p>
<pre><code>
    method new (*@args) { ... }</code></pre>
<p>which would be the equivalent of:</p>
<pre><code>
    method new (Dog $_: *@args) { ... }</code></pre>
<p>Well, actually, you <em>could</em> say that, but it would require that 
    you have an existing <code>Dog</code>-compatible object in order to 
    create a new one. And that could present a little bootstrapping problem...</p>
<p>(Though it could certainly cure the boot chewing problem...)</p>
<p>But in fact, you'll rarely need to declare <code>new</code> method at 
    all, because Perl supplies a default constructor to go with your class.</p>

<h3><a name="submethods">Submethods</a></h3>
<p>Some methods are intended to be inherited by derived classes. Others 
    are intended to be reimplemented in every class, or in every class that 
    doesn't want the default method. We call these "submethods", because 
    they work a little like subs, and a little like methods. (You can also 
    read the "sub" with the meaning it has in words like "subhuman".)</p>
<p>Typically these are (sub)methods related to the details of construction 
    and destruction of the object. So when you call a constructor, for instance, 
    it ends up calling the <code>BUILDALL</code> initialization routine 
    for the class, which ends up calling the <code>BUILD</code> submethod:</p>
<pre><code>
    submethod BUILD ($a, $b, $c) {
        $.a = $a;
        $.b = $b;
        $.c = $c;
    }</code></pre>
<p>Since the submethod is doing things that make sense only in the context 
    of the current class (such as initializing attributes), it makes no 
    sense for <code>BUILD</code> to be inherited. Likewise <code>DESTROY</code> 
    is also a submethod.</p>
<p>Why not just make them ordinary subs, then? Ordinary subs can't be called 
    by method invocation, and we want to call these routines that way. Furthermore, 
    if your base class <em>does</em> define an ordinary method named <code>BUILD</code> 
    or <code>DESTROY</code>, it can serve as the default <code>BUILD</code> 
    or <code>DESTROY</code> for all derived classes that don't declare their 
    own submethods. (All public methods are virtual in Perl, but some are 
    more virtual than others.)</p>
<p>You might be saying to yourself, "Wait, private methods aren't virtual. 
    Why not just use a private method for this?" It's true that private 
    methods aren't virtual, because they aren't in fact methods at all. 
    They're just ordinary subroutines in disguise. They have nothing to 
    do with inheritance. By contrast, submethods are all about presenting 
    a unified inherited <em>interface</em> with the option of either inheriting 
    or not inheriting the <em>implementation</em> of that interface, at 
    the discretion of the class doing the implementing.</p>
<p>So the bottom line is that submethods allow you to override an inherited 
    implementation for the current class without overriding the default 
    implementation for other classes. But in any case, it's still using 
    a public interface, called as an ordinary method call, from anywhere 
    in your program that has an object of your type.</p>
<p>Or a class of your type. The default <code>new</code> constructor is 
    an ordinary class method in class <code>Object</code>, so it's inherited 
    by all classes that don't define their own <code>new</code>. But when 
    you write your own <code>new</code>, you need to decide whether your 
    constructor should be inherited or not. If so, that's good, and you 
    should declare it as a method. But if not, you should declare it as 
    a submethod so that derived classes don't try to use it erroneously 
    instead of the default <code>Object.new()</code>.</p>














<p><em>Editor's Note: this Apocalypse is out of date and remains here for historic reasons.  See <a href="http://dev.perl.org/perl6/doc/design/syn/S12.html">Synopsis 12</a> for the latest information.</em></p>

<h3><a name="attributes">Attributes</a></h3>
<p>In Perl 6, "attributes" are what we call the instance variables of an 
    object. (We used that word to mean something else in Perl 5--we're now 
    calling those things "traits" or "properties".)</p>
<p>As with classes and methods, attribute declarations are apparently declarative. 
    Underneath they actually call a method in the metaclass to install the 
    new definition. The Perl 6 implementation of attributes is not based 
    on a hash, but on something more like a symbol table. Attributes are 
    stored in an opaque datatype rather like a struct in C, or an array 
    in Perl 5--but you don't know that. The datatype is opaque in the sense 
    that you shouldn't care how it's laid out in memory (unless you have 
    to interface with an outside data structure--like a C struct). Do not 
    confuse opacity with encapsulation. Encapsulation only hides the object's 
    implementation from the outside world. But the object's structure is 
    opaque even to the class that defines it.</p>
<p>One of the large benefits of this is that you can actually take a C or 
    C++ data structure and wrap accessor methods around it without having 
    to copy anything into a different data structure. This should speed 
    up things like XML parsing.</p>
<h4><a name="declaration_of_attributes">Declaration of Attributes</a></h4>
<p>In order to provide this opaque abstraction layer, attributes are not 
    declared as a part of any other data structure. Instead, they are modeled 
    on real variables, whose storage details are implicitly delegated to 
    the scope in which they are declared. So attributes are declared as 
    if they were normal variables, but with a strange scope and lifetime 
    that is neither <code>my</code> nor <code>our</code>. (That scope is, 
    of course, the current object, and the variable lives as long as the 
    object lasts.) The class will implicitly store those attributes in a 
    location distinct from any other class's attributes of the same name, 
    including any base or derived class. To declare an attribute variable, 
    declare it within the class definition as you would a <code>my</code> 
    variable, but use the <code>has</code> declarator instead of <code>my</code>:</p>
<pre><code>
    class Dog is Mammal {
        has $.tail;
        has @.legs;
        ...
    }</code></pre>
<p>The <code>has</code> declarator was chosen to remind people that attributes 
    are in a "HASA" relationship to the object rather than an "ISA" relationship.</p>
<p>The other difference from normal variables is that attributes have a 
    secondary sigil that indicates that they are associated with methods. 
    When you declare an attribute like <code>$.tail</code>, you're also 
    implicitly declaring an accessor method of the same name, only without 
    the <code>$</code> on the front. The dot is there to remind you that 
    it's also a method call.</p>
<p>As with other declarations, you may add various traits to an attribute:</p>
<pre><code>
    has $.dogtag is rw;</code></pre>
<p>If you want all your attributes to default to "<code>rw</code>", you 
    can put the attribute on the class itself:</p>
<pre><code>
    class Coordinates is rw {
        has int $.x;
        has int $.y;
        has int $.z;
    }</code></pre>
<p>Essentially, it's now a C-style struct, without having to introduce an 
    ugly word like "struct" into the language. Take that, C++. <code>:-)</code></p>
<p>You can also assign to a declaration:</p>
<pre><code>
    has $.master = &quot;TheDamian&quot;;</code></pre>
<p>Well, actually, this looks like an assignment, but it isn't. The effect 
    of this is to establish a default; it is not executed at runtime. (Or 
    more precisely, it runs when the class closure is executed by the metaclass, 
    so it gets evaluated only once and the value is stored for later use 
    by real instances. More below.)</p>
<h4><a name="use_of_attributes">Use of Attributes</a></h4>
<p>The attribute behaves just like an ordinary variable within the class's 
    instance methods. You can read and write the attributes just like ordinary 
    variables. (It is, however, illegal to refer to an instance attribute 
    variable (that is, a "<code>has</code>" variable) from within a class 
    method. Class methods may only access class attributes, not instance 
    attributes. See below.)</p>
<p>Bare attributes are automatically hidden from the outside world because 
    their sigiled names cannot be seen outside the class's package. This 
    is how Perl 6 enforces encapsulation. Outside the class the <em>only</em> 
    way to talk about an attribute is through accessor methods. Since public 
    methods are always virtual in Perl, this makes attribute access virtual 
    outside the class. Always. (Unless you give the optimizer enough hints 
    to optimize the class to "final". More on that later.)</p>
<p>In other words, only the class itself is allowed to know whether this 
    attribute is, in fact, implemented by this class. The class may also 
    choose to ignore that fact, and call the abstract interface, that is, 
    the accessor method, in which case it might actually end up calling 
    some derived class's overriding method, which might in turn call back 
    to this class's accessor as a super method. (So in general, an accessor 
    method should always refer to its actual variable name rather than the 
    accessor method name to avoid infinite recursion.)</p>
<p>You may write your own accessor methods around the bare attributes, but 
    if you don't, Perl will generate them for you based on the declaration 
    of the attribute variable. The traits of the generated method correspond 
    directly to the traits on the variable.</p>
<p>By default, a generated accessor is read-only (because by default any 
    method is read-only). If you mark an attribute with the trait "<code>is 
    rw</code>" though, the corresponding generated accessor will also be 
    marked "<code>is rw</code>", meaning that it can be used as an lvalue.</p>
<p>In any event, even without "<code>is rw</code>" the attribute variable 
    is always writable within the class itself (unless you apply the trait 
    <code>is constant</code> to it).</p>
<p>As with private classes and methods, attributes are declared private 
    using a colon on the front of their names. As with any private method, 
    a private accessor is completely ignored outside its class (or, by extension, 
    the classes trusted by this class).</p>
<p>To carry the separate namespace idea through, we incorporate the colon 
    as the secondary sigil in declarations of private attributes:</p>
<pre><code>
    has $:x;</code></pre>
<p>Then we can get rid of the verbose <code>is private</code> altogether. 
    Well, it's still there as a trait, but the colon implies it, and is 
    required anyway.) And we basically force people to document the private/public 
    distinction every place they reference <code>$:x</code> instead of <code>$.x</code>, 
    or <code>$obj.:meth</code> instead of <code>$obj.meth</code>.</p>
<p>We've seen secondary sigils before in earlier Apocalypses. In each case 
    they're associated with a bizarre usage of some sort. So far we have:</p>
<pre><code>
    $*foo       # a truly global global (in every package)
    $?foo       # a regex-scoped variable
    $^foo       # an autodeclared parameter variable
    $.foo       # a public attribute
    $:foo       # a private attribute</code></pre>
<p>As a form of the dreaded "Hungarian notation", secondary sigils are not 
    introduced lightly. We define secondary sigils only where we deem instant 
    recognizability to be crucial for readability. Just as you should never 
    have to look at a variable and guess whether it's a true global, you 
    should never have to look at a method and guess which variables are 
    attributes and which ones are variables you just happen to be in the 
    lexical scope of. Or which attributes are public and which are private. 
    In Perl 6 it's always obvious--at the cost of a secondary sigil.</p>
<p>We do hereby solemnly swear to never, never, ever add tertiary sigils. 
    You have been warned.</p>
<h4><a name="default_values">Default Values</a></h4>
<p>You can set default values on attributes by pseudo-assignment to the 
    attribute declaration:</p>
<pre><code>
    has Answer $.ans = 42;</code></pre>
<p>These default values are associated as "<code>build</code>" traits of 
    the attribute declaration object. When the <code>BUILD</code> submethod 
    is initializing a new object, these prototype values are used for uninitialized 
    attributes. The expression on the right is evaluated immediately at 
    the point of declaration, but you can defer evaluation by passing a 
    closure, which will automatically be evaluated at the actual initialization 
    time. (Therefore, to initialize to a closure value, you have to put 
    a closure in a closure.)</p>
<p>Here's the difference between those three approaches. Suppose you say:</p>
<pre><code>
    class Hitchhiker {
        my $defaultanswer = 0;
        has $.ans1 = $defaultanswer;
        has $.ans2 = { $defaultanswer };
        has $.ans3 = { { $defaultanswer } };
        $defaultanswer = 42;
        ...
    }</code></pre>
<p>When the object is eventually constructed, <code>$.ans1</code> will be 
    initialized to <code>0</code>, while <code>$.ans2</code> will be initialized 
    to 42. (That's because the closure binds <code>$defaultanswer</code> 
    to the current variable, which still presumably has the value 42 by 
    the time the <code>BUILD</code> routine initializes the new object, 
    even though the lexical variable "<code>$defaultanswer</code>" has supposedly 
    gone out of scope by the time the object is being constructed. That's 
    just how closures work.)</p>
<p>And <code>$.ans3</code> will be initialized not to 42, but to a closure 
    that, if you ever call it, will also return 42. So since the accessor 
    <code>$obj.ans3()</code> returns that closure, <code>$obj.ans3().()</code> 
    will return 42.</p>
<p>The default value is actually stored under the "<code>build</code>" trait, 
    so this:</p>
<pre><code>
    has $.x = calc($y);</code></pre>
<p>is equivalent to this:</p>
<pre><code>
    has $.x is build( calc($y) );</code></pre>
<p>and this:</p>
<pre><code>
    has $.x = { calc($y) };</code></pre>
<p>is equivalent to either of these:</p>
<pre><code>
    has $.x is build( { calc($y) } );
    has $.x will build { calc($y) };</code></pre>
<p>As with all closure-valued container traits, the container being declared 
    (the <code>$.x</code> variable in this case) is passed as the topic 
    to the closure (in addition to being the target that will be initialized 
    with the result of the closure, because that's what <code>build</code> 
    does). In addition to the magical topic, these build traits are also 
    magically passed the same named arguments that are passed to the <code>BUILD</code> 
    routine. So you could say</p>
<pre><code>
    has $.x = { calc($^y) };</code></pre>
<p>to do a calculation based on the <code>:y(582)</code> parameter originally 
    passed to the constructor. Or rather, that will be passed to the constructor 
    someday when the object is eventually constructed. Remember we're really 
    still at class construction time here.</p>
<p>As with other initializers, you can be more specific about the time at 
    which the default value is constructed, as long as that time is earlier 
    than class construction time:</p>
<pre><code>
    has $.x = BEGIN { calc() }
    has $.x = CHECK { calc() }
    has $.x = INIT  { calc() }
    has $.x = FIRST { calc() }
    has $.x = ENTER { calc() }</code></pre>
<p>which are really just short for:</p>
<pre><code>
    has $.x is build( BEGIN { calc() } )
    has $.x is build( CHECK { calc() } )
    has $.x is build( INIT  { calc() } )
    has $.x is build( FIRST { calc() } )
    has $.x is build( ENTER { calc() } )</code></pre>













<p><em>Editor's Note: this Apocalypse is out of date and remains here for historic reasons.  See <a href="http://dev.perl.org/perl6/doc/design/syn/S12.html">Synopsis 12</a> for the latest information.</em></p>

<h3><a name="class_attributes">Class Attributes</a></h3>
<p>In general, class attributes are just package or lexical variables. If 
    you define a package variable with a dot or colon, it autogenerates 
    an accessor for you just as it does for an ordinary attribute:</p>
<pre><code>
    our $.count;        # generates a public read-only .count accessor
    our %:cache is rw;  # generates a private read-write .:cache accessor</code></pre>
<p>The implicit invocant of these implicit accessors has a "squinting" type--it 
    can either be the class or an object of the class. (Declare your own 
    accessors if you have a philosophical reason for forcing the type one 
    way or the other.)</p>
<p>The disadvantage of using "<code>our</code>" above is that both 
    of these are accessible from outside the class via their package name 
    (though the private one is Officially Ignored, and cannot be named simply 
    by saying <code>%MyClass:::cache</code> because that syntax is specifically 
    disallowed).</p>
<p>If on the other hand you declare your class variables lexically:</p>
<pre><code>
    my $.count;         # generates a read-only .count accessor
    my %:cache is rw;   # generates a read-write .:cache accessor</code></pre>
<p>then the same pair of accessors are generated, but the variables themselves 
    are visible only within the class block. If you reopen the class in 
    another block, you can only see the accessors, not the bare variables. 
    This is probably a feature.</p>
<p>Generally speaking, though, unless you want to provide public accessors 
    for your class attributes, it's best to just declare them as ordinary 
    variables (either <code>my</code> or <code>state</code> variables) to 
    prevent confusion with instance attributes. It's a good policy not to 
    declare any public accessors until you know you need them. They are, 
    after all, part of your contract with the outside world, and the outside 
    world has a way of holding you to your contracts.</p>

<h3><a name="object_construction">Object Construction</a></h3>
<p>The basic idea here is to remove the drudgery of creating objects. In 
    addition we want object creation and cleanup to work right by default. 
    In Perl 5 it's possible to make recursive construction and destruction 
    work, but it's not the default, and it's not easy.</p>
<p>Perl 5 also confused the notions of constructor and initializer. A constructor 
    should create a new object once, then call all the appropriate initializers 
    in the inheritance tree without recreating the object. The initializer 
    for a base class should be called before the initializer for any class 
    derived from it.</p>
<p>The initializer for a class is always named <code>BUILD</code>. It's 
    in uppercase because it's usually called automatically for you at construction 
    time.</p>
<p>As with Perl 5, a constructor is only named "<code>new</code>" by convention, 
    and you can write a constructor with any name you like. However, in 
    Perl 6, if you do not supply a "<code>new</code>" method, a generic 
    one will be provided (by inheritance from <code>Object</code>, as it 
    happens).</p>
<h4><a name="the_default_constructor">The Default Constructor</a></h4>
<p>The default <code>new</code> constructor looks like this:</p>
<pre><code>
    multi method new (Class $class: *%_) {
        return $class.bless(0, *%_);
    }</code></pre>
<p>The arguments for the default constructor are always named arguments, 
    hence the <code>*%_</code> declaration to collect all those pairs and 
    pass them on to bless.</p>
<p>You'll note also that <code>bless</code> is no longer a subroutine but 
    a method call, so it's now impossible to omit the class specification. 
    This makes it easier to inherit constructors. You can still bless any 
    reference you could bless in Perl 5, but where you previously used a 
    function to do that: </p>
<pre><code>

    # Perl 5 code...
    return bless( {attr =&gt; &quot;hi&quot;}, $class );</code></pre>
<pre><code>

in Perl 6 you use a method call:</code></pre>
<pre><code>

    # Perl 6 code...
    return $class.bless( {attr =&gt; &quot;hi&quot;} );</code></pre>
<p>However, if what you pass as the first argument isn't a reference, <code>bless</code> 
    is going to construct an opaque object and initialize it. In a sense, 
    <code>bless</code> is the only real constructor in Perl 6. It first 
    makes sure the data structure is created. If you don't supply a reference 
    to bless, it calls <code>CREATE</code> to create the object. Then it 
    calls <code>BUILDALL</code> to call all the initializers.</p>
<p>The signature of <code>bless</code> is something like:</p>
<pre><code>
    method bless ($class: $candidate, *%_)</code></pre>
<p>The <code>0</code> candidate indicates the built-in opaque type. If you're 
    really strange in the head, you can think of the "<code>0</code>" as 
    standing for "<code>0paque</code>". Or it's the "zero" object, about 
    which we know zip. Whatever tilts your windmill...</p>
<p>In any event, strings are reserved for other object layouts. We could 
    conceivably have things like:</p>
<pre><code>
    return $class.bless(&quot;Cstruct&quot;, *%_);</code></pre>
<p>So as it happens, <code>0</code> is short for the layout "P6opaque".</p>
<p>Any additional arguments to <code>.bless</code> are automatically passed 
    on to <code>CREATE</code> and <code>BUILDALL</code>. But note that these 
    <em>must</em> be named arguments. It could be argued that the <em>only</em> 
    real purpose for writing a <code>.new</code> constructor in Perl 6 is 
    to translate different positional argument signatures into a unified 
    set of named arguments. Any other initialization common to all constructors 
    should be done within <code>BUILD</code>.</p>
<p>Oh, the invocant of <code>.bless</code> is either a class or an object 
    of the class, but if you use an object of the class, the contents of 
    that object are <em>not</em> automatically used to prototype the new 
    object. If you wish to do that, you have to do it explicitly by copying 
    the attributes:</p>
<pre><code>
    $obj.bless(0, *%$obj)</code></pre>
<p>(That is just a specific application of the general principle that if 
    you treat any object like a hash, it will behave like one, to the extent 
    that it can. That is, <code>%$obj</code> turns the attributes into key/value 
    pairs, and passes those as arguments to initialize the new object. Note 
    that <code>%$obj</code> includes the private attributes when used inside 
    the class, but not outside.)</p>
<p>Just because <code>.bless</code> allows an object to be used for a class 
    doesn't mean your <code>new</code> constructor has to do the same. Some 
    folks have philosophical issues with mixing up classes and objects, 
    and it's fine to disallow that on the constructor level. In fact, you'll 
    note that the default <code>.new</code> above requires a <code>Class</code> 
    as its invocant. Unless you override it, it doesn't allow an object 
    for the constructor invocant. Go thou and don't likewise.</p>
<h5><a name="the_default_cloner">The default cloner</a></h5>
<p>Another good reason not to overload <code>.new</code> to do cloning is 
    that Perl will also supply a default <code>.clone</code> routine that 
    works something like this:</p>
<pre><code>
    multi method clone ($proto: *%_) {
        return $proto.bless(0, *%_, *%$proto);
    }</code></pre>
<p>Note the order of the two hash arguments to <code>bless</code>. This 
    gives the supplied attribute values precedence over the copied attribute 
    values, so that you can change some of the attributes <em>en passant</em>, 
    if you like. That's because we're passing the two flattened hashes as 
    arguments to <code>.bless</code> and Perl 6's named argument binding 
    mechanism always picks the <em>first</em> argument that matches, not 
    the last. This is opposite of what happens when you use the Perl 5 idiom:</p>
<pre><code>
    %newvals = (%_, %$proto);</code></pre>
<p>In that case, the <em>last</em> value (the one in %$proto) would "win".</p>
<h4><a name="create">CREATE</a></h4>
<pre><code>
    submethod CREATE ($self: *%args) {...}</code></pre>
<p><code>CREATE</code> is called when you don't want to use an existing 
    data structure as the candidate for your object. In general you won't 
    define <code>CREATE</code> because the default <code>CREATE</code> does 
    all the heavy magic to bring an opaque object into existence. But if 
    you don't want an opaque object, and you don't care to write all your 
    constructors to create the data structure before calling <code>.bless</code>, 
    you can define your own <code>CREATE</code> submethod, and it will override 
    the standard one for all constructors in the class.</p>
<h4><a name="buildall">BUILDALL</a></h4>
<pre><code>
    submethod BUILDALL ($self: *%args) {...}</code></pre>
<p>After the data structure is created, it must be populated by each of 
    the participating classes (and roles) in the proper order. The <code>BUILDALL</code> 
    method is called upon to do this. The default <code>BUILDALL</code> 
    is usually correct, so you don't generally have to override it. In essence, 
    it delegates the initialization of parent classes to the <code>BUILDALL</code> 
    of the parent classes, and then it calls <code>BUILD</code> on the current 
    class. In this way the pieces of the object are assembled in the correct 
    order, from least derived to most derived.</p>
<p>For each class <code>BUILDALL</code> calls on, if the arguments contain 
    a pair whose key is that class name, it passes the value of the pair 
    as its argument to that class's <code>BUILDALL</code>. Otherwise it 
    passes the entire list. (There's not much ambiguity there--most classes 
    and roles will start with upper case, while most attribute names start 
    with lower case.)</p>
<h4><a name="build">BUILD</a></h4>
<pre><code>
    submethod BUILD ($self: *%args) {...}</code></pre>
<p>That is the generic signature of <code>BUILD</code> from the viewpoint 
    of the caller, but the typical <code>BUILD</code> routine declares explicit 
    parameters named after the attributes:</p>
<pre><code>
    submethod BUILD (+$tail, +@legs, *%extraargs) {
        $.tail = $tail;
        @:legs = @legs;
        ...
    }</code></pre>
<p>That occurs so frequently that there's a shorthand available in the signature 
    declaration. You can put the attributes (distinguished by those secondary 
    sigils, you'll recall) right into the signature. The following means 
    essentially the same thing, without repeating the names:</p>
<pre><code>
    submethod BUILD (+$.tail, +@:legs, *%extraargs) {...}</code></pre>
<p>It's actually unnecessary to declare the <code>*%extraargs</code> parameter. 
    If you leave it out, it will default to <code>*%_</code> (but only on 
    methods and submethods--see the section on Interface Consistency later).</p>
<p>You may use this special syntax only for instance attributes, not class 
    attributes. Class attributes should generally not be reinitialized every 
    time you make a new object, after all.</p>
<p>If you do not declare a <code>BUILD</code> routine, a default routine 
    will be supplied that initializes any attributes whose names correspond 
    to the keys of the argument pairs passed to it, and leaves the other 
    attributes to default to whatever the class supplied as the default, 
    or <code>undef</code> otherwise.</p>
<p>In any event, the assignment of default attribute values happens automatically. 
    For any attribute that is not otherwise initialized, the attribute declaration's 
    "<code>build</code>" property is evaluated and the resulting value copied 
    in to the newly created attribute slot. This happens logically at the 
    end of the <code>BUILD</code> block, so we avoid running initialization 
    closures unnecessarily. This implicit initialization is based not on 
    whether the attribute is undefined, but on whether it was initialized 
    earlier in <code>BUILD</code>. (Otherwise we could never explicitly 
    create an attribute with an undefined value.)</p>
	










	

<p><em>Editor's Note: this Apocalypse is out of date and remains here for historic reasons.  See <a href="http://dev.perl.org/perl6/doc/design/syn/S12.html">Synopsis 12</a> for the latest information.</em></p>
	
<h4><a name="eliminating_redundancy_in_constructor_calls">Eliminating Redundancy 
    in Constructor Calls</a></h4>
<p>If you say:</p>
<pre><code>
    my Dog $spot = Dog.new(...)</code></pre>
<p>you have to repeat the type. That's not a big deal for a small typename, 
    but sometime typenames are a lot longer. Plus you'd like to get rid 
    of the redundancy, just because it's, like, redundant. So there's a 
    variant on the dot operator that looks a lot like a dot assignment operator:</p>
<pre><code>
    my Dog $spot .= new(...)</code></pre>
<p>It doesn't really quite fit the assignment operator rule though. If it 
    did, it'd have to mean:</p>
<pre><code>
    my Dog $spot = $spot.new(...)</code></pre>
<p>which doesn't quite work, because <code>$spot</code> is undefined. What 
    probably happens is that the <code>my</code> cheats and puts a version 
    of <code>undef</code> in there that knows it should dispatch to the 
    <code>Dog</code> class if you call <code>.self:new()</code> on it. Anyway, 
    we'll make it work one way or another, so that it becomes the equivalent 
    of:</p>
<pre><code>
    my Dog $spot = Dog.new(...)</code></pre>
<p>The alternative is to go the C++ route and make <code>new</code> a reserved 
    word. We're just not going to do that.</p>
<p>Note that an attribute declaration of the form</p>
<pre><code>
    has Tail $wagger .= new(...)</code></pre>
<p>might not do what you want done when you want it done, if what you want 
    done is to create a new <code>Dog</code> object each time an object 
    is built. For that you'd have to say:</p>
<pre><code>
    has Tail $wagger = { .new(...) }</code></pre>
<p>or equivalently,</p>
<pre><code>
    has Tail $wagger will build { .new(...) }</code></pre>
<p>But leaving aside such timing issues, you should generally think of the 
    <code>.=</code> operator more as a variant on <code>.</code> than a 
    variant on <code>+=</code>. It can, for instance, turn any non-mutating 
    method call into a mutating method:</p>
<pre><code>
    @array.=sort;       # sort @array in place
    .=lc;               # lowercase $_ in place</code></pre>
<p>This presumes, of course, that the method's invocant and return value 
    are of compatible types. Some classes will wish to define special in-place 
    mutators. The syntax for that is:</p>
<pre><code>
    method self:sort (Array @a is rw) {...}</code></pre>
<p>It is illegal to use <code>return</code> from such a routine, since the 
    invocant is automatically returned. If you do not declare the invocant, 
    the default invocant is automatically considered "<code>rw</code>". 
    If you do not supply a mutating version, one is autogenerated for you 
    based on the corresponding copy operator.</p>

<h3><a name="object_deconstruction">Object Deconstruction</a></h3>
<p>Object destruction is no longer guaranteed to be "timely" in Perl 6. 
    It happens when the garbage collector gets around to it. (Though there 
    will be ways to emulate Perl 5 end-of-scope cleanup.)</p>
<p>As with object creation, object destruction is recursive. Unlike creation, 
    it must proceed in the opposite order.</p>
<h4><a name="destroyall">DESTROYALL</a></h4>
<p>The <code>DESTROYALL</code> routine is the counterpart to the <code>BUILDALL</code> 
    routine. Similarly, the default definition is normally sufficient for 
    the needs of most classes. <code>DESTROYALL</code> first calls <code>DESTROY</code> 
    on the current class, and then delegates to the <code>DESTROYALL</code> 
    of any parent classes. In this way the pieces of the object are disassembled 
    in the correct order, from most derived to least derived.</p>
<h4><a name="destroy">DESTROY</a></h4>
<p>As with Perl 5, all the memory deallocation is done for you, so you really 
    only need to define <code>DESTROY</code> if you have to release external 
    resources such as files.</p>
<p>Since <code>DESTROY</code> is the opposite of <code>BUILD</code>, if 
    any attribute declaration has a "<code>destroy</code>" property, that 
    property (presumably a closure) is evaluated before the main block of 
    <code>DESTROY</code>. This happens even if you don't declare a <code>DESTROY</code>.</p>
<p>(The "<code>build</code>" and "<code>destroy</code>" traits are the only 
    way for roles to let their preferences be made known at <code>BUILD</code> 
    and <code>DESTROY</code> time. It follows that any role that does not 
    define an attribute cannot participate in building and destroying except 
    by defining a method that <code>BUILD</code> or <code>DESTROY</code> 
    might call. In other words, stateless roles aren't allowed to muck around 
    with the object's state. This is construed as a feature.)</p>

<h3><a name="dispatch_mechanisms">Dispatch Mechanisms</a></h3>
<p>Perl 6 supports both single dispatch (traditional OO) and multiple dispatch 
    (also known as "multimethod dispatch", but we try to avoid that term).</p>
<h4><a name="single_dispatch">Single Dispatch</a></h4>
<p>Single dispatch looks up which method to run solely on the basis of the 
    type of the first argument, the invocant. A single-dispatch call distinguishes 
    the invocant syntactically (unlike a multiple-dispatch call, which looks 
    like a subroutine call, or even an operator.)</p>
<p>Basically, anything can be an invocant as long as it fills the <code>Dispatch</code> 
    role, which provides a <code>.dispatcher</code> method. This includes 
    ordinary objects, class objects, and (in some cases) even varieties 
    of <code>undef</code> that happen to know what class of thing they aren't 
    (yet).</p>
<p>Simple single dispatch is specified with the dot operator, or its indirect 
    object equivalent:</p>
<pre><code>
    $object.meth(@args)   # always calls public .meth
           .meth(@args)   # unary form
    meth $object: @args   # indirect object form</code></pre>
<p>There are variants on the dot form indicated by the character after the 
    dot. (None of these variants allows indirect object syntax.) The private 
    dispatcher only ever dispatches to the current class or its proxies, 
    so it's really more like a subroutine call in disguise:</p>
<pre><code>
    $object.:meth(@args)  # always calls private :meth
           .:meth(@args)  # unary form</code></pre>
<p>It is an error to use <code>.:</code> unless there is a correspondingly 
    named "colon" method in the appropriate class, just as it is an error 
    to use <code>.</code> when no method can be found of that name. Unlike 
    the <code>.:</code> operator, which can have only one candidate method, 
    the <code>.</code> operator potentially generates a list of candidates, 
    and allows methods in that candidate list to defer to subsequent methods 
    in other classes until a candidate has been found that is willing to 
    handle the dispatch.</p>
<p>In addition to the <code>.:</code> and <code>.=</code> operators, there 
    are three other dot variants that can be used if it's not known how 
    many methods are willing to handle the dispatch:</p>
<pre><code>
    $object.?meth(@args)  # calls method if there is one
           .?meth(@args)  # unary form
    $object.*meth(@args)  # calls all methods (0 or more)
           .*meth(@args)  # unary form
    $object.+meth(@args)  # calls all methods (1 or more)
           .+meth(@args)  # unary form</code></pre>
<p>The <code>.*</code> and <code>.+</code> versions are generally only useful 
    for calling submethods, or methods that are otherwise expected to work 
    like submethods. They return a list of all the successful return values. 
    The <code>.?</code> operator either returns the one successful result, 
    or undef if no appropriate method is found. Like the corresponding regex 
    modifiers, <code>?</code> means "0 or 1", while <code>*</code> means 
    "0 or more", and <code>+</code> means "1 or more". Ordinary <code>.</code> 
    means "exactly one". Here are some sample implementations, though of 
    course these are probably implemented in C for maximum efficiency:</p>
<pre><code>
    # Implements . (or .? if :maybe is set).
    sub CALLONE ($obj, $methname, +$maybe, *%opt, *@args) {
        my $startclass = $obj.dispatcher() // fail &quot;No dispatcher: $obj&quot;;
      METHOD:
        for WALKMETH($startclass, :method($methname), %opt) -&gt; &amp;meth {
            return meth($obj, @args);
        }
        fail qq(Can't locate method &quot;$methname&quot; via class &quot;$startclass&quot;)
            unless $maybe;
        return;
    }</code></pre>
<p>With this dispatcher you can continue by saying "<code>next METHOD</code>". 
    This allows methods to "failover" to other methods if they choose not 
    to handle the request themselves.</p>
<pre><code>
    # Implements .+ (or .* if :maybe is set).
    #   Add :force to redispatch in every class
    sub CALLALL ($obj, $methname, +$maybe, +$force, *%opt, *@args) {
        my $startclass = $obj.dispatcher() // fail &quot;No dispatcher: $obj&quot;;
        my @results = gather {
            if $force {
              METHOD:
                for WALKCLASS($startclass, %opt) -&gt; $class {
                    take $obj.::($class)::$methname(*@args) # redispatch
                }
            }
            else {
              METHOD:
                for WALKMETH($startclass, :method($methname), %opt) -&gt; &amp;meth {
                    take meth($obj,*@args);
                }
            }
        }
        return @results if @results or $maybe;
        fail qq(Can't locate method &quot;$methname&quot; via class &quot;$startclass&quot;);
    }</code></pre>
<p>This one you can quit early by saying "<code>last METHOD</code>". Notice 
    that both of these dispatchers cheat by calling a method as if it were 
    a sub. You may only do that by taking a reference to the method, and 
    calling it as a subroutine, passing the object as the first argument. 
    This is the only way to call a virtual method non-virtually in Perl. 
    If you try to call a method directly as a subroutine, Perl will ignore 
    the method, look for a subroutine of that name elsewhere, probably not 
    find it, and complain bitterly. (Or find the wrong subroutine, and execute 
    it, after which you will complain bitterly.)</p>
<p>We snuck in an example the new <code>gather</code>/<code>take</code> 
    construct. It is still somewhat conjectural.</p>
<h4><a name="calling_superclasses,_and_notsosuperclasses">Calling Superclasses, 
    and Not-So-Superclasses</a></h4>
<p>Perl 5 supplies a pseudoclass, <code>SUPER::</code>, that redirects dispatch 
    to a parent class's method. That's often the wrong thing to do, though, 
    in part because under MI you may have more than one parent class, and 
    also because you might have sibling classes that also need to have the 
    given method triggered. Even if <code>SUPER</code> is smart enough to 
    visit multiple parent classes, and even if all your classes cooperate 
    and call <code>SUPER</code> at the right time, the depth first order 
    of visitation might be the wrong order, especially under diamond inheritance. 
    Still, if you know that your parent classes use <code>SUPER</code>, 
    or you're calling into a language with <code>SUPER</code> semantics 
    (such as Perl 5) then you should probably use <code>SUPER</code> semantics 
    too, or you'll end up calling your parent's parents in duplicate. However, 
    since use of <code>SUPER</code> is slightly discouraged, we Huffman 
    code it a bit longer in Perl 6. Remember the <code>*%opt</code> parameters 
    to the dispatchers above? That comes in as a parameterized pseudoclass 
    called <code>WALK</code>.</p>
<pre><code>
    $obj.*WALK[:super]::method(@args)</code></pre>
<p>That limits the call to only those immediate super classes that define 
    the method. Note the star in the example. If you really want the Perl 
    5 semantics, leave the star out, and you'll only get the first existing 
    parent method of that name. (Why you'd want that is beyond me.)</p>
<p>Actually, we'll probably still allow <code>SUPER::</code> as a shorthand 
    for <code>WALK[:super]::</code>, since people will just hack it in anyway 
    if we don't provide it...</p>
<p>If you think about it, every ordinary dispatch has an implicit <code>WALK</code> 
    modifier on the front that just happens to default to <code>WALK[:canonical]</code>. 
    That is, the dispatcher looks for methods in the canonical order. But 
    you could say <code>WALK[:depth]</code> to get Perl 5's order, or you 
    could say <code>WALK[:descendant]</code> to get an order approximating 
    the order of construction, or <code>WALK[:ascendant]</code> to get an 
    order approximating the order of destruction. You could say <code>WALK[:omit(SomeClass)]</code> 
    to call all classes not equivalent to or derived from <code>SomeClass</code>. 
    For instance, to call all super classes, and not just your immediate 
    parents, you could say <code>WALK[:omit(::_)]</code> to skip the current 
    lexical class or anything derived from it.</p>
<p>But again, that's not usually the right thing to do. If your base classes 
    are all willing to cooperate, it's much better to simply call</p>
<pre><code>
    $obj.method(@args)</code></pre>
<p>and then let each of the implementations of the method defer to the next 
    one when they're done with their part of it. If any method says "<code>next 
    METHOD</code>", it automatically iterates the loop of the dispatcher 
    and finds the next method to dispatch to, even if that method comes 
    from a sibling class rather than a parent class. The next method is 
    called with the same arguments as originally supplied.</p>
<p>That presupposes that the entire set of methods knows to call "next" 
    appropriately. This is not always the case. In fact, if they don't all 
    call next, it's likely that none of them does. And maybe just knowing 
    whether or not they do is considered a violation of encapsulation. In 
    any case, if you still want to call all the methods without their active 
    cooperation, then use the star form:</p>
<pre><code>
    $obj.*method(@args)</code></pre>
<p>Then the various methods don't have to do anything to call the next method--it 
    happens automatically by default. In this case a method has to do something 
    special if it wants to <em>stop</em> the dispatch. Naturally, that something 
    is to call "<code>last METHOD</code>", which terminates the dispatch 
    loop early.</p>
<p>Now, sometimes you want to call the next method, but you want to change 
    the arguments so that the next method doesn't get the original argument 
    list. This is done with deep magic. If you use the <code>call</code> 
    keyword in an ordinary (nonwrapper) method, it steals the rest of the 
    dispatch list from the outer loop and redispatches to the next method 
    with the new arguments:</p>
<pre><code>
    @retvals = call(@newargs)
    return @retvals;</code></pre>
<p>And unlike with "<code>next METHOD</code>", control returns to this method 
    following the call. It returns the results of the subsequent method 
    calls, which you should return so that your outer dispatcher can add 
    them to the return values it already gathered.</p>
<p>Note that "<code>next METHOD</code>" and "<code>last METHOD</code>" can 
    typically be spelt "<code>next</code>" and "<code>last</code>" unless 
    they are in an inner loop.</p>
	










	

<p><em>Editor's Note: this Apocalypse is out of date and remains here for historic reasons.  See <a href="http://dev.perl.org/perl6/doc/design/syn/S12.html">Synopsis 12</a> for the latest information.</em></p>
	
<h4><a name="parallel_dispatch">Parallel Dispatch</a></h4>
<p>By default the various dot operators call a method on a single object, 
    even if it ends up calling multiple methods for that object. Since a 
    method call is essentially a unary postfix operator, however, you can 
    use it as a hyper operator on a list of objects:</p>
<pre><code>
    @object&raquo;.meth(@args)        # Call one for each or fail
    @object&raquo;.?meth(@args)       # Call one for each if available
    @object&raquo;.*meth(@args)       # Call all available for each
    @object&raquo;.+meth(@args)       # Call one or more for each</code></pre>
<p>Note that with the last two, if a method uses "<code>last METHOD</code>", 
    it doesn't bomb out of the "hyper" loop, but just goes on to the next 
    entry. One can always bomb out of the hyperloop with a real exception, 
    of course. And maybe with "<code>last HYPER</code>", depending on how 
    hyper's implicit iteration is implemented.</p>
<p>If you want to use an array for serial rather than parallel method calling, 
    see Delegation, which lets you set up cascading handlers.</p>
<h4><a name="walkclass_and_walkmeth_caching">WALKCLASS and WALKMETH Caching</a></h4>
<p><code>WALKCLASS</code> generates a list of matching classes. <code>WALKMETH</code> 
    generates a list of method references from matching classes.</p>
<p>The <code>WALKCLASS</code> and <code>WALKMETH</code> routines used in 
    the sample dispatch code need to cache their results so that every dispatch 
    doesn't have to traverse the inheritance tree again, but just consult 
    the preconstructed list in order. However, if there are changes to any 
    of the classes involved, then someone needs to call the appropriate 
    cache clear method to make sure that the inheritance is recalculated.</p>
<p><code>WALKCLASS</code>/<code>WALKMETH</code> options include some that 
    specify ordering:</p>
<pre><code>
    :canonical      # canonical dispatch order
    :ascendant      # most-derived first, like destruction order
    :descendant     # least-derived first, like construction order
    :preorder       # like Perl 5 dispatch
    :breadth        # like multimethod dispatch</code></pre>
<p>and some that specify selection criteria:</p>
<pre><code>
    :super              # only immediate parent classes
    :method(Str)        # only classes containing method declaration
    :omit(Selector)     # only classes that don't match selector
    :include(Selector)  # only classes that match selector</code></pre>
<p>Note that <code>:method(Str)</code> selects classes that merely have 
    methods declared, not necessarily defined. A declaration without a definition 
    probably implies that they intend to autoload a definition, so we should 
    call the stub anyway. In fact, Perl 6 differentiates an <code>AUTOMETHDEF</code> 
    from <code>AUTOLOAD</code>. <code>AUTOLOAD</code> works as it does in 
    Perl 5. <code>AUTOMETHDEF</code> is never called unless there is already 
    a declaration of the stub (or equivalently, <code>AUTOMETH</code> faked 
    a stub.)</p>
<p>It would be possible to just define everything in terms of <code>WALKCLASS</code>, 
    but that would imply looking up each method name twice, once inside 
    <code>WALKCLASS</code> to see if the method exists in the current class, 
    and once again outside in order to call it. Even if <code>WALKCLASS</code> 
    caches the cache list, it wouldn't cache the derived method list, so 
    it's better to have a separate cache for that, controlled by <code>WALKMETH</code>, 
    since that's the common case and has to be fast.</p>
<p>(Again, this is all abstract, and is probably implemented in gloriously 
    grungy C code. Nevertheless, you can probably call <code>WALKCLASS</code> 
    and <code>WALKMETH</code> yourself if you feel like writing your own 
    dispatcher.)</p>

<h3><a name="multiple_dispatch">Multiple Dispatch</a></h3>
<p>Multiple dispatch is based on the notion that methods often mediate the 
    relationships of multiple objects of diverse types, and therefore the 
    first object in the argument list should not be privileged over other 
    objects in the argument list when it comes to selecting which method 
    to run. In this view, methods aren't subservient to a particular class, 
    but are independent agents. A set of independent-minded, identically 
    named methods use the class hierarchy to do pattern matching on the 
    argument list and decide among themselves which method can best handle 
    the given set of arguments.</p>
<p>The Perl approach is, of course, that sometimes you want to distinguish 
    the first invocant, and sometimes you don't. The interaction of these 
    two approaches gets, um, interesting. But the basic notion is to let 
    the caller specify which approach is expected, and then, where it makes 
    sense, fall back on the other approach when the first one fails. Underlying 
    all this is the Principle of Least Surprise. Do not confuse this with 
    the Principle of Zero Surprise, which usually means you've just swept 
    the real surprises under some else's carpet. (There's a certain amount 
    of surprise you can't go below--the Heisenberg Uncertainty Principle 
    applies to software too.)</p>
<p>With traditional multimethods, all methods live in the same global namespace. 
    Perl 6 takes a different approach--we still keep all the traditional 
    Perl namespaces (lexical, package, global) and we still search for names 
    the same way (outward through the lexical scopes, then the current package, 
    then the global <code>*</code> namespace; or upward in the class hierarchy). 
    Then we simply claim that, under multiple dispatch, the "long name" 
    of any multi routine includes its signature, and that visibility is 
    based on the long name. So an inner or derived multi only hides an outer 
    or base multi of the same name <em>and</em> the same signature. (Routines 
    not declared "<code>multi</code>" still hide everything in the traditional 
    fashion.)</p>
<p>To put it another way, the multiple dispatch always works when both the 
    caller and the callee agree that that's how it should work. (And in 
    some cases it also works when it ought to work, even if they don't agree--sort 
    of a "common law" multimethod, as it were...)</p>
<h4><a name="declaration_of_multiple_dispatch_routines">Declaration of Multiple 
    Dispatch Routines</a></h4>
<p>A callee agrees to the multiple dispatch "contract" by including the 
    word "<code>multi</code>" in the declaration of the routine in question. 
    It essentially says, "Ordinarily this would be a unique name, but it's 
    okay to have duplicates of this name (the short name) that are differentiated 
    by signatures (the long name)."</p>
<p>Looking at it from the other end, leaving the "<code>multi</code>" out 
    says "I am a perfect match for any signature--don't bother looking any 
    further outward or upward." In other words, the standard non-multi semantics.</p>
<p>You may not declare a multi in the same scope as a non-multi. However, 
    as long as they are in different scopes, you can have a single non-multi 
    inside a set of multis, or a set of multis inside a single non-multi. 
    You can even have a set of multis inside a non-multi inside a set of 
    multis. Indeed, this is how you hide all the outer multis so that only 
    the inner multi's long names are considered. (And if no long name matches, 
    you get the intermediate non-multi as a kind of backstop.) The same 
    policy applies to both nested lexical scopes and derived subclasses.</p>
<p>Actually, up till now we've been oversimplifying the concept of "long 
    name" slightly. The long name includes only that part of the signature 
    up to the first colon. If there is no colon, then the entire signature 
    is part of the long name. (You can have more colons, in which case the 
    additional arguments function as tie breakers if the original set of 
    long names is insufficient to prevent a tie.)</p>
<p>So sometimes we'll probably slip and say "signature" when we mean "long 
    name". We pray your indulgence.</p>
<h5><a name="multi_sub">multi sub</a></h5>
<p>A multi sub in any scope hides any multi sub with the same "long name" 
    in any outer scope. It does not hide subs with the same short name but 
    a different signature. Er, long name, I mean...</p>
<h5><a name="multi_sub_*_(tradition_multimethods)">multi sub * (tradition 
    multimethods)</a></h5>
<p>If you want a multi that is visible in all namespaces (that don't hide 
    the long name), then declare the name in the global name space, indicated 
    in Perl 6 with a <code>*</code>. Most of the so-called "built-ins" are 
    declared this way:</p>
<pre><code>
    multi sub *push (Array $array, *@args) {...}
    multi sub *infix:+ (Num $x, Num $y) returns Num {...}
    multi sub *infix:.. (Int $x, Int $y: Int ?$by) returns Ranger {...}</code></pre>
<p>Note the use of colon in the last example to exclude <code>$by</code> 
    as part of the long name. The range operator is dispatched only on the 
    types of its two main arguments.</p>
<h5><a name="multi_method">multi method</a></h5>
<p>If you declare a method with <code>multi</code>, then that method hides 
    any base class method with the same long name. It does not hide methods 
    with the same short name but a different signature when called as a 
    multimethod. (It does hide methods when called under single dispatch, 
    in which case the first invocant is treated as the <em>only</em> invocant 
    regardless of where you put the colon. Just because a method is declared 
    with <code>multi</code> doesn't make it invisible to single dispatch.)</p>
<p>Unlike a regular method declaration, there is no implied invocant in 
    the syntax of a multi method. A method declared as multi <em>must</em> 
    declare all its invocants so that there's no ambiguity as to the meaning 
    of the first colon. With a multi method, it always means the end of 
    the long name. (With a non-multi, it always means that the optional 
    invocant declaration is present.)</p>
<h5><a name="multi_submethod">multi submethod</a></h5>
<p>Submethods may be declared with <code>multi</code>, in which case visibility 
    works the same as for ordinary methods. However, a submethod has the 
    additional constraint that the first invocant must be an exact class 
    match. Which effectively means that a submethod is first single dispatched 
    to the class, and then the appropriate submethod within that class is 
    selected, ignoring any other class's submethods of the same name.</p>
<h5><a name="multi_rule">multi rule</a></h5>
<p>Since rules are just methods in disguise, you can have multi rules as 
    well. (Of course, that doesn't do you a lot of good unless you have 
    rules with different signatures, which is unusual.)</p>
<h5><a name="multi_submethod_build">multi submethod BUILD</a></h5>
<p>It is not likely that Perl 6.0.0 will support multiple dispatch on named 
    arguments, but only on positional arguments. Since all the extra arguments 
    to a <code>BUILD</code> routine come in as named arguments, you probably 
    can't usefully multi a <code>BUILD</code> (yet). However, we should 
    not do anything that precludes multiple <code>BUILD</code> submethods 
    in the future. Which means we should probably enforce the presence of 
    a colon before the first named argument declaration in any multi signature, 
    so that the semantics don't suddenly change if and when we start supporting 
    multiple dispatch that includes named arguments as part of the long 
    name.</p>
<h5><a name="multi_method_constructors">multi method constructors</a></h5>
<p>To the extent that you declare constructors (such as <code>.new</code>) 
    with positional arguments, you can use <code>multi</code> on them in 
    6.0.0.</p>













<p><em>Editor's Note: this Apocalypse is out of date and remains here for historic reasons.  See <a href="http://dev.perl.org/perl6/doc/design/syn/S12.html">Synopsis 12</a> for the latest information.</em></p>
	
<h4><a name="calling_via_multiple_dispatch">Calling Via Multiple Dispatch</a></h4>
<p>As we mentioned, multiple dispatch is enabled by agreement of both caller 
    and callee. From the caller's point of view, you invoke multiple dispatch 
    simply by calling with subroutine call syntax instead of method call 
    syntax. It's then up to the dispatcher to figure out which of the arguments 
    are invocants and which ones are just options. (In the case where the 
    innermost visible subroutine is declared non-multi, this degenerates 
    to the Perl 5 semantics of subroutine calls.) This approach lets you 
    refactor a simple subroutine into a more nuanced set of subroutines 
    without changing how the subroutines are called at all. That makes this 
    sort of refactoring drop-dead simple. (Or at least as simple as refactoring 
    ever gets...)</p>
<p>It's a little harder to refactor between single dispatch and multiple 
    dispatch, but a good argument could be made that it <em>should</em> 
    be harder to do that, because you're going to have to think through 
    a lot more things in that case anyway.</p>
<p>Anyway, here's the basic relationship between single dispatch and multiple 
    dispatch. Single dispatch is more familiar, so we'll discuss multiple 
    dispatch first.</p>
<h5><a name="multiple_dispatch_semantics">Multiple dispatch semantics</a></h5>
<p>Whenever you make a call using subroutine call syntax, it's a candidate 
    for multiple dispatch. A search is made for an appropriate subroutine 
    declaration. As in Perl 5, this search goes outward through the lexical 
    scopes, then through the current package and on to the global namespace 
    (represented in Perl 6 with an initial * for the "wildcard" package 
    name). If the name found is not a multi, then it's a good old-fashioned 
    sub call, and no multiple dispatch is done. End of story.</p>
<p>However, if the first declaration we come to is a multi, then lots of 
    interesting stuff happens. (Fortunately for our performance, most of 
    this interesting stuff can happen at compile time, or upon first use.) 
    The basic idea is that we will collect a complete list of candidates 
    before we decide which one to call.</p>
<p>So the search continues outward, collecting all sub declarations with 
    the same short name but different long names. (We can ignore outer declarations 
    that are hidden by an inner declaration with the same long name.) If 
    we run into a scope with a non-multi declaration, then we're done generating 
    our candidate list, and we can skip the next paragraph.</p>
<p>After going all the way out to the global scope, we then examine the 
    type of the first argument as if we were about to do single dispatch 
    on it. We then visit any classes that would have been single dispatched, 
    in most-derived to least-derived order, and for each of those classes 
    we add into our candidate list any methods declared multi, plus all 
    the single invocant methods, whether or not they were declared multi! 
    In other words, we just add in all the methods declared in the class 
    as a subset of the candidates. (There are reasons for this that we'll 
    discuss below.) Anyway, just as with nested lexical scopes, if two methods 
    have the same long name, the more derived one hides the less derived 
    one. And if there's a class in which the method of the same short name 
    is not declared multi, it serves as a "stopper", just as a non-multi 
    sub does in a lexical scope. (Though that "stopper" method can of course 
    redispatch further up the inheritance tree, just as a "stopper" lexical 
    sub can always call further outward if it wants to.)</p>
<p>Now we have our list of candidates, which may or may not include every 
    sub and method with the same short name, depending on whether we hit 
    a "stopper". Anyway, once we know the candidate list, it is sorted into 
    order of distance from the actual argument types. Any exact match on 
    a parameter type is distance 0. Any miss by a single level of derivation 
    counts as a distance of 1. Any violation of a hard constraint (such 
    as having too many arguments for the number of parameters, or violating 
    a subtype check on a type that does constraint checking, or missing 
    the exact type on a submethod) is effectively an infinite distance, 
    and disqualifies the candidate completely.</p>
<p>Once we have our list of candidates sorted, we simply call the first 
    one on the list, unless there's more than one "first one" on the list, 
    in which case we look to see if one of them is declared to be the default. 
    If so, we call it. If not, we die.</p>
<p>So if there's a tie, the default routine is in charge of subsequent behavior:</p>
<pre><code>
    # Pick next best at random...
    multi sub foo (BaseA $a, BaseB $b) is default {
        next METHOD;
    }</code></pre>
<pre><code>
    # Give up at first ambiguity...
    multi sub bar (BaseA $a, BaseB $b) is default {
        last METHOD;
    }</code></pre>
<pre><code>
    # Invoke my least-derived ancestor
    multi sub baz (BaseA $a, BaseB $b) is default {
        my @ambiguities = WALKMETH($startclass, :method('baz'))
            or last METHOD;
        pop(@ambiguities).($a, $b);
    }</code></pre>
<pre><code>
    # Invoke most generic candidate (often a good fall-back)...
    multi sub baz (BaseA $a, BaseB $b) is default {
        my @ambiguities = @CALLER::methods or last METHOD;
        pop(@ambiguities).value.($a, $b);
    }</code></pre>
<p>In many cases, of course, the default routine won't redispatch, but simply 
    do something generically appropriate.</p>
<h5><a name="single_dispatch_semantics">Single dispatch semantics</a></h5>
<p>If you use the dot notation, you are explicitly calling single dispatch. 
    By default, if single dispatch doesn't find a suitable method, it does 
    a "failsoft" to multiple dispatch, pretending that you called a subroutine 
    with the invocant passed as the first argument. (Multiple dispatch doesn't 
    need to failsoft to single dispatch since all single dispatch methods 
    are included as a subset of the multiple dispatch candidates anyway.)</p>
<p>This failsoft behavior can be modified by lexically scoped pragma. If 
    you say</p>
<pre><code>
    use dispatch :failhard</code></pre>
<p>then single dispatch will be totally unforgiving as it is in Perl 5. 
    Or you can tell single dispatch to go away:</p>
<pre><code>
    use dispatch :multi</code></pre>
<p>in which case all your dot notation is treated as a sub call. That is, 
    any</p>
<pre><code>
    $obj.method(1,2,3)</code></pre>
<p>in the lexical scope acts like you'd said:</p>
<pre><code>
    method($obj,1,2,3)</code></pre>
<p>If single dispatch locates a class that defines the method, but the method 
    in question turns out to be a set of one or more multi methods, then, 
    the single dispatch fails immediately and a multiple dispatch is done, 
    with the additional constraint that only multis within that class are 
    considered. (If you wanted the first argument to do loose matching as 
    well, you should have called it as a multimethod in the first place.)</p>
<h5><a name="indirect_objects">Indirect objects</a></h5>
<p>If you use indirect object syntax with an explicit colon, it is exactly 
    equivalent to dot notation in its semantics.</p>
<p>However, one-argument subs are inherently ambiguous, because Perl 6 does 
    not require the colon on indirect objects without arguments. That is, 
    if you say:</p>
<pre><code>
    print $fh</code></pre>
<p>it's not clear whether you mean</p>
<pre><code>
    $fh.print</code></pre>
<p>or</p>
<pre><code>
    print($fh)</code></pre>
<p>As it happens, we've defined the semantics so that it doesn't matter. 
    Since all single invocant methods are included automatically in multimethod 
    dispatch, and since multiple dispatch degenerates to single dispatch 
    when there's only one invocant, it doesn't matter which way your write 
    it. The effect is the same either way. (Unless you've defined your own 
    non-multi print routine in a surrounding lexical scope. But then, if 
    you've done that, you probably did it on purpose <em>precisely</em> 
    because you wanted to disable the default dispatch semantics.)</p>
<h4><a name="meaning_of_next_method">Meaning of "next METHOD"</a></h4>
<p>Within the context of a multimethod dispatch, "<code>next METHOD</code>" 
    means to try the next best match, if unambiguous, or else the marked 
    default method. From within the default method it means just pick the 
    next in the list even if it's ambiguous. The dispatch list is actually 
    kept in <code>@CALLER::methods</code>, which is a list of pairs, the 
    key of each indicating the "distance" rating, and the value of each 
    containing a reference to the method to call (as a sub ref).</p>
<h4><a name="making_fiends,_er,_friends.">Making Fiends, er, Friends.</a></h4>
<p>If you want to directly access the attributes of a class, your multi 
    must be declared within the scope of that class. Attributes are never 
    directly visible outside a class. This makes it difficult to write an 
    efficient multimethod that knows about the internals of two different 
    classes. However, it's possible for private accessors to be visible 
    outside your class under one condition. If your class declares that 
    another class is trusted, that other class can see the private accessors 
    of your class. If the other class declares that you are trusted, then 
    you can see its private accessor methods. The trust relationship is 
    not necessarily symmetrical. This lets you have an architecture where 
    classes by and large don't trust each other, but they all trust a single 
    well-guarded "<code>multi</code>-plexor" class that keeps everyone else 
    in line.</p>
<p>The syntax for trusting another class is simply:</p>
<pre><code>
    class MyClass {
        trusts Yourclass;
        ...
    }</code></pre>
<p>It's not clear whether roles should be allowed to grant trust. In the 
    absence of evidence to the contrary, I'm inclined to say not. We can 
    always relax that later if, after many large, longitudinal, double-blind 
    studies, it turns out to be both safe and effective.</p>














<p><em>Editor's Note: this Apocalypse is out of date and remains here for historic reasons.  See <a href="http://dev.perl.org/perl6/doc/design/syn/S12.html">Synopsis 12</a> for the latest information.</em></p>

<h3><a name="overloading">Overloading</a></h3>
<p>In Perl 5 overloading was this big special deal that had to have special 
    hooks inserted all over the C code to catch various operations on overloaded 
    types and do something special with them. In Perl 6, that just all falls 
    out naturally from multiple dispatch. The only other part of the trick 
    is to consider operators to be function calls in disguise. So in Perl 
    6 the real name of an operator is composed of a grammatical context 
    identifier, a colon, and then the name of the operator as you usually 
    see it. The common context identifiers are "prefix", "infix", "postfix", 
    "circumfix", and "term", but there are others.</p>
<p>So when you say something like</p>
<pre><code>
    $x = &lt;$a++ * -@b.[...]&gt;;</code></pre>
<p>you're really saying something like this:</p>
<pre><code>
    $x = circumfix:&lt;&gt;(
        infix:*(
            postfix:++($a),
            prefix:-(
                infix:.(
                    @b,
                    circumfix:[](
                        term:...();
                    )
                )
            )
        )
    )</code></pre>
<p>Perl 5 had special key names representing stringification and numification. 
    In Perl 6 these naturally fall out if you define:</p>
<pre><code>
    method prefix:+ () {...}    # what we do in numeric context
    method prefix:~ () {...}    # what we do in string context</code></pre>
<p>Likewise you can define what to return in boolean context:</p>
<pre><code>
    method prefix:? () {...}    # what we do in boolean context</code></pre>
<p>Integer context is, of course, just an ordinary method:</p>
<pre><code>
    method int () {...}         # what we do in integer context</code></pre>
<p>These can be defined as normal methods since single-invocant multi subs 
    degenerate to standard methods anyway. C++ programmers will tend to 
    feel comfy defining these as methods. But others may prefer to declare 
    them as multi subs for consistency with binary operators. In which case 
    they'd look more like this:</p>
<pre><code>
    multi sub *prefix:+ (Us $us) {...}   # what we do in numeric context
    multi sub *prefix:~ (Us $us) {...}   # what we do in string context
    multi sub *prefix:? (Us $us) {...}   # what we do in string context
    multi sub *prefix:int (Us $us) {...} # what we do in integer context</code></pre>
<p>Coercions to other classes can also be defined:</p>
<pre><code>
    multi sub *coerce:as (Us $us, Them ::to) { to.transmogrify($us) }</code></pre>
<p>Such coercions allow both explicit conversion:</p>
<pre><code>
    $them = $us as Them;</code></pre>
<p>as well as implicit conversions:</p>
<pre><code>
    my Them $them = $us;</code></pre>
<h4><a name="binary_ops">Binary Ops</a></h4>
<p>Binary operators should generally be defined as multi subs:</p>
<pre><code>
    multi sub infix:+ (Us $us, Us $ustoo) {...}
    multi sub infix:+ (Us $us, Them $them) is commutative {...}</code></pre>
<p>The "<code>is commutative</code>" trait installs an additional autogenerated 
    sub with the invocant arguments reversed, but with the same semantics 
    otherwise. So the declaration above effectively autogenerates this:</p>
<pre><code>
    multi sub infix:+ (Them $them, Us $us) {...}</code></pre>
<p>Of course, there's no need for that if the two arguments have the same 
    type. And there might not actually be an autogenerated other subroutine 
    in any case, if the implementation can be smart enough to simply swap 
    the two arguments when it needs to. However it gets implemented, note 
    that there's no need for Perl 5's "reversed arguments flag" kludge, 
    since we reverse the parameter name bindings along with the types. Perl 
    5 couldn't do that because it had no control of the signature from the 
    compiler's point of view.</p>
<p>See Apocalypse 6 for much more on the definition of user-defined operators, 
    their precedence, and their associativity. Some of it might even still 
    be accurate.</p>

<h3><a name="class_composition_with_roles">Class Composition with Roles</a></h3>
<p>Objects have many kinds of relationships with other objects. One of the 
    pitfalls of the early OO movement was to encourage people to model many 
    relationships with inheritance that weren't really "isa" relationships. 
    Various languages have sought to redress this deficiency in various 
    ways, with varying degrees of success. With Perl 6 we'd like to back 
    off a step and allow the user to define abstract relationships between 
    classes without committing to a particular implementation.</p>
<p>More specifically, we buy the argument of the <a href="http://www.cse.ogi.edu/~black/publications/TR_CSE_02-012.pdf">Traits 
    paper</a> that classes should not be used both to manage objects and 
    to manage code reuse. It needs to be possible to separate those concerns. 
    Since a lot of the code that people want to reuse is that which manages 
    non-isa object relationships, that's what we should abstract out from 
    classes.</p>
<p>That abstraction we are calling a role. Roles can encompass both interface 
    and implementation of object relationships. A role without implementation 
    degenerates to an interface. A role without interface degenerates to 
    privately instantiated generics. But the typical role will provide both 
    interface and at least a default implementation.</p>
<p>Unlike the Traits paper, we will allow state as part of our implementation. 
    This is necessary if we are to abstract out the delegation decision. 
    We feel that the decision to delegate rather than compose a sub-object 
    is a matter of implementation, and therefore that decision should be 
    encapsulated (or at least be allowed to be encapsulated) in a role. 
    This allows you to refactor a problem by redefining one or more roles 
    without having to doctor all the classes that make use of those roles. 
    This is a great way to turn your huge, glorious "god object" into a 
    cooperating set of objects that know how to delegate to each other.</p>
<p>As in the Traits paper, roles are composed at class construction time, 
    and the class composer does some work to make sure the composed class 
    is not unintentionally ambiguous. If two methods of the same name are 
    composed into the same class, the ambiguity will be caught. The author 
    of the class has various remedies for dealing with this situation, which 
    we'll go into below.</p>
<p>From the standpoint of the typical user, a role just looks like a "smart" 
    include of a "partial class". They're smart in that roles have to be 
    well behaved in certain respects, but most of the time the naive user 
    can ignore the power of the abstraction.</p>
	












<p><em>Editor's Note: this Apocalypse is out of date and remains here for historic reasons.  See <a href="http://dev.perl.org/perl6/doc/design/syn/S12.html">Synopsis 12</a> for the latest information.</em></p>
	
<h4><a name="declaration_of_roles">Declaration of Roles</a></h4>
<p>A role is declared much like a class, but with a <code>role</code> keyword 
    instead:</p>
<pre><code>
    role Pet {
        method feed ($food) {
            $food.open_can();
            $food.put_in_bowl();
            .call();
        }
    }</code></pre>
<p>A role may not inherit from a class. It may be composed of other roles, 
    however. In essence, a role doesn't know its own type yet, because it 
    will be composed into another type. So if you happen to make any mention 
    of its main type (available as <code>::_</code>), that mention is in 
    fact generic. Therefore the type of <code>$self</code> is generic. Likewise 
    if you refer to <code>SUPER</code>, the role doesn't know what the parent 
    classes are yet, so that's also generic. The actual types are instantiated 
    from the generic types when the role is composed into the class. (You 
    can use the role name ("<code>Pet</code>") directly, but only in places 
    where a role name is allowed as a type constraint, not in places that 
    declare the type of an actual object.)</p>
<p>Just as the body of a class declaration is actually a method call on 
    an instance of the <code>MetaClass</code> class, so too the body of 
    a role declaration is actually a method call on an instance of the <code>MetaRole</code> 
    class, which is like the <code>MetaClass</code> class, with some tweaks 
    to manage <code>Role</code> objects instead of <code>Class</code> objects. 
    For instance, a <code>Role</code> object doesn't actually support a 
    dispatcher like a <code>Class</code> object.</p>
<p><code>MetaRole</code> and <code>MetaClass</code> do not inherit from 
    each other. More likely they both inherit from <code>MetaModule</code> 
    or some such.</p>
<h5><a name="parametric_types">Parametric types</a></h5>
<p>A role's main type is generic by default, but you can also parameterize 
    other types explicitly:</p>
<pre><code>
    role Pet[Type $petfood = TableScraps] {
        method feed (::($petfood) $food) {...}
    }</code></pre>
<p>Unlike certain other languages you may be altogether too familiar with, 
    Perl uses square brackets for parametric types rather than angles. Within 
    those square brackets it uses standard signature notation, so you can 
    also use the arguments to pass initial values, for instance. Just bear 
    in mind that by default any parameters to a role or class are considered 
    part of the name of the class when instantiated. Inasmuch as instantiated 
    type names are reminiscent of multimethod "long names", you may use 
    a colon to separate those arguments that are to be considered part of 
    the name from those that are just options.</p>
<p>Please note that these types can be as latent (or as non-latent) as you 
    like. Remember that what looks like compile time to you is actually 
    runtime to the compiler, so it's free to bind types as early or late 
    as you tell it to, including not at all.</p>
<h5><a name="interfaces">Interfaces</a></h5>
<p>If a role merely declares methods without defining them, it degenerates 
    to an interface:</p>
<pre><code>
    role Pet {
        method feed ($food) {...}
        method groom () {...}
        method scratch (+$where) {...}
    }</code></pre>
<p>When such a role is included in a class, the methods then have to be 
    defined by the class that uses the role. Actually, each method is on 
    its own--a role is free to define default implementations for any subset 
    of the methods it declares.</p>
<h5><a name="private_interfaces">Private interfaces</a></h5>
<p>If a role declares private accessors, those accessors are private to 
    the class, not the role. The class must define any private implementations 
    that are not supplied by the role, just as with public methods. But 
    private method names are never visible outside the class (except to 
    its trusted proxy classes).</p>
<h5><a name="encapsulated_attributes">Encapsulated attributes</a></h5>
<p>Unlike in the Traits paper, we allow roles to have state. Which is fancy 
    way of saying that the role can define attributes, and methods that 
    act on those attributes, not just methods that act only on other methods.</p>
<pre><code>
    role Pet {
        has $.collar = { Collar.new(Tag.new) };
        method id () { return $.collar.tag }
        method lose_collar () { undef $.collar }
    }</code></pre>
<p>By the way, I think that when <code>$.collar</code> is undefined, calling 
    <code>.tag</code> on it should merely return <code>undef</code> rather 
    than throwing an exception (in the same way that <code>@foo[$x][$y][$z]</code> 
    returns <code>undef</code> when <code>@foo[$x]</code> is undefined, 
    and for the same reason). The <code>undef</code> object returned should, 
    of course, contain an unthrown exception documenting the problem, so 
    that if the <code>undef</code> is ever asked to provide a defined value, 
    it can explain why it can't do so. Or if the returned value is tested 
    by <code>//</code>, it can participate in the resulting error message.</p>
<p>If you want to parameterize the initial value of a role attribute, be 
    sure to put a colon if you don't want the parameter to be considered 
    part of the long name:</p>
<pre><code>
    role Pet[IDholder $id: $tag] {
        has IDholder $.collar .= new($tag);
    }
    class Dog does Pet[Collar, DogLicense(&quot;fido&quot;)] {...}
    class Pigeon does Pet[LegBand, RacerId()] {...}
    my $dog = new Dog;
    my $pigeon = new Pigeon;</code></pre>
<p>In which case the long names of the roles in question are <code>Pet[Collar]</code> 
    and <code>Pet[LegBand]</code>. In which case all of these are true:</p>
<pre><code>
    $dog.does(Dog)
    $dog.does(Pet)
    $dog.does(Pet[Collar])</code></pre>
<p>but this is false:</p>
<pre><code>
    $dog.does(Pet[LegBand])</code></pre>
<p>Anyway, where were we. Ah, yes, encapsulated attributes, which leads 
    us to...</p>
<h5><a name="encapsulated_private_attributes">Encapsulated private attributes</a></h5>
<p>We can also have private attributes:</p>
<pre><code>
    has Nose $:sniffer .= new();</code></pre>
<p>And encapsulated private attributes lead us to...</p>
<h5><a name="encapsulated_delegation">Encapsulated delegation</a></h5>
<p>A role can abstract the decision to delegate:</p>
<pre><code>
    role Pet {
        has $:groomer handles &laquo;bathe groom trim&raquo; = hire_groomer();
    }</code></pre>
<p>Now when the <code>Dog</code> or <code>Cat</code> class incorporates 
    the <code>Pet</code> role, it doesn't even have to know that the <code>.groom</code> 
    method is delegated to a professional groomer. (See section on Delegation 
    below.)</p>
<h5><a name="encapsulated_inheritance">Encapsulated inheritance</a></h5>
<p>It gets worse. Since you can specify inheritance with an "is" declaration 
    within a class, you can do the same with a role:</p>
<pre><code>
    role Pet {
        is Friend;
    }</code></pre>
<p>Note carefully that this is not claiming that a <code>Pet</code> ISA 
    <code>Friend</code> (though that might be true enough). Roles never 
    inherit. So this is only saying that whatever animal takes on the role 
    of <code>Pet</code> gets some methods from <code>Friend</code> that 
    just happen to be implemented by inheritance rather than by composition. 
    Probably <code>Friend</code> <em>should</em> have been written as a 
    role, but it wasn't (perhaps because it was written in Some Other Language 
    that runs on Parrot), and now you want to pretend that it <em>was</em> 
    written as a role to get your project out the door. You don't want to 
    use delegation because there's only one animal involved, and inheritance 
    will work good enough till you can rewrite <code>Friend</code> in a 
    language that supports role playing.</p>
<p>Of course, the really funny thing is that if you go across a language 
    barrier like that, Perl might just decide to emulate the inheritance 
    with delegation anyway. But that should be transparent to you. And if 
    two languages manage to unify their object models within the Parrot 
    engine, you don't want to suddenly have to rewrite your roles and classes.</p>
<p>And the really, really funny thing is that Parrot implements roles internally 
    with a funny form of multiple inheritance anyway...</p>
<p>Ain't abstraction wonderful.</p>
<h4><a name="use_of_roles_at_compile_time">Use of Roles at Compile Time</a></h4>
<p>Roles are most useful at compile time, or more precisely, at class composition 
    time, the moment in which the <code>MetaClass</code> class is figuring 
    out how to put together your <code>Class</code> object. Essentially, 
    that's while the closure associated with your class is being executed, 
    with a little extra happening before and after.</p>
<p>A class incorporates a role with the verb "does", like this:</p>
<pre><code>
    class Dog is Mammal does Pet does Sentry {...}</code></pre>
<p>or equivalently, within the body of the class closure:</p>
<pre><code>
    class Dog {
        is Mammal;
        does Pet;
        does Sentry;
        ...
    }</code></pre>
<p>There is no ordering dependency among the roles, so it doesn't matter 
    above if <code>Sentry</code> comes before <code>Pet</code>. That is 
    because the class just remembers all the roles and then meshes them 
    after the closure is done executing.</p>
<p>Each role's methods are incorporated into the class unless there is already 
    a method of that name defined in the class itself. A class's method 
    definition hides any role definition of the same name, so role methods 
    are second-class citizens. On the other hand, role methods are still 
    part of the class itself, so they hide any methods inherited from other 
    classes, which makes ordinary inherited methods third-class citizens, 
    as it were.</p>
<p>If there are no method name conflicts between roles (or with the class), 
    then each role's methods can be installed in the class, and we're done. 
    (Unless we wish to do further analysis of role interrelationships to 
    make sure that each role can find the methods it depends on, in which 
    case we can do that. But for 6.0.0 I'll be happy if non-existent methods 
    just fail at runtime as they do now in Perl 5.)</p>
<p>If, however, two roles try to introduce a method of the same name (for 
    some definition of name), then the composition of the class <em>fails</em>, 
    and the compilation of the program blows sky high--we sincerely hope. 
    It's much better to catch this kind of error at compile time if you 
    can. And in this case, you can.</p>
<h5><a name="conflict_resolution">Conflict resolution</a></h5>
<p>There are several ways to solve conflicts. The first is simply to write 
    a class method that overrides the conflicting role methods, perhaps 
    figuring out which role method to call. It is allowed to use the role 
    name to select one of the hidden role methods:</p>
<pre><code>
    method shake ($self: $arg) {
        given $arg {
            when Culprit { $self.Sentry::shake($arg) }
            when Paw     { $self.Pet::shake($arg) }
        }
    }</code></pre>
<p>So even though the methods were not officially composed into the class, 
    they're still there--they're not thrown away.</p>
<p>That last example looks an awful lot like multiple dispatch, and in fact, 
    if you declare the roles' methods with <code>multi</code>, they would 
    be treated as methods with different "long names", provided their signatures 
    were sufficiently different.</p>
<p>An interesting question, though, is whether the class can force two role 
    methods that weren't declared "multi" to behave as if they were. Perhaps 
    this can be forced if the class declares a signatureless multi stub 
    without defining it later in the class:</p>
<pre><code>
    multi shake {...}</code></pre>
<p>The Traits paper recommends providing ways of renaming or excluding one 
    or the other of the conflicting methods. We don't recommend that, because 
    it's better if you can keep both contracts through multiple dispatch 
    to the role methods. However, you can force renaming or exclusion by 
    pretending the role is a delegation:</p>
<pre><code>
    does Pet handles [ :myshake&laquo;shake&raquo;, Any ];
    does Pet handles { $^name !~ &quot;shake&quot; };</code></pre>
<p>Or something that. (See the section on Delegation below.) If we can't 
    get that to work right, you can always say something like:</p>
<pre><code>
    method shake { .Sentry::shake(@_) }    # exclude Pet::shake
    method handshake { .Pet::shake(@_) }   # rename Pet::shake</code></pre>
<p>In many ways that's clearer than trying to attach a selection syntax 
    to "does".</p>
	










	

<p><em>Editor's Note: this Apocalypse is out of date and remains here for historic reasons.  See <a href="http://dev.perl.org/perl6/doc/design/syn/S12.html">Synopsis 12</a> for the latest information.</em></p>
	
<h4><a name="use_of_roles_at_run_time_(mixins)">Use of Roles at Runtime 
    (mixins)</a></h4>
<p>While roles are at their most powerful at compile time, they can also 
    function as mixin classes at runtime. The "does" binary operator performs 
    the feat of deriving a new class and binding the object to it:</p>
<pre><code>
    $fido does Sentry</code></pre>
<p>Actually, it only does this if <code>$fido</code> doesn't already do 
    the <code>Sentry</code> role. If it does already, this is basically 
    a no-op. The <code>does</code> operator works on the object in place. 
    It would be illegal to say, for instance,</p>
<pre><code>
    0 does true</code></pre>
<p>The <code>does</code> operator returns the object so you can nest mixins:</p>
<pre><code>
    $fido does Sentry does Tricks does TailChasing does Scratch;</code></pre>
<p>Unlike the compile-time role composition, each of these layers on a new 
    mixin with a new level of inheritance, creating a new anonymous class 
    for dear old Fido, so that a <code>.chase</code> method from <code>TailChasing</code> 
    hides a <code>.chase</code> method from <code>Sentry</code>.</p>
<p>(Do not confuse the binary <code>does</code> with the unary <code>does</code> 
    that you use inside a class definition to pull in a role.)</p>
<p>In contrast to <code>does</code>, the <code>but</code> operator works 
    on a copy. So you can say:</p>
<pre><code>
    0 but true</code></pre>
<p>and you get a mixin based on a copy of 0, not the original 0, which everyone 
    shares. One other wrinkle is that "true" isn't, in fact, a class name. 
    It's an enumerated value of a bit class. So what we said was a shorthand 
    for something like:</p>
<pre><code>
    0 but bit::true</code></pre>
<p>In earlier Apocalypses we talked about applying properties with <code>but</code>. 
    This has now been unified with mixins, so any time you say:</p>
<pre><code>
    $value but prop($x)</code></pre>
<p>you're really doing something more like</p>
<pre><code>
    $tmp = $value;      # make a copy
    $tmp does SomeRole; # guarantee there's a rw .prop method
    $tmp.prop = $x;     # set the prop method</code></pre>
<p>And therefore a property is defined by a role like this:</p>
<pre><code>
    role SomeRole {
        has SomeType $.prop is rw = 1;
    }</code></pre>
<p>This means that when you mention "<code>prop</code>" in your program, 
    something has to know how to map that to the <code>SomeRole</code> role. 
    That would often be something like an enum declaration. It's illegal 
    to use an undeclared property. But sometimes you just want a random 
    old property for which the role has the same name as the property. You 
    can declare one with</p>
<pre><code>
    my property answer;</code></pre>
<p>and that essentially declares a role that looks something like</p>
<pre><code>
    my role answer {
        has $.answer is rw = 1;
    }</code></pre>
<p>Then you can say</p>
<pre><code>
    $a = 0 but answer(42)</code></pre>
<p>and you have an object of an anonymous type that "does" <code>answer</code>, 
    and that include a <code>.answer</code> accessor of the same name, so 
    that if you call <code>$a.answer</code>, you'll get back <code>42</code>. 
    But <code>$a</code> itself has the value <code>0</code>. Since the accessor 
    is "<code>rw</code>", you can also say</p>
<pre><code>
    $a.answer = 43;</code></pre>
<p>There's a corresponding assignment operator:</p>
<pre><code>
    $a but= tainted;</code></pre>
<p>That avoids copying <code>$a</code> before tainting it. It basically 
    means the same thing as</p>
<pre><code>
    $a does taint::tainted</code></pre>
<p>For more on enumerated types, see Enums below.</p>

<h3><a name="traits">Traits</a></h3>
<p>Here we're talking about Perl's traits (as in compile-time properties), 
    not Traits (as in the Traits paper).</p>
<p>Traits can be thought of as roles gone wrong. Like roles, they can function 
    as straightforward mixins on container objects at compile time, but 
    they can also cheat, and frequently do. Unlike roles, traits are not 
    constrained to play fair with each other. With traits, it's both "first 
    come, first served", and "he who laughs last laughs best". Traits are 
    applied one at a time to their container victim, er, object, and an 
    earlier trait can throw away information required by a later trait. 
    Contrariwise, a later trait can overrule anything done by an earlier 
    trait--except of course that it can't undestroy information that has 
    been totally forgotten by the earlier trait.</p>
<p>You might say that "role" is short for "role model", while "trait" is 
    short for "traitor". In a nutshell, roles are symbiotes, while traits 
    are parasites. Nevertheless, some parasites are symbiotic, and some 
    symbiotes are parasitic. Go figure...</p>
<p>All that being said, well-behaved traits are really just roles applied 
    to declared items like containers or classes. It's the declaration of 
    the item itself that makes traits seem more permanent than ordinary 
    properties. The only reason we call them "traits" rather than "properties" 
    is to continually remind people that they are, in fact, applied at compile 
    time. (Well, and so that we can make bad puns on "traitor".)</p>
<p>Even ill-behaved traits should add an appropriately named role to the 
    container, however, in case someone wants to look at the metadata properties 
    of the container.</p>
<p>Traits are generally inflicted upon the "traitee" with the "is" keyword, 
    though other modalities are possible. When the compiler sees words like 
    "is" or "will" or "returns" or "handles", or special constructs like 
    signatures and body closures, it calls into an associated trait handler, 
    which applies the role to the item as a mixin, and also does any other 
    traitorous magic that needs doing.</p>
<p>To define a trait handler for an "is xxx" trait, define one or more multisubs 
    into a property role like this:</p>
<pre><code>
    role xxx {
        has Int $.xxx;
        multi sub trait_auxiliary:is(xxx $trait, Class $container: ?$arg) {...}
        multi sub trait_auxiliary:is(xxx $trait, Any $container: ?$arg) {...}
    }</code></pre>
<p>Then it can function as a trait. A well-behaved trait handler will say</p>
<pre><code>
    $container does xxx($arg);</code></pre>
<p>somewhere inside to set the metadata on the container correctly. Then 
    not only can you say</p>
<pre><code>
    class MyClass is xxx(123) {...}</code></pre>
<p>but you'll also be able to say </p>
<pre><code>

    if MyClass.meta.xxx == 123 {...}</code></pre>
<p>Since a class can function as a role when it comes to parameter type 
    matching, you can also say:</p>
<pre><code>
    class MyBase {
        multi sub trait_auxiliary:is(MyBase $base, Class $class: ?$arg) {...}
        multi sub trait_auxiliary:is(MyBase $tied, Any $container: ?$arg) {...}
    }</code></pre>
<p>These capture control if <code>MyBase</code> wants to capture control 
    of how it gets used by any class or container. But usually you can just 
    let it call the generic defaults:</p>
<pre><code>
    multi sub *trait_auxiliary:is(Class $base, Class $class: ?$arg) {...}</code></pre>
<p>which adds <code>$base</code> to the "isa" list of <code>$class</code>, 
    or</p>
<pre><code>
    multi sub *trait_auxiliary:is(Class $tied, Any $container: ?$arg) {...}</code></pre>
<p>which sets the "tie" type of the container to the implementation type 
    in <code>$tied</code>.</p>
<p>In any event, if the trait supplies the optional argument, that comes 
    in as <code>$arg</code>. (It's probably something unimportant, like 
    the function body...) Note that unlike "pair options" such as "<code>:wag</code>", 
    traits do not necessarily default to the value 1 if you don't supply 
    the argument. This is consistent with the notion that traits don't generally 
    do something passive like setting a value somewhere, but something active 
    like totally screwing up the structure of your container.</p>
<p>Most traits are introduced by use of a "helping verb", which could be 
    something like "<code>is</code>", or "<code>will</code>", or "<code>can</code>", 
    or "<code>might</code>", or "<code>should</code>", or "<code>does</code>". 
    We call these helping verbs "trait auxiliaries". Here's "<code>will</code>", 
    which (being syntactic sugar) merely delegates to back to "is":</p>
<pre><code>
    multi sub *trait_auxiliary:will($trait, $container: &amp;arg) {
        trait_auxiliary:is($trait, $container, &amp;arg);
    }</code></pre>
<p>Note the declaration of the argument as a non-optional reference to a 
    closure. This is what allows us to say:</p>
<pre><code>
    my $dog will eat { anything() };</code></pre>
<p>rather than having to use parens:</p>
<pre><code>
    my $dog is eat({ anything() });</code></pre>
<p>Other traits are applied with a single word, and we call one of those 
    a "trait verb". For instance, the "<code>returns</code>" trait described 
    in Apocalypse 6 is defined something like this:</p>
<pre><code>
    role returns {
        has ReturnType $.returns;
        multi sub trait_verb:returns($container: ReturnType $arg) {
            $container does returns($arg);
        }
        ...
    }</code></pre>
<p>Note that the argument is not optional on "<code>returns</code>".</p>
<p>Earlier we defined the <code>xxx</code> trait using multi sub definitions:</p>
<pre><code>
    role xxx {
        has Int $.xxx;
        multi sub trait_auxiliary:is(xxx $trait, Class $container: ?$arg) {...}
        multi sub trait_auxiliary:is(xxx $trait, Any $container: ?$arg) {...}
    }</code></pre>
<p>This is one of those situations in which you may really want single-dispatch 
    methods:</p>
<pre><code>
    role xxx {
        has Int $.xxx;
        method trait_auxiliary:is(xxx $trait: Class $container, ?$arg) {...}
        method trait_auxiliary:is(xxx $trait: Any $container, ?$arg) {...}
    }</code></pre>
<p>Some traits are control freaks, so they want to make sure that anything 
    mentioning them comes through their control. They don't want something 
    dispatching to another trait's trait_help:is method just because someone 
    introduced a cute new container type they don't know about. That other 
    trait would just mess things up.</p>
<p>Of course, if a trait is feeling magnanimous, it should just go ahead 
    and use multi subs. Since the multi-dispatcher takes into account single-dispatch 
    methods, and the distance of an exact match on the first argument is 
    0, the dispatcher will generally respect the wishes of both the paranoid 
    and the carefree.</p>
<p>Note that we included "does" in our list of "helping verbs". Roles actually 
    implement themselves using the trait interface, but the generic version 
    of <code>trait_auxiliary:does</code> defaults to doing proper roley 
    things rather than proper classy things or improper traitorous things. 
    So yes, you could define your own <code>trait_auxiliary:does</code> 
    and turn your nice role traitorous. That would be...naughty.</p>
<p>But apart from how you typically invoke them, traits and roles are really 
    the same thing. Just like the roles on which they're based, you may 
    neither instantiate nor inherit from a trait. You may, however, use 
    their names as type constraints on multimethod signatures and such. 
    As with well-behaved roles, they should define attributes or methods 
    that show up as metadata properties where that's appropriate. Unlike 
    compile-time roles, which all flatten out in the same class, compile-time 
    traits are applied one at a time, like mixin roles. You can, in fact, 
    apply a trait to a container at runtime, but if you do, it's just an 
    ordinary mixin role. You have to call the appropriate <code>trait_auxiliary:is()</code> 
    routine yourself if you want it to do any extra shenanigans. The compiler 
    won't call it for you at runtime like it would at compile time.</p>
<p>When you define a helping verb such as "is" or "does", it not only makes 
    it a postfix operator for declarations, but a unary operator within 
    class and role closures. Likewise, declarative closure blocks like <code>BEGIN</code> 
    and <code>INIT</code> are actually trait verbs, albeit ones that can 
    add multiple closures to a queue rather than adding a single property. 
    This implies that something like</p>
<pre><code>
    sub foo {
        LEAVE {...}
        ...
    }</code></pre>
<p>could (except for scoping issues) equivalently be written:</p>
<pre><code>
    sub foo LEAVE {...} {
        ...
    }</code></pre>
<p>Though why you'd want to that, I don't know. Hmm, if we really generalize 
    trait verbs like that, then you could also write things like:</p>
<pre><code>
    sub foo {
        is signature ('int $x');
        is cached;
        returns Int;
        ...
    }</code></pre>
<p>That's getting a little out there. Maybe we won't generalize it quite 
    that far...</p>














<p><em>Editor's Note: this Apocalypse is out of date and remains here for historic reasons.  See <a href="http://dev.perl.org/perl6/doc/design/syn/S12.html">Synopsis 12</a> for the latest information.</em></p>

<h3><a name="delegation">Delegation</a></h3>
<p>Delegation is the art of letting someone else do your work for you. The 
    fact that you consider it "your" work implies that delegation is actually 
    a means of taking credit in advance for what someone else is going to 
    do. In terms of objects, it means pretending that some other object's 
    methods are your own. Now, as it happens, you can always do that by 
    hand simply by writing your own methods that call out to another object's 
    methods of the same name. So any shorthand for doing that is pure syntactic 
    sugar. That's what we're talking about here.</p>
<p>Delegation in this sugary sense always requires there to be an attribute 
    to keep a reference to the object we're delegating to. So our syntactic 
    relief will come in the form of annotations on a "<code>has</code>" 
    declaration. We could have decided to instead attach annotations to 
    each method declaration associated with the attribute, but by the time 
    you do this, you've repeated so much information that you almost might 
    as well have written the non-sugary version yourself. I know that for 
    a fact, because that's how I originally proposed it. <code>:-)</code></p>
<p>Delegation is specified by a "handles" trait verb with an argument specifying 
    one or more method names that the current object and the delegated object 
    will have in common:</p>
<pre><code>
    has $:tail handles 'wag';</code></pre>
<p>Since the method name (but nothing else) is known at class construction 
    time, the following <code>.wag</code> method is autogenerated for you:</p>
<pre><code>
    method wag (*@args is context(Lazy)) { $:tail.wag(*@args) }</code></pre>
<p>(It's necessary to specify a <code>Lazy</code> context for the arguments 
    to a such a delegator method because the actual signature is supplied 
    by the tail's <code>.wag</code> method, not your method.) So as you 
    can see, the delegation syntax already cuts our typing in half, not 
    to mention the reading. The win is even greater when you specify multiple 
    methods to delegate:</p>
<pre><code>
    has $:legs handles &laquo;walk run lope shake pee&raquo;;</code></pre>
<p>Or equivalently:</p>
<pre><code>
    has $:legs handles ['walk', 'run', 'lope', 'shake', 'pee'];</code></pre>
<p>You can also say things like</p>
<pre><code>
    my @legmethods := &laquo;walk run lope shake pee&raquo;;
    has $:legs handles (@legmethods);</code></pre>
<p>since the "<code>has</code>" declaration is evaluated at class construction 
    time.</p>
<p>Of course, it's illegal to call the outer method unless the attribute 
    has been initialized to an object of a type supporting the method. So 
    a declaration that makes a new delegatee at object build time might 
    be specified like this:</p>
<pre><code>
    has $:tail handles 'wag' will build { Tail.new(*%_) };</code></pre>
<p>or, equivalently,</p>
<pre><code>
    has $:tail handles 'wag' = { Tail.new(*%_) };</code></pre>
<p>This automatically performs</p>
<pre><code>
    $:tail = Tail.new(*%_);</code></pre>
<p>when <code>BUILD</code> is called on a new object of the current class 
    (unless <code>BUILD</code> initializes <code>$:tail</code> to some other 
    value). Or, since you might want to declare the type of the attribute 
    without duplicating it in the default value, you can also say</p>
<pre><code>
    has Tail $:tail handles 'wag' = { .new(*%_) };</code></pre>
<p>or</p>
<pre><code>
    has Tail $:tail handles 'wag' will build { .new(*%_) };</code></pre>
<p>Note that putting a <code>Tail</code> type on the attribute does not 
    necessarily mean that the method is always delegated to the <code>Tail</code> 
    class. The dispatch is still based on the <em>runtime</em> type of 
    the object, not the declared type. So</p>
<pre><code>
    has Tail $:tail handles 'wag' = { LongTail.new(*%_) };</code></pre>
<p>delegates to the <code>LongTail</code> class, not the <code>Tail</code> 
    class. Of course, you'll get an exception at build time if you try to 
    say:</p>
<pre><code>
    has Tail $:tail handles 'wag' = { Dog.new(*%_) };</code></pre>
<p>since <code>Dog</code> is not derived from <code>Tail</code> (whether 
    or not the tail can wag the dog).</p>
<p>We declare <code>$:tail</code> as a private attribute here, but <code>$.tail</code> 
    would have worked just as well. A <code>Dog</code>'s tail does seem 
    to be a public interface, after all. Kind of a read-only accessor.</p>
<h4><a name="wildcard_delegation">Wildcard Delegation</a></h4>
<p>We've seen that the argument to "<code>handles</code>" can be a string 
    or a list of strings. But any argument or subargument that is not a 
    string is considered to be a smartmatch selector for methods. So you 
    can say:</p>
<pre><code>
    has $:fur handles /^get_/;</code></pre>
<p>and then you can do the <code>.get_wet</code> or <code>.get_fleas</code> 
    methods (presuming there are such), but you can't call the <code>.shake</code> 
    or <code>.roll_in_the_dirt</code> methods. (Obviously you don't want 
    to delegate the <code>.shake</code> method since that means something 
    else when applied to the <code>Dog</code> as a whole.)</p>
<p>If you say</p>
<pre><code>
    has $:fur handles Groomable;</code></pre>
<p>then you get only those methods available via the <code>Groomable</code> 
    role or class.</p>
<p>Wildcard matches are evaluated only after it has been determined that 
    there's no exact match to the method name. They therefore function as 
    a kind of autoloading in the overall pecking order. If the class also 
    has an <code>AUTOLOAD</code>, it is called only if none of the wildcard 
    delegations match. (An <code>AUTOMETHDEF</code> is called much earlier, 
    since it knows from the stub declarations whether there is supposed 
    to be a method of that name. So you can think of explicit delegation 
    as a kind of autodefine, and wildcard delegation as a kind of autoload.)</p>
<p>When you have multiple wildcard delegations to different objects, it's 
    possible to have a conflict of method names. Wildcard method matches 
    are evaluated in order, so the earliest one wins. (Non-wildcard method 
    conflicts can be caught at class composition time.)</p>
<h4><a name="renaming_delegated_methods">Renaming Delegated Methods</a></h4>
<p>If, where you would ordinarily specify a string, you put a pair, then 
    the pair maps the method name in this class to the method name in the 
    other class. If you put a hash, each key/value pair is treated as such 
    a mapping. Such mappings are not considered wildcards.</p>
<pre><code>
    has $:fur handles { :shakefur&laquo;shake&raquo; :scratch&laquo;get_fleas&raquo; };</code></pre>
<p>Perhaps that reads better with the old pair notation:</p>
<pre><code>
    has $:fur handles { shakefur =&gt; 'shake', scratch =&gt; 'get_fleas' };</code></pre>
<p>You <em>can</em> do a wildcard renaming, but not with pairs. Instead 
    do smartmatch with a substitution:</p>
<pre><code>
    has $:fur handles (s/^furget_/get_/);</code></pre>
<p>As always, the left-to-right mapping is from this class to the other 
    one. The pattern matching is working on the method name passed to us, 
    and the substituted method name is used on the class we delegate to.</p>
<h4><a name="delegation_without_an_attribute">Delegation Without an Attribute</a></h4>
<p>Ordinarily delegation is based on an attribute holding an object reference, 
    but there's no reason in principle why you have to use an attribute. 
    Suppose you had a <code>Dog</code> with two tails. You can delegate 
    based on a method call:</p>
<pre><code>
    method select_tail handles &laquo;wag hang&raquo; {...}</code></pre>
<p>The arguments are sent to both the delegator and delegatee method. So 
    when you call</p>
<pre><code>
    $dog.wag(:fast)</code></pre>
<p>you're actually calling</p>
<pre><code>
    $dog.select_tail(:fast).wag(:fast)</code></pre>
<p>If you use a wildcard delegation based on a method, you should be aware 
    that it has to call the method before it can even decide whether there's 
    a valid method call to the delegatee or not. So it behooves you not 
    to get too fancy with <code>select_tail()</code>, since it might just 
    have to throw all that work away and go on to the next wildcard specification.</p>
<h4><a name="delegation_of_handlers">Delegation of Handlers</a></h4>
<p>If your delegation object happens to be an array:</p>
<pre><code>
    has @:handlers handles 'foo';</code></pre>
<p>then something cool happens. &lt;cool rays&gt; In this case Perl 6 assumes 
    that your array contains a list of potential handlers, and you just 
    want to call the <em>first</em> one that succeeds. This is not considered 
    a wildcard match unless the "handles" argument forces it to be.</p>
<p>Note that this is different from the semantics of a hyper method such 
    as <code>@objects&raquo;.foo()</code>, which will try to call the method 
    on <em>every</em> object in <code>@objects</code>. If you want to do 
    that, you'll just have to write your own method:</p>
<pre><code>
    has @:ears;
    method twitchears () { @:ears&raquo;.twitch() }</code></pre>
<p>Life is hard.</p>
<h4><a name="hashbased_redispatch">Hash-Based Redispatch</a></h4>
<p>If your delegation object happens to be a hash:</p>
<pre><code>
    has %:objects handles 'foo';</code></pre>
<p>then the hash provides a mapping from the string value of "self" to the 
    object that should be delegated to:</p>
<pre><code>
    has %:barkers handles &quot;bark&quot; =
                (Chihauhau =&gt; $yip,
                    Beagle =&gt; $yap,
                   Terrier =&gt; $arf,
                 StBernard =&gt; $woof,
                );
    method prefix:~( return &quot;$.breed&quot; )</code></pre>
<p>If the string is not found in the hash, a "<code>next METHOD</code>" 
    is automatically performed.</p>
<p>Again, this construct is not necessarily considered a wildcard. In the 
    example above we know for a fact that there's supposed to be a <code>.bark</code> 
    method somewhere, therefore a specific method can be autogenerated in 
    the current class.</p>
	










	

<p><em>Editor's Note: this Apocalypse is out of date and remains here for historic reasons.  See <a href="http://dev.perl.org/perl6/doc/design/syn/S12.html">Synopsis 12</a> for the latest information.</em></p>
	
<h4><a name="relationship_to_roles">Relationship to Roles</a></h4>
<p>Delegation is a means of including a set of methods into your class. 
    Roles can also include a set of methods in your class, but the difference 
    is that what a role includes happens at class composition time, while 
    delegation is much more dynamic, depending on the current state of 
    the delegating attribute (or method).</p>
<p>But there's no reason you can't have your cake and eat it too, because 
    roles are specifically designed to allow you to pull in delegations 
    without the class even being aware of the fact that it's delegating. 
    When you include a role, you're just signing up for a set of methods, 
    with maybe a little state thrown in. You don't care whether those methods 
    are defined directly, or indirectly. The role manages that.</p>
<p>In fact, this is one of the primary motivators for including roles in 
    the design of Perl 6. As a named abstraction, a role lets you refactor 
    all the classes using that role without changing any of the classes 
    involved. You can turn your single "god" object into a set of nicely 
    cooperating objects transparently. Well, you have to do the composition 
    using roles first, and that's not transparent.</p>
<p>Note that all statically named methods are dispatched before any wildcard 
    methods, regardless of whether the methods came from a role or the class 
    itself. (Inherited methods also come before wildcard methods because 
    we order all the cachable method dispatches before all the non-cachable 
    ones. But see below.) So the lookup order is:</p>
<ol>
    <li> This class's declared methods (including autodefs and delegations) 
    </li>
    <li> An included role's declared methods (including autodefs and delegations) 
    </li>
    <li> Normal inherited methods (including autodefs and delegations of 
        the parent class) </li>
    <li> Wildcard delegated methods in this class (or failing that, from 
        any inherited class that does wildcard delegations) </li>
    <li> Methods autoloaded by an autoloader defined in this class (or failing 
        that, an autoloader from any inherited class) </li>
</ol>
<p>Note that any method that is stubbed (declared but not yet defined) in 
    steps 1 or 2 skips straight to step 4, because it means this class thinks 
    it "owns" a method of that name. (At this point Perl 5 would skip straight 
    to step 5, but Perl 6 still wants to do wildcard delegation before falling 
    back on inherited autoloading.)</p>
	
	
	
<h4><a name="anonymous_delegation_for_isa_emulation">Anonymous Delegation 
    for ISA Emulation</a></h4>
<p>When you inherit from a class with a different layout policy, Perl has 
    to emulate inheritance via anonymous delegation. In this case it installs 
    a wildcard delegation for you. According to the list above, this gives 
    precedence to all methods with the same layout policy over all methods 
    with a different layout policy. This might be a feature, especially 
    when calling cross-language. Then again, maybe it isn't.</p>
<p>There is no "<code>has</code>" variable for such an anonymous delegation. 
    Its delegated object is stored as a property on the class's entry in 
    the ISA list, probably. (Or we could autogenerate an attribute whose 
    name is related to the class name, I suppose.)</p>
<p>Since one of the primary motivations for allowing this is to make it 
    possible to call back and forth between Perl 5 and Perl 6 objects, we 
    need to make that as transparent as possible. When a Perl 6 object inherits 
    from a Perl 5 object, it is emulated with delegation. The invocant passed 
    into the Perl 5 (Ponie) object looks like a Perl 5 object to Perl 5. 
    However, if the Perl 5 object passes that as an invocant back into Perl 
    6, it has to go back to looking like a Perl 6 object to Perl 6, or our 
    emulation of inheritance is suboptimal. When a Ponie object accesses 
    its attributes through what it <em>thinks</em> is a hash reference, 
    it really has to call the appropriate Perl 6 accessor function if the 
    object comes from Perl 6. Likewise, when Perl 6 calls an accessor on 
    a Perl 5 object, it has to translate that method call into a hash lookup--presuming 
    that the Perl 5 object is implemented as a blessed hash.</p>
<p>Other language boundaries may or may not do similar tricks. Python's 
    attributes suffer from the same misdesign as Perl 5's attributes. (My 
    fault for copying Python's object model. <code>:-)</code> So that'd 
    be a good place for a similar policy.</p>
<p>So we can almost certainly emulate inheritance with delegation, albeit 
    with some possible misordering of classes if there are duplicate method 
    names. However, the hard part is constructing objects. Perl 5 doesn't 
    enforce a policy of named arguments for its constructors, so it is difficult 
    for a Perl 6 <code>BUILDALL</code> routine to have any automatic way 
    to call a Perl 5 constructor. It's tempting to install glue code into 
    the Perl 6 class that will do the translation, but that's really not 
    a good idea, because someday the Perl 5 class may eventually get translated 
    to a Perl 6 class, and your glue code will be useless, or worse.</p>
<p>So the right place to put the glue is actually back into the Perl 5 class. 
    If a Perl 5 class defines a <code>BUILD</code> subroutine, it will be 
    assumed that it properly handles named pairs in Perl 5's even/odd list 
    format. That will be used in lieu of any predefined constructor named 
    "<code>new</code>" or anything else.</p>
<p>If there is no <code>BUILD</code> routine in the Perl 5 package, but 
    there is a "<code>use fields</code>" declaration, then we can autogenerate 
    a rudimentary <code>BUILD</code> routine that should suffice for most 
    scalar attributes.</p>

<h3><a name="types_and_subtypes">Types and Subtypes</a></h3>
<p>I've always really liked the Ada distinction between types and subtypes. 
    A type is something that adds capabilities, while a subtype is something 
    that takes away capabilities. Classes and roles generally function as 
    types in Perl 6. In general you don't want to make a subclass that, 
    say, restricts your integers to only even numbers, because then you've 
    violated Liskov substitutability. In the same way that we force role 
    composition to be "before" classes, we will force subtyping constraints 
    to be "after" classes. In both cases we force it by a declarator change 
    so that you are unlikely to confuse a role with a class, or a class 
    with a subtype. And just as you aren't allowed to derive a role from 
    a class, you aren't allowed to derive a class from a constrained type.</p>
<p>On the other hand, a bit confusingly, it looks like subtyping will be 
    done with the "type" keyword, since we aren't using that word yet.</p>
<p>To remind people that a subtype of a class is just a constrained alias 
    for the class, we avoid the "is" word and declare a type using a <code>::=</code> 
    compile-time alias, like this:</p>
<pre><code>
    type Str_not2b ::= Str where /^[isnt|arent|amnot|aint]$/;</code></pre>
<p>The <code>::=</code> doesn't create the type, nor in fact does the <code>type</code> 
    keyword. It's actually the <code>where</code> that creates the type. 
    The <code>type</code> keyword just marks the name as "not really a classname" 
    so that you don't accidentally try to derive from it.</p>
<p>Since a type is "post-class-ical", there's really no such thing as an 
    object blessed into a type. If you try it, you'll just end up with an 
    object blessed into whatever the underlying unconstrained class is, 
    as far as inheritance is concerned. A type is not a subclass. A type 
    is primarily a handy way of sneaking smartmatching into multiple dispatch. 
    Just as a role allows you to specify something more general than a class, 
    a type allows you to specify something more specific than a class.</p>
<p>While types are primarily intended for restricting parameter types for 
    multiple dispatch, they also let you impose preconditions on assignment. 
    Basically, if you declare any container with a subtype, Perl will check 
    the constraint against any value you might try to bind or assign to 
    the container.</p>
<pre><code>
    type Str_not2b ::= Str where /^[isnt|arent|amnot|aint]$/;
    type EvenNum   ::= Num where { $^n % 2 == 0 }
                                                                            
    my Str_not2b $hamlet;
    $hamlet = 'isnt';   # Okay because 'isnt' ~~ /^[isnt|arent|amnot|aint]$/
    $hamlet = 'amnt';   # Bzzzzzzzt!   'amnt' !~ /^[isnt|arent|amnot|aint]$/
                                                                            
    my EvenNum $n;
    $n = 2;             # Okay
    $n = -2;            # Okay
    $n = 0;             # Okay
    $n = 3;             # Bzzzzzzzt</code></pre>
<p>It's perfectly legal to base one subtype on another. It merely adds an 
    additional constraint.</p>
<p>It's possible to use an anonymous subtype in a signature:</p>
<pre><code>
    use Rules::Common :profanity;</code></pre>
<pre><code>
    multi sub mesg (Str where /&lt;profanity&gt;/ $mesg is copy) {
        $mesg ~~ s:g/&lt;profanity&gt;/[expletive deleted]/;
        print $MESG_LOG: $mesg;
    }
                                                                            
    multi sub mesg (Str $mesg) {
        print $MESG_LOG: $mesg;
    }</code></pre>
<p>Given a set of multimethods that would "tie" on the actual classes of 
    the arguments, a multimethod with a matching constraint will be preferred 
    over an equivalent one with no constraint. So the first <code>mesg</code> 
    above is preferred if the constraint matches, and otherwise the second 
    is preferred. However, if two multis with constraints match (and are 
    otherwise equivalent), it's just as if you'd called any other set of 
    ambiguous multimethods, and one of them had better be marked as the 
    default, or you die.</p>
<p>We say that types are "post-class-ical", but since you can base them 
    off of any class including <code>Any</code>, they are actually rather 
    orthogonal to the class system.</p>

<h3><a name="enums">Enums</a></h3>
<p>An enum functions as a subtype that is constrained to a single value. 
    (When a subtype is constrained to a single value, it can be used for 
    that value.) But rather than declaring it as:</p>
<pre><code>
    type DayOfWeek ::= Int where 0..6;
    type DayOfWeek::Sunday    ::= DayOfWeek where 0;
    type DayOfWeek::Monday    ::= DayOfWeek where 1;
    type DayOfWeek::Tuesday   ::= DayOfWeek where 2;
    type DayOfWeek::Wednesday ::= DayOfWeek where 3;
    type DayOfWeek::Thursday  ::= DayOfWeek where 4;
    type DayOfWeek::Friday    ::= DayOfWeek where 5;
    type DayOfWeek::Saturday  ::= DayOfWeek where 6;</code></pre>
<p>we allow a shorthand:</p>
<pre><code>
    type DayOfWeek ::= int enum
        &laquo;Sunday Monday Tuesday Wednesday Thursday Friday Saturday&raquo;;</code></pre>
<p>Type int is the default enum type, so that can be:</p>
<pre><code>
    type DayOfWeek ::= enum
        &laquo;Sunday Monday Tuesday Wednesday Thursday Friday Saturday&raquo;;</code></pre>
<p>The enum installer inspects the strings you give it for things that look 
    like pairs, so to number your days from 1 to 7, you can say:</p>
<pre><code>
    type DayOfWeek ::= enum
        &laquo;:Sunday(1) Monday Tuesday Wednesday Thursday Friday Saturday&raquo;;</code></pre>
<p>You can import individual enums into your scope where they will function 
    like argumentless constant subs. However, if there is a name collision 
    with a sub or other enum, you'll have to disambiguate. Unambiguous enums 
    may be used as a property on the right side of a "but", and the enum 
    type can be intuited from it to make sure the object in question has 
    the right semantics mixed in. Two builtin enums are:</p>
<pre><code>
    type bool ::= bit enum &laquo;false true&raquo;;
    type taint ::= bit enum &laquo;untainted tainted&raquo;;</code></pre>














<p><em>Editor's Note: this Apocalypse is out of date and remains here for historic reasons.  See <a href="http://dev.perl.org/perl6/doc/design/syn/S12.html">Synopsis 12</a> for the latest information.</em></p>

<h3><a name="open_vs_closed_classes">Open vs. Closed Classes</a></h3>
<p>By default, classes in Perl are left open. That is, you can add more 
    methods to them, though you have to be explicit that that is what you're 
    doing:</p>
<pre><code>
    class Object is extended {
        method wow () { say &quot;Wow, I'm an object.&quot; }
    }</code></pre>
<p>Otherwise you'll get a class redefinition error.</p>
<p>Likewise, a "final" class (to use the Java term) is one that you know 
    will never be derived from, let alone mucked with internally.</p>
<p>Now, it so happens that leaving all your classes open is not terribly 
    conducive to certain kinds of optimization (let alone encapsulation). 
    From the standpoint of the compiler, you'd like to be able to say, "I 
    know this class will never be derived from or modified, so I can do 
    things like access my attributes directly without going through virtual 
    accessors." We were, in fact, tempted to make closed classes the default. 
    But this breaks in frameworks like mod_perl where you cannot predict 
    in advance which classes will want to be extended or derived from.</p>
<p>Some languages solve this (or think they solve it) by letting classes 
    declare themselves to be closed and/or final. But that's actually a 
    bad violation of OO principles. It should be the <em>users</em> of a 
    class that decide such things--and decide it for themselves, not for 
    others. As such, there has to be a consensus among all users of a class 
    to close or finalize it. And as we all know, consensus is difficult 
    to achieve.</p>
<p>Nevertheless, the Perl 6 approach is to give the top-level application 
    the right to close (and finalize) classes. But we don't do this by simply 
    listing the classes we want to close. Instead, we use the sneaky strategy 
    of switching the default to closed and then list the classes we want 
    to stay open.</p>
<p>The benefit of this is that modules other than the top level can simply 
    list all the classes that they know should stay open. In an open framework, 
    these are, at worst, no-ops, and they don't cause classes to close that 
    other modules might want to remain open. If <em>any</em> module requests 
    a class to stay open, it stays open. If <em>any</em> module requests 
    that a class remain available as a base class, it remains available.</p>
<p>It has been speculated that optimizer technology in Parrot will develop 
    such that a class can conjecturally be compiled as closed, and then 
    recompiled as open should the need arise. (This is just a specific case 
    of the more general problem of what you do whenever the assumptions 
    of the optimizer are violated.) If we get such an on-the-fly optimizer/pessimizer, 
    then our open class declarations are still not wasted--they will tell 
    the optimizer which classes not to bother trying to close or finalize 
    in the first place. Setting the default the other way wouldn't have 
    the same benefit.</p>
<p>Syntax? You want syntax? Hmm.</p>
<pre><code>
    use classes :closed :open&laquo;Mammal Insect&raquo;;</code></pre>
<p>Or some such. Maybe certain kinds of class reference automatically request 
    the class to be open without a special pragma. A module could request 
    open classes without attempting to close everything with just:</p>
<pre><code>
    use classes :open&laquo;Mammal Insect&raquo;;</code></pre>
<p>On the other hand, maybe that's another one of those inside-out interfaces, 
    and it should just be options on the classes whose declarations you 
    have to include anyway:</p>
<pre><code>
    use classes :closed;
    class Mammal is open {...}
    class Insect is open {...}</code></pre>
<p>Similarly, we can finalize classes by default and then "take it back" 
    for certain classes:</p>
<pre><code>
    use classes :final;
    class Mammal is base {...}
    class Insect is base {...}</code></pre>
<p>In any event, even though the default is expressed at the top of the 
    main application, the final decision on each class is not made by the 
    compiler until <code>CHECK</code> time, when all the compiled code has 
    had a chance to stake its claims. (A JIT compiler might well wait even 
    longer, in case runtime evaluated code wishes to express an opinion.)</p>

<h3><a name="interface_consistency">Interface Consistency</a></h3>
<p>In theory, a subclass should always act as a more specialized version 
    of a superclass. In terms of the design-by-contract theory, a subclass should 
    OR in its preconditions and AND in its postconditions. In terms of Liskov 
    substitutability, you should always be able to substitute a derived 
    class object in where a base class object is expected, and not have 
    it blow up. In terms of Internet policy, a derived class (compared to 
    its base class) should be at least as lenient in what it accepts, and 
    at least as strict in what it emits.</p>
<p>So, while it would be lovely in a way to require that derived methods 
    of the same name as a base method must use the same signature, in practice 
    that doesn't work out. A derived class often has to be able to add arguments 
    to the signature of a method so that it can "be more lenient" in what 
    it accepts as input.</p>
<p>But this poses a problem, insofar as the user of the derived object does 
    not know whether all the methods of a given name support the same interface. 
    Under <code>SUPER</code> semantics, one can at least assume that the 
    derived class will "weed out" any arguments that would be detrimental 
    to its superclass. But as we have already pointed out, there isn't a 
    single superclass under MI, and each superclass might need to have different 
    "detrimental arguments" weeded out. One could say that in that case, 
    you don't call <code>SUPER</code> but rather call out to each superclass 
    explicitly. But then you're back to the problem that <code>SUPER</code> 
    was designed to solve. And you haven't solved <code>SUPER</code>'s problem 
    either.</p>
<p>Under <code>NEXT</code> semantics, we assume that we are dispatching 
    to a set of methods with the same name, but potentially different signatures. 
    (Perl 6's <code>SUPER</code> implementation is really a limited form 
    of <code>NEXT</code>, insofar as <code>SUPER</code> indicates a set 
    of parent methods, unlike in Perl 5 where it picks one.) We need a way 
    of satisfying different signatures with the same set of arguments.</p>
<p>There are, in fact, two ways to approach this. One way is to say, okay 
    everything is a multimethod, and we just won't call anything whose signature 
    is irreconcilably inconsistent with the arguments presented. Plus there 
    are varying degrees of consistency within the set of "consistent" interfaces, 
    so we try them in decreasing order of consistency. A more consistent 
    multi is allowed to fall back to a less consistent multi with "<code>next 
    METHOD</code>".</p>
<p>But as a variant of the "pick one" mentality, that still doesn't help 
    the situation where you want to send a message to all your ancestor 
    classes (like "Please Mr. Base Class, help me initialize this object."), 
    but you want to be more specific with some classes than others ("Please 
    Miss Derived Class, set your <code>$.prim</code> attribute to 1."). 
    So the other approach is to use named arguments that can be ignored 
    by any classes that don't grok the argument.</p>
<p>So what this essentially comes down to is the fact that all methods and 
    submethods of classes that might be derived from (which is essentially 
    all classes, but see the previous section) must have a <code>*%</code> 
    parameter, either explicitly or implicitly, to collect up and render 
    harmless any unrecognized option pairs in the argument list. So the 
    ruling is that all methods and submethods that do not declare an explicit 
    <code>*%</code> parameter will get an implicit <code>*%_</code> parameter 
    declared for them whether they like it or not. (Subroutines are not 
    granted this "favor".)</p>
<p>It might be objected that this will slow down the parameter binding algorithm 
    for all methods favored with an implicit <code>*%_</code>, but I would 
    argue that the binding code doesn't have to do anything till it sees 
    a named parameter it doesn't recognize, and then it can figure out whether 
    the method even references <code>%_</code>, and if not, simply throw 
    the unrecognized argument away instead of constructing a <code>%_</code> 
    that won't be used. And most of this "figuring out" can be done at compile 
    time.</p>
<p>Another counterargument is that this prevents a class from recognizing 
    typos in argument names. That's true. It might be possible to ask for 
    a warning that checks globally (at class-finalization time in the optimizer?) 
    to see if there is any method of that name anywhere that is interested 
    in a parameter of that name. But any class that gets its parameters 
    out of a <code>*%</code> hash at runtime would cause false positives, 
    unless we assume that any <code>*%</code> hash makes any argument name 
    legal, in which case we're pretty much back to where we started, unless 
    we do analysis of the usage of all <code>*%</code> hash in those methods, 
    and count things like <code>%_&laquo;prim&raquo;</code> as proper parameter 
    declarations. And that can still be spoofed in any number of ways. Plus 
    it's not a trivial warning to calculate, so it probably wouldn't be 
    the default in a load-and-go interpreter.</p>
<p>So I think we basically have to live with possible typos to get proper 
    polymorphic dispatch. If something is frequently misspelled, then you 
    could always put in an explicit test against <code>%_</code> for that 
    argument:</p>
<pre><code>
    warn &quot;Didn't you mean :the(%_&laquo;teh&raquo;)?&quot; if %_&laquo;teh&raquo;;</code></pre>
<p>And perhaps we could have a pragma:</p>
<pre><code>
    use signatures :exact;</code></pre>
<p>But it's possible that the correct solution is to differentiate two kinds 
    of "isa", one that derives from "nextish" classes, and one that derives 
    from "superish" classes. A "<code>next METHOD</code>" traversal would 
    assume that any delegation to a super class would be handled explicitly 
    by the current class's methods. That is, a "superish" inheritance hides 
    the base class from <code>.*</code> and <code>.+</code>, as well as 
    "<code>next METHOD</code>".</p>
<p>On the other hand, if we marked the super class itself, we could refrain 
    from generating <code>*%</code> parameters for its methods. Any "next" 
    dispatcher would then have to "look ahead" to see if the next class 
    was a "superish" class, and bypass it. I haven't a clue what the syntax 
    should be though. We could mark the class with a "superish" trait, which 
    wouldn't be inheritable. Or we could mark it with a Superish role, which 
    would be inheritable, and a base class would have to override it to 
    impose a Nextish role instead. (But then what if one parent class is 
    Superish and one is Nextish?) Or we could even have two different metaclasses, 
    if we decide the two kinds of classes are fundamentally different beasts. 
    In that case we'd declare them differently using "class" and some other 
    keyword. Of course, people will want to use "class" for the type they 
    prefer, and the other keyword for the type they don't prefer. :-)</p>
<p>But since we're attempting to bias things in favor of nextish semantics, 
    that would be a "class", and the superish semantics might be a "guthlophikralique" 
    or some such. <code>:-)</code></p>
<p>Seriously, if we mark the class, "<code>is hidden</code>" can hide the 
    current class from "<code>next METHOD</code>" semantics. The problem 
    with that is, how do you apply the trait to a class in a different language? 
    That argues for marking the "isa" instead. So as usual when we can't 
    make up our minds, we'll just have it both ways. To mark the class itself, 
    use "<code>is hidden</code>". To mark the "isa", use "<code>hides Base</code>" 
    instead of "<code>is Base</code>". In neither case will "<code>next 
    METHOD</code>" traverse to such a class. (And no <code>*%_</code> will 
    be autogenerated.) </p>
<p>For example, here are two base classes that know about "<code>next METHOD</code>":</p>
<pre><code>
    class Nextish1 { method dostuff() {...; next;}
    class Nextish2 { method dostuff() {...; next;}</code></pre>
<pre><code>
    class MyClass is Nextish1 is Nextish2 {
        method dostuff () {...; next;}
    }</code></pre>
<p>Since all the base classes are "next-aware", <code>MyClass</code> knows 
    it can just defer to "next" and both parent classes' <code>dostuff</code> 
    methods will be called. However, suppose one of our base classes is 
    old-fashioned and thinks it should call things with <code>SUPER::</code> 
    instead. (Or it's a class off in Python or Ruby.) Then we have to write 
    our classes more like this:</p>
<pre><code>
    class Superish { method dostuff(...; .*SUPER::dostuff(); }
    class Nextish { method dostuff() {...; next;}</code></pre>
<pre><code>
    class MyClass hides Superish is Nextish {
        method dostuff () {
            .Superish::dostuff();       # do Superish::dostuff()
            next;                       # do Nextish::dostuff()
        }
    }</code></pre>
<p>Here, <code>MyClass</code> knows that it has two very different base 
    classes. <code>Nextish</code> knows about "<code>next</code>", and <code>Superish</code> 
    doesn't. So it delegates to <code>Superish::dostuff()</code> differently 
    than it delegates to <code>Nextish::dostuff()</code>. The fact that 
    it declared "<code>hides Superish</code>" prevents <code>next</code> 
    from visiting the Superish class.</p>














<p><em>Editor's Note: this Apocalypse is out of date and remains here for historic reasons.  See <a href="http://dev.perl.org/perl6/doc/design/syn/S12.html">Synopsis 12</a> for the latest information.</em></p>

<h3><a name="collections_of_classes">Collections of Classes</a></h3>
<h4><a name="in_classes">In Classes</a></h4>
<p>We'd like to be able to support virtual inner classes. You can't have 
    virtual inner classes unless you have a way to dispatch to the actual 
    class of the invocant. That says to me that the solution is bound up 
    intimately with the method dispatcher, and the syntax of naming an inner 
    class has to know about the invocant in whose context we have to start 
    searching for the inner class. So we could have an explicit syntax like:</p>
<pre><code>
    class Base {
        our class Inner { ... }
        has Inner $inner;
        submethod BUILD { .makeinner; }
        method makeinner ($self:){
            my Inner $thing .= $self.Inner.new();
            return $thing;
        }
    }</code></pre>
<pre><code>
    class Middle is Base {
        our class Inner is Base::Inner { ... }
    }</code></pre>
<pre><code>
    class Derived is Middle {
    }</code></pre>
<p>When you say <code>Derived.new()</code>, it creates a <code>Derived</code> 
    object, calls <code>Derived::BUILDALL</code>, which eventually calls 
    <code>Base::BUILD</code>, which makes a <code>Middle::Inner</code> object 
    (because that's what the virtual method <code>$self.Inner</code> returns) 
    and puts it in a variable that of the <code>Base::Inner</code> type 
    (which is fine, since <code>Middle::Inner</code> ISA <code>Base::Inner</code>. 
    Whew!</p>
<p>The only extra magic here is that an inner class would have to autogenerate 
    an accessor method (of the same name) that returns the class. A class 
    could then choose to access an inner class name directly, in which case 
    it would get its own inner class of that name, much like <code>$.foo</code> 
    always gets you your own attribute. But if you called the inner class 
    name as a method, it would automatically virtualize the name, and you'd 
    get the most derived existing version of the class.</p>
<p>This would give us most of what RFC 254 is asking for, at the expense 
    of one more autogenerated method. Use of such inner classes would take 
    the connivance of a base class that doesn't mind if derived classes 
    redefine its inner class. Unfortunately, it would have to express that 
    approval by calling <code>$self.Inner</code> explicitly. So this solution 
    does not go as far as letting you change classes that didn't expect 
    to be changed.</p>
<p>It would be possible to take it further, and I think we should. If we 
    say that whenever you use any global class, it makes an inner class 
    on your behalf that is merely an alias to the global class, creating 
    the accessor method as if it were an inner class, then it's possible 
    to virtualize the name of <em>any</em> class, as long as you're in a 
    context that has an appropriate invocant. Then we'd make any class name 
    lookup assume <code>$self.</code> on the front, basically.</p>
<p>This may seem like a wild idea, but interestingly, we're already proposing 
    to do a similar aliasing in order to have multiple versions of a module 
    running simultaneously. In the case of classes, it seems perfectly natural 
    that a new version might derive from an older version rather than redefining 
    everything.</p>
<p>The one fly in the ointment that I can see is that we might not always 
    have an appropriate invocant--for instance, outside any method body, 
    when we're declaring attributes. I guess when there's no dynamic context 
    indicating what an "inner" classname should mean, it should default 
    to the ordinary meaning in the current lexical and/or package context. 
    Within a class definition, for instance, the invocant is the metaclass, 
    which is unhelpful. So generally that means that a declared attribute 
    type will turn out to be a superclass of the actual attribute type at 
    runtime. But that's fine, ain't it? You can always store a <code>Beagle</code> 
    in a <code>Dog</code> attribute.</p>
<p>So in essence, it boils down to this. Within a method, the invocant is 
    allowed to have opinions about the meanings of any class names, and 
    when there are multiple possible meanings, pick the most appropriate 
    one, where that amounts to the name you'd find if the class name were 
    a virtual method name.</p>
<p>Here's the example from RFC 254, translated to Perl 6 (with <code>Frog</code> 
    made into an explicit inner class for clarity (though it should work 
    with any class by the aliasing rule above)):</p>
<pre><code>
    class Forest {
        our class Frog {
            method speak () { say &quot;ribbit ribbit&quot;; }
            method jump  () {...}
            method croak () {...} # ;-)
        }</code></pre>
<pre><code>
        has Frog $.frog;</code></pre>
<pre><code>
        method new ($class) {
            my Frog $frog .= new;       # MAGIC
            return $class.bless( frog =&gt; $frog );
        }
     
        sub make_noise {
            .frog.speak;        # prints &quot;ribbit ribbit&quot;
        }
    }</code></pre>
<p>Now we derive from <code>Forest</code>, producing <code>Forest::Japanese</code>, 
    with its own kind of frogs:</p>
<pre><code>
    class Forest::Japanese is Forest {
        our class Frog is Forest::Frog {
            method speak () { say &quot;kerokero&quot;; }
        }
    }</code></pre>
<p>And finally, we make a forest of that type, and tell it to make a noise:</p>
<pre><code>
    $forest = new Forest::Japanese;
    $forest.make_noise();               # prints &quot;kerokero&quot;</code></pre>
<p>In the Perl 5 equivalent, that would have printed "ribbit ribbit" instead. 
    How did it do the right thing in Perl 6?</p>
<p>The difference is on the line marked "<code>MAGIC</code>". Because <code>Frog</code> 
    was mentioned in a method, and the invocant was of type <code>Forest::Japanese</code> 
    rather than of type <code>Forest</code>, the word "<code>Frog</code>" 
    figured out that it was supposed to mean a <code>Forest::Japanese::Frog</code> 
    rather than a <code>Forest::Frog</code>. The name was "virtual". So 
    we ended up creating a forest with a frog of the appropriate type, even 
    though it might not have occurred to the writer of <code>Forest</code> 
    that a subclass would override the meaning of <code>Frog</code>.</p>
<p>So one object can think that its <code>Frog</code> is Japanese, while 
    another thinks it's Russian, or Mexican, or even Antarctican (if you 
    can find any forests there). Base methods that talk about <code>Frog</code> 
    will automatically find the <code>Frog</code> appropriate to the current 
    invocant. This works even if <code>Frog</code> is an outer class rather 
    than an inner class, because any outer class referenced by a base class 
    is automatically aliased into the class as a fake inner class. And the 
    derived class doesn't have to redefine its <code>Frog</code> by declaring 
    an inner class either. It can just alias (or use) a different outer 
    <code>Frog</code> class in as its fake inner class. Or even a different 
    version of the same <code>Frog</code> class, if there are multiple versions 
    of it in the library.</p>
<p>And it just works.</p>
<h4><a name="in_modules">In Modules</a></h4>
<p>It's also possible to put a collection of classes into a module, but 
    that doesn't buy you much except the ability to pull them all in with 
    one <code>use</code>, and manage them all with one version number. Which 
    has a lot to be said for it--in the next section.</p>

<h3><a name="versioning">Versioning</a></h3>
<p>Way back at the beginning, we claimed that a file-scoped class declaration:</p>
<pre><code>
    class Dog;
    ...</code></pre>
<p>is equivalent to the corresponding block-scoped declaration:</p>
<pre><code>
    class Dog {...}</code></pre>
<p>While that's true, it isn't the whole truth. A file-scoped class (or 
    module, or package) is the carrier of more metadata than a block-scoped 
    declaration. Perl 6 supports a notion of versions that is file based. 
    But even a class name plus a version is not sufficient to name a module--there 
    also has to be a naming authority, which could be a URI or a CPAN id. 
    This will be discussed more fully in Apocalypse 11, but for now we can 
    make some predictions.</p>
<p>The extra metadata has to be associated with the file somehow. It may 
    be implicit in the filename, or in the directory path leading to the 
    file. If so, then Perl 6 has to collect up this information as modules 
    are loaded and associate it with the top level class or module as a 
    set of properties.</p>
<p>It's also possible that a module could declare properties explicitly 
    to define these and other bits of metadata:</p>
<pre><code>
    author        http://www.some.com/~jrandom
    version       1.2.1
    creator       Joe Random
    description   This class implements camera obscura.
    subject       optics, boxes
    language      ja_JP
    licensed      Artistic|GPL</code></pre>
<p>Modules posted to CPAN or entered into any standard Perl 6 library are 
    required to declare some set of these properties so that installations 
    can know where to keep them, such that multiple versions by different 
    authors can coexist, all of them available to any installed version 
    of Perl. (This is a requirement for any Perl 6 installation. We're tired 
    of having to reinstall half of CPAN every time we patch Perl. We also 
    want to be able to run different versions of the <code>Frog</code> module 
    simultaneously when the <code>Frog</code> requirements of the modules 
    we use are contradictory.)</p>
<p>It's possible that the metadata is supplied by both the declarations 
    and by the file's name or location in the library, but if so, it's a 
    fatal error to use a module for which those two sources contradict each 
    other as to author or version. (In theory, it could also be a fatal 
    error to use modules with incompatible licensing, but a kind warning 
    might be more appreciated.) Likely there will also be some kind of automatic 
    checksumming going on as well to prevent fraudulent distributions of 
    code.</p>
<p>It might simplify things if we make an <code>identifier</code> metadatum 
    that incorporates all of naming authority, package name, and version. 
    But the individual parts still have to be accessible, if only as components 
    of <code>identifier</code>. However we structure it, we should make 
    the <code>identifier</code> the actual declared full name of the class, 
    yet another one of those "long names" that include extra parameters.</p>
<h4><a name="version_declarations">Version Declarations</a></h4>
<p>The syntax of a versioned class declaration looks like this:</p>
<pre><code>
    class Dog-1.2.1-cpan:JRANDOM;
    class Dog-1.2.1-http://www.some.com/~jrandom
    class Dog-1.2.1-mailto:jrandom@some.com</code></pre>
<p>Perhaps those could also have short forms, presuming we can distinguish 
    CPAN ids, web pages, and email addresses by their internal forms.</p>
<pre><code>
    class Dog-1.2.1-JRANDOM;
    class Dog-1.2.1-www.some.com/~jrandom;
    class Dog-1.2.1-jrandom@some.com;</code></pre>
<p>Or maybe using email addresses is a bad idea now in the modern Spam Age. 
    Or maybe Spam Ages should be plural, like the Dark Ages...</p>
<p>In any event, such a declaration automatically aliases the full name 
    of the class (or module) to the short name. So for the rest of the scope, 
    <code>Dog</code> refers to the longer name.</p>
<p>(Though if you refer to <code>Dog</code> within a method, it's considered 
    a virtual class name, so Perl will search any derived classes for a 
    redefined inner <code>Dog</code> class (or alias) before it settles 
    on the least-derived aliased <code>Dog</code> class.)</p>
<p>We lied slightly when we said earlier that only the file-scoped class 
    carries extra metadata. In fact, all of the classes (or modules, or 
    packages) defined within your file carry metadata, but it so happens 
    that the version and author of all your extra classes (or modules, or 
    packages) are forced to be the same as the file's version and author. 
    This happens automatically, and you may not override the generation 
    of these long names, because if you did, different file versions could 
    and would have version collisions of their interior components, and 
    that would be catastrophic. In general you can ignore this, however, 
    since the long names of your extra classes are always automatically 
    aliased back down to the short names you thought you gave them in the 
    first place. The extra bookkeeping is in there only so that Perl can 
    keep your classes straight when multiple versions are running at the 
    same time. Just don't be surprised when you ask for the name of the 
    class and it tells you more than you expected.</p>
	










	

<p><em>Editor's Note: this Apocalypse is out of date and remains here for historic reasons.  See <a href="http://dev.perl.org/perl6/doc/design/syn/S12.html">Synopsis 12</a> for the latest information.</em></p>
	
<h4><a name="use_of_version_and_author_wildcards">Use of Version and Author 
    Wildcards</a></h4>
<p>Since these long names are the actual names of the classes, when you 
    say:</p>
<pre><code>
    use Dog;</code></pre>
<p>you're really asking for something like:</p>
<pre><code>
    use Dog-(Any)-(Any);</code></pre>
<p>And when you say:</p>
<pre><code>
    use Dog-1.2.1;</code></pre>
<p>you're really asking for:</p>
<pre><code>
    use Dog-1.2.1-(Any);</code></pre>
<p>Note that the <code>1.2.1</code> specifies an <em>exact</em> match on 
    the version number. You might think that it should specify a minimum 
    version. However, people who want stable software will specify an exact 
    version and stick with it. They don't want <code>1.2.1</code> to mean 
    a minimum version. They know <code>1.2.1</code> works, so they want 
    that version nailed down forever--at least for now.</p>
<p>To match more than one version, put a range operator in parens:</p>
<pre><code>
    use Dog-(1.2.1..1.2.3);
    use Dog-(1.2.1..^1.3);
    use Dog-(1.2.1...);</code></pre>
<p>What goes inside the parens is in fact any valid smartmatch selector:</p>
<pre><code>
    use Dog-(1.2.1 | 1.3.4)-(/:i jrandom/);
    use Dog-(Any)-(/^cpan\:/)</code></pre>
<p>And in fact they could be closures too. These means the same thing:</p>
<pre><code>
    use Dog-{$^ver ~~ 1.2.1 | 1.3.4}-{$^auth ~~ /:i jrandom/};
    use Dog-{$^ver ~~ Any}-{$^auth ~~ /^cpan\:/}</code></pre>
<p>In any event, however you select the module, its full name is automatically 
    aliased to the short name for the rest of your lexical scope. So you 
    can just say</p>
<pre><code>
    my Dog $spot .= new(&quot;woof&quot;);</code></pre>
<p>and it knows (even if you don't) that you mean</p>
<pre><code>
    my Dog-1.3.4-cpan:JRANDOM $spot .= new(&quot;woof&quot;);</code></pre>
<p>(Again, if you refer to <code>Dog</code> within a method, it's a virtual 
    class name, so Perl will search any derived classes for a redefined 
    <code>Dog</code> class before it settles on the outermost aliased <code>Dog</code> 
    class.)</p>

<h3><a name="introspection">Introspection</a></h3>
<p>It's easy to specify what Perl 6 will provide for introspection: the 
    union of what Perl 6 needs and whatever Parrot provides for other languages. 
    <code>;-)</code></p>
<p>In the particular case of class metadata, the interface should generally 
    be via the class's metaclass instance--the object of type <code>MetaClass</code> 
    that was in charge of building the class in the first place. The metamethods 
    are in the metaobject, not in the class object. (Well, actually, those 
    are the same object, but a class object ignores the fact that it's also 
    a metaobject, and dispatches by default to its own methods, not the 
    ones defined by the metaclass.) To get to the metamethods of an ordinary 
    class object you have to use the <code>.meta</code> method:</p>
<pre><code>
    MyClass.getmethods()        # call MyClass's .getmethods method
    MyClass.meta.getmethods()   # get the method list of MyClass</code></pre>
<p>Unless <code>MyClass</code> has defined or inherited a <code>.getmethods</code> 
    method, the first call is an error. The second is guaranteed to work 
    for Perl 6's standard <code>MetaClass</code> objects. You can also call 
    <code>.meta</code> on any ordinary object:</p>
<pre><code>
    $obj.meta.getmethods();</code></pre>
<p>That's equivalent to</p>
<pre><code>
    $obj.dispatcher.meta.getmethods();</code></pre>
<p>As for which parts of a class are considered metadata--they all are, 
    if you scratch hard enough. Everything that is not stored directly as 
    a trait or property really ought to have some kind of trait-like method 
    to access it. Even the method body closures have to be accessible as 
    traits, since the <code>.wrap</code> method needs to have something 
    to put its wrapper around.</p>
<p>Minimally, we'll have user-specified class traits that look like this:</p>
<pre><code>
    identifier    Dog-1.2.1-http://www.some.com/~jrandom
        name      Dog
        version   1.2.1
        authority http://www.some.com/~jrandom
    author        Joe Random
    description   This class implements camera obscura.
    subject       optics, boxes
    language      ja_JP
    licensed      Artistic|GPL</code></pre>
<p>And there may be internal traits like these:</p>
<pre><code>
    isa           list of parent classes
    roles         list of roles
    disambig      how to deal with ambiguous method names from roles
    layout        P6opaque, P6hash, P5hash, P5array, PyDict, Cstruct, etc.</code></pre>
<p>The <code>layout</code> determines whether one class can actually derive 
    from another or has to fake it. Any P6opaque class can compatibly inherit 
    from any other P6opaque class, but if it inherits from any P5 class, 
    it must use some form of delegation to another invocant. (Hopefully 
    with a smart enough invocant reference that, if the delegated object 
    unknowingly calls back into our layout system, we can recover the original 
    object reference and maintain some kind of compositional integrity.)</p>
<p>The metaclass's <code>.getmethods</code> method returns method-descriptor 
    objects with at least the following properties:</p>
<pre><code>
    name                the name of the method
    signature           the parameters of the method
    returns             the return type of the method
    multi               whether duplicate names are allowed
    do                  the method body</code></pre>
<p>The <code>.getmethods</code> method has a selector parameter that lets 
    you specify whether you want to see a flattened or hierarchical view, 
    whether you're interested in private methods, and so forth. If you want 
    a hierarchical view, you only get the methods actually defined in the 
    class proper. To get at the others, you follow the "isa" trait to find 
    your parent classes' methods, and you follow the "roles" trait to get 
    to role methods, and from parents or roles you may also find links to 
    further parents or roles.</p>
<p>The <code>.getattributes</code> method returns a list of attribute descriptors 
    that have traits like these:</p>
<pre><code>
    name
    type
    scope
    rw
    private
    accessor
    build</code></pre>
<p>Additionally they can have any other variable traits that can reasonably 
    be applied to object attributes, such as <code>constant</code>.</p>
<p>Strictly speaking, metamethods like <code>.isa()</code>, <code>.does()</code>, 
    and <code>.can()</code> should be called through the meta object:</p>
<pre><code>
    $obj.meta.can(&quot;bark&quot;)
    $obj.meta.does(Dog)
    $obj.meta.isa(Mammal)</code></pre>
<p>And they can always be called that way. For convenience you can often 
    omit the <code>.meta</code> call because the base <code>Object</code> 
    type translates any unrecognized <code>.foo()</code> into <code>.meta.foo()</code> 
    if the meta class has a method of that name. But if a derived class 
    overrides such a metamethod, you have to go through the <code>.meta</code> 
    call explicitly to get the original call.</p>
<p>In previous Apocalypses we said that:</p>
<pre><code>
    $obj ~~ Dog</code></pre>
<p>calls:</p>
<pre><code>
    $obj.isa(Dog)</code></pre>
<p>That is not longer the case--you're actually calling:</p>
<pre><code>
    $obj.meta.does(Dog)</code></pre>
<p>which is true if <code>$obj</code> either "does" or "isa" <code>Dog</code> 
    (or "isa" something that "does" <code>Dog</code>). That is, it asks 
    if <code>$obj</code> is likely to satisfy the interface that comes from 
    the <code>Dog</code> role or class. The <code>.isa</code> method, by 
    contrast, is strictly asking if <code>$obj</code> inherits from the 
    <code>Dog</code> class. It's erroneous to call it on a role. Well, okay, 
    it's not strictly erroneous. It will just never return true. The optimizer 
    will love you, and remove half your code.</p>
<p>Note that either of <code>.does</code> or <code>.isa</code> can lie, 
    insofar as you might include an interface that you later override parts 
    of. When in doubt, rely on <code>.can</code> instead. Better yet, rely 
    on your dispatcher to pick the right method without trying to second 
    guess it. (And then be prepared to catch the exception if the dispatcher 
    throws up its hands in disgust...)</p>
<p>By the way, unlike in Perl 5 where <code>.can</code> returns a single 
    routine reference, Perl 6's version of <code>.meta.can</code> returns 
    a "WALK" iterator for a set of routines that match the name. When dereferenced, 
    the iterator gets fed to a dispatcher as if the method had been called 
    in the first place. Note that any wildcard methods (via delegation or 
    <code>AUTOLOAD</code>) are included by default in this list of potential 
    handlers, so there is no reason for subclasses to have to redefine <code>.can</code> 
    to reflect the new names. This does potentially weaken the meaning of 
    <code>.can</code> from "definitely has a method of this name" to "definitely 
    has one or more methods in one or more classes that will try to handle 
    this." But that's probably closer to what you want, and the best we 
    can do when people start fooling around with wildcard methods under 
    MI.</p>
<p>However, that being said, many classes may wish to dynamically specify 
    at the last moment which methods they can or cannot handle. That is, 
    they want a hook to allow a class to declare names even while the <code>.can</code> 
    candidate list is being built. By default <code>.meta.can</code> includes 
    all wildcard delegations and autoloads at the end of the list. However, 
    it will exclude from the list of candidates any class that defines its 
    own <code>AUTOMETH</code> method, on the assumption that each such <code>AUTOMETH</code> 
    method has already had its chance to add any callable names to the list. 
    If the class's <code>AUTOMETH</code> wishes to supply a method, it should 
    return a reference to that method.</p>
<p>Do not confuse <code>AUTOMETH</code> with <code>AUTOMETHDEF</code>. The 
    former is equivalent to declaring a stub declaration. The latter is 
    equivalent to supplying a body for an existing stub. Whether <code>AUTOMETH</code> 
    actually creates a stub, or <code>AUTOMETHDEF</code> actually creates 
    a body, is entirely up to those routines. If they wish to cache their 
    results, of course, then they should create the stub or body.</p>
<p>There are corresponding <code>AUTOSUB</code> and <code>AUTOSUBDEF</code> 
    hooks. And <code>AUTOVAR</code> and <code>AUTOVARDEF</code> hooks. These 
    all pretty much make <code>AUTOLOAD</code> obsolete. But <code>AUTOLOAD</code> 
    is still there for old times's sake.</p>














<p><em>Editor's Note: this Apocalypse is out of date and remains here for historic reasons.  See <a href="http://dev.perl.org/perl6/doc/design/syn/S12.html">Synopsis 12</a> for the latest information.</em></p>

<h3><a name="other_nonoo_decisions">Other Non-OO Decisions</a></h3>
<p>A lot of time went by while I was in the hospital last year, so we ended 
    up polishing up the design of Perl 6 in a number of areas not directly 
    related to OO. Since I've already got your attention (and we're already 
    90% of the way through this Apocalypse), I might as well list these 
    decisions here.</p>
<h4><a name="exportation">Exportation</a></h4>
<p>The trait we'll use for exportation (typically from modules but also 
    from classes pretending to be modules) is <code>export</code>:</p>
<pre><code>
                                               # Tagset...
    sub foo is export(:DEFAULT)         {...}  #  :DEFAULT, :ALL
    sub bar is export(:DEFAULT :others) {...}  #  :DEFAULT, :ALL, :others
    sub baz is export(:MANDATORY)       {...}  #  (always exported)
    sub bop is export                   {...}  #  :ALL
    sub qux is export(:others)          {...}  #  :ALL, :others</code></pre>
<p>Compared to Perl 5, we've basically made it easier to mark something 
    as exportable, but more difficult to export something by default. You 
    no longer have to declare your tagsets separately, since <code>:foo</code> 
    parameters are self-declaring, and the module will automatically build 
    the tagsets for you from the export trait arguments.</p>
<h4><a name="the_gather/take_construct">The Gather/Take Construct</a></h4>
<p>We used one example of the conjectural gather/take construct. A gather 
    executes a closure, returning a list of all the values returned by <code>take</code> 
    within its lexical scope. In a lazy context it might run as a coroutine. 
    There probably ought to be a dynamically scoped variant. Unless it should 
    be dynamic by default, in which case there probably ought to be a lexically 
    scoped variant...</p>
<h4><a name=":foo()_adverbs">:foo() Adverbs</a></h4>
<p>There's a new pair syntax that is more conducive to use as option arguments. 
    This syntax is reminiscent of both the Unix command line syntax and 
    the I/O layers syntax of Perl 5. But unlike Unix command-line options, 
    we use colon to introduce the option rather than the overly negative 
    minus sign. And unlike Perl 5's layers options, you can use these outside 
    of a string.</p>
<p>We haven't discarded the old pair syntax. It's still more readable for 
    certain uses, and it allows the key to be a non-identifier. Plus we 
    can define the new syntax in terms of it:</p>
<pre><code>
    Old                         New
    ---                         ---
    foo =&gt; $bar                 :foo($bar)
    foo =&gt; [1,2,3,@many]        :foo[1,2,3,@many]
    foo =&gt; &laquo;alice bob charles&raquo;  :foo&laquo;alice bob charles&raquo;
    foo =&gt; 'alice'              :foo&laquo;alice&raquo;
    foo =&gt; { a =&gt; 1, b =&gt; 2 }   :foo{ a =&gt; 1, b =&gt; 2 }
    foo =&gt; { dostuff() }        :foo{ dostuff() }
    foo =&gt; 0                    :foo(0)
    foo =&gt; 1                    :foo</code></pre>
<p>It's that last one that's the real winner for passing boolean options. 
    One other nice thing is that if you have several options in a row you 
    don't have to put commas between:</p>
<pre><code>
    $handle = open $file, :chomp :encoding&laquo;guess&raquo; :ungzip or die &quot;Oops&quot;;</code></pre>
<p>It might be argued that this conflicts the :foo notation for private 
    methods. I don't think it's a problem because method names never occur 
    in isolation.</p>
<p>Oh, one other feature of option pairs is that certain operations can 
    use them as adverbs. For instance, you often want to tell the range 
    operator how much to skip on each iteration. That looks like this:</p>
<pre><code>
    1..100 :by(3)</code></pre>
<p>Note that this only works where an operator is expected rather than a 
    term. So there's no confusion between:</p>
<pre><code>
    randomlistop 1..100 :by(3)</code></pre>
<p>and</p>
<pre><code>
    randomlistop 1..100, :by(3)</code></pre>
<p>In the latter case, the option is being passed to <code>randomlistop()</code> 
    rather than the <code>infix:..</code> operator.</p>
<h4><a name="special_quoting_of_identifiers_inside_curlies_going_away!">Special 
    Quoting of Identifiers Inside Curlies Going Away!</a></h4>
<p>Novice Perl 5 programmers are continually getting trapped by subscripts 
    that autoquote unexpectedly. So in Perl 6, we'll remove that special 
    case. %hash{shift} now always calls the shift function, because the 
    inside of curlies is always an expression. Instead, if you want to subscript 
    a hash with a constant string, or a slice of constant strings, use the 
    new French qw//-ish brackets like this:</p>
<pre><code>
    %hash&laquo;alice&raquo;                # same as %hash{'alice'}
    %hash&laquo;alice bob charlie&raquo;    # same as %hash{'alice','bob','charlie'}</code></pre>
<p>Note in particular that, since slices in Perl 6 are determined by the 
    subscript only, not the sigil, this:</p>
<pre><code>
    %hash&laquo;alice&raquo; = @x;</code></pre>
<p>evaluates the right side in scalar context, while</p>
<pre><code>
    %hash&laquo;alice bob charlie&raquo; = @x;</code></pre>
<p>evaluates the right side in list context. As with all other uses of the 
    French quotes in Perl 6, you can always use:</p>
<pre><code>
    %hash&lt;&lt;alice&gt;&gt; = @x;</code></pre>
<p>if you can't figure out how to type <code>^K&lt;&lt; or ^K&gt;&gt;</code> 
    in vim.</p>
<p>On the other hand, if you've got a fully Unicode aware editor, you could 
    probably write some macros to use the big double angles from Asian languages:</p>
<pre><code>
    %hash&#x300a;alice&#x300b; = @x;</code></pre>
<p>But by default we only provide the Latin-1 compatible versions. It would 
    be easy to overuse Unicode in Perl 6, so we're trying to underuse Unicode 
    for small values of 6. (Not to be confused with &#x2076;, or &#x2175;.)</p>
<h4><a name="vector_operators_renamed_back_to_hyper_operators">Vector Operators 
    Renamed Back to "hyper" Operators</a></h4>
<p>The mathematicians got confused when we started talking about "vector" 
    operators, so these dimensionally dwimming versions of scalar operators 
    are now called hyper operators (again). Some folks see operations like</p>
<pre><code>
    @a &raquo;*&laquo; @b</code></pre>
<p>as totally useless, and maybe they are--to a mathematician. But to someone 
    simply trying to calculate a bunch of things in parallel (think cellular 
    automata, or aerodynamic simulations, for instance), they make a lot 
    of sense. And don't restrict your thinking to math operators. How about 
    appending a newline to every string before printing it out:</p>
<pre><code>
    print @strings &raquo;~&laquo; &quot;\n&quot;;</code></pre>
<p>Of course,</p>
<pre><code>
    for @strings {say}</code></pre>
<p>is a shorter way to do the same thing. ("<code>say</code>" is just Perl 
    6's version of a printline function.)</p>
<h4><a name="unary_hyper_operators_now_use_one_quote_rather_than_two">Unary 
    Hyper Operators Now Use One Quote Rather Than Two</a></h4>
<p>Unary operators read better if they only "hyper" on the side where there's 
    an actual argument:</p>
<pre><code>
    @neg = -&laquo; @pos;
    @indexes = @x &raquo;++;</code></pre>
<p>And in particular, I consider a method spec like <code>.bletch(1,2,3)</code> 
    to be a unary postfix operator, and it would be really ugly to say:</p>
<pre><code>
    @objects&raquo;.bletch(1,2,3)&laquo;</code></pre>
<p>So that's just:</p>
<pre><code>
    @objects&raquo;.bletch(1,2,3)</code></pre>
<p>In general, binary operators still take "hypers" on both sides, indicating 
    that both sides participate in the dwimmery.</p>
<pre><code>
    @a &raquo;+&laquo; @a</code></pre>
<p>To indicate that one side or the other should be evaluated as a scalar 
    before participating in the hyperoperator, you can always put in a context 
    specifier:</p>
<pre><code>
    @a &raquo;+&laquo; +@a</code></pre>
<h4><a name="$thumb.twiddle_no_longer_requires_parens_when_interpolated"><code>$thumb.twiddle</code> 
    No Longer Requires Parens When Interpolated</a></h4>
<p>In Apocalypse 2 we said that any method interpolated into a double-quoted 
    string has to have parentheses. We're throwing out that special rule 
    in the interests of consistency. Now if you want to interpolate a variable 
    followed by an "accidental" dot, use one of these:</p>
<pre><code>
    $($var).twiddle
    $var\.twiddle</code></pre>
<p>Yes, that will make it a little harder to translate Perl 5 to Perl 6.</p>
<p>(Parentheses are still required if there are any arguments, however.)</p>
<h4><a name="the_=:=_identity_operator">The =:= Identity Operator</a></h4>
<p>There is a new <code>=:=</code> identity operator, which tests to see 
    if two objects are the same object. The association with the <code>:=</code> 
    binding operator should be obvious. (Some classes such as integers may 
    consider all objects of the same value to be a single object, in a Platonic 
    sense.)</p>
<p>Hmm? No, there is no associated assignment operator. And if there were, 
    I wouldn't tell you about it. Sheesh, some people...</p>
<p>But there is, of course, a hyper version:</p>
<pre><code>
    @a &raquo;=:=&laquo; @b</code></pre>
<h4><a name="new_grammatical_categories">New Grammatical Categories</a></h4>
<p>The current set of grammatical categories for operator names is:</p>
<pre><code>
    Category                            Example of use
    --------                            --------------
    coerce:as                           123 as BigInt, BigInt(123)
    self:sort                           @array.=sort
    term:...                            $x = {...}
    prefix:+                            +$x
    infix:+                             $x + $y
    postfix:++                          $x++
    circumfix:[]                        [ @x ]
    postcircumfix:[]                    $x[$y] or $x .[$y]
    rule_modifier:p5                    m:p5//
    trait_verb:handles                  has $.tail handles &laquo;wag&raquo;
    trait_auxiliary:shall               my $x shall conform&laquo;TR123&raquo;
    scope_declarator:has                has $.x;
    statement_control:if                if $condition {...} else {...}
    infix_postfix_meta_operator:=       $x += 2;
    postfix_prefix_meta_operator:&raquo;      @array &raquo;++
    prefix_postfix_meta_operator:&laquo;      -&laquo; @magnitudes
    infix_circumfix_meta_operator:&raquo;&laquo;    @a &raquo;+&laquo; @b</code></pre>
<p>Now, you may be thinking that some of these have long, unwieldy names. 
    You'd be right. The longer the name, the longer you should think before 
    adding a new operator of that category. (And the length of time you 
    should think probably scales exponentially with the length of the name.)</p>











	

<p><em>Editor's Note: this Apocalypse is out of date and remains here for historic reasons.  See <a href="http://dev.perl.org/perl6/doc/design/syn/S12.html">Synopsis 12</a> for the latest information.</em></p>
	
<h4><a name="assignment_to_state_variable_declaration_now_does_first_semantics.">Assignment 
    to <code>state</code> Variable Declaration Now Does "First" Semantics</a></h4>
<p>As we talked about earlier, assignment to a "<code>has</code>" variable 
    is really pseudo-assignment representing a call to the "<code>build</code>" 
    trait. In the same way, assignment to <code>state</code> variables (Perl's 
    version of lexically scoped "static" variables), is taken as pseudo-assignment 
    representing a call to the "<code>first</code>" trait. The first time 
    through a piece of code is when state variables typically like to be 
    initialized. So saying:</p>
<pre><code>
    state $pc = $startpc;</code></pre>
<p>is equivalent to</p>
<pre><code>
    state $pc is first( $startpc );</code></pre>
<p>which means that it will pay attention to the <code>$startpc</code> variable 
    only the first time this block is ever executed. Note that any side 
    effects within the expression will only happen the first time through. 
    If you say</p>
<pre><code>
    state $x = $y++;</code></pre>
<p>then that statement will only ever increment <code>$y</code> once. If 
    that's not what you want, then use a real assignment as a separate statement:</p>
<pre><code>
    state $x;
    $x = $y++;</code></pre>
<p>The <code>:=</code> and <code>.=</code> operators also attempt to do 
    what you mean, which in the case of:</p>
<pre><code>
    state $x := $y++;</code></pre>
<p>still probably doesn't do what you want. <code>:-)</code></p>
<p>In general, any "preset" trait is smart about when to apply its value 
    to the container it's being applied to, such that the value is set statically 
    if that's possible, and if that's not possible, it is set dynamically 
    at the "correct" moment.</p>
<p>For ordinary assignment to a "<code>my</code>" variable, that correct 
    moment just happens to be every time it is executed, so <code>=</code> 
    represents ordinary assignment. If you want to force an initial value 
    at execution time that was calculated earlier, however, then just use 
    ordinary assignment to assign the results of a precalculated block:</p>
<pre><code>
    my @canines = INIT { split slurp &quot;%ENV&laquo;HOME&raquo;/.canines&quot; };</code></pre>
<p>It's only the <code>has</code> and <code>state</code> declarators that 
    redefine assignment to set defaults with traits. (For <code>has</code>, 
    that's because the actual attribute variable won't exist until the object 
    is created. For <code>state</code>, that's because we want the default 
    to be "first time through".) But you can use any of the traits on any 
    variable for which it makes sense. For instance, just because we invented 
    the "<code>first</code>" initializer for state variables:</p>
<pre><code>
    state $lexstate is first(0);</code></pre>
<p>doesn't mean you can't use it to initialize any variable only the first 
    time through a block of code:</p>
<pre><code>
    my $foo is first(0);</code></pre>
<p>However, it probably doesn't make a lot of sense on a "<code>my</code>" 
    variable, unless you really want it to be undefined the second time 
    through. It does make a little more sense on an "<code>our</code>" variable 
    that will hang onto its value like a state variable:</p>
<pre><code>
    our $counter is first(0);</code></pre>
<p>An assignment would often be wrong in this case. But generally, the naive 
    user can simply use assignment, and it will usually do what they want 
    (if occasionally more often than they want). But it does exactly what 
    they want on <code>has</code> and <code>state</code> variables--presuming 
    they are savvy enough to want what it actually does... <code>:-)</code></p>
<p>So as with <code>has</code> variables, <code>state</code> variables can 
    be initialized with precomputed values:</p>
<pre><code>
    state $x = BEGIN { calc() }
    state $x = CHECK { calc() }
    state $x = INIT  { calc() }
    state $x = FIRST { calc() }
    state $x = ENTER { calc() }</code></pre>
<p>which mean something like:</p>
<pre><code>
    state $x is first( BEGIN { calc() } )
    state $x is first( CHECK { calc() } )
    state $x is first( INIT  { calc() } )
    state $x is first( FIRST { calc() } )
    state $x is first( ENTER { calc() } )</code></pre>
<p>Note, however, that the last one doesn't in fact make much sense, since 
    <code>ENTER</code> happens more frequently than <code>FIRST</code>. 
    Come to think of it, doing <code>FIRST</code> inside a <code>first</code> 
    doesn't buy you much either...</p>
<h4><a name="the_length()_function_is_gone">The <code>length()</code> Function 
    Is Gone</a></h4>
<p>In Perl 6 you're not going to see</p>
<pre><code>
    my $sizeofstring = length($string);</code></pre>
<p>That's because "length" has been deemed to be an insufficiently specified 
    concept, because it doesn't specify the units. Instead, if you want 
    the length of something in characters you use</p>
<pre><code>
    my $sizeinchars = chars($string);</code></pre>
<p>and if you want the size in elements, you use</p>
<pre><code>
    my $sizeinelems = elems(@array);</code></pre>
<p>This is more orthogonal in some ways, insofar as you can now ask for 
    the size in chars of an array, and it will add up all the lengths of 
    the strings in it for you:</p>
<pre><code>
    my $sizeinchars = chars(@array);</code></pre>
<p>And if you ask for the number of elems of a scalar, it knows to dereference 
    it:</p>
<pre><code>
    my $ref = [1,2,3];
    my $sizeinelems = elems($ref);</code></pre>
<p>These are, in fact, just generic object methods:</p>
<pre><code>
    @array.elems
    $string.chars
    @array.chars
    $ref.elems</code></pre>
<p>And the functional forms are just multimethod calls. (Unless they're 
    indirect object calls...who knows?)</p>
<p>You can also use <code>%hash.elems</code>, which returns the number of 
    pairs in the hash. I don't think <code>%hash.chars</code> is terribly 
    useful, but it will tell you how many characters total there are in 
    the values. (The key lengths are ignored, just like the integer "keys" 
    of an ordinary array.)</p>
<p>Actually, the meaning of <code>.chars</code> varies depending on your 
    current level of Unicode support. To be more specific, there's also:</p>
<pre><code>
    $string.bytes
    $string.codepoints
    $string.graphemes
    $string.letters</code></pre>
<p>...none of which should be confused with:</p>
<pre><code>
    $string.columns</code></pre>
<p>or its evil twin:</p>
<pre><code>
    $string.pixels</code></pre>
<p>Those last two require knowledge of the current font and rendering engine, 
    in fact. Though <code>.columns</code> is likely to be pretty much the 
    same for most Unicode fonts that restrict themselves to single and double-wide 
    characters.</p>
<h4><a name="string_positions">String Positions</a></h4>
<p>A corollary to the preceding is that string positions are not numbers. 
    If you say either</p>
<pre><code>
    $pos = index($string, &quot;foo&quot;);</code></pre>
<p>or</p>
<pre><code>
    $string ~~ /foo/; $pos = $string.pos;</code></pre>
<p>then <code>$pos</code> points to that location in that string. If you 
    ask for the numeric value of <code>$pos</code>, you'll get a number, 
    but which number you get can vary depending on whether you're currently 
    treating characters as bytes, codepoints, graphemes, or letters. When 
    you pass a <code>$pos</code> to <code>substr($string, $pos, 3)</code>, 
    you'll get back "<code>foo</code>", but not because it counted over 
    some number of characters. If you use <code>$pos</code> on some other 
    string, then it has to interpret the value numerically in the current 
    view of what "character" means. In a boolean context, a position is 
    true if the position is defined, even if that position would evaluate 
    to 0 numerically. (<code>index</code> and <code>rindex</code> return 
    undef when they "run out".)</p>
<p>And, in fact, when you say <code>$len = .chars</code>, you're really 
    getting back the position of the end of the string, which just happens 
    to numerify to the number of characters in the string in the current 
    view. A consequence of the preceding rules is that <code>&quot;&quot;.chars</code> 
    is true, but <code>+&quot;&quot;.chars</code> is false. So Perl 5 code 
    that says <code>length($string)</code> needs to be translated to <code>+chars($string)</code> 
    if used in a boolean context.</p>
<p>Routines like <code>substr</code> and <code>index</code> take either 
    positions or integers for arguments. Integers will automatically be 
    turned into positions in the current view. This may involve traversing 
    the string for variable-width representations, especially when working 
    with combining characters as parts of graphemes. Once you're working 
    with abstract positions, however, they are efficient. So</p>
<pre><code>
    while $pos = index($string, &quot;fido&quot;, $pos + 1) {...}</code></pre>
<p>never has to rescan the string.</p>
<p>The other point of all this is that you can pass <code>$pos</code> or 
    <code>$len</code> to another module, and <em>it doesn't matter</em> 
    if you're doing offsets in graphemes and they are doing offsets in codepoints. 
    They get the correct position by their lights, even though the number 
    of characters looks different. The main constraint on this is that if 
    you pass a position from a lower Unicode support level to a higher Unicode 
    support level, you can end up with a position that is inside what you 
    think of as a unitary character, whether that's a byte within a codepoint, 
    or a codepoint within a grapheme or letter. If you deref such a position, 
    an exception is thrown. But generally high-level routines call into 
    low-level routines, so the issue shouldn't arise all that often in practice. 
    However, low-level routines that want to be called from high-level routines 
    should strive not to return positions inside high-level characters--the 
    fly in the ointment being that the low-level routine doesn't necessarily 
    know the Unicode level expected by the calling routine. But we have 
    a solution for that...</p>
<p>High-level routines that suspect they may have a "partial position" can 
    call <code>$pos.snap</code> (or <code>$pos.=snap</code>) to round up 
    to the next integral position in the current view, or (much less commonly) 
    <code>$pos.snapback</code> (or <code>$pos.=snapback</code>) to round 
    down to the next integral position in the current view. This only biases 
    the position rightward or leftward. It doesn't actually do any repositioning 
    unless we're about to throw an exception. So this allows the low-level 
    routine to return <code>$pos.snap</code> without knowing at the time 
    how far forward to snap. The actual snapping is done later when the 
    high-level routine tries to use the position, and at that point we know 
    which semantics to snap forward under.</p>
<p>By the way, if you bind to a position rather than assign, it tracks the 
    string in question:</p>
<pre><code>
    my $string = &quot;xyz&quot;;
    my $endpos := $string.chars;        # $endpos == 3
    substr($string,0,0,&quot;abc&quot;);          # $endpos == 6, $string = &quot;abcxyz&quot;</code></pre>
<p>Deletions of string around a position cause the position to be reduced 
    to the beginning of the deletion. Insertions at a position are assumed 
    to be after that position. That is, the position stays pointing to the 
    beginning of the newly inserted string, like this:</p>
<pre><code>
    my $string = &quot;xyz&quot;;
    my $endpos := $string.chars;        # $endpos == 3
    substr($string,2,1,&quot;abc&quot;);          # $endpos == 2, $string = &quot;xyabc&quot;</code></pre>
<p>Hence concatenation never updates any positions. Which means that sometimes 
    you just have to call <code>.chars</code> again... (Perhaps we'll provide 
    a way to optionally insert before any matching position.)</p>
<p>Note that positions try very hard not to get demoted to integers. In 
    particular, position objects overload addition and substraction such 
    that</p>
<pre><code>
    $string.chars - 1
    index($string, &quot;foo&quot;) + 2</code></pre>
<p>are still position objects with an implicit reference into the string. 
    (Subtracting one position object from another results in an integer, 
    however.)</p>
<h4><a name="the_new_&_separator_in_regexen">The New "&amp;" Separator in 
    Regexen</a></h4>
<p>Analogous to the disjunctional <code>|</code> separator, we're also putting 
    in a conjunctional <code>&amp;</code> separator into our regex syntax:</p>
<pre><code>
    &quot;DOG&quot; ~~ /D [ &lt;vowel&gt;+ &amp; &lt;upper&gt;+ ] G/</code></pre>
<p>The semantics of it are pretty straightforward, as long as you realize 
    that all of the AND'ed assertions have to match <em>with the same length</em>. 
    More precisely, they have to start and stop matching at the same location. 
    So the following is always going to be false:</p>
<pre><code>
    / . &amp; .. /</code></pre>
<p>It would be possible to have the other semantics where, as long as the 
    trailing assertion matches either way, it doesn't have to match the 
    trailing assertion the <em>same</em> way. But then tell me whether <code>$1</code> 
    should return "<code>O</code>" or "<code>G</code>" after this:</p>
<pre><code>
    &quot;DOG&quot; ~~ /^[. &amp; ..] (.)/</code></pre>
<p>Besides, it's easy enough to get the other semantics with lookahead assertions. 
    Autoanchoring all the legs of a conjunction to the same spot adds much 
    more value to it by differentiating it from lookahead. You have to work 
    pretty hard to make separate lookaheads match the same length. Plus 
    doing that turns what should be a symmetric operator into a non-symmetrical 
    one, where the final lookahead can't be a lookahead because someone 
    has to "eat" the characters that all the assertions have agreed on are 
    the right number to eat. So for all these reasons it's better to have 
    a conjunction operator with complicated enough start/stop semantics 
    to be useful.</p>
<p>Actually, this operator was originally suggested to me by a biologist. 
    Which leads us to our...</p>

<h3><a name="optional_mandatory_crossdisciplinary_joke_for_people_tired_of_dogs">Optional 
    Mandatory Cross-Disciplinary Joke for People Tired of Dogs</a></h3>
<pre><code>
    Biologist: What's worse than being chased by a Velociraptor?
    Physicist: Obviously, being chased by an Acceloraptor.</code></pre>

<h3><a name="future_directions">Future Directions</a></h3>
<p>Away from Acceloraptors, obviously. </p>

<h3><a name="references...er,_reference...">References...er, Reference...</a></h3><pre><code> 
Nathanael Sch&auml;rli, St&eacute;phane Ducasse, Oscar Nierstrasz and Andrew Black. 
    Traits: Composable Units of Behavior. European Conference on Object-Oriented 
    Programming (ECOOP), July 2003. Springer LNCS 2743, Ed. Luca Cardelli. </code></pre>

        </div>



    </div>
    <div class="asset-footer"></div>
</div>


                            
                            <div id="entry-908" class="entry-asset asset hentry">
    <div class="asset-header">
        <h2 class="asset-name entry-title"><a href="/pub/2004/04/08/bloom_filters.html" rel="bookmark">Using Bloom Filters</a></h2>
        <div class="asset-meta">
            <span class="byline">
    
                By <span class="vcard author">Maciej Ceglowski</span> on <abbr class="published" title="2004-04-08T00:00:00-08:00">April  8, 2004 12:00 AM</abbr>
    
            </span>

            
            

        </div>
    </div>
    <div class="asset-content entry-content">

        <div class="asset-body">
            
<!-- sidebar begins -->
<!-- don't move sidebars -->
<!-- sidebar ends -->


<p>Anyone who has used Perl for any length of time is familiar with the lookup
hash, a handy idiom for doing existence tests:</p>

<pre><code>foreach my $e ( @things ) { $lookup{$e}++ }

sub check {
	my ( $key ) = @_;
	print &quot;Found $key!&quot; if exists( $lookup{ $key } );
}</code></pre>

<p> As useful as the lookup hash is, it can become unwieldy for very large
lists or in cases where the keys themselves are large.  When a lookup hash
grows too big, the usual recourse is to move it to a database or flat file,
perhaps keeping a local cache of the most frequently used keys to improve
performance.  </p>

<p> Many people don't realize that there is an elegant alternative to the lookup
hash, in the form of a venerable algorithm called a <em>Bloom filter</em>.
Bloom filters allow you to perform membership tests in just a fraction of the
memory you'd need to store a full list of keys, so you can avoid the
performance hit of having to use a disk or database to do your lookups.  As you
might suspect, the savings in space comes at a price: you run an adjustable
risk of false positives, and you can't remove a key from a filter once you've
added it in.  But in the many cases where those constraints are acceptable, a
Bloom filter can make a useful tool.  </p>

<p>For example, imagine you run a high-traffic online music store along the
lines of iTunes, and you want to minimize the stress on your database by only
fetching song information when you know the song exists in your collection. You
can build a Bloom filter at startup, and then use it as a quick existence check
before trying to perform an expensive fetching operation:</p>

<pre><code>use Bloom::Filter;

my $filter = Bloom::Filter-&gt;new( error_rate =&gt; 0.01, capacity =&gt; $SONG_COUNT );
open my $fh, "enormous_list_of_titles.txt" or die "Failed to open: $!";

while (&lt;$fh&gt;) {
	chomp;
	$filter-&gt;add( $_ );
}

sub lookup_song {
	my ( $title ) = @_;
	return unless $filter-&gt;check( $title );
	return expensive_db_query( $title ) or undef;
}</code></pre>

<p>In this example, there's a 1% chance that the test will give a false
positive, which means the program will perform the expensive fetch operation
and eventually return a null result. Still, you've managed to avoid the
expensive query 99% of the time, using only a fraction of the memory you would
have needed for a lookup hash. As we'll see further on, a filter with a 1%
error rate requires just under 2 bytes of storage per key.  That's far less
memory than you would need for a lookup hash.</p>

<csperl file="grab" domain="on" record="b/515" template="b/article_sidebar.view">

<p>Bloom filters are named after Burton Bloom, who first described them in a
1970 paper entitled <a href="http://portal.acm.org/citation.cfm?id=362692&dl=ACM&coll=portal">Space/time trade-offs in hash coding with allowable errors</a>. In those days of limited
memory, Bloom filters were prized primarily for their compactness; in fact, one
of their earliest applications was in spell checkers. However, there are less
obvious features of the algorithm that make it especially well-suited to
applications in social software.</p>

<p>Because Bloom filters use one-way hashing to store their data, it is
impossible to reconstruct the list of keys in a filter without doing an
exhaustive search of the keyspace. Even that is unlikely to be of much help,
since the false positives from an exhaustive search will swamp the list of real
keys. Bloom filters therefore make it possible to share information about what
you have without broadcasting a complete list of it to the world.  For that
reason, they may be especially valuable in peer-to-peer applications, where
both size and privacy are important constraints.</p>

<h3><a name="how_bloom_filters_work" id="how_bloom_filters_work">How Bloom Filters Work</a></h3>

<p>A Bloom filter consists of two components: a set of <code>k</code> hash
functions and a bit vector of a given length.  We choose the length of the bit
vector and the number of hash functions depending on how many keys we want
to add to the set and how high an error rate we are willing to put up with -- more on that a little bit further on.</p>

<p>All of the hash functions in a Bloom filter are configured so that their
range matches the length of the bit vector. For example, if a vector is 200
bits long, the hash functions return a value between 1 and 200.  It's important
to use high-quality hash functions in the filter to guarantee that output is
equally distributed over all possible values -- "hot spots" in a hash
function would increase our false-positive rate.</p>

<p>To enter a key into a Bloom filter, we run it through each one of the
<code>k</code> hash functions and treat the result as an offset into the bit
vector, turning on whatever bit we find at that position. If the bit is already
set, we leave it on. There's no mechanism for turning bits off in a Bloom
filter.</p>

<p>As an example, let's take a look at a Bloom filter with three hash functions
and a bit vector of length 14. We'll use spaces and asterisks to represent the
bit vector, to make it easier to follow along. As you might expect, an empty
Bloom filter starts out with all the bits turned off, as seen in Figure 1.</p>

<p class="secondary"><img src="/pub/2004/04/08/graphics/bloom_1.gif" width="284" height="24" alt="an empty Bloom filter" /><br /> 
<em>Figure 1. An empty Bloom filter.</em></p>

<p>Let's now add the string <code>apples</code> into our filter. To do so, we
hash <code>apples</code> through each of our three hash functions and collect
the output:</p>

<pre><code>hash1("apples") = 3
hash2("apples") = 12
hash3("apples") = 11</code></pre>

<p>Then we turn on the bits at the corresponding positions in the vector -- in this case bits 3, 11, and 12, as shown in Figure 2.</p>

<p class="secondary"><img src="/pub/2004/04/08/graphics/bloom_2.gif" width="284" height="24" alt="a Bloom filter with three bits enabled" /><br />
<em>Figure 2. A Bloom filter with three bits enabled.</em></p>

<p>To add another key, such as <code>plums</code>, we repeat the hashing
procedure:</p>

<pre><code>hash1("plums") = 11
hash2("plums") = 1
hash3("plums") = 8</code></pre>

<p>And again turn on the appropriate bits in the vector, as shown with
highlights in Figure 3.  </p>

<p class="secondary"><img src="/pub/2004/04/08/graphics/bloom_3.gif" width="284" height="24" alt="the Bloom filter after adding a second key"/><br />
<em>Figure 3. The Bloom filter after adding a second key.</em></p>

<p>Notice that the bit at position 11 was already turned on -- we had set
it when we added <code>apples</code> in the previous step. Bit 11 now does
double duty, storing information for both <code>apples</code> and
<code>plums</code>. As we add more keys, it may store information for some of
them as well. This overlap is what makes Bloom filters so compact -- any
one bit may be encoding multiple keys simultaneously.  This overlap also means
that you can never take a key out of a filter, because you have no guarantee
that the bits you turn off don't carry information for other keys. If we tried
to remove <code>apples</code> from the filter by reversing the procedure we
used to add it in, we would inadvertently turn off one of the bits that encodes
<code>plums</code>.  The only way to strip a key out of a Bloom filter is to
rebuild the filter from scratch, leaving out the offending key.</p>

<p>Checking to see whether a key already exists in a filter is exactly
analogous to adding a new key. We run the key through our set of hash
functions, and then check to see whether the bits at those offsets are all
turned on. If any of the bits is off, we know for certain the key is not in the
filter. If all of the bits are on, we know the key is probably there.</p>

<p>I say "probably" because there's a certain chance our key might be a false
positive. For example, let's see what happens when we test our filter for the
string <code>mango</code>. We run <code>mango</code> through the set of hash
functions:</p>

<pre><code>hash1("mango") = 8
hash2("mango") = 3
hash3("mango") = 12</code></pre>

<p>And then examine the bits at those offsets, as shown in Figure 4.</p>

<p class="secondary"><img src="/pub/2004/04/08/graphics/bloom_4.gif" width="284" height="24" alt="a false positive in the Bloom filter" /><br />
<em>Figure 4. A false positive in the Bloom filter.</em></p>

<p>All of the bits at positions 3, 8, and 12 are on, so our filter will report
that <code>mango</code> is a valid key.</p>

<p>Of course, <code>mango</code> is <strong>not</strong> a valid key -- the filter we built contains only <code>apples</code> and <code>plums</code>.
The fact that the offsets for <code>mango</code> point to enabled bits is just
coincidence. We have found a false positive -- a key that seems to be in
the filter, but isn't really there.</p>

<p>As you might expect, the false-positive rate depends on the bit vector
length and the number of keys stored in the filter. The roomier the bit vector,
the smaller the probability that all <code>k</code> bits we check will be on, unless the key actually exists in the filter. The relationship between the
number of hash functions and the false-positive rate is more subtle.  If you
use too few hash functions, there won't be enough discrimination between keys;
but if you use too many, the filter will be very dense, increasing the
probability of collisions. You can calculate the false-positive rate for any
filter using the formula:</p>

<pre>c = ( 1 - e(-kn/m) )k</pre>

<p>Where <code>c</code> is the false positive rate, <code>k</code> is the
number of hash functions, <code>n</code> is the number of keys in the filter,
and <code>m</code> is the length of the filter in bits.</p>

<p>When using Bloom filters, we very frequently have a desired false-positive rate in mind and we are also likely to have a rough idea of how many keys we
want to add to the filter. We need some way of finding out how large a bit
vector is to make sure the false-positive rate never exceeds our limit. The
following equation will give us vector length from the error rate and number of
keys:</p>

<pre><code>m = -kn / ( ln( 1 - c ^ 1/k ) )</code></pre>

<p>You'll notice another free variable here: <code>k</code>, the number of hash
functions. It's possible to use calculus to find a minimum for <code>k</code>, but
there's a lazier way to do it:</p>

<pre><code>sub calculate_shortest_filter_length {
	my ( $num_keys, $error_rate ) = @_;
	my $lowest_m;
	my $best_k = 1;

	foreach my $k ( 1..100 ) {
		my $m = (-1 * $k * $num_keys) / 
			( log( 1 - ($error_rate ** (1/$k))));

		if ( !defined $lowest_m or ($m &lt; $lowest_m) ) {
			$lowest_m = $m;
			$best_k   = $k;
		}
	}
	return ( $lowest_m, $best_k );
}</code></pre>

<p>To give you a sense of how error rate and number of keys affect the storage
size of Bloom filters, Table 1 lists some sample vector sizes for a variety of
capacity/error rate combinations.</p>

<table border="1" cellpadding="3">

<tr><th>Error Rate</th><th>Keys</th><th>Required
Size</th><th>Bytes/Key</th></tr>

<tr><td>1%</td><td>1K</td><td>1.87 K</td><td>1.9</td></tr>
<tr><td>0.1%</td><td>1K</td><td>2.80 K</td><td>2.9</td></tr>
<tr><td>0.01%</td><td>1K</td><td>3.74 K</td><td>3.7</td></tr>
<tr><td>0.01%</td><td>10K</td><td>37.4 K</td><td>3.7</td></tr>
<tr><td>0.01%</td><td>100K</td><td>374 K</td><td>3.7</td></tr>
<tr><td>0.01%</td><td>1M</td><td>3.74 M</td><td>3.7</td></tr>
<tr><td>0.001%</td><td>1M</td><td>4.68 M</td><td>4.7</td></tr>
<tr><td>0.0001%</td><td>1M</td><td>5.61 M</td><td>5.7</td></tr>
</table>

<p>You can find further lookup tables for various combinations of error rate,
filter size, and number of hash functions at <a href="http://www.cs.wisc.edu/~cao/papers/summary-cache/node8.html#tab:bf-config-1">Bloom
Filters -- the math</a>.</p>













<h2><a name="building_a_bloom_filter_in_perl" id="building_a_bloom_filter_in_perl">Building a Bloom Filter in Perl</a></h2>

<p>To make a working Bloom filter, we need a good set of hash functions These
are easy to come by -- there are several excellent hashing algorithms
available on CPAN. For our purposes, a good choice is
<code>Digest::SHA1</code>, a cryptographically strong hash with a fast C
implementation. We can use the module to create as many hash functions as we
like by salting the input with a list of distinct values. Here's a subroutine
that builds a list of unique hash functions:</p>

<pre><code>use Digest::SHA1 qw/sha1/;

sub make_hashing_functions {
	my ( $count ) = @_;
	my @functions;

	for my $salt (1..$count ) {
		push @functions, sub { sha1( $salt, $_[0] ) };
	}

	return @functions;
}</code></pre>

<p>To be able to use these hash functions, we have to find a way to control their
range. <code>Digest::SHA1</code> returns an embarrassingly lavish 160 bits of
hashed output, useful only in the unlikely case that our vector is
2<sup>160</sup> bits long. We'll use a combination of bit chopping and division
to scale the output down to a more usable size.</p>

<p>Here's a subroutine that takes a key, runs it through a list of hash
functions, and returns a bitmask of length <code>$FILTER_LENGTH</code>:</p>

<pre><code>sub make_bitmask {
	my ( $key ) = @_;
	my $mask    = pack( "b*", '0' x $FILTER_LENGTH);

	foreach my $hash_function ( @functions ){ 

		my $hash       = $hash_function-&gt;($key);
		my $chopped    = unpack("N", $hash );
		my $bit_offset = $result % $FILTER_LENGTH;

		vec( $mask, $bit_offset, 1 ) = 1;       
	}
	return $mask;
}</code></pre>

<p>That's a dense stretch of code, so let's look at it line by line:</p>

<pre><code>my $mask = pack( "b*", '0' x $FILTER_LENGTH);</code></pre>

<p>We start by using Perl's <code>pack</code> operator to create a zeroed bit
vector that is <code>$FILTER_LENGTH</code> bits long.  <code>pack</code> takes two
arguments, a template and a value. The <code>b</code> in our template tells
<code>pack</code> that we want it to interpret the value as bits, and the
<code>*</code> indicates "repeat as often as necessary," just like in a regular
expression. Perl will actually pad our bit vector to make its length a multiple
of eight, but we'll ignore those superfluous bits.</p>

<p>With a blank bit vector in hand, we're ready to start running our key
through the hash functions.</p>

<pre><code>my $hash = $hash_function-&gt;($key);
my $chopped = unpack("N", $hash );</code></pre>

<p>We're keeping the first 32 bits of the output and discarding the rest. This
prevents us from having to require <code>BigInt</code> support further along. The second line does the actual bit chopping. The <code>N</code> in the
template tells <code>unpack</code> to extract a 32-bit integer in network byte
order. Because we don't provide any quantifier in the template,
<code>unpack</code> will extract just one integer and then stop.</p>

<p>If you are extra, super paranoid about bit chopping, you could split the hash
into five 32-bit pieces and XOR them together, preserving all the information
in the original hash:</p>

<pre><code>my $chopped = pack( "N", 0 );
my @pieces  =  map { pack( "N", $_ ) } unpack("N*", $hash );
$chopped    = $_ ^ $chopped foreach @pieces;</code></pre>

<p>But this is probably overkill.</p>

<p>Now that we have a list of 32-bit integer outputs from our hash functions,
all we have to do is scale them down with the modulo operator so they fall in
the range (1..<code>$FILTER_LENGTH</code>).</p>

<pre><code>my $bit_offset = $chopped % $FILTER_LENGTH;</code></pre>

<p>Now we've turned our key into a list of bit offsets, which is exactly what
we were after.</p>

<p>The only thing left to do is to set the bits using <code>vec</code>, which
takes three arguments: the vector itself, a starting position, and the number
of bits to set. We can assign a value to <code>vec</code> like we would to a
variable:</p>

<pre><code>vec( $mask, $bit_offset, 1 ) = 1;</code></pre>

<p>After we've set all the bits, we wind up with a bitmask that is the same
length as our Bloom filter. We can use this mask to add the key into the
filter:</p>

<pre><code>sub add {
	my ( $key, $filter ) = @_;

	my $mask = make_bitmask( $key );
	$filter  = $filter | $mask;
}</code></pre>

<p>Or we can use it to check whether the key is already present:</p>

<pre><code>sub check {
	my ( $key, $filter ) = @_;
	my $mask  = make_bitmask( $key );
	my $found = ( ( $filter &amp; $mask ) eq $mask );
	return $found;
}</code></pre>

<p>Note that those are the bitwise OR (<code>|</code>) and AND
(<code>&amp;</code>) operators, not the more commonly used logical OR
(<code>||</code>) and AND ( <code>&amp;&amp;</code> ) operators.  Getting the
two mixed up can lead to hours of interesting debugging. The first example ORs
the mask against the bit vector, turning on any bits that aren't already set.
The second example compares the mask to the corresponding positions in the
filter -- if all of the on bits in the mask are also on in the filter, we
know we've found a match.</p>

<p>Once you get over the intimidation factor of using <code>vec</code>,
<code>pack</code>, and the bitwise operators, Bloom filters are actually quite
straightforward. <a href="/2004/04/08/examples/Filter.pm">Listing 1</a> shows a complete
object-oriented implementation called <code>Bloom::Filter</code>.</p>

<h3><a name="bloom_filters_in_distributed_social_networks"
id="bloom_filters_in_distributed_social_networks">Bloom Filters in Distributed
Social Networks</a></h3>

<p>One drawback of existing social network schemes is that they require
participants to either divulge their list of contacts to a central server
(Orkut, Friendster) or publish it to the public Internet (FOAF), in both cases
sacrificing a great deal of privacy.  By exchanging Bloom filters instead of
explicit lists of contacts, users can participate in social networking
experiments without having to admit to the world who their friends are. A Bloom
filter encoding someone's contact information can be checked to see whether it
contains a given name or email address, but it can't be coerced into revealing
the full list of keys that were used to build it. It's even possible to turn
the false-positive rate, which may not sound like a feature, into a powerful
tool.</p>

<p>Suppose that I am very concerned about people trying to reverse-engineer my
social network by running a dictionary attack against my Bloom filter. I can
build my filter with a prohibitively high false-positive rate (50%, for
example) and then arrange to send multiple copies of my Bloom filter to
friends, varying the hash functions I use to build each filter. The more
filters my friends collect, the lower the false-positive rate they will see.
For example, with five filters the false-positive rate will be
(0.5)<sup>5</sup>, or 3% -- and I can reduce the rate further by sending
out more filters.</p>

<p>If any one of the filters is intercepted, it will register the full 50%
false-positive rate. So I am able to hedge my privacy risk across several
interactions, and have some control over how accurately other people can see my
network. My friends can be sure with a high degree of certainty whether someone is on my contact list, but someone who manages to snag just one or two
of my filters will learn almost nothing about me.</p>

<p>Here's a Perl function that checks a key against a set of noisy filters:</p>

<pre><code>use Bloom::Filter;
        
sub check_noisy_filters {
	my ( $key, @filters ) = @_;
	foreach my $filter ( @filters ) {
		return 0 unless $filter-&gt;check( $key );
	}
	return 1;
}</code></pre>

<p>If you and your friends agree to use the same filter length and set of hash
functions, you can also use bitwise comparisons to estimate the degree of
overlap between your social networks. The number of shared on bits in two Bloom filters will give a usable measure of the distance between them.</p>

<pre><code>sub shared_on_bits {
	my ( $filter_1, $filter_2 ) = @_;
	return unpack( "%32b*",  $filter_1 &amp; $filter_2 )
}</code></pre>

<p>Additionally, you can combine two Bloom filters that have the same length
and hash functions with the bitwise OR operator to create a composite filter.
For example, if you participate in a small mailing list and want to create a whitelist from the address books of everyone in the group, you can have each
participant create a Bloom filter individually and then OR the filters together
into a Voltron-like master list. None of the members of the group will know who
the other members' contacts are, and yet the filter will exhibit the correct
behavior.</p>

<p>There are sure to be other neat Bloom filter tricks with potential
applications to social networking and distributed applications. The references
below list a few good places to start mining.</p>

<h3><a name="references" id="references">References</a></h3>

<ul>

<li><strong><a name="item_http_3a_2f_2fwww_2ecs_2ewisc_2eedu_2f_7ecao_2fpape"
id="item_http_3a_2f_2fwww_2ecs_2ewisc_2eedu_2f_7ecao_2fpape"></a><a href="http://www.cs.wisc.edu/~cao/papers/summary-cache/node8.html"> Bloom
Filters -- the math</a></strong>.  A good place to start for an overview
of the math behind Bloom filters.</li>

<li><strong><a name="item_http_3a_2f_2fwww_2ecap_2dlore_2ecom_2fcode_2fbloom"
id="item_http_3a_2f_2fwww_2ecap_2dlore_2ecom_2fcode_2fbloom"></a><a href="http://www.cap-lore.com/code/BloomTheory.html"> Some Motley Bloom Tricks</a></strong>.  Handy filter tricks and theory page.</li>

<li><strong><a name="item_http_3a_2f_2fwww_2eeecs_2eharvard_2eedu_2f_7emicha"
id="item_http_3a_2f_2fwww_2eeecs_2eharvard_2eedu_2f_7emicha"></a><a href="http://www.eecs.harvard.edu/~michaelm/NEWWORK/postscripts/BloomFilterSurvey.pdf">Bloom
Filter Survey</a></strong>.  A handy survey article on Bloom filter network
applications.</li>

<li><strong><a name="item_loaf" id="item_loaf" /><a href="http://loaf.cantbedone.org">LOAF</a></strong>.  Our own system for
incorporating social networks onto email using Bloom filters.</li>

<li><strong><a href="http://www.eecs.harvard.edu/~michaelm/NEWWORK/postscripts/cbf2.pdf">
Compressed Bloom Filters</a></strong>.  If you are passing filters around a
network, you will want to optimize them for minimum size; this paper gives a
good overview of compressed Bloom filters.</li>

<li><strong><a name="item_bloom16" id="item_bloom16" /><a href="http://search.cpan.org/~iwoodhead/Bloom16-0.01/Bloom16.pm"><code>Bloom16</code></a>.</strong>
A CPAN module implementing a counting Bloom filter.</li>

<li><strong><a name="item_bloom" id="item_bloom" /><a href="http://search.cpan.org/~aspinelli/Text-Document-1.07/Bloom.pod"><code>Text::Bloom</code></a></strong>.
CPAN module for using Bloom filters with text collections.</li>

<li><strong><a name="item_http_3a_2f_2fwww_2eresearch_2eatt_2ecom_2f_7esmb_2"
id="item_http_3a_2f_2fwww_2eresearch_2eatt_2ecom_2f_7esmb_2" /><a href="http://www.research.att.com/~smb/papers/bloom-encrypt.pdf">
Privacy-Enhanced Searches Using Encryted Bloom Filters</a></strong>.  This
paper discusses how to use encryption and Bloom filters to set up a query
system that prevents the search engine from knowing the query you are
running.</li>

<li><strong><a href="http://www.cs.wisc.edu/~cao/papers/summary-cache/node9.html">Bloom
Filters as Summaries</a></strong>.  Some performance data on actually using
Bloom filters as cache summaries.</li>

<li><strong><a href="http://www.research.att.com/~smb/papers/draft-bellovin-dnsext-bloomfilt-00.txt">
Using Bloom Filters for Authenticated Yes/No Answers in the DNS</a></strong>.
Internet draft for using Bloom filters to implement Secure DNS</li>

</ul>



        </div>



    </div>
    <div class="asset-footer"></div>
</div>


                            
                            <div id="entry-918" class="entry-asset asset hentry">
    <div class="asset-header">
        <h2 class="asset-name entry-title"><a href="/pub/2004/04/p6pdigest/20040404.html" rel="bookmark">This week on Perl 6, week ending 2004-04-04</a></h2>
        <div class="asset-meta">
            <span class="byline">
    
                By <span class="vcard author">Piers Cawley</span> on <abbr class="published" title="2004-04-04T00:00:00-08:00">April  4, 2004 12:00 AM</abbr>
    
            </span>

            
            

        </div>
    </div>
    <div class="asset-content entry-content">

        <div class="asset-body">
            <p>Wednesday?
Why did I leave it 'til Wednesday to write the summary?
I must have <i>some</i> reason.
Or maybe not.
I'll give fair warning that I won't be doing a summary for next week though,
what with Easter and everything,
but you'll get a fortnight's summary the week after,
because I'm good to you like that.</p>

<p>We'll start this week's summary with perl6&#45;internals.</p>

<h4><a name="MMD_vtable_functions_in_bytecode">MMD vtable functions in bytecode</a></h4>

<p>Dan had announced that he was working on adding parrot bytecode support for multimethod dispatch,
and outlined how they'd be used and got semi&#45;Warnocked.</p>

<p>The discussion got going this week,
Leo T&#246;tsch was unsure about some of Dan's implementation choices.
In particular,
he wondered if MMD subs should use PMCs rather than the simple function pointer that Dan had used.
Dan thought not.</p>
<csperl file="grab" domain="on" record="b/940" template="b/article_sidebar.view">
<p><a href='http://groups.google.com/groups?selm=a06010203bc88de42bcc6@[172.24.18.98]'>http://groups.google.com/</a></p>

<h4><a name="Behaviour_of_PMCs_on_assignment">Behaviour of PMCs on assignment</a></h4>

<p>The discussion of what to do when assigning to PMCs continued.
The issue is complicated because we are trying to be friendly to multiple languages (though,
as far as I can tell,
the really problematic issue is Perl Scalars; most of the other languages that spring to mind have variables that are 'simple' pointers to objects; Perl Scalars can hold (seemingly) a million and one different things,
potentially all at once).
TOGoS argued that,
as things stand there's a disjunction between the way (say) integer registers work and the way PMC registers work.
With Integer registers,
if you do</p>

<pre><code>    $I1 = $I2 + $I3</code></pre>

<p>then <code lang='und' xml:lang='und'>$I1</code> gets a 'new' integer; there doesn't need to be a preexisting integer. However, if you were to do:</p>

<pre><code>    $P1 = $P2 + $P3</code></pre>

<p>what actually happens (assuming we're using straightforward PMCs here...) is more like:</p>

<pre><code>    $P1.value = $P2 + $P3</code></pre>

<p>In other words, you need a preexisting <code lang='und' xml:lang='und'>$P1</code>. Leo agreed with TOGoS's argument, but worried that implementing it would blow core size up to an insane value. Dan didn't agree with TOGoS though, but I'm afraid I didn't quite follow his reasoning (probably because I'm being dumb this morning).</p>

<p><a href='http://groups.google.com/groups?selm=a06010205bc8de88d9b5e@[10.0.1.2]'>http://groups.google.com/</a></p>

<h4><a name="In_which_your_Summarizer_asks_dumb_questions">In which your Summarizer asks dumb questions</a></h4>

<p>In an extended moment of stupidity, Piers Cawley asked why we had distinct register and user stacks. Leo explained it to him, very politely I thought.</p>

<p><a href='http://groups.google.com/groups?selm=m2isgnzxtc.fsf@obelisk.bofh.org.uk'>http://groups.google.com/</a></p>

<h4><a name="Stalking_the_wily_Garbage_Collector_bug">Stalking the wily Garbage Collector bug</a></h4>

<p>Jens Rieks's <i>projet du jour</i> &#45;&#45; an EBNF parser in Parrot &#45;&#45; tweaked a garbage collection bug so he posted appropriate debug traces and Leo set to work on it. He didn't get it working fully, but it takes longer to crash now (but it crashes in the same bit of C code). Jens thinks it's a problem with Parrot's handling of strings.</p>

<p><a href='http://groups.google.com/groups?selm=200403291218.47861.parrot@jensbeimsurfen.de'>http://groups.google.com/</a></p>

<h4><a name="New_SDL_Parrot_bindings_underway">New SDL Parrot bindings underway</a></h4>

<p>That stalwart of Portland.pm, chromatic, announced that he's in the process of porting the existing SDL Parrot bindings to use our shiny new Object system. Jens Rieks wondered why he was prefixing his method names with underscores (you only need underscores for globally visible functions, methods can have straightforward names). Tim Bunce wondered why chromatic wasn't using nested namespaces. Leo pointed out that nested namespaces haven't been implemented just yet.</p>

<p><a href='http://groups.google.com/groups?selm=1080632006.13206.69.camel@localhost'>http://groups.google.com/</a></p>

<h4><a name="Some_new_classes">Some new classes</a></h4>

<p>Dan checked in some stub code for PMCArray and StringArray. Eventually they'll be auto&#45;resizable, PMC or String only arrays, but right now they're simple wrappers for PerlArray. He suggested that rewriting them so they were real, efficient arrays would be a Good Thing (and, I suggest, a relatively gentle introduction to Parrot hacking if anyone reading this is interested.)</p>

<p>Jens Rieks offered up a patch for his data dumper so it could take them into account, which Dan applied.</p>

<p><a href='http://groups.google.com/groups?selm=a06010216bc8f56b09896@[10.0.1.2]'>http://groups.google.com/</a></p>

<h4><a name="Points_of_focus">Points of focus</a></h4>

<p>Dan went all Managerial on our collective donkey and posted a nice bulletted list of things that need sorting out for a 0.1.1 release. The general thrust of the message is bug fixing and documenting, which is good.</p>

<p><a href='http://groups.google.com/groups?selm=a06010228bc90bf17fd33@[10.0.1.2]'>http://groups.google.com/</a></p>

<h4><a name="Fun_with_non_deterministic_searches">Fun with non deterministic searches</a></h4>

<p>One of the canonical illustrations of things to do with continuations is non deterministic searches. Imagine that you could write</p>

<pre><code>    $x = choose(1,3,5,9)
    $y = choose(1,5,9,13)

    assert $x * $y == 15
    
    print &#34;$x * $y == &#34;, $x * $y, &#34;\n&#34;</code></pre>

<p>and have &#34;3 * 5 == 15&#34; printed out. (Okay, so in Perl 6 you're going to be able to do that with junctions, but this is about an underlying implementation). Piers Cawley translated a simple non deterministic search algorithm from scheme to Parrot and posted the (initially failing) code to the list and pointed out that, even if he tweaked IMCC to generate full continuations instead of RetContinuations and turned of garbage collection, Parrot fell over with a bus error.</p>

<p>Once he'd explained how it worked (in a post made on April Fools' Day no less) and Leo had wrapped his head round it, the work went on to make it work. It turns out that Parrot had a few too many assumptions about how call stacks would work (starting with the assumption that you could simply reused a stack frame once you'd returned through it; in the presence of a full continuation you have to let stack frames be garbage collected). Leo fixed things so that you can now make a 'full' continuation simply by cloning the current continuation in P1 and there should only be a performance hit for the call chain that leads to the continuation (and that hit should be a one time cost you pay when cloning the continuation). Way to go Leo.</p>

<p>Oh yes, and <code lang='und' xml:lang='und'>$P0(...)</code> doesn't throw a syntax error in IMCC any more.</p>

<p><a href='http://groups.google.com/groups?selm=m265ckdfme.fsf@obelisk.bofh.org.uk'>http://groups.google.com/</a></p>

<p><a href='http://groups.google.com/groups?selm=m23c7nvjuk.fsf@obelisk.bofh.org.uk'>http://groups.google.com/</a> 
    &#45;&#45; Continuations made simple</p>

<h4><a name="Collision_of_running_jokes">Collision of running jokes</a></h4>

<p>Once upon a time, I endeavoured always to mention Leon Brocard in these summaries, which got increasingly difficult (not to mention tortured) as his posts to the mailing lists became more and more infrequent. However, on the first of April (aka the oldest running joke in Christendom) he posted a couple of patches. Sadly, we didn't manage to get a triple running joke collision, for it was Leo T&#246;tsch and not chromatic who applied the patches.</p>

<p><a href='http://groups.google.com/groups?selm=20040401114111.GA8636@kanga.astray.com'>http://groups.google.com/</a></p>

<h4><a name="Stream_library">Stream library</a></h4>

<p>Okay, if Leo T&#246;tsch is the Patchmonster, then Jens Rieks shows every indication of becoming the Libmonster. Not content with implementing Data::Dumper in pure Parrot, he's working on an EBNF Parser and, on Friday he released his first working development version of a Stream library which wraps all sorts of sources of strings behind a simple interface (suitable for parsers, for instance). Leo had a few issues with some of the implementation choices that potentially make it a little tricky to subclass streams (and then the week ended, but a little bird tells me that Jens took these comments on board and redid the library).</p>

<p><a href='http://groups.google.com/groups?selm=200404021013.48782.parrot@jensbeimsurfen.de'>http://groups.google.com/</a></p>

<h4><a name="Subroutine_calls">Subroutine calls</a></h4>

<p>Leo announced that he's added a <code lang='und' xml:lang='und'>pmc_const</code> opcode to parrot. The idea being that, in general subroutines don't vary that much so instead of having to call <code lang='und' xml:lang='und'>newsub</code> every time you make a function call (IMCC usually does this), you would instead fetch a preexisting Subroutine PMC from the PMC constant pool.</p>

<p><a href='http://groups.google.com/groups?selm=406D85DA.6090003@toetsch.at'>http://groups.google.com/groups?selm=406D85DA.6090003@toetsch.at</a></p>

<h4><a name="Named_attribute_access">Named attribute access</a></h4>

<p>In a very short (but useful) post, Leo announced that you could now do</p>

<pre><code>    getattribute $P0, anObject, &#34;attribute&#34;
    setattribute anObject, &#34;attribute&#34;, $P0</code></pre>

<p>For which I personally thank him profusely.</p>

<p><a href='http://groups.google.com/groups?selm=406EDF7F.5060107@toetsch.at'>http://groups.google.com/</a></p>

<h3><a name="Meanwhile,_over_in_perl6&#45;language">Meanwhile, over in perl6&#45;language</a></h3>

<p>Things were pretty quiet. But not utterly quiet</p>

<h4><a name="Default_Program">Default Program</a></h4>

<p>Extrapolating from the general Perl principle that, in the absence of any indication otherwise, Perl should use a sensible default, Brent Royal&#45;Gordon proposed that Perl 6 should extend this principle to entire programs. He proposed that, when the whole program was an empty string, Perl 6 should substitute a sensible default program. Based on extensive research on the Internet and printed Perl documentation, he proposed that the default program should be:</p>

<pre><code>    print &#34;Hello world!\n&#34;</code></pre>

<p>Apart from those who quibbled with his punctuation, the general response was positive. However, always one to take a good idea that one step further, Austin Hastings suggested that a more sensible default would be to have a naked invocation of perl launch an editor (or other script development environment). He proposed that, to this end, the Parrot team should be focusing on implementing elisp in Parrot rather than worrying about winning the Piethon.</p>

<p>Richard Nuttall thought that Austin hadn't gone far enough, he proposed that Perl 6 should load the DWIM::AI module and provide as output the script you were intending to write.</p>

<p>A quick glance at the calendar was in order at about this time.</p>

<p><a href='http://groups.google.com/groups?selm=406BCD38.3080108@brentdax.com'>http://groups.google.com/</a></p>

<h4><a name="Can_colons_control_backtracking_in_logical_expressions?">Can colons control backtracking in logical expressions?</a></h4>

<p>Gleefully ignoring Larry's stricture that &#34;I [Larry] get the colon.&#34;, Austin Hastings wondered about using <code lang='und' xml:lang='und'>::</code> to mean something special in conditional statements. Quite what his proposal offered over and above</p>

<pre><code>    if specific_condition() ?? detail() :: general_condition()
      { ... }</code></pre>

<p>perplexed Damian somewhat (though he did forget that <code lang='und' xml:lang='und'>... ? ... : ...</code> has become <code lang='und' xml:lang='und'>... ?? ... :: ...</code> in Perl 6. Elsewhere in the thread, Larry reminded everyone that Perl 6 will not be confusing statements and expressions.</p>

<p><a href='http://groups.google.com/groups?selm=ICELKKFHGNOHCNCCCBKFKEDNCLAA.Austin_Hastings@Yahoo.com'>http://groups.google.com/</a></p>

<h3><a name="Announcements,_Acknowledgements,_Apologies">Announcements, Acknowledgements, Apologies</a></h3>

<p>No announcements this week, apart from the one earlier about the next summary being due in two weeks because of Easter.</p>

<p>If you find these summaries useful or enjoyable, please consider contributing to the Perl Foundation to help support the development of Perl. You might also like to send me feedback at <a href='mailto:pdcawley@bofh.org.uk'>mailto:pdcawley@bofh.org.uk</a> or, if you find yourself at Miskin Folk Festival this Easter weekend, you could always buy me a drink.</p>

<p><a href='http://donate.perl&#45;foundation.org/'>http://donate.perl&#45;foundation.org/</a> &#45;&#45; The Perl Foundation</p>

<p><a href='http://dev.perl.org/perl6/'>http://dev.perl.org/perl6/</a> &#45;&#45; Perl 6 Development site</p>

<p><a href='http://www.miskinfolk.cjb.net/'>http://www.miskinfolk.cjb.net/</a> &#45;&#45; Miskin folk festival</p>

        </div>



    </div>
    <div class="asset-footer"></div>
</div>


                            
                            <div id="entry-906" class="entry-asset asset hentry">
    <div class="asset-header">
        <h2 class="asset-name entry-title"><a href="/pub/2004/04/01/masongal.html" rel="bookmark">Photo Galleries with Mason and Imager</a></h2>
        <div class="asset-meta">
            <span class="byline">
    
                By <span class="vcard author">Casey West</span> on <abbr class="published" title="2004-04-01T00:00:00-08:00">April  1, 2004 12:00 AM</abbr>
    
            </span>

            
            

        </div>
    </div>
    <div class="asset-content entry-content">

        <div class="asset-body">
            
<!-- sidebar begins -->
<!-- don't move sidebars -->
<!-- sidebar ends -->

<p>Creating a photo gallery is usually considered a daunting task.
Lots of people have tried it,
not many have succeeded.
One of the reasons for so many similar projects is that they don&#39;t often integrate well into an existing web site.
In this article we&#39;re going to build a photo gallery using two important components,
Mason and Imager.
Writing our gallery in Mason will make it much easier to integrate into an existing web site.</p>

<p>Mason,
also known as <a href="http://search.cpan.org/perldoc?HTML::Mason"><code>HTML::Mason</code></a>,
is a web application framework written in Perl.
Mason can run in any environment,
but is tuned to work best with mod_perl.
We will be using a number of Mason features in this article.
If you&#39;re not familiar with Mason I suggest you 
<a href='http://www.oreilly.com/catalog/perlhtmlmason/'>
get the book</a>
or 
<a href='http://masonbook.com'>
browse</a>
before you buy.
This article is not meant to be an introduction to Mason,
so some experience will definitely help when reading this.
Mason idioms will be briefly reviewed when they come up.</p>

<csperl file="grab" domain="on" record="b/795" template="b/article_sidebar.view">

<p><a href="http://search.cpan.org/perldoc?Imager"><code>Imager</code></a> is a Perl module for dealing with images.
It has mechanisms to manipulate an image,
and read and write various formats.
It&#39;s rather lightweight and has a clean interface in comparison to the alternative,
<a href="http://search.cpan.org/perldoc?Image::Magick"><code>Image::Magick</code></a>.</p>

<p>Combining these two Perl modules,
and adding a few others,
allows us to write a feature&#45;full photo gallery in just 200 lines.
Let's get started.</p>

<h3><a name="Apache_Configuration">Apache Configuration</a></h3>

<p>We&#39;re going to use Mason from mod_perl for our gallery.
This requires an Apache built with mod_perl,
and bit of web server configuration.</p>

<p>First,
Mason&#39;s Apache handler must be pre&#45;loaded.</p>

<pre><code>  PerlModule HTML::Mason::ApacheHandler</code></pre>

<p>Next, we need to tell Apache to let Mason handle any requests that it gets for resources within our gallery.</p>

<pre><code>  &#60;Location /gallery&#62;
    SetHandler perl&#45;script
    PerlHandler HTML::Mason::ApacheHandler
  &#60;/Location&#62;</code></pre>

<p>We want to keep special Mason files secret from the general public. If they&#39;re requested, Apache should always return a <code>404</code> HTTP status code, for <i>Not Found</i>.</p>

<pre><code>  &#60;LocationMatch &#34;(dhandler|autohandler)$&quot;&gt;
    SetHandler perl&#45;script
    PerlInitHandler Apache::Constants::NOT_FOUND
  &#60;/LocationMatch&#62;</code></pre>

<p>At this point, every file inside the gallery will be considered a Mason component. If you enjoy paying for lots of bandwidth and you want the full&#45;size images to be viewable by the public, one last configuration step must occur. The raw images are not Mason components so Apache should handle those in the default way.</p>

<pre><code>  &#60;Location /gallery/images&#62;
    SetHandler default
  &#60;/Location&#62;</code></pre>

<h3><a name="Directory_Structure">Directory Structure</a></h3>

<p>For this article we&#39;ll use the following directory structure, in a directory called <em>gallery</em>, inside our site <code>DocumentRoot</code>.</p>

<pre><code>  .
  |&#45;&#45; autohandler
  |&#45;&#45; dhandler
  |&#45;&#45; images
  |   `&#45;&#45; dhandler
  |&#45;&#45; index.html
  `&#45;&#45; pictures
      `&#45;&#45; [lots of images and sub-directories]</code></pre>

<p>As you can see, all the actual photos will be uploaded to the <em>gallery/pictures</em> directory. Our code will recognize sub-galleries and allow for infinite nesting. We can keep our photos very neatly organized this way.</p>

<p>As for the rest, it&#39;s all code. <em>autohandler</em> and <em>dhandler</em> are special Mason files, and <em>index.html</em> is just a wrapper around the top level <em>dhandler</em>.</p>

<h3><a name="The_autohandler">The <em>autohandler</em></a></h3>

<p>For this example, our <em>autohandler</em> is extremely simple. I&#39;m going to assume that you already have a Mason site running with your own <em>autohandler</em> wrappers in place. If you don&#39;t, you can use this one.</p>

<pre><code>  &#60;%method .title&#62;My Website&#60;/%method&#62;

  &#60;html&#62;
    &#60;head&#62;
      &#60;title&#62;&#60;&#38; SELF:.title &#38;&#62;&#60;/title&#62;
    &#60;/head&#62;
    &#60;body&#62;
      &#60;% $m&#45;&#62;call_next %&#62;
    &#60;/body&#62;
  &#60;/html&#62;</code></pre>

<p>The first thing our <em>autohandler</em> does is define a subcomponent called <code>.title</code>. Mason subcomponents are wrapped in <code>&#60;%method&#62;</code> blocks. They are templates just like files; the only difference is they live inside the files. This is analogous to Perl files and subroutines.</p>

<p>Next we define the skeleton of the web page. The <code>&#60;title&#62;</code> tag&#39;s content is dynamically generated by the output of the <code>SELF:.title</code> subcomponent. Any time you want to call a subcomponent, the call is wrapped in <code>&#60;&#38; &#38;&#62;</code> delimiters.</p>

<p>The body, or content, of our web page will be provided by whatever component is next in the call stack. Using the global variable to access Mason object, <code>$m</code>, the <code>call_next()</code> method is executed to do just that.</p>

<p>In our gallery the next component in the call stack will be one of two files. If we&#39;re at the topmost level, <code>http://example.com/gallery/</code>, for example, <em>index.html</em> will be called. Everywhere else <em>dhandler</em> will be called. This is because no files exist for Mason to map to, and when that happens, Mason looks for a <em>dhandler</em> to execute.</p>

<h3><a name="The_Invisible_Index">The Invisible Index</a></h3>

<p><code>dhandlers</code> are default handlers for files inside a directory, and not that directory itself. Because of this we are required to provide an <em>index.html</em> file or Apache will attempt to display a directory listing, or possibly return a <i>forbidden</i> status code, if directory listings are not allowed. In reality, our <em>index.html</em> doesn&#39;t do anything at all.</p>

<p>In its entirety, <em>index.html</em> simply states that it inherits from <em>dhandler</em>. Now <em>dhandler</em> will be executed for all non&#45;image access to our photo gallery.</p>

<pre><code>  &#60;%flags&#62;
    inherit =&#62; &#39;dhandler&#39;
  &#60;/%flags&#62;</code></pre>

<p>This uncovers a portion of Mason&#39;s object&#45;like component inheritance. By default, all components inherit from <em>autohandler</em>. For <em>index.html</em> we&#39;ve changed that. <em>dhandler</em> still inherits from <em>autohandler</em>, so anytime a request is sent to <em>index.html</em>, <em>dhandler</em> is first called, which calls <em>autohandler</em> first. Then <em>autohandler</em> does its thing and moves down the call stack to <em>dhandler</em>. <em>dhandler</em>, as we&#39;ll see, is not configured to call down the stack to <em>index.html</em>, because it doesn&#39;t need to. Thus ends the very high&#45;level overview of Mason inheritance.</p>













<h3><a name="Displaying_Gallery_Pages">Displaying Gallery Pages</a></h3>

<p>Moving on to the meat of our application, the top&#45;level <em>dhandler</em>. This file has the bulk of our code, roughly 150 lines. The code is neatly organized into subcomponents, so we&#39;ll start by discussing the high&#45;level code. And from that we&#39;ll work in order of execution.</p>

<p>Each page in our photo gallery has just one optional argument, a page number. By default we always start on page one (<code>1</code>).</p>

<pre><code>  &#60;%args&#62;
    $page =&#62; 1
  &#60;/%args&#62;</code></pre>

<p>Next, the <code>&#60;%shared&#62;</code> block is executed. It does a lot, so we&#39;ll look at it in great detail. We&#39;re using a <code>&#60;%shared&#62;</code> block instead of an <code>&#60;%init&#62;</code> block because some of the variables defined here need to be used within multiple subcomponents. As the name suggests, <code>&#60;%shared&#62;</code> blocks allow just that.</p>

<pre><code>  &#60;%shared&#62;
    use List::Group qw[group];
    use HTML::Table;
    use File::Spec::Functions qw[:ALL];</code></pre>

<p>The first step is to load the Perl modules this component will be using. <a href="http://search.cpan.org/perldoc?List::Group"><code>List::Group</code></a> turns a flat list into a List&#45;of&#45;Lists (LoL) based on specific grouping options, <a href="http://search.cpan.org/perldoc?HTML::Table"><code>HTML::Table</code></a> turns such an LoL into an HTML table structure, and <a href="http://search.cpan.org/perldoc?File::Spec::Functions"><code>File::Spec::Functions</code></a> provides a number of portable file and directory operations.</p>

<pre><code>    my $GALLERY_ROOT = $r&#45;&#62;document_root . &#34;/gallery/pictures&#34;;</code></pre>

<p>Next, we define the first shared variable. <code>$GALLERY_ROOT</code> is the absolute path to the location of the gallery pictures on the file system.</p>

<pre><code>    (my $path_from_uri = $m&#45;&#62;dhandler_arg) =~ s!(?:(?:/index)?\.html|/)$!!;</code></pre>

<p>It&#39;s time to determine the relative path to the resource being requested. Because we&#39;re inside a <em>dhandler</em>, Mason provides the <code>dhandler_arg()</code> method, which is similar in purpose to Apache&#39;s <code>uri()</code> method. It returns the portion of a URI that is relative to the directory containing the <em>dhandler</em>. If we request <code>/gallery/Family/IMG_0001.JPG.html</code>, <code>$m&#45;&#62;dhandler_arg()</code> will return <code>/Family/IMG_0001.JPG.html</code>.</p>

<p>Because we&#39;re looking for the path to an actual photo or gallery directory, there is some information to be removed from the end of our relative path. So our regex removes useless information such as index files, HTML extensions, and extra backslashes.</p>

<pre><code>    my $file = catdir $GALLERY_ROOT, $path_from_uri;
    $m&#45;&#62;clear_buffer and $m&#45;&#62;abort(404) unless &#45;e $file;</code></pre>

<p>From these two variables we can construct the absolute path to the file we&#39;re interested in using <code>catdir()</code>, from <code>File::Spec::Functions</code>. If this file doesn&#39;t exist, we don&#39;t want to go any further, so Mason&#39;s output buffer is cleared and the request is aborted immediately with a <code>404</code> HTTP status code, meaning <i>Not Found</i>.</p>

<p>If a gallery is being requested, not a specific photo, we must get the contents of that gallery. If a photo is being requested, we must get the contents of the gallery that photo belongs to.</p>

<pre><code>    my $dir = &#45;d $file ? $file : (splitpath $file)[1];
    opendir DIR, $dir or die $!;
    my $dir_list = [ map &#34;$dir/$_&#34;, grep { ! /^\./ } readdir DIR ];
    closedir DIR;</code></pre>

<p>Using a file test operator, we can determine if the current request is for a file or a directory. If a directory we simply assign <code>$file</code> to <code>$dir</code>. If a file, we use <code>splitpath()</code> from <code>File::Spec::Functions</code>. <code>splitpath()</code> returns three elements, the volume, directory tree, and filename. We&#39;re after the directory tree, or second element.</p>

<p>The <code>$dir_list</code> array reference is populated with a list of absolute paths to each file in <code>$dir</code>, excluding files that begin with a dot (<code>.</code>).</p>

<p>Now it&#39;s time to move on to building the breadcrumbs for navigation. This method of navigating &#34;up&#34; the photo gallery is important because we can have infinite levels of sub-galleries.</p>

<pre><code>    my @bread_crumb = (&#39;Gallery&#39;, splitdir $path_from_uri);</code></pre>

<p>First we define our plain&#45;text list of crumbs in <code>@bread_crumb</code>. The first element is the name of our photo gallery, which I imaginatively named <i>Gallery</i>. The rest of our breadcrumbs come from <code>$path_from_uri</code> by calling <code>splitpath()</code> to get the list of elements.</p>

<p>Our <code>@bread_crumb</code> list is great for the title of the page, but it doesn&#39;t contain any links for use inside the page for navigation. A new list of breadcrumbs will be created with correct linking.</p>

<pre><code>    my @bread_crumb_href;
    push @bread_crumb_href, sprintf &#39;&#60;a href=&#34;/gallery/%s&quot;&gt;%s&#60;/a&#62;&#39;,
      join(&#39;/&#39;,@bread_crumb[1..$_]), $bread_crumb[$_]
        for 0 .. $#bread_crumb &#45; 1;
    push @bread_crumb_href, $bread_crumb[&#45;1];</code></pre>

<p>For each breadcrumb except the very last, we create an HTML link. The reference location for each link, from left to right, needs to cumulatively add directories from the links before it. That&#39;s what <code>join(&#39;/&#39;,@bread_crumb[1..$_])</code> does. Finally we tack on the last element of the breadcrumb, unlinked, because it is the currently requested resource.</p>

<p>To illustrate, if a request is made to <code>/gallery/Backgrounds/Nature%20Backgrounds/ICmiddleFalls1280x1024.jpg.html</code>, the following list is in <code>@bread_crumb_href</code>.</p>

<pre><code>  (
   &#39;&#60;a href=&#34;/gallery/&quot;&gt;Gallery&#60;/a&#62;&#39;,
   &#39;&#60;a href=&#34;/gallery/Backgrounds&quot;&gt;Backgrounds&#60;/a&#62;&#39;,
   &#39;&#60;a href=&#34;/gallery/Backgrounds/Nature Backgrounds&quot;&gt;Nature Backgrounds&#60;/a&#62;&#39;,
   &#39;ICmiddleFalls1280x1024.jpg&#39;
  )</code></pre>

<p>Finally, we construct two scalars to hold the contents of our breadcrumbs.</p>

<pre><code>    my $bread_crumb      = join &#39; &#38;middot; &#39;, @bread_crumb;
    my $bread_crumb_href = join &#39; &#38;middot; &#39;, @bread_crumb_href;
  &#60;/%shared&#62;</code></pre>

<p>At this point we can define the <code>.title</code> subcomponent, using the <code>$bread_crumb</code> shared variable.</p>

<pre><code>  &#60;%method .title&#62;&#60;&#38; PARENT:.title &#38;&#62; &#38;middot; &#60;% $bread_crumb %&#62;&#60;/%method&#62;</code></pre>

<p>Notice that there is a subcomponent call to <code>PARENT:.title</code>. This is another illustration of Mason&#39;s inheritance model. Because <em>dhandler</em> <b>inherits</b> from <em>autohandler</em>, the <code>.title</code> subcomponent in <em>dhandler</em> is overriding the <code>.title</code> method in <em>autohandler</em>. That is to say, <em>dhandler</em> is <b>subclassing</b> <em>autohandler</em>. For this reason, if we don&#39;t want to clobber the <code>.title</code> subcomponent declared in <em>autohandler</em> we must be sure to call our parent. This is very similar to invoking a <code>SUPER::</code> method in Perl.</p>

<p>Now we can move on to the actual gallery display.</p>

<pre><code>  &#60;h1&#62;Photo Gallery&#60;/h1&#62;
  &#60;h2&#62;&#60;% $bread_crumb_href %&#62;&#60;/h2&#62;</code></pre>

<p>Using another shared variable, <code>$bread_crumb_href</code>, we construct our backward navigation.</p>

<pre><code>  &#60;table&#62;
    &#60;tr&#62;
      &#60;td valign=&#34;top&#34; width=&#34;15%&quot;&gt;
        &#60;&#38; SELF:.sub_gal_list, dir_list =&#62; $dir_list &#38;&#62;
      &#60;/td&#62;
      &#60;td valign=&#34;top&#34; width=&#34;35%&quot;&gt;
        &#60;&#38; SELF:.photo_list, dir_list =&#62; $dir_list, page =&#62; $page &#38;&#62;
      &#60;/td&#62;
      &#60;td valign=&#34;top&#34; width=&#34;50%&quot;&gt;
  % if ( &#45;f $file ) {
        &#60;&#38; SELF:.photo_view, file =&#62; $file &#38;&#62;
  % }
      &#60;/td&#62;
    &#60;/tr&#62;
  &#60;/table&#62;</code></pre>

<p>We have three columns of information to display at any one time -- an HTML table is a good way to do that. (Some standards purists and XHTML masochists will disagree with me on this point. I&#39;m interested in keeping the examples simple, not pure.) Each of the table cells calls a subcomponent with the appropriate arguments. Those subcomponents are discussed in detail later in this article. Notice that before we call <code>SELF:.photo_view</code> we check to see if the request is currently for a file. This can save us from calling that subcomponent if we currently don&#39;t want to look at a photo.</p>

<p>The first subcomponent called is <code>SELF:.sub_gal_list</code>. As the name suggests, it will list sub-galleries.</p>

<pre><code>  &#60;%method .sub_gal_list&#62;
    &#60;%args&#62;
      @dir_list
      $wrap =&#62; 1
    &#60;/%args&#62;

    &#60;h3&#62;Sub &#60;% @dir_list == 1 ? &#34;Gallery&#34; : &#34;Galleries&#34; %&#62;&#60;/h3&#62;
    &#60;% $table %&#62;
  
    &#60;%init&#62;
      @dir_list = grep { &#45;d $_ } @dir_list;
      return unless @dir_list;
      $_ = $m&#45;&#62;scomp(&#39;SELF:.sub_gal_view&#39;,dir =&#62; $_) for @dir_list;
      my $table = HTML::Table&#45;&#62;new(&#45;data =&#62; [ group \@dir_list, cols =&#62; $wrap ]);
    &#60;/%init&#62;
  &#60;/%method&#62;</code></pre>

<p><code>.sub_gal_list</code> accepts a directory listing argument. It also optionally accepts an argument detailing after how many entries in the list should be in each row.</p>













<p>Jumping to the <code>&#60;%init&#62;</code> block (remember the order of execution?), we filter the directory listing to exclude any entries that are not directories themselves. If that produces an empty list, there&#39;s no need to continue processing this subcomponent, so just <code>return</code>. Next, each of the entries are reformatted by passing them to the <code>SELF:.sub_gal_view</code> method. This is where it gets fun.</p>

<p>When a subcomponent is called, it&#39;s really just syntactic sugar to call <code>$m&#45;&#62;comp()</code>.</p>

<pre><code>  &#60;&#38; SELF:.sub_gal_view, dir =&#62; $_ &#38;&#62;</code></pre>

<p>The previous statement is exactly equivalent to the following:</p>

<pre><code>  % $m&#45;&#62;comp( &#39;SELF:.sub_gal_view&#39;, dir =&#62; $_ );</code></pre>

<p>Mason also defines the <code>scomp()</code> method, which compiles a subcomponent but returns its output as a string, just like Perl&#39;s <code>sprintf</code>.</p>

<p>After reformatting the entries, we group the flat list into a List&#45;of&#45;Lists containing just one column. That list is used as the value of the <code>-data</code> parameter to <code>HTML::Table&#45;</code>new()&#62;, which returns a table object.</p>

<p>Now it&#39;s time to process the template portion. First a heading is created. It&#39;s only plural if we have more than one sub-gallery. After the heading the sub-gallery table is displayed. Because an <code>HTML::Table</code> object overloads stringify, there&#39;s no need to call a method on it to get the HTML output.</p>

<p>Let's quickly look at the <code>.sub_gal_view</code> subcomponent used to reformat each directory listing.</p>

<pre><code>  &#60;%method .sub_gal_view&#62;
    &#60;%args&#62;
      $dir
    &#60;/%args&#62;
    &#60;a href=&#34;/gallery/&#60;% $rel_dir %&#62;&quot;&gt;&#60;% $label %&#62;&#60;/a&#62;
    &#60;%init&#62;
      my $rel_dir = abs2rel $dir, $GALLERY_ROOT;
      my $label   = (splitpath $rel_dir)[&#45;1];
    &#60;/%init&#62;
  &#60;/%method&#62;</code></pre>

<p>This subcomponent is extremely straightforward. It accepts a directory. Inside <code>&#60;%init&#62;</code>, <code>$rel_dir</code> is set to the relative directory path in relation to the <code>$GALLERY_ROOT</code>, which will give us a proper URL for the link. Finding the label for the link is simple, it is the real directory name, which is the last element of the list returned by <code>splitpath()</code>, from <code>File::Spec::Functions</code>.</p>

<p>This subcomponent finally generates the proper link for navigating to sub-galleries.</p>

<p>The next subcomponent called by our top&#45;level component is <code>.photo_list</code>, which generates the thumbnail view of our images.</p>

<pre><code>  &#60;%method .photo_list&#62;
    &#60;%args&#62;
      @dir_list
      $wrap =&#62; 5
      $rows =&#62; 7
      $page =&#62; 1
    &#60;/%args&#62;

    &#60;h3&#62;&#60;% @dir_list == 1 ? &#34;Photo&#34; : &#34;Photos&#34; %&#62;
        &#60;&#38; SELF:.photo_pager, page =&#62; $page, pages =&#62; $pages &#38;&#62;&#60;/h3&#62;
    &#60;% $table %&#62;

    &#60;%init&#62;
      @dir_list = grep { &#45;f $_ } @dir_list;
      return unless @dir_list;
      $_ = $m&#45;&#62;scomp(&#39;SELF:.thumb_view&#39;,file =&#62; $_, page =&#62; $page)
        for @dir_list;
      my @files = group \@dir_list, cols =&#62; $wrap;
      
      my $pages  = int( @files / $rows );
         $pages += 1 if $pages &#60; ( @files / $rows );
      @files = splice @files, $rows * ($page &#45; 1), $rows;
      
      my $table = HTML::Table&#45;&#62;new(&#45;data =&#62; \@files);
    &#60;/%init&#62;
  &#60;/%method&#62;</code></pre>

<p>Just like <code>.sub_gal_list</code>, the only required argument to this component is the directory listing. The other optional arguments correspond to how many images should be in each row (<code>$wrap</code>), how many rows to show on a page (<code>$rows</code>), and what page we&#39;re currently on (<code>$page</code>).</p>

<p>Once again we jump to the <code>&#60;%init&#62;</code> block where the directory listing is filtered to only include files. If there are no files, there&#39;s no reason to go any further, so just <code>return</code> from this subcomponent. Just as we did with sub-gallery listings, we reformat the remaining list of files by calling a subcomponent and storing its output. Next, we group the list of files into a List&#45;of&#45;Lists (LoL), each row containing <code>$wrap</code> entries.</p>

<p>Photo galleries may contain any number of photos, so it&#39;s essential to support paging for thumbnails. First we need to determine how many pages this gallery will have in total. To do that we divide the total number of rows by the number of rows we want on each page. That could return a fractional number that will be cut off to the nearest decimal by <code>int</code>. If that&#39;s the case then we want to increment the number of pages by one (<code>1</code>). Next we can extract the rows for our current page from all the rows currently in <code>@files</code> using a <code>splice</code>.</p>

<p>Finally, a new <code>HTML::Table</code> object is created, and populated with <code>@files</code>.</p>

<p>In the template portion a header is output, again only using the plural if we have more than one photo. Our header also contains paging information, provided by the <code>.photo_pager</code> subcomponent. Lastly, the HTML table full of thumbnails is displayed.</p>

<p>Speaking of thumbnails, it&#39;s time to look at the code in the <code>.thumb_view</code> subcomponent.</p>

<pre><code>  &#60;%method .thumb_view&#62;
    &#60;%args&#62;
      $file
      $page
    &#60;/%args&#62;
      &#60;a href=&#34;/gallery/&#60;% $rel_img %&#62;.html?page=&#60;% $page %&#62;&quot;&gt;
        &#60;img src=&#34;/gallery/images/&#60;% $rel_img %&#62;?xsize=50;ysize=40&#34; border=&#34;0&#34; /&#62;
      &#60;/a&#62;
    &#60;%init&#62;
      my $rel_img = abs2rel $file, $GALLERY_ROOT;
    &#60;/%init&#62;
  &#60;/%method&#62;</code></pre>

<p>This component takes two arguments. <code>$file</code> is the image to be turned into a thumbnail, and <code>$page</code> is the current page of this gallery. The <code>&#60;%init&#62;</code> block just finds the relative path of this image from the <code>$GALLERY_ROOT</code>. In the template the thumbnail is linked to the HTML file that this image would be displayed on, and includes the current page information as a means of saving that state.</p>

<p>The source of the image points to a file under <em>/gallery/images</em>, and includes query parameters for maximum width (<code>xsize</code>) and height (<code>ysize</code>). This is interesting because the pictures don&#39;t live there at all. If you recall, the only thing inside the <em>images</em> directory was a <em>dhandler</em>. More on that later.</p>

<p>The other subcomponent that <code>.photo_list</code> called was <code>.photo_pager</code>.</p>

<pre><code>  &#60;%method .photo_pager&#62;
    &#60;%args&#62;
      $page
      $pages
    &#60;/%args&#62;
    (
  % for ( 1 .. $pages ) {
  %   if ( $_ == $page ) {
        &#60;strong&#62;&#60;% $page %&#62;&#60;/strong&#62;
  %   } else {
        &#60;a href=&#34;?page=&#60;% $_ %&#62;&quot;&gt;&#60;% $_ %&#62;&#60;/a&#62;
  %   }
      &#60;% $_ != $pages ? &#34;&#38;middot;&#34; : &#34;&#34; %&#62;
  % }
    )
    &#60;%init&#62;
      return if $pages == 1;
    &#60;/%init&#62;
  &#60;/%method&#62;</code></pre>

<p>This subcomponent takes two arguments, the current page and the total number of pages. Before anything is output, the <code>&#60;%init&#62;</code> block checks to make sure we have more than one page. If not, no sense in going on. Looping through all the page numbers, we link all the numbers except our current page. After every number except the last one, we output a stylish separator. This subcomponent is very simple, but big enough that it&#39;s worth abstracting from the <code>.photo_list</code> subcomponent.</p>

<p>The final subcomponent in the top&#45;level <em>dhandler</em> is <code>.photo_view</code>.</p>

<pre><code>  &#60;%method .photo_view&#62;
    &#60;%args&#62;
      $file
    &#60;/%args&#62;
    &#60;h3&#62;Photo&#60;/h3&#62;
    &#60;img src=&#34;/gallery/images/&#60;% $rel_image %&#62;?xsize=400x;ysize=300&#34; /&#62;
    &#60;%init&#62;
      my $rel_image = abs2rel $file, $GALLERY_ROOT;
    &#60;/%init&#62;
  &#60;/%method&#62;</code></pre>

<p>This component does things that we&#39;ve already seen done in <code>.thumb_view</code>, so there&#39;s no need to expound upon it here.</p>














<h3><a name="The_Images_dhandler">The Images <em>dhandler</em></a></h3>

<p>You&#39;ve probably guessed by now that we intend to use Mason to process images. Mason is well suited to outputting many forms of data, not just text, and we&#39;ll be exploiting that fact for our image gallery.</p>

<pre><code>  &#60;%args&#62;
    $xsize =&#62; undef
    $ysize =&#62; undef
  &#60;/%args&#62;</code></pre>

<p>This component accepts two parameters that we&#39;ve already described. <code>$xsize</code> is the maximum width an image can be, and <code>$ysize</code> is the maximum height an image can be.</p>

<pre><code>  &#60;%flags&#62;
    inherit =&#62; undef
  &#60;/%flags&#62;</code></pre>

<p>This is the important part. Because components have inheritance, the <em>dhandler</em> would normally inherit from the <em>autohandler</em>. That&#39;s bad news when the <em>autohandler</em> is tuned to sending out HTML and our <em>dhandler</em> is trying to send binary image data. Setting the <code>inherit</code> flag to <code>undef</code> tells Mason that the <em>dhandler</em> doesn&#39;t inherit anything, that it&#39;s responsible for its own output.</p>

<p>The only code remaining in this template resides in the <code>&#60;%init&#62;</code> block, so let's step through that now.</p>

<pre><code>  &#60;%init&#62;
    $m&#45;&#62;clear_buffer;</code></pre>

<p>The very first thing we do is clear Mason&#39;s output buffer. This clears any headers that have already been built up in the buffer.</p>

<pre><code>    use Imager;
    use File::Type;</code></pre>

<p>Next we use the modules that will help scale the images, <code>Imager</code> and <code>File::Type</code>. <code>Imager</code> has already been discussed. <code>File::Type</code> uses magic to discover the type of files, and does so in a very memory&#45;sensitive way.</p>

<pre><code>    my $send_img = sub {
      $r&#45;&#62;content_type( &#34;image/$_[0]&#34; );
      $r&#45;&#62;send_http_header;
      $m&#45;&#62;print($_[1]);
      $m&#45;&#62;abort(200);
    };</code></pre>

<p>This anonymous subroutine just encapsulates code being executed twice, as a means to remove duplication. It sets the HTTP <code>Content&#45;Type</code> header to the image type passed as the first argument. Next it sends the HTTP header out. Then it sends the image data out, which is the second argument passed to this subroutine. Finally, it aborts execution with an HTTP <code>200</code> status code, everything is <i>OK</i>.</p>

<pre><code>    ( my $file = $r&#45;&#62;document_root . $r&#45;&#62;uri ) =~ s/images/pictures/;</code></pre>

<p>Discovering the proper file name for the image takes just a little work. After concatenating the <code>document_root()</code> with the <code>uri()</code>, we replace the <em>images</em> portion of the file path with <em>pictures</em>. Remember, none of the images are actually in the <em>images</em> directory.</p>

<pre><code>    my ($image, $type) = split /\//, File::Type&#45;&#62;checktype_filename($file);
    $type = &#39;png&#39; if $type eq &#39;x&#45;png&#39;;</code></pre>

<p>With the knowledge of the proper file name, <code>File::Type</code> can figure out what type of file we have. This is more foolproof than attempting a guess based on filename extensions. As a minor oddity, <code>File::Type</code> returns a non&#45;HTTP friendly <code>$type</code> for PNG images, so we need to fix that problem if it exists.</p>

<pre><code>    my $key = &#34;$file|$xsize|$ysize&#34;;
    if ( my $data = $m&#45;&#62;cache&#45;&#62;get( $key ) ) {
      $send_img&#45;&#62;($type, $data);
    }</code></pre>

<p>Generating scaled images from huge photos is a time-consuming function. It also has the potential to eat memory like a sieve. As a result, it&#39;s imperative that we take advantage of Mason&#39;s built&#45;in caching functionality. The key for each entry in our cache must be unique for each file, and the dimensions we&#39;re trying to scale it to. Those three pieces of data will make up our <code>$key</code>. If data is returned from the cache using the <code>$key</code>, then the image data is sent and the request is immediately aborted. This is a quick short-circuit that allows us to grab an image from the cache and return it at the earliest possible moment. Later in the article you&#39;ll see how to set the data into the cache.</p>

<pre><code>    $m&#45;&#62;abort(500) if $image ne &#39;image&#39; || ! exists $Imager::formats{$type};</code></pre>

<p>It&#39;s possible that the file being requested isn&#39;t an image. It&#39;s also possible that our installation of <code>Imager</code> doesn&#39;t support this type of image. If either of these conditions are true, we should abort immediately with a <code>500</code> HTTP status code, <i>Internal Server Error</i>.</p>

<pre><code>    my $img  = Imager&#45;&#62;new;
    if ( $img&#45;&#62;open(file =&#62; $file, type =&#62; $type) ) {
        if ( $xsize ) {
          $img = $img&#45;&#62;scale( xpixels =&#62; $xsize )
            unless $img&#45;&#62;getwidth &#60; $xsize;
        }
        if ( $ysize ) {
          $img = $img&#45;&#62;scale( ypixels =&#62; $ysize )
            unless $img&#45;&#62;getheight &#60; $ysize;
        }

        my $img_data;
        $img&#45;&#62;write(data =&#62; \$img_data, type =&#62; $type);
        $m&#45;&#62;cache&#45;&#62;set( $key =&#62; $img_data );
        $send_img&#45;&#62;($type, $img_data);
    }</code></pre>

<p>Now the heart and soul of image manipulation. The first step is to create a new <code>Imager</code> object. Next we try to open the image <code>$file</code>. If that succeeds, we can proceed to scaling the image.</p>

<p>When scaling, it&#39;s more important (to me) that the height of the image is exactly how I want it, so width is scaled first. Before the image is scaled its size is tested against the size of the image to be created. No scaling should occur if the image is smaller than the preferred size.</p>

<p>Once scaling has finished the image data can be extracted from the <code>Imager</code> object. When calling <code>write()</code> on the object we can pass a <code>data</code> option to let <code>Imager</code> write to a scalar reference. After the image data has been retrieved it is placed in the cache using the same <code>$key</code> that we first used when attempting to get information out of the cache. Finally, the image is sent out and the request is aborted.</p>

<pre><code>    warn &#34;[$file] [$image/$type] &#34; . $img&#45;&#62;errstr;
    $m&#45;&#62;abort(500);
  &#60;/%init&#62;</code></pre>

<p>In the event that <code>Imager</code> wasn&#39;t able to open the <code>$file</code>, the request should be aborted with a <code>500</code> HTTP status code, <i>Internal Server Error</i>. Before abortion, however, it would be useful to get some information in the <em>error_log</em>. The requested <code>$file</code>, its type information, and the error produced by <code>Imager</code> are all printed to <code>STDOUT</code> via <code>warn</code>.</p>

<h3><a name="What_It_Looks_Like">What It Looks Like</a></h3>

<p>For the less adventurous, yet overly curious members of the audience, a screenshot of our photo gallery follows.</p>


<p><img src="/pub/2004/04/01/graphics/figure_0.jpg" width="450" height="285" alt="Photo Gallery Screenshot" border="0" /></p>


<p>As an aside, that image was originally much larger, but I really wanted it to be just <code>450</code> pixels wide. I don&#39;t have any image manipulation tools to do that job, but I do have <code>Imager</code>. Thanks to <code>Imager</code>, it took me 30 seconds to whip up the following command line snippet.</p>

<pre><code>  perl &#45;MImager &#45;le&#39;Imager&#45;&#62;new&#45;&#62;open(file=&#62;shift,type=&#62;&#34;jpeg&#34;)
    &#45;&#62;scale(xpixels=&#62;450)
    &#45;&#62;write(file=&#62;shift,type=&#62;&#34;jpeg&#34;)&#39; figure_0.jpg figure_0_0.jpg</code></pre>

<h3><a name="Conclusion">Conclusion</a></h3>

<p>We&#39;ve just created a photo gallery that takes all the hard work out of maintaining photo galleries. There&#39;s no need to pre&#45;generate HTML or thumbnails. There&#39;s no web application interface so you don&#39;t have to change ownership of your gallery directory to the same user that Apache runs as. Using Mason&#39;s built-in caching, photo galleries are nearly as fast as accessing the data directly from the file system. Well, at least on the second request. Our galleries have paging and infinite sub-galleries. Most importantly, using Mason to its full potential has given us a fully customizable, very tiny web application that can be dropped into any existing web site or framework.</p>

<p>In fact, this code is the majority of the <i>faceplant</i> project. The source code can be downloaded from <a href='http://search.cpan.org/dist/faceplant'>http://search.cpan.org/dist/faceplant</a>. <i>faceplant</i> implements a few more features and is a bit more customizable. As such, its code is an excellent follow&#45;up to this article. Go forth, now, and plant thy face on the Internet!</p>

        </div>



    </div>
    <div class="asset-footer"></div>
</div>




                            <div class="content-nav">
                                <a href="/pub/2004/03/">&laquo; March 2004</a> |
                                <a href="/pub/">Main Index</a> |
                                <a href="/pub/archives.html">Archives</a>
                                | <a href="/pub/2004/05/">May 2004 &raquo;</a>
                            </div>


                        </div>
                    </div>


                    <div id="beta">
    <div id="beta-inner">


    
    <div class="widget-what-is-perl widget">
    <div class="widget-content widget-content-what-is-perl">
       Visit the home of the  Perl programming language: <a href="http://www.perl.org/">Perl.org</a
    </div>
</div>
<div class="widget-find-out-more widget-archives widget">
    <div class="widget-content">
        <ul>
            <li><a href="http://www.perl.org/get.html">Download</a></li>
            <li><a href="http://perldoc.perl.org/">Documentation</a></li>
            <li><a href="http://blogs.perl.org/">Perl Bloggers</a></li>
            <li><a href="http://news.perlfoundation.org/">Foundation News</a></li>
        </ul>
    </div>
</div><div class="widget-tcpc widget">
<h3 class="widget-header">Sponsored by</h3>
    <div class="widget-content">
        <a href="http://training.perl.com/" alt="Perl Training" target="_blank"><img src="/i/tcpc.png" width="150" height="50"></a>
    </div>
</div>

<div class="widget-syndication widget">
    <div class="widget-content">
        <ul>
            <li><img src="/mt-static/images/status_icons/feed.gif" alt="Subscribe to feed" width="9" height="9" /> <a href="/pub/atom.xml">Subscribe to this website's feed</a></li>

        </ul>
    </div>
</div>
<div class="widget-archive-monthly widget-archive widget">
    <h3 class="widget-header">Monthly <a href="/pub/archives.html">Archives</a></h3>
    <div class="widget-content">
        <ul>
        
            <li><a href="/pub/2014/02/">February 2014 (1)</a></li>
        
    
        
            <li><a href="/pub/2014/01/">January 2014 (1)</a></li>
        
    
        
            <li><a href="/pub/2013/10/">October 2013 (1)</a></li>
        
    
        
            <li><a href="/pub/2013/01/">January 2013 (1)</a></li>
        
    
        
            <li><a href="/pub/2012/12/">December 2012 (1)</a></li>
        
    
        
            <li><a href="/pub/2012/11/">November 2012 (1)</a></li>
        
    
        
            <li><a href="/pub/2012/10/">October 2012 (2)</a></li>
        
    
        
            <li><a href="/pub/2012/08/">August 2012 (2)</a></li>
        
    
        
            <li><a href="/pub/2012/06/">June 2012 (11)</a></li>
        
    
        
            <li><a href="/pub/2012/05/">May 2012 (18)</a></li>
        
    
        
            <li><a href="/pub/2012/04/">April 2012 (17)</a></li>
        
    
        
            <li><a href="/pub/2012/02/">February 2012 (1)</a></li>
        
    
        
            <li><a href="/pub/2011/12/">December 2011 (1)</a></li>
        
    
        
            <li><a href="/pub/2011/09/">September 2011 (1)</a></li>
        
    
        
            <li><a href="/pub/2011/08/">August 2011 (2)</a></li>
        
    
        
            <li><a href="/pub/2011/06/">June 2011 (1)</a></li>
        
    
        
            <li><a href="/pub/2011/05/">May 2011 (3)</a></li>
        
    
        
            <li><a href="/pub/2011/04/">April 2011 (1)</a></li>
        
    
        
            <li><a href="/pub/2011/03/">March 2011 (1)</a></li>
        
    
        
            <li><a href="/pub/2011/02/">February 2011 (1)</a></li>
        
    
        
            <li><a href="/pub/2011/01/">January 2011 (1)</a></li>
        
    
        
            <li><a href="/pub/2010/11/">November 2010 (1)</a></li>
        
    
        
            <li><a href="/pub/2010/10/">October 2010 (2)</a></li>
        
    
        
            <li><a href="/pub/2010/09/">September 2010 (1)</a></li>
        
    
        
            <li><a href="/pub/2010/08/">August 2010 (3)</a></li>
        
    
        
            <li><a href="/pub/2010/07/">July 2010 (2)</a></li>
        
    
        
            <li><a href="/pub/2010/04/">April 2010 (2)</a></li>
        
    
        
            <li><a href="/pub/2010/03/">March 2010 (4)</a></li>
        
    
        
            <li><a href="/pub/2008/05/">May 2008 (1)</a></li>
        
    
        
            <li><a href="/pub/2008/04/">April 2008 (2)</a></li>
        
    
        
            <li><a href="/pub/2008/03/">March 2008 (1)</a></li>
        
    
        
            <li><a href="/pub/2008/02/">February 2008 (1)</a></li>
        
    
        
            <li><a href="/pub/2008/01/">January 2008 (1)</a></li>
        
    
        
            <li><a href="/pub/2007/12/">December 2007 (2)</a></li>
        
    
        
            <li><a href="/pub/2007/09/">September 2007 (1)</a></li>
        
    
        
            <li><a href="/pub/2007/08/">August 2007 (1)</a></li>
        
    
        
            <li><a href="/pub/2007/07/">July 2007 (1)</a></li>
        
    
        
            <li><a href="/pub/2007/06/">June 2007 (1)</a></li>
        
    
        
            <li><a href="/pub/2007/05/">May 2007 (1)</a></li>
        
    
        
            <li><a href="/pub/2007/04/">April 2007 (1)</a></li>
        
    
        
            <li><a href="/pub/2007/03/">March 2007 (1)</a></li>
        
    
        
            <li><a href="/pub/2007/02/">February 2007 (1)</a></li>
        
    
        
            <li><a href="/pub/2007/01/">January 2007 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/12/">December 2006 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/11/">November 2006 (2)</a></li>
        
    
        
            <li><a href="/pub/2006/10/">October 2006 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/09/">September 2006 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/08/">August 2006 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/07/">July 2006 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/06/">June 2006 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/05/">May 2006 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/04/">April 2006 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/03/">March 2006 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/02/">February 2006 (4)</a></li>
        
    
        
            <li><a href="/pub/2006/01/">January 2006 (4)</a></li>
        
    
        
            <li><a href="/pub/2005/12/">December 2005 (4)</a></li>
        
    
        
            <li><a href="/pub/2005/11/">November 2005 (3)</a></li>
        
    
        
            <li><a href="/pub/2005/10/">October 2005 (2)</a></li>
        
    
        
            <li><a href="/pub/2005/09/">September 2005 (2)</a></li>
        
    
        
            <li><a href="/pub/2005/08/">August 2005 (9)</a></li>
        
    
        
            <li><a href="/pub/2005/07/">July 2005 (8)</a></li>
        
    
        
            <li><a href="/pub/2005/06/">June 2005 (9)</a></li>
        
    
        
            <li><a href="/pub/2005/05/">May 2005 (8)</a></li>
        
    
        
            <li><a href="/pub/2005/04/">April 2005 (7)</a></li>
        
    
        
            <li><a href="/pub/2005/03/">March 2005 (6)</a></li>
        
    
        
            <li><a href="/pub/2005/02/">February 2005 (7)</a></li>
        
    
        
            <li><a href="/pub/2005/01/">January 2005 (6)</a></li>
        
    
        
            <li><a href="/pub/2004/12/">December 2004 (8)</a></li>
        
    
        
            <li><a href="/pub/2004/11/">November 2004 (8)</a></li>
        
    
        
            <li><a href="/pub/2004/10/">October 2004 (5)</a></li>
        
    
        
            <li><a href="/pub/2004/09/">September 2004 (9)</a></li>
        
    
        
            <li><a href="/pub/2004/08/">August 2004 (6)</a></li>
        
    
        
            <li><a href="/pub/2004/07/">July 2004 (8)</a></li>
        
    
        
            <li><a href="/pub/2004/06/">June 2004 (6)</a></li>
        
    
        
            <li><a href="/pub/2004/05/">May 2004 (7)</a></li>
        
    
        
            <li><a href="/pub/2004/04/">April 2004 (8)</a></li>
        
    
        
            <li><a href="/pub/2004/03/">March 2004 (8)</a></li>
        
    
        
            <li><a href="/pub/2004/02/">February 2004 (9)</a></li>
        
    
        
            <li><a href="/pub/2004/01/">January 2004 (7)</a></li>
        
    
        
            <li><a href="/pub/2003/12/">December 2003 (4)</a></li>
        
    
        
            <li><a href="/pub/2003/11/">November 2003 (7)</a></li>
        
    
        
            <li><a href="/pub/2003/10/">October 2003 (8)</a></li>
        
    
        
            <li><a href="/pub/2003/09/">September 2003 (6)</a></li>
        
    
        
            <li><a href="/pub/2003/08/">August 2003 (7)</a></li>
        
    
        
            <li><a href="/pub/2003/07/">July 2003 (9)</a></li>
        
    
        
            <li><a href="/pub/2003/06/">June 2003 (9)</a></li>
        
    
        
            <li><a href="/pub/2003/05/">May 2003 (8)</a></li>
        
    
        
            <li><a href="/pub/2003/04/">April 2003 (8)</a></li>
        
    
        
            <li><a href="/pub/2003/03/">March 2003 (10)</a></li>
        
    
        
            <li><a href="/pub/2003/02/">February 2003 (8)</a></li>
        
    
        
            <li><a href="/pub/2003/01/">January 2003 (8)</a></li>
        
    
        
            <li><a href="/pub/2002/12/">December 2002 (5)</a></li>
        
    
        
            <li><a href="/pub/2002/11/">November 2002 (9)</a></li>
        
    
        
            <li><a href="/pub/2002/10/">October 2002 (7)</a></li>
        
    
        
            <li><a href="/pub/2002/09/">September 2002 (11)</a></li>
        
    
        
            <li><a href="/pub/2002/08/">August 2002 (8)</a></li>
        
    
        
            <li><a href="/pub/2002/07/">July 2002 (8)</a></li>
        
    
        
            <li><a href="/pub/2002/06/">June 2002 (4)</a></li>
        
    
        
            <li><a href="/pub/2002/05/">May 2002 (6)</a></li>
        
    
        
            <li><a href="/pub/2002/04/">April 2002 (6)</a></li>
        
    
        
            <li><a href="/pub/2002/03/">March 2002 (7)</a></li>
        
    
        
            <li><a href="/pub/2002/02/">February 2002 (5)</a></li>
        
    
        
            <li><a href="/pub/2002/01/">January 2002 (8)</a></li>
        
    
        
            <li><a href="/pub/2001/12/">December 2001 (7)</a></li>
        
    
        
            <li><a href="/pub/2001/11/">November 2001 (5)</a></li>
        
    
        
            <li><a href="/pub/2001/10/">October 2001 (9)</a></li>
        
    
        
            <li><a href="/pub/2001/09/">September 2001 (7)</a></li>
        
    
        
            <li><a href="/pub/2001/08/">August 2001 (13)</a></li>
        
    
        
            <li><a href="/pub/2001/07/">July 2001 (8)</a></li>
        
    
        
            <li><a href="/pub/2001/06/">June 2001 (13)</a></li>
        
    
        
            <li><a href="/pub/2001/05/">May 2001 (11)</a></li>
        
    
        
            <li><a href="/pub/2001/04/">April 2001 (9)</a></li>
        
    
        
            <li><a href="/pub/2001/03/">March 2001 (8)</a></li>
        
    
        
            <li><a href="/pub/2001/02/">February 2001 (8)</a></li>
        
    
        
            <li><a href="/pub/2001/01/">January 2001 (8)</a></li>
        
    
        
            <li><a href="/pub/2000/12/">December 2000 (6)</a></li>
        
    
        
            <li><a href="/pub/2000/11/">November 2000 (10)</a></li>
        
    
        
            <li><a href="/pub/2000/10/">October 2000 (10)</a></li>
        
    
        
            <li><a href="/pub/2000/09/">September 2000 (2)</a></li>
        
    
        
            <li><a href="/pub/2000/08/">August 2000 (2)</a></li>
        
    
        
            <li><a href="/pub/2000/07/">July 2000 (5)</a></li>
        
    
        
            <li><a href="/pub/2000/06/">June 2000 (7)</a></li>
        
    
        
            <li><a href="/pub/2000/05/">May 2000 (7)</a></li>
        
    
        
            <li><a href="/pub/2000/04/">April 2000 (3)</a></li>
        
    
        
            <li><a href="/pub/2000/03/">March 2000 (2)</a></li>
        
    
        
            <li><a href="/pub/2000/02/">February 2000 (2)</a></li>
        
    
        
            <li><a href="/pub/2000/01/">January 2000 (2)</a></li>
        
    
        
            <li><a href="/pub/1999/12/">December 1999 (6)</a></li>
        
    
        
            <li><a href="/pub/1999/11/">November 1999 (6)</a></li>
        
    
        
            <li><a href="/pub/1999/10/">October 1999 (5)</a></li>
        
    
        
            <li><a href="/pub/1999/09/">September 1999 (4)</a></li>
        
    
        
            <li><a href="/pub/1999/08/">August 1999 (3)</a></li>
        
    
        
            <li><a href="/pub/1999/07/">July 1999 (2)</a></li>
        
    
        
            <li><a href="/pub/1999/06/">June 1999 (3)</a></li>
        
    
        
            <li><a href="/pub/1999/04/">April 1999 (1)</a></li>
        
    
        
            <li><a href="/pub/1999/03/">March 1999 (1)</a></li>
        
    
        
            <li><a href="/pub/1999/01/">January 1999 (1)</a></li>
        
    
        
            <li><a href="/pub/1998/12/">December 1998 (1)</a></li>
        
    
        
            <li><a href="/pub/1998/11/">November 1998 (1)</a></li>
        
    
        
            <li><a href="/pub/1998/07/">July 1998 (2)</a></li>
        
    
        
            <li><a href="/pub/1998/06/">June 1998 (1)</a></li>
        
    
        
            <li><a href="/pub/1998/03/">March 1998 (1)</a></li>
        
        </ul>
    </div>
</div>
        
    

<div class="widget-powered widget">
    <div class="widget-content">
        <a href="http://www.movabletype.com/"><img src="/mt-static/images/bug-pbmt-white.png" alt="Powered by Movable Type 5.13-en" width="120" height="75" /></a>
    </div>
</div>



    </div>
</div>






                </div>
            </div>


            <div id="footer">
    <div id="footer-inner">
        <div id="footer-content">
            <div class="widget-powered widget">
                <div class="widget-content">
                    Powered by <a href="http://www.movabletype.com/" rel="generator">Movable Type Pro</a>
                </div>
            </div>

            <div class="widget-creative-commons widget">
                <div class="widget-content">
                    This blog is licensed under a <a href="http://creativecommons.org/licenses/by-nc-nd/3.0/">Creative Commons License</a>.
                </div>
            </div>

        </div>
    </div>
</div>



        </div>
    </div>
</body>
</html>
