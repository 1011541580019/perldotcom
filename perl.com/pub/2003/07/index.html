<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" id="sixapart-standard">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="generator" content="Movable Type Pro 5.13-en" />
<link rel="stylesheet" href="/pub/styles.css" type="text/css" />
<link rel="start" href="/pub/" title="Home" />
<link rel="alternate" type="application/atom+xml" title="Recent Entries" href="/pub/atom.xml" />
<script type="text/javascript" src="/pub/mt.js"></script>
<!--
<rdf:RDF xmlns="http://web.resource.org/cc/"
         xmlns:dc="http://purl.org/dc/elements/1.1/"
         xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#">
<Work rdf:about="/pub/">
<dc:title>Perl.com</dc:title>
<dc:description>news and views of the Perl programming language</dc:description>
<license rdf:resource="http://creativecommons.org/licenses/by-nc-nd/3.0/" />
</Work>
<License rdf:about="http://creativecommons.org/licenses/by-nc-nd/3.0/">
</License>
</rdf:RDF>
-->

<script type="text/javascript">

 var _gaq = _gaq || [];
 _gaq.push(['_setAccount', 'UA-50555-22']);
 _gaq.push(['_trackPageview']);

 (function() {
   var ga = document.createElement('script'); ga.type =
   'text/javascript'; ga.async = true;
   ga.src = ('https:' == document.location.protocol ? 'https://ssl' :
   'http://www') + '.google-analytics.com/ga.js';
   var s = document.getElementsByTagName('script')[0];
   s.parentNode.insertBefore(ga, s);
 })();

</script>
<script type='text/javascript' src='http://partner.googleadservices.com/gampad/google_service.js'></script>
<script type='text/javascript'>
GS_googleAddAdSenseService("ca-pub-4136420132070439");
GS_googleEnableAllServices();
</script>
<script type='text/javascript'>
GA_googleAddSlot("ca-pub-4136420132070439", "Perl_728x90");
</script>
<script type='text/javascript'>GA_googleFetchAds();</script>
    <title>Perl.com: July 2003 Archives</title>


    <link rel="prev" href="/pub/2003/06/" title="June 2003" />
    <link rel="next" href="/pub/2003/08/" title="August 2003" />

</head>
<body id="perl-com" class="mt-archive-listing mt-datebased-monthly-archive layout-wt">
    <div id="container">
        <div id="container-inner">


            <div id="header">
    <div id="header-inner">
        <div id="header-content">
        <span id="top_advert"> 
<!-- Put any landscape advert in here -->
<!-- Perl_728x90 -->
<script type='text/javascript'>
GA_googleFillSlot("Perl_728x90");
</script>
        </span> 



            <div id="header-name"><a href="/pub/" accesskey="1">Perl.com</a></div>
            <div id="header-description">news and views of the Perl programming language</div>




        </div>
    </div>
</div>



            <div id="content">
                <div id="content-inner">


                    <div id="alpha">
                        <div id="alpha-inner">


                            <h1 id="page-title" class="archive-title">July 2003 Archives</h1>





                            
                            <div id="entry-1170" class="entry-asset asset hentry">
    <div class="asset-header">
        <h2 class="asset-name entry-title"><a href="/pub/2003/07/29/exegesis6.html" rel="bookmark">Exegesis 6</a></h2>
        <div class="asset-meta">
            <span class="byline">
    
                By <span class="vcard author">Damian Conway</span> on <abbr class="published" title="2003-07-29T00:00:00-08:00">July 29, 2003 12:00 AM</abbr>
    
            </span>

            
            

        </div>
    </div>
    <div class="asset-content entry-content">

        <div class="asset-body">
            
<!-- sidebar begins -->
<!-- don't move sidebars -->
<!-- sidebar ends -->

<p><em>Editor's note: this document is out of date and remains here for historic interest.  See <a href="http://dev.perl.org/perl6/doc/design/syn/S06.html">Synopsis 6</a> for the current design information.</p>

<blockquote>

<p><em>As soon as she walked through my door I knew her type: she was an
argument waiting to happen. I wondered if the argument was required... or
merely optional? Guess I'd know the parameters soon enough.</em></p>

<p><em>"I'm Star At Data," she offered.</em></p>

<p><em>She made it sound like a pass. But was the pass by name? Or by
position?</em></p>

<p><em>"I think someone's trying to execute me. Some caller."</em></p>

<p><em>"Okay, I'll see what I can find out. Meanwhile, we're gonna have to
limit the scope of your accessibility."</em></p>

<p><em>"I'd prefer not to be bound like that," she replied.</em></p>

<p><em>"I see you know my methods," I shot back.</em></p>

<p><em>She just stared at me, like I was a block. Suddenly I wasn't surprised
someone wanted to dispatch her.</em></p>

<p><em>"I'll return later," she purred. "Meanwhile, I'm counting on you to give
me some closure."</em></p>

<p><em>It was gonna be another routine investigation.</em></p>

<p>&mdash; Dashiell Hammett, "The Maltese Camel"</p>
</blockquote>



<p>This Exegesis explores the new subroutine semantics described in Apocalypse
6. Those new semantics greatly increase the power and flexibility of subroutine
definitions, providing required and optional formal parameters, named and
positional arguments, a new and extended operator overloading syntax, a far
more sophisticated type system, multiple dispatch, compile-time macros,
currying, and subroutine wrappers.</p>

<p>As if that weren't bounty enough, Apocalypse 6 also covers the
object-oriented subroutines: methods and submethods. We will, however, defer a
discussion of those until Exegesis 12.</p>

<h3>Playing Our Parts</h3>

<p>Suppose we want to be able to partition a list into two arrays (hereafter
known as "sheep" and "goats"), according to some user-supplied criterion. We'll
call the necessary subroutine <code>&amp;part</code>, because it
<em>part</em>itions a list into two <em>part</em>s.</p>

<p>In the most general case, we could specify how <code>&amp;part</code> splits
the list up by passing it a subroutine. <code>&amp;part</code> could then call
that subroutine for each element, placing the element in the "sheep" array if
the subroutine returns true, and into the "goats" array otherwise. It would
then return a list of references to the two resulting arrays.</p>

<p>For example, calling:</p>

<pre><code>($cats, $chattels) = part &amp;is_feline, @animals;</code></pre>

<p>would result in <code>$cats</code> being assigned a reference to an array
containing all the animals that are feline and <code>$chattels</code> being
assigned a reference to an array containing everything else that exists merely
for the convenience of cats.</p>

<p>Note that in the above example (and throughout the remainder of this
discussion), when we're talking about a subroutine as an object in its own
right, we'll use the <code>&amp;</code> sigil; but when we're talking about a
call to the subroutine, there will be no <code>&amp;</code> before its name.
That's a distinction Perl 6 enforces too: subroutine calls never have an
ampersand; references to the corresponding <code>Code</code> object always
do.</p>

<h3>Part: The First</h3>

<p>The Perl 6 implementation of <code>&amp;part</code> would therefore be:</p>

<pre><code>sub part (Code $is_sheep, *@data) {
	my (@sheep, @goats);
	for @data {
		if $is_sheep($_) { push @sheep, $_ }
		else             { push @goats, $_ }
	}
	return (\@sheep, \@goats);
}</code></pre>

<p>As in Perl 5, the <code>sub</code> keyword declares a subroutine. As in Perl
5, the name of the subroutine follows the <code>sub</code> and &mdash; assuming
that name doesn't include a package qualifier &mdash; the resulting subroutine
is installed into the current package.</p>

<p><strong>Un</strong>like Perl 5, in Perl 6 we are allowed to specify a formal
parameter list after the subroutine's name. This list consists of zero or more
parameter variables. Each of these parameter variables is really a lexical
variable declaration, but because they're in a parameter list we don't need to
(and aren't allowed to!) use the keyword <code>my</code>.</p>

<p>Just as with a regular variable, each parameter can be given a storage type,
indicating what kind of value it is allowed to store.  In the above example,
for instance, the <code>$is_sheep</code> parameter is given the type
<code>Code</code>, indicating that it is restricted to objects of that type
(i.e. the first argument must be a subroutine or block).</p>

<p>Each of these parameter variables is automatically scoped to the body of the
subroutine, where it can be used to access the arguments with which the
subroutine was called.</p>

<p>A word about terminology: an "argument" is a item in the list of data that
is passed as part of a subroutine call. A "parameter" is a special variable
inside the subroutine itself.  So the subroutine call sends arguments, which
the subroutine then accesses via its parameters.</p>

<p>Perl 5 has parameters too, but they're not user-specifiable.  They're always
called <code>$_[0]</code>, <code>$_[1]</code>, <code>$_[2]</code>, etc.</p>

<h4>Not-So-Secret Alias</h4>

<p>However, one way in which Perl 5 and Perl 6 parameters <em>are</em> similar
is that, unlike Certain Other Languages, Perl parameters don't receive copies
of their respective arguments.  Instead, Perl parameters become
<em>aliases</em> for the corresponding arguments.</p>

<p>That's already the case in Perl 5. So, for example, we can write a
temperature conversion utility like:</p>

<pre><code># Perl 5 code...
sub Fahrenheit_to_Kelvin {
	$_[0] -= 32;
	$_[0] /= 1.8;
	$_[0] += 273.15;
}

# and later...

Fahrenheit_to_Kelvin($reactor_temp);</code></pre>

<p>When the subroutine is called, within the body of
<code>&amp;Fahrenheit_to_Kelvin</code> the <code>$_[0]</code> variable becomes
just another name for <code>$reactor_temp</code>. So the changes the subroutine
makes to <code>$_[0]</code> are really being made to
<code>$reactor_temp</code>, and at the end of the call
<code>$reactor_temp</code> has been converted to the new temperature scale.</p>

<p>That's very handy when we intend to change the values of arguments (as in
the above example), but it's potentially a very nasty trap too. Many
programmers, accustomed to the pass-by-copy semantics of other languages, will
unconsciously fall into the habit of treating the contents of
<code>$_[0]</code> as if they were a copy. Eventually that will lead to some
subroutine unintentionally changing one of its arguments &mdash; a bug that is
often very hard to diagnose and frequently even harder to track down.</p>

<p>So Perl 6 modifies the way parameters and arguments interact.  Explicit
parameters are still aliases to the original arguments, but in Perl 6 they're
<strong>constant</strong> aliases by default.  That means, unless we
specifically tell Perl 6 otherwise, it's illegal to change an argument by
modifying the corresponding parameter within a subroutine.</p>

<p>All of which means that a the na&iuml;ve translation of
<code>&amp;Fahrenheit_to_Kelvin</code> to Perl 6 isn't going to work:</p>

<pre><code># Perl 6 code...
sub Fahrenheit_to_Kelvin(Num $temp) {
	$temp -= 32;
	$temp /= 1.8;
	$temp += 273.15;
}</code></pre>

<p>That's because <code>$temp</code> (and hence the actual value it's an alias
for) is treated as a constant within the body of
<code>&amp;Fahrenheit_to_Kelvin</code>. In fact, we'd get a compile time error
message like:</p>

<pre><code>Cannot modify constant parameter ($temp) in &amp;Fahrenheit_to_Kelvin</code></pre>

<p>If we want to be able to modify arguments via Perl 6 parameters, we have to
say so up front, by declaring them <code>is rw</code> ("read-write"):</p>

<pre><code>sub Fahrenheit_to_Kelvin (Num $temp is rw) {
	$temp -= 32;
	$temp /= 1.8;
	$temp += 273.15;
}</code></pre>

<p>This requires a few extra keystrokes when the old behaviour is needed, but
saves a huge amount of hard-to-debug grief in the most common cases. As a
bonus, an explicit <code>is rw</code> declaration means that the compiler can
generally catch mistakes like this:</p>

<pre><code>$absolute_temp = Fahrenheit_to_Kelvin(212);</code></pre>

<p>Because we specified that the <code>$temp</code> argument has to be
read-writeable, the compiler can easily catch attempts to pass in a read-only
value.</p>

<p>Alternatively, we might prefer that <code>$temp</code> not be an alias at
all. We might prefer that <code>&amp;Fahrenheit_to_Kelvin</code> take a
<em>copy</em> of its argument, which we could then modify without affecting the
original, ultimately returning it as our converted value. We can do that too in
Perl 6, using the <code>is copy</code> trait:</p>

<pre><code>sub Fahrenheit_to_Kelvin(Num $temp is copy) {
	$temp -= 32;
	$temp /= 1.8;
	$temp += 273.15;
	return $temp;
}</code></pre>













<p><em>Editor's note: this document is out of date and remains here for historic interest.  See <a href="http://dev.perl.org/perl6/doc/design/syn/S06.html">Synopsis 6</a> for the current design information.</p>

<h4>Defining the Parameters</a></h4>

<p>Meanwhile, back at the <code>&amp;part</code>, we have:</p>

<pre><code>sub part (Code $is_sheep, *@data) {...}</code></pre>

<p>which means that <code>&amp;part</code> expects its first argument to be a
scalar value of type <code>Code</code> (or <code>Code</code> reference). Within
the subroutine that first argument will thereafter be accessed via the name
<code>$is_sheep</code>.</p>

<p>The second parameter (<code>*@data</code>) is what's known as a "slurpy
array". That is, it's an array parameter with the special marker
(<code>*</code>) in front of it, indicating to the compiler that
<code>@data</code> is supposed to grab all the remaining arguments passed to
<code>&amp;part</code> and make each element of <code>@data</code> an alias to
one of those arguments.</p>

<p>In other words, the <code>*@data</code> parameter does just what
<code>@_</code> does in Perl 5: it grabs all the available arguments and makes
its elements aliases for those arguments. The only differences are that in Perl
6 we're allowed to give that slurpy array a sensible name, and we're allowed to
specify other individual parameters before it &mdash; to give separate sensible
names to one or more of the preliminary arguments to the call.</p>

<p>But why (you're probably wondering) do we need an asterisk for that? Surely
if we had defined <code>&amp;part</code> like this:</p>

<pre><code>sub part (Code $is_sheep, @data) {...}   # note: no asterisk on @data</code></pre>

<p>the array in the second parameter slot would have slurped up all the
remaining arguments anyway.</p>

<p>Well, no. Declaring a parameter to be a regular (non-slurpy) array tells the
subroutine to expect the corresponding argument to be a actual array (or an
array reference). So if <code>&amp;part</code> had been defined with its second
parameter just <code>@data</code> (rather than <code>*@data</code>), then we
could call it like this:</p>

<pre><code>part \&amp;selector, @animal_sounds;</code></pre>

<p>or this:</p>

<pre><code>part \&amp;selector, ["woof","meow","ook!"];</code></pre>

<p>but not like this:</p>

<pre><code>part \&amp;selector, "woof", "meow", "ook!";</code></pre>

<p>In each case, the compiler would compare the type of the second argument
with the type required by the second parameter (i.e. an <code>Array</code>). In
the first two cases, the types match and everything is copacetic.  In the third
case, the second argument is a string, not an array or array reference, so we
get a compile-time error message:</p>

<pre><code>Type mismatch in call to &amp;part: @data expects Array but got Str instead</code></pre>

<p>Another way of thinking about the difference between slurpy and regular
parameters is to realize that a slurpy parameter imposes a list (i.e.
flattening) context on the corresponding arguments, whereas a regular,
non-slurpy parameter doesn't flatten or listify.  Instead, it insists on a
single argument of the correct type.</p>

<p>So, if we want <code>&amp;part</code> to handle raw lists as data, we need
to tell the <code>@data</code> parameter to take whatever it finds &mdash;
array or list &mdash; and flatten everything down to a list. That's what the
asterisk on <code>*@data</code> does.</p>

<p>Because of that all-you-can-eat behaviour, slurpy arrays like this are
generally placed at the very end of the parameter list and used to collect data
for the subroutine. The preceding non-slurpy arguments generally tell the
subroutine <em>what to do</em>; the slurpy array generally tells it <em>what to
do it to</em>.</p>

<h4>Splats and Slurps</h4>

<p>Another aspect of Perl 6's distinction between slurpy and non-slurpy
parameters can be seen when we write a subroutine that takes multiple scalar
parameters, then try to pass an array to that subroutine.</p>

<p>For example, suppose we wrote:</p>

<pre><code>sub log($message, $date, $time) {...}</code></pre>

<p>If we happen to have the date and time in a handy array, we might expect
that we could just call <code>log</code> like so:</p>

<pre><code>log("Starting up...", @date_and_time);</code></pre>

<p>We might then be surprised when this fails even to compile.</p>

<p>The problem is that each of <code>&amp;log</code>'s three scalar parameters
imposes a scalar context on the corresponding argument in any call to
<code>log</code>. So <code>"Starting up..."</code> is first evaluated in the
scalar context imposed by the <code>$message</code> parameter and the resulting
string is bound to <code>$message</code>. Then <code>@date_and_time</code> is
evaluated in the scalar context imposed by <code>$date</code>, and the
resulting array reference is bound to <code>$date</code>. Then the compiler
discovers that there is no third argument to bind to the <code>$time</code>
parameter and kills your program.</p>

<p>Of course, it <strong>has</strong> to work that way, or we don't get the
ever-so-useful "array parameter takes an unflattened array argument" behaviour
described earlier. Unfortunately, that otherwise admirable behaviour is
actually getting in the way here and preventing <code>@date_and_time</code>
from flattening as we want.</p>

<p>So Perl 6 also provides a simple way of explicitly flattening an array (or a
hash for that matter): the unary prefix <code>*</code> operator:</p>

<pre><code>log("Starting up...", *@date_and_time);</code></pre>

<p>This operator (known as "splat") simply flattens its argument into a list.
Since it's a unary operator, it does that flattening <strong>before</strong>
the arguments are bound to their respective parameters.</p>

<p>The syntactic similarity of a "slurpy" <code>*</code> in a parameter list,
and a "splatty" <code>*</code> in an argument list is quite deliberate. It
reflects a behavioral similarity: just as a slurpy asterisk implicitly
flattens any argument to which its parameter is bound, so too a splatty
asterisk explicitly flattens any argument to which it is applied.</p>

<h4>I Do Declare</h4>

<p>By the way, take another look at those examples above &mdash; the ones with
the <code>{...}</code> where their subroutine bodies should be. Those dots
aren't just metasyntactic; they're real executable Perl 6 code. A subroutine
definition with a <code>{...}</code> for its body isn't actually a
<em>definition</em> at all. It's a <em>declaration</em>.</p>

<p>In the same way that the Perl 5 declaration:</p>

<pre><code># Perl 5 code...
sub part;</code></pre>

<p>states that there exists a subroutine <code>&amp;part</code>, without
actually saying how it's implemented, so too:</p>

<pre><code># Perl 6 code...
sub part (Code $is_sheep, *@data) {...}</code></pre>

<p>states that there exists a subroutine <code>&amp;part</code> that takes a
<code>Code</code> object and a list of data, without saying how it's
implemented.  In fact, the old <code>sub part;</code> syntax is no longer
allowed; in Perl 6 you have to yada-yada-yada when you're making a
declaration.</p>

<h4>Body Parts</h4>

<p>With the parameter list taking care of getting the right arguments into the
right parameters in the right way, the body of the <code>&amp;part</code>
subroutine is then quite straightforward:</p>

<pre><code>{
    my (@sheep, @goats);
    for @data {
        if $is_sheep($_) { push @sheep, $_ }
        else             { push @goats, $_ }
    }
    return (\@sheep, \@goats);
}</code></pre>

<p>According to the original specification, we need to return references to two
arrays. So we first create those arrays. Then we iterate through each element
of the data (which the <code>for</code> aliases to <code>$_</code>, just as in
Perl 5).  For each element, we take the <code>Code</code> object that was
passed as <code>$is_sheep</code> (let's just call it the <em>selector</em> from
now on) and we call it, passing the current data element. If the selector
returns true, we push the data element onto the array of "sheep", otherwise it
is appended to the list of "goats". Once all the data has been divvied up, we
return references to the two arrays.</p>

<p>Note that, if this were Perl 5, we'd have to unpack the <code>@_</code>
array into a list of lexical variables and then explicitly check that
<code>$is_sheep</code> is a valid <code>Code</code> object. In the Perl 6
version there's no <code>@_</code>, the parameters are already lexicals, and
the type-checking is handled automatically.</p>

<h4>Call of the Wild</h4>

<p>With the explicit parameter list in place, we can use <code>&amp;part</code>
in a variety of ways. If we already have a subroutine that is a suitable
test:</p>

<pre><code>sub is_feline ($animal) {
    return $animal.isa(Cat);
}</code></pre>

<p>then we can just pass that to <code>&amp;part</code>, along with the data to
be partitioned, then grab the two array references that come back:</p>

<pre><code>($cats, $chattels) = part &amp;is_feline, @animals;</code></pre>

<p>This works fine, because the first parameter of <code>&amp;part</code>
expects a <code>Code</code> object, and that's exactly what
<code>&amp;is_feline</code> is. Note that we couldn't just put
<code>is_feline</code> there (i.e. without the ampersand), since that would
indicate a <em>call</em> to <code>&amp;is_feline</code>, rather than a
reference to it.</p>

<p>In Perl 5 we'd have had to write <code>\&amp;is_feline</code> to get a
reference to the subroutine. However, since the <code>$is_sheep</code>
parameter specifies that the first argument must be a scalar (i.e. it imposes a
scalar context on the first argument slot), in Perl 6 we don't have to create a
subroutine reference explicitly. Putting a code object in the scalar context
auto-magically enreferences it (just as an array or hash is automatically
converted to a reference in scalar context). Of course, an explicit
<code>Code</code> reference is perfectly acceptable there too:</p>

<pre><code>($cats, $chattels) = part \&amp;is_feline, @animals;</code></pre>

<p>Alternatively, rather than going to the trouble of declaring a separate
subroutine to sort our sheep from our goats, we might prefer to conjure up a
suitable (anonymous) subroutine on the spot:</p>

<pre><code>($cats, $chattels) = part sub ($animal) { $animal.isa(Animal::Cat) }, @animals;</code></pre>

<h4>In a Bind</h4>

<p>So far we've always captured the two array references returned from the
<code>part</code> call by assigning the result of the call to a list of
scalars. But we might instead prefer to bind them to actual arrays:</p>

<pre><code>(@cats, @chattels) := part sub($animal) { $animal.isa(Animal::Cat) }, @animals;</code></pre>

<p>Using binding (<code>:=</code>) instead of assignment (<code>=</code>)
causes <code>@cats</code> and <code>@chattels</code> to become aliases for the
two anonymous arrays returned by <code>&amp;part</code>.</p>

<p>In fact, this aliasing of the two return values to <code>@cats</code> and
<code>@chattels</code> uses <em>exactly</em> the same mechanism that is used to
alias subroutine parameters to their corresponding arguments. We could almost
think of the lefthand side of the <code>:=</code> as a parameter list (in this
case, consisting of two non-slurpy array parameters), and the righthand side
of the <code>:=</code> as being the corresponding argument list. The only
difference is that the variables on the lefthand side of a <code>:=</code> are
not implicitly treated as constant.</p>

<p>One consequence of the similarities between binding and parameter passing is
that we can put a slurpy array on the left of a binding:</p>

<pre><code>(@Good, $Bad, *@Ugly) := (@Adams, @Vin, @Chico, @OReilly, @Lee, @Luck, @Britt);</code></pre>

<p>The first pseudo-parameter (<code>@Good</code>) on the left expects an
array, so it binds to <code>@Adams</code> from the list on the right.</p>

<p>The second pseudo-parameter (<code>$Bad</code>) expects a scalar. That means
it imposes a scalar context on the second element of the righthand list. So
<code>@Vin</code> evaluates to a reference to the original array and
<code>$Bad</code> becomes an alias for <code>\@Vin</code>.</p>

<p>The final pseudo-parameter (<code>*@Ugly</code>) is slurpy, so it expects
the rest of the lefthand side to be a list it can slurp up. In order to ensure
that, the slurpy asterisk causes the remaining pseudo-arguments on the right to
be flattened into a list, whose elements are then aliased to successive
elements of <code>@Ugly</code>.</p>













<p><em>Editor's note: this document is out of date and remains here for historic interest.  See <a href="http://dev.perl.org/perl6/doc/design/syn/S06.html">Synopsis 6</a> for the current design information.</p>

<h4>Who Shall Sit in Judgment?</h4>

<p>Conjuring up an anonymous subroutine in each call to <code>part</code> is
intrinsically neither good nor bad, but it sure is ugly:</p>

<pre><code>($cats, $chattels) = part sub($animal) { $animal.isa(Animal::Cat) }, @animals;</code></pre>

<p>Fortunately, there's a cleaner way to specify the selector within the call
to <code>part</code>. We can use a <em>parameterized block</em> instead:</p>

<pre><code>($cats, $chattels) = part -&gt; $animal { $animal.isa(Animal::Cat) } @animals;</code></pre>

<p>A parameterized block is just a normal brace-delimited block, except that
you're allowed to put a list of parameters out in front of it, preceded by an
arrow (<code>-&gt;</code>). So the actual parameterized block in the above
example is:</p>

<pre><code>-&gt; $animal { $animal.isa(Animal::Cat) }</code></pre>

<p>In Perl 6, a block is a subspecies of <code>Code</code> object, so it's
perfectly okay to pass a parameterized block as the first argument to
<code>&amp;part</code>. Like a real subroutine, a parameterized block can be
subsequently invoked and passed an argument list. The body of the
<code>&amp;part</code> subroutine will continue to work just fine.</p>

<p>It's important to realize that parameterized blocks <em>aren't</em>
subroutines though. They're blocks, and so there are important differences in
their behaviour. The most important difference is that you can't
<code>return</code> from a parameterized block, the way you can from a
subroutine. For example, this:</p>

<pre><code>part sub($animal) { return $animal.size &lt; $breadbox }, @creatures</code></pre>

<p>works fine, returning the result of each size comparison every time the
anonymous subroutine is called within <code>&amp;part</code>.</p>

<p>But in this "pointier" version:</p>

<pre><code>part -&gt; $animal { return $animal.size &lt; $breadbox } @creatures</code></pre>

<p>the <code>return</code> isn't inside a nested subroutine; it's inside a
block. The first time the parameterized block is executed within
<code>&amp;part</code> it causes the subroutine in which the block was defined
(i.e. the subroutine that's <em>calling</em> <code>part</code>) to return!</p>

<p>Oops.</p>

<p>The problem with that second example, of course, is not that we were too
Lazy to write the full anonymous subroutine. The problem is that we weren't
Lazy enough: we forgot to <em>leave out</em> the <code>return</code>. Just like
a Perl 5 <code>do</code> or <code>eval</code> block, a Perl 6 parameterized
block evaluates to the value of the last statement executed within it. We only
needed to say:</p>

<pre><code>part -&gt; $animal { $animal.size &lt; $breadbox } @creatures</code></pre>

<p>Note too that, because the parameterized block is a block, we don't need to
put a comma after it to separate it from the second argument. In fact,
<em>anywhere</em> a block is used as an argument to a subroutine, any comma
before or after the block is optional.</p>

<h4>Cowabunga!</h4>

<p>Even with the slight abbreviation provided by using a parameterized block
instead of an anonymous subroutine, it's all too easy to lose track of the the
actual data (i.e.  <code>@animals</code>) when it's buried at the end of that
long selector definition.</p>

<p>We can help it stand out a little better by using a new feature of Perl 6:
the "pipeline" operator:</p>

<pre><code>($cats, $chattels) = part sub($animal) { $animal.isa(Animal::Cat) } &lt;== @animals;</code></pre>

<p>The <code>&lt;==</code> operator takes a subroutine <em>call</em> as its
lefthand argument and a list of data as its righthand arguments. The
subroutine being called on the left must have a slurpy array parameter (e.g.
<code>*@data</code>) and the list on the operator's right is then bound to that
parameter.</p>

<p>In other words, a <code>&lt;==</code> in a subroutine call marks the end of
the specific arguments and the start of the slurped data.</p>

<p>Pipelines are more interesting when there are several stages to the process,
as in this Perl 6 version of the Schwartzian transform:</p>

<pre><code>@shortest_first = map  { .key }                     # 4
              &lt;== sort { $^a.value &lt;=&gt; $^b.value }  # 3
              &lt;== map  { $_ =&gt; .height }            # 2
              &lt;== @animals;                         # 1</code></pre>

<p>This example takes the array <code>@animals</code>, flattens it into a list
(#1), pipes that list in as the data for a <code>map</code> operation (#2),
takes the resulting list of object/height pairs and pipes that in to the
<code>sort</code> (#3), then takes the resulting sorted list of pairs and
<code>map</code>s out just the sorted objects (#4).</p>

<p>Of course, since the data lists for all of these functions always come at
the end of the call anyway, we could have just written that as:</p>

<pre><code>@shortest_first = map  { .key }                     # 4
                  sort { $^a.value &lt;=&gt; $^b.value }  # 3
                  map  { $_ =&gt; .height }            # 2
                  @animals;                         # 1</code></pre>

<p>But there's no reason to stint ourselves: the pipelines cost nothing in
performance, and often make the flow of data much clearer.</p>

<p>One problem that many people have with pipelined list processing techniques
like the Schwartzian Transform is that the pipeline flows the "wrong" way: the
code reads left-to-right/top-to-bottom but the data (and execution) runs
right-to-left/bottom-to-top.  Happily, Perl 6 has a solution for that too. It
provides a "reversed" version of the pipeline operator, to make it easy to
create left-to-right pipelines:</p>

<pre><code>@animals ==&gt; map  { $_ =&gt; .height }              # 1
         ==&gt; sort { $^a.value &lt;=&gt; $^b.value }    # 2
         ==&gt; map  { .key }                       # 3
         ==&gt; @shortest_first;                    # 4</code></pre>

<p>This version works exactly the same as the previous
right-to-left/bottom-to-top examples, except that now the various components of
the pipeline are written and performed in the "natural" order.</p>

<p>The <code>==&gt;</code> operator is the mirror-image of <code>&lt;==</code>,
both visually and in its behaviour. That is, it takes a subroutine call as its
righthand argument and a list of data on its left, and binds the lefthand
list to the slurpy array parameter of the subroutine being called on the
right.</p>

<p>Note that this last example makes use of a special dispensation given to
both pipeline operators. The argument on the "sharp" side is supposed to be a
subroutine call. However, if it is a variable, or a list of variables, then the
pipeline operator simply assigns the list from its "blunt" side to variable (or
list) on its "sharp" side.</p>

<p>Hence, if we preferred to partition our animals left-to-right, we could
write:</p>

<pre><code>@animals ==&gt; part sub ($animal) { $animal.isa(Animal::Cat) } ==&gt; ($cats, $chattels);</code></pre>

<h4>The Incredible Shrinking Selector</h4>

<p>Of course, even with a parameterized block instead of an anonymous
subroutine, the definition of the selector argument is still klunky:</p>

<pre><code>($cats, $chattels) = part -&gt; $animal { $animal.isa(Animal::Cat) } @animals;</code></pre>

<p>But it doesn't have to be so intrusive. There's another way to create a
parameterized block. Instead of explicitly enumerating the parameters after a
<code>-&gt;</code>, we could use <em>placeholder variables</em> instead.</p>

<p>As explained in Apocalypse 4, a placeholder variable is one whose sigil is
immediately followed by a caret (<code>^</code>).  Any block containing one or
more placeholder variables is automatically a parameterized block, without the
need for an explicit <code>-&gt;</code> or parameter list. Instead, the block's
parameter list is determined automatically from the set of placeholder
variables enclosed by the block's braces.</p>

<p>We could simplify our partitioning to:</p>

<pre><code>($cats, $chattels) = part { $^animal.isa(Animal::Cat) }
@animals;</code></pre>

<p>Here <code>$^animal</code> is a placeholder, so the block immediately
surrounding it becomes a parameterized block &mdash; in this case with exactly
one parameter.</p>

<p>Better still, any block containing a <code>$_</code> is also a parameterized
block &mdash; with a single parameter named <code>$_</code>. We could dispense
with the explicit placeholder and just write our partitioning statement:</p>

<pre><code>($cats, $chattels) = part { $_.isa(Animal::Cat) }
@animals;</code></pre>

<p>which is really a shorthand for the parameterized block:</p>

<pre><code>($cats, $chattels) = part -&gt; $_ { $_.isa(Animal::Cat) }
@animals;</code></pre>

<p>Come to think of it, since we now have the unary dot operator (which calls a
method using <code>$_</code> as the invocant), we don't even need the explicit
<code>$_</code>:</p>

<pre><code>($cats, $chattels) = part { .isa(Animal::Cat) }
@animals;</code></pre>

<h3>Part: The Second</h3>

<p>But wait, there's even...err...less!</p>

<p>We could very easily extend <code>&amp;part</code> so that we don't even
need the block in that case; so that we could just pass the raw class in as the
first parameter:</p>

<pre><code>($cats, $chattels) = part Animal::Cat, @animals;</code></pre>

<p>To do that, the type of the first parameter will have to become
<code>Class</code>, which is the (meta-)type of all classes.  However, if we
changed <code>&amp;part</code>'s parameter list in that way:</p>

<pre><code>sub part (Class $is_sheep, *@data) {...}</code></pre>

<p>then all our existing code that currently passes <code>Code</code> objects
as <code>&amp;part</code>'s first argument will break.</p>

<p>Somehow we need to be able to pass <em>either</em> a <code>Code</code>
object <em>or</em> a <code>Class</code> as <code>&amp;part</code>'s first
argument. To accomplish that, we need to take a short detour into...</p>













<p><em>Editor's note: this document is out of date and remains here for historic interest.  See <a href="http://dev.perl.org/perl6/doc/design/syn/S06.html">Synopsis 6</a> for the current design information.</p>

<h4>The Wonderful World of Junctions</h4>

<p>Perl 6 introduces an entirely new scalar data-type: the <em>junction</em>. A
junction is a single scalar value that can act like two or more values at once.
So, for example, we can create a value that behaves like any of the values
<code>1</code>, <code>4</code>, or <code>9</code>, by writing:</p>

<pre><code>$monolith = any(1,4,9);</code></pre>

<p>The scalar value returned by <code>any</code> and subsequently stored in
<code>$monolith</code> is equal to <code>1</code>. And at the same time it's
also equal to <code>4</code>. And to <code>9</code>. It's equal to any of them.
Hence the name of the <code>any</code> function that we used to set it up.</p>

<p>What good it that? Well, if it's equal to "any of them" then, with a single
comparison, we can test if some other value is also equal to "any of them":</p>

<pre><code>if $dave == any(1,4,9) { print "I'm sorry, Dave, you're just a
square." }</code></pre>

<p>That's considerably shorter (and more maintainable) than:</p>

<pre><code>if $dave == 1 || $dave == 4 || $dave == 9 { print "I'm sorry, Dave,
you're just a square." }</code></pre>

<p>It even reads more naturally.</p>

<p>Better still, Perl 6 provides an n-ary operator that builds the same kinds
of junctions from its operands:</p>

<pre><code>if $dave == 1|4|9 { print "I'm sorry, Dave, you're just a square."
}</code></pre>

<p>Once you get used to this notation, it too is very easy to follow: <em>if
Dave equals 1 or 4 or 9...</em>.</p>

<p>(Yes, the Perl 5 bitwise OR is still available in Perl 6; it's just spelled
differently now).</p>

<p>The <code>any</code> function is more useful when the values under
consideration are stored in a single array. For example, we could check whether
a new value is bigger than any we've already seen:</p>

<pre><code>if $newval &gt; any(@oldvals) { print "$newval isn't the smallest."
}</code></pre>

<p>In Perl 5 we'd have to write that:</p>

<pre><code>if (grep { $newval &gt; $_ } @oldvals) { print "$newval isn't the
smallest." }</code></pre>

<p>which isn't as clear and isn't as quick (since the <code>any</code> version
will short-circuit as soon as it knows the comparison is true, whereas the
<code>grep</code> version will churn through every element of
<code>@oldvals</code> no matter what).</p>

<p>An <code>any</code> is even more useful when we have a collection of new
values to check against the old ones. We can say:</p>

<pre><code>if any(@newvals) &gt; any(@oldvals) { print "Already seen at least
one smaller value." }</code></pre>

<p>instead of resorting to the horror of nested <code>grep</code>s:</p>

<pre><code>if (grep { my $old = $_; grep { $_ &gt; $old } @newvals } @oldvals)
{ print "Already seen at least one smaller value." }</code></pre>

<p>What if we wanted to check whether <em>all</em> of the new values were
greater than any of the old ones? For that we use a different kind of junction
&mdash; one that is equal to all our values at once (rather than just any one
of them). We can create such a junction with the <code>all</code> function:</p>

<pre><code>if all(@newvals) &gt; any(@oldvals) {
    print "These are all bigger than something already seen."
}</code></pre>

<p>We could also test if all the new values are greater than <em>all</em> the
old ones (not merely greater than at least one of them), with:</p>

<pre><code>if all(@newvals) &gt; all(@oldvals) {
    print "These are all bigger than everything already seen."
}</code></pre>

<p>There's an operator for building <code>all</code> junctions too.  No prizes
for guessing. It's n-ary <code>&amp;</code>. So, if we needed to check that the
maximal dimension of some object is within acceptable limits, we could say:</p>

<pre><code>if $max_dimension &lt; $height &amp; $width &amp; $depth {
    print "A maximal dimension of $max_dimension is okay."
}</code></pre>

<p>That last example is the same as:</p>

<pre><code>if $max_dimension &lt; $height
&amp;&amp; $max_dimension &lt; $width
&amp;&amp; $max_dimension &lt; $depth {
    print "A maximal dimension of $max_dimension is okay."
}</code></pre>

<p><code>any</code> junctions are known as <em>disjunctions</em>, because they
act like they're in a boolean OR: "this OR that OR the other". <code>all</code>
junctions are known as <em>conjunctions</em>, because they have an implicit AND
between their values &mdash; "this AND that AND the other".</p>

<p>There are two other types of junction available in Perl 6:
<em>abjunctions</em> and <em>injunctions</em>. An abjunction is created using
the <code>one</code> function and represents exactly one of its possible values
at any given time:</p>

<pre><code>if one(@roots) == 0 {
    print "Unique root to polynomial.";
}</code></pre>

<p>In other words, it's as though there were an implicit n-ary XOR between each
pair of values.</p>

<p>Injunctions represent none of their values and hence are constructed with a
built-in named <code>none</code>:</p>

<pre><code>if $passwd eq none(@previous_passwds) {
    print "New password is acceptable.";
}</code></pre>

<p>They're like a multi-part NEITHER...NOR...NOR...</p>

<p>We can build a junction out of any scalar type. For example, strings:</p>

<pre><code>my $known_title = 'Mr' | 'Mrs' | 'Ms' | 'Dr' | 'Rev';</code></pre>

<pre><code>if %person&#123;title} ne $known_title {
    print "Unknown title: %person&#123;title}.";
}</code></pre>

<p>or even <code>Code</code> references:</p>

<pre><code>my &amp;ideal := \&amp;tall &amp; \&amp;dark &amp; \&amp;handsome;
</code></pre>

<pre><code>if ideal($date) {   # Same as: if tall($date) &amp;&amp; dark($date) &amp;&amp; handsome($date)
    swoon();
}</code></pre>

<h4>The Best of Both Worlds</h4>

<p>So a disjunction (<code>any</code>) allows us to create a scalar value that
is <em>either</em> this <em>or</em> that.</p>

<p>In Perl 6, classes (or, more specifically, <code>Class</code> objects) are
scalar values. So it follows that we can create a disjunction of classes. For
example:</p>

<pre><code>Floor::Wax | Dessert::Topping</code></pre>

<p>gives us a type that can be <em>either</em> <code>Floor::Wax</code>
<em>or</em> <code>Dessert::Topping</code>.  So a variable declared with that
type:</p>

<pre><code>my Floor::Wax|Dessert::Topping $shimmer;</code></pre>

<p>can store <em>either</em> a <code>Floor::Wax</code> object <em>or</em> a
<code>Dessert::Topping</code> object. A parameter declared with that type:</p>

<pre><code>sub advertise(Floor::Wax|Dessert::Topping $shimmer) {...}</code></pre>

<p>can be passed an argument that is of either type.</p>

<h4>Matcher Smarter, not Harder</h4>

<p>So, in order to extend <code>&amp;part</code> to accept a <code>Class</code>
as its first argument, whilst allowing it to accept a <code>Code</code> object
in that position, we just use a type junction:</p>

<pre><code>sub part (Code|Class $is_sheep, *@data) {
    my (@sheep, @goats);
    for @data {
        when $is_sheep { push @sheep, $_ }
        default        { push @goats, $_ }
    }
    return (\@sheep, \@goats);
}</code></pre>

<p>There are only two differences between this version and the previous one.
The first difference is, of course, that we have changed the type of the first
parameter. Previously it was <code>Code</code>; now it's
<code>Code|Class</code>.</p>

<p>The second change is in the body of the subroutine itself. We replaced the
partitioning <code>if</code> statement:</p>

<pre><code>for @data {
    if $is_sheep($_) { push @sheep, $_ }
    else             { push @goats, $_ }
}</code></pre>

<p>With a switch:</p>

<pre><code>for @data {
    when $is_sheep { push @sheep, $_ }
    default        { push @goats, $_ }
}</code></pre>

<p>Now the actual work of categorizing each element as a "sheep" or a "goat" is
done by the <code>when</code> statement, because:</p>

<pre><code>when $is_sheep { push @sheep, $_ }</code></pre>

<p>Is equivalent to:</p>

<pre><code>if $_ ~~ $is_sheep { push @sheep, $_; next }</code></pre>

<p>When <code>$is_sheep</code> is a subroutine reference, that implicit
smart-match will simply pass <code>$_</code> (the current data element) to the
subroutine and then evaluate the return value as a boolean. On the other hand,
when <code>$is_sheep</code> is a class, the smart-match will check to see if
the object in <code>$_</code> belongs to the same class or some derived
class.</p>

<p>The single <code>when</code> statement handles either type of selector
&mdash; <code>Code</code> or <code>Class</code> &mdash; auto-magically.  That's
why it's known as smart-matching.</p>

<p>Having now allowed class names as selectors, we can take the final step and
simplify:</p>

<pre><code>($cats, $chattels) = part { .isa(Animal::Cat) } @animals;</code></pre>

<p>to:</p>

<pre><code>($cats, $chattels) = part Animal::Cat, @animals;</code></pre>

<p>Note, however, that the comma is back. Only blocks can appear in argument
lists without accompanying commas, and the raw class isn't a block.</p>













<p><em>Editor's note: this document is out of date and remains here for historic interest.  See <a href="http://dev.perl.org/perl6/doc/design/syn/S06.html">Synopsis 6</a> for the current design information.</p>

<h3>Partitioning Rules!</h3>

<p>Now that the <code>when</code>'s implicit smart-match is doing the hard work
of deciding how to evaluate each data element against the selector, adding new
kinds of selectors becomes trivial.  For example, here's a third version of
<code>&amp;part</code> which also allows Perl 6 rules (i.e. patterns) to be
used to partition a list:</p>

<pre><code>sub part (Code|Class|Rule $is_sheep, *@data) {
    my (@sheep, @goats);
    for @data {
        when $is_sheep { push @sheep, $_ }
        default        { push @goats, $_ }
    }
    return (\@sheep, \@goats);</code></pre>

<p>All we needed to do was to tell <code>&amp;part</code> that its first
argument was also allowed to be of type <code>Rule</code>.  That allows us to
call <code>&amp;part</code> like this:</p>

<pre><code>($cats, $chattels) = part /meow/, @animal_sounds;</code></pre>

<p>In the scalar context imposed by the <code>$is_sheep</code> parameter, the
<code>/meow/</code> pattern evaluates to a <code>Rule</code> object (rather
than immediately doing a match).  That <code>Rule</code> object is then bound
to <code>$is_sheep</code> and subsequently used as the selector in the
<code>when</code> statement.</p>

<p>Note that the body of this third version is exactly the same as that of the
previous version. No change is required because, when it detects that
<code>$is_sheep</code> is a <code>Rule</code> object, the <code>when</code>'s
smart-matching will auto-magically do a pattern match.</p>

<p>In the same way, we could further extend <code>&amp;part</code> to allow the
user to pass a hash as the selector:</p>

<pre><code>my %is_cat = (
    cat =&gt; 1, tiger =&gt; 1, lion =&gt; 1, leopard =&gt; 1, # etc.
);

($cats, $chattels) = part %is_cat, @animal_names;</code></pre>

<p>simply by changing the parameter list of <code>&amp;part</code> to:</p>

<pre><code>sub part (Code|Class|Rule|Hash $is_sheep, *@data) {
    # body exactly as before
}</code></pre>

<p>Once again, the smart-match hidden in the <code>when</code> statement just
Does The Right Thing. On detecting a hash being matched against each datum, it
will use the datum as a key, do a hash look up, and evaluate the truth of the
corresponding entry in the hash.</p>

<p>Of course, the ever-increasing disjunction of allowable selector types is
rapidly threatening to overwhelm the entire parameter list. At this point it
would make sense to factor the type-junction out, give it a logical name, and
use that name instead. To do that, we just write:</p>

<pre><code>type Selector ::= Code | Class | Rule | Hash;</code></pre>

<pre><code>sub part (Selector $is_sheep, *@data) {
    # body exactly as before
}</code></pre>

<p>The <code>::=</code> binding operator is just like the <code>:=</code>
binding operator, except that it operates at compile-time. It's the right
choice here because types need to be fully defined at compile-time, so the
compiler can do as much static type checking as possible.</p>

<p>The effect of the binding is to make the name <code>Selector</code> an alias
for <code>Code</code> <code>|</code> <code>Class</code> <code>|</code>
<code>Rule</code> <code>|</code> <code>Hash</code>. Then we can just use
<code>Selector</code> wherever we want that particular disjunctive type.</p>

<h3>Out with the New and in with the Old</h3>

<p>Let's take a step back for a moment.</p>

<p>We've already seen how powerful and clean these new-fangled explicit
parameters can be, but maybe you still prefer the Perl 5 approach. After all,
<code>@_</code> was good enough fer Grandpappy when he lernt hisself Perl as a
boy, dangnabit!</p>

<p>In Perl 6 we can still pass our arguments the old-fashioned way and then
process them manually:</p>

<pre><code># Still valid Perl 6...
sub part {
    # Unpack and verify args...
    my ($is_sheep, @data) = @_;
    croak "First argument to &amp;part is not Code, Hash, Rule, or Class"
        unless $is_sheep.isa(Selector);

    # Then proceed as before...
    my (@sheep, @goats);
    for @data {
        when $is_sheep { push @sheep, $_ }
        default        { push @goats, $_ }
    }
    return (\@sheep, \@goats);
}</code></pre>

<p>If we declare a subroutine without a parameter list, Perl 6 automatically
supplies one for us, consisting of a single slurpy array named
<code>@_</code>:</p>

<pre><code>sub part {...}      # means: sub part (*@_) {...}</code></pre>

<p>That is, any un-parametered Perl 6 subroutine expects to flatten and then
slurp up an arbitrarily long list of arguments, binding them to the elements of
a parameter called <code>@_</code>. That's pretty much what a Perl 5 subroutine
does. The only important difference is that in Perl 6 that slurpy
<code>@_</code> is, like all Perl 6 parameters, constant by default. So, if we
want the <em>exact</em> behaviour of a Perl 5 subroutine &mdash; including
being able to modify elements of <code>@_</code> &mdash; we need to be
explicit:</p>

<pre><code>sub part (*@_ is rw) {...}</code></pre>

<p>Note that "declare a subroutine without a parameter list" <em>doesn't</em>
mean "declare a subroutine with an empty parameter list":</p>

<pre><code>sub part    {...}   # without parameter list
sub part () {...}   # empty parameter list</code></pre>

<p>An empty parameter list specifies that the subroutine takes exactly zero
arguments, whereas a missing parameter list means it takes any number of
arguments and binds them to the implicit parameter <code>@_</code>.</p>

<p>Of course, by using the implicit <code>@_</code> instead of named
parameters, we're merely doing extra work that Perl 6 could do for us, as well
as making the subroutine body more complex, harder to maintain, and slower.
We're also eliminating any chance of Perl 6 identifying argument mismatches at
compile-time. And, unless we're prepared to complexify the code even further,
we're preventing client code from using named arguments (see "Name your poison"
below).</p>

<p>But this is Perl, not Fascism. We're not in the business of imposing the One
True Coding Style on Perl hackers. So if you want to pass your arguments the
old-fashioned way, Perl 6 makes sure you still can.</p>

<h3>A Pair of Lists in a List of Pairs</h3>

<p>Suppose now that, instead of getting a list of array references back, we
wanted to get back a list of <code>key=&gt;value</code> pairs, where each value
was one of the array refs and each key some kind of identifying label (we'll
see why that might be particularly handy soon).</p>

<p>The easiest solution is to use two fixed keys (for example,
"<code>sheep</code>" and "<code>goats</code>"):</p>

<pre><code>sub part (Selector $is_sheep, *@data) returns List of Pair {
    my %herd;
    for @data {
        when $is_sheep { push %herd{"sheep"}, $_ }
        default        { push %herd{"goats"}, $_ }
    }
    return *%herd;
}</code></pre>

<p>The parameter list of the subroutine is unchanged, but now we've added a
return type after it, using the <code>returns</code> keyword. That return type
is <code>List of Pair</code>, which tells the compiler that any
<code>return</code> statements in the subroutine are expected to return a list
of values, each of which is a Perl 6 <code>key=&gt;value</code> pair.</p>

<h4>Parametric Types</h4>

<p>Note that this type is different from those we've seen so far: it's
compound. The <code>of Pair</code> suffix is actually an argument that modifies
the principal type <code>List</code>, telling the container type what kind of
value it's allowed to store. This is possible because <code>List</code> is a
<em>parametric type</em>. That is, it's a type that can be specified with
arguments that modify how it works. The idea is a little like C++ templates,
except not quite so brain-meltingly complicated.</p>

<p>The specific parameters for a parametric type are normally specified in
square brackets, immediately after the class name.  The arguments that define a
particular instance of the class are likewise passed in square brackets. For
example:</p>

<pre><code>class Table[Class $of] {...}
class Logfile[Str $filename] {...}
module SecureOps[AuthKey $key] {...}

# and later:

sub typeset(Table of Contents $toc) {...}
# Expects an object whose class is Table
# and which stores Contents objects

my Logfile["./log"] $file;
# $file can only store logfiles that log to ./log

$plaintext = SecureOps[$KEY]::decode($cryptotext);
# Only use &amp;decode if our $KEY entitles us to</code></pre>

<p>Note that type names like <code>Table of Contents</code> and <code>List of
Pair</code> are really just tidier ways to say
<code>Table[of=&gt;Contents]</code> and <code>List[of=&gt;Pair]</code>.</p>

<p>By convention, when we pass an argument to the <code>$of</code> parameter of
a parametric type, we're telling that type what kind of value we're expecting
it to store. For example: whenever we access an element of <code>List of
Pair</code>, we expect to get back a <code>Pair</code>. Similarly we could
specify <code>List of Int</code>, <code>Array of Str</code>, or <code>Hash of
Num</code>.</p>

<p>Admittedly <code>List of Pair</code> doesn't seem <em>much</em> tidier than
<code>List(of=&gt;Pair)</code>, but as container types get more complex, the
advantages start to become obvious. For example, consider a data structure
consisting of an array of arrays of arrays of hashes of numbers (such as one
might use to store, say, several years worth of daily climatic data). Using the
<code>of</code> notation that's just:</p>

<pre><code>type Climate::Record ::= Array of Array of Array of Hash of Num;</code></pre>

<p>Without the <code>of</code> keyword, it's:</p>

<pre><code>type Climate::Record ::= Array(of=&gt;Array(of=&gt;Array(of=&gt;Hash(of=&gt;Num))));</code></pre>

<p>which is starting to look uncomfortably like Lisp.</p>

<p>Parametric types may have any number of parameters with any names we like,
but only type parameters named <code>$of</code> have special syntactic support
built into Perl.</p>













<p><em>Editor's note: this document is out of date and remains here for historic interest.  See <a href="http://dev.perl.org/perl6/doc/design/syn/S06.html">Synopsis 6</a> for the current design information.</p>

<h4>TMTOWTDeclareI</h4>

<p>While we're talking about type declarations, it's worth noting that we could
also have put <code>&amp;part</code>'s new return type out in front (just as
we've been doing with variable and parameter types). However, this is only
allowed for subroutines when the subroutine is explicitly scoped:</p>

<pre><code># lexical subroutine
my List of Pair sub part (Selector $is_sheep, *@data) {...}</code></pre>

<p>or:</p>

<pre><code># package subroutine
our List of Pair sub part (Selector $is_sheep, *@data) {...}</code></pre>

<p>The return type goes between the scoping keyword (<code>my</code> or
<code>our</code>) and the <code>sub</code> keyword. And, of course, the
<code>returns</code> keyword is not used.</p>

<p>Contrariwise, we can also put variable/parameter type information
<em>after</em> the variable name. To do that, we use the <code>of</code>
keyword:</p>

<pre><code>my sub part ($is_sheep of Selector, *@data) returns List of Pair {...}</code></pre>

<p>This makes sense, when you think about it. As we saw above, <code>of</code>
tells the preceding container what type of value it's supposed to store, so
<code>$is_sheep of Selector</code> tells <code>$is_sheep</code> it's supposed
to store a <code>Selector</code>.</p>

<h4>You Are What You Eat -- Not!</h4>

<p>Careful though: we have to remember to use <code>of</code> there, not
<code>is</code>. It would be a mistake to write:</p>

<pre><code>my sub part ($is_sheep is Selector, *@data) returns List of Pair {...}</code></pre>

<p>That's because Perl 6 variables and parameters can be more precisely typed
than variables in most other languages.  Specifically, Perl 6 allows us to
specify both the <em>storage type</em> of a variable (i.e. what kinds of values
it can contain) and the <em>implementation class</em> of the variable (i.e. how
the variable itself is actually implemented).</p>

<p>The <code>is</code> keyword indicates what a particular container (variable,
parameter, etc.) <em>is</em> &mdash; namely, how it's implemented and how it
operates.  Saying:</p>

<pre><code>sub bark(@dogs is Pack) {...}</code></pre>

<p>specifies that, although the <code>@dogs</code> parameter looks like an
<code>Array</code>, it's actually implemented by the <code>Pack</code> class
instead.</p>

<p>That declaration is <strong>not</strong> specifying that the
<code>@dogs</code> variable <em>stores</em> <code>Pack</code> objects. In fact,
it's not saying anything at all about what <code>@dogs</code> stores. Since its
storage type has been left unspecified, <code>@dogs</code> inherits the default
storage type &mdash; <code>Any</code> &mdash; which allows its elements to
store any kind of scalar value.</p>

<p>If we'd wanted to specify that <code>@dogs</code> was a normal array, but
that it can only store <code>Dog</code> objects, we'd need to write:</p>

<pre><code>sub bark(@dogs of Dog) {...}</code></pre>

<p>and if we'd wanted it to store <code>Dog</code>s but be
implemented by the <code>Pack</code> class, we'd have to write:</p>

<pre><code>sub bark(@dogs is Pack of Dog) {...}</code></pre>

<p>Appending <code>is SomeType</code> to a variable or parameter is the Perl 6
equivalent of Perl 5's <code>tie</code> mechanism, except that the tying is
part of the declaration. For example:</p>

<pre><code>my $Elvis is King of Rock&amp;Roll;</code></pre>

<p>rather than a run-time function call like:</p>

<pre><code># Perl 5 code...
my $Elvis;
tie $Elvis, 'King', stores=&gt;all('Rock','Roll');</code></pre>

<p>In any case, the simple rule for <code>of</code> vs <code>is</code> is:
<em>to say what a variable stores, use <code>of</code>; to say how the variable
itself works, use <code>is</code></em>.</p>

<h4>Many Happy Returns</h4>

<p>Meanwhile, we're still attempting to create a version of
<code>&amp;part</code> that returns a list of pairs. The easiest way to create
and return a suitable list of pairs is to flatten a hash in a list context.
This is precisely what the <code>return</code> statement does:</p>

<pre><code>return *%herd;</code></pre>

<p>using the splatty star. Although, in this case, we could have simply
written:</p>

<pre><code>return %herd;</code></pre>

<p>since the declared return type (<code>List of Pair</code>) automatically
imposes list context (and hence list flattening) on any <code>return</code>
statement within <code>&amp;part</code>.</p>

<p>Of course, it will only make sense to return a flattened hash if we've
already partitioned the original data into that hash. So the bodies of the
<code>when</code> and <code>default</code> statements inside
<code>&amp;part</code> have to be changed accordingly. Now, instead of pushing
each element onto one of two separate arrays, we push each element onto one of
the two arrays stored inside <code>%herd</code>:</p>

<pre><code>for @data {
    when $is_sheep { push %herd{"sheep"}, $_ }
    default        { push %herd{"goats"}, $_ }
}</code></pre>

<h4>It Lives!!!!!</h4>

<p>Assuming that each of the hash entries (<code>%herd{"sheep"}</code> and
<code>%herd{"goats"}</code>) will be storing a reference to one of the two
arrays, we can simply push each data element onto the appropriate array.</p>

<p>In Perl 5 we'd have to dereference each of the array references inside our
hash before we could push a new element onto it:</p>

<pre><code># Perl 5 code...
push @{$herd{"sheep"}}, $_;</code></pre>

<p>But in Perl 6, the first parameter of <code>push</code> expects an array, so
if we give it an array reference, the interpreter can work out that it needs to
dereference that first argument. So we can just write:</p>

<pre><code># Perl 6 code...
push %herd{"sheep"}, $_;</code></pre>

<p>(Remember that, in Perl 6, hashes keep their <code>%</code> sigil, even when
being indexed).</p>

<p>Initially, of course, the entries of <code>%herd</code> don't contain
references to arrays at all; like all uninitialized hash entries, they contain
<code>undef</code>. But, because <code>push</code> itself is defined like
so:</p>

<pre><code>sub push (@array is rw, *@data) {...}</code></pre>

<p>an actual read-writable array is expected as the first argument.  If a
scalar variable containing <code>undef</code> is passed to such a parameter,
Perl 6 detects the fact and autovivifies the necessary array, placing a
reference to it into the previously undefined scalar argument. That behaviour
makes it trivially easy to create subroutines that autovivify read/write
arguments, in the same way that Perl 5's <code>open</code> does.</p>

<p>It's also possible to declare a read/write parameter that <em>doesn't</em>
autovivify in this way: using the <code>is ref</code> trait instead of <code>is
rw</code>:</p>

<pre><code>sub push_only_if_real_array (@array is ref, *@data) {...}</code></pre>

<p><code>is ref</code> still allows the parameter to be read from and written
to, but throws an exception if the corresponding argument isn't already a real
referent of some kind.</p>

<h3>A Label by Any Other Name</h3>

<p>Mandating fixed labels for the two arrays being returned seems a little
inflexible, so we could add another &mdash; optional &mdash; parameter via
which user-selected key names could be passed...</p>

<pre><code>sub part (Selector $is_sheep,
          Str ?@labels is dim(2) = &lt;&lt;sheep goats&gt;&gt;,
          *@data
         ) returns List of Pair
{
    my ($sheep, $goats) is constant = @labels;
    my %herd = ($sheep=>[], $goats=>[]);
    for @data {
        when $is_sheep { push %herd{$sheep}, $_ }
        default        { push %herd{$goats}, $_ }
    }
    return *%herd;
}</code></pre>

<p>Optional parameters in Perl 6 are prefixed with a <code>?</code> marker
(just as slurpy parameters are prefixed with <code>*</code>). Like required
parameters, optional parameters are passed positionally, so the above example
means that the second argument is expected to be an array of strings. This has
important consequences for backwards compatibility &mdash; as we'll see
shortly.</p>

<p>As well as declaring it to be optional (using a leading <code>?</code>), we
also declare the <code>@labels</code> parameter to have exactly two elements,
by specifying the <code>is dim(2)</code> trait. The <code>is dim</code> trait
takes one or more integer values. The number of values it's given specifies the
number of dimensions the array has; the values themselves specify how many
elements long the array is in each dimension. For example, to create a
four-dimensional array of 7x24x60x60 elements, we'd declare it:</p>

<pre><code>my @seconds is dim(7,24,60,60);</code></pre>

<p>In the latest version of <code>&amp;part</code>, the <code>@labels is
dim(2)</code> declaration means that <code>@labels</code> is a normal
one-dimensional array, but that it has only two elements in that one
dimension.</p>

<p>The final component of the declaration of <code>@labels</code> is the
specification of its default value. Any optional parameter may be given a
default value, to which it will be bound if no corresponding argument is
provided. The default value can be any expression that yields a value
compatible with the type of the optional parameter.</p>

<p>In the above version of <code>&amp;part</code>, for the sake of backwards
compatibility we make the optional <code>@labels</code> default to the list of
two strings <code>&lt;&lt;sheep&nbsp;goats&gt;&gt;</code>&nbsp; (using the new
Perl 6 list-of-strings syntax).</p>

<p>Thus if we provide an array of two strings explicitly, the two strings we
provide will be used as keys for the two pairs returned.  If we don't specify
the labels ourselves, <code>"sheep"</code> and <code>"goats"</code> will be
used.</p>

<h4>Name Your Poison</h4>

<p>With the latest version of <code>&amp;part</code> defined to return named
pairs, we can now write:</p>

<pre><code>@parts = part Animal::Cat, &lt;&lt;cat chattel&gt;&gt;, @animals;
#    returns: (cat=&gt;[...], chattel=&gt;[...])
# instead of: (sheep=&gt;[...], goats=&gt;[...])</code></pre>

<p>The first argument (<code>Animal::Cat</code>) is bound to
<code>&amp;part</code>'s <code>$is_sheep</code> parameter (as before). The
second argument (<code>&lt;&lt;cat chattel&gt;&gt;</code>) is now bound to the
optional <code>@labels</code> parameter, leaving the <code>@animals</code>
argument to be flattened into a list and slurped up by the <code>@data</code>
parameter.</p>

<p>We could also pass some or all of the arguments as <em>named arguments</em>.
A named argument is simply a Perl 6 pair, where the key is the name of the
intended parameter, and the value is the actual argument to be bound to that
parameter. That makes sense: every parameter we ever declare has to have a
name, so there's no good reason why we shouldn't be allowed to pass it an
argument using that name to single it out.</p>

<p>An important restriction on named arguments is that they cannot come before
positional arguments, or after any arguments that are bound to a slurpy array.
Otherwise, there would be no efficient, single-pass way of working out which
unnamed arguments belong to which parameters.  Apart from that one overarching
restriction (which Larry likes to think of as a zoning law), we're free to pass
named arguments in any order we like. That's a huge advantage in any subroutine
that takes a large number of parameters, because it means we no longer have to
remember their order, just their names.</p>

<p>For example, using named arguments we could rewrite the above
<code>part</code> call as any of the following:</p>

<pre><code># Use named argument to pass optional @labels argument...
@parts = part Animal::Cat, labels =&gt; &lt;&lt;cat chattel&gt;&gt;, @animals;

# Use named argument to pass both @labels and @data arguments...
@parts = part Animal::Cat, labels =&gt; &lt;&lt;cat chattel&gt;&gt;, data =&gt; @animals;

# The order in which named arguments are passed doesn't matter...
@parts = part Animal::Cat, data =&gt; @animals, labels =&gt; &lt;&lt;cat chattel&gt;&gt;;

# Can pass *all* arguments by name...
@parts = part is_sheep =&gt; Animal::Cat,
                labels =&gt; &lt;&lt;cat chattel&gt;&gt;,
                  data =&gt; @animals;

# And the order still doesn't matter...
@parts = part data =&gt; @animals,
              labels =&gt; &lt;&lt;cat chattel&gt;&gt;,
              is_sheep =&gt; Animal::Cat;

# etc.</code></pre>

<p>As long as we never put a named argument before a positional argument, or
after any unnamed data for the slurpy array, the named arguments can appear in
any convenient order. They can even be pulled out of a flattened hash:</p>

<pre><code>@parts = part *%args;</code></pre>













<p><em>Editor's note: this document is out of date and remains here for historic interest.  See <a href="http://dev.perl.org/perl6/doc/design/syn/S06.html">Synopsis 6</a> for the current design information.</p>

<h4>Who Gets the Last Piece of Cake?</h4>

<p>We're making progress. Whether we pass its arguments by name or
positionally, our call to <code>part</code> produces two partitions of the
original list. Those partitions now come back with convenient labels that we
can specify via the optional <code>@labels</code> parameter.</p>

<p>But now there's a problem. Even though we explicitly marked it as optional,
it turns out that things can go horribly wrong if we don't actually supply that
optional argument. Which is not very "optional".  Worse, it means there's
potentially a problem with every single legacy call to <code>part</code> that
was coded before we added the optional parameter.</p>

<p>For example, consider the call:</p>

<pre><code>@pets = ('Canis latrans', 'Felis sylvestris');

@parts = part /:i felis/, @pets;

# expected to return: (sheep=&gt;['Felis sylvestris'], goats=&gt;['Canis latrans'] )
# actually returns:   ('Canis latrans'=&gt;[], 'Felis sylvestris'=&gt;[])</code></pre>

<p>What went wrong?</p>

<p>Well, when the call to <code>part</code> is matching its argument list
against <code>&amp;call</code>'s parameter list, it works left-to-right as
follows:</p>

<ol>

<li>The first parameter (<code>$is_sheep</code>) is declared as a scalar of
type <code>Selector</code>, so the first argument must be a <code>Code</code>
or a <code>Class</code> or a <code>Hash</code> or a <code>Rule</code>. It's
actually a <code>Rule</code>, so the call mechanism binds that rule to
<code>$is_sheep</code>.</li>

<li>The second parameter (<code>?@labels</code>) is declared as an array of two
strings, so the second argument must be an array of two strings.
<code>@pets</code> is an array of two strings, so we bind that array to
<code>@labels</code>. (Oops!)</li>

<li>The third parameter (<code>*@data</code>) is declared as a slurpy array, so
any remaining arguments should be flattened and bound to successive elements of
<code>@data</code>. There are no remaining arguments, so there's nothing to
flatten-and-bind, so <code>@data</code> remains empty.</li>

</ol>

<p>That's the problem. If we pass the arguments positionally and there are not
enough of them to bind to every parameter, the parameters at the start of the
parameter list are bound before those towards the end. Even if those earlier
parameters are marked optional. In other words, argument binding is "greedy"
and (for obvious efficiency reasons) it never backtracks to see if there might
be better ways to match arguments to parameters. Which means, in this case,
that our data is being preemptively "stolen" by our labels.</p>

<h4>Pipeline to the Rescue!</h4>

<p>So in general (and in the above example in particular) we need some way of
indicating that a positional argument belongs to the slurpy data, not to some
preceding optional parameter. One way to do that is to pass the ambiguous
argument by name:</p>

<pre><code>@parts = part /:i felis/, data=&gt;@pets;</code></pre>

<p>Then there can be no mistake about which argument belongs to what
parameter.</p>

<p>But there's also a purely positional way to tell the call to
<code>part</code> that <code>@pets</code> belongs to the slurpy
<code>@data</code>, not to the optional <code>@labels</code>. We can pipeline
it directly there. After all, that's precisely what the pipeline operator does:
it binds the list on its blunt side to the slurpy array parameter of the call
on its sharp side. So we could just write:</p>

<pre><code>@parts = part /:i felis/ &lt;== @pets;

# returns: (sheep=&gt;['Felis sylvestris'], goats=&gt;['Canis latrans'])</code></pre>

<p>Because <code>@pets</code> now appears on the blunt end of a pipeline,
there's no way it can be interpreted as anything other than the slurped data
for the call to <code>part</code>.</p>

<h4>A Natural Assumption</h4>

<p>Of course, as a solution to the problem of legacy code, this is highly
sub-optimal. It requires that every single pre-existing call to
<code>part</code> be modified (by having a pipeline inserted).  That will
almost certainly be too painful.</p>

<p>Our new optional labels would be much more useful if their existence itself
were also optional &mdash; if we could somehow add a single statement to the
start of any legacy code file and thereby cause <code>&amp;part</code> to work
like it used to in the good old days before labels. In other words, what we
really want is an impostor <code>&amp;part</code> subroutine that pretends that
it only has the original two parameters (<code>$is_sheep</code> and
<code>@data</code>), but then when it's called surreptitiously supplies an
appropriate value for the new <code>@label</code> parameter and quietly calls
the real <code>&amp;part</code>.</p>

<p>In Perl 6, that's easy. All we need is a good curry.</p>

<p>We write the following at the start of the file:</p>

<pre><code>use List::Part;   # Supposing &amp;part is defined in this module

my &amp;part ::= &amp;List::Part::part.assuming(labels =&gt; &lt;&lt;sheep goats&gt;&gt;)</code></pre>

<p>That second line is a little imposing so let's break it down.
First of all:</p>

<pre><code>List::Part::part</code></pre>

<p>is just the fully qualified name of the <code>&amp;part</code> subroutine
that's defined in the <code>List::Part</code> module (which, for the purposes
of this example, is where we're saying <code>&amp;part</code> lives). So:</p>

<pre><code>&amp;List::Part::part</code></pre>

<p>is the actual <code>Code</code> object corresponding to the
<code>&amp;part</code> subroutine. So:</p>

<pre><code>&amp;List::Part::part.assuming(...)</code></pre>

<p>is a method call on that <code>Code</code> object. This is the tricky bit,
but it's no big deal really. If a <code>Code</code> object really is an object,
we certainly ought to be able to call methods on it. So:</p>

<pre><code>&amp;List::Part::part.assuming(labels =&gt; &lt;&lt;sheep goats&gt;&gt;)</code></pre>

<p>calls the <code>assuming</code> method of the <code>Code</code> object
<code>&amp;part</code> and passes the <code>assuming</code> method a named
argument whose name is <code>labels</code> and whose value is the list of
strings <code>&lt;&lt;sheep goats&gt;&gt;</code>.</p>

<p>Now, if we only knew what the <code>.assuming</code> method did...</p>

<h4>That About Wraps it Up</h4>

<p>What the <code>.assuming(...)</code> method does is place an anonymous
wrapper around an existing <code>Code</code> object and then return a reference
to (what appears to be) an entirely separate <code>Code</code> object. That new
<code>Code</code> object works exactly like the original &mdash; except that
the new one is missing one or more of the original's parameters.</p>

<p>Specifically, the parameter list of the wrapper subroutine doesn't have any
of the parameters that were named in in the call to <code>.assuming</code>.
Instead those missing parameters are automatically filled in whenever the new
subroutine is called, using the values of those named arguments to
<code>.assuming</code>.</p>

<p>All of which simply means that the method call:</p>

<pre><code>&amp;List::Part::part.assuming(labels =&gt; &lt;&lt;sheep goats&gt;&gt;)</code></pre>

<p>returns a reference to a new subroutine that acts like this:</p>

<pre><code>sub ($is_sheep, *@data) {
    return part($is_sheep, labels=&gt;&lt;&lt;sheep goats&gt;&gt;, *@data)
}</code></pre>

<p>That is, because we passed a
<code>labels&nbsp;=&gt;&nbsp;&lt;&lt;sheep&nbsp;goats&gt;&gt;</code>&nbsp;
argument to <code>.assuming</code>, we get back a subroutine <em>without</em> a
<code>labels</code> parameter, but which then just calls <code>part</code> and
inserts the value <code>&lt;&lt;sheep&nbsp;goats&gt;&gt;</code>&nbsp; for the
missing parameter.</p>

<p>Or, as the code itself suggests:</p>

<pre><code>&amp;List::Part::part.assuming(labels =&gt; &lt;&lt;sheep goats&gt;&gt;)</code></pre>

<p>gives us what <code>&amp;List::Part::part</code> would become under the
assumption that the value of <code>@labels</code> is always
<code>&lt;&lt;sheep&nbsp;goats&gt;&gt;</code>&nbsp;.</p>

<p>How does that help with our source code backwards compatibility problem? It
completely solves it. All we have to do is to make Perl 6 use that carefully
wrapped, two-parameter version of <code>&amp;part</code> in all our legacy
code, instead of the full three-parameter one. To do that, we merely create a
lexical subroutine of the same name and bind the wrapped version to that
lexical:</p>

<pre><code>my &amp;part ::= &amp;List::Part::part.assuming(labels =&gt; &lt;&lt;sheep goats&gt;&gt;);</code></pre>

<p>The <code>my &amp;part</code> declares a lexical subroutine named
<code>&amp;part</code> (in exactly the same way that a <code>my $part</code>
would declare a lexical variable named <code>$part</code>). The <code>my</code>
keyword says that it's lexical and the sigil says what kind of thing it is
(<code>&amp;</code> for subroutine, in this case). Then we simply install the
wrapped version of <code>&amp;List::Part::part</code> as the implementation of
the new lexical <code>&amp;part</code> and we're done.</p>

<p>Just as lexical variables hide package or global variables of the same name,
so too a lexical subroutine hides any package or global subroutine of the same
name. So <code>my &amp;part</code> hides the imported
<code>&amp;List::Part::part</code>, and every subsequent call to
<code>part(...)</code> in the rest of the current scope calls the lexical
<code>&amp;part</code> instead.</p>

<p>Because that lexical version is bound to a label-assuming wrapper, it
doesn't have a <code>labels</code> parameter, so none of the legacy calls to
<code>&amp;part</code> are broken. Instead, the lexical <code>&amp;part</code>
just silently "fills in" the <code>labels</code> parameter with the value we
originally gave to <code>.assuming</code>.</p>

<p>If we needed to add another partitioning call within the scope of that
lexical <code>&amp;part</code>, but we wanted to use those sexy new non-default
labels, we could do so by calling the actual three-parameter
<code>&amp;part</code> via its fully qualified name, like so:</p>

<pre><code>@parts = List::Part::part(Animal::Cat, &lt;&lt;cat chattel&gt;&gt;, @animals);</code></pre>

<h4>Pair Bonding</h4>

<p>One major advantage of having <code>&amp;part</code> return a list of pairs
rather than a simple list of arrays is that now, instead of positional
binding:</p>

<pre><code># with original (list-of-arrays) version of &amp;part...
(@cats, @chattels) := part Animal::Cat &lt;== @animals;</code></pre>

<p>we can do "named binding"</p>

<pre><code># with latest (list-of-pairs) version of &amp;part...
(goats=&gt;@chattels, sheep=&gt;@cats) := part Animal::Cat &lt;== @animals;</code></pre>

<p>Named binding???</p>

<p>Well, we just learned that we can bind arguments to parameters by name, but
earlier we saw that parameter binding is merely an implicit form of explicit
<code>:=</code> binding. So the inevitable conclusion is that the only reason
we can bind parameters by name is because <code>:=</code> supports named
binding.</p>

<p>And indeed it does. If a <code>:=</code> finds a list of pairs on its
righthand side, and a list of simple variables on its lefthand side, it uses
named binding instead of positional binding.  That is, instead of binding first
to first, second to second, etc., the <code>:=</code> uses the key of each
righthand pair to determine the name of the variable on its left to which the
value of the pair should be bound.</p>

<p>That sounds complicated, but the effect is very easy to understand:</p>

<pre><code># Positional binding...
($who, $why) := ($because, "me");
# same as: $who := $because; $why := "me";

# Named binding...
($who, $why) := (why =&gt; $because, who =&gt; "me");
# same as: $who := "me"; $why := $because;</code></pre>

<p>Even more usefully, if the binding operator detects a list of pairs on its
left and another list of pairs on its right, it binds the value of the first
pair on the right to the value of the identically named pair on the left
(again, regardless of where the two pairs appear in their respective lists).
Then it binds the value of the second pair on the right to the value of the
identically named pair on the left, and so on.</p>

<p>That means we can set up a named <code>:=</code> binding in which the names
of the bound variables don't even have to match the keys of the values being
bound to them:</p>

<pre><code># Explicitly named binding...
(who=&gt;$name, why=&gt;$reason) := (why =&gt; $because, who =&gt; "me");
# same as: $name := "me"; $reason := $because;</code></pre>

<p>The most common use for that feature will probably be to create
"free-standing" aliases for particular entries in a hash:</p>

<pre><code>(who=&gt;$name, why=&gt;$reason) := *%explanation;
# same as: $name := %explanation{who}; $reason := %explanation{why};</code></pre>

<p>or to convert particular hash entries into aliases for other variables:</p>

<pre><code>*%details := (who=&gt;"me", why=&gt;$because);
# same as: %details{who} := "me", %details{why} := $because;</code></pre>













<p><em>Editor's note: this document is out of date and remains here for historic interest.  See <a href="http://dev.perl.org/perl6/doc/design/syn/S06.html">Synopsis 6</a> for the current design information.</p>

<h3>An Argument in Name Only</h3>

<p>It's pretty cool that Perl 6 automatically lets us specify positional
arguments &mdash; and even return values &mdash; by name rather than
position.</p>

<p>But what if we'd prefer that some of our arguments could <em>only</em> be
specified by name. After all, the <code>@labels</code> parameter isn't really
in the same league as the <code>$is_sheep</code> parameter: it's only an option
after all, and one that most people probably won't use. It shouldn't really be
a positional parameter at all.</p>

<p>We <strong>can</strong> specify that the <code>labels</code> argument is
only to be passed by name...by changing the previous declaration of the
<code>@labels</code> parameter very slightly:</p>

<pre><code>sub part (Selector $is_sheep,
          Str +@labels is dim(2) = &lt;&lt;sheep goats&gt;&gt;,
          *@data
         ) returns List of Pair
{
    my ($sheep, $goats) is constant = @labels;
    my %herd = ($sheep=>[], $goats=>[]);
    for @data {
        when $is_sheep { push %herd{$sheep}, $_ }
        default        { push %herd{$goats}, $_ }
    }
    return *%herd;
}</code></pre>

<p>In fact, there's only a single character's worth of difference in the whole
definition. Whereas before we declared the <code>@labels</code> parameter like
this:</p>

<pre><code>Str ?@labels is dim(2) = &lt;&lt;sheep goats&gt;&gt;</code></pre>

<p>now we declare it like this:</p>

<pre><code>Str +@labels is dim(2) = &lt;&lt;sheep goats&gt;&gt;</code></pre>

<p>Changing that <code>?</code> prefix to a <code>+</code> changes
<code>@labels</code> from an optional positional-or-named parameter to an
optional named-only parameter. Now if we want to pass in a <code>labels</code>
argument, we can only pass it by name.  Attempting to pass it positionally will
result in some extreme prejudice from the compiler.</p>

<p>Named-only parameters are still optional parameters however, so legacy code
that omits the labels:</p>

<pre><code>%parts = part Animal::Cat &lt;== @animals;</code></pre>

<p>still works fine (and still causes the <code>@labels</code> parameter to
default to <code>&lt;&lt;sheep goats&gt;&gt;</code>).</p>

<p>Better yet, converting <code>@labels</code> from a positional to a
named-only parameter also solves the problem of legacy code of the form:</p>

<pre><code>%parts = part Animals::Cat, @animals;</code></pre>

<p><code>@animals</code> can't possibly be intended for the
<code>@labels</code> parameter now. We explicitly specified that labels can
only be passed by name, and the <code>@animals</code> argument isn't named.</p>

<p>So named-only parameters give us a clean way of upgrading a subroutine and
still supporting legacy code. Indeed, in many cases the <strong>only</strong>
reasonable way to add a new parameter to an existing, widely used, Perl 6
subroutine will be to add it as a named-only parameter.</p>

<h3>Careful with that Arg, Eugene!</h3>

<p>Of course, there's no free lunch here. The cost of solving the legacy code
problem is that we changed the meaning of any more recent code like this:</p>

<pre><code>%parts = part Animal::Cat, &lt;&lt;cat chattel&gt;&gt;, @animals;     # Oops!</code></pre>

<p>When <code>@labels</code> was positional-or-named, the
<code>&lt;&lt;cat&nbsp;chattel&gt;&gt;</code>&nbsp; argument could only be
interpreted as being intended for <code>@labels</code>. But now, there's no way
it can be for <code>@labels</code> (because it isn't named), so Perl 6 assumes
that the list is just part of the slurped data. The two-element list will now
be flattened (along with <code>@animals</code>), resulting in a single list
that is then bound to the <code>@data</code> parameter, as if we'd written:</p>

<pre><code>%parts = part Animal::Cat &lt;== 'cat', 'chattel', @animals;</code></pre>

<p>This is yet another reason why named-only should probably be the first
choice for optional parameters.</p>

<h4>Temporal Life Insurance</h4>

<p>Being able to add name-only parameters to existing subroutines is an
important way of future-proofing any calls to the subroutine.  So long as we
continue to add only named-only parameters to <code>&amp;part</code>, the order
in which the subroutine expects its positional and slurpy arguments will be
unchanged, so every existing call to <code>part</code> will continue to work
correctly.</p>

<p>Curiously, the reverse is also true. Named-only parameters also provide us
with a way to "history-proof" subroutine <em>calls</em>. That is, we can allow
a subroutine to accept named arguments that it doesn't (yet) know how to
handle! Like so:</p>

<pre><code>sub part (Selector $is_sheep,
          Str +@labels is dim(2) = &lt;&lt;sheep goats&gt;&gt;
          *%extras,         # &lt;-- NEW PARAMETER ADDED HERE
          *@data,
         ) returns List of Pair
{
    # Handle extras...
    carp "Ignoring unknown named parameter '$_'" for keys %extras;

    # Remainder of subroutine as before...
    my ($sheep, $goats) is constant = @labels;
    my %herd = ($sheep=>[], $goats=>[]);
    for @data {
        when $is_sheep { push %herd{$sheep}, $_ }
        default        { push %herd{$goats}, $_ }
    }
    return *%herd;
}

# and later...

%parts = part Animal::Cat, label=&gt;&lt;&lt;Good Bad&gt;&gt;, max=&gt;3, @data;

# warns: "Ignoring unknown parameter 'max' at future.pl, line 19"</code></pre>

<p>The <code>*%extras</code> parameter is a "slurpy hash". Just as the slurpy
array parameter (<code>*@data</code>) sucks up any additional positional
arguments for which there's no explicit parameter, a slurpy hash sucks up any
named arguments that are unaccounted for. In the above example, for instance,
<code>&amp;part</code> has no <code>$max</code> parameter, so passing the named
argument <code>max=&gt;3</code> would normally produce a (compile-time)
exception:</p>

<pre><code>Invalid named parameter ('max') in call to &amp;part</code></pre>

<p>However, because <code>&amp;part</code> now has a slurpy hash, that
extraneous named argument is simply bound to the appropriate entry of
<code>%extras</code> and (in this example) used to generate a warning.</p>

<p>The more common use of such slurpy hashes is to capture the named arguments
that are passed to an object constructor and have them automatically forwarded
to the constructors of the appropriate ancestral classes. We'll explore that
technique in Exegesis 12.</p>

<h3>The Greatest Thing Since Sliced Arrays</h3>

<p>So far we've progressively extended <code>&amp;part</code> from the first
simple version that only accepted subroutines as selectors, to the most recent
versions that can now also use classes, rules, or hashes to partition their
data.</p>

<p>Suppose we also wanted to allow the user to specify a list of integer
indices as the selector, and thereby allow <code>&amp;part</code> to separate a
slice of data from its "anti-slice". In other words, instead of:</p>

<pre><code>%data{2357}  = [ @data[2,3,5,7]            ];
%data{other} = [ @data[0,1,4,6,8..@data-1] ];</code></pre>

<p>we could write:</p>

<pre><code>%data = part [2,3,5,7], labels=&gt;["2357","other"], @data;</code></pre>

<p>We could certainly extend <code>&amp;part</code> to do that:</p>

<pre><code>type Selector ::= Code | Class | Rule | Hash | (Array of Int);

sub part (Selector $is_sheep,
          Str +@labels is dim(2) = &lt;&lt;sheep goats&gt;&gt;,
          *@data
         ) returns List of Pair
{
    my ($sheep, $goats) is constant = @labels;
    my %herd = ($sheep=>[], $goats=>[]);
    if $is_sheep.isa(Array of Int) {
        for @data.kv -&gt; $index, $value {
            if $index == any($is_sheep) { push %herd{$sheep}, $value }
            else                        { push %herd{$goats}, $value }
        }
    }
    else {
        for @data {
            when $is_sheep { push %herd{$sheep}, $_ }
            default        { push %herd{$goats}, $_ }
        }
    }
    return *%herd;
}

# and later, if there's a prize for finishing 1st, 2nd, 3rd, or last...

%prize = part [0, 1, 2, @horses-1],
              labels =&gt; &lt;&lt; placed  also_ran &gt;&gt;,
              @horses;</code></pre>

<p>Note that this is the first time we couldn't just add another class to the
<code>Selector</code> type and rely on the smart-match inside the
<code>when</code> to work out how to tell "sheep" from "goats". The problem
here is that when the selector is an array of integers, the <em>value</em> of
each data element no longer determines its sheepishness/goatility. It's now the
element's <em>position</em> (i.e. its index) that decides its fate.  Since our
existing smart-match compares values, not positions, the <code>when</code>
can't pick out the right elements for us.  Instead, we have to consider both
the index <em>and</em> the value of each data element.</p>

<p>To do that we use the <code>@data</code> array's <code>.kv</code> method.
Just as calling the <code>.kv</code> method on a hash returns <em>key</em>,
<em>value</em>, <em>key</em>, <em>value</em>, <em>key</em>, <em>value</em>,
etc., so too calling the <code>.kv</code> method on an array returns
<em>index</em>, <em>value</em>, <em>index</em>, <em>value</em>, <em>index</em>,
<em>value</em>, etc. Then we just use a parameterized block as our
<code>for</code> block, specifying that it has two arguments. That causes the
<code>for</code> to grab two elements of the list its iterating (i.e. one index
and one value) on each iteration.</p>

<p>Then we simply test to see if the current index is any of those specified in
<code>$is_sheep</code>'s array and, if so, we push the corresponding value:</p>

<pre><code>for @data.kv -&gt; $index, $value {
    if $index == any(@$is_sheep) { push %herd{$sheep}, $value }
    else                         { push %herd{$goats}, $value }
}</code></pre>













<p><em>Editor's note: this document is out of date and remains here for historic interest.  See <a href="http://dev.perl.org/perl6/doc/design/syn/S06.html">Synopsis 6</a> for the current design information.</p>

<h3>A Parting of the ... err ... Parts</h3>

<p>That works okay, but it's not perfect. In fact, as it's presented above the
<code>&amp;part</code> subroutine is now both an ugly solution and an
inefficient one.</p>

<p>It's ugly because <code>&amp;part</code> is now twice as long as it was
before. The two branches of control-flow within it are similar in form but
quite different in function. One partitions the data according to the
<em>contents</em> of a datum; the other, according to a datum's
<em>position</em> in <code>@data</code>.</p>

<p>It's inefficient because it effectively tests the type of the selector
argument twice: once (implicitly) when it's first bound to the
<code>$is_sheep</code> parameter, and then again (explicitly) in the call to
<code>.isa</code>.</p>

<p>It would be cleaner and more maintainable to break these two nearly
unrelated behaviours out into separate subroutines. And it would be more
efficient if we could select between those two subroutines by testing the type
of the selector only once.</p>

<p>Of course, in Perl 6 we can do just that &mdash; with a
<em>multisub</em>.</p>

<p>What's a multisub? It's a collection of related subroutines (known as
"variants"), all of which have the same name but different parameter lists.
When the multisub is called and passed a list of arguments, Perl 6 examines the
types of the arguments, finds the variant with the same name and the most
compatible parameter list, and calls that variant.</p>

<p>By the way, you might be more familiar with the term <em>multimethod</em>. A
multisub is a multiply dispatched subroutine, in the same way that a
multimethod is a multiply dispatched method. There'll be much more about those
in Exegesis 12.</p>

<p>Multisubs provide facilities something akin to function overloading in C++.
We set up several subroutines with the same logical name (because they
implement the same logical action). But each takes a distinct set of argument
types and does the appropriate things with those particular arguments.</p>

<p>However, multisubs are more "intelligent" that mere overloaded subroutines.
With overloaded subroutines, the compiler examines the compile-time types of
the subroutine's arguments and hard codes a call to the appropriate variant
based on that information. With multisubs, the compiler takes no part in the
variant selection process. Instead, the interpreter decides which variant to
invoke at the time the call is actually made. It does that by examining the
<em>run-time</em> type of each argument, making use of its inheritance
relationships to resolve any ambiguities.</p>

<p>To see why a run-time decision is better, consider the following code:</p>

<pre><code>class Lion is Cat {...}    # Lion inherits from Cat

multi sub feed(Cat  $c) { pat $c; my $glop = open 'Can'; spoon_out($glop); }
multi sub feed(Lion $l) { $l.stalk($prey) and kill; }

my Cat $fluffy = Lion.new;

feed($fluffy);</code></pre>

<p>In Perl 6, the call to <code>feed</code> will correctly invoke the second
variant because the interpreter knows that <code>$fluffy</code> actually
contains a reference to a <code>Lion</code> object at the time the call is made
(even though the nominal type of the variable is <code>Cat</code>).</p>

<p>If Perl 6 multisubs worked like C++'s function overloading, the call to
<code>feed($fluffy)</code> would invoke the <em>first</em> version of
<code>feed</code>, because all that the compiler knows for sure at compile-time
is that <code>$fluffy</code> is declared to store <code>Cat</code> objects.
That's precisely why Perl 6 doesn't do it that way. We prefer leave the
hand-feeding of lions to other languages.</p>

<h4>Many Parts</h4>

<p>As the above example shows, in Perl 6, multisub variants are defined by
prepending the <code>sub</code> keyword with another keyword:
<code>multi</code>. The parameters that the interpreter is going to consider
when deciding which variant to call are specified to the left of a colon
(<code>:</code>), with any other parameters specified to the right. If there is
no colon in the parameter list (as above), <em>all</em> the parameters are
considered when deciding which variant to invoke.</p>

<p>We could re-factor the most recent version of <code>&amp;part</code> like
so:</p>

<pre><code>type Selector ::= Code | Class | Rule | Hash;

multi sub part (Selector $is_sheep:
                Str +@labels is dim(2) = &lt;&lt;sheep goats&gt;&gt;,
                *@data
               ) returns List of Pair
{
    my ($sheep, $goats) is constant = @labels;
    my %herd = ($sheep=>[], $goats=>[]);
    for @data {
        when $is_sheep { push %herd{$sheep}, $_ }
        default        { push %herd{$goats}, $_ }
    }
    return *%herd;
}

multi sub part (Int @sheep_indices:
                Str +@labels is dim(2) = &lt;&lt;sheep goats&gt;&gt;,
                *@data
               ) returns List of Pair
{
    my ($sheep, $goats) is constant = @labels;
    my %herd = ($sheep=>[], $goats=>[]);
    for @data -&gt; $index, $value {
        if $index == any(@sheep_indices) { push %herd{$sheep}, $value }
        else                             { push %herd{$goats}, $value }
    }
    return *%herd;
}</code></pre>

<p>Here we create two variants of a single multisub named
<code>&amp;part</code>. The first variant will be invoked whenever
<code>&amp;part</code> is called with a <code>Selector</code> object as its
first argument (that is, when it is passed a <code>Code</code> or
<code>Class</code> or <code>Rule</code> or <code>Hash</code> object as its
selector).</p>

<p>The second variant will be invoked only if the first argument is an
<code>Array of Int</code>. If the first argument is anything else, an exception
will be thrown.</p>

<p>Notice how similar the body of the first variant is to the earlier
subroutine versions. Likewise, the body of the second variant is almost
identical to the <code>if</code> branch of the previous (subroutine)
version.</p>

<p>Notice too how the body of each variant only has to deal with the particular
type of selector that its first parameter specifies. That's because the
interpreter has already determined what type of thing the first argument was
when deciding which variant to call. A particular variant will only ever be
called if the first argument is compatible with that variant's first
parameter.</p>

<h3>Call Me Early</h3>

<p>Suppose we wanted more control over the default labels that
<code>&amp;part</code> uses for its return values. For example, suppose we
wanted to be able to prompt the user for the appropriate defaults &mdash;
before the program runs.</p>

<p>The default value for an optional parameter can be any valid Perl expression
whose result is compatible with the type of the parameter.  We could simply
write:</p>

<pre><code>my Str @def_labels;

BEGIN {
    print "Enter 2 default labels: ";
    @def_labels = split(/\s+/, &lt;&gt;, 3).[0..1];
}

sub part (Selector $is_sheep,
          Str +@labels is dim(2) = @def_labels,
          *@data
         ) returns List of Pair
{
    # body as before
}</code></pre>

<p>We first define an array variable:</p>

<pre><code>my Str @def_labels;</code></pre>

<p>This will ultimately serve as the expression that the <code>@labels</code>
parameter uses as its default:</p>

<pre><code>Str +@labels is dim(2) = @def_labels</code></pre>

<p>Then we merely need a <code>BEGIN</code> block (so that it runs before the
program starts) in which we prompt for the required information:</p>

<pre><code>print "Enter 2 default labels: ";</code></pre>

<p>read it in:</p>

<pre><code>&lt;&gt;</code></pre>

<p>split the input line into three pieces using whitespace as a separator:</p>

<pre><code>split(/\s+/, &lt;&gt;, 3)</code></pre>

<p>grab the first two of those pieces:</p>

<pre><code>split(/\s+/, &lt;&gt;, 3).[0..1]</code></pre>

<p>and assign them to <code>@def_labels</code>:</p>

<pre><code>@def_labels = split(/\s+/, &lt;&gt;, 3).[0..1];</code></pre>

<p>We're now guaranteed that <code>@def_labels</code> has the necessary default
labels before <code>&amp;part</code> is ever called.</p>

<h4>Core Breach</h4>

<p>Built-ins like <code>&amp;split</code> can also be given named arguments in
Perl 6, so, alternatively, we could write the <code>BEGIN</code> block like
so:</p>

<pre><code>BEGIN {
    print "Enter 2 default labels: ";
    @def_labels = split(str=&gt;&lt;&gt;, max=&gt;3).[0..1];
}</code></pre>

<p>Here we're leaving out the split pattern entirely and making use of
<code>&amp;split</code>'s default split-on-whitespace behaviour.</p>

<p>Incidentally, an important goal of Perl 6 is to make the language powerful
enough to natively implement all its own built-ins. We won't actually implement
it that way, since screamingly fast performance is another goal, but we do want
to make it easy for anyone to create their own versions of any Perl built-in or
control structure.</p>

<p>So, for example, <code>&amp;split</code> would be declared like this:</p>

<pre><code>sub split( Rule|Str ?$sep = /\s+/,
           Str ?$str = $CALLER::_,
           Int ?$max = Inf
          )
{
    # implementation here
}</code></pre>

<p>Note first that every one of <code>&amp;split</code>'s parameters is
optional, and that the defaults are the same as in Perl 5. If we omit the
separator pattern, the default separator is whitespace; if we omit the string
to be split, <code>&amp;split</code> splits the caller's <code>$_</code>
variable; if we omit the "maximum number of pieces to return" argument, there
is no upper limit on the number of splits that may be made.</p>

<p>Note that we can't just declare the second parameter like so:</p>

<pre><code>Str ?$str = $_,</code></pre>

<p>That's because, in Perl 6, the <code>$_</code> variable is lexical (not
global), so a subroutine doesn't have direct access to the <code>$_</code> of
its caller. That means that Perl 6 needs a special way to access a caller's
<code>$_</code>.</p>

<p>That special way is via the <code>CALLER::</code> namespace.  Writing
<code>$CALLER::_</code> gives us access to the <code>$_</code> of whatever
scope called the current subroutine.  This works for other variables too
(<code>$CALLER::foo</code>, <code>@CALLER::bar</code>, etc.) but is rarely
useful, since we're only allowed to use <code>CALLER::</code> to access
variables that already exist, and <code>$_</code> is about the only variable
that a subroutine can rely upon to be present in any scope it might be called
from.</p>













<p><em>Editor's note: this document is out of date and remains here for historic interest.  See <a href="http://dev.perl.org/perl6/doc/design/syn/S06.html">Synopsis 6</a> for the current design information.</p>

<h4>A Constant Source of Joy</h4>

<p>Setting up the <code>@def_labels</code> array at compile-time and then using
it as the default for the <code>@labels</code> parameter works fine, but
there's always the chance that the array might somehow be accidentally
reassigned later. If that's not desirable, then we need to make the array a
constant. In Perl 6 that looks like this:</p>

<pre><code>my @def_labels is constant = BEGIN {
    print "Enter 2 default labels: ";
    split(/\s+/, &lt;&gt;, 3).[0..1];
};</code></pre>

<p>The <code>is constant</code> trait is the way we prevent any Perl 6 variable
from being reassigned after it's been declared. It effectively replaces the
<code>STORE</code> method of the variable's implementation with one that throws
an exception whenever it's called. It also instructs the compiler to keep an
eye out for compile-time-detectable modifications to the variable and die
violently if it finds any.</p>

<p>Whenever a variable is declared <code>is constant</code> it must be
initialized as part of its declaration. In this case we use the return value of
a <code>BEGIN</code> block as the initializer value.</p>

<p>Oh, by the way, <code>BEGIN</code> blocks have return values in Perl 6.
Specifically, they return the value of the last statement executed inside them
(just like a Perl 5 <code>do</code> or <code>eval</code> block does, except
that <code>BEGIN</code>s do it at compile-time).</p>

<p>In the above example the result of the <code>BEGIN</code> is the return
value of the call to <code>split</code>. So <code>@def_labels</code> is
initialized to the two default labels, which cannot thereafter be changed.</p>

<h4><code>BEGIN</code> at the Scene of the Crime</h4>

<p>Of course, the <code>@def_labels</code> array is really just a temporary
storage facility for transferring the results of the <code>BEGIN</code> block
to the default value of the <code>@labels</code> parameter.</p>

<p>We could easily do away with it entirely, by simply putting the
<code>BEGIN</code> block right there <em>in</em> the parameter list:</p>

<pre><code>sub part (Selector $is_sheep,
          Str +@labels is dim(2) = BEGIN {
                      print "Enter 2 default labels: "; 
                      split(/\s+/, &lt;&gt;, 3).[0..1];
                    },
          *@data
         ) returns List of Pair
{
    # body as before
}</code></pre>

<p>And that works fine.</p>

<h3>Macro Biology</h3>

<p>The only problem is that it's ugly, brutish, and not at all short. If only
there were some way of calling the <code>BEGIN</code> block at that point
without having to put the actual <code>BEGIN</code> block at that point....</p>

<p>Well, of course there is such a way. In Perl 6 a block is just a special
kind of nameless subroutine... and a subroutine is just a special name-ful kind
of block. So it shouldn't really come as a surprise that <code>BEGIN</code>
blocks have a name-ful, subroutine-ish counterpart. They're called
<em>macros</em> and they look and act very much like ordinary subroutine,
except that they run at compile-time.</p>

<p>So, for example, we could create a compile-time subroutine that requests and
returns our user-specified labels:</p>

<pre><code>macro request(int $n, Str $what) returns List of Str {
    print "Enter $n $what: ";
    my @def_labels = split(/\s+/, &lt;&gt;, $n+1);
    return { @def_labels[0..$n-1] };
}

# and later...

sub part (Selector $is_sheep,
          Str +@labels is dim(2) = request(2,"default labels"),
          *@data
         ) returns List of Pair
{
    # body as before
}</code></pre>

<p>Calls to a macro are invoked during compilation (not at run-time). In fact,
like a <code>BEGIN</code> block, a macro call is executed as soon as the parser
has finished parsing it. So, in the above example, when the parser has parsed
the declaration of the <code>@labels</code> parameter and then the
<code>=</code> sign indicating a default value, it comes across what looks like
a subroutine call. As soon as it has parsed that subroutine call (including its
argument list) it will detect that the subroutine <code>&amp;request</code> is
actually a macro, so it will immediately call <code>&amp;request</code> with
the specified arguments (<code>2</code> and <code>"default labels"</code>).</p>

<p>Whenever a macro like <code>&amp;request</code> is invoked, the parser
itself intercepts the macro's return value and integrates it somehow back into
the parse tree it is in the middle of building.  If the macro returns a block
&mdash; as <code>&amp;request</code> does in the above example &mdash; the
parser extracts the the contents of that block and inserts the parse tree of
those contents into the program's parse tree. In other words, if a macro
returns a block, a precompiled version of whatever is inside the block replaces
the original macro call.</p>

<p>Alternatively, a macro can return a string. In that case, the parser inserts
that string back into the source code in place of the macro call and then
reparses it. This means we could also write <code>&amp;request</code> like
this:</p>

<pre><code>macro request(int $n, Str $what) returns List of Str {
    print "Enter $n $what: ";
    return "&lt;&lt; ( @(split(/\s+/, &lt;&gt;, $n+1).[0..$n-1]) &gt;&gt;";
}</code></pre>

<p>in which case it would return a string containing the characters
<code>"&lt;&lt;"</code>, followed by the two labels that the
<code>request</code> call reads in, followed by a closing double angles. The
parser would then substitute that string in place of the macro call, discover
it was a <code>&lt;&lt;...&gt;&gt;</code> word list, and use that list as the
default labels.</p>

<h4>Macros for <code>BEGIN</code>-ners</h4>

<p>Macros are enormously powerful. In fact, in Perl 6, we could implement the
functionality of <code>BEGIN</code> itself using a macro:</p>

<pre><code>macro MY_BEGIN (&amp;block) {
    my $context = want;
    if $context ~~ List {
        my @values = block();
        return { *@values };
    }
    elsif $context ~~ Scalar {
        my $value = block();
        return { $value };
    }
    else {
        block();
        return;
    }
}</code></pre>

<p>The <code>MY_BEGIN</code> macro declares a single parameter
(<code>&amp;block</code>). Because that parameter is specified with the
<code>Code</code> sigil (<code>&amp;</code>), the macro requires that the
corresponding argument must be a block or subroutine of some type. Within the
body of <code>&amp;MY_BEGIN</code> that argument is bound to the
<em>lexical</em> subroutine <code>&amp;block</code> (just as a
<code>$foo</code> parameter would bind its corresponding argument to a lexical
scalar variable, or a <code>@foo</code> parameter would bind its argument to a
lexical array).</p>

<p><code>&amp;MY_BEGIN</code> then calls the <code>want</code> function, which
is Perl 6's replacement for <code>wantarray</code>.  <code>want</code> returns
a scalar value that simultaneously represents any the contexts in which the
current subroutine was called. In other words, it returns a disjunction of
various classes. We then compare that context information against the three
possibilities &mdash; <code>List</code>, <code>Scalar</code>, and (by
elimination) <code>Void</code>.</p>

<p>If <code>MY_BEGIN</code> was called in a list context, we evaluate its
block/closure argument in a list context, capture the results in an array
(<code>@values</code>), and then return a block containing the contents of that
array flattened back to a list. In a scalar context we do much the same thing,
except that <code>MY_BEGIN</code>'s argument is evaluated in scalar context and
a block containing that scalar result is returned. In a void context (the only
remaining possibility), the argument is simply evaluated and nothing is
returned.</p>

<p>In the first two cases, returning a block causes the original macro call to
be replaced by a parse tree, specifically, the parse tree representing the
values that resulted from executing the original block passed to
<code>MY_BEGIN</code>.</p>

<p>In the final case &mdash; a void context &mdash; the compiler isn't
expecting to replace the macro call with anything, so it doesn't matter what we
return, just as long as we evaluate the block. The macro call itself is simply
eliminated from the final parse-tree.</p>

<p>Note that <code>MY_BEGIN</code> could be written more concisely than it was
above, by taking advantage of the smart-matching behaviour of a switch
statement:</p>

<pre><code>macro MY_BEGIN (&amp;block) {
    given want {
        when List   { my @values = block(); return { *@values }; }
        when Scalar { my $value  = block(); return {  $value  }; }
        when Void   {              block(); return               }
    }
}</code></pre>

<h4>A Macro by Any Other Syntax ...</h4>

<p>Because macros are called by the parser, it's possible to have them interact
with the parser itself. In particular, it's possible for a macro to tell the
parser how the macro's own argument list should be parsed.</p>

<p>For example, we could give the <code>&amp;request</code> macro its own
non-standard argument syntax, so that instead of calling it as:</p>

<pre><code>request(2,"default labels")</code></pre>

<p>we could just write:</p>

<pre><code>request(2 default labels)</code></pre>

<p>To do that we'd define <code>&amp;request</code> like so:</p>

<pre><code>macro request(int $n, Str $what) 
    is parsed( /:w \( (\d+) (.*?) \) / )
    returns List of Str
{
    print "Enter $n $what: ";
    my @def_labels = split(/\s+/, &lt;&gt;, $n+1);
    return { @def_labels[0..$n-1] };
}</code></pre>

<p>The <code>is parsed</code> trait tells the parser what to look for
immediately after it encounters the macro's name. In the above example, the
parser is told that, after encountering the sequence <code>"request"</code> it
should expect to match the pattern:</p>

<pre><code>/ :w        # Allow whitespace between the tokens
  \(        # Match an opening paren
  (\d+)     # Capture one-or-more digits
  (.*?)     # Capture everything else up to...
  \)        # ...a closing paren
/</code></pre>

<p>Note that the one-or-more-digits and the anything-up-to-paren bits of the
pattern are in capturing parentheses. This is important because the list of
substrings that an <code>is parsed</code> pattern captures is then used as the
argument list to the macro call. The captured digits become the first argument
(which is then bound to the <code>$n</code> parameter) and the captured
"everything else" becomes the second argument (and is bound to
<code>$what</code>).</p>

<p>Normally, of course, we don't need to specify the <code>is parsed</code>
trait when setting up a macro. Since a macro is a kind of subroutine, by
default its argument list is parsed the same as any other subroutine's &mdash;
as a comma-separated list of Perl 6 expressions.</p>













<p><em>Editor's note: this document is out of date and remains here for historic interest.  See <a href="http://dev.perl.org/perl6/doc/design/syn/S06.html">Synopsis 6</a> for the current design information.</p>

<h3>Refactoring Parameter Lists</h3>

<p>By this stage, you might be justified in feeling that
<code>&amp;part</code>'s parameter list is getting just a leeeeettle too
sophisticated for its own good. Moreover, if we were using the multisub
version, that complexity would have to be repeated in every variant.</p>

<p>Philosophically though, that's okay. The later versions of
<code>&amp;part</code> are doing some fairly sophisticated things, and the
complexity required to achieve that has to go somewhere.  Putting that extra
complexity in the parameter list means that the body of <code>&amp;part</code>
stays much simpler, as do any calls to <code>&amp;part</code>.</p>

<p>That's the whole point: <em>Complexify locally to simplify globally.</em> Or
maybe: <em>Complexify declaratively to simplify procedurally.</em></p>

<p>But there's precious little room for the consolations of philosophy when
you're swamped in code and up to your assembler in allomorphism. So, rather
than having to maintain those complex and repetitive parameter lists, we might
prefer to factor out the common infrastructure. With, of course, yet another
macro:</p>

<pre><code>macro PART_PARAMS {
	my ($sheep,$goats) = request(2 default labels);
	return "Str +\@labels is dim(2) = &lt;&lt;$sheep $goats&gt;&gt;, *\@data";
}

multi sub part (Selector $is_sheep, PART_PARAMS) {
    # body as before
}

multi sub part (Int @is_sheep, PART_PARAMS) {
    # body as before
}</code></pre>

<p>Here we create a macro named <code>&amp;PART_PARAMS</code> that requests and
extracts the default labels and then interpolates them into a string, which it
returns. That string then replaces the original macro call.</p>

<p>Note that we reused the <code>&amp;request</code> macro within the
<code>&amp;PART_PARAMS</code> macro. That's important, because it means that,
as the body of <code>&amp;PART_PARAMS</code> is itself being parsed, the
default names are requested and interpolated into
<code>&amp;PART_PARAMS</code>'s code. That ensures that the user-supplied
default labels are hardwired into <code>&amp;PART_PARAMS</code> even before
it's compiled. So every subsequent call to <code>PART_PARAMS</code> will return
the same default labels.</p>

<p>On the other hand, if we'd written <code>&amp;PART_PARAMS</code> like
this:</p>

<pre><code>macro PART_PARAMS {
	print "Enter 2 default labels: ";
	my ($sheep,$goats) = split(/\s+/, &lt;&gt;, 3);
	return "*\@data, Str +\@labels is dim(2) = &lt;&lt;$sheep $goats&gt;&gt;";
}</code></pre>

<p>then each time we used the <code>&amp;PART_PARAMS</code> macro in our code,
it would re-prompt for the labels. So we could give each variant of
<code>&amp;part</code> its own default labels.  Either approach is fine,
depending on the effect we want to achieve. It's really just a question how
much work we're willing to put in in order to be Lazy.</p>

<h3>Smooth Operators</h3>

<p>By now it's entirely possible that your head is spinning with the sheer
number of ways Perl 6 lets us implement the <code>&amp;part</code> subroutine.
Each of those ways represents a different tradeoff in power, flexibility, and
maintainability of the resulting code. It's important to remember that, however
we choose to implement <code>&amp;part</code>, it's always invoked in basically
the same way:</p>

<pre><code>%parts = part $selector, @data;</code></pre>

<p>Sure, some of the above techniques let us modify the return labels, or
control the use of named vs positional arguments. But with all of them, the
call itself starts with the name of the subroutine, after which we specify the
arguments.</p>

<p>Let's change that too!</p>

<p>Suppose we preferred to have a partitioning <em>operator</em>, rather than a
subroutine. If we ignore those optional labels, and restrict our list to be an
actual array, we can see that the core partitioning operation is binary ("apply
this selector to that array").</p>

<p>If <code>&amp;part</code> is to become an operator, we need it to be a
binary operator. In Perl 6 we can make up completely new operators, so let's
take our partitioning inspiration from Moses and call our new operator:
<code>~|_|~</code></p>

<p>We'll assume that this "Red Sea" operator is to be used like this:</p>

<pre><code>%parts = @animals ~|_|~ Animal::Cat;</code></pre>

<p>The left operand is the array to be partitioned and the right operand is the
selector. To implement it, we'd write;</p>

<pre><code>multi sub infix:~|_|~ (@data, Selector $is_sheep)
    is looser(&amp;infix:+)
    is assoc('non')
{
    return part $is_sheep, @data;
}</code></pre>

<p>Operators are often overloaded with multiple variants (as we'll soon see),
so we typically implement them as multisubs. However, it's also perfectly
possible to implement them as regular subroutines, or even as macros.</p>

<p>To distinguish a binary operator from a regular multisub, we give it a
special compound name, composed of the keyword <code>infix:</code> followed by
the characters that make up the operator's symbol. These characters can be any
sequence of non-whitespace Unicode characters (except left parenthesis, which
can only appear if it's the first character of the symbol).  So instead of
<code>~|_|~</code> we could equally well have named our partitioning operator
any of:</p>

<pre><code>infix:&yen;
infix:&brvbar;
infix:^%#$!
infix:&lt;-&gt;
infix:&nabla;</code></pre>

<p>The <code>infix:</code> keyword tells the compiler that the operator is
placed between its operands (as binary operators always are). If we're
declaring a unary operator, there are three other keywords that can be used
instead: <code>prefix:</code>, <code>postfix:</code>, or
<code>circumfix:</code>. For example:</p>

<pre><code>sub prefix:&plusmn;       (Num $n) is equiv(&amp;infix:+)    { return +$n|-$n }

sub postfix:&sup2;      (Num $n) is tighter(&amp;infix:**) { return $n**2 }

sub circumfix:&lfloor;...&rfloor; (Num $n) { return POSIX::floor($n) }

# and later...

$error = &plusmn;&lfloor;$x&sup2;&rfloor;;</code></pre>

<p>The <code>is tighter</code>, <code>is looser</code>, and <code>is
equiv</code> traits tell the parser what the precedence of the new operator
will be, relative to existing operators: namely, whether the operator binds
more tightly than, less tightly than, or with the same precedence as the
operator named in the trait. Every operator has to have a precedence and
associativity, so every operator definition has to include one of these three
traits.</p>

<p>The <code>is assoc</code> trait is only required on infix operators and
specifies whether they chain to the left (like <code>+</code>), to the right
(like <code>=</code>), or not at all (like <code>..</code>). If the trait is
not specified, the operator takes its associativity from the operator that's
specified in the <code>is tighter</code>, <code>is looser</code>, or <code>is
equiv</code> trait.</p>

<h4>Arguments Both Ways</h4>

<p>On the other hand, we might prefer that the selector come first (as it does
in <code>&amp;part</code>):</p>

<pre><code>%parts = Animal::Cat ~|_|~ @animals;</code></pre>

<p>in which case we could just add:</p>

<pre><code>multi sub infix:~|_|~ (Selector $is_sheep, @data)
    is equiv( &amp;infix:~|_|~(Array,Selector) )
{
    return part $is_sheep, @data;
}</code></pre>

<p>so now we can specify the selector and the data in <em>either</em>
order.</p>

<p>Because the two variants of the <code>&amp;infix:~|_|~</code> multisubs have
different parameter lists (one is <code>(Array,Selector)</code>, the other is
<code>(Selector, Array)</code>, Perl 6 always knows which one to call. If the
left operand is a <code>Selector</code>, the
<code>&amp;infix:~|_|~(Selector,Array)</code> variant is called. If the left
operand is an array, the <code>&amp;infix:~|_|~(Array,Selector)</code> variant
is invoked.</p>

<p>Note that, for this second variant, we specified <code>is equiv</code>
instead of <code>is tighter</code> or <code>is looser</code>. This ensures that
the precedence and associativity of the second variant are the same as those of
the first. That's also why we didn't need to specify an <code>is
assoc</code>.</p>

<h3>Parting Is Such Sweet Sorrow</h3>

<p>Phew. Talk about "more than one way to do it"!</p>

<p>But don't be put off by these myriad new features and alternatives. The vast
majority of them are special-purpose, power-user techniques that you may well
never need to use or even know about.</p>

<p>For most of us it will be enough to know that we can now add a proper
parameter list, with sensibly named parameters, to any subroutine. What we used
to write as:</p>

<pre><code>sub feed {
    my ($who, $how_much, @what) = @_;
    ...
}</code></pre>

<p>we now write as:</p>

<pre><code>sub feed ($who, $how_much, *@what) {
    ...
}</code></pre>

<p>or, when we're feeling particularly cautious:</p>

<pre><code>sub feed (Str $who, Num $how_much, Food *@what) {
    ...
}</code></pre>

<p>Just being able to do that is a huge win for Perl 6.</p>

<h3>Parting Shot</h3>

<p>By the way, here's (most of) that same partitioning functionality
implemented in Perl 5:</p>

<pre><code># Perl 5 code...
sub part {
    my ($is_sheep, $maybe_flag_or_labels, $maybe_labels, @data) = @_;
    my ($sheep, $goats);
    if ($maybe_flag_or_labels eq "labels" &amp;&amp; ref $maybe_labels eq 'ARRAY') { 
        ($sheep, $goats) = @$maybe_labels;
    }
    elsif (ref $maybe_flag_or_labels eq 'ARRAY') {
        unshift @data, $maybe_labels;
        ($sheep, $goats) = @$maybe_flag_or_labels;
    }
    else {
        unshift @data, $maybe_flag_or_labels, $maybe_labels;
        ($sheep, $goats) = qw(sheep goats);
    }
    my $arg1_type = ref($is_sheep) || 'CLASS';
    my %herd;
    if ($arg1_type eq 'ARRAY') {
        for my $index (0..$#data) {
            my $datum = $data[$index];
            my $label = grep({$index==$_} @$is_sheep) ? $sheep : $goats;
            push @{$herd{$label}}, $datum;
        }
    }
    else {
        croak "Invalid first argument to &amp;part"
            unless $arg1_type =~ /^(Regexp|CODE|HASH|CLASS)$/;
        for (@data) {
            if (  $arg1_type eq 'Regexp' &amp;&amp; /$is_sheep/
               || $arg1_type eq 'CODE'   &amp;&amp; $is_sheep-&gt;($_)
               || $arg1_type eq 'HASH'   &amp;&amp; $is_sheep-&gt;{$_}
               || UNIVERSAL::isa($_,$is_sheep)
               ) {
                push @{$herd{$sheep}}, $_;
            }
            else {
                push @{$herd{$goats}}, $_;
            }
        }
    }
    return map {bless {key=&gt;$_,value=&gt;$herd{$_}},'Pair'} keys %herd;
}</code></pre>

<p>... which is <em>precisely</em> why we're developing Perl 6.</p>

        </div>



    </div>
    <div class="asset-footer"></div>
</div>


                            
                            <div id="entry-1168" class="entry-asset asset hentry">
    <div class="asset-header">
        <h2 class="asset-name entry-title"><a href="/pub/2003/07/22/overloading.html" rel="bookmark">Overloading</a></h2>
        <div class="asset-meta">
            <span class="byline">
    
                <abbr class="published" title="2003-07-22T00:00:00-08:00">July 22, 2003 12:00 AM</abbr>
    
            </span>

            
            

        </div>
    </div>
    <div class="asset-content entry-content">

        <div class="asset-body">
            
<!-- sidebar begins -->
<!-- don't move sidebars -->
<!-- sidebar ends -->

<h3>Introduction: What is Overloading?</h3>

<p>All object-oriented programming languages have a feature called overloading,
but in most of them this term means something different from what it means in
Perl. Take a look at this Java example:</p>

<pre><code>public Fraction(int num, int den);
public Fraction(Fraction F);
public Fraction();</code></pre>

<p>In this example, we have three methods called <code>Fraction</code>. Java,
like many languages, is very strict about the number and type of arguments that
you can pass to a function. We therefore need three different methods to cover
the three possibilities. In the first example, the method takes two integers (a
numerator and a denominator) and it returns a <code>Fraction</code> object
based on those numbers. In the second example, the method takes an existing
<code>Fraction</code> object as an argument and returns a copy (or clone) of
that object.  The final method takes no arguments and returns a default
<code>Fraction</code> object, maybe representing 1/1 or 0/1.  When you call one
of these methods, the Java Virtual Machine determines which of the three
methods you wanted by looking at the number and type of the arguments.</p>

<csperl file="grab" domain="on" record="b/936" template="b/article_sidebar.view">

<p>In Perl, of course, we are far more flexible about what arguments we can
pass to a method. Therefore the same method can be used to handle all of the
three cases from the Java example.  (We'll see an example of this in a short
while.) This means that in Perl we can save the term "overloading" for
something far more interesting &mdash; <em>operator overloading</em>.</p>

<h3><code>Number::Fraction</code> &mdash; The Constructor</h3>

<p>Imagine you have a Perl object that represents fractions (or, more
accurately, rational numbers, but we'll call them fractions as we're not all math geeks). In order to handle the same situations as the Java class we mentioned above, we need to be able to run code like this:</p>

<pre><code>use Number::Fraction;

my $half       = Number::Fraction-&gt;new(1, 2);
my $other_half = Number::Fraction-&gt;new($half);
my $default    = Number::Fraction-&gt;new;</code></pre>

<p>To do this, we would write a constructor method like this:</p>

<pre><code>sub new {
    my $class = shift;
    my $self;
    if (@_ &gt;= 2) {
        return if $_[0] =~ /\D/ or $_[1] =~ /\D/;
        $self-&gt;{num} = $_[0];
        $self-&gt;{den} = $_[1];
    } elsif (@_ == 1) {
        if (ref $_[0]) {
            if (UNIVERSAL::isa($_[0], $class) {
                return $class-&gt;new($_[0]-&gt;{num}, $_[0]-&gt;{den});
            } else {
                croak "Can't make a $class from a ", ref $_[0];
            }
        } else {
            return unless $_[0] =~ m|^(\d+)/(\d+)|;

            $self-&gt;{num} = $1;
            $self-&gt;{den} = $2;
        }
    } elsif (!@_) {
        $self-&gt;{num} = 0;
        $self-&gt;{den} = 1;
    }

    bless $self, $class;
    $self-&gt;normalise;
    return $self;
}</code></pre>

<p>As promised, there's just one method here and it does everything that the
three Java methods did and more even, so it's a good example of why we don't
need method overloading in Perl. Let's look at the various parts in some
detail.</p>

<pre><code>sub new {
    my $class = shift;
    my $self;</code></pre>

<p>The method starts out just like most Perl object constructors.  It grabs the
class which is passed in as the first argument and then declares a variable
called <code>$self</code> which will contain the object.</p>

<pre><code>    if (@_ &gt;= 2) {
        return if $_[0] =~ /\D/ or $_[1] =~ /\D/;
        $self-&gt;{num} = $_[0];
        $self-&gt;{den} = $_[1];</code></pre>

<p>This is where we start to work out just how the method was called. We look
at <code>@_</code> to see how many arguments we have been given. If we've got
two arguments then we assume that they are the numerator and denominator of the
fraction. Notice that there's also another check to ensure that both arguments
contain only digits. If this check fails, we return <code>undef</code> from the
constructor.</p>

<pre><code>     } elsif (@_ == 1) {
        if (ref $_[0]) {
            if (UNIVERSAL::isa($_[0], $class) {
                return $class-&gt;new($_[0]-&gt;num, $_[0]-&gt;den);
            } else {
                croak "Can't make a $class from a ", ref $_[0];
            }
        } else {
            return unless $_[0] =~ m|^(\d+)/(\d+)|;
            $self-&gt;{num} = $1;
            $self-&gt;{den} = $2;
        }</code></pre>

<p>If we've been given just one argument, then there are a couple of things we can do. First we see if the argument is a reference, and if it is, we check that it's a reference to another <code>Number::Fraction</code> object (or a subclass). If it's the right kind of object then we get the numerators and denominators (using the accessor functions) and use them to call the two argument forms of <code>new</code>. It the argument is the wrong type of reference then we complain bitterly to the user.</p>

<p>If the single argument isn't a reference then we assume it's a string
of the form <code>num/den</code>, which we can split apart to get the numerator
and denominator of the fraction. Once more we check for the correct format
using a regex and return <code>undef</code> if the check fails.</p>

<pre><code>     } elsif (!@_) {
        $self-&gt;{num} = 0;
        $self-&gt;{den} = 1;
    }</code></pre>

<p>If we are given no arguments, then we just create a default fraction which
is <code>0/1</code>.</p>

<pre><code>    bless $self, $class;
    $self-&gt;normalise;
    return $self;
}</code></pre>

<p>At the end of the constructor we do more of the normal OO Perl stuff. We
<code>bless</code> the object into the correct class and return the reference
to our caller. Between these two actions we pause to call the
<code>normalise</code> method, which converts the fraction to its simplest form.
For example, it will convert <code>12/16</code> to <code>3/4</code>.</p>

<h3><code>Number::Fraction</code> &mdash; Doing Calculations</h3>

<p>Having now created fraction objects, we will want to start doing
calculations with them. For that we'll need methods that implement the various
mathematical functions. Here's the <code>add</code> method:</p>

<pre><code>sub add {
    my ($self, $delta) = @_;

    if (ref $delta) {
        if (UNIVERSAL::isa($delta, ref $self)) {
            $self-&gt;{num} = $self-&gt;num  * $delta-&gt;den
                + $delta-&gt;num * $self-&gt;den;
            $self-&gt;{den} = $self-&gt;den  * $delta-&gt;den;
        } else {
            croak "Can't add a ", ref $delta, " to a ", ref $self;
        }
    } else {
        if ($delta =~ m|(\d+)/(\d+)|) {
            $self-&gt;add(Number::Fraction-&gt;new($1, $2));
        } elsif ($delta !~ /\D/) {
            $self-&gt;add(Number::Fraction-&gt;new($delta, 1));
        } else {
            croak "Can't add $delta to a ", ref $self;
        }
    }
    $self-&gt;normalise;
}</code></pre>

<p>Once more we try to handle a number of different types of arguments. We can
add the following things to our fraction object:</p>

<ul>

<li>Another object of the same class (or a subclass).</li>
<li>A string in the format <code>num/den</code>.</li>
<li>An integer. This is converted to a fraction with a denominator of 1.</li>

</ul>

<p>This then allows us to write code like this:</p>

<pre><code>my $half           = Number::Fraction-&gt;new(1, 2);
my $quarter        = Number::Fraction-&gt;new(1, 4);
my $three_quarters = $half;
$three_quarters-&gt;add($quarter);</code></pre>

<p>In my opinion, this code looks pretty horrible. It also has a nasty, subtle
bug. Can you spot it? (Hint: What will be in <code>$half</code> after running
this code?) To tidy up this code we can turn to <em>operator
overloading</em>.</p>

<h3><code>Number::Fraction</code> &mdash; Operator Overloading</h3>

<p>The module <code>overload.pm</code> is a standard part of the Perl
distribution.  It allows your objects to define how they will react to a number
of Perl's operators. For example, we can add code like this to
<code>Number::Fraction</code>:</p>

<pre><code>use overload '+' =&gt; 'add';</code></pre>

<p>Whenever a Number::Fraction is used as one of the operands
to the <code>+</code> operator, the <code>add</code> method will be
called instead. Code like:</p>

<pre><code>$three_quarters = $half + '3/4';</code></pre>

<p>is converted to:</p>

<pre><code>$three_quarters = $half-&gt;add('3/4');</code></pre>

<p>This is getting closer, but it still has a serious problem. The
<code>add</code> method works on the <code>$half</code> object.  In general,
however, that's not how an assignment should work. If you were working with
ordinary scalars and had code like:</p>

<pre><code>$foo = $bar + 0.75;</code></pre>

<p>You would be very surprised if this altered the value of <code>$bar</code>.
Our objects need to work in the same way. We need to change our add method so
that it doesn't alter <code>$self</code> but instead returns the new
fraction.</p>

<pre>sub add {
    my ($l, $r) = @_;
    if (ref $r) {
        if (UNIVERSAL::isa($r, ref $l) {
            return Number::Fraction-&gt;new($l-&gt;num * $r-&gt;den + $r-&gt;num * $l-&gt;den,
                    $l-&gt;den * $r-&gt;den})
        } else {
            ...
        } else {
            ...
        }
    }
}</code></pre>

<p>In this example, I've only shown one of the sections, but I hope it's clear
how it would work. Notice that I've also renamed <code>$self</code> and
<code>$delta</code> to <code>$l</code> and <code>$r</code>. I find this makes
more sense as we are working with the left and right operands of the
<code>+</code> operator.</p>













<h3><a name="overloading noncommutative operators"
id="overloading noncommutative operators">Overloading
Non-Commutative Operators</a></h3>

<p>We can now happily handle code like:</p>

<pre><code>$three_quarters = $half + '1/4';</code></pre>

<p>Our object will do the right thing &mdash; <code>$three_quarters</code> will
end up as a <code>Number::Fraction</code> object that contains the value
<code>3/4</code>. What will happen if we write code like this?</p>

<pre><code>$three_quarters = '1/4' + $half;</code></pre>

<p>The <code>overload</code> modules handle this case as well. If your object
is <em>either</em> operand of one of the overloaded operators, then your method
will be called. You get passed an extra argument which indicates whether your
object was the left or right operand of the operator. This argument is
false if your object is the left operand and true if it is the right
operand.</p>

<p>For commutative operators you probably don't need to take any
notice of this argument as, for example:</p>

<pre><code>$half + '1/4'</code></pre>

<p>is the same as:</p>

<pre><code>'1/4' + $half</code></pre>

<p>However, for non-commutative operators (like <code>-</code> and
<code>/</code>) you will need to do something like this:</p>

<pre><code>sub subtract {
    my ($l, $r, $swap) = @_;

    ($l, $r) = ($r, $l) if $swap;
    ...
}</code></pre>

<h3>Overloadable Operators</h3>

<p>Just about any Perl operator can be overloaded in this way. This
is a partial list:</p>

<ul>

<li>Arithmetic: <code>+</code>, <code>+=</code>, <code>-</code>,
<code>-=</code>, <code>*</code>, <code>*=</code>, <code>/</code>,
<code>/=</code>, <code>%</code>, <code>%=</code>, <code>**</code>,
<code>**=</code>, <code>&lt;&lt;</code>, <code>&lt;&lt;=</code>,
<code>&gt;&gt;</code>, <code>&gt;&gt;=</code>, <code>x</code>, <code>x=</code>,
<code>.</code>, <code>.=</code></li>

<li>Comparison: <code>&lt;</code>, <code>&lt;=</code>, <code>&gt;</code>,
<code>=&gt;</code>, <code>==</code>, <code>!=</code>, <code>&lt;=&gt;</code>
<code>lt</code>, <code>le</code>, <code>gt</code>, <code>ge</code>,
<code>eq</code>, <code>ne</code>, <code>cmp</code></li>

<li>Increment/Decrement: <code>++</code>, <code>--</code> (both pre- and post-
versions)</li>

</ul>

<p>A full list is given in <code>overload</code>.</p>

<p>It's a very long list, but thankfully you rarely have to supply
an implementation for more than a few operators. Perl is quite
happy to synthesize (or <em>autogenerate</em>) many of the missing
operators. For example:</p>

<ul>
<li>++ can be derived from +</li>
<li>+= can be derived from +</li>
<li>- (unary) can be derived from - (binary)</li>
<li>All numeric comparisons can be derived from <code>&lt;=&gt;</code></li>
<li>All string comparisons can be derived from <code>cmp</code></li>
</ul>

<p>Two other special operators give finer control over this autogeneration of
methods. <code>nomethod</code> defines a subroutine that is called when no
other function is found and <code>fallback</code> controls how hard Perl tries
to autogenerate a method. <code>fallback</code> can have one of three
values:</p>

<dl>

<dt><code>undef</code></dt>
<dd>Attempt to autogenerate methods and <code>die</code> if a method can't be
autogenerated.  This is the default.</dd>

<dt><code>0</code></dt>
<dd>Never try to autogenerate methods.</dd>

<dt><code>1</code></dt>
<dd>Attempt to autogenerate methods but fall back on Perl's default behavior
for the the object if a method can't be autogenerated.</dd>
</dl>

<p>Here's an example of an object that will die gracefully when an unknown
operator is called. Notice that the <code>nomethod</code> subroutine is passed
the usual three arguments (left operand, right operand, and the swap flag)
together with an extra argument containing the operator that was used.</p>

<pre><code>use overload
    '-' =&gt; 'subtract',
    fallback =&gt; 0,
    nomethod =&gt; sub { 
        croak "illegal operator $_[3]" 
};</code></pre>

<p>Three special operators are provided to control type conversion.  They
define methods to be called if the object is used in string, numeric, and
boolean contexts. These operators are denoted by <code>q{""}</code>,
<code>0+</code>, and <code>bool</code>. Here's how we can use these in
<code>Number::Fraction</code>:</p>

<pre><code>use overload
    q{""} =&gt; 'to_string',
    '0+'  =&gt; 'to_num';

sub to_string {
    my $self = shift;
    return "$_-&gt;{num}/$_-&gt;{den}";
}

sub to_num {
    my $self = shift;
    return $_{num}/$_-&gt;{den};
}</code></pre>

<p>Now, when we print a <code>Number::Fraction</code> object, it will be
displayed in <code>num/den</code> format.  When we use the object in a numeric
context, Perl will automatically convert it to its numeric equivalent.</p>

<p>We can use these type-conversion and fallback operators to cut down the
number of operators we need to define even further.</p>

<pre><code>use overload
    '0+' =&gt; 'to_num',
    fallback =&gt; 1;</code></pre>

<p>Now, whenever our object is used where Perl is expecting a number and we
haven't already defined an overloading method, Perl will try to use our object
as a number, which will, in turn, trigger our <code>to_num</code> method. This
means that we only need to define operators where their behavior will differ
from that of a normal number. In the case of <code>Number::Fraction</code>, we
don't need to define any numeric comparison operators since the numeric value of
the object will give the correct behavior. The same is true of the string
comparison operators if we define <code>to_string</code>.</p>

<h3>Overloading Constants</h3>

<p>We've come a long way with our overloaded objects. Instead of nasty code
like:</p>

<pre><code>use Number::Fraction;

$f = Number::Fraction-&gt;new(1, 2);
$f-&gt;add('1/4');</code></pre>

<p>we can now write code like:</p>

<pre><code>use Number::Fraction;

$f = Number::Fraction-&gt;new(1, 2) + '1/4';</code></pre>

<p>There are still, however, two places where we need to use the full name of
the class &mdash; when we load the module and when we create a new fraction
object. We can't do much about the first of these, but we <em>can</em> remove
the need for that ugly <code>new</code> call by <em>overloading
constants</em>.</p>

<p>You can use <code>overload::constant</code> to control how Perl interprets
constants in your program.  <code>overload::constant</code> expects a hash
where the keys identify various kinds of constants and the values are
subroutines which handle the constants. The keys can be any of
<code>integer</code> (for integers), <code>float</code> (for floating point
numbers), <code>binary</code> (for binary, octal, and hex numbers),
<code>q</code> (for strings), and <code>qr</code> (for the constant parts of
regular expressions).</p>

<p>When a constant of the right type is found, Perl will call the associated
subroutine, passing it the string representation of the constant and the way
that Perl would interpret the constant by default. Subroutines associated with
<code>q</code> or <code>qr</code> also get a third argument -- either
<code>qq</code>, <code>q</code>, <code>s</code>, or <code>tr</code> --which
indicates how the string is being used in the program.</p>

<p>As an example, here is how we would set up constant handlers so that strings
of the form <code>num/den</code> are always converted to the equivalent
<code>Number::Fraction</code> object:</p>

<pre>
my %_const_handlers = 
    (q =&gt; sub { 
        return __PACKAGE__-&gt;new($_[0]) || $_[1] 
});

sub import {
    overload::constant %_const_handlers if $_[1] eq ':constants';
}

sub unimport {
    overload::remove_constant(q =&gt; undef);
}</code></pre>

<p>We've defined a hash, <code>%_const_handlers</code>, which only contains one
entry as we are only interested in strings. The associated subroutine calls the
<code>new</code> method in the current package (which will be
<code>Number::Fraction</code> or a subclass) passing it the string as found in
the program source. If this string can be used to create a valid
<code>Number::Fraction</code> object, a reference to that object is returned.</p>

<p>If a valid object isn't returned then the subroutine returns its second
argument, which is Perl's default intepretation of the constant. As a result,
any strings in the program that can be intepreted as a fraction are converted
to the correct <code>Number::Fraction</code> object and other strings are left
unchanged.</p>

<p>The constant handler is loaded as part of our package's <code>import</code>
subroutine. Notice that it is only loaded if the <code>import</code> subroutine
is passed the optional argument <code>:constants</code>. This is because this
is a potentially big change to the way that a program's source code is
interpreted so we only want to turn it on if the user wants it.
<code>Number::Fraction</code> can be used in this way by putting the following
line in your program:</p>

<pre><code>use Number::Fraction ':constants';</code></pre>

<p>If you don't want the scary constant-refining stuff you can
just use:</p>

<pre><code>use Number::Fraction;</code></pre>

<p>Also note that we've defined an <code>unimport</code> subroutine which
removes the constant handler. An <code>unimport</code> subroutine is called
when a program calls <code>no Number::Fraction</code> &mdash; it's the opposite
of <code>use</code>. If you're going to make major changes to the way that Perl
parses a program then it's only polite to undo your changes if the programmer
askes you to.</p>

<h3>Conclusion</h3>

<p>We've finally managed to get rid of most of the ugly class names from our
code. We can now write code like this:</p>

<pre><code>use Number::Fraction ':constants';

my $half = '1/2';
my $three_quarters = $half + '1/4';
print $three_quarters;  # prints 3/4</code></pre>

<p>I hope you can agree that this has the potential to make code far easier to
read and understand.</p>

<p><code>Number::Fraction</code> is available on the CPAN. Please feel free to
take a closer look at how it is implemented. If you come up with any more
interesting overloaded modules, I'd love to hear about them.</p>


        </div>



    </div>
    <div class="asset-footer"></div>
</div>


                            
                            <div id="entry-1156" class="entry-asset asset hentry">
    <div class="asset-header">
        <h2 class="asset-name entry-title"><a href="/pub/2003/06/p6pdigest/20030720.html" rel="bookmark">This week on Perl 6, week ending 2003-07-20</a></h2>
        <div class="asset-meta">
            <span class="byline">
    
                By <span class="vcard author">Piers Cawley</span> on <abbr class="published" title="2003-07-20T00:00:00-08:00">July 20, 2003 12:00 AM</abbr>
    
            </span>

            
            

        </div>
    </div>
    <div class="asset-content entry-content">

        <div class="asset-body">
            
<p>Welcome back to an interim Perl 6 Summary, falling between two conference
weeks &mdash; OSCON and YAPC::Europe. For reasons involving insanity, a
EuroStar ticket going begging, and undeserved generosity, I shall be bringing
my conference haul up to 3 for the year. Yay me! Now if I can just finagle a
talk into the schedule I will have spoken at all three too. I'll certainly have
heckled at all three.</p>

<h4>The State of the Onion</h4>

<p>Tim Howell wondered if Larry's State of the Onion address to OSCON would be
available anywhere. Robert "White Camel" Spier didn't rest on his laurels, but
posted a link to Larry's slides and transcript. chromatic popped up with a
different link which neatly combines slides and transcript. However, they both
lack the funny balloon pony which I gave Larry just before the talk. Maybe
there will be video later.</p>

<p> <a 
href="http://groups.google.com/groups?threadm=3B1351035BBCE045831FCFDD4F4EC92D044C7F%40sonofexchange.fefcful.org">http://groups.google.com/groups</a></p>

<p> <a 
href="/pub/a/2003/07/16/soto2003.html">http://www.perl.com/pub/a/2003/07/16/soto2003.html</a></p>

<h4>A Small Perl Task for the Interested</h4>

<p>A few weeks back, Dan asked for volunteers to improve Parrot's build system.
Lars Balker Rasmussen stepped up to the plate and offered a simple wrapper.
Josh Wilmes seems to be somewhat sceptical about the whole endeavour, pointing
at <code>libtool</code> as an illustration of the size of the problem.</p>

<p> <a 
href="http://groups.google.com/groups?threadm=0fptkdo04c.fsf%40laphroaig.balker.org">http://groups.google.com/groups</a></p>

<h4><code>env.pmc</code></h4>

<p>Parrot is in the process of getting an <code>env</code> PMC, for accessing
environment variables. Dan and Leo's discussion of the patch took in iterators
and the wisdom of caching values. In the end, Dan prevailed and the environment
PMC doesn't cache values.</p>

<p> <a 
href="http://groups.google.com/groups?threadm=200307110809.h6B89s728289%40thu8.leo.home">http://groups.google.com/groups</a></p>

<h4>Dan on threading</h4>

<p>"Yes, [there is some plan of how threading will work in Parrot]. (Though
there's some disagreement [as] to the solidity and sanity of the plan)".</p>

<p>Dan went on to outline the plan.</p>

<p> <a 
href="http://groups.google.com/groups?threadm=a05210602bb38ce4499f5%40%5B63.120.19.221%5D">http://groups.google.com/groups</a></p>

<h4>Event handling</h4>

<p>Event handling appears to be the topic of the week. The consensus seems to
be that getting it right is hard. Lots of people offered constructive
suggestions and problem cases. I sat on the sidelines and trusted them to get
it Right (a strategy which seems to pay off remarkably often, thankfully).</p>

<p>Damien Neil was rather less sure of the wisdom of Parrot's events and
asynchronous IO model, arguing for a system based on threading. Dan was
unconvinced. I don't think Damien was convinced either.</p>

<p> <a 
href="http://groups.google.com/groups?threadm=200307150815.h6F8FvS29109%40thu8.leo.home">http://groups.google.com/groups</a></p>

<p> <a 
href="http://groups.google.com/groups?threadm=a05210608bb3cacd7c15e%40%5B63.120.19.221%5D">http://groups.google.com/groups</a></p>

<p> <a 
href="http://groups.google.com/groups?threadm=a05210604bb3c7f592ef5%40%5B63.120.19.221%5D">http://groups.google.com/groups</a></p>

<h4>IMCC sub names are not labels</h4>

<p>Luke Palmer had some problems with using continuation passing style
subroutines in IMCC. Leo initially pointed out that IMCC didn't support CPS.
Then he fixed it so that it did (sort of: the user still has to do a chunk of
the work, but sometimes that's a good thing).</p>

<p>In an example of synchronicity, Will Coleda had a similar problem. Leo's fix
helped him too, and he went off to continue hacking on Tcl. (It helps me too,
as I have this cunning plot....)</p>

<p> <a 
href="http://groups.google.com/groups?threadm=ygc1xwsw4nx.fsf%40babylonia.flatirons.org">http://groups.google.com/groups</a></p>

<h4>More on targeting GCC</h4>

<p>In last week's summary I wondered what Tupshin Harper was talking about when
he suggested emulating a "more traditional, stack-oriented processor". This
week, Tupshin wished that "people had the decency to tell me how insane [the
idea] is". Dan obliged, telling Tupshin that he was insane (but he did it with
a smile).</p>

<p>The problem boils down to GCC's assumptions about the "shape" of the stack.
GCC assumes a conventional, contiguous area of stack memory filled with stack
frames. Parrot assumes a garbage collected chain of continuations, which is
about as far as you can get from GCC's beliefs.</p>

<p> <a 
href="http://groups.google.com/groups?threadm=3F148CF0.8040801%40tupshin.com">http://groups.google.com/groups</a></p>

<h4> <code>Parrot_sprintf</code> not recognizing 7 in precision</h4>

<p>mrnobo1024 posted a patch to fix a minor niggle with
<code>Parrot_sprintf</code>. Leon Brocard applied it.</p>

<p> <a 
href="http://groups.google.com/groups?threadm=rt-23005-60977.8.97351447008035%40rt.perl.org">http://groups.google.com/groups</a></p>

<h4> Problems with new object ops</h4>

<p>Dan has started adding real classes and objects to Parrot.  (Yay!)</p>

<p>Simon Glover found some bugs. (Not entirely unexpected.)</p>

<p>Simon also sent in a patch fixing the bugs. (Yay! Yay! and thrice Yay!)</p>

<p> <a 
href="http://groups.google.com/groups?threadm=Pine.GSO.4.43.0307162222430.28483-100000%40egg.amnh.org">http://groups.google.com/groups</a></p>

<h4> The big <code>core.ops</code> split</h4>

<p>Brent Dax has started work on splitting <code>core.ops</code> from being the
second largest file in the Parrot distribution (108k) into a total of ten more
narrowly defined <code>.ops</code> files. Benjamin Goldberg wondered if this
would be a good time for tidying up the parrot directory structure.  At the
very least, he called for moving the source files into a <code>src</code>
subdirectory.</p>

<p>Dan asked for a volunteer to rough out a move plan covering which files move
where and what the new directory structure would look like, which would allow
the perl.org jockeys to rearrange things in such a way that the various files
remember their histories.</p>

<p> <a 
href="http://groups.google.com/groups?threadm=000f01c34d73%244c2951e0%242a01a8c0%40brent">http://groups.google.com/groups</a></p>

<h4>Copyrights</h4>

<p>Josh Wilmes posted a monster patch to unify the various copyright notices
attached to the files in the parrot distribution.  Everything is now
(correctly) copyrighted by the Perl Foundation.</p>

<p> <a 
href="http://groups.google.com/groups?threadm=rt-23064-61526.13.0744805883565%40rt.perl.org">http://groups.google.com/groups</a></p>



<h3> Meanwhile, in perl6-language</h3>

<p>Somebody needs to set an Exegesis among the pigeons. There's all of 14
messages in there, almost discussing the semantics of aliasing an array
slice.</p>

<p> <a 
href="http://groups.google.com/groups?threadm=3F186F40.AF8BE6BB%40hotpop.com">http://groups.google.com/groups</a>
&mdash; Alias those slices</p>

<h4> Parsers with Pre-processors</h4>

<p>I didn't quite understand what Dave Whipp was driving at when he talked
about overloading the <code>&lt;ws&gt;</code> pattern as a way of doing
preprocessing of Perl 6 patterns. I didn't understand Luke Palmer's answer
either. Help.</p>

<p> <a 
href="http://groups.google.com/groups?threadm=20030718051146.95342.qmail%40onion.perl.org">http://groups.google.com/groups</a></p>

<h4>Protocols</h4>

<p>Luke Palmer's been toying with Objective-C (and why not, it's a nice
language) and would like Perl 6 to steal Objective-C's protocols. Protocols are
a little like Java's interfaces, but nicer. I'm waiting for him to latch onto
the idea of Categories which are Objective C's way of adding methods to a
class, at runtime.</p>

<p>Discussion of Luke's proposal centered on a couple of his peripheral points.
Nobody's yet addressed his main point, but it looks like a decent idea to
me.</p>

<p> <a 
href="http://groups.google.com/groups?threadm=ygck7aeahch.fsf%40babylonia.flatirons.org">http://groups.google.com/groups</a></p>



<h3> Acknowledgements, Announcements, and Apologies</h3>

<p>First of all, I plead insanity for my mistake of last week's summary. PONIE
does not stand for "Perl On New Internal Architecture", it obviously stands for
"Perl On New Internal Engine". I'm very, very sorry and I'll try not to do it
again.</p>

<p><em>Editor's note:  the Ponie expansion was corrected in both summaries
before publication.  The summarizer has been whacked appropriately.</em></p>

<p>Secondly, an announcement, I've started one of those
punditry/bloggy things. It's at
<a  href="http://pc1.bofhadsl.ftech.co.uk:8080/">http://pc1.bofhadsl.ftech.co.uk:8080/</a>
(Snappy URL eh?) and it's called 'Just A Summary'. I'm expecting it
to concentrate on Perl and Perl 6 related issues, but at the time
of this writing I've only got two 'real' articles up there so
anything could happen.</p>

<p>As ever, if you've appreciated this summary, please consider one or more of
the following options:</p>

<ul>

<li>Send money to the Perl Foundation at <a 
href="http://donate.perl-foundation.org/">http://donate.perl-foundation.org/</a>
and help support the ongoing development of Perl.</li>

<li>Get involved in the Perl 6 process. The mailing lists are open to all.  <a 
href="http://dev.perl.org/perl6/">http://dev.perl.org/perl6/</a> and <a 
href="http://www.parrotcode.org/">http://www.parrotcode.org/</a> are good
starting points with links to the appropriate mailing lists.</li>

<li>Send feedback, flames, money, requests for consultancy, photographic and
writing commissions, or an Apple 23' Cinema Display to <em><a 
href="mailto:p6summarizer@bofh.org.uk">p6summarizer@bofh.org.uk</a></em> (One
of these days that begging request will work, and I'll be flabbergasted).</li>

</ul>

        </div>



    </div>
    <div class="asset-footer"></div>
</div>


                            
                            <div id="entry-1166" class="entry-asset asset hentry">
    <div class="asset-header">
        <h2 class="asset-name entry-title"><a href="/pub/2003/07/16/soto2003.html" rel="bookmark">State of the Onion 2003</a></h2>
        <div class="asset-meta">
            <span class="byline">
    
                By <span class="vcard author">Larry Wall</span> on <abbr class="published" title="2003-07-16T00:00:00-08:00">July 16, 2003 12:00 AM</abbr>
    
            </span>

            
            

        </div>
    </div>
    <div class="asset-content entry-content">

        <div class="asset-body">
            
<!-- sidebar begins -->
<!-- don't move sidebars -->
<!-- sidebar ends -->

<p> This is the 7th annual State of the Perl Onion speech, wherein I tell you
how Perl is doing.  Perl is doing fine, thank you.  Now that that's out of the
way, I'd like to spend the rest of the time telling jokes.</p>

<img src="/pub/2003/07/16/graphics/slide1.jpg" width="499" height="375" />

<p>In fact, the conference organizers have noticed that I spend most of the
time telling jokes.  So each year they give me a little less time, so I have to
chop out more of the serious subject matter so as to leave time for the
jokes.</p>

<p>Extrapolating several years into the future, they'll eventually chop my time
down to ten seconds.  I'll have just enough time to say: "I'm really, really
excited about what is happening with Perl this year. And I'd like to announce
that, after lengthy negotiations, Guido and I have finally decided...
&lt;gong&gt; ["Time's up. Next speaker please"]</p>

<p>Well, you didn't really want to know that anyway...</p>

<p>Since this is a State of the Union speech, or State of the Onion, in the
particular case of Perl, I'm supposed to tell you what Perl's current state is.
But I already told you that the current state of Perl is just fine.  Or at
least as fine as it ever was.  Maybe a little better.</p>

<p>But what you really want to know about is the future state of Perl.  That's
nice.  I don't know much about the future of Perl.  Nobody does.  That's part
of the design of Perl 6.  Since we're designing it to be a mutable language, it
will probably mutate.  If I did know the future of Perl, and if I told you,
you'd probably run away screaming.</p>

<p>As I was meditating on this subject, thinking about how I don't know the
future of Perl, and how you probably don't <em>want</em> to know it anyway, I was
reminded of a saying that I first saw posted in the 1960's.  You may feel like
this on some days.</p>

<blockquote><p>We the unwilling,<br />
led by the unknowing,<br />
are doing the impossible<br />
for the ungrateful.<br />
We have done so much for so long with so little<br />
We are now qualified to do anything with nothing</p></blockquote>

<img src="/pub/2003/07/16/graphics/slide2.jpg" width="499" height="375" alt="blue collar" />

<p>I think of it as the Blue-Collar Worker's Creed.</p>

<p>This has been attributed to various people, none of whom are Ben Franklin,
Abraham Lincoln, or Mark Twain.  My favorite attribution is to Mother Teresa.
She may well have quoted it, but I don't think she coined it, because I don't
think Mother Teresa thought of herself as "unwilling".  After all, Mother
Teresa got a Nobel prize for being one of the most willing people on the face
of the earth.</p>

<p>It's also been attributed to the Marines in Vietnam, and it certainly 
    fits a little better. But since I grew up in a Navy town, I'd like to 
    think it was invented by a civilian shipyard worker working for the 
    Navy. In any event, I first saw it posted in a work area at Puget Sound 
    Naval Shipyard back in the 1960's. Now, you may well wondering what 
    I was doing in a Naval Shipyard in the 1960's. That's a secret.</p>

<p>Anyway, you may also be wondering why I brought it up at all.  Well, last
year I used the table of contents from an issue of Scientific American as my
outline.  This year I'd like to use this as my outline.</p>

<p>I'd like to, but I won't.</p>

<p>But if I did, here's what I'd say.</p>

<p>From the postmodern point of view, this is a text that needs to be
deconstructed.  It was obviously written by someone in a position of power
pretending not to be.  And by making light of the plight of blue collar
workers, and allowing the oppressed workers to post this copy-machine meme in
the workplace, this white-collar wolf in blue-collar sheep's clothing has
managed to persuade the oppressed workers that being powerless is something to
be proud of.</p>

<p>Now, some of you young folks are too steeped in postmodernism to know 
    anything about postmodernism, so let's review. Postmodernism in its 
    most vicious form started out with the notion that there exist various 
    cultural constructs, or texts, or memes, that allow some human beings 
    to oppress other human beings. Of course, in Soviet Russia it's the 
    other way around. Which is why they managed to deconstruct themselves, 
    I guess.</p>

<p>Anyway, deconstructionism is all about throwing out the bad cultural memes,
where "bad" is defined as anything an oppressed person doesn't like.  Which is
fine as far as it goes, but the spanner in the works is that you can only be an
oppressed person if the deconstructionists say you are.  Dead white males need
not apply.  Fortunately, I'm not dead yet.  Though I'm trying.  As some of you
know, several weeks ago I was in the hospital with a bleeding ulcer.  I guess
I'm a little like Soviet Russia.  I oppress myself, so I deconstruct
myself.</p>

<p>Oh, by the way, I got better.  In case you hadn't noticed.</p>

<p>Though I'm not allowed to drink anything brown anymore.  Sigh. That's why
this speech is so boring &mdash; I wrote it under the non-influence.</p>

<p>But back to postmodernism.  Postmodern critics have invented a notation for
using a word and denying its customary meaning at the same time, since most
customary meanings are oppressive to someone or other, and if not, they ought
to be.  Or something like that.</p>

<p>Anyway, I'm going to borrow that notation for my own oppressive purposes,
and strike out a few of these words that don't mean exactly what I want them to
mean.  I hope that doesn't make me a postmodern critic.  Or maybe it does.  As
Humpty Dumpty said, the question is who's to be master, that's all.</p>

<p>So let's start by striking out "unwilling", because there are quite a few
willing people around here.  Or at least willful.</p>

<p>And let's strike out "unknowing" too, because you wouldn't be sitting here
listening to us leaders here tonight if you thought we didn't know anything.
On the other hand, maybe you just came for the jokes...</p>

<p>Now let's strike out the "impossible".  Actually, I hesitate to strike that
one out, because what we're trying to do with Perl is to be all things to all
people, and in the long run that is completely impossible, technically,
socially, and theologically speaking.</p>

<p>But that doesn't stop us from trying.  And who knows, maybe more of it is
possible than we imagine.</p>

<p>We definitely have to strike out ungrateful, because we know many people are
grateful.  Nevertheless, a number of people find it impossible to be grateful,
and we should be working to please them as well.  Love your enemies, and all
that.  Another impossible task.  Or... perhaps the same one.</p>













<p>I like to please people who did not expect to be pleased.  One day when I
was a lot younger than I am now, I performed a piece on my violin.  A lady came
up to me afterward and said, "You know, I don't like the violin.  But I liked
that."</p>

<p>I treasure that sort of compliment, just as I treasure the email messages
that say, "I had given up on computer programming because it wasn't any fun,
and then I discovered Perl."  That's what I mean when I say we should work to
please the people who don't expect to be grateful.</p>

<p>Anyway, back to our Creed here.  I can't see anything wrong with the last
two lines.  In fact, they're directly applicable.</p>

<blockquote><p>We have done so much for so long with so little</p></blockquote>

<p>That's Perl 5.</p>

<blockquote><p>We are now qualified to anything with nothing.</p></blockquote>

<p>That's Perl 6.  I suppose I need to strike that out too, since it doesn't
really exist yet, except in our heads.</p>

<p>Well, maybe that's not such a bad outline after all.  Let's talk a little
more about those things.</p>

<img src="/pub/2003/07/16/graphics/slide10.jpg" width="499" height="375" alt="the unwilling" />

<blockquote><p>We the unwilling</p></blockquote>

<p>Here in the open source community, we're willing to help out, but that's
because we're <em>not</em> willing to put up with the status quo.  And that's
generally due to our inflated sense of Laziness, Impatience, and Hubris.  But
then a really funny thing happens.  A number of us will get together and agree
about something that needs doing because of our Laziness, Impatience, and
Hubris, and then we'll start working on that project with a great deal of
industriousness, patience, and humility, which seem to be the very opposite
qualities to those that motivated us in the first place.</p>

<p>I've tried to figure out a rationale for that, but I've pretty much come to
the conclusion that it's not rational or reasonable.  It's just who we are.
Here's a favorite quotation of mine.</p>

<blockquote><p>"The reasonable man adapts himself to the world; the
unreasonable one persists in trying to adapt the world to himself.  Therefore
all progress depends on the unreasonable man."</p></blockquote>

<p>I think that all of us agree that this is true.  We just can't always agree
on what to be unreasonable about.  Of course, this was written by George
Bernard Shaw, who had his own ideas of the most reasonable ways to be
unreasonable.  This is, after all, the guy who wrote Pygmalion, upon which the
musical My Fair Lady was based, with dear old 'Enry 'Iggins and Eliza Dolit'le
going at each other's throats.  And over linguistics of all things.  Fancy
that.</p>

<p>The only problem with this quote is that it's false.  A lot of progress
comes from unreasonable women.</p>

<p>Well, okay, maybe Shaw meant "he or she" when he only said "he".  Still, if
we're going to please unreasonable people in the twenty-first century, maybe we
need to rewrite it like this:</p>

<img src="/pub/2003/07/16/graphics/slide11.jpg" width="499" height="375" alt="strike out man and him" />

<p>On the other hand, some people are impossible to please.  We should probably
just strike out "George Bernard Shaw" since he's a dead white male.</p>

<img src="/pub/2003/07/16/graphics/slide13.jpg" width="499" height="375" alt="unknowing" />

<blockquote><p>We the unwilling, led by the unknowing</p></blockquote>

<p>That's me all over.  Which is what the bug said after he hit the
windshield.</p>

<p>Or as the bug's friend said, "Bet you don't have the guts to do that
again."</p>

<p>Whether I have the guts to do Perl again is another question.  My guts are
still in sad shape at the moment, according to the doctor...</p>

<p>Anyway, back to "me the unknowing".  I admit that there's an awful lot that
I don't know.  I'd love to tell you how much I don't know, but I don't know
that either.</p>

<p>So I'll have to talk about what I know instead.  If you are so inclined, you
may infer that I am totally oblivious to anything I don't talk about today.</p>













<p>One thing I do know about is the universal architectural diagram.  It looks
like this.</p>

<p>It doesn't have to be chartreuse.  How about pink, to match the fireworks up
in the corner.  I put the fireworks up in the corner there in case you missed
the fireworks on the 4th of July.</p>

<img src="/pub/2003/07/16/graphics/slide14.jpg" width="499" height="375" alt="pink" />

<p>Anyway, this is the universal architectural diagram because you can
represent almost any architecture with it, if you try hard enough.  Here's a
common enough one:</p>

<img src="/pub/2003/07/16/graphics/slide15.jpg" width="499" height="375" alt="CPU" />

<p>Here we have a bus that's common across the other three components of our
computer, the memory, the CPU, and the I/O system.  Within the computer we have
other entities such as strings, which you can view either as a whole or as a
sequence of characters.</p>

<img src="/pub/2003/07/16/graphics/slide16.jpg" width="499" height="375" alt="string" />

<p>An integer is just like a string, only it's a sequence of bits.</p>

<img src="/pub/2003/07/16/graphics/slide17.jpg" width="499" height="375" alt="integer" />

<p>We can go from very small ideas like integers to very large ideas like
government:</p>

<img src="/pub/2003/07/16/graphics/slide18.jpg" width="499" height="375" alt="government" />

<p>Or even alternate forms of government.</p>

<img src="/pub/2003/07/16/graphics/slide19.jpg" width="499" height="375" alt="Borg" />













<p> The diagram is even more versatile because you can rotate it on its
side.</p>

<img src="/pub/2003/07/16/graphics/slide20.jpg" width="499" height="375" alt="plain" />

<img src="/pub/2003/07/16/graphics/slide21.jpg" width="499" height="375" alt="right" />

<p>Now, for some reason, this particular orientation seems to engender the most
patriotism.  It might just be accidental, but if you color it like this</p>

<img src="/pub/2003/07/16/graphics/slide22.jpg" width="499" height="375" alt="flag" />

<p>people start thinking about saluting it.  Kinda goes with the fireworks, I
guess.</p>

<p>A little more dangerous is this diagram.</p>

<img src="/pub/2003/07/16/graphics/slide23.jpg" width="499" height="375" alt="object" />

<p>It's amazing how many people will salute that one.  And people will even go
to war for this one:</p>

<img src="/pub/2003/07/16/graphics/slide24.jpg" width="499" height="375" alt="class" />

<p>But you know, the whole notion of objects like this is that there are ways
in which you treat them as a single thing, and ways in which you treat them as
multiple things.  Every structured object is wrapped up in its own identity.
That's really what this little diagram is getting at.</p>

<p>Well, let's keep rotating it and see what we get.</p>

<img src="/pub/2003/07/16/graphics/slide26.jpg" width="499" height="375" alt="rotate" />

<img src="/pub/2003/07/16/graphics/slide27.jpg" width="499" height="375" alt="God" />

<p>Okay, if you happen to be a Christian of the trinitarian persuasion like me,
then you believe that God is a structured object that is simultaneously
singular and plural depending on how you look at it.  Of course, nobody ever
fights about that sort of thing, right?</p>













<img src="/pub/2003/07/16/graphics/slide28.jpg" width="499" height="375" alt="plain" />

<img src="/pub/2003/07/16/graphics/slide29.jpg" width="499" height="375" alt="left" />

<p>It's kind of unusual to see the diagram in this orientation, probably due to
linguistic considerations.</p>

<img src="/pub/2003/07/16/graphics/slide30.jpg" width="499" height="375" alt="one out of many" />

<p>But whether you say "one out of many" or "e pluribus unum",</p>

<img src="/pub/2003/07/16/graphics/slide31.jpg" width="499" height="375" alt="pluribus" />

<p>it means much the same thing.  In a language that reads left to right,
perhaps it's more naturally suited to processes that lose information, such as
certain kinds of logic.</p>

<img src="/pub/2003/07/16/graphics/slide32.jpg" width="499" height="375" alt="or" />

<p>Again, we can go from the very small to the very large.</p>

<img src="/pub/2003/07/16/graphics/slide33.jpg" width="499" height="375" alt="black hole" />

<p>If you feed three random planets to a black hole, you also lose information.
Or at least you hide it very well, depending on your theory of how black holes
work.</p>

<p>If you feed one of these diagrams to a black hole, it turns into a piece of
spaghetti.</p>

<p>But let's not, and say we did.</p>













<p>Oddly enough, what I'd really like to talk about today is Perl.  If we look
at our goal for the Parrot project, it looks something like this.</p>

<img src="/pub/2003/07/16/graphics/slide37.jpg" width="499" height="375" alt="Borg Parrot" />

<p>Oops, wrong slide.</p>

<img src="/pub/2003/07/16/graphics/slide38.jpg" width="499" height="375" alt="Parrot" />

<p>That is, Parrot is designed to be a single engine upon which we can run both
Perl 5 and Perl 6.  And... stuff.  Admittedly, this is a rather Perl-centric
view of reality, to the extent you can call this reality.</p>

<p>Well, okay, I'll cheat and show you the other stuff we'd like to do.</p>

<img src="/pub/2003/07/16/graphics/slide39.jpg" width="499" height="375" alt="detail" />

<p>We'd also like to support, for example, PHP, Ruby, Python, BASIC, Scheme,
COBOL, Java, Befunge, TECO, Rebol, REXX, and... I can't quite make out that one
on the bottom there.  And if I could, I wouldn't say it anyway, because there
are children present, and I wouldn't want to fuck up their brains.</p>


<p>Okay, I admit this is not quite reality yet.  I just put in all those
languages because I'm a white male who is trying to oppress you before I'm
quite dead.  So I'd better strike out a few things that aren't really there
yet.</p>

<img src="/pub/2003/07/16/graphics/slide40.jpg" width="499" height="375" alt="strikes" />

<p>Could I interest you in a really fast BASIC interpreter?</p>

<img src="/pub/2003/07/16/graphics/slide41.jpg" width="499" height="375" alt="Parrot + BASIC" />

<p>Well, it's time to move on to our next point.</p>

<img src="/pub/2003/07/16/graphics/slide42.jpg" width="499" height="375" alt="impossible" />

<blockquote><p>We the unwilling, led by the unknowing, are doing the
impossible.</p></blockquote>

<p>Is what we're doing really impossible?  It's possible.  But we won't know
till we try.  More precisely, till we finish trying.  Sometimes things seem
impossible to us, but maybe that's just because we're all slackers.</p>

<p>And because we oversimplify. </p>













<p>Let's take another look at the pink tennis court.  I mean, the universal
architectural diagram.  It really isn't quite as universal as I've made it out
to be.  First, let's get rid of the pink.</p>

<img src="/pub/2003/07/16/graphics/slide43.jpg" width="499" height="375" alt="black" />

<p>Maybe I should give equal time to blue.</p>

<img src="/pub/2003/07/16/graphics/slide44.jpg" width="499" height="375" alt="blue" />

<p>Nah.</p>

<img src="/pub/2003/07/16/graphics/slide43.jpg" width="499" height="375" alt="black" />

<p>Anyway, as I was saying, this isn't universal enough.  Here's the real
universal diagram.</p>

<img src="/pub/2003/07/16/graphics/slide46.jpg" width="499" height="375" alt="line widget" />

<p>This is what's known as an impossible object.  I like it.  I'm impossible
object oriented.  This particular impossible object is often called a widget.
But you knew that already.</p>

<p>What you might not have known is that, up till now, it's been thought
impossible to color such an object accurately.  But as you can see,</p>

<img src="/pub/2003/07/16/graphics/slide47.jpg" width="499" height="375" alt="colorized" />

<p>that is false.  There are still some perceptual difficulties with it, but
I'm sure <em>that</em> problem is just a relic of our reptile brain.  Or was it our
bird brain.  I forget.  In any event, if you have trouble perceiving this
object correctly, just use the universal clarification tool.</p>

<img src="/pub/2003/07/16/graphics/slide48.jpg" width="499" height="375" alt="cloud" />

<p>I'll assume you can supply your own cloud from now on.</p>

<p>Should be easy here in Portland... I'm allowed to make jokes about Portland
because I grew up in the Pacific Northwet.</p>













<p>As you can see, this more accurate universal architectural diagram can
actually be rotated in 3-d with properly simulated lighting.</p>

<img src="/pub/2003/07/16/graphics/slide49.jpg" width="499" height="375" alt="rotate" />
<img src="/pub/2003/07/16/graphics/slide50.jpg" width="499" height="375" alt="rotate" />
<img src="/pub/2003/07/16/graphics/slide51.jpg" width="499" height="375" alt="rotate" />
<img src="/pub/2003/07/16/graphics/slide52.jpg" width="499" height="375" alt="rotate" />

<p>It's extensible.</p>

<img src="/pub/2003/07/16/graphics/slide53.jpg" width="499" height="375" alt="6comb" />

<img src="/pub/2003/07/16/graphics/slide54.jpg" width="499" height="375" alt="12comb" />

<p>Comb structures are important in a programming language.  That's why we're
adding a switch statement to Perl 6.</p>

<p>It's also a more accurate representation of Parrot.</p>

<img src="/pub/2003/07/16/graphics/slide55.jpg" width="499" height="375" alt="parrot" />













<p>It's also more sophisticated linguistically.</p>

<img src="/pub/2003/07/16/graphics/slide56.jpg" width="499" height="375" alt="widget" />

<p>Not only can it represent singular and plural concepts, but also the 
    old Indo-European notion of dual objects.</p>

<p>We still have vestiges of that in English.</p>

<img src="/pub/2003/07/16/graphics/slide57.jpg" width="499" height="375" alt="oxen" />

<p>One ox, many oxes, two oxen yoked together pulling your plow.</p>

<img src="/pub/2003/07/16/graphics/slide58.jpg" width="499" height="375" alt="regexen" />

<p>Or one regex, many regexes, but two regexen working together.</p>

<img src="/pub/2003/07/16/graphics/slide59.jpg" width="499" height="375" alt="Vaxen" />

<p>You always wanted to know the proper name for a two-headed Vax?</p>

<p>Everything is possible.  You should be grateful.</p>

<img src="/pub/2003/07/16/graphics/slide60.jpg" width="499" height="375" alt="ungrateful" />

<p>On to the ungrateful undead.</p>

<p>There's been a lot of carping lately about how slow Perl 6 development is
going.  Some of it comes from well intentioned folks, but some of it comes from
our poison pen pals who live in the troll house.  Still, I think a lot of the
criticism shows a lack of understanding of the basic laws of development.
These laws can be illustrated with this diagram:</p>

<img src="/pub/2003/07/16/graphics/slide61.jpg" width="499" height="375" alt="widget" />

<p>Basically, perfect development is impossible.  Development can be fast,
good, and cheap.  Pick two.</p>

<p>Actually, that's unrealistic. </p>

<p>Pick one.</p>

<p>Which one would you pick?  You want fast?  You want cheap?  No, I think you
want this one.</p>

<p>Good.</p>













<p>Good design is neither fast nor cheap.  Every time we crank out a new chunk
of the design of Perl 6 or of Parrot, it's a bit like writing a master's
thesis.  It's a lot of reading, and a lot of writing, and a lot of thinking,
and a lot of email, and a lot of phone conferences.  It's really complicated
and multidimensional.</p>

<img src="/pub/2003/07/16/graphics/slide62.jpg" width="499" height="375" alt="escher" />

<p>There's a lot going on behind the scenes that you don't hear about every
day.  Many people have sacrificed to give us time to work on these things.
People have donated their own time and money to it.  O'Reilly and Associates
have donated phone conferences and other infrastructure.  The Perl 6 design
team in particular has borne a direct financial cost but also a tremendous
opportunity cost in pursuing this at the expense of career and income.  I'm not
looking for sympathy, but I want you to know that I almost certainly could have
landed a full-time job 20 months ago if I'd been willing to forget about Perl
6.  I'm extremely grateful for the grants the Perl Foundation has been able to
give toward the Perl 6 effort.  But I just want you to know that it's costing
us more than that.</p>

<p>But Perl 6 is all about freedom, and that's why we're willing to pledge our
lives, our fortunes, and our sacred honor.</p>

<p>Times are tough, and I'm not begging for more sacrifice from you good folks.
I just want to give a little perspective, and fair warning that at some point
soon I'm going to have to get a real job with real health insurance because I
can't live off my mortgage much longer.  It's bad for my ulcer, and it's bad
for my family.</p>

<p>Fortunately, the basic design of Perl 6 is largely done, appearances to the
contrary notwithstanding.  Damian and I will be talking about that in the Perl
6 session later in the week.</p>

<p>Well, enough ranting.  I don't want to sound ungrateful myself, because I'm
not.  In any event, the last three years have been extremely exciting, and I
think the coming years will be just as interesting.</p>

<p>In particular, I have a great announcement to make at the end of my talk
about what's going to be happening next.  But let me explain a bit first what's
happened, again using our poor, abused widget.</p>

<img src="/pub/2003/07/16/graphics/slide63.jpg" width="499" height="375" alt="implementations" />

<p>In this case, time is flowing in the upward direction.</p>

<p>Originally we just had one implementation of Perl, and the general
perception as we started developing Perl 6 was that we were going to have two
implementations of Perl.</p>

<p>But in actual fact, we're going to have at least three implementations of
Perl.</p>

<p>First, the good old Perl 5 that's based on C,  And on the right, the Perl 6
that's based on Parrot.  But there in the middle is a Perl5 that is also based
on Parrot.</p>

<img src="/pub/2003/07/16/graphics/slide64.jpg" width="499" height="375" alt="ellipses" />

<p>Note that the left two are the same language, while the right two share the
same platform.</p>

<p>So what's that Perl 5 doing there in the middle?  If you've been following
Perl 6 development, you'll know that from the very beginning we've said that
there has to be a migration strategy, and that that strategy has two parts.
First, we have to be able to translate Perl 5 to Perl 6.  If that were all of
it, we wouldn't need the middle Perl there.  But not only do people need to be
able to translate from Perl 5 to Perl 6, it is absolutely crucial that they be
allowed to do it piecemeal.  You can't translate a complicated set of modules
all at once and expect them to work.  Instead, we want people to be able to run
some of their modules in Perl 5, and others in Perl 6, all under the same
interpreter.</p>

<p>So that's one good reason to have a Perl 5 compiler for Parrot.  Another
good reason is that we expect Perl 5 to run faster on Parrot, by and large.</p>

<img src="/pub/2003/07/16/graphics/slide65.jpg" width="499" height="375" alt="hands" />

<p>Yet another reason is that we have a little bootstrapping issue with the
Perl 6 grammar.  The Perl 6 grammar is defined in Perl 6 regexes.  But those
regexes are parsed with the Perl 6 grammar.  Catch 22.  The solution to this
involves two things.  First, a magical module of Damian's that translates Perl
6 regexes back into Perl 5 regexes.  Second, a Perl 5 regex interpreter to run
those regexes.  Now, it'd be possible to do it with old Perl 5, but it'll be
cleaner to run it with the new Perl 5 running on Parrot.</p>

<img src="/pub/2003/07/16/graphics/slide66.jpg" width="499" height="375" alt="widget" />













<p>Now, it's awfully cumbersome to keep saying "Perl 5 over Parrot" and such,
so we need to do some namespace cleanup here.  We can drop the "over Parrot"
for Perl 6, because that's redundant.</p>

<img src="/pub/2003/07/16/graphics/slide67.jpg" width="499" height="375" alt="drop parrot" />

<p>Likewise, people always think of the original when we say "Perl 5".</p>

<img src="/pub/2003/07/16/graphics/slide68.jpg" width="499" height="375" alt="drop C" />

<p>That means we need a code name for this thing in the middle.  We've decided
to call it "Ponie".</p>

<img src="/pub/2003/07/16/graphics/slide69.jpg" width="499" height="375" alt="Ponie" />

<p>We have lots of reasons to call it that.  To be sure, none of them are
<em>good</em> reasons, but I'm told it will make the London.pm'ers deliriously happy
if I say, "I want a Ponie".</p>

<p>And I do want a Ponie.  "I want the Ponie, I want the whole Ponie.  I want
it now."</p>

<img src="/pub/2003/07/16/graphics/slide71.jpg" width="499" height="375" alt="versions" />

<p>The plan is to for Ponie version 5.10 to be a drop-in replacement for Perl
5.10.  Eventually there will be a Ponie 5.12, and if Ponie is good enough,
there may not be an old-fashioned 5.12.  We'll just stop with 5.10.</p>

<p>So we're gonna start on Ponie right now.  Since I've been carping about lack
of resources, you might wonder how we're gonna do this.</p>

<p>Well, as it happens, a nice company called Fotango has a lot of Perl 5 code
they want to run on Parrot, and they are clued enough to have authorized one of
their employees, our very own Arthur Bergman, to spend company time porting
Perl 5 to Parrot.</p>

<p>Is that cool or what?  I'm out of time, so read the press release.  But I'm
really excited by our vision for the future, and if you're not excited, maybe
you need to have your vision checked.</p>

<img src="/pub/2003/07/16/graphics/slide72.jpg" width="499" height="375" alt="vision" />

<p>Thanks for listening, and I hope that from now on you'll all be completely
unreasonable.</p>

        </div>



    </div>
    <div class="asset-footer"></div>
</div>


                            
                            <div id="entry-1164" class="entry-asset asset hentry">
    <div class="asset-header">
        <h2 class="asset-name entry-title"><a href="/pub/2003/07/15/nocode.html" rel="bookmark">How to Avoid Writing Code</a></h2>
        <div class="asset-meta">
            <span class="byline">
    
                By <span class="vcard author">Kake Pugh</span> on <abbr class="published" title="2003-07-15T00:00:00-08:00">July 15, 2003 12:00 AM</abbr>
    
            </span>

            
            

        </div>
    </div>
    <div class="asset-content entry-content">

        <div class="asset-body">
            
<!-- sidebar begins -->
<!-- don't move sidebars -->
<!-- sidebar ends -->

<br clear="all" />
<csperl file="grab" domain="on" record="sc/1848" field="html" />

<p>One of the most boring programming tasks in the world has to be
pulling data out of a database and displaying it on a web site. Yet
it's also one of the most ubiquitous. Perl programmers being lazy,
there are tools to help make boring programming tasks less painful, and two of these tools, <code>Class::DBI</code> and the
<code>Template</code> Toolkit, create a whole which is far more
drudgery-destroying than its parts.</p>

<p>Both these tools can do more complicated stuff than that described in
this article, but my aim is to motivate people who may not have tried
them out to give them a go and see how much work they can save you for
even simple tasks.</p>

<p>I've assumed that you know the basics of designing a database--why
you have several tables and <code>JOIN</code> them rather than putting everything in the same table. I've also assumed that you're not allergic to reading documentation, so I'm going to spend more space on
saying <em>why</em> I use particular features of the modules rather
than explaining exactly <em>how</em> they work.</p>

<h3>Synergy</h3>

<p>The reason that <code>Class::DBI</code> and the
<code>Template</code> Toolkit work so well together is simple. 
<code>Template</code> Toolkit templates can call methods on objects
passed to them--so there's no need to explicitly pull every column
out of the database before you process the template--and
<code>Class::DBI</code> saves you the bother of writing methods to
retrieve database columns. You're essentially going straight from the
database to HTML with only a very small amount of Perl in the middle.</p>

<p>Suppose you're writing a web application to store details of books and
their authors, and reviews of the books by users of the site. You'd
like to have a page that displays all the books in your database and,
for each book, offers links to all the reviews already written. With
suitably set-up classes you can write a couple of lines of Perl:</p>

<pre><code>  #!/usr/bin/perl -w
  use strict;

  use Bookworms::Book;
  use Bookworms::Template;

  my @books = Bookworms::Book->retrieve_all;
  @books = sort { $a->title cmp $b->title } @books;
  print Bookworms::Template->output( template => "book_list.tt",
                                     vars     => { books => \@books } );
</code></pre>

<p>hand your designer a simple template to pretty up:</p>

<pre><code>  [% page_title = "List all books" %]
  [% INCLUDE header.tt %]

    &lt;ul&gt;
      [% FOREACH book = books %]
        &lt;li&gt;[% book.title %] ([% book.author.name %])
            [% FOREACH review = book.reviews %]
              (&lt;a href="review.cgi?review=[% review.uid %]"&gt;Read review 
			  by [% review.reviewer.name %]&lt;/a&gt;)
            [% END %]
        &lt;/li&gt;
      [% END %]
    &lt;/ul&gt;

  [% INCLUDE footer.tt %]
</code></pre>

<p>and your task is done. You don't have to explicitly select the
reviews; you don't have to then cross-reference to another table to
find out the reviewer's name; you don't have to mess with
HERE-documents or fill your program with print statements. You hardly
have to do anything.</p>

<p>Except of course, write the <code>Bookworm::*</code> classes in the
first place, but that's easy.</p>

<h3>Simple, Small Classes</h3>

<p>For convenience, we write a class containing all the SQL needed to set
up our database schema. This is very useful for running tests as well
as for deploying a new install of the application.</p>

<pre><code>  package Bookworm::Setup;
  use strict;
  use DBI;

  # Hash for table creation SQL - keys are the names of the tables,
  # values are SQL statements to create the corresponding tables.
  my %sql = (
      author => qq {
          CREATE TABLE author (
              uid   int(10) unsigned NOT NULL auto_increment,
              name  varchar(200),
              PRIMARY KEY (uid)
          )
      },
      book => qq{
          CREATE TABLE book (
              uid           int(10) unsigned NOT NULL auto_increment,
              title         varchar(200),
              first_name    varchar(200),
              author        int(10) unsigned, # references author.uid
              PRIMARY KEY (uid)
          )
      },
      review => qq{
          CREATE TABLE review (
              uid       int(10) unsigned NOT NULL auto_increment,
              book      int(10) unsigned, # references book.uid
              reviewer  int(10) unsigned, # references reviewer.uid
              PRIMARY KEY (uid)
          )
      },
      reviewer => qq{
          CREATE TABLE review (
              uid   int(10) unsigned NOT NULL auto_increment,
              name  varchar(200),
              PRIMARY KEY (uid)
          )
      }
  );
</code></pre>

This class has a single method that sets up a database conforming to
the schema above. Here's the rendered POD for it; the implementation
is pretty simple. The "force_clear" option is very useful for testing.

<pre><code>    setup_db( dbname      => 'bookworms',
              dbuser      => 'username',
              dbpass      => 'password',
              force_clear => 0            # optional, defaults to 0
            );

  Sets up the tables. Unless "force_clear" is supplied and set to a
  true value, any existing tables with the same names as we want to
  create will be left alone, whether or not they have the right
  columns etc. If "force_clear" is true, then any tables that are "in
  the way" will be removed. _Note that this option will nuke all your
  existing data._

  The database user "dbuser" must be able to create and drop tables in
  the database "dbname".

  Croaks on error, returns true if all OK.
</code></pre>

<p>Now, another class to wrap around the <code>Template</code> Toolkit;
we want to grab global variables like the name of the site, and so on,
from a config class. (There are plenty of config modules on CPAN;
you're bound to find one you like. I quite like
<code>Config::Tiny</code>; other people swear by
<code>AppConfig</code>--and since the latter is a prerequisite of the
<code>Template</code> Toolkit, you'll have it installed already.) 
<code>Bookworms::Config</code> is just a little wrapper class around
<code>Config::Tiny</code>, so if I change to a different config method
later I don't have to rewrite lots of code.</p>

<pre><code>  package Bookworms::Template;
  use strict;
  use Bookworms::Config;
  use CGI;
  use Template;

  # We have one method, which returns everything you need to send to
  # STDOUT, including the Content-Type: header.

  sub output {
      my ($class, %args) = @_;

      my $config = Bookworms::Config->new;
      my $template_path = $config->get_var( "template_path" );
      my $tt = Template->new( { INCLUDE_PATH => $template_path } );

      my $tt_vars = $args{vars} || {};
      $tt_vars->{site_name} = $config->get_var( "site_name" );

      my $header = CGI::header;

      my $output;
      $tt->process( $args{template}, $tt_vars, \$output)
          or croak $tt->error;
      return $header . $output;
  }
</code></pre>

<p>Now we can start writing the classes to manage our database tables. 
Here's the class to handle book objects:</p>

<pre><code>  package Bookworms::Book;
  use base 'Bookworms::DBI';
  use strict;

  __PACKAGE__->set_up_table( "book" );
  __PACKAGE__->has_a( author => "Bookworms::Author" );
  __PACKAGE__->has_many( "reviews",
                         "Bookworms::Review" => "book" );

  1;
</code></pre>

<p>Yes, that's all you need. This simple class, by its ultimate
inheritance from <code>Class::DBI</code>, has auto-created
constructors and accessors for every aspect of a book as defined in
our database schema. And moreover, because we've told it (using
<code>has_a</code>) that the <code>author</code> column in the
<code>book</code> table is actually a foreign key for the primary key
of the table modeled by <code>Bookworms::Author</code>, when we use
the <code>->author</code> accessor we actually get a
<code>Bookworms::Author</code> object, which we can then call methods
on:</p>

<pre><code>  my $hobbit = Bookworms::Book->search( title => "The Hobbit" );
  print "The Hobbit was written by " . $hobbit->author->name;
</code></pre>

<p>There are a couple of supporting classes that we need to write, but
they're not complicated either.</p>

<p>First a base class, as with all <code>Class::DBI</code>
applications, to set the database details:</p>

<pre><code>  package Bookworms::DBI;
  use base "Class::DBI::mysql";

  __PACKAGE__->set_db( "Main", "dbi:mysql:bookworms", 
    "username", "password" );

  1;
</code></pre>

<p>Our base class inherits from <code>Class::DBI::mysql</code> instead
of plain <code>Class::DBI</code>, so we can save ourselves the trouble
of directly specifying the table columns for each of our database
tables--the database-specific base classes will auto-create a
<code>set_up_table</code> method to handle all this for you.</p>

<p>At the time of writing, base classes for MySQL, PostgreSQL, Oracle,
and SQLite are available on CPAN. There's also
<code>Class::DBI::BaseDSN</code>, which allows you to specify the
database type at runtime.</p>

<p>We'll also want a class for each of the author, review, and reviewer
tables, but these are even simpler than the <code>Book</code> class. 
For example, the author class could be as trivial as:</p>

<pre><code>  package Bookworms::Author;
  use base 'Bookworms::DBI';
  use strict;

  __PACKAGE__->set_up_table( "author" );

  1;
</code></pre>

<p>If we wanted to be able to access all the books by a given author, we
could add the single line</p>

<pre><code>  __PACKAGE__->has_many( "books",
                         "Bookworms::Book" => "author" );
</code></pre>

<p>and an accessor to return an array of <code>Bookworms::Book</code>
objects would be automatically created, to be used like so:</p>

<pre><code>  my $author = Bookworms::Author->search( name => "J K Rowling" );
  my @books = $author->books;
</code></pre>

<p>Or indeed:</p>

<pre><code>  &lt;h1&gt;[% author.name %]&lt;/h1&gt;

  &lt;ul&gt;
    [% FOREACH book = author.books %]
      &lt;li&gt;[% book.title %]&lt;/li&gt;
    [% END %]
  &lt;/ul&gt;
</code></pre>

<p>Simple, small, almost trivial classes, taking a minute or two each
to write.</p>

<csperl file="grab" domain="on" record="b/2705" template="b/article_sidebar_pdf.view" />













<h3>What Does This Get Me?</h3>

<p>The immediate benefits of all this are obvious:</p>

<ul>
  <li>You don't have to mess about with HTML, since the very simplistic
      use of the <code>Template</code> Toolkit means that templates are
      comprehensible to competent web designers.</li>

  <li>You don't have to maintain classes full of copy-and-paste code,
      since the repetitive programming tasks like creating constructors and
      simple accessors are done for you.</li>
</ul>

<p>A large hidden benefit is testing. Since the actual CGI scripts--which
can be a pain to test--are so simple, you can concentrate most of your
energy on testing the underlying modules.</p>

<p>It's probably worth writing a couple of simple tests to make sure that
you've set up your classes the way you intended to, particularly in
your first couple of forays into <code>Class::DBI</code>.</p>

<pre><code>  use Test::More tests => 5;
  use strict;

  use_ok( "Bookworms::Author" );
  use_ok( "Bookworms::Book" );
  my $author = Bookworms::Author->create({ name => "Isaac Asimov" });
  isa_ok( $author, "Bookworms::Author" );
  my $book = Bookworms::Book->create({ title  => "Foundation",
                                       author => $author });
  isa_ok( $book, "Bookworms::Book" );
  is( $book->author->name, "Isaac Asimov", "right author" );
</code></pre>

<p>However, the big testing win with this technique of separating out
the heavy lifting from the CGI scripts into modules is when you'd like
to add something more complicated. Say, for example, fuzzy matching. 
It's well known that people can't spell, and you'd like someone typing
in &quot;Isaac Assimov&quot; to find the author they're looking for. 
So, let's process the author names as we create the author objects,
and store some kind of canonicalized form in the database.</p>

<p><code>Class::DBI</code> allows you to define &quot;triggers&quot;--methods that are called at given points during the lifetime of an
object. We'll want to use an <code>after_create</code> trigger, which
is called after an object has been created and stored in the database. 
We use this in preference to a <code>before_create</code> trigger,
since we want to know the uid of the object, and this is only created
(via the auto_increment primary key) once the object has been written
to the database.</p>

<p>We use <code>Search::InvertedIndex</code> to store the
canonicalized names, for quick access. We start with a very simple
canonicalization--stripping out vowels and collapsing repeated
letters. (I've found that this can pick up about half of name
misspellings found in the wild, which is pretty impressive.)</p>

<p>We'll write a couple of tests before we move on to code. Here are some
that check that our class is doing what we told it to--removing
vowels and collapsing repeated consonants.</p>

<pre><code>  use Test::More tests => 2;
  use strict;

  use Bookworms::Author;

  my $author = Bookworms::Author->create({ name => "Isaac Asimov" });
  my @matches = Bookworms::Author->fuzzy_match( name => "asemov" );
  is_deeply( \@matches, [ $author ], 
    "fuzzy matching catches wrong vowels" );
  @matches = Bookworms::Author->fuzzy_match( 
    name => "assimov" );
  is_deeply( \@matches, [ $author ], 
    "fuzzy matching catches repeated letters" );
</code></pre>

<p>We should also write some other tests to run our algorithms over
various misspellings that we've captured from actual users, to give an
idea of whether &quot;what we told our class to do&quot; is the right
thing.</p>

<p>Here's the first addition to the <code>Bookworms::Author</code>
class, to store the indexed data:</p>

<pre><code>  use Search::InvertedIndex;

  my $database = Search::InvertedIndex::DB::Mysql->new(
                     -db_name    => "bookworms",
                     -username   => "username",
                     -password   => "password",
                     -hostname   => "",
                     -table_name => "sii_author",
                     -lock_mode  => "EX"
    ) or die "Couldn't set up db";

  my $map = Search::InvertedIndex->new( -database => $database )
    or die "Couldn't set up map";
  $map->add_group( -group => "author_name" );

  __PACKAGE__->add_trigger( after_create => sub {
      my $self = shift;
      my $update = Search::InvertedIndex::Update->new(
          -group => "author_name",
          -index => $self->uid,
          -data  => $self->name,
           -keys  => { map { $self->_canonicalise($_) => 1 }
                       split(/\s+/, $self->name)
                     }
          );
          $map->update( -update => $update );
      }
  } );

  sub _canonicalise {
      my ($class, $word) = @_;
      return "" unless $word;
      $word = lc($word);
      $word =~ s/[aeiou]//g;    # remove vowels
      $word =~ s/(\w)\1+/$1/eg; # collapse doubled 
                                # (or tripled, etc) letters
      return $word;
  }
</code></pre>

<p>(We'll also want similar triggers for <code>after_update</code> and
<code>after_delete</code>, in order that our indexing is kept up to
date with our data.)</p>

<p>Then we can write the fuzzy_matching method:</p>

<pre><code>  sub fuzzy_match {
      my ($class, %args) = @_;
      return () unless $args{name};
      my @terms = map { $class->_canonicalise($_) => 1 }
                        split(/\s+/, $args{name});
      my @leaves;
      foreach my $term (@terms) {
          push @leaves, Search::InvertedIndex::Query::Leaf->new(
              -key   => $term,
              -group => "author_name" );
      }

      my $query = Search::InvertedIndex::Query->new( -logic => 'and',
                                                     -leafs => \@leaves );
      my $result = $map->search( -query => $query );

      my @matches;
      my $num_results = $result->number_of_index_entries || 0;
      if ( $num_results ) {
          for my $i ( 1 .. $num_results ) {
              my ($index, $data) = $result->entry( -number => $i - 1 );
              push @matches, $data;
          }
      }

      return @matches;
  }
</code></pre>

<p>(The matching method can be improved. I've found that neither
<code>Text::Soundex</code> nor <code>Text::Metaphone</code> are much
of an improvement over the simple approach already detailed, but
<code>Text::DoubleMetaphone</code> is definitely worth plugging in, to
catch misspellings such as Nicolas/Nicholas and Asimov/Azimof.)</p>

<p>There are plenty of other features that our little web application
would benefit from, but I shall leave those as an exercise for the
reader. I hope I've given you some insight into my current preferred
web development techniques--and I'd love to see a finished
<code>Bookworms</code> application if it does scratch anyone's
itch.</p>

<h3>See Also</h3>

<ul>
  <li><a href="http://search.cpan.org/author/TMTM/Class-DBI/"><code>Class::DBI</code></a></li>
  <li><a href="http://search.cpan.org/author/ABW/Template-Toolkit/">The <code>Template</code> Toolkit</a></li>
  <li><a href="http://search.cpan.org/author/SNOWHARE/Search-InvertedIndex/"><code>Search::InvertedIndex</code></a></li>
  <li><a href="http://search.cpan.org/author/MAURICE/Text-DoubleMetaphone/"><code>Text::DoubleMetaphone</code></a></li>
</ul>



        </div>



    </div>
    <div class="asset-footer"></div>
</div>


                            
                            <div id="entry-1154" class="entry-asset asset hentry">
    <div class="asset-header">
        <h2 class="asset-name entry-title"><a href="/pub/2003/06/p6pdigest/20030713.html" rel="bookmark">This week on Perl 6, week ending 2003-07-13</a></h2>
        <div class="asset-meta">
            <span class="byline">
    
                By <span class="vcard author">Piers Cawley</span> on <abbr class="published" title="2003-07-13T00:00:00-08:00">July 13, 2003 12:00 AM</abbr>
    
            </span>

            
            

        </div>
    </div>
    <div class="asset-content entry-content">

        <div class="asset-body">
            <p>Welcome once again to the Perl 6 Summary, in a week of major developments
and tantalizing hints.  We start, as usual, with what's happening in
perl6-internals:</p>

<h4>Targeting Parrot from GCC</h4>

<p>Discussion in the thread entitled 'WxWindows Support / Interfacing
Libraries' centred on writing a Parrot backend to GCC.  (No, I have no idea
what that has to do with the thread subject.) Tupshin Harper, Leo T&ouml;tsch
and Benjamin Goldberg discussed possibilities and potential pit- and pratfalls.
At one point, Tupshin suggested emulating a "more traditional stack-oriented
processor".  I don't think he was joking.</p>

<p> <a href="http://groups.google.com/groups?threadm=3F0C7891.9060603%40tupshin.com">
http://groups.google.com/groups</a></p>

<h4>Timely destruction and <code>TRACE_SYSTEM_AREAS</code></h4>

<p>J&uuml;rgen B&ouml;mmels' Parrot IO rewrite is causing some problems with
garbage collection. (IO handles are the canonical examples of resources that
need timely destruction).</p>

<p>Leo tracked down the source of resource leak to a problem with handles being
found on the C stack. J&uuml;rgen wasn't happy about this (he's not keen on the
stack walking approach to garbage collection). He proposed that we get rid of
the stack walk in favour of some other solution to the infant mortality problem
and offered a few candidates. Leo said that he didn't like walking the C stack,
going so far as to state that "Timely destruction and solving infant mortality
don't play together or are mutually exclusive - in the current approach." Dan
hasn't commented on this yet.</p>

<p> <a href="http://groups.google.com/groups?threadm=200307070855.h678tU603505%40thu8.leo.home">
http://groups.google.com/groups</a></p>

<h4>Parrot is not feature frozen</h4>

<p>There was a certain amount of confusion as some old email with the subject
"Parrot is feature-frozen until Wednesday" made its way into a small number of
inboxes, sowing confusion as it went. Suffice to say that Parrot is not
currently feature frozen, though Steve Fink did say that he was considering a
point release once the imcc/parrot integration was complete. If Dan gets
objects and exceptions finished, then it might even warrant a 0.1.0 version
number rather than 0.0.11.</p>

<p> <a href="http://groups.google.com/groups?threadm=200307071153.h67BrdD12034%40thu8.leo.home">
http://groups.google.com/groups</a></p>

<h4>Perl* Abstraction</h4>

<p>Luke Palmer has "finally" started to implement his Infinity PMC and has
noticed a lot of redundant code in the <code>Perl*</code> classes.  He also
noticed that Parrot doesn't seem to have the distinction between container and
value that has been confusing people on the language list.</p>

<p> <a href="http://groups.google.com/groups?threadm=ygche5yyspa.fsf%40babylonia.flatirons.org">
http://groups.google.com/groups</a></p>

<h4>Fun with ParrotIO</h4>

<p>First, J&uuml;rgen B&ouml;mmels sent in a patch to excise integer file
descriptors from Parrot except when they are managed via ParrotIO PMCs. Leo
applied this.</p>

<p>Clinton Pierce thought that this patch meant that a Win32 bug could be
closed in the Parrot bug database. This sparked a discussion with Leo, and
J&uuml;rgen, but I'm not entirely sure of the status of the bug.</p>

<p> <a href="http://groups.google.com/groups?threadm=rt-22899-60490.17.7794643303328%40rt.perl.org">http://groups.google.com/groups</a></p>

<p> <a href="http://groups.google.com/groups?threadm=200307081114828.SM00133%40localhost">http://groups.google.com/groups</a></p>

<h4>Jako groks basic PMCs</h4>

<p>Gregor N Purdy seems to have started working on Jako again, and checked in
some changes allowing Jako to manipulate PMCs. People agreed that this was
cool.</p>

<p> <a href="http://groups.google.com/groups?threadm=1057700664.16182.2.camel%40borg.focusresearch.com">http://groups.google.com/groups</a></p>

<h4>I want a Ponie!</h4>

<p>The <em><a href="mailto:ponie-dev@perl.org">ponie-dev@perl.org</a></em>
mailing list was announced and I'll be summarizing it as of next week when I've
joined, caught up, and generally recovered from America.</p>

<p>What's Ponie? Ponie is "Perl On New Internal Engine" or, as Thomas
Klausner put it, "A version of Perl 5 that will run on Parrot". Larry announced
Ponie at his OSCON 'State of the Onion' address.</p>

<p>Discussion of Ponie on the perl6-internals list centered on the "What is
ponie?" question, with a certain amount of "Why ponie-dev, not perl6-ponie?"
thrown in for good measure.</p>

<p>Brian Ingerson announced that he'd set up a Ponie Wiki. Leon Brocard pointed
at the use.perl story announcing Ponie. Your summarizer punted on writing a
description of the project himself.</p>

<p> <a href="http://groups.google.com/groups?threadm=20030709175831.D52652-100000%40onion.valueclick.com">http://groups.google.com/groups</a></p>

<p> <a href="http://www.poniecode.org/">http://www.poniecode.org/</a> &mdash;
More on Ponie</p>

<p><a href="http://ponie.kwiki.org/">http://ponie.kwiki.org/</a> &mdash; Ingy's
Ponie Wiki</p>

<p> <a href="http://use.perl.org/article.pl?sid=03/07/09/0237202">http://use.perl.org/article.pl</a>
&mdash; use.perl announcement</p>

<h4>Exceptions!</h4>

<p>Leo T&ouml;tsch checked in the beginnings of an exceptions system. Then he
checked in the beginnings of an events system.</p>

<p> <a href="http://groups.google.com/groups?threadm=3F0D414C.7070302%40nextra.at">http://groups.google.com/groups</a></p>

<p> <a href="http://groups.google.com/groups?threadm=3F0EA7CA.7020404%40nextra.at">http://groups.google.com/groups</a></p>



<h3>Meanwhile, in perl6-language</h3>

<p>There were all of 6 messages, all of them discussing the effects of aliasing
an array slice.</p>

<p> <a href="http://groups.google.com/groups?threadm=20030707080359.A75579%40megazone.bigpanda.com">http://groups.google.com/groups</a></p>

<h4>Perl 6 Rules at OSCON</h4>

<p>No, wait, that should be Perl6::Rules.</p>

<p>For his last talk at OSCON, Damian spoke about Perl6::Rules, his
implementation of Perl 6's rules system in pure Perl 5. Oh boy, was it
tantalizing. He demonstrated <em>working code</em> that supports a large chunk of Perl 6 matching semantics,
complete with handy debugging information, diagnostic dumping and all the other
useful stuff.</p>

<p>When we were all gagging for him to release it to CPAN immediately, he told
us that it wasn't finished yet; that he'd implemented it all during the week of
OSCON, in 700 lines of code; that he was going on holiday for a month once he
got home; and that the module would be completed and released to CPAN as time
and money allowed and would be out by Christmas.</p>

<p>He didn't say which Christmas.</p>

<p>Trust me, we want this. A lot.</p>



<h3>Acknowledgements, Announcements, and Apologies</h3>

<p>Hmm... this summary is later than last week's.  How did that happen?</p>

<p>Thanks to Darren Stalder and Cindy Fry, our kind hosts in Seattle; to Shiro
san for some fantastic sushi on Sunday night; to Jesse Broksmith and Melissa
Cain for being our Seattle native guides; to Ward Cunningham for a lift in his
Jeep and for just being Ward; and to Casey West for reasons I promised not to
go into in the summary.</p>

<p>For months now, I've been half joking about sending me jobs in the last
little bit of this summary, but I really mean it now. If anyone's looking for
an experienced OO Perl programmer and half experienced writer, I'm hunting
work. Please get in touch at the address below.</p>

<p>As ever, if you've appreciated this summary, please consider one or more of
the following options:</p>

<ul>

<li>Send money to the Perl Foundation at <a href="http://donate.perl-foundation.org/">http://donate.perl-foundation.org/</a>
and help support the ongoing development of Perl.</li>

<li>Get involved in the Perl 6 process. The mailing lists are open to all.  <a href="http://dev.perl.org/perl6/">http://dev.perl.org/perl6/</a> and <a href="http://www.parrotcode.org/">http://www.parrotcode.org/</a> are good
starting points with links to the appropriate mailing lists.</li>

<li>Send feedback, flames, money, photographic and writing commissions, or a
cute little iSight to <em><a href="mailto:p6summarizer@bofh.org.uk">p6summarizer@bofh.org.uk</a></em>.</li>

</ul>



        </div>



    </div>
    <div class="asset-footer"></div>
</div>


                            
                            <div id="entry-1162" class="entry-asset asset hentry">
    <div class="asset-header">
        <h2 class="asset-name entry-title"><a href="/pub/2003/07/08/mod_perl.html" rel="bookmark">Integrating mod_perl with Apache 2.1 Authentication</a></h2>
        <div class="asset-meta">
            <span class="byline">
    
                By <span class="vcard author">Geoffrey Young</span> on <abbr class="published" title="2003-07-08T00:00:00-08:00">July  8, 2003 12:00 AM</abbr>
    
            </span>

            
            

        </div>
    </div>
    <div class="asset-content entry-content">

        <div class="asset-body">
            
<!-- sidebar begins -->
<!-- don't move sidebars -->
<!-- sidebar ends -->

<h3>Scratching Your Own Itch</h3>

<p> Some time ago I became intrigued with <a href="ftp://ftp.isi.edu/in-notes/rfc2617.txt">Digest authentication</a>, which
uses the same general mechanism as the familiar Basic authentication scheme but
offers significantly more password security without requiring an SSL
connection. At the time it was really just an academic interest&mdash;while
some browsers supported Digest authentication, many of the more popular ones
did not.  Furthermore, even though the standard Apache distribution came with
modules to support both Basic and Digest authentication, Apache (and thus
mod_perl) only offered an API for interacting with Basic authentication. If you
wanted to use Digest authentication, flat files were the only password storage
medium available. With both of these restrictions, it seemed impractical to
deploy Digest authentication in all but the most limited circumstances.</p>

<p>Fast forward two years. Practically all mainstream browsers now support
Digest authentication, and my interest spawned what is now <a href="http://search.cpan.org/author/geoff/Apache-AuthDigest-0.022/">Apache::AuthDigest</a>,
a module that gives mod_perl 1.0 developers an API for Digest authentication
that is very similar to the Basic API that mod_perl natively supports. The one
lingering problem is probably not surprising&mdash;Microsoft Internet
Explorer. As it turns out, using the Digest scheme with MSIE requires a fully
RFC-compliant Digest implementation, and Apache::AuthDigest was patterned after
Apache 1.3's <code>mod_digest.c</code>, which is sufficient for most browsers
but not MSIE.</p>

<csperl file="grab" domain="on" record="b/832" template="b/article_sidebar.view">

<p>In my mind, opening up Digest authentication through mod_perl still needed
work to be truly useful, namely full RFC compliance to support MSIE. Wading
through RFCs is not how I like to spend my spare time, so I started searching
for a shortcut. Because Apache 2.0 did away with <code>mod_digest.c</code> and
replaced it with the fully compliant <code>mod_auth_digest.c</code>, I was
convinced that there was something in Apache 2.0 I could use to make my life
easier. In Apache 2.1, the development version of the next generation Apache
server, I found what I was looking for.</p>

<p>In this article, we're going to examine a mod_perl module that provides Perl
support for the new authentication provider hooks in Apache 2.1. These
authentication providers make writing Basic authentication handlers easier than
it has been in the past. At the same time, the new provider mechanism opens up
Digest authentication to the masses, making the Digest scheme a real
possibility for filling your dynamic authentication needs. While the material
is somewhat dense, the techniques we will be looking at are some of the most
interesting and powerful in the mod_perl arsenal. Buckle up.</p>

<p>To follow along with <a href="http://www.modperlcookbook.org/~geoff/perl.com/Apache-AuthenHook-2.00_01.tar.gz">the
code</a> in this article, you will need at least mod_perl version 1.99_10,
which is currently only available from CVS. You will also need <a href="http://httpd.apache.org/dev/">Apache 2.1</a>, which is also only
available from CVS. Instructions for obtaining the sources for both can be
found <a href="http://perl.apache.org/docs/2.0/user/install/install.html#Getting_Bleeding_Edge_CVS_Sources">here</a>.
When compiling Apache, keep in mind that the code presented here only works
under the <a href="http://httpd.apache.org/docs-2.0/mpm.html">prefork MPM</a>
&mdash; making it thread-safe is the next step in the adventure.</p>

<h3>Authentication Basics</h3>

<p>Because there is lots of material to cover, we'll skip over the requisite
introductory discussion of HTTP authentication, the Apache request cycle, and
other materials that probably already familiar and skip right to the mod_perl
authentication API. In both mod_perl 1.0 and mod_perl 2.0, the
<code>PerlAuthenHandler</code> represents Perl access to the Apache
authentication phase, where incoming user credentials are traditionally matched
to those stored within the application. A simple <code>PerlAuthenHandler</code>
in mod_perl 2.0 might look like the following.</p>

<pre><code>package My::BasicHandler;

use Apache::RequestRec ();
use Apache::Access ();

use Apache::Const -compile => qw(OK DECLINED HTTP_UNAUTHORIZED);

use strict;

sub handler {
  my $r = shift;

  # get the client-supplied credentials
  my ($status, $password) = $r->get_basic_auth_pw;

  # only continue if Apache says everything is OK
  return $status unless $status == Apache::OK;

  # user1/basic1 is ok
  if ($r->user eq 'user1' &amp;&amp; $password eq 'basic1') {
    return Apache::OK;
  }

  # user2 is denied outright
  if ($r->user eq 'user2') {
    $r->note_basic_auth_failure;
    return Apache::HTTP_UNAUTHORIZED;
  }

  # all others are passed along to the Apache default
  # handler, which reads from the AuthUserFile
  return Apache::DECLINED;
}

1;</code></pre>

<p>Although simple and impractical, this handler illustrates the API nicely.
The process begins with a call to <code>get_basic_auth_pw()</code>, which does
a few things behind the scenes. If a suitable Basic Authorization header is
found, <code>get_basic_auth_pw()</code> will parse and decode the header,
populate the user slot of the request record, and return <code>OK</code> along
with the user-supplied password in clear text. Any value other than
<code>OK</code> should be immediately propagated back to Apache, which
effectively terminates the current request.</p>

<p>The next step in the process is where the real authentication logic resides.
Our handler is responsible for digging out the username from
<code>$r->user()</code> and applying some criteria for determining whether the
user-supplied credentials are acceptable. If they are, the handler simply
returns <code>OK</code> and the request is allowed to proceed. If they are not,
the handler has a decision to make: either call
<code>note_basic_auth_failure()</code> and return
<code>HTTP_UNAUTHORIZED</code> (which is the same as the old
<code>AUTH_REQUIRED</code>) to indicate failure, or return
<code>DECLINED</code> to pass authentication control to the next authentication
handler.</p>

<p>For the most part, the mod_perl API is identical to the API Apache offers to
C module developers. The benefit that mod_perl adds is the ability to easily
extend authentication beyond Apache's default flat-file mechanism to the areas
where Perl support is strong, such as relational databases or LDAP.  However,
despite the versatility and strength programming the authentication phase
offered, I never liked the look and feel of the API.  While in some respects
the process is dictated by the nuances of <a href="ftp://ftp.isi.edu/in-notes/rfc2617.txt">RFC 2617</a> and the HTTP
protocol itself, the interface always struck me as somewhat inconsistent and
difficult for new users to grasp. Additionally, as already mentioned, the API
covers only Basic authentication, which is a real drawback as more and more
browsers support the Digest scheme.</p>

<p>Apparently I wasn't alone in some of these feelings. Apache 2.1 has taken
steps to improve the overall process for module developers. The result is a
new, streamlined API that focuses on a new concept: authentication
providers.</p>

<h3>Authentication Providers in Apache 2.1</h3>

<p>While in Apache 2.0 module writers were responsible for a large portion of
the authentication logic&mdash;calling routines to parse and set
authentication headers, digging out the user from the request record, and so on
&mdash; the new authentication mechanism in Apache 2.1 delegates all HTTP and
RFC logic out to two standard modules. <code>mod_auth_basic</code> handles
Basic authentication and is enabled in the default Apache build. The standard
<code>mod_auth_digest</code>, not enabled by default, handles the very complex
world of Digest authentication.  Regardless of the authentication scheme you
choose to support, these modules are responsible for the details of parsing and
interpreting the incoming request headers, as well as generating properly
formatted response headers.</p>

<p>Of course, managing authentication on an HTTP level is only part of the
story. What <code>mod_auth_basic</code> and <code>mod_auth_digest</code> leave
behind is the job of digging out the server-side credentials and matching them
to their incoming counterpart. Enter authentication providers.</p>

<p>Authentication providers are modules that supply server-side credential
services to <code>mod_auth_basic</code> or <code>mod_auth_digest</code>. For
instance, the default <code>mod_authn_file</code> digs the username and
password out of the flat file specified by the <code>AuthUserFile</code>
directive, similar to the default mechanism in Apache 1.3 and 2.0. An Apache
2.1 configuration that explicitly provides the same flat file behavior as
Apache 2.0 would look similar to the following.</p>

<pre><code>&lt;Location /protected>
  Require valid-user
  AuthType Basic
  AuthName realm1

  AuthBasicProvider file

  AuthUserFile realm1
&lt;/Location></code></pre>

<p>The new part of this configuration is the <code>AuthBasicProvider</code>
directive, which is implemented by <code>mod_auth_basic</code> and used to
specify the provider responsible for managing server-side credentials. There is
also a corresponding <code>AuthDigestProvider</code> directive if you have
<code>mod_auth_digest</code> installed.</p>

<p>While it could seem as though Apache 2.1 is merely adding another directive
to achieve essentially the same results, the shift to authentication providers
adds significant value for module developers: a new API that is far simpler
than before. Skipping ahead to the punch line, programming with new Perl API for
Basic authentication, which follows the Apache API almost exactly, would look
similar to the following.</p>

<pre><code>package My::BasicProvider;

use Apache::Const -compile => qw(OK DECLINED HTTP_UNAUTHORIZED);

use strict;

sub handler {
  my ($r, $user, $password) = @_;

  # user1/basic1 is ok
  if ($user eq 'user1' &amp;&amp; $password eq 'basic1') {
    return Apache::OK;
  }

  # user2 is denied outright
  if ($user eq 'user2') {
    return Apache::HTTP_UNAUTHORIZED;
  }

  # all others are passed along to the next provider
  return Apache::DECLINED;
}

1;</code></pre>

<p>As you can see, not only are the incoming username and password supplied in
the argument list, removing the need for <code>get_basic_auth_pw()</code> and
its associated checks, but gone is the need to call
<code>note_basic_auth_failure()</code> before returning
<code>HTTP_UNAUTHORIZED</code>. In essence, all that module writers need to be
concerned with is validating the user credentials against whatever back-end
datastore they choose. All in all, the API is a definite improvement. To add
even more excitement, the API for Digest authentication looks almost exactly
the same (but more on that later).</p>

<p>Because the new authentication provider approach represents a significant
change in the way Apache handles authentication internally, it is not part of
the stable Apache 2.0 tree and is instead being tested in the development tree.
Unfortunately, until the provider mechanism is backported to Apache 2.0, or an
official Apache 2.2 release, it is unlikely that authentication providers will
be supported by core mod_perl 2.0. However, this does not mean that mod_perl
developers are out of luck&mdash;by coupling mod_perl's native directive
handler API with a bit of XS, we can open up the new Apache provider API to
Perl with ease. The <a href="http://search.cpan.org/search?query=Apache::AuthenHook">Apache::AuthenHook</a>
module does exactly that.</p>

<h3>Introducing Apache::AuthenHook</h3>

<p>Over in the Apache C API, authentication providers have a few jobs to do:
they must register themselves by name as a provider while supplying a callback
interface for the schemes they wish to support (Basic, Digest, or both). In
order to open up the provider API to Perl modules our gateway module
Apache::AuthenHook will need to accomplish these tasks as well.  Both of these
are accomplished at the same time through a call to the official Apache API
function <code>ap_register_provider</code>.</p>

<p>Usually, mod_perl provides direct access to the Apache C API for us. For
instance, a Perl call to <code>$r->get_basic_auth_pw()</code> is proxied off to
<code>ap_get_basic_auth_pw</code>&mdash;but in this case
<code>ap_register_provider</code> only exists in Apache 2.1 and, thus, is not
supported by mod_perl 2.0.  Therefore, part of what Apache::AuthenHook needs to
do is open up this API to Perl. One of the great things about mod_perl is the
ease at which it allows itself to be extended even beyond its own core
functionality.  Opening up the Apache API past what mod_perl allows is
relatively easy with a dash of XS.</p>

<p>Our module opens with <code>AuthenHook.xs</code>, which is used to expose
<code>ap_register_provider</code> through the Perl function
<code>Apache::AuthenHook::register_provider()</code>.</p>

<pre><code>#include "EXTERN.h"
#include "perl.h"
#include "XSUB.h"

#include "mod_perl.h"
#include "ap_provider.h"
#include "mod_auth.h"

...

static const authn_provider authn_AAH_provider =
{
  &amp;check_password,
  &amp;get_realm_hash,
};

MODULE = Apache::AuthenHook    PACKAGE = Apache::AuthenHook

PROTOTYPES: DISABLE

void
register_provider(provider)
  SV *provider

  CODE:

    ap_register_provider(modperl_global_get_pconf(),
                         AUTHN_PROVIDER_GROUP,
                         SvPV_nolen(newSVsv(provider)), "0",
                         &amp;authn_AAH_provider);</code></pre>

<p>Let's start at the top. Any XS module you write will include the first three
header files, while any mod_perl XS extension will require at least
<code>#include "mod_perl.h"</code>. The remaining two included header files are
specific to what we are trying to accomplish&mdash;<code>ap_provider.h</code>
defines the <code>ap_register_provider</code> function, while
<code>mod_auth.h</code> defines the <code>AUTHN_PROVIDER_GROUP</code> constant
we will be using, as well as the <code>authn_provider</code> struct that holds
our callbacks.</p>

<p>Skipping down a bit, we can see our implementation of
<code>Apache::AuthenHook::register_provider()</code>. The <code>MODULE</code>
and <code>PACKAGE</code> declarations place <code>register_provider()</code>
into the <code>Apache::AuthenHook</code> package. Following that is the
definition of the <code>register_provider()</code> function itself.</p>

<p>As you can see, <code>register_provider()</code> accepts a single argument,
a Perl scalar representing the name of the provider to register, making its
usage something akin to the following.</p>

<pre><code>Apache::AuthenHook::register_provider('My::BasicProvider');</code></pre>

<p>The user-supplied name is then used in the call to
<code>ap_register_provider</code> from the Apache C API to register
<code>My::BasicProvider</code> as an authentication provider.</p>

<p>The twist in the process is that our implementation of
<code>ap_register_provider</code> registers Apache::AuthenHook's callbacks (the
<code>check_password</code> and <code>get_realm_hash</code> routines not shown
here) for each Perl provider. In essence, this means that Apache::AuthenHook
will be acting as go-between for Perl providers. Much in the same way that
mod_perl proper is called by Apache for each phase and dispatches to different
<code>Perl*Handlers</code>, Apache::AuthenHook will be called by Apache's
authentication modules and dispatch to the appropriate Perl provider at
runtime.</p>

<p>If this boggles your mind a bit, not to worry, it is only being presented to
give you a feel for the bigger picture and show how easy it is to open up
closed parts of the Apache C API with mod_perl and just a few lines of XS.
However, the fun part of Apache::AuthenHook (and the part that you are more
likely to use in your own mod_perl modules) is handled over in Perl space.</p>













<h4>Setting the Stage</h4>

<p>Now that we have the ability to call <code>ap_register_provider</code>, we
need to link that into the Apache configuration process somehow. What we do not
want to do is replace current <code>PerlAuthenHandler</code> functionality,
since that directive is for inserting authentication handler logic in place of
Apache's defaults.  In our case, we need the default modules to run so they can
call our Perl providers.  Instead, we want to make it possible for Perl modules
to register themselves as authentication providers. While we could have Perl
providers call our new <code>register_provider()</code> function directly,
Apache::AuthenHook chose to make the process transparent, using mod_perl's
directive handler API to call <code>register_provider()</code> silently as
<code>httpd.conf</code> is parsed.</p>

<p>Apache::AuthenHook makes sneaky use of directive handlers to extend the
default Apache <code>AuthBasicProvider</code> and
<code>AuthDigestProvider</code> directives so they register Perl providers
on-the-fly. The net result is that Perl providers will be fully registered and
configured via standard Apache directives, similar to the following.</p>

<pre><code>AuthBasicProvider My::BasicProvider file</code></pre>

<p>At configuration time, Apache::AuthenHook will intercept
<code>AuthBasicProvider</code> and register My::BasicProvider. At request time,
<code>mod_auth_basic</code> will attempt to authenticate the user, first using
My::BasicProvider, followed by the default file provider if My::BasicProvider
declines the request.</p>

<p>A nice side effect to this is that through our implementation we will be
giving mod_perl developers a feature they have never had before&mdash;the
ability to interlace Perl handlers and C handlers within the same phase.</p>

<pre><code>AuthDigestProvider My::DigestProvider file My::OtherDigestProvider</code></pre>

<p>Exciting, no? Let's take a look at <code>AuthenHook.pm</code> and see how
the directive handler API works in mod_perl 2.0.</p>

<h3>Directive Handlers with mod_perl</h3>

<p>Directive handlers are a very powerful but little used feature of mod_perl.
For the most part, their lack of use probably stems from the complex and
intimidating API in mod_perl 1.0. However, in mod_perl 2.0, the API is much
simpler and should lend itself to adoption by a larger audience.</p>

<p>The directive handler API allows mod_perl modules to define their own custom
configuration directives that are understood by Apache, For example, enabling
modules to make use of configuration variables like:</p>

<pre><code>Foo "bar"</code></pre>

<p>in <code>httpd.conf</code> requires only a few relatively simple settings
you can code directly in Perl.</p>

<p>While using directive handlers simply to replace <code>PerlSetVar</code>
behavior might seem a bit flashy, the techniques used by Apache::AuthenHook are
some of the most powerful mod_perl has to offer.</p>

<p>As previously mentioned, we will be extending the new
<code>AuthBasicProvider</code> and <code>AuthDigestProvider</code> directives
to apply to Perl providers as well, silently registering each provider as the
directive itself is parsed. To do this, we redefine these core directives,
manipulate their configuration data, then disappear and allow Apache to handle
the directives as if we were never there.</p>

<p>The code responsible for this is in <code>AuthenHook.pm</code>.</p>

<pre><code>package Apache::AuthenHook;

use 5.008;

use DynaLoader ();

use mod_perl 1.99_10;     # DECLINE_CMD and $parms->info support
use Apache::CmdParms ();  # $parms->info

use Apache::Const -compile => qw(OK DECLINE_CMD OR_AUTHCFG RAW_ARGS);

use strict;

our @ISA     = qw(DynaLoader);
our $VERSION = '2.00_01';

__PACKAGE__->bootstrap($VERSION);

our @APACHE_MODULE_COMMANDS = (
  { name         => 'AuthDigestProvider',
    errmsg       => 'specify the auth providers for a directory or location',
    args_how     => Apache::RAW_ARGS,
    req_override => Apache::OR_AUTHCFG,
    cmd_data     => 'digest' },

  { name         => 'AuthBasicProvider',
    errmsg       => 'specify the auth providers for a directory or location',
    args_how     => Apache::RAW_ARGS,
    req_override => Apache::OR_AUTHCFG,
    func         => 'AuthDigestProvider',
    cmd_data     => 'basic' },
);</code></pre>

<p>At the top of our module we import a few required items, some that are new
and some that should already be familiar. DynaLoader and the
<code>bootstrap()</code> method are required to pull in the
<code>register_provider()</code> function from our XS implementation and,
unlike with mod_perl 1.0, have nothing to do with the actual directive handler
implementation. The Apache::CmdParms class provides the <code>info()</code>
method we will be illustrating shortly, while Apache::Const gives us access to
the constants we will need throughout the process.</p>

<p>The <code>@APACHE_MODULE_COMMANDS</code> array is where the real interface
for directive handlers begins. <code>@APACHE_MODULE_COMMANDS</code> holds an
array of hashes, each of which defines the behavior of an Apache directive.
Let's focus on the first directive our handler implements,
<code>AuthDigestProvider</code>, forgetting for the moment that mod_auth_digest
also defines this directive.</p>

<p>While it should be obvious that the <code>name</code> key specifies the name
of the directive, it is not so obvious that it also specifies the default Perl
subroutine to call when Apache encounters <code>AuthDigestProvider</code> while
parsing <code>httpd.conf</code>.  Later on, we will need to implement the
<code>AuthDigestProvider()</code> subroutine, which will contain the logic for
all the activities we want to perform when Apache sees the
<code>AuthDigestProvider</code> directive.</p>

<p>The <code>args_how</code> and <code>req_override</code> are fields that tell
Apache specifically how the directive is supposed to behave in the
configuration. <code>req_override</code> defines how our directive will
interact with the core <a href="http://httpd.apache.org/docs-2.0/mod/core.html#allowoverride"><code>AllowOverride</code></a>
directive, in our case allowing <code>AuthDigestProvider</code> in
<code>.htaccess</code> files only on directories governed by
<code>AllowOverride AuthConfig</code>. Similarly, <code>args_how</code> defines
how Apache should interact with our <code>AuthDigestProvider()</code>
subroutine when it sees our directive in <code>httpd.conf</code>. In the case
of <code>RAW_ARGS</code>, it means that Apache will pass our callback whatever
follows the directive as a single string. Other possible values for both of
these keys can be found in the documentation pointed to at the end of this
article.</p>

<p>The final important key in our first hash is the <code>cmd_data</code> key,
in which we can store a string of our choosing.  This will become important in
a moment.</p>

<p>The second hash in <code>@APACHE_MODULE_COMMANDS</code> defines the behavior
of the <code>AuthBasicProvider</code> directive, which for the most part is
identical to <code>AuthDigestProvider</code>. The differences are important,
however, and begin with the addition of the <code>func</code> key. Although the
default Perl subroutine callback for handling directives is the same as the
name of the directive, the <code>func</code> key allows us to point to a
different subroutine instead.  Here we will be reusing
<code>AuthDigestProvider()</code> to process both directives. How will we know
which directive is actually being parsed?  The <code>cmd_data</code> slot will
contain <code>digest</code> when processing <code>AuthDigestProvider</code> and
<code>basic</code> when processing <code>AuthBasicProvider</code>.</p>

<p>At this point, we have defined what our directives will look like and how
they will interact with Apache in <code>httpd.conf</code>. What we have not
shown is the logic that sits behind our directives. As we mentioned, both of
our directives will be calling the Perl subroutine
<code>AuthDigestProvider</code>, defined in <code>AuthenHook.pm</code>.</p>

<pre><code>sub AuthDigestProvider {
  my ($cfg, $parms, $args) = @_;

  my @providers = split ' ', $args;

  foreach my $provider (@providers) {

    # if the provider looks like a Perl handler...
    if ($provider =~ m/::/) {

      # save the config for later
      push @{$cfg->{$parms->info}}, $provider;

      # and register the handler as an authentication provider
      register_provider($provider);
    }
  }

  # pass the directive back to Apache "unprocessed"
  return Apache::DECLINE_CMD;
}</code></pre>

<p>The first argument passed to our directive handler callback,
<code>$cfg</code>, represents the configuration object for our module, which we
can populate with whatever data we choose and access again at request time. The
second argument is an Apache::CmdParms object, which we will use to dig out the
string we specified in the <code>cmd_data</code> slot of our configuration hash
using the <code>info()</code> method.</p>

<p>While the first two arguments are standard and will be there for any
directive handler you write, the third argument can vary somewhat. Because we
specified <code>RAW_ARGS</code> as our <code>args_how</code> setting in the
configuration hash, <code>$args</code> contains everything on the
<code>httpd.conf</code> line following our directive. The standard
<code>Auth*Provider</code> directives we are overriding can take more than one
argument, so we split on whitespace and break apart the configuration into an
array of providers, each of which we then process separately.</p>

<p>Each provider is examined using a cursory check to see whether the specified
provider is a Perl provider. If the provider meets our criteria, we call the
<code>register_provider()</code> function defined in <code>AuthenHook.xs</code>
and keep track of the provider by storing it in our <code>$cfg</code>
configuration object.</p>

<p>The final part of our callback brings the entire process together.  The
constant <code>DECLINE_CMD</code> has special meaning to Apache. Just as you
might return <code>DECLINED</code> from a <code>PerlTransHandler</code> to
trick Apache into thinking no translation took place, returning
<code>DECLINE_CMD</code> from a directive handler tricks Apache into thinking
that the directive was unprocessed. So, after our
<code>AuthDigestProvider()</code> subroutine runs, Apache will continue along
until it finds <code>mod_auth_digest</code>, which will then process the
directive as though we were never there.</p>

<p>The one final piece of <code>AuthenHook.pm</code> that we need to discuss is
directive merging. In order to deal properly with situations when directives
meet, such as when <code>AuthBasicProvider</code> is specified in both an
<code>.htaccess</code> file as well as the <code>&lt;Location></code> that
governs the URI, we need to define <code>DIR_CREATE()</code> and
<code>DIR_MERGE()</code> subroutines.</p>

<p><code>DIR_CREATE()</code> is called at various times in the configuration
process, including when <code>&lt;Location></code> and related directives are
parsed at configuration time, as well as whenever an <code>.htaccess</code>
file enters the request cycle. This is where we create the <code>$cfg</code>
object our callback uses to store configuration data. While it is not required,
<code>DIR_CREATE()</code> is a good place to initialize fields in the object as
well, which prevents accidentally dereferencing nonexistent references.</p>

<pre><code>sub DIR_CREATE {
  return bless { digest => [],
                 basic  => [], }, shift;
}</code></pre>

<p><code>DIR_MERGE</code>, generally called at request time, defines how we
handle places where directives collide. The following code is standard for
allowing the current configuration (<code>%$base</code>) to inherit only
missing parameters from higher configurations (<code>%$add</code>), which is
the behavior you are most likely to want.</p>

<pre><code>sub DIR_MERGE {
  my ($base, $add) = @_;

  my %new = (%$add, %$base);

  return bless \%new, ref($base);
}

1;</code></pre>

<p>Thus ends <code>AuthenHook.pm</code>.</p>

<p>The final result is pretty amazing. By secretly intercepting the
<code>AuthDigestProvider</code> directive before <code>mod_auth_digest</code>
has the chance to process it, we have provided an interface that makes the
presence of Apache::AuthenHook all but undetectable. To enable the new provider
mechanism for mod_perl developers, all that is required is to load
Apache::AuthenHook using the new <code>PerlLoadModule</code> directive</p>

<pre><code>PerlLoadModule Apache::AuthenHook</code></pre>

<p>and their Perl providers will be magically inserted into the authentication
phase at the appropriate time.</p>













<h3>Taking a Step Back</h3>

<p>Let's recap what we have accomplished so far. <code>AuthenHook.pm</code>
redefines <code>AuthDigestProvider</code> and <code>AuthBasicProvider</code> so
that any Perl providers listed in the configuration are automagically
registered and inserted into the authentication process. At request time, one
of the default Apache authentication handlers will call on the configured
providers to supply server-side credentials. All registered Perl providers
really point to the callbacks in <code>AuthenHook.xs</code> which have the
arduous task of proxying the request for server-side credentials to the proper
Perl provider.  All in all, Apache::AuthenHook covers lots of ground, even if
the gory details of what happens over in XS land have been left out.</p>

<p>As we mentioned earlier, Apache::AuthenHook not only the ability to write
authentication providers in Perl, but it also follows the Apache API very
closely. While diving deep into the XS code that Apache::AuthenHook uses to
implement the <code>check_password</code> and <code>get_realm_hash</code>
callbacks is far beyond the scope of this article, you may find it interesting
that the callback signature for <code>check_password</code></p>

<pre><code>static authn_status check_password(request_rec *r, const char *user,
                                   const char *password)
{
  ...
}</code></pre>

<p>is practically identical to what Apache::AuthenHook passes on to Perl
providers supporting the Basic authentication scheme.</p>

<pre><code>sub handler {
  my ($r, $user, $password) = @_;

  ...
}</code></pre>

<p>If you recall, we started investigating the Apache 2.1 provider mechanism as
a way to combine the security of the Digest authentication scheme with the
strength of Perl. The signature for the Digest authentication callback,
<code>get_realm_hash</code>, is only slightly different than
<code>check_password</code>.</p>

<pre><code>static authn_status get_realm_hash(request_rec *r, const char *user,
                                   const char *realm, char **rethash)
{
  ...
}</code></pre>

<p>How does this translate into a Perl API? It is surprisingly simple.  As it
turns out, the name <code>check_password</code> is significant&mdash;for
Basic authentication, the provider is expected to take steps to see if the
incoming username and password match the username and password stored on the
server back-end. For Digest authentication, as the name
<code>get_realm_hash</code> might suggest, all a provider is responsible for is
retrieving the hash for a user at a given realm.  <code>mod_auth_digest</code>
does all the heavy lifting.</p>

<h3>Digest Authentication for the People</h3>

<p>While we didn't take the time to explain how Basic authentication over HTTP
actually works, briefly explaining Digest authentication is probably worth the
time, if only to allow you to appreciate the elegance of the new provider
mechanism.</p>

<p>When a request comes in for a resource protected by Digest authentication,
the server begins the process by returning a <code>WWW-Authenticate</code>
header that contains the authentication scheme, realm, a server generated
nonce, and various other bits of information. A fully RFC-compliant
<code>WWW-Authenticate</code> header might look like the following.</p>

<pre><code>WWW-Authenticate: Digest realm="realm1", 
nonce="Q9equ9C+AwA=195acc80cf91ce99828b8437707cafce78b11621", 
algorithm=MD5, qop="auth"</code></pre>

<p>On the client side, the username and password are entered by the end user
based on the authentication realm sent from the server. Unlike Basic
authentication, in which the client transmits the user's password practically
in the clear, Digest authentication never exposes the password over the wire.
Instead, both the client and server handle the user's credentials with care.
For the client, this means rolling up the user credentials, along with other
parts of the request such as the server-generated nonce and request URI, into a
single MD5 hash, which is then sent back to the server via the
<code>Authorization</code> header.</p>

<pre><code>Authorization: Digest username="user1", realm="realm1", 
qop="auth", algorithm="MD5", uri="/index.html",
nonce="Q9equ9C+AwA=195acc80cf91ce99828b8437707cafce78b11621", 
nc=00000001, cnonce="3e4b161902b931710ae04262c31d9307", 
response="49fac556a5b13f35a4c5f05c97723b32"</code></pre>

<p>The server, of course, needs to have its own copy of the user credentials
around for comparison. Now, because the client and server have had (at various
points in time) access to the same dataset&mdash;the user-supplied username
and password, as well as the request URI, authentication realm, and other
information shared in the HTTP headers&mdash;both ought to be able to
generate the same MD5 hash. If the hash generated by the server does not match
the one sent by the client in the <code>Authorization</code> header, the
difference can be attributed to the one piece of information not mutually
agreed upon through the HTTP request: the password.</p>

<p>As you can see from the headers involved, there is quite a lot of
information to process and interpret with the Digest authentication scheme.
However, if you recall, one of the benefits of the new provider mechanism is
that <code>mod_auth_digest</code> takes care of all the intimate details of the
scheme internally, relieving you from the burden of understanding it at
all.</p>

<p>All a Digest provider is required to do is match the incoming user and realm
to a suitable digest, stored in the medium of its choosing, and return it. With
the hash in hand, <code>mod_auth_digest</code> will do all the subsequent
manipulations and decide whether the hash the provider supplied is indeed
sufficient to allow the user to continue on its journey to the resource it is
after.</p>

<p>With that background behind us, we can proceed with a sample Perl Digest
provider.</p>

<pre><code>package My::DigestProvider;

use Apache::Log;

use Apache::Const -compile => qw(OK DECLINED HTTP_UNAUTHORIZED);

use strict;

sub handler {
  my ($r, $user, $realm, $hash) = @_;

  # user1 at realm1 is found - pass to mod_auth_digest
  if ($user eq 'user1' &amp;&amp; $realm eq 'realm1') {
    $$hash = 'eee52b97527306e9e8c4613b7fa800eb';
    return Apache::OK;
  }

  # user2 is denied outright
  if ($user eq 'user2' &amp;&amp; $realm eq 'realm1') {
    return Apache::HTTP_UNAUTHORIZED;
  }

  # all others are passed along to the next provider
  return Apache::DECLINED;
}

1;</code></pre>

<p>Note the only slight difference between the interface for Digest
authentication as compared to Basic authentication. Because the authentication
realm is an essential part of the Digest scheme, it is passed to our
<code>handler()</code> subroutine in addition to the request record,
<code>$r</code>, and username we received with the Basic scheme.</p>

<p>Knowing the username and authentication realm, our provider can choose
whatever method it desires to retrieve the MD5 hash associated with the user.
Returning the hash for comparison by <code>mod_auth_digest</code> is simply a
matter of populating the scalar referenced by <code>$hash</code> and returning
<code>OK</code>. While using references in this way may feel a bit strange, it
follows the same pattern as the official Apache C API, so I guess that makes it
ok.</p>

<p>If the user cannot be found, the provider can choose to return
<code>HTTP_UNAUTHORIZED</code> and deny access to the user, or return
<code>DECLINED</code> to pass authority for the user to the next provider.
Remember, unlike with the Perl handlers for all the other phases of the
request, you can intermix Perl providers with C providers, sandwiching the
default file provider with Perl providers of your own choosing.</p>

<p>The one question that remains is how to generate a suitable MD5 digest to
pass back to <code>mod_auth_digest</code>. For the default file provider, the
return digest is typically generated using the <code>htdigest</code> binary
that comes with the Apache installation. However, a Perl one-liner that can be
used to generate a suitable MD5 digest for Perl providers would look similar to
the following.</p>

<pre><code>$ perl -MDigest::MD5 -e'print Digest::MD5::md5_hex("user:realm:password")'</code></pre>

<p>That is all there is to it. No hash checking, no header manipulations, no
back flips or somersaults. Simply dig out the user credentials and pass them
along. At last, Digest authentication for the (Perl) people.</p>

<h3>Don't Forget the Tests!</h3>

<p>Of course, no module would be complete without a test suite, and the <a href="http://search.cpan.org/search?query=Apache-Test">Apache-Test</a>
framework introduced <a href="/pub/a/2003/05/22/testing.html">last time</a> gives us
all the tools we need to write a complete set of tests.</p>

<p>For the most part, the tests for Apache::AuthenHook are not that different
from those presented before. LWP supports Digest authentication natively, so
all our test scripts really need to do is make a request to a protected URI and
let LWP do all the work. Here is a snippet from one of the tests.</p>

<pre><code>plan tests => 10, (have_lwp &amp;&amp;
                   have_module('mod_auth_digest'));

my $url = '/digest/index.html';

$response = GET $url, username => 'user1', password => 'digest1';
ok $response->code == 200;</code></pre>

<p>When we plan the tests, we first check for the existence of
<code>mod_auth_digest</code>&mdash;both <code>mod_auth_basic</code> and
<code>mod_auth_digest</code> can be enabled or disabled for any given
installation, so we need to check for them where appropriate. Passing the
username and password credentials is pretty straightforward, using the
<code>username</code> and <code>password</code> keys after the URL when
formatting the request.</p>

<p>Actually, while the <code>username</code> and <code>password</code> keys
have special meaning, you can use the same technique to send any arbitrary
headers in the request.</p>

<pre><code># fetch the Last-Modified header from one response...
my $last_modified = $response->header('Last-Modified');

# and use it in the next request
$response = GET $uri, 'If-Modified-Since' => $last_modified;
ok ($response->code == HTTP_NOT_MODIFIED);</code></pre>

<p>That's something to note just in case you need that functionality sometime
later in your testing life.</p>

<p>One final note about our tests will apply to anyone writing a mod_perl XS
extension. Instead of using <code>extra.conf.in</code> to configure Apache, we
used <code>extra.last.conf.in</code>. The difference between the two is that
<code>extra.last.conf.in</code> is guaranteed to be loaded the last in the
configuration order&mdash;if our <code>PerlLoadModule</code> directive is
processed before mod_perl gets the chance to add the proper <code>blib</code>
entries, nothing will work, so ensuring our configuration is loaded after
everything else is in place is important.</p>

<h3>Whew</h3>

<p>mod_perl is truly exciting. With surprisingly little work, we have managed
to open an entire new world within Apache 2.1 to the Perl masses. I know of no
other blend of technologies that allow for such remarkable flexibility beyond
what each individually brings to the table. Hopefully, this article has not
only introduced you to new Apache and authentication concepts, but has also
brought to light ways in which you can leverage mod_perl that you never thought
of before.</p>

<h3>More Information</h3>

<p>I apologize if this article is a little on the heavy side, teasing you with
only cursory introductions to cool concepts while leaving out the finer
details. So, if you want to explore these concepts in more detail, I leave you
with the following required reading.</p>

<p>A nice overall introduction to the new provider mechanism can be found in <a href="http://www.serverwatch.com/tutorials/article.php/2202671">Safer Apache
Driving with AAA</a>. The mechanics of Basic authentication can be found in
lots of places, but decent explanations of Digest authentication are harder to
find. Both are covered to some level of detail in <a href="http://www.modperlcookbook.org/chapters/ch13.pdf">Chapter 13</a> of the
<a href="http://modperlcookbook.org/"><em>mod_perl Developer's
Cookbook</em></a>, which is freely available online. Recipe 13.8 in particular
includes the code that became the splinter in my mind and eventually this
article.</p>

<p>A more detailed explanation of directive handlers in mod_perl 2.0 can be
found in the <a href="http://perl.apache.org/docs/2.0/user/config/custom.html">mod_perl 2.0
documentation</a>. Although covering only mod_perl 1.0 directive handlers,
whose implementation is very different, <a href="http://modperl.com:9000/book/chapters/ch8.html">Chapter 8</a> in <a href="http://www.modperl.com/"><em>Writing Apache Modules with Perl and
C</em></a> and <a href="http://www.modperlcookbook.org/chapters/ch07.pdf">Recipes 7.8 through
7.11</a> in the <em>mod_perl Developer's Cookbook</em> provide excellent
explanations of concepts that are universal to both platforms, and are
essential reading if you plan on using directive handlers yourself. If you are
curious about the intricate details of directive merging, Chapter 21 in <a href="http://www.oreilly.com/catalog/apache3/">Apache: the Definitive Guide</a>
presents probably the most comprehensive explanation available.</p>

<p>Finally, if you are interested in the gory details of the XS that really
drives Apache::AuthenHook, there is no better single point of reference than <a href="http://www.manning.com/jenness/"><em>Extending and Embedding
Perl</em></a>, which was my best friend while writing this module and
absolutely deserves a place on your bookshelf.</p>

<h3>Thanks</h3>

<p>Many thanks to Stas Bekman and Philippe Chiasson for their feedback and
review of the several patches to mod_perl core that were required for the code
in this article, as well as to J&#246;rg Walter, who was kind enough to take
the time to review this article and give valuable feedback.</p>
        </div>



    </div>
    <div class="asset-footer"></div>
</div>


                            
                            <div id="entry-1152" class="entry-asset asset hentry">
    <div class="asset-header">
        <h2 class="asset-name entry-title"><a href="/pub/2003/06/p6pdigest/20030706.html" rel="bookmark">This week on Perl 6, week ending 2003-07-06</a></h2>
        <div class="asset-meta">
            <span class="byline">
    
                By <span class="vcard author">Piers Cawley</span> on <abbr class="published" title="2003-07-06T00:00:00-08:00">July  6, 2003 12:00 AM</abbr>
    
            </span>

            
            

        </div>
    </div>
    <div class="asset-content entry-content">

        <div class="asset-body">
            <h2>Perl 6 Summary for the week ending 20030706</h2>

<p>Welcome to this week's Perl 6 Summary, coming to you live from a gatecrashed
Speakers' lounge at OSCON/TPC, surrounded by all the cool people like Dan
Sugalski, Lisa Wolfisch, Graham Barr, and Geoff Young, who aren't distracting
me from writing this summary at all.</p>

<p>10 minutes later, after the arrival of James Duncan and Adam Turoff, I'm
still not being distracted. Oh no... Leon Brocard's just arrived, which helps
with the running joke, but not with the 'getting the summary written'.</p>

<p>So, we'll start as usual with the goings on in perl6-internals.</p>

<h3>More on Parrot's multiple stack implementations</h3>

<p>Dan pointed out that, although Control, User, and Pads share the same stack
engine, Pads should be implemented using a simple linked list. He also
confessed that all the register backing stacks should share an implementation,
but that he'd been too lazy to macro things up properly.</p>

<p> <a
href="http://groups.google.com/groups?threadm=a05210614bb27df94abdb%40%5B63.120.19.221%5D">
http://groups.google.com/groups</a></p>

<h3>Building IMCC as parrot</h3>

<p>Leo T&ouml;tsch posted an initial patch to make IMCC build as the parrot
executable. And there was much <code>Makefile</code> debugging.</p>

<p> <a
href="http://groups.google.com/groups?threadm=rt-22855-60060.13.3692622089707%40rt.perl.org">
http://groups.google.com/groups</a></p>

<h3>Parrot IO work</h3>

<p>Work on Parrot's IO system was ongoing this week.</p>

<p> <a
href="http://groups.google.com/groups?threadm=rt-22857-60064.4.51506402790031%40rt.perl.org">
http://groups.google.com/groups</a></p>

<h3>Parrot Exceptions</h3>

<p>Discussion of possibly resumable exceptions continued, and morphed into a
discussion of the workings of warnings when Benjamin Goldberg wondered if
warnings were being implemented as exceptions.</p>

<p>They aren't. I think Benjamin was being confused by Perl 6's
<code>fail</code> function which can either issue a warning and return undef to
its caller's caller, or throw an exception, depending on a pragma whose name I
can't for the life of me remember.</p>

<p> <a
href="http://groups.google.com/groups?threadm=3F005CE3.F19682A6%40hotpop.com">
http://groups.google.com/groups</a></p>

<h3>Parrot's build system</h3>

<p>Last week Dan asked for help writing a configuration and build system that
would allow per-C-file compiler flag overrides and various other complexities.
This week Alan Burlison worried that this approach looked "<em>very</em>
suspect". This sparked a discussion of the proper way to do interrupt safe
queueing, reentrant code, and other scary things.</p>

<p>I may be misreading what's being said in the thread, but it seems that the
scariest thing about the whole issue is that there's no portable way of doing
the Right Thing, which leads to all sorts of painful platform dependencies and
hoopage (From "to jump through hoops", anything which requires you to jump
through a lot of hoops has a high degree of hoopage. For the life of me I can't
remember if it was me or Leon Brocard who coined the term).</p>

<p>Swamps were mentioned. Monty Python skits were quoted. Uri Guttman was
overtaken by (MUAHAHAHAHAHA!) megalomania.</p>

<p> <a
href="http://groups.google.com/groups?threadm=3F00BCD8.5090108%40sun.com">
http://groups.google.com/groups</a></p>

<h3>Klaas-Jan Stol Explains Everything (part 1)</h3>

<p>Last week I mentioned that I didn't know what Klaas-Jan Stol was driving at
when he proposed a general, language-independent "argument" PMC class and hoped
that he would provide an explanation, with code fragments.</p>

<p>This week, Klaas-Jan came through, and I think I understand what he wants.
Go read his explanation and see if you understand it too.  It's to do with when
a parameter should be passed by reference or by value. Parrot currently assumes
that Strings and PMCs are passed by reference, and that integers and floats are
passed by value.</p>

<p>There was some discussion of whether support for optionally passing PMCs by
value should be added at the parrot level or whether individual language
compilers should be responsible for calling the appropriate PMC methods.</p>

<p> <a
href="http://groups.google.com/groups?threadm=BAY1-DAV73yhKpOxLYZ000348b0%40hotmail.com">
http://groups.google.com/groups</a></p>

<h3>Moving ParrotIO to PMCs</h3>

<p>J&uuml;rgen B&ouml;mmels is working hard on moving Parrot's IO-system to a
fully garbage collected PMC based system. He posted an initial patch
transforming ParrotIO structures into PMCs using a simple wrapping
approach.</p>

<p>The patch had problems because the new ParrotIO PMCs were marked as needing
active destruction, which could lead to problems with files being closed twice
and memory structures getting cleaned up twice, which tends to make memory leak
detecting tools a little unhappy. This bug proved to be easy to fix. But then
another one reared its head and has so far proved rather harder to fix.</p>

<p> <a
href="http://groups.google.com/groups?threadm=rt-22864-60093.6.14456938094875%40rt.perl.org">
http://groups.google.com/groups</a></p>

<h3>Jako gets modules (sort of)></h3>

<p>Gregor N Purdy announced that he's added rudimentary module support to his
Jako "little" (?) language. A little later he announced that he'd added rather
less rudimentary module support.</p>

<p> <a
href="http://groups.google.com/groups?threadm=1057204345.17931.14.camel%40borg.focusresearch.com">
http://groups.google.com/groups</a></p>

<h3>Stupid Parrot Tricks</h3>

<p>Clinton Pierce, shooting for his "mad genius" badge announced that he'd
implemented a simple CGI script in Parrot BASIC. Everyone gasped. Robert Spier
decided that the time may have come to start playing with
<code>mod_parrot</code> (embedding Parrot in Apache) again.</p>

<p> <a
href="http://groups.google.com/groups?threadm=200307031813953.SM00173%40localhost">
http://groups.google.com/groups</a></p>

<p> <a
href="http://www.camfriends.org/testform.html">http://www.camfriends.org/testform.html</a>
-- that BASIC CGI URL</p>

<h3>Lazy Arrays</a></h3>

<p>Luke Palmer is thinking about implementing LazyArray and LazySequence PMCs
and outlined his design approach for the list.  Benjamin Goldberg and Leo
T&ouml;tsch both contributed answers to some of the questions Luke raised.</p>

<p> <a
href="http://groups.google.com/groups?threadm=ygcllvf9qbm.fsf%40babylonia.flatirons.org">
http://groups.google.com/groups</a></p>

<h3>wxWindows Support</h3>

<p>David Cuny asked if there was any interest in supporting wxWindows (an open
source, cross platform, native UI framework for a pile of operating
systems).</p>

<p>Leo thought that one could use wxWindows from Parrot via the NCI (Native
Call Interface), but that it wouldn't be at all easy. He thought that the best
way would be a custom dynamically loaded PMC, tied to good object support in
Parrot. Neither of which we have (yet).</p>

<p>Leo also thought that using Parrot as a GCC backend would be a reasonably
sensible idea, but that it "would need some extensions at both sides". He
wondered if there were any GCC people listening.</p>

<p> <a
href="http://groups.google.com/groups?threadm=200307040708.49426.dcuny%40lanset.com">
http://groups.google.com/groups</a></p>

<h3>Hash Iterators</h3>

<p>Leo checked in his "buggy initial try" at implementing a hash iterator for
Parrot, but he wasn't entirely happy with his implementation. Sean O'Rourke
suggested a Better Way, which Leo immediately took advantage of.</p>

<p> <a
href="http://groups.google.com/groups?threadm=3F06C195.4090901%40nextra.at">
http://groups.google.com/groups</a></p>

<hr />

<h2>Meanwhile, in perl6-language</h2>

<p>Almost nothing happened.</p>

<h3><code>printf</code> like formatting in interpolated strings</h3>

<p>Jonadab the Unsightly One made another proposal in this longrunning
thread.</p>

<p> <a
href="http://groups.google.com/groups?threadm=he68nw9k.fsf%40jonadab.homeip.net">
http://groups.google.com/groups</a></p>

<h3>Perl 6 Daydreams</h3>

<p>The directed daydreaming continued. Jonadab is looking forward to Perl 6's
new improved object model (him and many, many others I believe). This morphed
into a discussion of porting Inform to run on Parrot, which spawned thoughts of
when Parrot achieves its final goal of being able to load and run z-code based
interactive fiction. (The theory is that getting z-code working on Parrot will
be the final goal because once that happens the dev team will stop working on
Parrot and spend all their time playing Zork).</p>

<p> <a
href="http://groups.google.com/groups?threadm=d6gwnv5w.fsf%40jonadab.homeip.net">
http://groups.google.com/groups</a></p>

<h3>Aliasing an array slice</h3>

<p>Dan Brook wondered if it would be either possible or sane to bind a variable
to an array slice:</p>

<pre><code>my @array_slice := @array[1,3,5]</code></pre>

<p>Luke Palmer thought it would have to be, because if it weren't</p>

<pre><code>my *@fibs := (1, 1, map { $^a  + $^b} zip(@fibs, @fibs[1...]));</code></pre>

<p>wouldn't work (and that would be a bad thing because?).</p>

<p>Damian pointed out that it sort of worked already in Perl 5.  This started
people discussing what the Right Thing would finally be in Perl 6.</p>

<p> <a
href="http://groups.google.com/groups?threadm=20030704184357.017b86c5.dbrook%40easyspace.com">
http://groups.google.com/groups</a></p>

<hr />

<h2>Acknowledgements, Announcements and Apologies</h2>

<p>Look, I'm sorry the Summary's late, okay? OSCON is an incredibly distracting
thing to be present at; every time I settled down to write I got drawn into
another fascinating conversation and before I knew it it was time to go back to
my hotel, which is, of course, where I managed to knuckle down and write
this.</p>

<p>Thanks to Curtis Poe for putting us up for the first couple of nights in
Portland, and to Tom Phoenix for being a top notch Native Guide. No thanks to
Powell's City of Books <a
href="http://www.powells.com/">http://www.powells.com/</a> for having far too
much good stuff in stock. Thankfully, they ship.</p>

<p>As ever, if you've appreciated this summary, please consider one or more of
the following options:</p>

<ul>

<li>Send money to the Perl Foundation at <a
href="http://donate.perl-foundation.org/">http://donate.perl-foundation.org/</a>
and help support the ongoing development of Perl.</li>

<li>Get involved in the Perl 6 process. The mailing lists are open to all.  <a
href="http://dev.perl.org/perl6/">http://dev.perl.org/perl6/</a> and <a
href="http://www.parrotcode.org/">http://www.parrotcode.org/</a> are good
starting points with links to the appropriate mailing lists.</li>

<li>Send feedback, flames, money, photographic and writing commissions, or a
cute little iSight to <em><a
href="mailto:p6summarizer@bofh.org.uk">p6summarizer@bofh.org.uk</a></em>.</li>

</ul>
</body>
</html>

        </div>



    </div>
    <div class="asset-footer"></div>
</div>


                            
                            <div id="entry-1158" class="entry-asset asset hentry">
    <div class="asset-header">
        <h2 class="asset-name entry-title"><a href="/pub/2003/07/01/regexps.html" rel="bookmark">Power Regexps, Part II</a></h2>
        <div class="asset-meta">
            <span class="byline">
    
                By <span class="vcard author">Simon Cozens</span> on <abbr class="published" title="2003-07-01T00:00:00-08:00">July  1, 2003 12:00 AM</abbr>
    
            </span>

            
            

        </div>
    </div>
    <div class="asset-content entry-content">

        <div class="asset-body">
            
<!-- sidebar begins -->
<!-- don't move sidebars -->
<!-- sidebar ends -->

<p>In the previous article, we looked at some of the more intermediate features
of regular expressions, including multiline matching, quoting, and
interpolation. This time, we're going to look at
more-advanced features. We'll also look at some
modules that can help us handle regular expressions.</p>


<h2><a name="look_forward,_look_back">Look Forward, Look Back</a></h2>
<p>Perhaps the most misunderstood facility of regular expressions are the
lookahead and lookbehind operators; let's begin with the simplest, the
positive lookahead operator.</p>
<p>This operator, spelled <code>(?= )</code>, attempts to match a pattern, and if
successful, promptly forgets all about it. As its name implies, it peeks
forward into the string to see whether the next part of the string matches
the pattern. For instance:</p>
<pre><code>
    $a=&quot;13.15    Train to London&quot;; 
    $a=~ /(?=.*London)([\d\.]+)/</code></pre>
<p>This is perhaps an inefficient way of writing:</p>
<pre><code>
    $a =~ /([\d\.]+).*London/;</code></pre>
<p>and it can be read as &quot;See if this string has 'London' in it somewhere,
and if so, capture a series of digits or periods.&quot;</p>
<p>Here's an example of it in real-life code; I want to turn some file
names into names of Perl modules. I'll have a name like
<em>/Library/Perl/Mail/Miner/Recogniser/Phone.pm</em> - this is part of my
<code>Mail::Miner</code> module, so I can guarantee that the name of the module
will start with <code>Mail/Miner</code> - and I want to get
<code>Mail::Miner::Recogniser::Phone</code>. Here's the code that does it:</p>
<pre><code>
    our @modules = map {
        s/.pm$//;
        s{.*(?=Mail/Miner)}{};
        join &quot;::&quot;, splitdir($_)
    } @files;</code></pre>
<p>We look at each of our files, and first take off the <code>.pm</code> from the
end. Now what we need to do is remove everything before the
<code>Mail/Miner</code> portion, stripping off <em>/Library/Perl</em> or whatever our
path happens to be. Now we could write this as:</p>
<pre><code>
    s{.*Mail/Miner}{Mail/Miner};</code></pre>
<p>removing everything which appears before <code>Mail/Miner</code> and then the text
<code>Mail/Miner</code> itself, and then replacing all that with <code>Mail/Miner</code>
again. This is obviously horribly long-winded, and it's much more
natural to think of this in turns of &quot;get rid of everything but stop
when you see <code>Mail/Miner</code>&quot;. In most cases, you can think of <code>(?= )</code> as
meaning &quot;up to&quot;.</p>
<p>Similar but subtly different is the negative counterpart <code>(?! )</code>. This
again peeks forward into the string, but ensures that it <strong>doesn't</strong>
match the pattern. A good way to think of this is &quot;so long as you don't
see&quot;. Damian Conway's <code>Text::Autoformat</code> contains some code for
detecting quoted lines of text, such as may be found in an e-mail
message:</p>
<pre><code>
    % Will all this regular expression scariness go away in 
    % Perl 6?</code></pre>
<pre><code>
    Yes, definitely; we're replacing it with a completely different set
    of scariness.</code></pre>
<p>Here the first two lines are quoted, and the expressions that check for
this look like so:</p>
<pre><code>
    my $quotechar = qq{[!#%=|:]};
    my $quotechunk = qq{(?:$quotechar(?![a-z])|[a-z]*&gt;+)};</code></pre>
<p><code>$quotechar</code> contains the characters that we consider signify a
quotation, and <code>$quotechunk</code> has two options for what a quotation looks
like. The second is most natural: a greater-than sign, possibly preceded
by some initials, such as produced by the popular Supercite <code>emacs</code>
package:</p>
<pre><code>
    SC&gt; You're talking nonsense, you odious little gnome!</code></pre>
<p>The left-hand side of the alternation in <code>$quotechunk</code> is a little more
interesting. We look for one of our quotation characters, such as <code>%</code>
as in the example above, but then we make sure that the next character
we see is not alphabetic; this may be a quotation:</p>
<pre><code>
    % I think that all right-thinking people...</code></pre>
<p>but this almost certainly isn't</p>
<pre><code>
    %options = ( verbose =&gt; 1, debug =&gt; 0 );</code></pre>
<p>The <code>(?!)</code> acts as a &quot;make sure you don't see&quot; directive.</p>
<p>The mistake everyone makes at least once with this is to assume you can
say:</p>
<pre><code>
    /(?!foo)bar/;</code></pre>
<p>and wonder why it matches against <code>foobar</code>. After all, we've made sure
we didn't see a <code>foo</code> before the <code>bar</code>, right? Well, not exactly.
These are lookahead operators, and so can't be used to find things
&quot;before&quot; anything at all; they're only used to determine what we can or
can't see after the current position. To understand why this is wrong,
imagine what it would mean if it were a positive assertion:</p>
<pre><code>
    /(?=foo)bar/;</code></pre>
<p>This means &quot;are the next three characters we see <code>foo</code>? If so, the next three characters we see are <code>bar</code>&quot;. This is obviously never
going to happen, since a string can't contain both <code>foo</code> and <code>bar</code> at
the same position and the same time. (Although I believe Damian has a
paper on that.) So the negative version means &quot;are the next three
characters we see <strong>not</strong> <code>foo</code>? Then match <code>bar</code>&quot;. <code>foo</code> is not
<code>bar</code>, so this matches any <code>bar</code>. What was probably meant was a
lookbehind assertion, which we will look at imminently.</p>
<p>Now we've seen the two forward-facing assertions, we can turn (ha, ha)
to the backward-facing assertions, positive and negative lookbehind.
There's one important difference between these and their forward-facing
counterparts; while lookahead operators can contain more or less any
kind of regular expression pattern, for reasons of implementation the
lookbehind operators must have a fixed width computable at compile time.
That is, you're not allowed to use any indefinite quantifiers in your
subpatterns.</p>
<p>The positive lookbehind assertion is <code>(?&lt;=)</code>, and the only thing
you need to know about it is that it's so rare I can't remember the last
time I saw it in real code. I don't think I've ever used it, except
possibly in error. If you think you want to use one of these, then you almost
certainly need to rethink your strategy. Here's a quick example, though,
from <code>IPC::Open3</code>:</p>
<pre><code>
    $@ =~ s/(?&lt;=value attempted) at .*//s;</code></pre>
<p>The context for this is that we've just done the equivalent of</p>
<pre><code>
    eval { $_[0] = ... };</code></pre>
<p>and if someone maliciously passes a constant value to the subroutine, 
we want to through the <code>Modification of a read-only value attempted</code>
error back in their face. We check we're seeing the error we expect,
then strip off the <code> at .../IPC/Open3.pm, line 154</code> part of the message
so that it can be fed to <code>croak</code>. The less Tom-Christianseny way to
do this would be something like:</p>
<pre><code>
    croak &quot;You fed me bogus parameters&quot; if $@ =~ /attempted/;</code></pre>
<p>The negative lookbehind assertion, on the other hand, is considerably
more common; this is the answer to our &quot;<code>bar</code> not preceded by <code>foo</code>&quot;
problem of the previous section.</p>
<pre><code>
    /(?!&lt;foo)bar/;</code></pre>
<p>This will match <code>bar</code>, peeking backward into the string to make sure
it doesn't see <code>foo</code> first. To take another example, suppose we're
preparing some text for sending over the network, and we want to make
sure that all the line feeds (<code>\n</code>) have carriage returns (<code>\r</code>)
before them. Here's the truly lazy way to do it:</p>
<pre><code>
    # Make sure there's an \r in there somewhere
    s{\n}  {\r\n}g;
    # And then strip out duplicates
    s{\r\r}{\r}  g;
 
This is fine (if somewhat inefficient) unless it's OK for two carriage
returns to appear without a line feed in the way. Here's the finesse:</code></pre>
<pre><code>
    s/(?&lt;!\r)\n/\r\n/g;</code></pre>
<p>If you see a line feed that is <strong>not</strong> preceded by a carriage return,
then stick a carriage return in there -- much cleaner, and much more efficient.</p>















<h2><a name="split,_//g_and_other_shenanigans"><code>split</code>, <code>//g</code> and other shenanigans</a></h2>
<p>In the previous article, we had a nice piece of multiline, formatted
data, such as one might expect to parse with Perl:</p>
<pre><code>
    Name: Mark-Jason Dominus
    Occupation: Perl trainer
    Favourite thing: Octopodes</code></pre>
<pre><code>
    Name: Simon Cozens
    Occupation: Hacker
    Favourite thing: Sleep</code></pre>
<p>Now, there's a boring way to parse this. If you're coming from a C
or Java background, then you might try:</p>
<pre><code>
    my $record = {}
    my @records;
    for (split /\n/, $text {
        chomp;
        if (/([^:]+): (.*)/) {
            $record-&gt;{$1} = $2;
        } elsif ($_ =~ /^\s*$/) {
            # Blank line =&gt; end of current record
            push @records, $record;
            $record = {};
        } else {
            die &quot;Wasn't expecting to see '$_' here&quot;;
        }
    }</code></pre>
<p>And, of course, this will work. But there's several more
Perl-ish solutions that this. When you know the fields provided by your
data, it's rather nice to have a regular expression that reflects the
data structure:</p>
<pre><code>
    while ($data =~ /Name:\s(.*)\n
                     Occupation:\s(.*)\n 
                     Favourite.*:\s(.*)/gx) {
        push @records, { name =&gt; $1, occupation =&gt; $2, favourite =&gt; $3 }
    }</code></pre>
<p>Here we use the <code>/g</code> modifier, which allows us to resume the match from
where it last left off.</p>
<p>If we don't know the fields while we're writing our program, then we'll
have to break the process up into two stages. First, we extract
individual records: records are delimited by a blank line:</p>
<pre><code>
    my @texts = split /\n\s*\n/, $text;</code></pre>
<p>And then for each record, we can either use the <code>/g</code> trick again, or
simply split each record into lines. I prefer the latter, for reasons
you'll see in a second:</p>
<pre><code>
    for (@texts) {
        my $record = {};
        for (split /\n/, $_) {
            /([^:]+): (.*)/;
            $record-&gt;{$1} = $2;
        }
        push @records, $record;
    }</code></pre>
<p>This is not dissimilar from the initial solution, but it allows us to
make some interesting improvements. For starters, when you see code
that transforms data with a <code>for</code> loop, you should wonder whether it
could be better written with a <code>map</code> statement. This goes double if
you're using <code>push</code> inside the <code>for</code> loop as we are here. So this
version is a natural evolution:</p>
<pre><code>
    @records = map {
        my $record = {};
        for (split /\n/, $_) { 
            /([^:]+): (.*)/;
            $record-&gt;{$1} = $2;
        }
        $record;
    } split /\n\s*\n/, $text;</code></pre>
<p>And we can actually do away with the inner <code>for</code> loop too:</p>
<pre><code>
    @records = map {
        {
            map { /([^:]+): (.*)/ and ($1 =&gt; $2) } split /\n/, $_
        }
    } split /\n\s*\n/, $text;</code></pre>
<p>But if we're prepared to be a little lax about trailing whitespace,
there's actually an even nicer way to do it, using the one thing that
everyone forgets about <code>split</code>: if your <code>split</code> pattern contains
parentheses, then the captured text is inserted into the list returned
by <code>split</code>. That is, the following code:</p>
<pre><code>
    split( /(\W+)/, &quot;perl-5.8.0.tar.gz&quot;)</code></pre>
<p>will produce the list</p>
<pre><code>
    (&quot;perl&quot;, &quot;-&quot;, &quot;5&quot;, &quot;.&quot;, &quot;8&quot;, &quot;.&quot;, &quot;0&quot;, &quot;.&quot;, &quot;tar&quot;, &quot;.&quot;, &quot;gz&quot;)</code></pre>
<p>So we can actually use the field name, colon and space at the start of
each line as the <code>split</code> expression itself:</p>
<pre><code>
    split /^([^:]+):\s*/m</code></pre>
<p>There is a slight problem with this idea - because the first
thing in each record is delimeter we're looking for, the first thing
returned by <code>split</code> will be an empty string. But we can easily get
around this by adding another <code>undef</code> to provide a fake <code>undef =&gt; ''</code>
hash element. This allows us to reduce the parser code to:</p>
<pre><code>
    @records = map { 
                     { undef, split /^([^:]+):\s*/m, $_ } 
                   } split /\n\s*\n/, $text;</code></pre>
<p>It may not be pretty, but it's quick and it works.</p>
<p>Of course, you may also use lookahead and lookbehind assertions with
<code>split</code>; I sometimes use the following code to break a string into
tokens:</p>
<pre><code>
    split /(?&lt;=\W)|(?=\W)/, $string;</code></pre>
<p>This is almost the same as</p>
<pre><code>
    split /(\W)/, $string</code></pre>
<p>but with a subtle difference. Again, as Perl wants to see a nonword
character as a delimiter, it will return an empty string between two
adjacent nonwords:</p>
<pre><code>
    split /(\W)/, '$foo := $bar';
    # '', '$', 'foo', ' ', '', ':', '', '=', '', ' ', '', '$', 'bar'</code></pre>
<p>Splitting on a word boundary goes too much the other way:</p>
<pre><code>
    split /\b/, '$foo := $bar';
    # '$', 'foo', ' := $', 'bar'</code></pre>
<p>And so it turns out that we want to cleave the string where we've just
seen a nonword character, or if we're about to see one:</p>
<pre><code>
    split /(?&lt;=\W)|(?=\W)/, $string;
    # '$', 'foo', ' ', ':', '=', ' ', '$', 'bar'</code></pre>
<p>And this gives us the sort of tokenisation we want.</p>


<h2><a name="regexp_modules">Regexp Modules</a></h2>
<p>Now, though, we are getting into the sort of regular expressions that
are not written lightly, and we may need some help constructing and
debugging these expressions. Thankfully, there are plenty of modules
which make regexp handling much easier for us.</p>


<h3><a name="re">re</a></h3>
<p>The <code>re</code> module is as invaluable as it is obscure. It's one of those
hidden treasures of the Perl core that Casey was talking about last
month. As well as turning on two features of the regular expression
engine, tainting subexpressions and evaluated assertions, it provides a
debugging facility that allows you to watch your expression being
compiled and executed.</p>
<p>Here's a relative simple expression:</p>
<pre><code>
    $a =~ /([^:]+):\s*(.*)/;</code></pre>
<p>When this code is run under <code>-Mre=debug</code>, then the following will be
printed when the regexp is compiled:</p>
<pre><code>
    Compiling REx `([^:]+):\s*(.*)'
    size 25 first at 4
       1: OPEN1(3)
       3:   PLUS(13)
       4:     ANYOF[\0-9;-\377](0)
      13: CLOSE1(15)
      15: EXACT &lt;:&gt;(17)
      17: STAR(19)
      18:   SPACE(0)
      19: OPEN2(21)
      21:   STAR(23)
      22:     REG_ANY(0)
      23: CLOSE2(25)
      25: END(0)</code></pre>
<p>This tells us the instructions for the little machine that the regular
expression compiler creates: it should first open a bracket, then go
into a loop (<code>PLUS</code>) finding characters that are <code>ANYOF</code> character
zero through to <code>9</code> and <code>;</code> through to character 255 - that is,
everything apart from a <code>:</code>. Then we close the bracket, look for a
specific character, and so on. The numbers in brackets after each
instruction are the line number to jump to on completion; then the
<code>PLUS</code> loop exits, it should go on to line 13, <code>CLOSE1</code> and so on.</p>
<p>Next when we try to run this match against some text:</p>
<pre><code>
    $a = &quot;Name: Mark-Jason Dominus&quot;;</code></pre>
<p>It will first tell us something about the optimizations it performs:</p>
<pre><code>
    Guessing start of match, REx `([^:]+):\s*(.*)' against `Name: ...'
    Found floating substr `:' at offset 4...
    Does not contradict STCLASS...
    Guessed: match at offset 0</code></pre>
<p>What this means is that it has found the constant element <code>:</code> in the
regular expression, and tries to locate that in the string, and then
work backward to find out where it should start the match. Since the
<code>:</code> is at position four in our string, it will go on to deduce that
the match should start at the beginning and...</p>
<pre><code>
    Matching REx `([^:]+):\s*(.*)' against `Name: Mark-Jason Dominus'
    Setting an EVAL scope, savestack=3
    0 &lt;&gt; &lt;Name: Mark-J&gt;    |  1:  OPEN1
    0 &lt;&gt; &lt;Name: Mark-J&gt;    |  3:  PLUS
    ANYOF[\0-9;-\377] can match 4 times out of 32767...</code></pre>
<p>The <code>[^:]</code> can match four times, since it knows there are four things
that are not colons there.</p>
<p>The <code>re</code> module is absolutely essential for heavy-duty study of how the
regular expression engine works, and why it doesn't do what you think it
should.</p>


<h3><a name="yape::regex::explain">YAPE::Regex::Explain</a></h3>
<p>The description given by <code>re</code> is a little low-level for some people;
well, most people. <code>YAPE::Regex::Explain</code> aims to put the explanation
at a much higher level; for instance,</p>
<pre><code>
     % perl -MYAPE::Regex::Explain -e 'print 
       YAPE::Regex::Explain-&gt;new(qr/(?&lt;=\W)|(?=\W)/)-&gt;explain'</code></pre>
<p>will produce quite a verbose explanation of the regular expression like
so:</p>
<pre><code>
    ----------------------------------------------------------------------
    (?-imsx:                 group, but do not capture (case-sensitive)
                             (with ^ and $ matching normally) (with . not
                             matching \n) (matching whitespace and #
                             normally):
    ----------------------------------------------------------------------
      (?&lt;=                     look behind to see if there is:
    ----------------------------------------------------------------------
        \W                       non-word characters (all but a-z, A-Z,
                                 0-9, _)
    ----------------------------------------------------------------------
    ...</code></pre>


<h3><a name="graphviz::regex">GraphViz::Regex</a></h3>
<p>I find that one of the best ways to debug and understand a complex
procedure is to draw a picture. <code>GraphViz::Regex</code> uses the <code>graphviz</code>
visualization library to draw a state machine diagram for a given
regular expression:</p>
<pre><code>
    use GraphViz::Regex;</code></pre>
<pre><code>
    my $regex = '(([abcd0-9])|(foo))';</code></pre>
<pre><code>
    my $graph = GraphViz::Regex-&gt;new($regex);
    print $graph-&gt;as_png;</code></pre>


<h3><a name="regexp::common">Regexp::Common</a></h3>
<p>So much for explaining complicated regular expressions; what about
generating them? The <code>Regexp::Common</code> module aims to be a repository
for all kinds of commonly needed regular expressions, such as URIs,
balanced texts, domain names and IP addresses. The interface
is a little freaky, but it can hugely help to clarify complex regexps:</p>
<pre><code>
    my $ts = qr/\d+:\d+:\d+\.\d+/;
    $tcpdump =~ /$ts ($RE{net}{IPv4}) &gt; ($RE{net}{IPv4}) : (tcp|udp) (\d+)/;</code></pre>


<h3><a name="text::balanced">Text::Balanced</a></h3>
<p>Finally, one particularly common family of things to match for are quoted,
parenthesised or tagged text. Damian's <code>Text::Balanced</code> module helps
produce both regular expressions and subroutines to match and extract
balanced text sequences. For instance, we can create a regular
expression for matching double-quoted strings like so:</p>
<pre><code>
    use Text::Balanced qw(gen_delimited_pat);
    $pat = gen_delimited_pat(q{&quot;})
    # (?:\&quot;(?:[^\\\&quot;]*(?:\\.[^\\\&quot;]*)*)\&quot;)</code></pre>
<p>This pattern will match quoted text, but will also be aware of escape
sequences like <code>\&quot;</code> and <code>\\</code>, and hence not break off in the middle of</p>
<pre><code>
    &quot;\&quot;So\&quot;, he said, \&quot;How about lunch?\&quot;&quot;</code></pre>
<p><code>Text::Balanced</code> also contains routines for extracting tagged text,
finding balanced pairs of parentheses, and much more.</p>


<h2><a name="summary">Summary</a></h2>
<p>We've looked at some slightly more-complex features of regular expressions,
and shown how we can use these to slice and dice text with Perl. As these
regexes get more complicated, the need for tools to help us debug them 
increases; and so we've looked also at <code>re</code>, <code>YAPE</code> and <code>GraphViz::Regex</code>.</p>
<p>Finally, the <code>Regexp::Common</code> and <code>Text::Balanced</code> modules help us create
complex regular expressions of our own.</p>


        </div>



    </div>
    <div class="asset-footer"></div>
</div>




                            <div class="content-nav">
                                <a href="/pub/2003/06/">&laquo; June 2003</a> |
                                <a href="/pub/">Main Index</a> |
                                <a href="/pub/archives.html">Archives</a>
                                | <a href="/pub/2003/08/">August 2003 &raquo;</a>
                            </div>


                        </div>
                    </div>


                    <div id="beta">
    <div id="beta-inner">


    
    <div class="widget-what-is-perl widget">
    <div class="widget-content widget-content-what-is-perl">
       Visit the home of the  Perl programming language: <a href="http://www.perl.org/">Perl.org</a
    </div>
</div>
<div class="widget-find-out-more widget-archives widget">
    <div class="widget-content">
        <ul>
            <li><a href="http://www.perl.org/get.html">Download</a></li>
            <li><a href="http://perldoc.perl.org/">Documentation</a></li>
            <li><a href="http://blogs.perl.org/">Perl Bloggers</a></li>
            <li><a href="http://news.perlfoundation.org/">Foundation News</a></li>
        </ul>
    </div>
</div><div class="widget-tcpc widget">
<h3 class="widget-header">Sponsored by</h3>
    <div class="widget-content">
        <a href="http://training.perl.com/" alt="Perl Training" target="_blank"><img src="/i/tcpc.png" width="150" height="50"></a>
    </div>
</div>

<div class="widget-syndication widget">
    <div class="widget-content">
        <ul>
            <li><img src="/mt-static/images/status_icons/feed.gif" alt="Subscribe to feed" width="9" height="9" /> <a href="/pub/atom.xml">Subscribe to this website's feed</a></li>

        </ul>
    </div>
</div>
<div class="widget-archive-monthly widget-archive widget">
    <h3 class="widget-header">Monthly <a href="/pub/archives.html">Archives</a></h3>
    <div class="widget-content">
        <ul>
        
            <li><a href="/pub/2014/02/">February 2014 (1)</a></li>
        
    
        
            <li><a href="/pub/2014/01/">January 2014 (1)</a></li>
        
    
        
            <li><a href="/pub/2013/10/">October 2013 (1)</a></li>
        
    
        
            <li><a href="/pub/2013/01/">January 2013 (1)</a></li>
        
    
        
            <li><a href="/pub/2012/12/">December 2012 (1)</a></li>
        
    
        
            <li><a href="/pub/2012/11/">November 2012 (1)</a></li>
        
    
        
            <li><a href="/pub/2012/10/">October 2012 (2)</a></li>
        
    
        
            <li><a href="/pub/2012/08/">August 2012 (2)</a></li>
        
    
        
            <li><a href="/pub/2012/06/">June 2012 (11)</a></li>
        
    
        
            <li><a href="/pub/2012/05/">May 2012 (18)</a></li>
        
    
        
            <li><a href="/pub/2012/04/">April 2012 (17)</a></li>
        
    
        
            <li><a href="/pub/2012/02/">February 2012 (1)</a></li>
        
    
        
            <li><a href="/pub/2011/12/">December 2011 (1)</a></li>
        
    
        
            <li><a href="/pub/2011/09/">September 2011 (1)</a></li>
        
    
        
            <li><a href="/pub/2011/08/">August 2011 (2)</a></li>
        
    
        
            <li><a href="/pub/2011/06/">June 2011 (1)</a></li>
        
    
        
            <li><a href="/pub/2011/05/">May 2011 (3)</a></li>
        
    
        
            <li><a href="/pub/2011/04/">April 2011 (1)</a></li>
        
    
        
            <li><a href="/pub/2011/03/">March 2011 (1)</a></li>
        
    
        
            <li><a href="/pub/2011/02/">February 2011 (1)</a></li>
        
    
        
            <li><a href="/pub/2011/01/">January 2011 (1)</a></li>
        
    
        
            <li><a href="/pub/2010/11/">November 2010 (1)</a></li>
        
    
        
            <li><a href="/pub/2010/10/">October 2010 (2)</a></li>
        
    
        
            <li><a href="/pub/2010/09/">September 2010 (1)</a></li>
        
    
        
            <li><a href="/pub/2010/08/">August 2010 (3)</a></li>
        
    
        
            <li><a href="/pub/2010/07/">July 2010 (2)</a></li>
        
    
        
            <li><a href="/pub/2010/04/">April 2010 (2)</a></li>
        
    
        
            <li><a href="/pub/2010/03/">March 2010 (4)</a></li>
        
    
        
            <li><a href="/pub/2008/05/">May 2008 (1)</a></li>
        
    
        
            <li><a href="/pub/2008/04/">April 2008 (2)</a></li>
        
    
        
            <li><a href="/pub/2008/03/">March 2008 (1)</a></li>
        
    
        
            <li><a href="/pub/2008/02/">February 2008 (1)</a></li>
        
    
        
            <li><a href="/pub/2008/01/">January 2008 (1)</a></li>
        
    
        
            <li><a href="/pub/2007/12/">December 2007 (2)</a></li>
        
    
        
            <li><a href="/pub/2007/09/">September 2007 (1)</a></li>
        
    
        
            <li><a href="/pub/2007/08/">August 2007 (1)</a></li>
        
    
        
            <li><a href="/pub/2007/07/">July 2007 (1)</a></li>
        
    
        
            <li><a href="/pub/2007/06/">June 2007 (1)</a></li>
        
    
        
            <li><a href="/pub/2007/05/">May 2007 (1)</a></li>
        
    
        
            <li><a href="/pub/2007/04/">April 2007 (1)</a></li>
        
    
        
            <li><a href="/pub/2007/03/">March 2007 (1)</a></li>
        
    
        
            <li><a href="/pub/2007/02/">February 2007 (1)</a></li>
        
    
        
            <li><a href="/pub/2007/01/">January 2007 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/12/">December 2006 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/11/">November 2006 (2)</a></li>
        
    
        
            <li><a href="/pub/2006/10/">October 2006 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/09/">September 2006 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/08/">August 2006 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/07/">July 2006 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/06/">June 2006 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/05/">May 2006 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/04/">April 2006 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/03/">March 2006 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/02/">February 2006 (4)</a></li>
        
    
        
            <li><a href="/pub/2006/01/">January 2006 (4)</a></li>
        
    
        
            <li><a href="/pub/2005/12/">December 2005 (4)</a></li>
        
    
        
            <li><a href="/pub/2005/11/">November 2005 (3)</a></li>
        
    
        
            <li><a href="/pub/2005/10/">October 2005 (2)</a></li>
        
    
        
            <li><a href="/pub/2005/09/">September 2005 (2)</a></li>
        
    
        
            <li><a href="/pub/2005/08/">August 2005 (9)</a></li>
        
    
        
            <li><a href="/pub/2005/07/">July 2005 (8)</a></li>
        
    
        
            <li><a href="/pub/2005/06/">June 2005 (9)</a></li>
        
    
        
            <li><a href="/pub/2005/05/">May 2005 (8)</a></li>
        
    
        
            <li><a href="/pub/2005/04/">April 2005 (7)</a></li>
        
    
        
            <li><a href="/pub/2005/03/">March 2005 (6)</a></li>
        
    
        
            <li><a href="/pub/2005/02/">February 2005 (7)</a></li>
        
    
        
            <li><a href="/pub/2005/01/">January 2005 (6)</a></li>
        
    
        
            <li><a href="/pub/2004/12/">December 2004 (8)</a></li>
        
    
        
            <li><a href="/pub/2004/11/">November 2004 (8)</a></li>
        
    
        
            <li><a href="/pub/2004/10/">October 2004 (5)</a></li>
        
    
        
            <li><a href="/pub/2004/09/">September 2004 (9)</a></li>
        
    
        
            <li><a href="/pub/2004/08/">August 2004 (6)</a></li>
        
    
        
            <li><a href="/pub/2004/07/">July 2004 (8)</a></li>
        
    
        
            <li><a href="/pub/2004/06/">June 2004 (6)</a></li>
        
    
        
            <li><a href="/pub/2004/05/">May 2004 (7)</a></li>
        
    
        
            <li><a href="/pub/2004/04/">April 2004 (8)</a></li>
        
    
        
            <li><a href="/pub/2004/03/">March 2004 (8)</a></li>
        
    
        
            <li><a href="/pub/2004/02/">February 2004 (9)</a></li>
        
    
        
            <li><a href="/pub/2004/01/">January 2004 (7)</a></li>
        
    
        
            <li><a href="/pub/2003/12/">December 2003 (4)</a></li>
        
    
        
            <li><a href="/pub/2003/11/">November 2003 (7)</a></li>
        
    
        
            <li><a href="/pub/2003/10/">October 2003 (8)</a></li>
        
    
        
            <li><a href="/pub/2003/09/">September 2003 (6)</a></li>
        
    
        
            <li><a href="/pub/2003/08/">August 2003 (7)</a></li>
        
    
        
            <li><a href="/pub/2003/07/">July 2003 (9)</a></li>
        
    
        
            <li><a href="/pub/2003/06/">June 2003 (9)</a></li>
        
    
        
            <li><a href="/pub/2003/05/">May 2003 (8)</a></li>
        
    
        
            <li><a href="/pub/2003/04/">April 2003 (8)</a></li>
        
    
        
            <li><a href="/pub/2003/03/">March 2003 (10)</a></li>
        
    
        
            <li><a href="/pub/2003/02/">February 2003 (8)</a></li>
        
    
        
            <li><a href="/pub/2003/01/">January 2003 (8)</a></li>
        
    
        
            <li><a href="/pub/2002/12/">December 2002 (5)</a></li>
        
    
        
            <li><a href="/pub/2002/11/">November 2002 (9)</a></li>
        
    
        
            <li><a href="/pub/2002/10/">October 2002 (7)</a></li>
        
    
        
            <li><a href="/pub/2002/09/">September 2002 (11)</a></li>
        
    
        
            <li><a href="/pub/2002/08/">August 2002 (8)</a></li>
        
    
        
            <li><a href="/pub/2002/07/">July 2002 (8)</a></li>
        
    
        
            <li><a href="/pub/2002/06/">June 2002 (4)</a></li>
        
    
        
            <li><a href="/pub/2002/05/">May 2002 (6)</a></li>
        
    
        
            <li><a href="/pub/2002/04/">April 2002 (6)</a></li>
        
    
        
            <li><a href="/pub/2002/03/">March 2002 (7)</a></li>
        
    
        
            <li><a href="/pub/2002/02/">February 2002 (5)</a></li>
        
    
        
            <li><a href="/pub/2002/01/">January 2002 (8)</a></li>
        
    
        
            <li><a href="/pub/2001/12/">December 2001 (7)</a></li>
        
    
        
            <li><a href="/pub/2001/11/">November 2001 (5)</a></li>
        
    
        
            <li><a href="/pub/2001/10/">October 2001 (9)</a></li>
        
    
        
            <li><a href="/pub/2001/09/">September 2001 (7)</a></li>
        
    
        
            <li><a href="/pub/2001/08/">August 2001 (13)</a></li>
        
    
        
            <li><a href="/pub/2001/07/">July 2001 (8)</a></li>
        
    
        
            <li><a href="/pub/2001/06/">June 2001 (13)</a></li>
        
    
        
            <li><a href="/pub/2001/05/">May 2001 (11)</a></li>
        
    
        
            <li><a href="/pub/2001/04/">April 2001 (9)</a></li>
        
    
        
            <li><a href="/pub/2001/03/">March 2001 (8)</a></li>
        
    
        
            <li><a href="/pub/2001/02/">February 2001 (8)</a></li>
        
    
        
            <li><a href="/pub/2001/01/">January 2001 (8)</a></li>
        
    
        
            <li><a href="/pub/2000/12/">December 2000 (6)</a></li>
        
    
        
            <li><a href="/pub/2000/11/">November 2000 (10)</a></li>
        
    
        
            <li><a href="/pub/2000/10/">October 2000 (10)</a></li>
        
    
        
            <li><a href="/pub/2000/09/">September 2000 (2)</a></li>
        
    
        
            <li><a href="/pub/2000/08/">August 2000 (2)</a></li>
        
    
        
            <li><a href="/pub/2000/07/">July 2000 (5)</a></li>
        
    
        
            <li><a href="/pub/2000/06/">June 2000 (7)</a></li>
        
    
        
            <li><a href="/pub/2000/05/">May 2000 (7)</a></li>
        
    
        
            <li><a href="/pub/2000/04/">April 2000 (3)</a></li>
        
    
        
            <li><a href="/pub/2000/03/">March 2000 (2)</a></li>
        
    
        
            <li><a href="/pub/2000/02/">February 2000 (2)</a></li>
        
    
        
            <li><a href="/pub/2000/01/">January 2000 (2)</a></li>
        
    
        
            <li><a href="/pub/1999/12/">December 1999 (6)</a></li>
        
    
        
            <li><a href="/pub/1999/11/">November 1999 (6)</a></li>
        
    
        
            <li><a href="/pub/1999/10/">October 1999 (5)</a></li>
        
    
        
            <li><a href="/pub/1999/09/">September 1999 (4)</a></li>
        
    
        
            <li><a href="/pub/1999/08/">August 1999 (3)</a></li>
        
    
        
            <li><a href="/pub/1999/07/">July 1999 (2)</a></li>
        
    
        
            <li><a href="/pub/1999/06/">June 1999 (3)</a></li>
        
    
        
            <li><a href="/pub/1999/04/">April 1999 (1)</a></li>
        
    
        
            <li><a href="/pub/1999/03/">March 1999 (1)</a></li>
        
    
        
            <li><a href="/pub/1999/01/">January 1999 (1)</a></li>
        
    
        
            <li><a href="/pub/1998/12/">December 1998 (1)</a></li>
        
    
        
            <li><a href="/pub/1998/11/">November 1998 (1)</a></li>
        
    
        
            <li><a href="/pub/1998/07/">July 1998 (2)</a></li>
        
    
        
            <li><a href="/pub/1998/06/">June 1998 (1)</a></li>
        
    
        
            <li><a href="/pub/1998/03/">March 1998 (1)</a></li>
        
        </ul>
    </div>
</div>
        
    

<div class="widget-powered widget">
    <div class="widget-content">
        <a href="http://www.movabletype.com/"><img src="/mt-static/images/bug-pbmt-white.png" alt="Powered by Movable Type 5.13-en" width="120" height="75" /></a>
    </div>
</div>



    </div>
</div>






                </div>
            </div>


            <div id="footer">
    <div id="footer-inner">
        <div id="footer-content">
            <div class="widget-powered widget">
                <div class="widget-content">
                    Powered by <a href="http://www.movabletype.com/" rel="generator">Movable Type Pro</a>
                </div>
            </div>

            <div class="widget-creative-commons widget">
                <div class="widget-content">
                    This blog is licensed under a <a href="http://creativecommons.org/licenses/by-nc-nd/3.0/">Creative Commons License</a>.
                </div>
            </div>

        </div>
    </div>
</div>



        </div>
    </div>
</body>
</html>
