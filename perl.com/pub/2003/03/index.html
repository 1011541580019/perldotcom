<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" id="sixapart-standard">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="generator" content="Movable Type Pro 5.13-en" />
<link rel="stylesheet" href="/pub/styles.css" type="text/css" />
<link rel="start" href="/pub/" title="Home" />
<link rel="alternate" type="application/atom+xml" title="Recent Entries" href="/pub/atom.xml" />
<script type="text/javascript" src="/pub/mt.js"></script>
<!--
<rdf:RDF xmlns="http://web.resource.org/cc/"
         xmlns:dc="http://purl.org/dc/elements/1.1/"
         xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#">
<Work rdf:about="/pub/">
<dc:title>Perl.com</dc:title>
<dc:description>news and views of the Perl programming language</dc:description>
<license rdf:resource="http://creativecommons.org/licenses/by-nc-nd/3.0/" />
</Work>
<License rdf:about="http://creativecommons.org/licenses/by-nc-nd/3.0/">
</License>
</rdf:RDF>
-->

<script type="text/javascript">

 var _gaq = _gaq || [];
 _gaq.push(['_setAccount', 'UA-50555-22']);
 _gaq.push(['_trackPageview']);

 (function() {
   var ga = document.createElement('script'); ga.type =
   'text/javascript'; ga.async = true;
   ga.src = ('https:' == document.location.protocol ? 'https://ssl' :
   'http://www') + '.google-analytics.com/ga.js';
   var s = document.getElementsByTagName('script')[0];
   s.parentNode.insertBefore(ga, s);
 })();

</script>
<script type='text/javascript' src='http://partner.googleadservices.com/gampad/google_service.js'></script>
<script type='text/javascript'>
GS_googleAddAdSenseService("ca-pub-4136420132070439");
GS_googleEnableAllServices();
</script>
<script type='text/javascript'>
GA_googleAddSlot("ca-pub-4136420132070439", "Perl_728x90");
</script>
<script type='text/javascript'>GA_googleFetchAds();</script>
    <title>Perl.com: March 2003 Archives</title>


    <link rel="prev" href="/pub/2003/02/" title="February 2003" />
    <link rel="next" href="/pub/2003/04/" title="April 2003" />

</head>
<body id="perl-com" class="mt-archive-listing mt-datebased-monthly-archive layout-wt">
    <div id="container">
        <div id="container-inner">


            <div id="header">
    <div id="header-inner">
        <div id="header-content">
        <span id="top_advert"> 
<!-- Put any landscape advert in here -->
<!-- Perl_728x90 -->
<script type='text/javascript'>
GA_googleFillSlot("Perl_728x90");
</script>
        </span> 



            <div id="header-name"><a href="/pub/" accesskey="1">Perl.com</a></div>
            <div id="header-description">news and views of the Perl programming language</div>




        </div>
    </div>
</div>



            <div id="content">
                <div id="content-inner">


                    <div id="alpha">
                        <div id="alpha-inner">


                            <h1 id="page-title" class="archive-title">March 2003 Archives</h1>





                            
                            <div id="entry-1100" class="entry-asset asset hentry">
    <div class="asset-header">
        <h2 class="asset-name entry-title"><a href="/pub/2003/03/p6pdigest/20030330.html" rel="bookmark">This week on Perl 6, week ending 2003-03-30</a></h2>
        <div class="asset-meta">
            <span class="byline">
    
                By <span class="vcard author">Piers Cawley</span> on <abbr class="published" title="2003-03-30T00:00:00-08:00">March 30, 2003 12:00 AM</abbr>
    
            </span>

            
            

        </div>
    </div>
    <div class="asset-content entry-content">

        <div class="asset-body">
            
<!-- sidebar begins -->
<!-- don't move sidebars -->
<!-- sidebar ends -->


<p>Welcome once again to the gallimaufry that is a Perl 6
summary. Unfettered this week by the presence of feline distraction
we plunge straight into the crystal clear waters of perl6-internals.</p>


<h4><a name="iterator_proof_of_concept">Iterator proof of concept</a></h4>
<p>People must really like Leo T&ouml;tsch's Iterator proposal and
patch. There was only one comment about it this week (from Leo, so
I'm not sure if it counts) asking for thoughts about a possible Ref or
Reference class. Anyone?</p>
<p><a href="http://groups.google.com/groups?threadm=3E7ED9AF.904%40toetsch.at">http://groups.google.com/groups</a></p>


<h4><a name="bonsai">Bonsai</a></h4>
<p>Zach Lipton announced that he has Bonsai up and running on the Parrot
CVS repository. This gives us a shiny new way of looking at the
history of the distribution. Thanks Zach.</p>
<p><a href="http://tinderbox.perl.org/bonsai">http://tinderbox.perl.org/bonsai</a></p>


<h4><a name="basic,_imcc_and_windows">BASIC, IMCC and Windows</a></h4>
<p>Clinton A Pierce had problems trying to get IMCC building correctly
under Win32 in order to generate a binary distribution for the win32
platform. He finally brought up a working IMCC on Friday and asked for
comments about what a binary distribution should look like.</p>
<p><a href="http://groups.google.com/groups?threadm=5.1.0.14.2.20030326162310.01dab620%40mail.geeksalad.org">http://groups.google.com/groups</a></p>
<p><a href="http://groups.google.com/groups?threadm=5.1.0.14.2.20030328092715.029084b0%40mail.geeksalad.org">http://groups.google.com/groups</a></p>


<h4><a name="getopt.macro">getopt.macro</a></h4>
<p>Inspired by the argument processing in Leon Brocard's <code>uniq(1)</code>
implementation, Jonathan Scott Duff presented a getopt macro for
Parrot programmers. Benjamin Goldberg had a few suggestions about how
to make things a little more flexible.</p>
<p><a href="http://groups.google.com/groups?threadm=20030327132923.B16979%40cbi.tamucc.edu">http://groups.google.com/groups</a></p>


<h4><a name="patch_to_examples/assembly/cat.pasm">Patch to <em>examples/assembly/cat.pasm</em></a></h4>
<p>Paul Duncan offered a patch to <em>examples/assembly/cat.pasm</em> which
would cause it to terminate when it received a ctrl-D.</p>
<p><a href="http://groups.google.com/groups?threadm=20030327235825.GH27611%40ns.snowman.net">http://groups.google.com/groups</a></p>


<h4><a name="imcc_and_scientific_notation">IMCC and scientific notation</a></h4>
<p>Having got IMCC working in a win32 environment, Clinton A Pierce
discovered that IMCC didn't understand scientific notation, but the
parrot assembler does. Leo T&ouml;tsch pointed out that it sort of
does, but instead of <code>1e20</code> you have to write <code>1.e20</code>. Joseph Ryan
wondered if handling scientific notation wasn't really a job for
individual compilers, but Clint and Mark Biggar explained why this
wasn't a good idea. As Mark said, in a world with BigFloats you don't
want to have to expand 1e2048 into a 2049 character string if you can
possibly help it.</p>
<p><a href="http://groups.google.com/groups?threadm=rt-21729-54213.8.88208842817178%40bugs6.perl.org">http://groups.google.com/groups</a></p>


<h4><a name="rt_spam">RT spam</a></h4>
<p>Someone claiming to be Marla Hurley crawled out from under a stone and
took it upon themselves to offer credit to the perl6 RT
installation. Thanks. We needed that.</p>



<h3><a name="meanwhile,_over_in_perl6language">Meanwhile, over in perl6-language</a></h3>
<p>The language list was again busier than the internals list this week,
but volume has fallen on both lists. (If you don't count an off topic
thread on the internals list, which I haven't, there were only 22
messages there this week. And very few patches from Leopold
T&ouml;tsch, I hope he's all right.)</p>


<h4><a name="is_static">is static?</a></h4>
<p>Discussion of static/state variables continued. Arcadi Shehter
wondered if it made sense to attach <code>but</code> properties to closures. I
confess I didn't really understand what he was driving at. Austin
Hastings and Larry saw something in it, and the question shifted to
ways of doing state variable initialization, which in turn led to
possible changes in the various control of flow keywords. As Larry
pointed out, if you have a static variable:</p>
<pre>
   state $variable</pre>
<p>Then, assuming that you need 'undef' to be a possible value for your
variable, you need some way of doing once and only one initialization
of that variable.</p>
<pre>
   state $variable;
   ONCE_AND_ONLY_ONCE { $variable = $initial_value };</pre>
<p>The problem is that INIT and CHECK blocks happen too early; in the
code above, <code>$initial_value</code> may well not be set, if your state
variable is set up inside a closure this becomes even more
likely. Larry reckons that the most useful initialization semantics
appear to be 'just in time'. In other words you want initialization to
happen on the first actual call to a closure. But <code>FIRST {...}</code> is
already taken, so Larry is considering renaming FIRST and LAST to
ENTER and LEAVE, freeing up FIRST to mean &quot;my very first
time&quot;. Freudian analysis was discouraged.</p>
<p><a href="http://groups.google.com/groups?threadm=15998.63434.790251.478232%40gargle.gargle.HOWL">http://groups.google.com/groups</a></p>


<h4><a name="argument_initializations">Argument initializations</a></h4>
<p>Michael Lazzaro summarized the various different and proposed
assignment operators available in Perl 6, including a proposed <code>::=</code>
for 'only assign to uninitialized variables'. Michael wondered how
these could be used in method signatures and proposed some changes to
the signature system as set out in Apocalypse 6. People were dubious
about this, with Damian saying &quot;I don't think that allowing 20
different types of assignment in the parameter list of a subroutine
actually helps at all.&quot; I'm not sure Michael is convinced yet.</p>
<p><a href="http://groups.google.com/groups?threadm=8E178DC3-5EF1-11D7-BB31-00050245244A%40cognitivity.com">http://groups.google.com/groups</a></p>


<h4><a name="p6ml">P6ML?</a></h4>
<p>Michael Lazzaro asked if anyone was actually working on P6ML (a
project name that popped up last week in the 'XML is too hard for
Programmers' thread) and if there was any idea of what such a project
would entail. Robin Berjon was unsure of the wisdom of such a project,
arguing that supporting a tool that wasn't strict about the XML it
parsed would be a retrograde step and giving reasons as to
why. However, he did think that creating a toolset for 'recuperating
data from a quasi-XML [document] (aka tag soup)' would be interesting
and useful, and he proposed a couple of approaches.</p>
<p>It's apparent, from reading this thread that people who don't like the
current generations of XML tools really don't like them at all:
adjectives such as 'craptacular' and phrases like 'festering pile of
steaming camel turds' were bandied about. Then there's the 'Perl has
lots of ways of doing XML, which is great because you can pick the one
that suits you' camp, and the 'Perl has lots of ways of doing XML,
which is terrible because you have to pick the one that suits you and
that takes time' camp.</p>
<p>Leon Brocard pointed out that, whilst Perl 6 might have nicer syntax
and a faster parsing engine, there was nothing to stop people working
out, and implementing, the required semantics in Perl 5 right
now. There was a fair amount of muttering that, however desirable or
otherwise P6ML may be, there wasn't really much need to be discussing
it on a language design list (as if that could stop anything).</p>
<p>Dan Sugalski caught everyone out by raving about the idea: &quot;the
thought of altering Perl 6's grammar to make it a functional language
is sheer genius [...] I say we start right away!&quot;. The only catch is
that Dan was talking about ML, a programming language and he bent the
needle on Austin Hasting's Sarcasmeter. But he promised to fix any
such devices at OSCON if their owners would bring them to him
there. So that's all right then.</p>
<p><a href="http://groups.google.com/groups?threadm=D53FA5D4-5EF1-11D7-BB31-00050245244A%40cognitivity.com">http://groups.google.com/groups</a></p>


<h4><a name="summary_writer_goes_all_red_and_glowy.">Summary writer goes all red and glowy.</a></h4>
<p>Matthijs van Duin pointed out that Piers had misspelled him as
'Mattijs' 4 times in last week's summary.</p>
<p>I am really sorry and I shall endeavour never to do it again.</p>


<h4><a name="support_for_attributed_dags">Support for attributed DAGs</a></h4>
<p>In a thread deceptively named 'Perl and *ML', Dan opined that XML
would be so much easier to support if Perl had good support for
attributed DAGs (That's Directed Acyclic Graphs, or 'trees'), and
noted that having such support would be good for things like Abstract
Syntax Trees too. Robin Berjon wasn't so sure, pointing out that,
whilst fast and efficient graph support would be really useful,
acyclic graphs weren't that useful for XML as useful XML
representations usually had back links to parent and sibling nodes
(and that's before you take linking into account). I have the feeling
that further discussion of graph support probably belongs on the
internals list for the time being, but I could well be wrong.</p>
<p><a href="http://groups.google.com/groups?threadm=a05210603baa7749a319f%40%5B63.120.19.221%5D">http://groups.google.com/groups</a></p>



<h3><a name="acknowledgements,_announcements_and_apologies">Acknowledgements, Announcements and Apologies</a></h3>
<p>I've already apologized to Matthijs &quot;Mattijs&quot; van Duin for misspelling
his name, but I'll do it again. I'm really, really sorry.</p>
<p>If you've appreciated this summary, please consider one or more of the
following options:</p>
<ul>
<li>
Send money to the Perl Foundation at
<a href="http://donate.perl-foundation.org/">http://donate.perl-foundation.org/</a> and help support the ongoing
development of Perl.</li>


<li>
Get involved in the Perl 6 process. The mailing lists are open  to
all. <a href="http://dev.perl.org/perl6/">http://dev.perl.org/perl6/</a> and <a href="http://www.parrotcode.org/">http://www.parrotcode.org/</a>
are good starting points with links to the appropriate mailing lists.</li>


<li>
Send feedback, flames, money, photographic and writing commissions, or
an ArtixScan 2500f to <em><a href="mailto:p6summarizer@bofh.org.uk">p6summarizer@bofh.org.uk</a></em></li>

</ul>
<p>This week's summary was again sponsored by Darren Duncan. Thanks
Darren. If you'd like to become a summary sponsor, drop me a line at
<em><a href="mailto:p6summarizer@bofh.org.uk">p6summarizer@bofh.org.uk</a></em>.</p>

        </div>



    </div>
    <div class="asset-footer"></div>
</div>


                            
                            <div id="entry-1090" class="entry-asset asset hentry">
    <div class="asset-header">
        <h2 class="asset-name entry-title"><a href="/pub/2003/03/26/perlanddotnet.html" rel="bookmark">Five Tips for .NET Programming in Perl</a></h2>
        <div class="asset-meta">
            <span class="byline">
    
                By <span class="vcard author">Randy Ray</span> on <abbr class="published" title="2003-03-26T00:00:00-08:00">March 26, 2003 12:00 AM</abbr>
    
            </span>

            
            

        </div>
    </div>
    <div class="asset-content entry-content">

        <div class="asset-body">
            
<!-- sidebar begins -->
<!-- don't move sidebars -->
<!-- sidebar ends -->


<p><i>Randy Ray is coauthor of <a href="http://www.oreilly.com/catalog/pwebserperl/">Programming Web Services with Perl</a></i></p>

<p><i>Abstract: One of the most common categories of questions on the
        <tt>SOAP::Lite</tt> mailing list is how to get Perl SOAP applications to
        work with .NET services. It's not that Perl and <tt>SOAP::Lite</tt> are
        not suited to the job, but rather that there are easy traps to fall
        into. Add to that the fact that .NET has its own distinct philosophy
        toward applications, and the confusion is understandable. This
        article will cover some of the most common traps and considerations
        that trip up Perl developers.</i></p>
		
    <h3>The .NET Attraction</h3>
	
    <p>When Microsoft first announced its .NET initiative and the variety of
      technologies that would be created to support it, it was met with some
      skepticism. Reactions ranged from "they're at it again" to "this could
      potentially be really powerful." Right now, the reality is sitting
      somewhere in between, but it is gradually moving from the realm of "just
      another Microsoft gimmick" to widespread acceptance. Whatever else the
      .NET concept accomplishes, it is already bringing Web services to the
      general desktop arena.</p>
	  
    <p>One of the limiting factors to the larger acceptance of .NET has been
      the limited set of fully supported languages. Microsoft
      promotes its C# language, while also providing .NET-enabled
      development tools and environments for the other languages that its Visual Studio product supports--Java, C++, and Visual Basic. Because .NET
      is based on several published standards, other tools that are not
      generally .NET-centric are still useful, and provide alternatives to the
      Microsoft tools for some languages, primarily Java.</p>
	  
    <p>The main XML concepts to keep in mind when dealing with a .NET service
      are XML Schema and WSDL, the Web Services Definition Language. A .NET
      service automatically generates a WSDL description of itself as a part of
      the tool environment that Microsoft provides. This is a powerful
      feature, and the key to interoperability with other languages. WSDL
      itself defers the definition of complex datatypes to the XML Schema
      application, which describes both document structure and the nature of
      the content itself.</p>
	  
	  <csperl file="grab" domain="on" record="b/818" template="article_sidebar.view">
	  
    <p>Unfortunately, Perl has been largely overlooked in the tools arena where
      .NET is concerned. Even though the purpose of basing .NET on open
      standards was to enable wider integration with other tools, systems, and
      languages, the only .NET product for Perl currently available is a Visual
      Studio plug-in for Perl that runs on only Microsoft-based platforms. As
      the number of .NET services grows, so will the desire to access these
      services from Perl clients, often on platforms that don't support Visual
      Studio. The key to doing this lies in the fact that .NET services
      natively support SOAP as an interface, through the WSDL descriptions.</p>
	  
    <h3>The Tips &amp; Tricks</h3>
	
    <p>The rest of this article offers five hints and help on writing these
      clients in Perl, using the <tt>SOAP::Lite</tt> toolkit.</p>
	  
<ol>
<li><p><b>Identify and Qualify</b></p>

    <p>The first, and most common, mistake that Perl clients make is to forget
      that .NET interfaces are strongly typed and use named arguments. Perl
      does neither of these things by default. In fact, when dealing with a
      SOAP service that is written in Perl, most of the time a client
      doesn't have to worry about things such as parameter name or type. A .NET
      service is strict about the names and types (and namespace URIs) of
      the arguments.</p>
	  
    <p>For example, imagine a service that provides the current time, possibly
      adjusted for time zone. The call, <tt>getCurrentTime</tt>, may be called
      with no arguments for the time in UTC (Universal Coordinated Time), or it
      may be passed a single argument, <tt>zone</tt>, the specified  time zone
      for which the time should be adjusted. It expects this argument to be of
      type <tt>string</tt> (using the definition of that basic type from the
      XML Schema specification). But simply passing the argument to a call
      won't get the name right. Instead, <tt>SOAP::Lite</tt> will create a
      generic name for the parameter when it creates the actual XML, and .NET
      will reject it.</p>
	  
    <p>To get around this, use the <tt>SOAP::Data</tt> class that is a part of
      <tt>SOAP::Lite</tt> (it is in the same module, so you don't have to load
      a second library):</p>
	  
    <pre><code>
 $arg = SOAP::Data->new(name => 'zone', value => 'PST');
    </code></pre>
	
    <p><tt>SOAP::Lite</tt> will properly identify values like "PST" (Pacific
      Standard Time) or "CDT" (Central Daylight Time) as being strings. But
      what if the interface also accepts numerical offsets like "-0800" or
      "+1100"? Without explicit casting as strings, those values would be
      encoded as <tt>int</tt> values. And the service would reject them.</p>
	  
    <p>The <tt>SOAP::Data</tt> class covers this as well:</p>
	
    <pre><code>
 $arg = SOAP::Data->new(name => 'zone', value => 'PST', type => 'xsi:string');
    </code></pre>
	
    <p>(The <i>xsi:</i> prefix on the type refers to the XML Schema Instance
      namespace, which <tt>SOAP::Lite</tt> always defines and associates with
      that specific identifier.)</p>
	  
    <p>The <tt>SOAP::Data</tt> class provides methods for all aspects of the
      data item: <tt>name</tt>, <tt>value</tt>, <tt>type</tt>, and so on. It also
      provides <tt>uri</tt> to specify the namespace URI (when needed), and
      <tt>encodingStyle</tt> to specify the URI that identifies an alternative
      encoding from that being used in the rest of the request.</p></li>
	  
<li><p><b>Be Careful About Namespaces</b></p>
	
    <p>The XML namespaces used on elements are just as important in a .NET
      service as the name and type are. SOAP relies on
      namespaces to distinguish parts from each other, but again the relaxed
      nature of Perl can mean that Perl-based services lure you into a false
      sense of ease that .NET doesn't share.</p>
	  
    <p>Unfortunately, <tt>SOAP::Lite</tt> makes this harder for .NET
      applications by defaulting to no namespace for elements when none is
      explicitly given. Luckily, the <tt>SOAP::Data</tt> class includes a
      method for defining the namespace as well:</p>
	  
    <pre><code>
 $arg->url('http://use.perl.org/Slash/Journal/SOAP');
    </code></pre>
	
    <p>Explicitly providing the namespace gets even more important when
      encoding complex types such as hashes and arrays.</p></li>
	  
<li><p><b>Use Classes and Objects to Control Encoding</b></p>

    <p>The default methods that <tt>SOAP::Lite</tt> uses to encode arrays and
      hash tables will not produce the style of XML that a .NET service is
      expecting. <tt>SOAP::Lite</tt> will base things on the plainest, most
      vanilla-type descriptions in the SOAP specification itself, while
      .NET uses complex types as defined in XML Schema for elements that are
      not basic data.</p>
	  
    <p>Suppose a .NET interface defines a complex type it called
      <b>CodeModuleDef</b>. This type has (for now) three simple elements: the
      <i>name</i> of the module, the <i>language</i> it is in, and the
      <i>lines</i> of code. Now imagine the remote method <b>registerModule</b>
      expects one such object as an argument. This <em>won't</em> work:</p>
	  
    <pre><code>
 $soap->registerModule(SOAP::Data->name('module')->uri->('http://...')->
                       value({ name => 'SOAP::Lite', language => 'perl',
                               lines => 4973 }));
    </code></pre>
	
    <p>The receiving server will get an element typed as "SOAPStruct" in the
      default namespace for unknown types (http://xml.apache.org/xml-soap).
      While setting the name and URI were OK, the type will still stop things
      dead in their tracks. Instead, do this:</p>
	  
    <pre><code>
 $soap->registerModule(SOAP::Data->name('module')->uri->('http://...')->
                       value(bless { name => 'SOAP::Lite',
                                     language => 'perl',
                                     lines => 4973 }, 'CodeModuleDef'));
    </code></pre>
	
    <p>The resulting structure will have the correct type attribute set. The
      same approach can be used for array references and scalars that are
      types other than the basic types.</p></li>
	  
<li><p><b>Oops ... Watch Out for Element Order and Namespaces</b></p>

    <p>This actually won't quite bridge the gap all the way. There are two
      problems with it. One is a general Perl feature, the other may be a bug
      with <tt>SOAP::Lite</tt>.</p>
	  
    <p>The first problem is that XML Schema generally requires the elements of
      a complex type to be in a well-defined order (there's one type of
      compound structure that doesn't require this, but it isn't a commonly
      used). Perl, by nature, doesn't preserve a specific order to hash
      keys. You can use the <b>Tie::IxHash</b> module, if you know you will
      always insert the keys in the correct order. Or, you can provide your own
      serialization code for <tt>SOAP::Lite</tt> to use. As it happens, this
      will allow you to fix the second problem, too. The second problem stems
      from the fact that <tt>SOAP::Lite</tt> assigns the correct namespace to
      the outer element of the structure, but not to the inner elements. In a
      schema-based type, all the elements must be in the same namespace. This
      may be a bug in <tt>SOAP::Lite</tt>, but that hasn't been determined for
      certain (it seems like an unusual feature). The inner elements are in
      fact given no namespace at all.</p>
	  
    <p>What is needed is a function that can be given to the serializer to use
      when it encounters an object of any of the special classes. This routine
      won't have to actually produce XML, <tt>SOAP::Lite</tt> will still take
      care of that. This routine will only have to produce a structure that the
      serializer will understand from the object it is given. A filter, in
      other words. To do that, two things are needed: an explicit declaration
      of the field-order, and an understanding of how the serializer expects to
      call this filter, and what it expects to be returned by it.</p>
	  
    <p>The explicit ordering is simple; it can be an array declared in the
      class namespace, or a "private" key on the hash itself. Unlocking the
      second piece took some digging around into the internals of the
      <tt>SOAP::Lite</tt> source code. Connecting the two took even more
      digging.</p>
	  
    <p>For the example approach below, assume that any class that will use this
      generic serialization filter defines an array called <tt>@FIELDS</tt> as
      a package-global value. Warning: This approach may be a little hard
      to wrap one's brain around at first. We'll explain it after the code:</p>
	  
    <pre><code>
 sub serialize_complex_type {
   my ($soap, $obj, $name, $type, $attr) = @_;

   my @fields = do { no strict 'refs'; @{ref($obj) . '::FIELDS'} };
   if ($name =~ /^(\w+):(\w+)$/) {
     $name = $2;
     $attr->{xmlns} = $attr->{"xmlns:$1"};
     delete $attr->{"xmlns:$1"};
   } else {
     $attr->{xmlns} = $attr->{uri};
   }

   [ $name, $attr,
   [ map { defined($obj->{$_}) ?
           $soap->encode_object($obj->{$_}, $_) : () }
     @fields ] ];
 }
    </code></pre>
	
    <p>Additionally, every package that plans to use it to serialize their
      objects will have to make it visible to the <tt>SOAP::Serializer</tt>
      package:</p>
	  
    <pre><code>
 *SOAP::Serializer::as_Some__Class = \&amp;main::serialize_complex_type;
    </code></pre>
	
    <p>Here, we assumed a class name of <tt>Some::Class</tt>, and that the
      earlier code was declared in the main namespace. So what does it all
      do?</p>
	  
    <p>The serializing routine is called by an object derived from
      <tt>SOAP::Serializer</tt> (or a subclass of it), as a method with the
      object to serialize, its name, its type, and the hash table of attributes
      as arguments. It expects to get back an array reference with three or four
      values. The first is the tag name to use. The second is the hash
      reference of attributes to add to the opening tag, and the third is
      either an array reference of nested content, or a simple scalar value to
      be put inside the opening and closing tag pair. The fourth element, should
      you include it, is a value for an "ID" attribute. This is used to
      uniquely identify an element, for the sake of multiple references and
      such. We don't worry about it here. </p>
	  
    <p>So we take the arguments as they are given, and the first thing the
      routine does is check for a name that includes a namespace. Since the
      style of <tt>SOAP::Lite</tt> will leave any child elements unqualified,
      the namespace label is stripped and the URI itself is assigned to the
      simple <tt>xmlns</tt> attribute. This will make it apply to any child
      elements of this object. If the object contains other objects as
      children, then they too will be run through this serializer, so they will have
      the chance to declare a namespace in the same way. If there was no label,
      then we take the value of the <tt>uri</tt> attribute, which would have been
      set by calling the <tt>SOAP::Data</tt> method of the same name. Finally,
      we build the array reference using the (possibly modified)
      <tt>$name</tt>, the modified attribute hash reference and an array
      reference of the object's elements, in field order.</p>
	  
    <p>We got the field order by using a symbolic reference to the
      <tt>@FIELDS</tt> array for the object's class. Much the same sort of
      trick is needed to get the <tt>SOAP::Serializer</tt> class to use this
      code. When handed a blessed object, the serializer takes the class name,
      changes all "::" to "__", and prepends "as_" to the result. It then looks
      for a method by that name. It searches using the serialization object
      itself, so the method has to be visible to that class. Right now, there
      isn't a way in <tt>SOAP::Lite</tt> to do this more directly. To hook this
      serialization into place, we directly alias "as_Some__Class" into the
      needed package, as shown above.</p>
	  
    <p>Note that the recursive encoding of the object's contents (which may be
      objects themselves) is handled by a <tt>SOAP::Serializer</tt> method
      called "<tt>encode_object</tt>." This is an undocumented part of the
      serializer that was the source of much of the logic for the code snippet
      above. It was by examining this routine that the above code (in a slightly
      different form) was used in writing a complex client to use the
      MapPoint.NET service, one of Microsoft's commercial .NET services.</p></li>
	  
<li><p><b>Play with <tt>stubmaker.pl</tt> and <tt>SOAPsh.pl</tt></b></p>
	
    <p>For the last tip, a more simple piece of advice. The <tt>SOAP::Lite</tt>
      package comes with a number of utility scripts. Among these are a "shell"
      for testing SOAP services, called <tt>SOAPsh.pl</tt>, and a
      code-generation tool for generating classes from WSDL description files,
      called <tt>stubmaker.pl</tt>.</p>
	  
    <p>As was mentioned earlier, WSDL plays a major role in the definition and the 
      documentation of .NET services. The <tt>stubmaker.pl</tt> tool tries to
      create Perl classes based on a WSDL document. It does a fairly good job,
      but it lacks in support for XML Schema. If a service uses any nonbasic
      types, then the template that <tt>stubmaker.pl</tt> generates would not handle
      it as well.</p>
	  
    <p>This should not prevent you from using the tool. It does a lot
      of the heavy lifting by extracting the proper namespace URLs, actual
      server URLs, and remote method names. Even if the code template itself
      cannot be used directly, then it could still save you work.</p></li>
	  
</ol>
	  
    <h3>Summary</h3>
	
    <p>There is much more to properly dealing with .NET services than can be
      addressed in a single article. The goal here is to head off some of the
      more frequently encoutered problems, and let you as the developer focus
      on more important issues.</p>
	  
    <p>One of the biggest drawbacks to using Perl for .NET is that there is
      only limited support at present for WSDL and XML Schema. Some
      new CPAN modules are working to fill these gaps, but they are
      in early stages of functionality. For now, it is still necessary to do
      some of the core steps manually. This situation should improve
      over time.</p>
	  
    <p>As a last "bonus" tip, remember this: Much of the advice here is just as
      important for writing .NET services, as it is for writing
      .NET clients. For the next Web service you write, consider the additional
      client base you would have access to if you wrote it to be compatible
      with .NET.</p>
	  
<hr size="1" noshade="noshade" />

<p>
O'Reilly &amp; Associates recently released (December 2002) <a href="http://www.oreilly.com/catalog/pwebserperl/">Programming Web Services with Perl</a>.
</p>

<ul>
<li><p>
<a href="http://www.oreilly.com/catalog/pwebserperl/chapter/index.html">Sample Chapter 6, Programming SOAP</a>, is available 
free online. 
</p></li>

<li><p>
You can also look at the <a href="http://www.oreilly.com/catalog/pwebserperl/toc.html">Table of Contents</a>, the 
<a href="http://www.oreilly.com/catalog/pwebserperl/inx.html">Index</a>, and the <a href="http://www.oreilly.com/catalog/pwebserperl/desc.html">Full Description</a> of 
the book.
</p></li>

<li><p>
For more information, or to order the book, 
<a href="http://www.oreilly.com/catalog/pwebserperl/">click here</a>.</p></li>  
</ul>





        </div>



    </div>
    <div class="asset-footer"></div>
</div>


                            
                            <div id="entry-1098" class="entry-asset asset hentry">
    <div class="asset-header">
        <h2 class="asset-name entry-title"><a href="/pub/2003/03/p6pdigest/20030323.html" rel="bookmark">This week on Perl 6, week ending 2003-03-23</a></h2>
        <div class="asset-meta">
            <span class="byline">
    
                By <span class="vcard author">Piers Cawley</span> on <abbr class="published" title="2003-03-23T00:00:00-08:00">March 23, 2003 12:00 AM</abbr>
    
            </span>

            
            

        </div>
    </div>
    <div class="asset-content entry-content">

        <div class="asset-body">
            
<!-- sidebar begins -->
<!-- don't move sidebars -->
<!-- sidebar ends -->


<p>Assuming I can tear myself away from stroking the cat who has just
magically appeared on my chest and is even now trying to wipe his dags
on my nose, welcome one and all to another Perl 6 summary, which
should go a lot quicker now that Sully has moved off and let me see
the screen. He'll be back though. But before that happens we'll start
with perl6-internals.</p>


<h4><a name="speed_question:_save/restore_vs_push/pop">Speed question: save/restore vs push/pop</a></h4>
<p>Benjamin Goldberg wondered about how many <code>save</code>s it takes to be
slower than one <code>pushx</code>. Steve Fink pointed out that <code>save</code> and
<code>pushx</code> are not interchangeable as they push things onto totally
different stacks (<code>save</code> pushes onto the generic user stack, <code>pushx</code>
push onto type specific register frame stacks). Leo T&ouml;tsch
ignored this difference (which Ben was apparently aware of) and did
some tests which showed that, on his local architecture and core, 2
saves were slower than one push. On Dan's machine, it took 3 saves to
be slower than one push. Dan also pointed out that, on some
architectures, there's a subtle win with saves because a push would
dirty the L1 and L2 caches while the save wouldn't. (On SPARC at
least, apparently).</p>
<p><a href="http://groups.google.com/groups?threadm=3E756D30.1A1E32CD%40earthlink.net">http://groups.google.com/groups</a></p>


<h4><a name="baby_steps_in_porting_io_to_the_pio_architecture">Baby Steps in porting IO to the PIO architecture</a></h4>
<p>Last week, Leon Brocard posted his implementation of the <strong>uniq(1)</strong>
Unix utility to PASM. This week, J&uuml;rgen B&ouml;mmels' ongoing
project of moving Parrot's IO operators from the STDIO library to
Parrot's own PIO library (which is asynchronous and a combination of
lovely and scary by all reports.) broke this because PIO didn't have
any read buffering capabilities, which means that the <code>readline</code> op
didn't work.</p>
<p>On Monday, J&uuml;rgen had write buffering working, which Dan applied
with alacrity while making noises about needing to finish up the
documentation for Parrot's asynchronous IO system. There was some
debate on whether a PIO flush should force a write to the disk, or
simply ensure that all the buffers were flushed to the OS. Nicholas
Clark discussed some issues he'd had with Perl 5.8's PerlIO system,
and the need for two different kinds of flush, or more succinctly, the
need to distinguish 'flush' from 'sync'. Dan was convinced by this
argument and Steve Fink seconded the decision.</p>
<p>Then, on Sunday, J&uuml;rgen released a patch which got read
buffering working. Dan had a few problems with it and the patch hadn't
been applied by the end of the week. I'm sure it'll go in like a
greased weasel once that's been fixed though.</p>
<p><a href="http://groups.google.com/groups?threadm=rt-21600-53762.1.82033716216168%40bugs6.perl.org">http://groups.google.com/groups</a> -- J&uuml;rgen adds
write buffering</p>
<p><a href="http://groups.google.com/groups?threadm=20030318215758.GD290%40Bagpuss.unfortu.net">http://groups.google.com/groups</a> -- Nicholas discusses
different types of <code>flush</code></p>
<p><a href="http://groups.google.com/groups?threadm=rt-21656-53999.2.32338126263997%40bugs6.perl.org">http://groups.google.com/groups</a> -- J&uuml;rgen adds
read buffering</p>


<h4><a name="pbc_object_files">PBC Object Files</a></h4>
<p>Michael Collins wondered if it might be a good idea to come up with a
parrot 'object file' specification. I liked Michael's description of
an object file as 'a file that contains compiled instructions plus a
section with a table that maps subroutine/constant labels to their
corresponding byte offsets within the file.' Leo T&ouml;tsch's answer
was 'not yet'. Apparently the basic functionality is there but there
are some cleanups and a couple of opcodes needed.</p>
<p><a href="http://groups.google.com/groups?threadm=3e7647b7.c774.0%40bestweb.net">http://groups.google.com/groups</a></p>


<h4><a name="parrot_binaries">Parrot binaries</a></h4>
<p>Ask Bj&oslash;rn Hansen posted to say that he'd been trying to make
an RPM <em>.spec</em> file for parrot and had noted the lack of a <code>make
install</code> target. He also wondered about the permissions of various
files in the distribution, which seem somewhat cockeyed. Steve Fink
posted a patch which covered some of this (or at least the make
install and RPM issues) with tools which would generate RPMs and asked
for comments on his work. Leo T&ouml;tsch liked it and offered a
couple of suggestions</p>
<p><a href="http://groups.google.com/groups?threadm=86u1e0x1sf.fsf%40miette.develooper.com">http://groups.google.com/groups</a></p>
<p><a href="http://groups.google.com/groups?threadm=20030319175639.GF662%40foxglove">http://groups.google.com/groups</a> -- Steve's working patch</p>


<h4><a name="some_comments_on_pdd_14_big_numbers">Some comments on PDD 14 Big Numbers</a></h4>
<p>Mark Biggar, who implemented the original Big* packages for Perl had
some suggestions about Parrot's big number handling based on PDD
14. Benjamin Goldberg wondered if it would be a good idea to design
our BigInt type so that we could replace the maths engine with a
different engine so that users could pick which ever engine they
prefer as configuration option, and so that new maths engines could be
added without having to make wholesale changes.</p>
<p><a href="http://groups.google.com/groups?threadm=3E77BD4F.5090006%40attbi.com">http://groups.google.com/groups</a></p>


<h4><a name="99_bottles_of_beer_on_the_wall">99 bottles of beer on the wall</a></h4>
<p>Douglas Hunter appears to have noticed that, up until now, Parrot had
lacked a vital program -- one which would output the lyrics to that
well known song, <em>99 Bottles of Beer on the Wall</em>. So, being a
community spirited kind of chap, he implemented just that and posted
it to the list. A few people quibbled about his style (unnecessary
labels, that sort of thing). Leo T&ouml;tsch pointed out, with the
aid of some IMCC output that the optimizer caught those issues anyway,
and added the code to the Parrot distribution's <em>examples/</em>
directory. Well done Douglas, it's good to see Parrot being used for
essential applications like this. I'm just surprised nobody has yet
benchmarked the Parrot implementation against Perl and Python. This
may just be the test application we need for the Parrot/Python speed
challenge.</p>
<p><a href="http://groups.google.com/groups?threadm=3E78F149.3020502%40plusthree.com">http://groups.google.com/groups</a></p>


<h4><a name="basic,_imcc_and_windows">BASIC, IMCC and Windows</a></h4>
<p>Clinton A Pierce has been having a hard time making good on his offer
to produce a milestone Windows binary for distribution. He's having a
hard time building IMCC because it seems to want headers that MSVC++
isn't happy with. Dan  noted that this needs to be fixed before the
next release of Parrot (which will be either 0.1.0 or
0.0.11) because he wants to get rid of the IMCC/parrot difference and
just have a single binary. Leo T&ouml;tsch and Nicholas Clark offered
a few suggestions about workarounds, but it looks like there's still
no Windows distribution for Parrot.</p>
<p><a href="http://groups.google.com/groups?threadm=3E7AF5A0.7010104%40toetsch.at">http://groups.google.com/groups</a></p>


<h4><a name="iterator_proof_of_concept">Iterator Proof of Concept</a></h4>
<p>Following the deafening response to his Iterator proposal of last
week, Leo T&ouml;tsch agreed with me that that must mean that
everyone liked the idea and posted a proof of concept patch and
invited comments. Nobody has yet done so.</p>
<p><a href="http://groups.google.com/groups?threadm=3E7C4808.8090801%40toetsch.at">http://groups.google.com/groups</a></p>


<h4><a name="vtable_1__accessor_macros">vtable_1 - accessor macros</a></h4>
<p>Leo T&ouml;tsch has started work on hiding vtable functions and
posted his first patch. He commented that the new accessor macros seem
to make for more readable source files. He asked if people were okay
with the macro, as the next step would be to start using the macros
all over the parrot source. Nicholas Clark liked the basic idea, but
worried about documentation, and about the possibility of scary macro
layering a la Perl 5. He also wondered if it would be possible to
conditionally write them as inline functions, which would make
debugging easier. Leo didn't see much point in making this particular
set of macros into inline functions as they were simple translations
with no complex functionality.</p>
<p><a href="http://groups.google.com/groups?threadm=3E7D886A.8050502%40toetsch.at">http://groups.google.com/groups</a></p>


<h4><a name="parrot_0.0.10_released">Parrot 0.0.10 released</a></h4>
<p>Parrot version 0.0.10, codename 'Juice' was released on
Wednesday. Steve Fink rounded up the usual list of improvements and
generally did a good job of letting the world know about the new
Parrot release. If you want the details, follow the link.</p>
<p><a href="http://groups.google.com/groups?threadm=20030319033557.GD23200%40foxglove">http://groups.google.com/groups</a></p>


















<h3><a name="meanwhile,_over_in_perl6language">Meanwhile, over in perl6-language</a></h3>
<p>perl6-language was again the busier list this week. The fallout from
Apocalypse 6 continues both with clarifications of what was in that
document and some suggestions inspired by it.</p>


<h4><a name="is_static">is static?</a></h4>
<p>Towards the end of last week, Uri Guttman had asked about a possible
'is static' variable trait, and the discussion carried on into the
this week. Arcadi Shehter suggested using <code>has</code> to introduce a static
variable:</p>
<pre>
    sub foo () {
        has $s //= 0;
        $s ++;
    }</pre>
<p>Larry described this as a <em>very</em> interesting idea, but was concerned
that this might be akin to overloading the meaning of <code>has</code> in the
same way that C overloaded the meaning of <code>static</code>. Damian also
worried that using 'has' in this way would mean stretching 'the concept
of objects a little too far'. He also thought that using <code>//=</code> to
initialize such a variable felt wrong, and that maybe we needed a
third assignment operator to go with 'assign unless true (<code>||=</code>)' and
'assign unless defined (<code>//=</code>)', which could be thought of as 'assign
unless exists' and suggested <code>??=</code> as a possible (though he didn't
profess to actually like it). Damian also thought that such
functionality should really be introduced with a trait and suggested a
list of possible trait names. Uri was unconvinced by any of Damian's
alternatives and proposed deciding the name with a duel on the beach
at Boca Raton.</p>
<p>Larry decided that using a trait to denote a 'static' variable would
be the wrong way to go because such a variable has a different kind of
scope from a <code>my</code> variable and described the whatever declaration was
eventually settled on as introducing a lexically scoped alias to a
property of the current block. Larry later suggested <code>state $s = 0</code>
because 'a static var makes a subroutine stateful'. Uri wasn't sure,
but Damian liked it.</p>
<p>Arcadi Shehter wondered about scoping of lexically scoped subs and if
they could really be thought of as lexically scoped at all, whereupon
he and Matthijs van Duin got a bit tangled up with the various kinds of
scoping available, but there's been no definitive comment from Damian
or Larry about the correct behaviour.</p>
<p><a href="http://groups.google.com/groups?threadm=15988.34979.963066.105078%40gargle.gargle.HOWL">http://groups.google.com/groups</a></p>


<h4><a name="on_the_place_of_scalar_in_any_class_hierarchy">On the place of Scalar in any class hierarchy</a></h4>
<p>During the discussion last week about strictness and type coercion on
function calls, some confusion arose about whether <code>Int isa Scalar</code>,
or <code>Scalar isa Int|String|Float|...</code>. David Whipp proved himself a
hero by posting on this subject, pointing out that Scalar is the type
of the variable, not of the value (I'd probably replace variable with
'container', but I'm picky like that) and explained how this solved
some of the problems people had been having. There was no comment from
Larry or Damian about this post, but I thought it was wonderful.</p>
<p><a href="http://groups.google.com/groups?threadm=20030317191207.1000.qmail%40onion.perl.org">http://groups.google.com/groups</a></p>


<h4><a name="a6_questions">A6 questions</a></h4>
<p>Dave Storrs posted a grab bag of questions about Apocalypse 6 and got
a grab bag of answers.</p>
<p><a href="http://groups.google.com/groups?threadm=20030316140934.C14569%40megazone.bigpanda.com">http://groups.google.com/groups</a></p>


<h4><a name="apoc_5__some_issues">Apoc 5 - some issues</a></h4>
<p>Matthijs van Duin had a pile of questions and issues with Apocalypse
5. Some of the questions were Hard. Only Luke Palmer dared answer
them. He and Matthijs batted things back and forth a few times, but it
looks like Matthijs still had some issues with backtracking into and
over closures.</p>
<p><a href="http://groups.google.com/groups?threadm=20030317143550.GK547%40cds.nl">http://groups.google.com/groups</a></p>


<h4><a name="xml_is_too_hard_for_programmers">``XML is Too Hard for Programmers''</a></h4>
<p>Rich Morin pointed everyone at Tim Bray's article about XML being hard
to deal with in most programming languages. Robin Berjon chipped in
with a pointer to an xml-dev thread on the same subject. There was a
certain amount of muttering about companies that use formats that seem
to walk like XML but fail to quack like XML (the initials M &amp; S were
used, and I don't think they were referring to Marks and
Spencer). Michael Lazzaro made an impassioned plea for insuring that
Perl 6 allows easy, fast parsing of XML-like things out of the
box. Austin Hastings suggested that Michael should take command of
P6ML. Dan pointed to a basic Parrot XML parser in the Parrot examples
directory that was at least four times faster than the equivalent Perl
5 code that it's a line for line translation of, and noted that the
performance numbers were old.</p>
<p><a href="http://groups.google.com/groups?threadm=p05200f03ba9d00b87d1d%40%5B192.168.254.205%5D">http://groups.google.com/groups</a></p>
<p><a href="http://www.tbray.org/ongoing/When/200x/2003/03/16/XML-Prog">http://www.tbray.org/ongoing/When/200x/2003/03/16/XML-Prog</a> -- Tim
Bray's article</p>
<p><a href="http://lists.xml.org/archives/xml-dev/200303/msg00536.html">http://lists.xml.org/archives/xml-dev/200303/msg00536.html</a> --
xml-dev thread</p>


<h4><a name="rules_and_hypotheticals:_continuations_versus_callbacks">Rules and hypotheticals: continuations versus callbacks</a></h4>
<p>Remember what I said about Matthijs van Duin still having some issues
with backtracking? Well, he kicked off a whole new thread just to
discuss it and two possible methods for implementing the grammar
system (labelled the 'backtracking continuation' and 'callback'
methods). Matthijs would like to see the backtracking continuation
method blessed as the right way. (He discusses all this here because
the choice of implementation could well have language level
implications). Luke Palmer was concerned that both of Matthijs's
proposed implementations would be very slow and had a couple of other
possible implementation approaches (the 'success continuation' and
'backtrack exception' methods). Matthijs reckoned that the success
continuation approach was pretty much the same as his 'callback'
method, and that the 'backtrack exception' method seemed to have
problems with rules like <code>&lt;foo&gt; &lt;bar&gt;</code>. And then it all got very
complicated as Dan and Matthijs went back and forth at the issue with
occasional interjections from others where appropriate. Then someone
mentioned threads...</p>
<p>Dan and Matthijs seem to have very different sets of assumptions which
leads one to suspect that they're arguing past each other on
occasion. I certainly found myself wishing there was somewhere
convenient with an ample supply of chalkboards, chalk, index cards and
Sharpies and other high bandwidth communication aids where they could
go and come to some kind of understanding.</p>
<p>At one point Austin Hastings observed that 'when anyone says ``I don't
see why anyone would ...'', Damian immediately posts an example of
why. Unless it's Damian, in which case Simon, Larry, or Dan usually
counterpost.' Hey, it made me smile.</p>
<p>I think Larry's only contribution to this thread bears repeating in
its entirety:</p>
<blockquote><p>I would like to express my sincere gratitude to all of you for working
through these issues.  I bent my brain on the Perl 5 regex engine, and
that was just a ``simple'' recurse-on-success engine--and I'm not the
only person it drove mad.  I deeply appreciate that Perl 6's regex
engine may drive you even madder.  But such sacrifices are at the
heart of why people love Perl.  Thanks!</p>
</blockquote><p><a href="http://groups.google.com/groups?threadm=20030318195515.GA8498%40cds.nl">http://groups.google.com/groups</a></p>


<h4><a name="questions_to_help_program_perl6::parameters">Questions to Help Program Perl6::Parameters</a></h4>
<p>Brent Dax is working on a Perl6::Parameters source filter for Perl 5,
a task he describes as 'damn hard'. He had a couple of questions about
argument behaviour. Damian had the answers, and made noises about his
forthcoming module, Perl6::Rules. Simon muttered something about
Parse::FastDescent (but everyone passed over that) and pointed out
Matthijs van Duin's work in progress.</p>
<p>Larry thanked Brent for taking on the task and 'suffering vicarious
pain for the user' and mentioned that he was interested in feedback on
spots where the design impacts performance unduly. Larry went on to
discuss possible changes to the scoping of <code>$_</code> to help with with the
transition from Perl 5 to Perl 6. He and Damian proceeded to discuss
other entertaining syntax possibilities to do with <code>want</code>, <code>where</code>
and <code>when</code>. Nobody has yet proposed meaningful semantics for <code>what</code>,
<code>who</code> and <code>why</code>, but I'm sure somebody will get 'round to it.</p>
<p><a href="http://groups.google.com/groups?threadm=013901c2ed93%2458d64cd0%246501a8c0%40deepblue">http://groups.google.com/groups</a></p>
<p><a href="http://www.liacs.nl/~mavduin/P6P5_0.00_01.tar.gz">http://www.liacs.nl/~mavduin/P6P5_0.00_01.tar.gz</a> -- Matthijs' work
in progress</p>


<h4><a name=".req_or_.arity"><code>.req</code> or <code>.arity</code>?</a></h4>
<p>Austin Hastings asked that Routine's <code>.req</code> method be renamed
<code>.arity</code>. Damian rather liked the idea. Larry wasn't so sure because
<code>.arity</code> is somewhat opaque to non-mathematicians, but he accepted
that one could argue that anyone who doesn't know what arity means
shouldn't be writing code that depends on it. Steffen M&uuml;ller
thought that either <code>.req</code> or <code>.reqargs</code> would be a better name for
the method.</p>
<p>For those who don't know, 'arity' is the number of arguments a
function or operator takes.</p>
<p><a href="http://groups.google.com/groups?threadm=20030318230916.30389.qmail%40web12306.mail.yahoo.com">http://groups.google.com/groups</a></p>




<h3><a name="acknowledgements,_announcements_and_apologies">Acknowledgements, Announcements and Apologies</a></h3>
<p>And another summary rolls towards its close. I'd like to echo Larry's
thanks to everyone who's working on scary magic like the Perl 6 rules
engine and Perl6::Prototypes. The way people like Brent, Matthijs,
Leo and Luke have stepped up to the plate for this undeniably Hard
Stuff is, frankly, inspirational. It's people like you who keeps me
bullish about Perl 6.</p>
<p>Thanks too to everyone else involved in either list; Michael Lazzaro
made the point that often the most productive way for perl6-language
to proceed is for an initial suggestion to be thrown out onto the
list, then everyone has a good long wibble about it going off in about
3000 different directions at once before someone (usually one of
Damian, Larry or Allison but not necessarily) pulls it all together
into something that makes sense and we move on to the next item. My
gut tells me that without all the wibbling the end result wouldn't be
quite so satisfying.</p>
<p>For instance, much as I hated trying to summarize the everlasting
pipeline thread, the end results of that discussion are the rather
lovely <code>==&gt;</code> and <code>&lt;==</code> operators that appeared in the latest
Apocalypse. (Of course, Larry or Damian will probably respond to this
summary by telling me that actually, they'd been planning something
like that all along. I just won't necessarily believe them)</p>
<p>If you appreciated this summary, please consider one or more of the
following options:</p>
<ul>
<li>
Send money to the Perl Foundation at
<a href="http://donate.perl-foundation.org/">http://donate.perl-foundation.org/</a> and help support the ongoing
development of Perl.</li>


<li>
Get involved in the Perl 6 process. The mailing lists are open  to
all. <a href="http://dev.perl.org/perl6/">http://dev.perl.org/perl6/</a> and <a href="http://www.parrotcode.org/">http://www.parrotcode.org/</a>
are good starting points with links to the appropriate mailing lists.</li>


<li>
Send feedback, flames, money, photographic and writing commissions, or
a print of Mark Citret's <em>Empty Room</em> to <em><a href="mailto:p6summarizer@bofh.org.uk">p6summarizer@bofh.org.uk</a></em></li>

</ul>
<p>This week's summary was again sponsored by Darren Duncan. Thanks
Darren. If you'd like to become a summary sponsor, drop me a line at
<em><a href="mailto:p6summarizer@bofh.org.uk">p6summarizer@bofh.org.uk</a></em>.</p>

        </div>



    </div>
    <div class="asset-footer"></div>
</div>


                            
                            <div id="entry-1088" class="entry-asset asset hentry">
    <div class="asset-header">
        <h2 class="asset-name entry-title"><a href="/pub/2003/03/18/only.html" rel="bookmark">For Perl Programmers : only</a></h2>
        <div class="asset-meta">
            <span class="byline">
    
                By <span class="vcard author">Brian Ingerson</span> on <abbr class="published" title="2003-03-18T00:00:00-08:00">March 18, 2003 12:00 AM</abbr>
    
            </span>

            
            

        </div>
    </div>
    <div class="asset-content entry-content">

        <div class="asset-body">
            
<!-- sidebar begins -->
<!-- don't move sidebars -->
<!-- sidebar ends -->


<p>Have you ever wished that you could have more than one version of a Perl
module installed on your system, and that you could easily tell Perl
exactly which one you wanted to load? Perhaps you have some legacy
programs that only run with older versions of certain modules, while the
rest of your system is coded to the more-modern versions of the same
module. Or maybe you administer a multiuser system, where your various
users request different module versions.</p>
<p>Perl's built-in mechanism for module version control is very rudimentary.
Basically, you can say:</p>
<pre><code>
    use XML::Parser 2.27;</code></pre>
<p>The <code>use</code> command will load XML::Parser and then proceed to <code>die</code> unless
<code>$XML::Parser::VERSION</code> is greater than or equal to 2.27. There is no
way to ask for one specific version or a range of versions. Most of the
time this is OK. It's OK if you assume that successive versions of
modules always improve, never drop functionality and are fully backward
compatible. Unfortunately, in real life, this isn't always true.</p>
<p>Take Lincoln Stein's excellent <code>GD</code> module for example. <code>GD.pm</code> is a
toolset for creating graphic images from Perl programs. Up to version
1.19, <code>GD</code> supported the GIF format. Due to GIF's licensing
restrictions, the author was forced to retract support. GIF support was
replaced by the PNG format, and later JPEG support was added. If you
are required to use <code>GD</code> for both GIF and PNG format types, then you need to
do some monkeying around with library paths to get it to work.</p>
<p>With big projects in restrictive environments, dealing with module
versioning issues can quickly become a tangled briar patch. When your
needs for using specific modules become too thorny, you need a sharper
chainsaw. This article describes such a saw.</p>




<h3><a name="the_only_way">The Only Way</a></h3>
<p>Introducing <code>only.pm</code>! <code>only</code> is a full featured system for installing
and loading multiple versions of Perl modules.</p>
<p>To make sure that your program loads version <code>1.19</code> of <code>GD</code>, simply say:</p>
<pre><code>
    use only GD =&gt; 1.19;</code></pre>
<p>If you know that any of the <code>GD</code> versions from 2.01 up to 2.06 are OK, then
say:</p>
<pre><code>
    use only GD =&gt; '2.01-2.06';</code></pre>
<p>If you also want to import <code>GD::foo</code> and <code>GD::bar</code>, then:</p>
<pre><code>
    use only GD =&gt; '2.01-2.06', qw(foo bar);</code></pre>
<p><code>only</code> acts as an extension to Perl's <code>use</code> command. It intercepts the
parameters that you would normally pass to <code>use</code> along with an
acceptable version range. It takes all of that information and does a
&quot;heap of bit-wrangling&quot; to make sure that you get the version of the
module you wanted. In every other respect, it tries to act like a regular
<code>use</code> statement.</p>




<h3><a name="easy_installations">Easy Installations</a></h3>
<p>How do you go about installing several versions of Perl modules? Perl is
really only designed to support the installation of a single module
version. Whenever you install a new version of a module, it simply
overwrites the older version. This is known as upgrading. Usually that's
what you want, but in the context of <code>only</code>, you actually want to have
multiple versions installed simultaneously.</p>
<p>Advanced Perl programmers know that is possible to install modules into
different directories. You can supply a <code>PREFIX=</code> parameter to the <code>make
install</code> process. But then you have to remember where you installed the
module, and manually adjust <code>@INC</code> to have the right sequence of paths.
That's just no fun.</p>
<p>Fortunately, <code>only</code> makes it extremely simple to install multiple
versions. To start with, just go about building your module in the
usual way:</p>
<pre><code>
    tar xvzf Cat-Fancy-0.09.tar.gz
    cd Cat-Fancy-0.09
    perl Makefile.PL
    make test</code></pre>
<p>Normally, the next step is <code>make install</code>. But if you want to store version
<code>0.09</code> separate from any other version of <code>Cat::Fancy</code>, do this:</p>
<pre><code>
    perl -Monly=install</code></pre>
<p>This actually does the same procedure as <code>make install</code> would except
that it automatically determines a safe place to stick your module; one
that <code>only.pm</code> can find when you say:</p>
<pre><code>
    use only Cat::Fancy =&gt; 0.09;</code></pre>
<p><strong>Note</strong>: If you need authorized access to install modules on your system,
then you can do:</p>
<pre><code>
    sudo perl -Monly=install</code></pre>
<p>But <em>be careful</em>. The <code>perl</code> used by <code>sudo</code> may not be the same <code>perl</code>
as the one used by <code>make</code>. If this is the case, then you'll need to
specify the full path to <code>perl</code>.</p>


<h4><a name="where_is_my_only_module">Where Is My Only Module?</a></h4>
<p>You may wonder, &quot;Where exactly do these modules get installed and will
they conflict with my existing modules?&quot;. The short answer is, &quot;They get
installed exactly where you told them to!&quot;.</p>
<p>When you install the <code>only</code> module, you are asked to select a base
directory where <code>only::install</code> can install modules. The default value
is a modification of your Perl's <code>sitelib</code> directory. For instance, if
your <code>sitelib</code> was:</p>
<pre><code>
    /usr/local/perl580/lib/sitelib/5.8.0</code></pre>
<p>then <code>only.pm</code> would default to:</p>
<pre><code>
    /usr/local/perl580/lib/version/5.8.0</code></pre>
<p>Even though this is the default, you are prompted to select any
directory you want. Your choice is saved permanently in <code>only::config</code>.
The constant <code>only::config::versionlib</code>, becomes the base directory
where <code>only</code> will install and search for versioned modules.</p>
<p>If you really need to, then you can override this directory as well. For
installation, you would say:</p>
<pre><code>
    perl -Monly=install - versionlib=/home/ingy/modules</code></pre>
<p>The <code>versionlib</code> is just the base directory. <code>only</code> separates various module
versions by sticking them into a subdirectory named after the version. So
<code>Cat::Fancy</code> would be installed as:</p>
<pre><code>
    /usr/local/perl580/lib/version/5.8.0/0.09/Cat/Fancy.pm</code></pre>


<h4><a name="module::build">Module::Build</a></h4>
<p>Many new Perl modules are using <code>Module::Build</code> for their build process,
instead of the age-old <code>Makefile.PL</code> and <code>ExtUtils::MakeMaker</code>.
<code>Module::Build</code> is a wonderfully organized and extensible replacement
for its stalwart yet terribly crufty predecessor.</p>
<p>One of the side benefits of modules distributions that have
<code>Module::Build</code> is that you can do version-specific installations
natively by saying:</p>
<pre><code>
    perl Build.PL
    ./Build versioninstall</code></pre>
<p>Although this is just a pass-through call to <code>only::install</code>, it does
not suffer from the aforementioned &quot;sudo&quot; problem.</p>




<h3><a name="only_the::facts">only The::Facts</a></h3>
<p>Back to <code>only.pm</code>. In this section, I'll discuss all the gory details of
the <code>use only</code> syntax. It really isn't that bad. The basic form is:</p>
<pre><code>
    use only MODULE =&gt; CONDITION;</code></pre>
<p>where MODULE is a module name, and CONDITION is either a simple version
number or a more complex version specification. More on version
conditions in a moment. If you have arguments to pass to the module, then simply
tack them on to the end:</p>
<pre><code>
    use only MODULE =&gt; CONDITION, ARGUMENTS;</code></pre>
<p><code>only</code> even accounts for situations where different versions need different
arguments. You match up the conditions and arguments as a set of anonymous
arrays:</p>
<pre><code>
    use only MODULE =&gt;
        [ CONDITION1, ARGUMENTS1 ],
        ...,
        [ CONDITION7, ARGUMENTS7 ];</code></pre>
<p>Finally, there are some special options that you can pass to <code>only</code> to tell it
how to behave. This is accomplished syntactically by passing an anonymous hash
of option/value pairs. Put the options hash directly after <code>use only</code>:</p>
<pre><code>
    use only { OPTION =&gt; VALUE},
        MODULE =&gt; CONDITION;</code></pre>
<p>If you want to set the options globally (for all subsequent <code>only</code>
interaction), then just specify the options without any other arguments. For
example, to override the <code>versionlib</code> option for all <code>use only ...</code>
statements, say:</p>
<pre><code>
    use only { versionlib =&gt; '/home/ingy/modules' };</code></pre>


<h4><a name="hazardous_conditions">Hazardous Conditions</a></h4>
<p>Even though a &quot;version condition&quot; can be as simple as a single version
number like '0.42', <code>only</code> offers flexible syntax for expressing
exactly which versions you are (and aren't) interested in.</p>
<p>If you want to specify a list of versions, then just use a space-separated
enumeration:</p>
<pre><code>
    use only Bird::Talk =&gt; '0.42 0.44 0.47 0.50';</code></pre>
<p>If your version requirements fall into a range, then you can specify those, too.
Just use two versions, separated by a dash:</p>
<pre><code>
    use only Bird::Talk =&gt; '0.42-0.50';</code></pre>
<p>Of course, you can list multiple ranges as well. And if you leave one of
the versions off the range, then that means the range is open-ended.</p>
<pre><code>
    use only Bird::Talk =&gt; '0.42-0.50 0.55-0.62 0.67-';</code></pre>
<p>Sometimes it's easier to just specify the versions you don't want. Using
a '!' in front of either a range or a single version, negates that
meaning. To avoid all versions of <code>Bird::Talk</code> below 0.42, and also the
extremely buggy version .53, say:</p>
<pre><code>
    use only Bird::Talk =&gt; '!-0.41 !0.53';</code></pre>
<p>When more than one eligible version of <code>Bird::Talk</code> is installed on your
system, <code>only</code> always chooses the highest version. If you don't specify any
version, then that is an indication to choose the highest-numbered version.
This is different than saying:</p>
<pre><code>
    use Bird::Talk;</code></pre>
<p>because <code>only</code> will search your <code>versionlib</code> first.</p>
















<h4><a name="for_arguments'_sake">For Argument's Sake</a></h4>
<p>There's not much to say about passing arguments. Just pass them in the
same way you would on a normal <code>use</code> statement. This should even work for
modules like <code>Inline.pm</code> where the arguments are not import lists:</p>
<pre><code>
    use only Inline =&gt; 0.44, 'Java';</code></pre>
<p>There is one exception. In Perl, when you say something like:</p>
<pre><code>
    use Dog::Walk ();</code></pre>
<p>That's a cue to not call the module's <code>import</code> method at all. In other
words, it ensures that no functions will be exported into your
namespace. But if you say:</p>
<pre><code>
    use only Dog::Walk =&gt; 1.00, ();</code></pre>
<p>then you will not get the same effect. Unfortunately, there is no way for <code>only.pm</code>
to detect that you called it that way. As a workaround, <code>only</code> lets you say:</p>
<pre><code>
    use only Dog::Walk =&gt; 1.00, [];</code></pre>
<p>This has a similar visual appearance and is meant as a mnemonic. (Hopefully,
there aren't a whole lot of modules in the world where it is important to pass
in a single empty array ref :)</p>


<h4><a name="the_only_options">The Only Options</a></h4>
<p>The only (no pun intended) option currently implemented for <code>only</code> is
<code>versionlib</code>. This option allows you to override the system <code>versionlib</code>
stored in <code>only::config</code>.</p>
<pre><code>
    use only { versionlib =&gt; '/home/ingy/modules' },
        Corn::Stalk =&gt; 0.99, [];</code></pre>




<h3><a name="friends_and_family">Friends and Family</a></h3>
<p>One important duty of <code>only</code> is to ensure that when you load a specific
version of some module, all of that module's related modules are also
loaded from the same version level. This is tricky, because in Perl, you
never know when a module is going to be loaded. It could be loaded by
your original module or not. It might happen at compile time ( <code>use</code> )
or run time ( <code>require</code> ). It could be loaded hours later in a long-running process (or a very, very, very slow computer :) There might also
be autoloaded functions involved.</p>
<p>Most importantly, some of the sub-modules might be loaded using <code>use only</code>,
while others are loaded with standard <code>use</code> and <code>require</code> statements. To make
all this happen the way you'd expect it to, <code>only</code> plays some tricks with
<code>@INC</code>. More on that shortly, my preciouses.</p>
<p><code>only</code> knows which modules are related because it saves the information as
metadata for every module it installs. For example, if I install a module like
so:</p>
<pre><code>
    $ cd YAML-0.35
    $ perl Makefile.PL
    ... lines deleted
    $ make test
    ... lines deleted
    $ perl -Monly=install
    Installing /usr/local/perl580/lib/version/5.8.0/0.35/YAML.pm
    Installing /usr/local/perl580/lib/version/5.8.0/0.35/YAML.pod
    Installing /usr/local/perl580/lib/version/5.8.0/0.35/YAML/Error.pm
    Installing /usr/local/perl580/lib/version/5.8.0/0.35/YAML/Family.pm
    Installing /usr/local/perl580/lib/version/5.8.0/0.35/YAML/Node.pm
    Installing /usr/local/perl580/lib/version/5.8.0/0.35/YAML/Transfer.pm
    Installing /usr/local/perl580/lib/version/5.8.0/0.35/YAML/Error.yaml
    Installing /usr/local/perl580/lib/version/5.8.0/0.35/YAML/Family.yaml
    Installing /usr/local/perl580/lib/version/5.8.0/0.35/YAML/Node.yaml
    Installing /usr/local/perl580/lib/version/5.8.0/0.35/YAML/Transfer.yaml
    Installing /usr/local/perl580/lib/version/5.8.0/0.35/YAML.yaml</code></pre>
<p>then I get a YAML metadata file for each module. The metadata file <code>YAML.yaml</code>
looks like this:</p>
<pre><code>
    # This meta file created by/for only.pm
    meta_version: 0.25
    install_version: 0.35
    distribution_name: YAML
    distribution_version: 0.35
    distribution_modules:
      - YAML.pm
      - YAML/Error.pm
      - YAML/Family.pm
      - YAML/Node.pm
      - YAML/Transfer.pm</code></pre>
<p>This way, no matter which module is loaded first, <code>only</code> knows about every
other module that was installed with that module.</p>




<h3><a name="only_on_the_inside">Only on the Inside</a></h3>
<p>The internals of <code>only.pm</code> are not incredibly complicated, but there is
a little black magic going on. Most of it boils down to a relatively
new and under-publicized feature of Perl5: putting <strong>objects</strong> onto the
<code>@INC</code> array.</p>
<p>As you probably know, <code>@INC</code> is a special global array of file-system
paths. When a program tries to load a Perl module with the <code>use</code> or
<code>require</code> commands, it searches each of these paths in order until the
module is found. The default paths in <code>@INC</code> are compiled into Perl. You
can alter the array with the <code>PERL5LIB</code> environment variable, the
<code>lib.pm</code> module, or even by simply changing it with regular Perl array
commands. It's just an array, after all.</p>
<p>As of Perl 5.6.1, you can actually put Perl objects onto <code>@INC</code> and have
<code>use</code> and <code>require</code> interact with them. When <code>require</code> encounters an
object in <code>@INC</code> it attempts to call that object's <code>INC</code> method. The
<code>INC</code> method can do anything it wants to load the module. It could
actually go out on the internet and locate the module, download it,
install it and load it!</p>
<p>The <code>INC</code> method should either return a filehandle or nothing. If a
filehandle is returned, then <code>require</code> considers the operation a success. It
reads the contents of that filehandle and <code>eval</code>-s the module into
existence. If nothing is returned, then the operation is considered
unsuccessful, and <code>require</code> continues its merry way down <code>@INC</code>.</p>
<p>The heart of the <code>only</code> module's magic lies in the fact that it puts an
object onto <code>@INC</code> that is responsible for loading an appropriate
version of your module. Not only that,it is also responsible for
loading the matching version of any related modules that were installed
at the same time as your module.</p>




<h3><a name="ooo__object_oriented_only">O-O-o - Object-Oriented Only</a></h3>
<p>Since <code>only</code> is an object-oriented module on the inside, it is no surprise
that it offers an OO API to the those of you on the outside. (I assume that
you don't live inside a Perl module :)</p>
<p>Using the OO interface can give you more understanding and control of the
version specific loading process, at the cost of a slightly more verbose
syntax specification. As an example, if you would normally do this:</p>
<pre><code>
    use only Good::Stuff =&gt; '1.20-1.55';</code></pre>
<p>then you can say the same thing by doing this:</p>
<pre><code>
    use only;
    my $only;
    BEGIN {
        $only = only-&gt;new;
        $only-&gt;module('Good::Stuff');
        $only-&gt;condition('1.20-1.55');
        $only-&gt;include;
    }
    use Good::Stuff;</code></pre>
<p>Note that the <code>use</code> statement is absolutely normal. No <code>only</code> involved.
But it still does what we want! That's because the preceding code sticks
one of those magic <code>only</code> objects onto <code>@INC</code>.</p>
<p>The methods should be fairly self-explanatory. The key method call is
<code>only-</code>include&gt;. It tells the object to attach itself to the front of @INC.</p>
<p>One nice thing is that you can actually do stuff with the object later on in
the program:</p>
<pre><code>
    use only;
    my $only;
    BEGIN {    # methods can be stacked
        $only = only-&gt;new-&gt;module('Good::Stuff')-&gt;condition('1.20-1.55')-&gt;include;
    }
    use Good::Stuff;
    ...
    print &quot;Using Good::Stuff version: &quot; . $only-&gt;distribution_version . &quot;\n&quot;;
    ...
    $only-&gt;remove;    # Remove object from @INC;</code></pre>




<h3><a name="conclusion">Conclusion</a></h3>
<p>I always believed that if my old Triumph motorcycle ever broke down out
on the open road, I could somehow figure out a way to repair it by
walking down the road for a half mile in either direction, and finding
some odds and ends lying around that I could use for tools. That's
because the roads are usually littered with all sorts of weird things,
and I see everything as a tool to somehow suit my needs.</p>
<p>Perl is much like that roadside. There are all kinds of weird things
lying around that can help it solve its own problems. Even when Perl is
playing the part of a busted Triumph bike, its roadside qualities always
seem to be able to kickstart it right back into action.</p>
<p><code>only.pm</code> is a great example of this. Even though Perl was inadequate in
regards to module versioning yesterday, today, it's packing a brand new
chainsaw. Rev it up!</p>




<h3><a name="about_the_author">About the Author</a></h3>
<p>Brian Ingerson has been programming for more than 20 years, and hacking
Perl for five of those. He is dedicated to improving the overall quality of
scripting languages including Perl, Python, PHP and Ruby. He currently
hails from Portland, Ore. -- the location of this year's O'Reilly
Open Source Convention. How convenient!</p>



        </div>



    </div>
    <div class="asset-footer"></div>
</div>


                            
                            <div id="entry-1096" class="entry-asset asset hentry">
    <div class="asset-header">
        <h2 class="asset-name entry-title"><a href="/pub/2003/03/p6pdigest/20030316.html" rel="bookmark">This week on Perl 6, week ending 2003-03-16</a></h2>
        <div class="asset-meta">
            <span class="byline">
    
                By <span class="vcard author">Piers Cawley</span> on <abbr class="published" title="2003-03-16T00:00:00-08:00">March 16, 2003 12:00 AM</abbr>
    
            </span>

            
            

        </div>
    </div>
    <div class="asset-content entry-content">

        <div class="asset-body">
            <!-- sidebar begins --><!-- don't move sidebars --><!-- sidebar ends --><p>Spring is in the air, the Apocalypse is here (or imminent, dependingon which sense of the word 'Apocalypse' you are using). We'll startwith perl6-internals as usual, before bracing ourselves for theincreased volume and ploughing on into perl6-language.</p><h4><a name="object_spec">Object Spec</a></h4><p>Dan's 3rd try at the Objects and Classes spec received a very smallamount of further discussion this week. What there was mostly touchedon the boundary between where the line is drawn between parrot'sobject system and a particular language's object system. Theinference I draw from all this is that the next Object spec will bethe <code>final(ish)</code> Parrot Object spec.</p><h4><a name="parrot_0.0.10">Parrot 0.0.10</a></h4><p>Steve Fink instituted a Parrot feature freeze in the run up to 0.0.10at the end of last week, aiming for a release on Saturday the 15th ofMarch and noted that he was leaning toward &quot;Juice&quot; as a code name(punning on Leo T&ouml;tsch's work on the <code>imcc -Oj</code>optimizations). David Cuny pointed out that there was already avirtual machine called Juice and suggested a whole list of possiblecode names. Leo T&ouml;tsch reckoned that calling it 'Juice' would be'too much honour' and suggested a list of anagrams of 'Parrotten'. (&quot;Partner to&quot;, &quot;Par Rotten&quot; or &quot;Tarte porn&quot; anyone?).</p><p>It looks like we missed the release on the 15th, but Steve announceda release candidate on the 16th, in expectation of a release on the17th.</p><p><a href="http://groups.google.com/groups?threadm=20030309225740.GA662%40foxglove">http://groups.google.com/groups</a> -- Feature freeze</p><p><a href="http://groups.google.com/groups?threadm=20030316091856.GB662%40foxglove">http://groups.google.com/groups</a> -- Release candidate announced</p><h4><a name="languages/basic_reorg"><em>languages/BASIC</em> reorg</a></h4><p>Clinton A Pierce announced that he'd reorganized the<em>languages/BASIC</em> subtree into 'compiled' and 'interpreted'subtrees and noted that he was very impressed with the improvements inParrot's speed and memory management. Leo T&ouml;tsch pointed out afew issues with MANIFEST and the need for a Makefile, and wondered ifClinton had run things through IMCC.</p><p><a href="http://groups.google.com/groups?threadm=5.1.0.14.2.20030309181336.03b10b10%40mail.geeksalad.org">http://groups.google.com/groups</a></p><h4><a name="the_judy_algorithm">The Judy algorithm</a></h4><p>Tim Bunce pointed everyone at the Judy dynamic array code onSourceforge and wondered if it would be useful for Parrot. (Judy is ahigh speed dynamic array implementation optimized for modernprocessor architectures apparently). Leo T&ouml;tsch thought itlooked interesting and suggested that someone try wrapping Judy up ina PMC and running some performance tests. Elizabeth Mattijsen went andtook a look and reported some issues with memory leakage and worriedthat the project looked 'silent'. Tim mailed her concerns toJudy's author who addressed them in his reply and admitted that hewasn't that good at keeping the website up to date. He said that Judyhad been 'tested carefully not to have leakage' and wondered if itmight have been an issue with the tool Liz used to do the testing.</p><p>I await further developments with interest. If Judy can be made towork, it looks jolly quick.</p><p><a href="http://groups.google.com/groups?threadm=20030310103730.GG25543%40dansat.data-plan.com">http://groups.google.com/groups</a></p><p><a href="http://judy.sourceforge.net/application/10minutes.htm">http://judy.sourceforge.net/application/10minutes.htm</a></p><h4><a name="yet_another_iterator_proposal">Yet another iterator proposal</a></h4><p>Leo T&ouml;tsch posted a request for comments on what he called 'yetanother iterator proposal'. Nobody commented. I wonder if this meanseveryone liked it.</p><p><a href="http://groups.google.com/groups?threadm=3E6CAC8F.4010308%40toetsch.at">http://groups.google.com/groups</a></p><h4><a name="parrot_for_windows">Parrot for Windows</a></h4><p>Benjamin Goldberg wondered if there were any precompiled parrotbinaries for Win32 available as he wants to be able to test parrotcode without the current weird rites he has to go through (see hispost for details). Clinton A Pierce put a snapshot build up on his sitetemporarily for Benjamin to download. Robert Spier offered space onwww.parrotcode.org for a windows build when the next release comes outwhich Dan thought would be really cool. Dan also wondered about makingan automated build farm but I think he may have a tuit shortage whenit comes time to actually implement it. Joshua Hoblitt also offered tohost binaries on his CPAN mirror. Clint said he'd be happy to makemilestone binaries and wondered if there was a standard way such adistribution should be put together.</p><p><a href="http://groups.google.com/groups?threadm=3E6D7C66.3327A18F%40earthlink.net">http://groups.google.com/groups</a></p><h4><a name="moving_to_pio">Moving to PIO</a></h4><p>J&uuml;rgen B&ouml;mmels continued to make Dan happy by moving morefile related opcodes from STDIO to Parrot's PIO libraries. The latestops to get his attention were <code>open</code> and <code>close</code>. Dan did a happydance and applied the patch before wondering if we were subject to acode freeze (I don't think so; it was feature freeze time).</p><p><a href="http://rt.perl.org/rt2/Ticket/Display.html?id=21536">http://rt.perl.org/rt2/Ticket/Display.html</a></p><h4><a name="imcc_and_pdd03_(calling_conventions)">IMCC and PDD03 (Calling conventions)</a></h4><p>Leo has been thinking some more about the parrot calling conventionsdescribed in Parrot Design Document 3 and worried that they can'tactually be done. He proposed reducing the number of parameters thatcan be passed in registers in order to take pressure off the registerallocator in IMCC. Dan agreed and quickly changed the PDD to take thisinto account. Leo then asked for some clarification on a couple ofother issues that he was having a hard time understanding. Dan saidthat it was probably best to come back to these issues after he'd donePDD15 (The object spec). Leo agreed that objects will probably shedmore light on the calling conventions and we all sat back to hang onDan's every object oriented word. Not that there's any pressure atall.</p><p><a href="http://groups.google.com/groups?threadm=3E6F6860.4030103%40toetsch.at">http://groups.google.com/groups</a></p><h4><a name="parrot_extensions,_or_pmc_versatility">Parrot extensions, or PMC versatility</a></h4><p>Darren Duncan had some questions about PMCs and parrot extensions andwhat he should consider as he wrote a general persistence library. Danand Benjamin Goldberg had some answers.</p><p><a href="http://groups.google.com/groups?threadm=p05111b00ba970ad339b0%40%5B24.70.202.54%5D">http://groups.google.com/groups</a></p><h4><a name="sun4_vtable_jit_support">sun4 vtable JIT support</a></h4><p>Jason Gloudon posted a patch adding support for vtable calls in thesun4/JIT and added support for some more ops. There appeared to be afew problems with the patch so it hasn't been applied yet.</p><p><a href="http://groups.google.com/groups?threadm=rt-21577-53666.4.91616196911266%40bugs6.perl.org">http://groups.google.com/groups</a></p><h4><a name="a_fish,_a_barrel_and_a_running_joke">A fish, a barrel and a running joke</a></h4><p>Leon Brocard made maintaining this particular running joke almosttrivial this week by actually posting something. He's implemented<code>uniq(1)</code> in parrot assembly, though he notes that it's not very fastcompared to GNU <code>uniq(1)</code> yet. Dan added it to the distribution in<em>examples/assembly/</em>.</p><p><a href="http://groups.google.com/groups?threadm=rt-21588-53714.14.8561040030741%40bugs6.perl.org">http://groups.google.com/groups</a></p><h4><a name="parrot_reaches_another_milestone">Parrot reaches another milestone</a></h4><p>Dan has decided that Parrot has reached the point where it should havea working <code>install</code> make target. He asked for someone to make itso. No takers so far, but he posted late on Sunday so maybe there willbe news of this in the next summary.</p><p><a href="http://groups.google.com/groups?threadm=a0521060bba9a52cb54c4%40%5B63.120.19.221%5D">http://groups.google.com/groups</a></p><h3><a name="meanwhile,_over_in_perl6language">Meanwhile, over in perl6-language</a></h3><p>perl6-language saw 210 messages this week. Which I think is more thanit's seen in the last 3 or 4 weeks put together. Maybe it hadsomething to do with the return of Damian Conway and the release ofApocalypse 6 (and the spectacularly short Apocalypse 7).</p><h4><a name="statement_modifiers">Statement modifiers</a></h4><p>Matthijs van Duin wondered if the issue of multiple statementmodifiers has been settled. The thread is long, and the answer isessentially (and authoritatively) &quot;Yes, it's settled. No, you can't doit.&quot; So, unless Larry changes his mind the point is moot. However,Matthijs does put his case very well, if you're interested in thisarea I can recommend reading the thread.</p><p><a href="http://groups.google.com/groups?threadm=20030310095221.GC18286%40cds.nl">http://groups.google.com/groups</a></p><p><a href="http://archive.develooper.com/perl6-language%40perl.org/msg09331.html">http://archive.develooper.com/perl6-language%40perl.org/msg09331.html</a></p><h4><a name="just_when_you_get_fed_up_of_waiting_for_the_apocalypse...">Just when you get fed up of waiting for the Apocalypse...</a></h4><p>Two come along at once.</p><p>Apocalypses 6 and 7 appeared online on Monday, a mere 9 months sincethe last one (Apocalypse 7 is all of two sentences long and iscontained within Apocalypse 6, we'll be ignoring it from now on). ThisApocalypse covered closures, subs, functions, methods, types,signatures and pile of other good stuff. All the syntax introduced wasspelled out neatly using Perl 6 rule notation, neatly showing off thepower of the syntax introduced in Apocalypse 5. I would attempt tosummarize it, but it's already pretty dense so I suggest you all readit:</p><p><a href="/pub/a/2003/03/07/apocalypse6.html">http://www.perl.com/pub/a/2003/03/07/apocalypse6.html</a></p><p>Now you've digested that, the rest of the summary should be easier tofollow.</p><p>Damian returned to the list, though he's only reading posts related toApocalypse 6 and he's pretty busy writing Exegesis 6 too so we're notexpecting vast amounts of posts from him.</p><p>Austin Hastings kicked off with the first question, wondering if the's' in <code>&lt;psiglet&gt;</code> was silent. &quot;Of course not.&quot; says Larry.</p><p>Paul applauded the new <code>macro</code> feature (but Damian corrected hissyntax).</p><h4><a name="s&m_vs._b&d">S&amp;M vs. B&amp;D</a></h4><p>Uri Guttman, displayed entirely too much knowledge about thedifference between B&amp;D and S&amp;M asking if Larry shouldn't have used B&amp;Dwhere he used S&amp;M in the apocalypse. Austin Hastings knows too muchtoo it appears, commenting that it depends on whether you considerstrongly typed compile-type semantics as being restrictive orpainful.</p><p><a href="http://groups.google.com/groups?threadm=x7el5eoq8c.fsf%40mail.sysarch.com">http://groups.google.com/groups</a></p><h4><a name="can_is_properties_be_specified_indirectly">Can &quot;is&quot; properties be specified indirectly?</a></h4><p>Austin Hastings wondered if there would be some way of differentiatingbetween an array of constants and an array of variables. In otherwords, how would one specify an array which may be appended/pushed,but whose values cannot change or a hash to which you could add keysbut not change existing entries. Damian thought that you'd have tosubclass Array or Hash as appropriate. Luke Palmer wasn't keen on thisbecause then it would be easier to do something in C++ than in Perl,which isn't the usual way of things.</p><p><a href="http://groups.google.com/groups?threadm=20030310221737.97547.qmail%40web12307.mail.yahoo.com">http://groups.google.com/groups</a></p><h4><a name="is_constant_eq_pass_by_value"><code>is constant</code> eq pass by value?</a></h4><p>Uri Guttman was confused by the default parameter passing style forPerl 6 functions, <code>is constant</code>. A parameter variable declared with<code>is constant</code> is 'locked'; you can't use the same variable to hold adifferent value.</p><pre><code>   sub some_func ($some_arg is constant) {       $some_arg += 10;       ...       return $some_arg;   }</code></pre><p>To do that you need to declare the parameter with <code>is copy</code>. Urinoted that he really should keep his finger off the send button untilhe's read the whole 'megilla', whatever one of those is.</p><p><a href="http://groups.google.com/groups?threadm=x74r6aomdr.fsf%40mail.sysarch.com">http://groups.google.com/groups</a></p><h4><a name="pipes">Pipes</a></h4><p>Michael Lazzaro declared that he thought the Apocalypse was <em>great</em>and that the 'sig stuff is very, very nice.' Then he asked about'pipes' (the new <code>&lt;==</code> and <code>==&gt;</code> operators which are almost,but not quite, entirely unlike the hypothetical <code>~&gt;</code> and<code>&lt;~</code> operators that were discussed so interminably a fewsummaries back). He wanted to know what was decided about some of theedge cases discussed in the appendix to the apocalypse (and had acomment to make about style). Damian pointed out that Michael's edgecases all collapsed to two:</p><pre><code>    @var &lt;== LIST;    LIST ==&gt; @var;</code></pre><p>Damian said that Larry was still unsure about these but that he(Damian) thought they would be allowed in, if only because</p><pre><code>    @in ==&gt; map  {...}        ==&gt; sort {...}        ==&gt; map  {...}        ==&gt; @out;</code></pre><p>is a lot less ugly than</p><pre><code>    @in ==&gt; map  {...}        ==&gt; sort {...}        ==&gt; map  {...}        ==&gt; push @out;</code></pre><p>or (John Williams suggestion)</p><pre><code>    LIST ==&gt; @var.STORE(*);</code></pre><p>I have visions of the Perl 6 naysayers reading this section andmuttering dark imprecations about the end of the Perl as we knowit...</p><p><a href="http://groups.google.com/groups?threadm=BC6DD3EA-535B-11D7-8B38-00050245244A%40cognitivity.com">http://groups.google.com/groups</a></p><h4><a name="complex_parameter_types">Complex Parameter Types</a></h4><p>Michael Lazzaro wanted to know more about 'complex' typedeclarations. He wanted to know how these interacted with signatures,could one use arbitrarily complex types in subroutine signatures? Couldone do multidispatch on them? He also had a question aboutwhen/whether types got coerced (that wasn't actually his question, butit's what it boiled down to) when functions were called.</p><p>The answer to the first two questions was straightforward: Yes, youcan use arbitrarily complex types in function and multimethodsignatures.</p><p>The third one proved a little trickier. Damian said that values wouldnot be coerced, but Larry wasn't so sure. He thought that coercionwould be the right thing to do. Probably. Damian noted that the 'RightThing' could well vary depending on whether the parameter in questionwas declared <code>is constant/rw</code> (in which case passing a parameter withthe wrong type would be an error) or <code>is copy</code> (in which casecoercion could be the thing to do). Austin Hastings wondered if thiscould be handled with a <code>use strict 'params'</code> type pragma, but Damianwasn't convinced, arguing that the use of typed params automaticallyimplied type stricture.</p><p>This thread gets horribly hard to summarize so, for now, I'll justpick out some representative highlights.</p><p>Larry says that, in the absence of a pragma to the contrary typechecking will be done at runtime if the type is unknown/unknowable atcompile time, but he expects the B&amp;D types to come up with a pragmathat enforces compile time checking on pain of failed compilations.</p><p>Brent Dax came up with the concept of 'strict' and 'loose' argumenttyping. Strict arg typing doesn't coerce except that, say, a Child cansatisfy a requirement for a Parent. Loose arg typing will coercewherever possible. He argued that the mechanism for choosing betweenstrict and loose arg typing should be under the control of the<em>caller</em> rather than the callee, as that seemed to fit best with ThePerl Way. Larry agreed with him. He added that the real question iswhether the default <code>use strict</code> should include strict arg typing andnoted that he was inclining toward the strict side. This week.</p><p>A subthread sprang up dealing with Type inference. David Whipp notedthat a smart compiler might well be able to infer the type of somevariables at compile time. The theory being that in the presence ofgood type inference some variables wouldn't have to have a known typeto avoid triggering compile time errors under strict arg typing. AngelFaus pointed out that using 'user visible' type inference wasn't toogood an idea because (among other reasons) it might lead to caseswhere a program only works as written for more recent versions of thecompiler (which doesn't mean that type inference is a bad idea; if thecompiler knows the type of a variable it could potentially use thatinformation to improve code performance).</p><p>My head started spinning when Larry seemed to imply that, not only isInt a Scalar, but a Scalar is also an Int. Or maybe it plays one onTV.</p><p>This thread is still very much underway as I write this summary, soattempting to summarize it is akin to summarizing a book when you'rehalfway through it; you're never quite sure what are the importantbits. Hopefully things will be a little nearer resolution next weekand you'll get a more coherent summary of the conclusions.</p><p><a href="http://groups.google.com/groups?threadm=47347794-5363-11D7-8B38-00050245244A%40cognitivity.com">http://groups.google.com/groups</a></p><p><a href="http://groups.google.com/groups?threadm=20030314033648.58654.qmail%40onion.perl.org">http://groups.google.com/groups</a> -- the inferencesubthread</p><p><a href="http://groups.google.com/groups?threadm=20030313195506.GA15015%40wall.org">http://groups.google.com/groups</a> -- My head hurts</p><h4><a name="signatures_zones_and_line_noise">Signatures zones and line noise</a></h4><p>Brent Dax wasn't keen on the new syntax for declaring whetherparameters were optional, positional, named or variadic (greedy) andwondered if we couldn't use something prettier (wordier) with namedtraits (<code>$x is optional</code> etc). Damian thought that would be'uncomfortably prolix' with default values ending up a long way fromtheir owners. Paul and Brent proposed allowing</p><pre><code>    multi substr(Str $str, $from = $CALLER::_ is optional                           $len  = Inf is optional,                           $new is optional) {        ...    }</code></pre><p>but Damian pointed out that this could lead to badness because, in asignature the <code>is</code> would bind to the variable, but in a normalvariable declaration and assignment the <code>is</code> would bind to the value,which would be confusing. There was some discussion of appropriatenames for the other 'linenoise' in signatures, specifically the choiceof name for the <code>*</code> type. The three front runners appear to be'variadic', 'greedy' and 'slurpy/slurpificatious'. I like 'greedy',but then I'm close to the person who proposed it.</p><p><a href="http://groups.google.com/groups?threadm=005401c2e798%2449301b90%246501a8c0%40deepblue">http://groups.google.com/groups</a></p><h4><a name="in_which_luke_palmer_gets_ignored">In which Luke Palmer gets ignored</a></h4><p>Luke Palmer had things to say about Appendix C of the apocalypse,specifically to do with temp/let and with <code>caller</code> andContinuations. Maybe what he said on these subjects was completelyuncontroversial, but nobody has replied to either ofthem yet.</p><p><a href="http://groups.google.com/groups?threadm=ygc1y1eictl.fsf%40babylonia.flatirons.org">http://groups.google.com/groups</a> -- temp/let</p><p><a href="http://groups.google.com/groups?threadm=ygcsmtu5h0l.fsf%40babylonia.flatirons.org">http://groups.google.com/groups</a> -- Continuations</p><h4><a name="multi_promotion">Multi promotion</a></h4><p>Richard Proctor wondered what would happen if you declared amultimethod with the same name as a previously declared normalsub/method. Specifically he wanted to know if the new declarationwould automagically turn the old one into a multimethod. MichaelLazzaro thought not. As did Damian and Larry. Damian provided asummary of the rules for subroutine/method dispatch, which lookwonderfully subvertable. Piers Cawley wondered if it would be possibleto get at a 'dispatcher' object and/or override it in a lexical scope,nothing that sometimes, he scares himself. Nicholas Clark seemed tothink Piers wasn't completely insane before going on to talk aboutwrapping and unwrapping in the case when the wrapper has itself beenwrapped. Larry seemed to think that unwrapping should still do theright thing even if the wrapper being removed is itself wrapped.</p><p><a href="http://groups.google.com/groups?threadm=Marcel-1.53-0311144218-0b0Rr9i%40waveney.demon.co.uk">http://groups.google.com/groups</a></p><p><a href="http://groups.google.com/groups?threadm=3E6E853D.9090604%40conway.org">http://groups.google.com/groups</a> -- Dispatch rules (OK?)</p><h4><a name="wrappers_vs._efficiency">Wrappers vs. Efficiency</a></h4><p>In the Apocalypse, Larry talked about the performance implications ofgeneralized function wrappers and brought up the idea of subroutinetraits which would mark a sub as unwrappable, giving <code>is inline</code> asan example. John Siracusa asked that whatever the 'specific definitionfor speed' is that forbids runtime wrapping, it shouldn't be spelled'inline' (though inline may imply &quot;don't wrap me please&quot;). A fewpeople agreed, but things mostly got left vague.</p><p><a href="http://groups.google.com/groups?threadm=BA93ED19.605E6%25siracusa%40mindspring.com">http://groups.google.com/groups</a></p><h4><a name="macro_invocants">Macro invocants</a></h4><p>Dave Whipp wondered about using macros to do things like:</p><pre><code>    my Database $db = MySqlDatabase.connect(...);    $db.select * FROM Foo WHERE Foo.bar LIKE a%b;</code></pre><p>by implementing <code>select</code> as a macro. Larry thought so, but you wouldhave to export the macro into the calling context. Larry added thatyou would probably implement that particular functionality by treating&quot;.select&quot; as an infix macro with a specially parsed argument on itsright hand side (the SQL statement). David thought this was a littleclunky and proposed <code>macromethod</code> as a way to avoid the exportrequirements. Luke Palmer was unconvinced and it went back and forth afew times.</p><p>Larry wasn't convinced by David's suggestion either, commenting that'mixing such compile-time semantics with a notation that supposedlymandates run-time dispatch is a recipe for a certain amount ofconfusion no matter how well we do it.'</p><p><a href="http://groups.google.com/groups?threadm=20030312013549.15320.qmail%40onion.perl.org">http://groups.google.com/groups</a></p><h4><a name="overloading_multis_on_constness_of_parameters">Overloading multis on constness of parameters</a></h4><p>Joe Gottman wondered if it would be possible to overload multimethodsbased on the const-ness of a parameter is the same way C++ does. Theanswer appears to be 'yes'. Piers Cawley passed on a question fromGreg MacCarroll about overloading on the value of a parameter. Damianthought probably not, but then showed a cunning trick involvingoverloading <code>isa</code> and a junction to allow something pretty similar.Luke Palmer was impressed.</p><p>I'm not entirely sure what it had to do with this particular thread,but Austin Hastings posted a chart of his understanding of the variousdispatch rules. Worth reading.</p><p><a href="http://groups.google.com/groups?threadm=004d01c2e83b%2447b8c0c0%24cf6e1918%40carolina.rr.com">http://groups.google.com/groups</a></p><p><a href="http://groups.google.com/groups?threadm=20030314205347.31744.qmail%40web12308.mail.yahoo.com">http://groups.google.com/groups</a> -- Austin's chart</p><h4><a name="operators_and_context">Operators and context</a></h4><p>Deborah Ariel Picket had some questions about Michael Lazzaro'scomplete list of known Perl 6 operators, and wondered if this listshould be extended to take context into account. She also wonderedwhat the complete list of possible contexts was now. Michael reckonedthat the list she pointed to was still current, but he expected to addthe new <code>&lt;==</code> and <code>==&gt;</code> ops. He also agreed that addinginformation about contextual behaviour would be a good (if daunting)thing to do. He noted too that Apocalypse 6 seems to imply that therewould be a context for every type. Nothing definitive from Larry (oreven Damian) yet.</p><p><a href="http://groups.google.com/groups?threadm=200303130103.h2D13EY1026789%40bruce.csse.monash.edu.au">http://groups.google.com/groups</a></p><p><a href="http://archive.develooper.com/perl6-language@perl.org/msg12130.html">http://archive.develooper.com/perl6-language@perl.org/msg12130.html</a>-- the current operators list</p><h4><a name="assignment_overloading">Assignment Overloading</a></h4><p>Luke Palmer wondered if it would be possible to overload theassignment operator and wondered if the assignment operator was avalue or a reference copy. Damian pointed out that <code>*infix:=</code> wasreally an operator on containers not values and you'd probablyimplement it by overloading <code>STORE</code> in the container's class. He alsocommented that <code>STORE</code> might end up being spelled<code>&amp;infix:=</code>. Copying is a shallow value copy.</p><p>Larry popped up to discuss the .copy method on SCALAR but I wasn'tentirely sure whether that gets called on the target container or thething being copied. But that might just be me being confused.</p><p><a href="http://groups.google.com/groups?threadm=ygc7kb3d5pu.fsf%40babylonia.flatirons.org">http://groups.google.com/groups</a></p><h4><a name="p6fc">P6FC</a></h4><p>Aldo Calpini put up a tentative class hierarchy for Perl 6's standardclasses (he called them the Perl 6 Foundation Classes, narrowlyavoiding a knee jerk response from at least one summarizer of thisparish) and asked for comments. Murat &Uuml;nalan suggested that Aldowas posting to the wrong audience before suggesting that we adopt the.Net/Java object hierarchy, which confused Aldo somewhat, so Muratclarified what he meant. Simon Cozens made a few suggestions to Aldoabout naming and missing classes. Larry added some clarifications onhis thinking about the difference between types and classes.</p><p><a href="http://groups.google.com/groups?threadm=20251014703.20030313105923%40perl.it">http://groups.google.com/groups</a></p><p><a href="http://dada.perl.it/p6fc.html">http://dada.perl.it/p6fc.html</a> -- Aldo's class diagram</p><p><a href="http://groups.google.com/groups?threadm=20030314184631.GD22246%40wall.org">http://groups.google.com/groups</a> -- Larry on types and classes</p><h4><a name="thoughts_about_multiple_properties">Thoughts about multiple properties</a></h4><p>Chris Dutton wondered about using junctions for multiple propertiesso <code>method bar is public is rw {...}</code> could be written as<code>method bar is public &amp; rw {...}</code> instead. Jonathan Scott Duffdidn't think that made much sense, and pointed out that the <code>is</code> isoptional after the first, so you could write <code>method bar is public rw {...}</code> if you wanted. Larry noted that 'thatfeature is still in Schr&ouml;dinger's little box.'</p><p>This led Mark Biggar to suggest some syntax for neatly defininggroups of traits and complex types without having to go to the lengthof defining a class. Michael Lazzaro thought that Perl 6 classeswouldn't be as heavyweight as they are in Perl 5 and did some WAGging(Wild Ass Guessing) about making subs that inherit from Sub whichlooked pretty good to me even if it did lead Austin Hastings to callMichael a 'bad, evil man'.</p><p><a href="http://groups.google.com/groups?threadm=37E62955-5584-11D7-A62F-0005020F8EB9%40cmb-enterprises.com">http://groups.google.com/groups</a></p><h4><a name="named_vs._variadic_parameters">Named vs. Variadic Parameters</a></h4><p>Michael Lazzaro pointed up some issues with subroutines that have bothvariadic arguments and named arguments. Luke Palmer thought that therewere two, mutually exclusive, ways of dealing with this: Michael's proposedbehaviour and the behaviour described in the Apocalypse. Luke washappy with the Apocalypse behaviour. Michael said that he hoped thatwhatever was decided, 'broken' function signatures would give rise toa compiler error.</p><p><a href="http://groups.google.com/groups?threadm=59940A64-567C-11D7-895C-00050245244A%40cognitivity.com">http://groups.google.com/groups</a></p><h4><a name="is_static"><code>is static</code>?</a></h4><p>Uri Guttman asked about static variables in Perl 6. In Perl 5 you canget a static variable by doing:</p><pre><code>    {        my $count = 0;        sub sequence { return ++$count }    }</code></pre><p>Uri wanted to be able to do something like:</p><pre><code>    sub sequence {        my $count is static is default(0);        return ++$count;    }</code></pre><p>Dave Whipp wondered if <code>our</code> did the job (it doesn't). Larrymentioned that he didn't particularly like 'static' as a name for thissort of variable and reckoned that, if there were an 'is static'declaration the compiler would probably translate:</p><pre><code>    my $pi is static = 3;</code></pre><p>to something like</p><pre><code>    our $foo__Xdeadbeef will init {.set(3)}</code></pre><p>Larry's preferred syntax would be <code>our $foo is unique</code>, but he notedthat 'It's not like someone isn't going to implement &quot;is static&quot; themoment our back is turned anyway'.</p><p><a href="http://groups.google.com/groups?threadm=x7of4c7cj0.fsf%40mail.sysarch.com">http://groups.google.com/groups</a></p><h4><a name="no_mandatory_named_arguments">No mandatory named arguments?</a></h4><p>Nicholas Clark wondered if his reading of Apocalypse 6 was correct andthat there is no way to specify mandatory named parameters. Larryagreed that this was so, but that one could finesse things at runtimewith tricks like:</p><pre><code>    sub foo(+$req = die 'You must supply a &quot;req =&gt;&quot; argument') {...}</code></pre><p><a href="http://groups.google.com/groups?threadm=20030315231648.GJ277%40Bagpuss.unfortu.net">http://groups.google.com/groups</a></p><h3><a name="acknowledgements,_announcements_and_apologies">Acknowledgements, Announcements and Apologies</a></h3><p>That about wraps it up for this week. Many thanks to Larry for givingus all something to talk about on perl6-language this week; I wasstarting to think about making the language list summary a fortnightlything.</p><p>If you appreciated this summary, please consider one or more of thefollowing options:</p><ul><li>Send money to the Perl Foundation at<a href="http://donate.perl-foundation.org/">http://donate.perl-foundation.org/</a> and help support the ongoingdevelopment of Perl.</li><li>Get involved in the Perl 6 process. The mailing lists are open  toall. <a href="http://dev.perl.org/perl6/">http://dev.perl.org/perl6/</a> and <a href="http://www.parrotcode.org/">http://www.parrotcode.org/</a>are good starting points with links to the appropriate mailing lists.</li><li>Send feedback, flames, money, job offers or a 'get out of war free'card to <em><a href="mailto:p6summarizer@bofh.org.uk">p6summarizer@bofh.org.uk</a></em></li></ul><p>This week's summary was again sponsored by Darren Duncan. ThanksDarren. If you'd like to become a summary sponsor, drop me a line at<em><a href="mailto:p6summarizer@bofh.org.uk">p6summarizer@bofh.org.uk</a></em>.</p>
        </div>



    </div>
    <div class="asset-footer"></div>
</div>


                            
                            <div id="entry-1086" class="entry-asset asset hentry">
    <div class="asset-header">
        <h2 class="asset-name entry-title"><a href="/pub/2003/03/13/datetime.html" rel="bookmark">The Many Dates and Times of Perl</a></h2>
        <div class="asset-meta">
            <span class="byline">
    
                By <span class="vcard author">Dave Rolsky</span> on <abbr class="published" title="2003-03-13T00:00:00-08:00">March 13, 2003 12:00 AM</abbr>
    
            </span>

            
            

        </div>
    </div>
    <div class="asset-content entry-content">

        <div class="asset-body">
             <!-- sidebar begins -->
<!-- don't move sidebars -->
<!-- sidebar ends -->
<h3><a name="some_basic_concepts">Some Basic Concepts</a></h3>
<p>In order to understand what you might want to do with dates and times,
it's good to have a handle on some basic concepts.  Here are some
terms that I'll be using in this article:</p>
<csperl file="grab" domain="on" record="b/795" template="article_sidebar.view">
<ul>
<li><strong><a name="item_datetime">datetime</a></strong><br />
</li>
This is not a word, but I will use it as a convenient shorthand to
refer to a date and time together, because they are basically the same
thing.  Adding time to a date simply increases its granularity.
<li><strong><a name="item_utc">UTC (also GMT and Zulu)</a></strong><br />
UTC stands for &quot;Coordinated Universal Time&quot;.  It is an international
standard which is kept using atomic clocks, and is kept to within 0.9
seconds of the rotation of the earth on its axis in order to work well
with traditional standards of time-keeping.  UTC time is measured at
the prime meridian (O degrees longitude).
<p>Time zones around the world are specified as an offset from UTC.  The
widely used term GMT (Greenwich Mean Time) refers to a time zone that
is equivalent to UTC.  In other words, it has no offset.</p>
<p>The US military has a set of terms used for time zones around the
world based on the alphabet (A-Z).  In this system UTC is Z, sometimes
called &quot;Zulu&quot;.</p>
<p>UTC is a good standard for the <em>internal</em> representation of dates and
times, as it makes comparing datetimes or doing datetime math much
easier.</p></li>
<li><strong><a name="item_time_zones_and_daylight_saving_time">Time zones and Daylight Saving Time</a></strong><br />
<p>Time zones, as mentioned above, are defined as an offset from UTC.
Most, but <em>not</em> all, time zones are in offsets of whole hours.
Adelaide, Australia has an offset of nine and a half hours ahead of
UTC, and Nepal has an offset five hours and forty-five minutes ahead
of UTC.</p>
<p>Time zones are complicated by the use of Daylight Saving Time, which
changes the actual offset of a given location to vary over the course
of the year.  The eastern US has an offset of -0500 from UTC, five
hours behind UTC.  This means that 12:00 (noon) UTC becomes 07:00
(AM).  However, when Daylight Saving Time is in effect, the offset
becomes -0400, four hours behind UTC.  Because time zones are
determined by governments, use of Daylight Saving Time, and the base
offsets, have changed over time, and may change again in the future.</p>
<p>This greatly complicates math when dealing with non-UTC datetimes.  
If I have a local datetime for the Eastern US of 2002-10-25 14:15:00
and I add six months to that datetime, then I will have crossed a DST
change.</p>
<p>The upshot of all this is that any code that represents time zones as
<em>fixed</em> offset will probably start producing errors once date math
gets involved.</p>
<p>The definitive source of time zone offsets and rules is the Olson time
zone database.  It defines zones according to names like
&quot;America/New_York&quot;, as opposed to &quot;EST&quot;.  The latter shorthand is
commonly used, but it should probably be avoided because these short
names are not unique or definitive.  For example, there is an &quot;EST&quot; at
-0500 and +1000.</p>
</li>
<li><strong><a name="item_local_time">Local time</a></strong><br />
<p>The local time is UTC plus the local time zone offset.  While UTC is
great for internal use, most people want to see datetimes in terms of
<em>their</em> location.  In a sense, local time is the <em>display</em> format,
while UTC is the <em>storage</em> format.</p></li>
<li><strong><a name="item_the_epoch">The epoch</a></strong><br />
<p>Epoch is a generic term referring to the &quot;start&quot; of any particular
system.  For example, the Gregorian calendar's epoch is January 1, 1
CE.</p>
<p>The epoch system, as used most operating systems, represents a
datetime as the number of seconds after a specific date and time.  For
Unix systems, the epoch began on January 1, 1970 at midnight GMT
(UTC).  Other systems have different epochs.  Because of this, you
cannot assume that an epoch time of 2,003,131 means the same thing
from system to system, because different systems have a different
&quot;second 0&quot;.  Storing a datetime as its epoch is not portable.</p>
<p>Even worse, on most current systems, epochs are represented by a 32
bit signed integer, which only lets you represent datetimes with a
range of about 136 years.  On most UNIX systems currently in use, this
means that the latest date you can represent right now is sometime in
the year 2038, and the earliest is around 1902.  This doesn't work
very well if you're trying to represent the birth date of your
great-great-grandmother.</p>
<p>The upshot of all this is I would strongly recommend <em>not</em> using
epochs except when you have no other choice.  Of course, you'll often
have no choice, so it's important to know how this system works.</p>
</li>
<li><strong><a name="item_the_gregorian_calendar">The Gregorian Calendar</a></strong><br />
<p>There have been many different calendar systems in use throughout
history.  The Gregorian calendar is the current generally agreed upon
international standard for representing dates, and is what you are
using when you say &quot;August 8, 1999&quot;.  Other calendars that are still
in use include the Hebrew calendar, the Islamic calendar, and the
Chinese calendar.</p>
<p>Even though the Gregorian calendar wasn't created until 1582, and it
wasn't adopted world wide until this century, we can still extrapolate
backwards in time using the Gregorian calendar.</p>
</li>
</ul>
<h3><a name="what_needs_doing_with_dates_and_times">What Needs Doing with Dates and Times?</a></h3>
<p>There are a lot of things you can do with dates and times, and
different modules/distributions provide different types of
functionality.  Broadly speaking, we can consider the following areas
of functionality:</p>
<ul>
<li><strong><a name="item_parsing%2fformatting">Parsing/Formatting</a></strong><br />
<p>There are more datetime formats in use in the computing world than you
can shake a stick at.  You'll often have to parse a datetime in one
format in order to turn it into something you can work with
internally, like a bunch of integers or an epoch time.</p>
<p>On the flip side, you'll often have to take some standard
representation, like an epoch, and convert it to some other format.</p>
</li>
<li><strong><a name="item_basic_representation">Basic representation</a></strong><br />
<p>A nice datetime object can be quite handy.  These range from
lightweight wrappers around Perl's <a href="#item_localtime"><code>localtime()</code></a> to objects that try
to provide methods for all possible datetime operations.</p>
</li>
<li><strong><a name="item_math_and_calculations">Math and calculations</a></strong><br />
<p>You'll often want to answer questions like &quot;what day is seven days
after today&quot; or &quot;how much time is there between now and midnight?&quot;
This is closely related to the task of figuring out the date Easter
falls on in a given year, or what day of the week Martin Luther King's
birthday falls on.</p>
</li>
</ul>
<p>There are plenty of other things we can do with datetimes, but these
are largely elaborations of the above areas of functionality.</p>
<h3><a name="perl's_builtin_date/time_functionality">Perl's Built-in Date/Time Functionality</a></h3>
<p>Perl has some built-in functionality for handling dates and times.
This functionality includes:</p>
<ul>
<li><strong><a name="item_time"><code>time()</code></a></strong><br />
<p>A function that returns the current epoch time.</p>
</li>
<li><strong><a name="item_localtime"><code>localtime()</code> and <code>gmtime()</code></a></strong><br />
<p>These functions convert an epoch time into a set of components
representing the local time.  They both return arrays containing
things like the hour, minute, month, etc., though some of the values
returned are awkward to use.  For example, the year is the actual year
minus 1900.</p>
<p>The <a href="#item_localtime"><code>localtime()</code></a> function returns the datetime of your current
location, based on your system's time zone setting, while the gmtime
function returns the current UTC datetime.</p>
<p>The <code>Time::localtime</code> and <code>Time::gmtime</code> modules provide a thin
object layer around <code>gmtime()</code> and <a href="#item_localtime"><code>localtime()</code></a> respectively, so
you can do things like <code>print gmtime()-&gt;year</code>.  Of course, that
<em>still</em> prints the year minus 1900.</p>
</li>
<li><strong><a name="item_time%3a%3alocal">Time::Local</a></strong><br />
<p>This core module provide functions that translate from the array of
components returned by <a href="#item_localtime"><code>localtime()</code></a> or <code>gmtime()</code> back to an epoch
time.</p>
</li>
<li><strong><a name="item_posix%2epm">POSIX.pm</a></strong><br />
<p>The <code>POSIX</code> module included with Perl provides interfaces to several
common C library functions for datetimes, such as <code>strftime()</code>.  I
consider this the last refuge for the desperate, because the
<a href="#item_posix%2epm"><code>POSIX.pm</code></a> module is a memory hog, and the C library interface is
rather un-Perlish.</p>
</li>
</ul>
















<h3><a name="the_big_stars">The Big Stars</a></h3>
<p>These are the modules that have the longest history, and are the most
widely used.</p>
<ul>
<li><strong><a name="item_timedate_distribution">TimeDate distribution</a></strong><br />
<p>This distribution, maintained and mostly written by Graham Barr,
includes three modules.  <code>Date::Format</code> module provides a few
functions for formatting datetime output, including a <code>strftime()</code>
similar to the one in the standard C library.  It can work with either
epoch times, or the array of components returned by Perl's
<a href="#item_localtime"><code>localtime()</code></a> function.</p>
<p><code>Date::Parse</code> parses a limited set of common datetime formats,
returning either an epoch time or an array of components.</p>
<p>The distribution also includes a number of language modules which can
be used to localize both parsing and formatting.</p>
<p>Finally, <code>Time::Zone</code> provides an interface to time zone offsets,
based on short time zone names like &quot;EST&quot; or &quot;GMT&quot;.  As was mentioned
before, these names are not official or standardized, so they are of
limited usefulness.</p>
<p>All of these modules are limited by their use of epoch time
internally, but they are fairly quick and light weight.  For complex
datetime problems, these modules probably don't automate enough of the
dirty work.</p>
</li>
<li><strong><a name="item_time%3a%3apiece">Time::Piece</a></strong><br />
<p>Written and maintained by Matt Sergeant, this module is based on an
interface designed by Larry Wall.  It provides a convenient object API
for datetimes, though the API is a bit confusing.  For example, <code>$time-&gt;mon</code> returns the month number (1-12) while <code>$time-&gt;month</code> returns the abbreviated name of the month.</p>
<p>It also implements basic parsing and formatting via the use of the
C-level <code>strptime()</code> and <code>strftime()</code> functions.  The included
<code>Time::Seconds</code> module allows for basic date math, such as <code>$tomorrow = $time + ONE_DAY</code>.</p>
<p>The implementation is fairly lightweight, but is limited by its use of
epoch time as the internal representation.  It is certainly useful,
but like the TimeDate modules, it doesn't go far enough for more
complex uses.</p>
<p>As of this writing, Matt Sergeant has released an experimental version
of <a href="#item_time%3a%3apiece"><code>Time::Piece</code></a> based on my <code>DateTime.pm</code> module.  This leaves the
<a href="#item_time%3a%3apiece"><code>Time::Piece</code></a> API unchanged, but allows it to handle dates that
cannot be represented by a given system's epoch.</p>
</li>
<li><strong><a name="item_date%3a%3amanip">Date::Manip</a></strong><br />
<p>Sullivan Beck's <a href="#item_date%3a%3amanip"><code>Date::Manip</code></a> is really huge, weighing in at about
3,000 lines of code.  As might be expected of that much code, there is
something for everyone here.  It handles parsing, formatting, date
math, as well as more esoteric things like recurring datetimes and
business day calculations.  It should be noted that it's time zone
support is pretty much the same that provided by <code>Time::Zone</code>.</p>
<p>This module's most unique feature is its very flexible parser, which
is capable of handling things like &quot;3 weeks ago Monday&quot; or &quot;next
Sunday&quot;.  It also provides some parsing for specifying recurrences,
like &quot;every 3rd Monday in 2003&quot;.</p>
<p>Unlike everything else we've covered so far, this module is not
limited to epoch times.  It has an entirely functional interface, and
in my opinion the API could be cleaner.  I dislike the fact that some
functions do many different things, with the output depending either
on the argument type(s), explicit flags, or both.</p>
<p>But the biggest problem with this module, which is acknowledged by its
author, is its size.  It uses lots of memory (about 3MB on my system),
and is fairly slow to load.  The former makes it problematic for
mod_perl, and the latter causes problems with CGI scripts.  You can
find most of its features elsewhere, in slimmer modules, but if size
and speed are not an issue, this module almost certainly does
everything you want.</p>
</li>
<li><strong><a name="item_date%3a%3acalc">Date::Calc</a></strong><br />
<p>Steffen Beyer's <a href="#item_date%3a%3acalc"><code>Date::Calc</code></a> distribution is where you go when you
need functionality combined with speed.  This modules offers much of
the functionality provided by <a href="#item_date%3a%3amanip"><code>Date::Manip</code></a>, but the core
<a href="#item_date%3a%3acalc"><code>Date::Calc</code></a> module has a much smaller memory footprint than
<a href="#item_date%3a%3amanip"><code>Date::Manip</code></a> (about 1MB on my box), and much greater speed.  This is
based its core implementation is in C.</p>
<p>This module provides functions for calculating all sorts of
date-related information, as well some minimal parsing and formatting
operations.  The interface requires some hand-holding to use, as every
function returns one or more elements, never a data structure such as
a hash, so you have to constantly deal with passing and receiving
arrays of values.</p>
<p>The distribution also includes a class called <code>Date::Calc::Object</code>,
which can represent either a datetime <em>or</em> a &quot;delta&quot;, the difference
between two datetimes.  This dual nature is odd, since many of the
methods applicable to one will not work for the other.  The class
supports overloading for date math and comparison, so you can do
things like <code>$date + [1, 2, 3]</code>, which adds one year, two months, and
three days to the given date.</p>
<p>Finally, there is a <code>Date::Calendar</code> object, which can be used to set
up a calendar &quot;profile&quot; defining holidays, work days, and partial work
days in a variety of ways.  This is quite useful if you need to
calculate a day X business days in the future, while taking account of
a particular organization's holidays.</p>
<p>None of the modules in this distribution rely on epoch time, though
they only support positive-numbered years.  Time zone support is
extremely minimal, and is done only as offsets, without support for
daylight saving rules.  Localization for a variety of languages is
implemented for parsing and formatting.</p>
</li>
</ul>
<h3><a name="and_a_cast_of_thousands_...">And a Cast of Thousands ...</a></h3>
<p>It wouldn't be Perl if there weren't at least a dozen other modules
with overlapping functionality, right?  In this case, there's more
than two dozen!  For sanity's sake, I've excluded more than a few
modules, in particular those that either appeared to be unmaintained,
or those without enough comprehensible documentation for me to figure
out what the heck they do.  In alphabetical order, those remaining
are:</p>
<ul>
<li><strong><a name="item_astro%3a%3asunrise_%2d_ron_hill">Astro::Sunrise - Ron Hill</a></strong><br />
<p>This module provides sunrise and sunset times, given a specific date
and place.</p>
</li>
<li><strong><a name="item_astro%3a%3atime_%2d_chris_phillips">Astro::Time - Chris Phillips</a></strong><br />
<p>Contains a number of functions useful when dealing with datetimes as
they are used in astronomy.</p>
</li>
<li><strong><a name="item_class%3a%3adate_%2d_balzs_szab">Class::Date - Bal&0xE1;zs Szab&0xF3;</a></strong><br />
<p>This is basically the <a href="#item_time%3a%3apiece"><code>Time::Piece</code></a> API plus more stuff.  It appears
to provide complete time zone support based on the Olson database, by
way of <a href="#item_posix%2epm"><code>POSIX.pm</code></a>.  It is epoch-limited.</p>
</li>
<li><strong><a name="item_date%3a%3abusiness_%2d_richard_desimine">Date::Business - Richard DeSimine</a></strong><br />
<p>A simple interface for doing date math with business dates.  In other
words, weekends don't count, and you can define your own holidays.
This module is epoch-limited.</p>
</li>
<li><strong><a name="item_date%3a%3aconvert_%2d_mordechai_abzug">Date::Convert - Mordechai Abzug</a></strong><br />
<p>Converts dates between the Gregorian, Hebrew, and Julian calendars.</p>
</li>
<li><strong><a name="item_date%3a%3aconvert%3a%3afrench_rev_%2d_jean_forget">Date::Convert::French_Rev - Jean Forget</a></strong><br />
<p>Converts to and from the French Revolutionary calendar.</p>
</li>
<li><strong><a name="item_date%3a%3aday_%2d_john_von_essen">Date::Day - John Von Essen</a></strong><br />
<p>Tells you the day of the week for a given date.</p>
</li>
<li><strong><a name="item_date%3a%3adayofweek_%2d_rich_bowen">Date::DayofWeek - Rich Bowen</a></strong><br />
<p>Does exactly the same thing as <code>Date::Day</code> but only for years
1500-2699.  On the flip side, it uses a cuter algorithm.</p>
</li>
<li><strong><a name="item_date%3a%3adecade_%2d_michael_diekmann">Date::Decade - Michael Diekmann</a></strong><br />
<p>Provides three decade calculation functions with an API similar to
that of <a href="#item_date%3a%3acalc"><code>Date::Calc</code></a>.</p>
</li>
<li><strong><a name="item_date%3a%3adiscordian_%2d_rich_bowen">Date::Discordian - Rich Bowen</a></strong><br />
<p>Converts to and from the Discordian calendar.</p>
</li>
<li><strong><a name="item_date%3a%3aeaster_%2d_rich_bowen">Date::Easter - Rich Bowen</a></strong><br />
<p>Calculates the date Easter falls on in a given year.</p>
</li>
<li><strong><a name="item_date%3a%3ahandler_%2d_benoit_beausejour">Date::Handler - Benoit Beausejour</a></strong><br />
<p>A date object comparable to <a href="#item_time%3a%3apiece"><code>Time::Piece</code></a>, but with a more consistent
interface.  It implements localization, a variety of date math
operations, and includes an object for representing datetime spans.
It provides time zone support based on the native OS implementation,
which on some systems means support for the Olson database.  It is
epoch-limited.</p>
</li>
<li><strong><a name="item_date%3a%3aical_%2d_rich_bowen">Date::ICal - Rich Bowen</a></strong><br />
<p>A date object that provides a simple API, date math, and iCal
formatting and parsing (see RFC 2445).  It only support time zones as
offsets, but it is not epoch-limited.</p>
</li>
<li><strong><a name="item_date%3a%3aiso_%2d_rich_bowen">Date::ISO - Rich Bowen</a></strong><br />
<p>A subclass of Date::ICal that adds ISO 8601 format parsing and
formatting.</p>
</li>
<li><strong><a name="item_date%3a%3ajapanese%3a%3aera_%2d_tatsuhiko_miyagawa">Date::Japanese::Era - Tatsuhiko Miyagawa</a></strong><br />
C<p>onverts to and from Japanese Era dates.</p>
</li>
<li><strong><a name="item_date%3a%3ajapanese%3a%3aholiday_%2d_tomohiro_ikebe">Date::Japanese::Holiday - Tomohiro Ikebe</a></strong><br />
<p>Tells you whether or not a given date is a Japanese holiday.</p>
</li>
<li><strong><a name="item_date%3a%3aleapsecond_%2d_flvio_soibelmann_glock">Date::Leapsecond - Fl&0xE1;vio Soibelmann Glock</a></strong><br />
<p>Converts between UT1 and UTC times.</p>
</li>
<li><strong><a name="item_date%3a%3aleapyear_%2d_rich_bowen">Date::Leapyear - Rich Bowen</a></strong><br />
<p>One function to tell you whether or not a given year is a leap year.</p>
</li>
<li><strong><a name="item_date%3a%3amaya_%2d_abigail">Date::Maya - Abigail</a></strong><br />
<p>Converts between Julian days and the Mayan calendar.</p>
</li>
<li><strong><a name="item_date%3a%3apassover_%2d_rich_bowen">Date::Passover - Rich Bowen</a></strong><br />
<p>Calculates the dates of Passover and Rosh Hashanah for a given year.</p>
</li>
</ul>















<ul>
<li><strong><a name="item_date%3a%3aperiodparser_%2d_simon_cozens">Date::PeriodParser - Simon Cozens</a></strong><br />
<p>Parses English descriptions of time periods like &quot;this morning&quot; or
&quot;around two weeks ago&quot; and turns them into pairs of epoch times
representing the beginning and end of the period.</p>
</li>
<li><strong><a name="item_date%3a%3arange_%2d_tony_bowden">Date::Range - Tony Bowden</a></strong><br />
<p>An object for representing a range of dates.  Lets you figure out
whether two ranges overlap, whether a date is included in a given
range, and a few other useful things.</p>
</li>
<li><strong><a name="item_date%3a%3aroman_%2d_leo_cacciari">Date::Roman - Leo Cacciari</a></strong><br />
<p>An object for representing dates according to the Roman calendar.</p>
</li>
<li><strong><a name="item_date%3a%3aset_%2d_flvio_soibelmann_glock">Date::Set - Fl&0xE1;vio Soibelmann Glock</a></strong><br />
<p>An object that represents sets of datetimes.  A set can be either a
datetime span, a recurring set of dates, or a fixed set of specific
datetimes.  It provides set math operations for all of these, as well
as allowing you to iterate across the members of the set.  Also see
<code>Date::Set::Timezone</code>.</p>
</li>
<li><strong><a name="item_date%3a%3asimple_%2d_john_tobey">Date::Simple - John Tobey</a></strong><br />
A<p> date object that represents dates only, without a time component.
It provides date math.  It is not epoch-limited.</p>
</li>
<li><strong><a name="item_date%3a%3atie_%2d_flvio_soibelmann_glock">Date::Tie - Fl&0xE1;vio Soibelmann Glock</a></strong><br />
<p>A basic date object with date math.  Its functionality is implemented
via a tied hash interface.  It supports fixed offset time zones, and
it is epoch-limited.</p>
</li>
<li><strong><a name="item_http%3a%3adate_%2d_gisle_aas">HTTP::Date - Gisle Aas</a></strong><br />
<p>This module is part of the LWP distribution.  It parses many common
datetime formats, including all of those that are used by the HTTP
protocol.  If <code>Date::Parse</code> doesn't understand all the formats you
need to deal with, this module provides a good alternative.</p>
</li>
<li><strong><a name="item_time%3a%3aduration_%2d_sean_burke">Time::Duration - Sean Burke</a></strong><br />
<p>Given a number of seconds, this module return a human language
description of the duration.  For example, 3660 seconds would be &quot;1
hour and 1 minute&quot;.</p>
</li>
<li><strong><a name="item_time%3a%3ahuman_%2d_simon_cozens">Time::Human - Simon Cozens</a></strong><br />
<p>Given an epoch time, this module can return a string describing that
time in colloquial terms, such as &quot;half past nine&quot;.  It has hooks for
localization.</p>
</li>
<li><strong><a name="item_time%3a%3aunix_%2d_nathan_wiger">Time::Unix - Nathan Wiger</a></strong><br />
<p>Loading this module forces Perl's <a href="#item_time"><code>time()</code></a> function to use the Unix
epoch system, regardless of the OS on which the code is running.</p>
</li>
<li><strong><a name="item_time_modules_%2d_david_muir_sharnoff">Time modules - David Muir Sharnoff</a></strong><br />
<p>This distribution includes <code>Time::CTime</code>, <code>Time::ParseDate</code>, and
<code>Time::Timezone</code>, which are slightly more powerful versions of Graham
Barr's <code>Date::Format</code>, <code>Date::Parse</code>, and <code>Time::Zone</code>.</p>
</li>
</ul>
<h3><a name="but_wait,_there's_more!">But Wait, There's More!</a></h3>
<p>Not content to leave well enough alone, I've recently started a
project to fix what I see as the fundamental problem with the state of
Perl datetime modules.  That fundamental problem is that despite the
fact that almost all the possible functionality you could want exists,
it is scattered over a large number of incompatible modules.</p>
<p>For example, <a href="#item_date%3a%3acalc"><code>Date::Calc</code></a> provides good functionality for various
datetime calculations and date math, but the values it returns are not
well suited for being passed to <code>Date::Format</code>.  And while
<a href="#item_date%3a%3amanip"><code>Date::Manip</code></a> has powerful parsing, the return value from its parsing
routine cannot be passed to any other module without further
massaging.  And so and so on.</p>
<p>For example, if I wanted to parse a date with <code>Date::Parse</code> and then
calculate the date one week later with <a href="#item_date%3a%3acalc"><code>Date::Calc</code></a>, and then format
it with <code>Date::Format</code>, I'd have to do the following:</p>
<pre>
my $time1 = str2time($date_string); # Date::Parse</pre>
<pre>
# Today() from Date::Calc returns
# date information for an epoch time
my ($y1, $m1, $d1) = Today($time);</pre>
<pre>
my ($y2, $m2, $d2) = Add_Delta_Days($y1, $m1, $d1, 7);</pre>
<pre>
my $time2 = Date_to_Time($y2, $m2, $d2);</pre>
<pre>
print strftime('%B %d, %Y', $time2);</pre>
<p>Of course, I didn't <em>have</em> to use the <code>strftime()</code> function for
formatting a date.  I could have done it with just <a href="#item_date%3a%3acalc"><code>Date::Calc</code></a> as:</p>
<pre>
print sprintf('%s %02d %04d',
Month_to_Text($m2), $d2, $y2);</pre>
<p>But I want convenience.  If I'm dealing with many datetimes and I need
to parse various inputs, generate different formats, and do lots of
calculations, then a convenient and uniform API can go a long way
towards code maintainability.  The extra glue code needed to make
different modules cooperate can quickly obscure the actual intent of
the program.</p>
<p>Efforts in the past to herd all the existing module authors towards a
common API have failed, so rather than try that again, I decided to
just write even more datetime code.  As we all know, the best way to
put out a fire is to pour copious amounts of gasoline on it.  In order
to make my project sound cool, I'm calling it the &quot;Perl DateTime
Suite&quot;, which sounds much better than &quot;more date and time modules&quot;.</p>
<p>The goal for this project is to produce a suite of datetime modules
that do everything you'd ever need related to dates and times.  The
modules in this suite will cooperate with each other, which means that
a module that parses datetimes will return a standard object, and a
module for formatting datetimes will accept that standard object.</p>
<p>So far, this project has attracted interest from a number of people,
and discussions on the <a href="mailto:datetime@perl.org">datetime@perl.org</a> list have gone well.
Recently, I released alpha versions of the core object,
<code>DateTime.pm</code>, as well as <code>DateTime::TimeZone</code>, which provides
complete time zone support based on the Olson database.  There is also
an alpha of <code>DateTime::Format::ICal</code> on CPAN, a module for parsing
and formatting iCal datetimes and durations.  In the future, look for
more modules in the suite, all of which will begin with &quot;DateTime::&quot;.</p>
<h3><a name="further_resources_and_reading">Further Resources and Reading</a></h3>
<p>Some excellent online resources include Claus Tondering's Calendar FAQ
at <a href="http://www.tondering.dk/claus/calendar.html,">http://www.tondering.dk/claus/calendar.html,</a> as well as the US
Naval Observatory Time Service site at <a href="http://tycho.usno.navy.mil/.">http://tycho.usno.navy.mil/.</a>
For more information on time zones and the Olson database, see
<a href="http://www.twinsun.com/tz/tz-link.htm.">http://www.twinsun.com/tz/tz-link.htm.</a></p>
<p>If you're interested in discussing anything related to Perl and
datetimes, check out the <a href="mailto:datetime@perl.org">datetime@perl.org</a> list.  You can subscribe by
sending a message to <a href="mailto:datetime-subscribe@perl.org.">datetime-subscribe@perl.org.</a></p>
<h3><a name="thanks">Thanks</a></h3>
<p>Thanks to Jonathan Scott Duff, Nick Tonkin, and Iain Truskett for
reviewing this article before publication.</p>


        </div>



    </div>
    <div class="asset-footer"></div>
</div>


                            
                            <div id="entry-1094" class="entry-asset asset hentry">
    <div class="asset-header">
        <h2 class="asset-name entry-title"><a href="/pub/2003/03/p6pdigest/20030309.html" rel="bookmark">This week on Perl 6, week ending 2003-03-09</a></h2>
        <div class="asset-meta">
            <span class="byline">
    
                By <span class="vcard author">Piers Cawley</span> on <abbr class="published" title="2003-03-09T00:00:00-08:00">March  9, 2003 12:00 AM</abbr>
    
            </span>

            
            

        </div>
    </div>
    <div class="asset-content entry-content">

        <div class="asset-body">
            
<!-- sidebar begins -->
<!-- don't move sidebars -->
<!-- sidebar ends -->


<p>Ooh look, it's another of those Perl 6 Summaries where Piers tries to
work a gratuitous reference to Leon Brocard into a summary of what's
been happening to the Perl 6 development process this week.</p>
<p>As tradition dictates, we'll start with all the action from
perl6-internals.</p>

<h4><a name="object_specs">Object Specs</a></h4>
<p>With his great good taste and impeccable timing, Dan Sugalski managed
to release his second draft of an Object spec at 22.27 GMT on Sunday
March the second. Which meant that, strictly, the root message of this
thread doesn't belong in this summary. To which I say 'Tosh!'</p>
<p>Brent Dax wondered how this spec coped with classless OO languages
like JavaScript and whether such languages would have to fake
things with anonymous classes. It seems that faking it is going to the
'right' way.</p>
<p>Erik Bagfors asked for a clear example of the difference between
attributes and properties, and between class and object variables. Dan
didn't actually offer an example, but explained that properties are
'runtime assigned name values pairs that are stuck on a variable',
while attributes 'correspond to instance variables or slots in other
object systems'.</p>
<p>Dave Whipp wondered about the semantics of creation and destruction of
objects with a long list of questions. Dan replied that there was a
'Class Spec' forthcoming at some point too. The Object spec concerns
itself with 'just the behaviour of objects that already exist'.</p>
<p>Some further discussion of this happened in perl6-language, but Dan
dragged it back into perl6-internals. I shall follow his example by
summarizing those subthreads here, whilst muttering rude words under
my breath about people make a poor summarizer's life so hard.</p>
<p>Garrett Goebel (not G&ouml;bel, as I mistakenly spelt it last
week) wondered about serialization and persistence and wondered
whether a 'pure Parrot' serialization scheme would be possible,
allowing one to serialize Perl, Python, Ruby etc objects at the Parrot
level. Dan pointed out that there were <code>freeze</code> and <code>thaw</code> vtable
entries for PMCs, and said that he had some 'sketches of necessary
core functionality to make it feasible'. It looks like simple 'data
objects' will be simple to serialize at the parrot level.</p>
<p>Sam Vilain suggested a whole bunch of extra things to be associated
with Objects. Dan noted that all of Sam's suggestions were actually
things that belonged with Classes rather than objects, with the
exception of what Sam referred to as 'associations'. Garret asked for
some clarification of what Sam was talking about, tying it to
something Sam had said in perl6-language about 'exporting object
relationships in a sensible and consistent manner', so Sam did a brain
dump which outlined a scheme for persisting almost anything in a
language neutral manner (requiring more or less complicity on the part
of some languages) with loads of neat ideas in it. Dan liked the
ideas, but isn't going to go the whole way (probably). Dan also
implied that Parrot's serialize/deserialize methods would make use of
the GC system to make sure that everything gets dumped properly, once
and only once, solving the problem of cyclic references (YAY! An OO
Persistence tool writer writes).</p>
<p>Dan released the next iteration of his tentative object spec on Sunday
(but a little earlier this time). He and Uri Guttman spent the rest of
the day thrashing out some issues and clarifying some terminology. Dan
is threatening a glossary with the next try at an object spec.</p>
<p>(Dan just suggested on IRC that I summarize these threads as 'Dan
muttered incoherently about objects again. Folks generally humored
him.' Which I would never do of course; I'm English and I know how to
spell 'humour'.)</p>
<p><a href="http://groups.google.com/groups?threadm=a05200f03ba882e2a2fcb%40%5B63.120.19.221%5D">http://groups.google.com/groups</a> -- Object spec (try 2)</p>
<p><a href="http://groups.google.com/groups?threadm=71BEC0D4E1DED3118F7A009027B12028034C8C34%40EXCH_MISSION">http://groups.google.com/groups</a>
-- Garrett's first question</p>
<p><a href="http://groups.google.com/groups?threadm=200303042358.56560.sam%40vilain.net">http://groups.google.com/groups</a> -- Sam Vilain's suggestions</p>
<p><a href="http://groups.google.com/groups?threadm=71BEC0D4E1DED3118F7A009027B12028034C8C3D%40EXCH_MISSION">http://groups.google.com/groups</a> -- Garrett
asks for clarity</p>
<p><a href="http://groups.google.com/groups?threadm=200303071408.38029.sam%40vilain.net">http://groups.google.com/groups</a> -- Sam's brain dump.</p>
<p><a href="http://groups.google.com/groups?threadm=a05200f00ba8d18fbf624%40%5B63.120.19.221%5D">http://groups.google.com/groups</a> -- Object Spec (try 3)</p>


<h4><a name="imcc_and_multiple_source_files">IMCC and multiple source files</a></h4>
<p>K Stol wondered whether it was possible to write multi-file IMCC
programs. Leopold T&ouml;tsch answered that, whilst there's no Parrot
linker as yet, but by the time we read his post we could use the
<code>.include</code> macro to glue source files together.</p>
<p><a href="http://groups.google.com/groups?threadm=BAY1-DAV70xZpvXB2PO0000d563%40hotmail.com">http://groups.google.com/groups</a></p>


<h4><a name="patch_roundup">Patch Roundup</a></h4>
<p>Jason Gloudon added some more ops to the sun4 JIT core. His patch was
applied, along with most of Steve Peters' patches from last
week. J&uuml;rgen B&ouml;mmels patched the print ops to use pure PIO
(Parrot IO) rather than a scary stdio/PIO hybrid. Dan applied this one
with alacrity (I don't think he likes stdio).</p>


<h4><a name="coroutines_end_and_dfg">Coroutines end and DFG</a></h4>
<p>Leo T&ouml;tsch wondered if coroutines ended and if they did, how?
Leo noted that coroutines caused IMCC some big headaches with register
allocation. Jonathan Sillito replied saying that coroutines were never
ending and pointed out that each coroutine has its own user stack
which means that <code>saveall</code> and <code>restoreall</code> do the right thing,
which wasn't quite what gives IMCC headaches because you can't pass
arguments in the stack and have to rely on lexicals or globals, which
apparently means that IMCC will need some new hints to work out what's
happening.</p>
<p>Nobody explained what DFG stands for.</p>
<p><a href="http://groups.google.com/groups?threadm=3E650FCD.7010906%40toetsch.at">http://groups.google.com/groups</a></p>


<h4><a name="sablevm">SableVM</a></h4>
<p>Tupshin pointed everyone at SableVM 'an interesting Java VM done as a
doctoral thesis'. Leo found some of the optimization techniques in the
thesis interesting. Which scares me.</p>
<p><a href="http://groups.google.com/groups?threadm=3E6B09CB.7020007%40tupshin.com">http://groups.google.com/groups</a></p>
<p><a href="http://www.sablevm.org/">http://www.sablevm.org/</a> -- SableVM</p>
<p><a href="http://www.info.uqam.ca/%7Eegagnon/gagnon-phd.pdf">http://www.info.uqam.ca/%7Eegagnon/gagnon-phd.pdf</a> -- SableVM Thesis</p>


<h4><a name="parrot_0.0.10_freeze">Parrot 0.0.10 freeze</a></h4>
<p>Steve Fink announced the feature freeze before release 0.0.10. Parrot
is now frozen prior to the 0.0.10 release on March 15th.</p>
<p><a href="http://groups.google.com/groups?threadm=20030309225740.GA662%40foxglove">http://groups.google.com/groups</a></p>



<h3><a name="meanwhile,_over_in_perl6language">Meanwhile, over in perl6-language</a></h3>
<p>The object discussion leaked over from perl6-internals, I'll cover the
language relevant parts here. Dave Whipp had some interesting things
to say about Associations in response to one of Sam Vilain's posts
that I covered in perl6-internals and Andy Wardley offered a counter
argument. There was a fair amount of discussion about the advisability
of Multiple Inheritance (which can be summed up as ``we don't have to
like it but we probably have to do it''.) Andy Wardley proposed
stealing Ruby's Mixins and Simon Cozens came up with a nifty
Perl6-o-meter which Larry pointed out was rather more general than
Simon intended.</p>
<p><a href="http://groups.google.com/groups?threadm=20030306231736.3750.qmail%40onion.perl.org">http://groups.google.com/groups</a></p>
<p><a href="http://groups.google.com/groups?threadm=20030306174032.GA14420%40wall.org">http://groups.google.com/groups</a></p>


<h4><a name="signal/slot_like_mechanism">Signal/slot like mechanism</a></h4>
<p>Yannick Le Saint wondered if there was a notification mechanism
planned for Perl 6. Luke Palmer offered a simple implementation which
wasn't quite what Yannick was after which looks like it might possibly
need modifications to the 'Class' Class. Dan pointed noted that there
would almost certainly be a mechanism for registering watcher subs
with the internals (``Yay!'' writes an insane summarizer with a penchant
for digging around in Perl's runtime internals...).</p>
<p><a href="http://groups.google.com/groups?threadm=200303061827.15964.y.lesaint%40free.fr">http://groups.google.com/groups</a></p>



<h3><a name="acknowledgements,_announcements_and_apologies">Acknowledgements, Announcements and Apologies</a></h3>
<p>Another quiet week. However, as I write this Apocalypse 6 is available
to read on perl.com and Dan is making noises on IRC about the next
draft of the object spec being released some time before
Sunday. I have the feeling that next week's summary will be covering a
lot more traffic.</p>
<p>Still haven't produced an American Odyssey web page. I've been too
busy taking photographs and relearning how to use my large format
camera.</p>
<p>If you appreciated this summary, please consider one or more of the
following options:</p>
<ul>
<li>
Send money to the Perl Foundation at
<a href="http://donate.perl-foundation.org/">http://donate.perl-foundation.org/</a> and help support the ongoing
development of Perl.</li>


<li>
Get involved in the Perl 6 process. The mailing lists are open  to
all. <a href="http://dev.perl.org/perl6/">http://dev.perl.org/perl6/</a> and <a href="http://www.parrotcode.org/">http://www.parrotcode.org/</a>
are good starting points with links to the appropriate mailing lists.</li>


<li>
Send feedback, flames, money, job offers or an extension back for an
Ebony 45S to <em><a href="mailto:p6summarizer@bofh.org.uk">p6summarizer@bofh.org.uk</a></em></li>

</ul>
<p>This week's summary was again sponsored by Darren Duncan. Thanks
Darren. If you'd like to become a summary sponsor, drop me a line at
<em><a href="mailto:p6summarizer@bofh.org.uk">p6summarizer@bofh.org.uk</a></em>.</p>

        </div>



    </div>
    <div class="asset-footer"></div>
</div>


                            
                            <div id="entry-1084" class="entry-asset asset hentry">
    <div class="asset-header">
        <h2 class="asset-name entry-title"><a href="/pub/2003/03/07/apocalypse6.html" rel="bookmark">Apocalypse 6</a></h2>
        <div class="asset-meta">
            <span class="byline">
    
                By <span class="vcard author">Larry Wall</span> on <abbr class="published" title="2003-03-07T00:00:00-08:00">March  7, 2003 12:00 AM</abbr>
    
            </span>

            
            

        </div>
    </div>
    <div class="asset-content entry-content">

        <div class="asset-body">
            
<!-- sidebar begins -->
<!-- don't move sidebars -->
<!-- sidebar ends -->

<p><em>Editor's Note: this Apocalypse is out of date and remains here for historic reasons.  See <a href="http://dev.perl.org/perl6/doc/design/syn/S06.html">Synopsis 06</a> for the latest information.</em></p>

<p>This is the Apocalypse on Subroutines.  In Perl culture the term
&quot;subroutine&quot; conveys the general notion of calling something that
returns control automatically when it's done.  This &quot;something&quot; that
you're calling may go by a more specialized name such as &quot;procedure&quot;,
&quot;function&quot;, &quot;closure&quot;, or &quot;method&quot;.  In Perl 5, all such subroutines
were declared using the keyword <code>sub</code> regardless of their specialty.
For readability, Perl 6 will use alternate keywords to declare special
subroutines, but they're still essentially the same thing underneath.
Insofar as they all behave similarly, this Apocalypse will have
something to say about them.  (And if we also leak a few secrets
about how method calls work, that will make Apocalypse 12 all the
easier--presuming we don't have to un-invent anything between now
and then...)</p>
<p>Here are the RFCs covered in this Apocalypse.  PSA stands for &quot;problem,
solution, acceptance&quot;, my private rating of how this RFC will fit into
Perl 6.  I note that none of the RFCs achieved unreserved acceptance
this time around.  Maybe I'm getting picky in my old age.  Or maybe
I just can't incorporate anything into Perl without &quot;marking&quot; it...</p>
<pre><code>
    RFC   PSA   Title
    ---   ---   -----
     21   abc   Subroutines: Replace C&lt;wantarray&gt; with a generic C&lt;want&gt;
                   function
     23   bcc   Higher order functions
     57   abb   Subroutine prototypes and parameters
     59   bcr   Proposal to utilize C&lt;*&gt; as the prefix to magic subroutines
     75   dcr   structures and interface definitions
    107   adr   lvalue subs should receive the rvalue as an argument
    118   rrr   lvalue subs: parameters, explicit assignment, and wantarray()
                   changes
    128   acc   Subroutines: Extend subroutine contexts to include name
                   parameters and lazy arguments
    132   acr   Subroutines should be able to return an lvalue
    149   adr   Lvalue subroutines: implicit and explicit assignment
    154   bdr   Simple assignment lvalue subs should be on by default
    160   acc   Function-call named parameters (with compiler optimizations)
    168   abb   Built-in functions should be functions
    176   bbb   subroutine / generic entity documentation
    194   acc   Standardise Function Pre- and Post-Handling
    271   abc   Subroutines : Pre- and post- handlers for subroutines
    298   cbc   Make subroutines' prototypes accessible from Perl
    334   abb   Perl should allow specially attributed subs to be called as C
                   functions
    344   acb   Elements of @_ should be read-only by default</code></pre>
<p>In Apocalypses 1 through 4, I used the RFCs as a springboard for
discussion.  In Apocalypse 5 I was forced by the complexity of the
redesign to switch strategies and present the RFCs after a discussion
of all the issues involved.  That was so well received that I'll try
to follow the same approach with this and subsequent Apocalypses.</p>
<p>But this Apocalypse is not trying to be as radical as the one on
regexes.  Well, okay, it is, and it isn't.   Alright, it <em>is</em> radical,
but you'll like it anyway (we hope).  At least the old way of calling
subroutines still works.  Unlike regexes, Perl subroutines don't have
a lot of historical cruft to get rid of.  In fact, the basic problem
with Perl 5's subroutines is that they're not crufty enough, so the
cruft leaks out into user-defined code instead, by the Conservation
of Cruft Principle.  Perl 6 will let you migrate the cruft out of the
user-defined code and back into the declarations where it belongs.
Then you will think it to be very beautiful cruft indeed (we hope).</p>
<p>Perl 5's subroutines have a number of issues that need to be dealt
with.  First of all, they're just awfully slow, for various reasons:</p>
<ul>
<li>
Construction of the <code>@_</code> array
</li>


<li>
Needless prepping of potential lvalues
</li>


<li>
General model that forces lots of run-time processing
</li>


<li>
Difficulty of optimization
</li>


<li>
Storage of unneeded context
</li>


<li>
Lack of tail recursion optimization
</li>


<li>
Named params that aren't really
</li>


<li>
Object model that forces double dispatch in some cases
</li>

</ul>
<p>Quite apart from performance, however, there are a number of
problems with usability:</p>
<ul>
<li>
Not easy to detect type errors at compile time
</li>


<li>
Not possible to specify the signatures of certain built-in functions
</li>


<li>
Not possible to define control structures as subroutines
</li>


<li>
Not possible to type-check any variadic args other than as a list
</li>


<li>
Not possible to have a variadic list providing scalar context to
its elements
</li>


<li>
Not possible to have lazy parameters
</li>


<li>
Not possible to define immediate subroutines (macros)
</li>


<li>
Not possible to define subroutines with special syntax
</li>


<li>
Not enough contextual information available at run time.
</li>


<li>
Not enough contextual information available at compile time.
</li>

</ul>
<p>In general, the consensus is that Perl 5's simple subroutine syntax is
just a little <em>too</em> simple.  Well, okay, it's a <em>lot</em> too simple.
While it's extremely orthogonal to always pass all arguments as a
single variadic array, that mechanism does not always map well onto
the problem space.  So in Perl 6, subroutine syntax has blossomed in
several directions.</p>
<p>But the most important thing to note is that we haven't actually added
a lot of syntax.  We've added some, but most of new capabilities come
in through the generalized trait/property system, and the new type
system.  But in those cases where specialized syntax buys us clarity,
we have not hesitated to add it.  (Er, actually, we hesitated quite
a lot.  Months, in fact.)</p>
<p>One obvious difference is that the <code>sub</code> on closures is now optional,
since every brace-delimited block is now essentially a closure.
You can still put the <code>sub</code> if you like.  But it is only required
if the block would otherwise be construed as a hash value; that is,
if it appears to contain a list of pairs.  You can force any block to
be considered a subroutine with the <code>sub</code> keyword; likewise you can
force any block to be considered a hash value with the <code>hash</code> keyword.
But in general Perl just dwims based on whether the top-level is a
list that happens to have a first argument that is a pair or hash:</p>
<pre><code>
    Block               Meaning
    -----               -------
    { 1 =&gt; 2 }          hash { 1 =&gt; 2 }
    { 1 =&gt; 2, 3 =&gt; 4 }  hash { 1 =&gt; 2, 3 =&gt; 4 }
    { 1 =&gt; 2, 3, 4 }    hash { 1 =&gt; 2, 3 =&gt; 4 }
    { %foo, 1 =&gt; 2 }    hash { %foo.pairs, 1 =&gt; 2 }</code></pre>
<p>Anything else that is not a list, or does not start with a pair or
hash, indicates a subroutine:</p>
<pre><code>
    { 1 }               sub { return 1 }
    { 1, 2 }            sub { return 1, 2 }
    { 1, 2, 3 }         sub { return 1, 2, 3 }
    { 1, 2, 3 =&gt; 4 }    sub { return 1, 2, 3 =&gt; 4 }
    { pair 1,2,3,4 }    sub { return 1 =&gt; 2, 3 =&gt; 4 }
    { gethash() }       sub { return gethash() }</code></pre>
<p>This is a syntactic distinction, not a semantic one.  That last two
examples are taken to be subs despite containing functions returning
pairs or hashes.  Note that it would save no typing to recognize the
<code>pair</code> method specially, since <code>hash</code> automatically does pairing
of non-pairs.  So we distinguish these:</p>
<pre><code>
    { pair 1,2,3,4 }    sub { return 1 =&gt; 2, 3 =&gt; 4 }
    hash { 1,2,3,4 }    hash { 1 =&gt; 2, 3 =&gt; 4 }</code></pre>
<p>If you're worried about the compiler making bad choices before deciding
whether it's a subroutine or hash, you shouldn't.  The two constructs
really aren't all that far apart.  The <code>hash</code> keyword could in fact
be considered a function that takes as its first argument a closure
returning a hash value list.  So the compiler might just compile the
block as a closure in either case, then do the obvious optimization.</p>
<p>Although we say the <code>sub</code> keyword is now optional on a closure, the
<code>return</code> keyword only works with an explicit <code>sub</code>.  (There are
other ways to return values from a block.)</p>


<h2><a name="subroutine_declarations">Subroutine Declarations</a></h2>
<p>You may still declare a sub just as you did in Perl 5, in which case
it behaves much like it did in Perl 5.  To wit, the arguments still
come in via the <code>@_</code> array.  When you say:</p>
<pre><code>
    sub foo { print @_ }</code></pre>
<p>that is just syntactic sugar for this:</p>
<pre><code>
    sub foo (*@_) { print @_ }</code></pre>
<p>That is, Perl 6 will supply a default parameter signature (the precise
meaning of which will be explained below) that makes the subroutine
behave much as a Perl 5 programmer would expect, with all the arguments
in <code>@_</code>.  It is not exactly the same, however.  You may not modify
the arguments via <code>@_</code> without declaring explicitly that you want
to do so.  So in the rare cases that you want to do that, you'll have
to supply the <code>rw</code> trait (meaning the arguments should be considered
&quot;read-write&quot;):</p>
<pre><code>
    sub swap (*@_ is rw) { @_[0,1] = @_[1,0] };</code></pre>
<p>The Perl5-to-Perl6 translator will try to catch those cases and add
the parameter signature for you when you want to modify the arguments.
(Note: we will try to be consistent about using &quot;arguments&quot; to mean
the actual values you pass to the function when you call it, and
&quot;parameters&quot; to mean the list of lexical variables declared
as part of the subroutine signature, through which you access the
values that were passed to the subroutine.)</p>
<p>Perl 5 has rudimentary prototypes, but Perl 6 type signatures can be
much more expressive if you want them to be.  The entire declaration
is much more flexible.  Not only can you declare types and names of
individual parameters, you can add various traits to the parameters,
such as <code>rw</code> above.  You can add traits to the subroutine itself,
and declare the return type.  In fact, at some level or other,
the subroutine's signature and return type are also just traits.
You might even consider the body of the subroutine to be a trait.</p>
<p>For those of you who have been following Perl 6 development, you'll
wonder why we're now calling these &quot;traits&quot; rather than &quot;properties&quot;.
They're all really still properties under the hood, but we're trying to
distinguish those properties that are expected to be set on containers
at compile time from those that are expected to be set on values
at run time.  So compile-time properties are now called &quot;traits&quot;.
Basically, if you declare it with <code>is</code>, it's a trait, and if you add
it onto a value with <code>but</code>, it's a property.  The main reason for
making the distinction is to keep the concepts straight in people's
minds, but it also has the nice benefit of telling the optimizer
which properties are subject to change, and which ones aren't.</p>
<p>A given trait may or may not be implemented as a method on the
underlying container object.  You're not supposed to care.</p>
<p>There are actually several syntactic forms of trait:</p>
<pre><code>
    rule trait :w {
          is &lt;ident&gt;[\( &lt;traitparam&gt; \)]?
        | will &lt;ident&gt; &lt;closure&gt;
        | of &lt;type&gt;
        | returns &lt;type&gt;
    }</code></pre>
<p>(We're specifying the syntax here using Perl 6 regexes.  If you don't
know about those, go back and read Apocalypse 5.)</p>
<p>A <code>&lt;type&gt;</code> is actually allowed to be a junction of types:</p>
<pre><code>
    sub foo returns Int|Str {...}</code></pre>
<p>The <code>will</code> syntax specifically introduces a closure trait without
requiring the extra parens that <code>is</code> would.  Saying:</p>
<pre><code>
    will flapdoodle { flap() and doodle() }</code></pre>
<p>is exactly equivalent to:</p>
<pre><code>
    is flapdoodle({ flap() and doodle() })</code></pre>
<p>but reads a little better.  More typically you'll see traits like:</p>
<pre><code>
    will first { setup() }
    will last { teardown() }</code></pre>
<p>The final block of a subroutine declaration is the &quot;do&quot; trait.  Saying:</p>
<pre><code>
    sub foo { ... }</code></pre>
<p>is like saying:</p>
<pre><code>
    sub foo will do { ... }</code></pre>
<p>Note however that the closure eventually stored under the <code>do</code> trait
may in fact be modified in various ways to reflect argument processing,
exception handling, and such.</p>
<p>We'll discuss the <code>of</code> and <code>returns</code> traits later when we discuss
types.  Back to syntax.</p>














<p><em>Editor's Note: this Apocalypse is out of date and remains here for historic reasons.  See <a href="http://dev.perl.org/perl6/doc/design/syn/S06.html">Synopsis 06</a> for the latest information.</em></p>

<h3><a name="the_sub_form">The <code>sub</code> form</a></h3>
<p>A subroutine can be declared as lexically scoped, package scoped,
or unscoped:</p>
<pre><code>
    rule lexicalsub :w {
        &lt;lexscope&gt; &lt;type&gt;?
        &lt;subintro&gt; &lt;subname&gt; &lt;psignature&gt;?
        &lt;trait&gt;*
        &lt;block&gt;
    }</code></pre>
<pre><code>
    rule packagesub :w {
        &lt;subintro&gt; &lt;subname&gt; &lt;psignature&gt;?
        &lt;trait&gt;*
        &lt;block&gt;
    }</code></pre>
<pre><code>
    rule anonsub :w {
        &lt;subintro&gt; &lt;psignature&gt;?
        &lt;trait&gt;*
        &lt;block&gt;
    }</code></pre>
<p>The non-lexically scoped declaration cannot specify a return type
in front.  The return type can only be specified as a trait in that case.</p>
<p>As in Perl 5, the difference between a package sub and an anonymous
sub depends on whether you specify the <code>&lt;subname&gt;</code>.  If omitted,
the declaration (which is not really a declaration in that case)
generates and returns a closure.  (Which may not <em>really</em> be a
closure if it doesn't access any external lexicals, but we call them
all closures anyway just in case...)</p>
<p>A lexical subroutine is declared using either <code>my</code> or <code>our</code>:</p>
<pre><code>
    rule lexscope { my | our }</code></pre>
<p>This list doesn't include <code>temp</code> or <code>let</code> because those are not
declarators of lexical scope but rather operators that initiate
dynamic scoping.  See the section below on Lvalue subroutines for
more about <code>temp</code> and <code>let</code>.</p>
<p>In both lexical and package declarations, the name of the subroutine
is introduced by the keyword <code>sub</code>, or one of its variants:</p>
<pre><code>
    rule subintro { sub | method | submethod | multi | rule | macro }</code></pre>
<p>A <code>method</code> participates in inheritance and always has an invocant
(object or class).  A <code>submethod</code> has an invocant but does not
participate in inheritance.  It's a sub pretending to be a method
for the current class only.  A <code>multi</code> is a multimethod, that is,
a method that called like a subroutine or operator, but is dispatched
based on the types of one or more of its arguments.</p>
<p>Another variant is the regex <code>rule</code>, which is really a special kind
of method; but in actuality rules probably get their own set of parse
rules, since the body of a rule is a regex.  I just put &quot;rule&quot; into
&lt;subintro&gt; as a placeholder of sorts, because I'm lazy.</p>
<p>A <code>macro</code> is a subroutine that is called immediately upon completion
of parsing.  It has a default means of parsing arguments, or it may
be bound to an alternate grammar rule to parse its arguments however
you like.</p>
<p>These syntactic forms correspond the various <code>Routine</code> types in the
<code>Code</code> type hierarchy:</p>
<pre><code>
                                   Code
                        ____________|________________
                       |                             |
                    Routine                        Block
       ________________|_______________            __|___
      |     |       |       |    |     |          |      |
     Sub Method Submethod Multi Rule Macro      Bare Parametric</code></pre>
<p>The <code>Routine</code>/<code>Block</code> distinction is fairly important, since you
always <code>return</code> out of the current <code>Routine</code>, that is, the current
<code>Sub</code>, <code>Method</code>, <code>Submethod</code>, <code>Multi</code>, <code>Rule</code>, or <code>Macro</code>.  Also,
the <code>&amp;_</code> variable refers to your current <code>Routine</code>.  A <code>Block</code>,
whether <code>Bare</code> or <code>Parametric</code>, is invisible to both of those notions.</p>
<p>(It's not yet clear whether the <code>Bare</code> vs <code>Parametric</code> distinction
is useful.  Some apparently <code>Bare</code> blocks are actually <code>Parametric</code>
if they refer to <code>$_</code> internally, even implicitly.  And a <code>Bare</code>
block is just a <code>Parametric</code> block with a signature of <code>()</code>.
More later.)</p>
<p>A <code>&lt;psignature&gt;</code> is a parenthesized signature:</p>
<pre><code>
    rule psignature :w { \( &lt;signature&gt; \) }</code></pre>
<p>And there is a variant that doesn't declare names:</p>
<pre><code>
    rule psiglet :w { \( &lt;siglet&gt; \) }</code></pre>
<p>(We'll discuss &quot;siglets&quot; later in their own section.)</p>
<p>It's possible to declare a subroutine in an lvalue or a signature as if
it were an ordinary variable, in anticipation of binding the symbol to an
actual subroutine later.  Note this only works with an explicit name, since
the whole point of declaring it in the first place is to have a name for it.
On the other hand, the formal subroutine's parameters <em>aren't</em> named, hence
they are specified by a <code>&lt;psiglet&gt;</code> rather than a <code>&lt;psignature&gt;</code>:</p>
<pre><code>
    rule scopedsubvar :w {
        &lt;lexscope&gt; &lt;type&gt;? &amp;&lt;subname&gt; &lt;psiglet&gt;? &lt;trait&gt;*
    }</code></pre>
<pre><code>
    rule unscopedsubvar :w {
        &amp;&lt;subname&gt; &lt;psiglet&gt;? &lt;trait&gt;*
    }</code></pre>
<p>If no <code>&lt;psiglet&gt;</code> is supplied for such a declaration, it just
uses whatever the signature of the bound routine is.  So instead of:</p>
<pre><code>
    my sub foo (*@_) { print @_ }</code></pre>
<p>you could equivalently say:</p>
<pre><code>
    my &amp;foo ::= sub (*@_) { print @_ };</code></pre>
<p>(You may recall that <code>::=</code> does binding at compile time.  Then again,
you may not.)</p>
<p>If there is a <code>&lt;psiglet&gt;</code>, however, it must be compatible with
the signature of the routine that is bound to it:</p>
<pre><code>
    my &amp;moo(Cow) ::= sub (Horse $x) { $x.neigh };     # ERROR</code></pre>


<h3><a name="pointy_subs">&quot;Pointy subs&quot;</a></h3>
<p>&quot;Pointy subs&quot; declare a closure with an unparenthesized signature:</p>
<pre><code>
    rule pointysub :w {
        -\&gt; &lt;signature&gt; &lt;block&gt;
    }</code></pre>
<p>They may not take traits.</p>


<h3><a name="bare_subs">Bare subs</a></h3>
<p>A bare block generates a closure:</p>
<pre><code>
    rule baresub :w {
        &lt;block&gt; { .find_placeholders() }
    }</code></pre>
<p>A bare block declaration does not take traits (externally, anyway), and
if there are any parameters, they must be specified with placeholder
variables.  If no placeholders are used, <code>$_</code> may be treated as
a placeholder variable, provided the surrounding control structure
passes an argument to the the closure.  Otherwise, <code>$_</code> is bound as
an ordinary lexical variable to the outer <code>$_</code>.  (<code>$_</code> is also an
ordinary lexical variable when explicit placeholders are used.)</p>
<p>More on parameters below.  But before we talk about parameters,
we need to talk about types.</p>


<h2><a name="digression_on_types">Digression on types</a></h2>
<p>Well, what are types, anyway?  Though known as a &quot;typeless&quot; language,
Perl actually supports several built-in container types such as scalar,
array, and hash, as well as user-defined, dynamically typed objects
via <code>bless</code>.</p>
<p>Perl 6 will certainly support more types.  These include some low-level
storage types:</p>
<pre><code>
    bit int str num ref bool</code></pre>
<p>as well as some high-level object types:</p>
<pre><code>
    Bit Int Str Num Ref Bool
    Array Hash Code IO
    Routine Sub Method Submethod Macro Rule
    Block Bare Parametric
    Package Module Class Object Grammar
    List Lazy Eager</code></pre>
<p>(These lists should not be construed as exhaustive.)  We'll also need
some way of at least hinting at representations to the compiler,
so we may also end up with types like these:</p>
<pre><code>
    int8 int16 int32 int64
    uint8 uint16 uint32 uint64</code></pre>
<p>Or maybe those are just extra <code>size</code> traits on a declaration
somewhere.  That's not important at this point.</p>
<p>The important thing is that we're adding a generalized type system
to Perl.  Let us begin by admitting that it is the height of madness to
add a type system to a language that is well-loved for being typeless.</p>
<p>But mad or not, there are some good reasons to do just that.
First, it makes it possible to write interfaces to other languages
in Perl.  Second, it gives the optimizer more information to think
about.  Third, it allows the S&amp;M folks to inflict strongly typed
compile-time semantics on each other.  (Which is fine, as long as
they don't inflict those semantics on the rest of us.)  Fourth,
a type system can be viewed as a pattern matching system for
multi-method dispatch.</p>
<p>Which basically boils down to the notion that it's fine for Perl
to have a type system as long as it's optional.  It's just another
area where Perl 6 will try to have its cake and eat it too.</p>
<p>This should not actually come as a surprise to anyone who has been
following the development of Perl 5, since the grammatical slot
for declaring a variable's effective type has been defined for some
time now.  In Perl 5 you can say:</p>
<pre><code>
    my Cat $felix;</code></pre>
<p>to declare a variable intended to hold a <code>Cat</code> object.  That's nice, as far
as it goes.  Perl 6 will support the same syntax, but we'll have
to push it much further than that if we're to have a type system
that is good enough to specify interfaces to languages like C++
or Java.  In particular, we have to be able to specify the types of
composite objects such as arrays and hashes without resorting to class
definitions, which are rather heavyweight--not to mention opaque.
We need to be able to specify the types of individual function and
method parameters and return values.  Taken collectively, these
parameter types can form the signature of a subroutine, which is one
of the traits of the subroutine.</p>
<p>And of course, all this has to be intuitively obvious to the naive
user.</p>
<p>Yeah, sure, you say.</p>
<p>Well, let's see how far we can get with it.  If the type system is
too klunky for some particular use, people will simply avoid using it.
Which is fine--that's why it's optional.</p>
<p>First, let's clarify one thing that seems to confuse people frequently.
Unlike some languages, Perl makes a distinction between the type of
the variable, and the type of the value.  In Perl 5, this shows up
as the difference between overloading and tying.  You overload the
value, but you tie the variable.  When you say:</p>
<pre><code>
    my Cat $felix;</code></pre>
<p>you are specifying the type of the <em>value</em> being stored, not the
type of the <em>variable</em> doing the storing.  That is, <code>$felix</code> must
contain a reference to a <code>Cat</code> value, or something that &quot;isa&quot; <code>Cat</code>.
The variable type in this case is just a simple scalar, though that
can be changed by tying the variable to some class implementing the
scalar variable operations.</p>














<p><em>Editor's Note: this Apocalypse is out of date and remains here for historic reasons.  See <a href="http://dev.perl.org/perl6/doc/design/syn/S06.html">Synopsis 06</a> for the latest information.</em></p>

<p>In Perl 6, the type of the variable is just one of the traits of the
variable, so if you want to do the equivalent of a <code>tie</code> to the <code>Box</code>
class, you say something like:</p>
<pre><code>
    my Cat $felix is Box;</code></pre>
<p>That declares your intent to store a <code>Cat</code> value into a <code>Box</code>
variable.  (Whether the cat will then dead or alive (or dead|alive)
depends on the definition of the <code>Box</code> class, and whether the <code>Box</code>
object's side effects extend to the <code>Cat</code> value stored in it.)</p>
<p>But by default:</p>
<pre><code>
    my Cat $felix;</code></pre>
<p>just means something like:</p>
<pre><code>
    my Cat $felix is Scalar;</code></pre>
<p>Likewise, if you say:</p>
<pre><code>
    my Cat @litter;</code></pre>
<p>it's like saying:</p>
<pre><code>
    my Cat @litter is Array;</code></pre>
<p>That is, <code>@litter</code> is an ordinary array of scalar values that happen
to be references to <code>Cat</code>s.  In the abstract, <code>@litter</code> is a function
that maps integers to cats.</p>
<p>Likewise,</p>
<pre><code>
    my Cat %pet;</code></pre>
<p>is like:</p>
<pre><code>
    my Cat %pet is Hash;</code></pre>
<p>You can think of the <code>%pet</code> hash as a function that maps cat names
(strings) to cats.  Of course, that's an oversimplification--for both
arrays and hashes, subscripting is not the only operation.  But it's
the fundamental operation, so the declared type of the returned value
reflects the return value of such a subscripted call.</p>
<p>Actually, it's not necessarily the return type.  It's merely a type
that is <em>consistent</em> with the returned type.  It would be better
to declare:</p>
<pre><code>
    my Animal %pet;</code></pre>
<p>and then you could return a <code>Cat</code> or a <code>Dog</code> or a <code>Sponge</code>, presuming all
those are derived from <code>Animal</code>.  You'd have to generalize it a bit
further if you want to store your pet <code>Rock</code>.  In the limit, you can
just leave the type out.  When you say:</p>
<pre><code>
    my %pet;</code></pre>
<p>you're really just saying:</p>
<pre><code>
    my Object %pet is Hash;</code></pre>
<p>...except that you're not.  We have to push it further than that,
because we have to handle more complicated structures as well.
When you say:</p>
<pre><code>
    my Cat @litter is Array;</code></pre>
<p>it's really shorthand for:</p>
<pre><code>
    my @litter is Array of Cat;</code></pre>
<p>That is, &quot;<code>Cat</code>&quot; is really a funny parameter that says what kind of
<code>Array</code> you have.  If you like, you could even write it like this:</p>
<pre><code>
    my @litter is Array(returns =&gt; Cat)</code></pre>
<p>Likewise you might write:</p>
<pre><code>
    my %pet is Hash(keytype =&gt; Str, returns =&gt; Cat)</code></pre>
<p>and specify the key type of the hash.  The &quot;<code>of</code>&quot; keyword is just
syntactic sugar for specifying the return type of the previous
storage class.  So we could have</p>
<pre><code>
    my %pet is Hash of Array of Array of Hash of Array of Cat;</code></pre>
<p>which might really mean:</p>
<pre><code>
    my %pet is Hash(keytype =&gt; Str,
                    returns =&gt; Array(
                        returns =&gt; Array(
                            returns =&gt; Hash(
                                keytype =&gt; Str,
                                returns =&gt; Array(
                                    returns =&gt; Cat)))))</code></pre>
<p>or some such.</p>
<p>I suppose you could also write that as:</p>
<pre><code>
    my Array of Array of Hash of Array of Cat %pet;</code></pre>
<p>but for linguistic reasons it's probably better to keep the variable
name near the left and put the long, heavy phrases to the right.
(People tend to prefer to say the short parts of their sentences
before the long parts--linguists call this the &quot;end-weight&quot; problem.)
The <code>Hash</code> is implied by the <code>%pet</code>, so you could leave out the &quot;<code>is</code>&quot;
part and just say:</p>
<pre><code>
    my %pet of Array of Array of Hash of Array of Cat;</code></pre>
<p>Another possibility is:</p>
<pre><code>
    my Cat %pet is Hash of Array of Array of Hash of Array;</code></pre>
<p>That one reads kinda funny if you leave out the &quot;<code>is Hash</code>&quot;, though.
Nevertheless, it says that we have this funny data structure that
has multiple parameters that you can view as a funny function
returning <code>Cat</code>.  In fact, &quot;<code>returns</code>&quot; is a synonym for &quot;<code>of</code>&quot;.
This is also legal:</p>
<pre><code>
    my @litter returns Cat;</code></pre>
<p>But the &quot;<code>returns</code>&quot; keyword is mostly for use by functions:</p>
<pre><code>
    my Cat sub find_cat($name) {...}</code></pre>
<p>is the same as:</p>
<pre><code>
    my sub find_cat($name) returns Cat {...}</code></pre>
<p>This is more important for things like closures that have no &quot;<code>my</code>&quot;
on the front:</p>
<pre><code>
    $closure = sub ($name) returns Cat {...}</code></pre>
<p>Though for the closure case, it's possible we could define some kind
of non-<code>my</code> article to introduce a type unambiguously:</p>
<pre><code>
    $closure = a Camel sub ($name) {...}
    $closure = an Aardvark sub () {...}</code></pre>
<p>Presumably &quot;<code>a</code>&quot; or &quot;<code>an</code>&quot; is short for &quot;anonymous&quot;.  Which is more or
less what the indefinite article means in English.</p>
<p>However, we need <code>returns</code> anyway in cases where the return value
is complicated, so that you'd rather list it later (for end-weight
reasons):</p>
<pre><code>
    my sub next_prisoner() returns (Nationality, Name, Rank, SerialNo) {...}</code></pre>
<p>Note that the return type is a signature much like the parameter types,
though of course there are no formal parameter names on a return value.
(Though there could be, I suppose.)  We're calling such nameless
signatures &quot;siglets&quot;.</p>


<h2><a name="stub_declarations">Stub declarations</a></h2>
<p>When you declare a subroutine, it can change how the rest of the
current file (or string) is compiled.  So there is some pressure to
put subroutine declarations early.  On the other hand, there are good
reasons for putting subroutine definitions later in the file too,
particularly when you have mutually recursive subroutines.  Beyond
that, the definition might not even be supplied until run time if you
use some kind of autoloading mechanism.  (We'll discuss autoloading
in Apocalypse 10, Packages.)  Perl 5 has long supported the notion of
&quot;forward&quot; declarations or &quot;stubs&quot; via a syntax that looks like this:</p>
<pre><code>
    sub optimal;</code></pre>
<p>Perl 6 also supports stubbing, but instead you write it like this:</p>
<pre><code>
    sub optimal {...}</code></pre>
<p>That is, the stub is distinguished not by leaving the body of the
function out, but by supplying a body that explicitly calls the
&quot;<code>...</code>&quot; operator (known affectionately as the &quot;yada, yada, yada&quot;
operator).  This operator emits a warning if you actually try to
execute it.  (It can also be made to pitch an exception.)  There is
no warning for redefining a <code>{...}</code> body.</p>
<p>We're moving away from the semicolon syntax in order to be consistent
with the distinction made by other declarations:</p>
<pre><code>
    package Fee;        # scope extends to end of file
    package Fee { ... } # scope extends over block</code></pre>
<pre><code>
    module Fie;         # scope extends to end of file
    module Fie { ... }  # scope extends over block</code></pre>
<pre><code>
    class Foe;          # scope extends to end of file
    class Foe { ... }   # scope extends over block</code></pre>
<p>To be consistent, a declaration like:</p>
<pre><code>
    sub foo;</code></pre>
<p>would therefore extend to the end of the file.  But that would be
confusing for historical reasons, so we disallow it instead, and you
have to say:</p>
<pre><code>
    sub foo {...}</code></pre>














<p><em>Editor's Note: this Apocalypse is out of date and remains here for historic reasons.  See <a href="http://dev.perl.org/perl6/doc/design/syn/S06.html">Synopsis 06</a> for the latest information.</em></p>

<h2><a name="scope_of_subroutine_names">Scope of subroutine names</a></h2>
<p>Perl 5 gives subroutine names two scopes.  Perl 6 gives them four.</p>


<h3><a name="package_scoped_subs">Package scoped subs</a></h3>
<p>All named subs in Perl 5 have package scope.  (The body provides a
lexical scope, but we're not talking about that.  We're talking about
where the name of the subroutine is visible from.)  Perl 6 provides
by default a package-scoped name for &quot;unscoped&quot; declarations such
as these:</p>
<pre><code>
          sub fee {...}
       method fie {...}
    submethod foe {...}
        multi foo {...}
        macro sic {...}</code></pre>
<p>Methods and submethods are ordinarily package scoped, because (just
as in Perl 5) a class's namespace is kept in a package.</p>


<h3><a name="anonymous_subs">Anonymous subs</a></h3>
<p>It's sort of cheating to call this a subroutine scope, because it's
really more of a non-scope.  Scope is a property of the <em>name</em>
of a subroutine. Since closures and anonymous subs have no name,
they naturally have no intrinsic scope of their own.  Instead, they
rely on the scope of whatever variable contains a reference to them.
The only way to get a lexically scoped subroutine name in Perl 5 was
by indirection:</p>
<pre><code>
    my $subref = sub { dostuff(@_) }
    &amp;$subref(...)</code></pre>
<p>But that doesn't actually give you a lexically scoped name that is
equivalent to an ordinary subroutine's name.  Hence, Perl 6 also
provides...</p>


<h3><a name="lexically_scoped_subs">Lexically scoped subs</a></h3>
<p>You can declare &quot;scoped&quot; subroutines by explicitly putting a <code>my</code>
or <code>our</code> on the front of the declaration:</p>
<pre><code>
    my sub privatestuff { ... }
    our sub semiprivatestuff { ... }</code></pre>
<p>Both of these introduce a name into the current lexical scope, though
in the case of <code>our</code> this is just an alias for a package subroutine
of the same name.  (As with other uses of <code>our</code>, you might want
to introduce a lexical alias if your strictness level prohibits
unqualified access to package subroutines.)</p>
<p>You can also declare lexically scoped macros:</p>
<pre><code>
    my macro sic { ... }</code></pre>


<h3><a name="global_scoped_subs">Global scoped subs</a></h3>
<p>Perl 6 also introduces the notion of completely global variables that
are visible from everywhere they aren't overridden by the current
package or lexical scope.  Such variables are named with a leading <code>*</code>
on the identifier, indicating that the package prefix is a wildcard,
if you will.  Since subroutines are just a funny kind of variable,
you can also have global subs:</p>
<pre><code>
    sub *print (*@list) { $*DEFOUT.print(@list) } }</code></pre>
<p>In fact, that's more-or-less how some built-in functions like <code>print</code>
could be implemented in Perl 6.  (Methods like <code>$*DEFOUT.print()</code>
are a different story, of course.  They're defined off in a
class somewhere.  (Unless they're multimethods, in which case they
could be defined almost anywhere, because multimethods are always
globally scoped.  (In fact, most built-ins including <code>print</code> will
be multimethods, not subs. (But we're getting ahead of ourselves...))))</p>


<h2><a name="signatures">Signatures</a></h2>
<p>One of Perl's strong points has always been the blending of
positional parameters with variadic parameters.</p>
<p>&quot;Variadic&quot; parameters are the ones that <em>vary</em>.  They're the &quot;...And
The Rest&quot; list of values that many functions--like <code>print</code>, <code>map</code>,
and <code>chomp</code>--have at the end of their call.  Whereas positional
parameters generally tell a function <em>how</em> to do its job, variadic
parameters are most often used to pass the arbitrary sequences of
data the function is supposed to do its job on/with/to.</p>
<p>In Perl 5, when you unpack the arguments to a <code>sub</code> like so:</p>
<pre><code>
    my ($a, $b, $c, @rest) = @_;</code></pre>
<p>you are defining three positional parameters, followed by a variadic
list.  And if you give the sub a prototype of <code>($$$@)</code> it will force the
first three parameters to be evaluated in scalar context, while the
remaining arguments are evaluated in list context.</p>
<p>The big problem with the Perl 5 solution is that the parameter
binding is done at run time, which has run-time costs.  It also
means the metadata is not readily available outside the function body.
We could just as easily have written it in some other form like:</p>
<pre><code>
    my $a = shift;
    my $b = shift;
    my $c = shift;</code></pre>
<p>and left the rest of the arguments in <code>@_</code>.  Not only is this
difficult for a compiler to analyze, but it's impossible to get the
metadata from a stub declaration; you have to have the body defined
already.</p>
<p>The old approach is very flexible, but the cost to the user is
rather high.</p>
<p>Perl 6 still allows you to access the arguments via <code>@_</code> if you
like, but in general you'll want to hoist the metadata up into
the declaration.  Perl 6 still fully supports the distinction
between positional and variadic data--you just have to declare them
differently.  In general, variadic items must follow positional items
both in declaration and in invocation.</p>
<p>In turn, there are at least three kinds of positional parameters, and
three kinds of variadic parameters.  A declaration for all six kinds
of parameter won't win a beauty contest, but might look like this:</p>
<pre><code>
    method x ($me: $req, ?$opt, +$namedopt, *%named, *@list) {...}</code></pre>
<p>Of course, you'd rarely write all of those in one declaration.
Most declarations only use one or two of them.  Or three or four...
Or five or six...</p>
<p>There is some flexibility in how you pass some of these parameters,
but the ordering of both formal parameters and actual arguments is
constrained in several ways.  For instance, positional parameters must
precede non-positional, and required parameters must precede optional.
Variadic lists must be attached either to the end of the positional
list or the end of the named parameter list.  These constraints serve
a number of purposes:</p>
<ul>
<li>
They avoid user confusion.
</li>


<li>
They enable the system to implement calls efficiently.
</li>


<li>
Perhaps most importantly, they allow interfaces to evolve without
breaking old code.
</li>

</ul>
<p>Since there are constraints on the ordering of parameters, similar
parameters tend to clump together into &quot;zones&quot;.  So we'll call the
<code>?</code>, <code>+</code>, and <code>*</code> symbols you see above &quot;zone markers&quot;.  The
underlying metaphor really is very much like zoning regulations--you
know, the ones where your city tells you what you may or may not do
on a chunk of land you think you own.  Each zone has a set of possible
uses, and similar zones often have overlapping uses.  But you're still
in trouble if you put a factory in the middle of a housing division,
just as you're in trouble if you pass a positional argument to a
formal parameter that has no position.</p>
<p>I was originally going to go with a semicolon to separate required
from optional parameters (as Perl 5 uses in its prototypes), but I
realized that it would get lost in the traffic, visually speaking.
It's better to have the zone markers line up, especially if you decide
to repeat them in the vertical style:</p>
<pre><code>
    method action ($self:
                int  $x,
                int ?$y,
                int ?$z,
             Adverb +$how,
        Beneficiary +$for,
           Location +$at is copy,
           Location +$toward is copy,
           Location +$from is copy,
             Reason +$why,
                    *%named,
                    *@list
                ) {...}</code></pre>
<p>So optional parameters are all marked with zone markers.</p>
<p>In this section we'll be concentrating on the declaration's syntax
rather than the call's syntax, though the two cannot be completely
disintertwingled.  The declaration syntax is actually the more
complicated of the two for various good reasons, so don't get too
discouraged just yet.</p>


<h3><a name="positional_parameters">Positional parameters</a></h3>
<p>The three positional parameter types are the invocant, the required
parameters, and the optional positional parameters.  (Note that in
general, positional parameters may also be called using named parameter
notation, but they must be declared as positional parameters if you
wish to have the <em>option</em> of calling them as positional parameters.)
All positional parameters regardless of their type are considered
scalars, and imply scalar context for the actual arguments.  If you
pass an array or hash to such a parameter, it will actually pass
a reference to the array or hash, just as if you'd backslashed the
actual argument.</p>


<h4><a name="the_invocant">The invocant</a></h4>
<p>The first argument to any method (or submethod) is its invocant, that
is, the object or class upon which the method is acting.  The invocant
parameter, if present, is always declared with a colon following it.
The invocant is optional in the sense that, if there's no colon,
there's no explicit invocant declared.  It's still there, and it must
be passed by the caller, but it has no name, and merely sets the outer
topic of the method.  That is, the invocant's name is <code>$_</code>, at least
until something overrides the current topic.  (You can always get at
the invocant with the <code>self</code> built-in, however.  If you don't like
&quot;self&quot;, you can change it with a macro.  See below.)</p>
<p>Ordinary subs never have an invocant.  If you want to declare a
non-method subroutine that behaves as a method, you should declare
a submethod instead.</p>
<p>Multimethods can have multiple invocants.  A colon terminates the list
of invocants, so if there is no colon, all parameters are considered
invocants.  Only invocants participate in multimethod dispatch.
Only the first invocant is bound to <code>$_</code>.</p>
<p>Macros are considered methods on the current parse state object,
so they have an invocant.</p>


<h4><a name="required_parameters">Required parameters</a></h4>
<p>Next (or first in the case of subs) come the required positional
parameters.  If, for instance, the routine declares three of these,
you have to pass at least three arguments in the same order.  The list
of required parameters is terminated at the first optional parameter,
that is the first parameter having any kind of zone marker.  If none
of those are found, all the parameters are required, and if you pass
either too many or too few arguments, Perl will throw an exception
as soon as it notices.  (That might be at either compile time or run
time.)  If there are optional or variadic parameters, the required
list merely serves as the minimum number of arguments you're allowed
to pass.</p>


<h4><a name="optional_parameters">Optional parameters</a></h4>
<p>Next come the optional positional parameters.  (They have to come next
because they're positional.)  In the declaration, optional positional
parameters are distinguished from required parameters by marking the
optional parameters with a question mark.  (The parameters are not
distinguished in the call--you just use commas.  We'll discuss call
syntax later.)  All optional positional parameters are marked with
<code>?</code>, not just the first one.  Once you've made the transition to the
optional parameter zone, all parameters are considered optional from
there to the end of the signature, even after you switch zones to
<code>+</code> or <code>*</code>.  But once you leave the positional zone (at the end
of the <code>?</code> zone), you can't switch back to the positional zone,
because positionals may not follow variadics.</p>
<p>If there are no variadic parameters following the optional parameters,
the declaration establishes both a minimum and a maximum number of
allowed arguments.  And again, Perl will complain when it notices
you violating either constraint.  So the declaration:</p>
<pre><code>
    sub *substr ($string, ?$offset, ?$length, ?$repl) {...}</code></pre>
<p>says that <code>substr</code> can be called with anywhere from 1 to 4 scalar
parameters.</p>


<h3><a name="variadic_parameters">Variadic parameters</a></h3>
<p>Following the positional parameters, three kinds of variadic parameters
may be declared.  Variadic arguments may be slurped into a hash or
an array depending on whether they look like named arguments or not.
&quot;Slurpy&quot; parameters are denoted by a unary <code>*</code> before the variable
name, which indicates that an arbitrary number of values is expected
for that variable.</p>
<p>Additional named parameters may be placed at the end of the
declaration, or marked with a unary <code>+</code> (because they're &quot;extra&quot;
parameters).  Since they are--by definition--in the variadic region,
they may only be passed as named arguments, never positionally.  It is
illegal to mark a parameter with <code>?</code> after the first <code>+</code> or <code>*</code>,
because you can't reenter a positional zone from a variadic zone.</p>
<p>Unlike the positional parameters, the variadic parameters are not
necessarily declared in the same order as they will be passed in the
call.  They may be declared in any order (though the exact behavior
of a slurpy array depends slightly on whether you declare it first
or last).</p>


<h4><a name="namedonly_parameters">Named-only parameters</a></h4>
<p>Parameters marked with a <code>+</code> zone marker are named-only parameters.
Such a parameter may never be passed positionally, but only by name.</p>














<p><em>Editor's Note: this Apocalypse is out of date and remains here for historic reasons.  See <a href="http://dev.perl.org/perl6/doc/design/syn/S06.html">Synopsis 06</a> for the latest information.</em></p>

<h4><a name="the_slurpy_hash">The slurpy hash</a></h4>
<p>A hash declaration like <code>*%named</code> indicates that the <code>%named</code>
hash should slurp up all the remaining named arguments (that is,
those that aren't bound explicitly to a specific formal parameter).</p>


<h4><a name="the_slurpy_array">The slurpy array</a></h4>
<p>An array declaration like <code>*@rest</code> indicates that the <code>@rest</code> array
should slurp up all the remaining items after the named parameters.
(Later we'll discuss how to disambiguate the situation when the
beginning of your list looks like named parameters.)  If you <code>shift</code>
or <code>pop</code> without an argument, it shifts or pops whatever slurpy array
is in scope.  (So in a sense, your main program has an implicit slurpy
array of <code>*@*ARGS</code> because that's what <code>shift</code> shifts there.)</p>


<h3><a name="formal_parameter_syntax">Formal parameter syntax</a></h3>
<p>Formal parameters have lexical scope, as if they were declared with
a <code>my</code>.  (That is reflected in the pseudocode in Appendix B.)
Their scope extends only to the end of the associated block.
Formal parameters are the only lexically scoped variables that are
allowed to be declared outside their blocks.  (Ordinary <code>my</code> and
<code>our</code> declarations are always scoped to their surrounding block.)</p>
<p>Any subroutine can have a method signature syntactically, but
subsequent semantic analysis will reject mistakes like invocants on
subroutines.  This is not just motivated by laziness.  I think that
&quot;<code>You can't have an invocant on a subroutine</code>&quot; is a better error
message than &quot;<code>Syntax error</code>&quot;.</p>
<pre><code>
    rule signature :w {
        [&lt;parameter&gt; [&lt;[,:]&gt; &lt;parameter&gt; ]* ]?
    }</code></pre>
<p>In fact, we just treat colon as a funny comma here, so any use of
extra colons is detected in semantic analysis.  Similarly, zone
markers are semantically restricted, not syntactically.  Again,
&quot;<code>Syntax error</code>&quot; doesn't tell you much.  It's much more informative
to see &quot;<code>You can't declare an optional positional parameter like
?$flag after a slurpy parameter like *@list</code>&quot;, or &quot;<code>You can't use
a zone marker on an invocant</code>&quot;.</p>
<p>Here's what an individual parameter looks like:</p>
<pre><code>
    rule parameter :w {
        [ &lt;type&gt;? &lt;zone&gt;? &lt;variable&gt; &lt;trait&gt;* &lt;defval&gt;?
        | \[ &lt;signature&gt; \]     # treat single array ref as an arg list
        ]
    }</code></pre>
<pre><code>
    rule zone {
        [ \?            # optional positional
        | \*            # slurpy array or hash
        | \+            # optional named-only
        ]
    }</code></pre>
<pre><code>
    rule variable { &lt;sigil&gt; &lt;name&gt; [ \( &lt;siglet&gt; \) ]? }
    rule sigil { &lt;[$@%&amp;]&gt; &lt;[*.?^]&gt;? }   # &quot;What is that, swearing?&quot;</code></pre>
<p>Likewise, we parse any sigil here, but semantically reject things like <code>$*x</code>
or <code>$?x</code>.  We also reject package-qualified names and indirect names.
We could have a <code>&lt;simplevar&gt;</code> rule that only admits <code>&lt;ident&gt;</code>,
but again, &quot;<code>Syntax error</code>&quot; is a lot less user-friendly than &quot;<code>You can't
use a package variable as a parameter, dimwit!</code>&quot;</p>
<p>Similarly, the optional <code>&lt;siglet&gt;</code> in <code>&lt;variable&gt;</code> is allowed
only on <code>&amp;</code> parameters, to say what you expect the signature of
the referenced subroutine to look like.  We should talk about siglets.</p>


<h4><a name="siglets">Siglets</a></h4>
<p>The <code>&lt;siglet&gt;</code> in the <code>&lt;variable&gt;</code> rule is an example of
a nameless signature, that is, a &quot;small signature&quot;, or &quot;siglet&quot;.
Signatures without names are also used for return types and context
traits (explained later).  A siglet is sequential list of paramlets.
The paramlets do not refer to actual variable names, nor do they
take defaults:</p>
<pre><code>
    rule siglet :w {
        [&lt;paramlet&gt; [&lt;[,:]&gt; &lt;paramlet&gt; ]* ]?
    }</code></pre>
<pre><code>
    rule paramlet :w {
        [ &lt;type&gt; &lt;zone&gt;? &lt;varlet&gt;? &lt;trait&gt;*     # require type
        | &lt;zone&gt; &lt;varlet&gt;? &lt;trait&gt;*             # or zone
        | &lt;varlet&gt; &lt;trait&gt;*                     # or varlet
        | \[ &lt;siglet&gt; \]        # treat single array ref as an arg list
        ]
    }</code></pre>
<p>In place of a <code>&lt;variable&gt;</code>, there's a kind of stub we'll call a &quot;varlet&quot;:</p>
<pre><code>
    rule varlet :w {
        &lt;sigil&gt; [ \( &lt;siglet \) ]?
    }</code></pre>
<p>As with the <code>&lt;variable&gt;</code> rule, a <code>&lt;varlet&gt;</code>'s optional
siglet is allowed only on <code>&amp;</code> parameters.</p>
<p>Here's a fancy example with one signature and several siglets.</p>
<pre><code>
    sub (int *@) imap ((int *@) &amp;block(int $),
                        int *@vector is context(int) {...}</code></pre>
<p>You're not expected to understand all of that yet.  What you should
notice, however, is that a paramlet is allowed to be reduced to
a type (such as <code>int</code>), or a zone (such as <code>?</code>), or a varlet (such as <code>$</code>), or some sequence
of those (such as <code>int *@</code>).  But it's not allowed to be reduced to a null
string.  A signature of <code>()</code> indicates zero arguments, not one argument
that could be anything.  Use <code>($)</code> for that.  Nor can you specify four
arguments by saying <code>(,,,)</code>.  You have to put something there.</p>
<p>Perl 6 siglets can boil down to something very much like Perl 5's
&quot;prototype pills&quot;.  However, you can't leave out the comma between
parameters in Perl 6.  So you have to say <code>($,$)</code> rather than <code>($$)</code>,
when you want to indicate a list of two scalars.</p>
<p>If you use a <code>&lt;siglet&gt;</code> instead of a <code>&lt;signature&gt;</code>
in declaring a subroutine, it will be taken as a Perl 5 style
prototype, and all args still come in via <code>@_</code>.  This is a sop to
the Perl5-to-Perl6 translator, which may not be able to figure out
how to translate a prototype to a signature if you've done something
strange with <code>@_</code>.  You should not use this feature in new code.
If you use a siglet on a stub declaration, you must use the same siglet
on the corresponding definition as well, and vice versa.  You can't
mix siglets and signatures that way.  (This is not a special rule,
but a natural consequence of the signature matching rules.)</p>


<h4><a name="siglets_and_multimethods">Siglets and multimethods</a></h4>
<p>For closure parameters like <code>&amp;block(int $)</code>, the associated siglet
is considered part of its name.  This is true not just for parameters,
but anywhere you use the <code>&amp;</code> form in your program, because with
multimethods there may be several routines sharing the same identifier,
distinguishable only by their type signature:</p>
<pre><code>
    multi factorial(int $a) { $a&lt;=1 ?? 1 :: $a*factorial($a-1) }
    multi factorial(num $a) { gamma(1+$a) }</code></pre>
<pre><code>
    $ref = &amp;factorial;          # illegal--too ambiguous
    $ref = &amp;factorial($);       # illegal--too ambiguous
    $ref = &amp;factorial(int);     # good, means first one.
    $ref = &amp;factorial(num);     # good, means second one.
    $ref = &amp;factorial(complex); # bad, no such multimethod.</code></pre>
<p>Note that when following a name like &quot;<code>&amp;factorial</code>&quot;, parentheses do not
automatically mean to make a call to the subroutine.  (This Apocalypse
contradicts earlier Apocalypses.  Guess which one is right...)</p>
<pre><code>
    $val = &amp;factorial($x);      # illegal, must use either
    $val = factorial($x);       #   this or
    $val = &amp;factorial.($x);     #   maybe this.</code></pre>
<p>In general, don't use the <code>&amp;</code> form when you really want to call
something.</p>


<h3><a name="formal_parameter_traits">Formal parameter traits</a></h3>
<p>Other than type, zone, and variable name, all other information about
parameters is specified by the standard trait syntax, generally
introduced by <code>is</code>.  Internally even the type and zone are just
traits, but syntactically they're out in front for psychological
reasons.  <em>Whose</em> psychological reasons we won't discuss.</p>


<h4><a name="is_constant_(default)"><code>is constant</code> (default)</a></h4>
<p>Every formal parameter is constant by default, meaning primarily that
the compiler won't feel obligated to construct an lvalue out the actual
argument unless you specifically tell it to.  It also means that you
may not modify the parameter variable in any way.  If the parameter is
a reference, you may use it to modify the referenced object (if the
object lets you), but you can't assign to it and change the original
variable passed to the routine.</p>


<h4><a name="is_rw"><code>is rw</code></a></h4>
<p>The <code>rw</code> trait is how you tell the compiler to ask for an lvalue
when evaluating the actual argument for this parameter.  Do not
confuse this with the <code>rw</code> trait on the subroutine as a whole, which
says that the entire subroutine knows how to function as an lvalue.
If you set this trait, then you may modify the variable that was
passed as the actual argument.  A <code>swap</code> routine would be:</p>
<pre><code>
    sub swap ($a is rw, $b is rw) { ($a,$b) = ($b,$a) }</code></pre>
<p>If applied to a slurpy parameter, the <code>rw</code> trait distributes to each
element of the list that is bound to the parameter.  In the case of
a slurpy hash, this implies that the named pairs are in an lvalue
context, which actually puts the right side of each named pair into
lvalue context.</p>
<p>Since normal lvalues assume &quot;<code>is rw</code>&quot;, I suppose that also implies
that you can assign to a pair:</p>
<pre><code>
    (key =&gt; $var) = &quot;value&quot;;</code></pre>
<p>or even do named parameter binding:</p>
<pre><code>
    (who =&gt; $name, why =&gt; $reason) := (why =&gt; $because, who =&gt; &quot;me&quot;);</code></pre>
<p>which is the same as:</p>
<pre><code>
    $name   := &quot;me&quot;;
    $reason := $because;</code></pre>
<p>And since a slurpy hash soaks up the rest of the named parameters,
this also seems to imply that binding a slurpy <code>rw</code> hash actually
makes the hash values into <code>rw</code> aliases:</p>
<pre><code>
    $a = &quot;a&quot;; $b = &quot;b&quot;;
    *%hash := (a =&gt; $a, b =&gt; $b);
    %hash{a} = 'x';
    print $a;   # prints &quot;x&quot;</code></pre>
<p>That's kinda scary powerful.  I'm not sure I want to document that...
[&quot;Too late!&quot; whispers Evil Damian.]</p>


<h4><a name="is_copy"><code>is copy</code></a></h4>
<p>This trait requests copy-in semantics.  The variable is modifiable
by you, but you're only modifying your own private copy.  It has the
same effects as assigning the argument to your own <code>my</code> variable.
It does <em>not</em> do copy-out.</p>
<p>If you want both copy-in and copy-out semantics, declare it <code>rw</code>
and do your own copying back and forth, preferably with something
that works even if you exit by exception (if that's what you want):</p>
<pre><code>
    sub cico ($x is rw) {
        my $copy = $x;
        LAST { $x = $copy }
        ...
    }</code></pre>
<p>Though if you're using a copy you probably only want to copy-out on
success, so you'd use a <code>KEEP</code> block instead.  Or more succinctly,
using the new <code>will</code> syntax:</p>
<pre><code>
    sub cicomaybe ($x is rw) {
        my $copy will keep { $x = $copy } = $x;
        ...
    }</code></pre>


<h4><a name="is_ref"><code>is ref</code></a></h4>
<p>This trait explicitly requests call-by-reference semantics.  It lets
you read and write an existing argument but doesn't attempt to coerce
that argument to an lvalue (or autovivify it) on the caller end,
as <code>rw</code> would.  This trait is distinguished from a parameter of type
<code>Ref</code>, which merely asserts that the return type of the parameter is a
reference without necessarily saying anything about calling convention.
You can without contradiction say:</p>
<pre><code>
    sub copyref (Ref $ref is copy) {...}</code></pre>
<p>meaning you can modify <code>$ref</code>, but that doesn't change whatever was
passed as the argument for that parameter.</p>














<p><em>Editor's Note: this Apocalypse is out of date and remains here for historic reasons.  See <a href="http://dev.perl.org/perl6/doc/design/syn/S06.html">Synopsis 06</a> for the latest information.</em></p>

<h4><a name="defaults">Defaults</a></h4>
<p>Default values are also traits, but are written as assignments and
must come at the end of the formal parameter for psychological reasons.</p>
<pre><code>
    rule defval :w { \= &lt;item&gt; }</code></pre>
<p>That is:</p>
<pre><code>
    sub trim ( Str $_ is rw, Rule ?$remove = /\s+/ ) {
            s:each/^ &lt;$remove&gt; | &lt;$remove&gt; $//;
    }</code></pre>
<p>lets you call <code>trim</code> as either:</p>
<pre><code>
    trim($input);</code></pre>
<p>or:</p>
<pre><code>
    trim($input, /\n+/);</code></pre>
<p>It's very important to understand that the expression denoted by
<code>item</code> is evaluated in the lexical scope of the subroutine definition,
not of the caller.  If you want to get at the lexical scope of the
caller, you have to do it explicitly (see <code>CALLER::</code> below).  Note
also that an <code>item</code> may not contain unbracketed commas, or the parser
wouldn't be able to reliably locate the next parameter declaration.</p>
<p>Although the default looks like an assignment, it isn't one.  Nor is
it exactly equivalent to <code>//=</code>, because the default is set only
if the parameter doesn't exist, not if it exists but is undefined.
That is, it's used only if no argument is bound to the parameter.</p>
<p>An <code>rw</code> parameter may only default to a valid lvalue.  If you find
yourself wanting it to default to an ordinary value because it's
undefined, perhaps you really want <code>//=</code> instead:</p>
<pre><code>
    sub multprob ($x is rw, $y) {
        $x //= 1.0;     # assume undef means &quot;is certain&quot;
        $x *= $y;
    }</code></pre>
<p>Syntactically, you can put a default on a required parameter, but it
would never be used because the argument always exists.  So semantic
analysis will complain about it.  (And I'd rather not say that adding
a default implies it's optional without the <code>?</code> zone marker.)</p>


<h3><a name="formal_parameter_types">Formal parameter types</a></h3>
<p>Formal parameters may have any type that any other variable may
have, though particular parameters may have particular
restrictions.  An invocant needs to be an object of an appropriate
class or subclass, for instance.  As with ordinary variable
declarations the type in front is actually the return type, and you
can put it afterwards if you like:</p>
<pre><code>
    sub foo (int @array is rw) {...}
    sub foo (@array of int is rw) {...}
    sub foo (@array is Array of int is rw) {...}</code></pre>
<p>The type of the actual argument passed must be compatible with
(but not necessarily identical to) the formal type.  In particular,
for methods the formal type will often indicate a base class of the
actual's derived class.  People coming from C++ must remember that all
methods are &quot;virtual&quot; in Perl.</p>
<p>Closure parameters are typically declared with <code>&amp;</code>:</p>
<pre><code>
    sub mygrep (&amp;block, *@list is rw) {...}</code></pre>
<p>Within that subroutine, you can then call <code>block()</code> as an ordinary
subroutine with a lexically scoped name.  If such a parameter is
declared without its own parameter signature, the code makes no
assumptions about the actual signature of the closure supplied as
the actual argument.  (You can always inspect the actual signature
at run time, of course.)</p>
<p>You may, however, supply a signature if you like:</p>
<pre><code>
    sub mygrep (&amp;block($foo), *@list is rw) {
        block(foo =&gt; $bar);
    }</code></pre>
<p>With an explicit signature, it would be error to bind a block to
<code>&amp;block</code> that is not compatible.  We're leaving &quot;compatible&quot; undefined
for the moment, other than to point out that the signature doesn't have
to be identical to be compatible.  If the actual subroutine accepted
one required parameter and one optional, it would work perfectly fine,
for instance.  The signature in <code>mygrep</code> is merely specifying what
it requires of the subroutine, namely one positional argument named
&quot;<code>$foo</code>&quot;.  (Conceivably it could even be named something different
in the actual routine, provided the compiler turns that call into a
positional one because it thinks it already knows the signature.)</p>


<h2><a name="calling_subroutines">Calling subroutines</a></h2>
<p>The typical subroutine or method is called a lot more often than
it is declared.  So while the declaration syntax is rather ornate,
we strive for a call syntax that is rather simple.  Typically it
just looks like a comma-separated list.  Parentheses are optional on
predeclared subroutine calls, but mandatory otherwise.  Parentheses
are mandatory on method calls with arguments, but may be omitted
for argumentless calls to methods such as attribute accessors.
Parentheses are optional on multimethod and macro calls because they
always parse like list operators.  A rule may be called like a method
but is normally invoked within a regex via the <code>&lt;rule&gt;</code> syntax.</p>
<p>As in Perl 5, within the list there may be an implicit transition
from scalar to list context.  For example, the declaration of the
standard <code>push</code> built-in in Perl 6 probably looks like this:</p>
<pre><code>
    multi *push (@array, *@list) {...}</code></pre>
<p>but you still generally call it as you would in Perl 5:</p>
<pre><code>
    push(@foo, 1, 2, 3);</code></pre>
<p>This call has two of the three kinds of call arguments.  It has one
positional argument, followed by a variadic list.  We could imagine
adding options to <code>push</code> sometime in the future.  We <em>could</em> define
it like this:</p>
<pre><code>
    multi *push (@array, ?$how, *@list) {...}</code></pre>
<p>That's just an optional positional parameter, so you'd call it
like this:</p>
<pre><code>
    push(@foo, &quot;rapidly&quot;, 1,2,3)</code></pre>
<p>But that won't do, actually, since we used to allow the list to
start at the end of the positional parameters, and any pre-existing
<code>push(@foo,1,2,3)</code> call to the new declaration would end up mapping
the &quot;<code>1</code>&quot; onto the new optional parameter.  Oops...</p>
<p>If instead we force new parameters to be in named notation, like this:</p>
<pre><code>
    multi *push (@array, *@list, +$how) {...}</code></pre>
<p>t�en we can say:</p>
<pre><code>
    push(@foo, how =&gt; &quot;rapidly&quot;, 1,2,3)</code></pre~
<p>and it's no longer ambiguous.  Since <code>dhow</code> is i� the named-only zone,
it can never be set positionally, and the old calls to:</p>
<pre><code>
    push(@foo, 1,2,3);</code></pre>
<p>still work fine, because <code>*@list</code> is still at the end of the
positional parameter zone.  If we instead declare that:</p>
<pre><code>
    multi *push (@array, +$how, *@list) {...}</code></pre>
<p>we could still say:</p>
<pre><code>
    push(@foo, how =&gt; &quot;rapidly&quot;, 1,2,3)</code></pre>
<p>but this becomes illegal:</p>
<pre><code>
    push(@foo, 1,2,3);</code></pre>
<p>because the slurpy array is in the named-only zone.  We'll need an
explicit way to indicate the start of the list in this case.  I can
think of lots of (mostly bad) ways.  You probably can too.  We'll
come back to this...</p>


<h3><a name="actual_arguments">Actual arguments</a></h3>
<p>So the actual arguments to a Perl function are of three kinds:
positional, named, and list.  Any or all of these parts may be omitted,
but whenever they are there, they <em>must</em> occur in that order.  It's
more efficient for the compiler (and less confusing to the programmer)
if all the positional arguments come before all the non-positional
arguments in the list.  Likewise, the named arguments are constrained
to occur before the list arguments for efficiency--otherwise the
implementation would have to scan the entire list for named arguments,
and some lists are monstrous huge.</p>
<p>We'd call these three parts &quot;zones&quot; as well, but then people
would get them confused with our six declarative zones.  In fact,
extending the zoning metaphor a bit, our three parts are more like
houses, stores, and factories (real ones, not OO ones, sheesh).
These are the kinds of things you actually <em>find</em> in residential,
commercial, and industrial zones.  Similarly, you can think of the
three different kinds of argument as the things you're allowed to
<em>bind</em> in the different parameter zones.</p>
<p>A house is generally a scalar item that is known for its position;
after all, &quot;there's no <em>place</em> like home&quot;.  Um, yeah.  Anyway,
we usually number our houses.  In the US, we don't usually name our
houses, though in the UK they don't seem to mind it.</p>
<p>A store may have a position (a street number), but usually we refer
to stores by name.  &quot;I'm going out to Fry's&quot; does not refer to a
particular location, at least not here in Silicon Valley.  &quot;I'm going
out to McDonald's&quot; doesn't mean a particular location anywhere in
the world, with the possible exception of &quot;not Antarctica&quot;.</p>
<p>You don't really care exactly where a factory is--as long as it's not
in your back yard--you care what it produces.  The typical factory is
for mass producing a series of similar things.  In programming terms,
that's like a generator, or a pipe...or a list.  And you mostly worry
about how you get vast quantities of stuff into and out of the factory
without keeping the neighbors awake at night.</p>
<p>So our three kinds of arguments map onto the various parameter zones
in a similar fashion.</p>


<h4><a name="the_positional_arguments">The positional arguments</a></h4>
<p>Obviously, actual positional arguments are mapped onto the formal
parameters in the order in which the formal positional parameters
are declared.  Invocant parameters (if any) must match invocant
arguments, the required parameters match positional arguments, and
then any additional non-named arguments are mapped onto the optional
positional parameters.  However, as soon as the first named argument is
seen (that cannot be mapped to an explicitly typed <code>Pair</code> or <code>Hash</code>
parameter) this mapping stops, and any subsequent positional parameters
may only be bound by name.</p>


<h4><a name="the_named_arguments">The named arguments</a></h4>
<p>After the positional argument part, you may pass as many named pairs
as you like.  These may bind to any formal parameter named in the
declaration, whether declared as positional or named.  However, it
is erroneous to simultaneously bind a parameter both by position and
by name.  Perl may (but is not required to) give you a warning or error
about this.  If the problem is ignored, the positional parameter takes
precedence, since the name collision might have come in by accident as
a result of passing extra arguments intended for a different routine.
Problems like this can arise when passing optional arguments to all
the base classes of the current class, for instance.  It's not yet
clear how fail-soft we should be here.</p>
<p>Named arguments can come in either as <code>Pair</code> or <code>Hash</code> references.
When parameter mapper sees an argument that is neither a <code>Pair</code> nor a
<code>Hash</code>, it assumes it's the end of the named part and the beginning of
the list part.</p>
<p>All unbound named arguments are bound to elements of the slurpy hash,
if one was declared.  If no slurpy hash is declared, an exception is
thrown (although some standard methods, like <code>BUILD</code>, will provide
an implicitly declared slurpy hash--known as <code>%_</code> by analogy
to <code>@_</code>--to handle surplus named arguments).</p>
<p>At the end of named argument processing, any unmapped optional
parameter ends up with the value <code>undef</code> unless a default value is
declared for it.  Any unmapped required parameter throws an exception.</p>


<h4><a name="the_slurpy_array2">The slurpy array</a></h4>
<p>All remaining arguments are bound to the slurpy array, if any.  If no
slurpy array is specified, any remaining arguments cause an exception
to be thrown.  (You only get an implicit <code>*@_</code> slurpy array when the
signature is omitted entirely. Otherwise we could never validly give
the error &quot;Too many arguments&quot;.)</p>
<p>No argument processing is done on this list.  If you go back to using
named pairs at the end of the list, for instance, you'll have to pop
those off yourself.  But since the list is potentially very long, Perl
isn't going to look for those on your behalf.</p>
<p>Indeed, the list could be infinitely long, and maybe even a little
longer than that.  Perl 5 always flattens lists before calling the
subroutine.  In Perl 6, list flattening is done lazily, so a list
could contain several infinite entries:</p>
<pre><code>
    print(1..Inf, 1..Inf);</code></pre>
<p>That might eventually give the <code>print</code> function heartburn, of course...</p>














<p><em>Editor's Note: this Apocalypse is out of date and remains here for historic reasons.  See <a href="http://dev.perl.org/perl6/doc/design/syn/S06.html">Synopsis 06</a> for the latest information.</em></p>

<h3><a name="variadic_transitions">Variadic transitions</a></h3>
<p>There are, then, two basic transitions in argument processing.  First
is the transition from positional to named arguments.  The second is
from named arguments to the variadic list.  It's also possible to
transition directly from positional arguments to the variadic list
if optional positional arguments have been completely specified.
That is, the slurp array could just be considered the next optional
positional parameter in that case, as it is in <code>push</code>.</p>
<p>But what if you don't want to fill out all the optional parameters, and
you aren't planning to use named notation to skip the rest of them?
How can you make both transitions simultaneously?  There are two
workarounds.  First, suppose we have a <code>push</code>-like signature such
as this:</p>
<pre><code>
    sub stuff (@array, ?$how, *@list) {...}</code></pre>
<p>The declarative workaround is to move the optional parameters after
the slurp array, so that they are required to be specified as named
parameters:</p>
<pre><code>
    sub stuff (@array, *@list, +$how) {...}</code></pre>
<p>Then you can treat the slurp array as a positional parameter.
That's the solution we used to add an extra argument to <code>push</code>
earlier, where the list always starts at the second argument.</p>
<p>On the calling end, you don't have any control of the declaration,
but you can always specify one of the arguments as named, either the
final positional one, or the list itself:</p>
<pre><code>
    stuff(@foo, how =&gt; undef, 1,2,3)
    stuff(@foo, list =&gt; (1,2,3))</code></pre>
<p>The latter is clearer and arguably more correct, but it has a couple
of minor problems.  For one thing, you have to know what the parameter
name is.  It's all very well if you have to know the names of optional
parameters, but <em>every</em> list operator has a list that you really
ought to be able to feed without knowing its name.</p>
<p>So we'll just say that the actual name of the slurpy list parameter is
&quot;<code>*@</code>&quot;.  You can always say this:</p>
<pre><code>
    stuff(@foo, '*@' =&gt; (1,2,3))</code></pre>
<p>That's still a lot of extra unnecessary cruft--but we can do better.
List operators are like commands in Unix, where there's a command line
containing a program name and some options, and streams of data coming
in and going out via pipes.  The command in this case is <code>stuff</code>,
and the option is <code>@foo</code>, which says what it is we're stuffing.
But what about the streams of stuff going in and out?  Perl 6 has
lazy lists, so they are in fact more like streams than they used to be.</p>
<p>There will be two new operators, called pipe operators, that allow us
to hook list generators together with list consumers in either order.
So either of these works:</p>
<pre><code>
    stuff @foo &lt;== 1,2,3
    1,2,3 ==&gt; stuff @foo</code></pre>
<p>The (ir)rationale for this is provided in Appendix A.</p>
<p>To be sure, these newfangled pipe operators do still pass the
list as a &quot;<code>*@</code>&quot;-named argument, because that allows indirection in the
entire argument list.  Instead of:</p>
<pre><code>
    1,2,3 ==&gt; stuff @foo</code></pre>
<p>you can pull everything out in front, including the positional and
named parameters, and build a list that gets passed as &quot;splat&quot;
arguments (described in the next section) to <code>stuff</code>:</p>
<pre><code>
    list(@foo, how =&gt; 'scrambled' &lt;== 1,2,3)
        ==&gt; stuff *;</code></pre>
<p>In other words:</p>
<pre><code>
    list(@foo, how =&gt; 'scrambled' &lt;== 1,2,3) ==&gt; stuff *;</code></pre>
<p>is equivalent to:</p>
<pre><code>
    list(@foo, how =&gt; 'scrambled' &lt;== 1,2,3) ==&gt; stuff *();</code></pre>
<p>which is equivalent to:</p>
<pre><code>
    stuff *(list(@foo, how =&gt; 'scrambled' &lt;== 1,2,3));</code></pre>
<p>The &quot;splat&quot; and the <code>list</code> counteract each other, producing:</p>
<pre><code>
    stuff(@foo, how =&gt; 'scrambled' &lt;== 1,2,3);</code></pre>
<p>So what <code>stuff</code> actually sees is exactly as if you called it like this:</p>
<pre><code>
    stuff(@foo, how =&gt; 'scrambled', '*@' =&gt; (1,2,3));</code></pre>
<p>which is equivalent to:</p>
<pre><code>
    stuff @foo, how =&gt; 'scrambled', 1, 2, 3;</code></pre>
<p>And yes, the <code>==&gt;</code> and <code>&lt;==</code> operators are big, fat, and
obnoxiously noticeable.  I like them that way.  I think the pipes
are important and <em>should</em> stand out.  In postmodern architecture
the ducts are just part of the deconstructed decor.  (Just don't
anyone suggest a <code>==&gt;=</code> operator.  Just...don't.)</p>
<p>The <code>==&gt;</code> and <code>&lt;==</code> operators have the additional side
effect of forcing their blunt end into list context and their pointy
end into scalar context.  (More precisely, it's not the expression
on the pointy end that is in scalar context, but rather the positional
arguments of whatever list function is pointed to by the pointy end.)
See Appendix A for details.</p>


<h3><a name="context">Context</a></h3>
<p>As with Perl 5, the scalar arguments are evaluated in scalar context,
while the list arguments are evaluated in list context.  However,
there are a few wrinkles.</p>


<h4><a name="overriding_signature_with_*">Overriding signature with <code>*</code></a></h4>
<p>Perl 5 has a syntax for calling a function without paying any attention
to its prototype, but in Perl 6 that syntax has been stolen for a
higher purpose (referential purity).  Also, sometimes you'd like to be
able to ignore part of a signature rather than the whole signature.
So Perl 6 has a different notation, unary <code>*</code>, for disabling
signature checking, which we've mentioned in earlier Apocalypses,
and which you've already seen in the form of the <code>stuff *</code> above.
(Our splat in the <code>stuff *</code> above is in fact unary, but the optional
argument is missing, because the list is supplied via pipe.)</p>
<p>The first splatted term in an argument list causes all prior terms
to be evaluated in scalar context, and all subsequent terms to be
evaluated in list context.  (Splat is a no-op in list context, so it
doesn't matter if there are more splatted terms.)  If the function
wants more positional arguments, they are assumed to come from the
generated list, as if the list had been specified literally in the
program at that point as comma-separated values.</p>
<p>With splat lists, some of the argument processing may have to be
deferred from compile time to runtime, so in general such a call may
run slower than the ordinary form.</p>


<h4><a name="context_unknown_at_compile_time">Context unknown at compile time</a></h4>
<p>If Perl can't figure out the signature of a function at compile time
(because, for instance, it's a method and not a function), then it
may not be known which arguments are in scalar or list context at
the time they are evaluated.  This doesn't matter for Perl variables,
because in Perl 6, they always return a reference in either scalar or
list context.  But if you call a function in such an indeterminate
context, and the function doesn't have a return value declared that
clarifies whether the function behaves differently in scalar or list
context, then one of two things must happen.  The function must either
run in an indeterminate context, or the actual call to the function
must be delayed until the context is known.  It is not yet clear
which of these approaches is the lesser evil.  It may well depend on
whether the function pays more attention to its dynamic context or
to global values.  A function with no side effects and no global or
dynamic dependencies can be called whenever we like, but we're not
here to enforce the functional paradigm.  Interesting functions may
pay attention to their context, and they may have side effects such
as reading from an input stream in a particular order.</p>
<p>A variant of running in indeterminate context is to simply assume the
function is running in list context.  (That is, after all, what Perl
5 does on methods and on not-yet-declared subroutines.)  In Perl 6,
we may see most such ambiguities resolved by explicit use of the <code>&lt;==</code>
operator to force preceding args into scalar context, and the
following args into list context.  Individual arguments may also be
forced into scalar or list context, of course.</p>
<p>By the way, if you mix unary splat with <code>&lt;==</code>, only the args
to the left of the splat are forced into scalar context.  (It can do
this because <code>&lt;==</code> governs everything back to the list operator,
since it has a precedence slightly looser than comma.)  So, given
something like:</p>
<pre><code>
    @moreargs = (1,2,3);
    mumble $a, @b, c(), *@moreargs &lt;== @list;</code></pre>
<p>we can tell just by looking that <code>$a</code>, <code>@b</code>, and <code>c()</code> are all
evaluated in scalar context, while <code>@moreargs</code> and <code>@list</code> are both
in list context.  It is parsed like this:</p>
<pre><code>
    mumble( ($a, @b, c(), (*@moreargs)) &lt;== (@list) );</code></pre>
<p>You might also write that like this:</p>
<pre><code>
    @moreargs = list(1,2,3 &lt;== @list);
    mumble $a, @b, c(), *@moreargs;</code></pre>
<p>In this case, we can still assume that <code>$a</code>, <code>@b</code>, <code>c()</code> are in
scalar context, because as we mentioned in the previous section,
the <code>*</code> forces it.  (That's because there's no reason to put the
splat if you're already in list context.)</p>
<p>Before we continue, you probably need a break.  Here, have a break:</p>
<pre><code>
    *******************************************************
    ******************** Intermission *********************
    *******************************************************</code></pre>


<h2><a name="variations_on_a_theme">Variations on a theme</a></h2>
<p>Welcome back.</p>
<p>We've covered the basics up till now, but there are a number of
miscellaneous variations we left out in the interests of exposition.
We'll now go back to visit some of those issues.</p>


<h3><a name="typed_slurps">Typed slurps</a></h3>
<p>Sometimes you want to specify that the variadic list has a particular
recurring type, or types.  This falls out naturally from the slurp
array syntax:</p>
<pre><code>
    sub list_of_ints ($a, $b, Int *@ints) { ... }
    sub list_of_scalars (Scalar *@scalars) { ... }</code></pre>
<p>These still evaluate the list in list context.  But if you declare
them as:</p>
<pre><code>
    sub intlist ($a, $b, Int *@ints is context(Int)) { ... }
    sub scalarlist (Scalar *@scalars is context(Scalar)) { ... }</code></pre>
<p>then these provide a list of <code>Int</code> or <code>Scalar</code> contexts to the
caller.  If you call:</p>
<pre><code>
    scalarlist(@foo, %bar, baz())</code></pre>
<p>you get two scalar references and the scalar result of <code>baz()</code>, not a
flattened list.  You can have lists without list context in Perl 6!</p>
<p>If you want to have alternating types in your list, you can.
Just specify a tuple type on your context:</p>
<pre><code>
    strintlist( *@strints is context(Str,Int)) { ... }</code></pre>
<p>Perl 5's list context did not do lazy evaluation, but always flattened
immediately.  In Perl 6 the default list context &quot;<code>is context(Lazy)</code>&quot;.
But you can specify &quot;<code>is context(Eager)</code>&quot; to get back to Perl 5
semantics of immediate flattening.</p>
<p>As a sop to the Perl5-to-Perl6 translator (and to people who have to
read translated programs), the <code>Eager</code> context can also be specified
by doubling the slurpy <code>*</code> on the list to make it look like a pair of
rollers that will squish anything flat:</p>
<pre><code>
    sub p5func ($arg, **@list) { ... }</code></pre>
<p>The &quot;eager splat&quot; is also available as a unary operator to
attempt eager flattening on the rvalue side:</p>
<pre><code>
    @foo = **1..Inf;  # Test our &quot;out of memory&quot; handler...</code></pre>














<p><em>Editor's Note: this Apocalypse is out of date and remains here for historic reasons.  See <a href="http://dev.perl.org/perl6/doc/design/syn/S06.html">Synopsis 06</a> for the latest information.</em></p>

<h3><a name="sublist_formals">Sublist formals</a></h3>
<p>It's often the case that you'd like to treat a single array argument
as if it were an argument list of its own.  Well, you can.  Just put
a sublist signature in square brackets.  This is particularly good
for declaring multimethods in a functional programming mindset:</p>
<pre><code>
    multi apply (&amp;func, []) { }
    multi apply (&amp;func, [$head, *@tail]) {
        return func($head), apply(&amp;func, @tail);
    }</code></pre>
<pre><code>
    @squares := apply { $_ * $_ } [1...];</code></pre>
<p>Of course, in this case, the first multimethod is never called because
the infinite list is never null no matter how many elements we pull
off the front.  But that merely means that <code>@squares</code> is bound to
an infinite list generator.  No big deal, as long as you don't try to
flatten the list...</p>
<p>Note that, unlike the example in the previous section which alternated
strings and integers, this:</p>
<pre><code>
    strintlist( [Str, Int] *@strints ) { ... }</code></pre>
<p>implies single array references coming in, each containing a string
and an integer.</p>
<p>Of course, this may be a bad example insofar as we could just write:</p>
<pre><code>
    multi apply (&amp;func) { }
    multi apply (&amp;func, $head, *@tail) {
        return func($head), apply(&amp;func, *@tail);
    }</code></pre>
<pre><code>
    @squares := apply { $_ * $_ } *1...;</code></pre>
<p>It'd be nice to lose the <code>*</code> though on the calls.  Maybe what we
really want is a slurpy scalar in front of the slurpy array, where
presumably the <code>&lt;==</code> maps to the first slurpy scalar or hash
(or it could be passed positionally):</p>
<pre><code>
    multi apply (&amp;func) { }
    multi apply (&amp;func, *$head, *@tail) {
        return func($head), apply(&amp;func &lt;== @tail);
    }</code></pre>
<pre><code>
    @squares := apply { $_ * $_ } 1...;</code></pre>
<p>Yow, I think I could like that if I tried.</p>
<p>So let's say for now that a slurpy scalar parameter just pulls the
first (or next) value off of the the slurpy list.  The <code>[]</code> notation
is still useful though for when you really do have a single array
ref coming in as a parameter.</p>


<h3><a name="attributive_parameters">Attributive parameters</a></h3>
<p>It is typical in many languages to see object initializers that look
like this (give or take a keyword):</p>
<pre><code>
    function init (a_arg, b_arg, c_arg) {
        a = a_arg;
        b = b_arg;
        c = c_arg;
    }</code></pre>
<p>Other languages <em>try</em> to improve the situation without actually
succeeding.  In a language resembling C++, it might look more like
this:</p>
<pre><code>
    method init (int a_arg, int b_arg, int c_arg)
        : a(a_arg), b(b_arg), c(c_arg) {}</code></pre>
<p>But there's still an awful lot of redundancy there, not to mention
inconsistent special syntax.</p>
<p>Since (as proven by Perl 5) signatures are all about syntactic sugar
anyway, and since Perl 6 intentionally makes attribute variables
visually distinct from ordinary variables, we can simply write this
in Perl 6 as:</p>
<pre><code>
    submethod BUILD ($.a, $.b, $.c) {}</code></pre>
<p>Any parameter that appears to be an attribute is immediately
copied directly into the corresponding object attribute, and no
lexical parameter is generated.  You can mix these with ordinary
parameters--the general rule of thumb for an initializer is that you
should see each dotted attribute at least once:</p>
<pre><code>
    submethod BUILD ($.a, $.b, $c) {
        $.c = mung($c);
    }</code></pre>
<p>This feature is primarily intended for use in constructors and
initializers, but Perl does not try to guess which subroutines fall
into that category (other than the fact that Perl 6 will implicitly
call certain conventional names like CREATE and BUILD.)</p>
<p>However, submethods such as BUILD are assumed to have an extra
<code>*%_</code> parameter to soak up any extra unrecognized named arguments.
Ordinarily you must declare a slurp-hash explicitly to get
that behavior.  But BUILD submethods are always called with named
arguments (except for the invocant), and often have to ignore arguments
intended for other classes participating in the current construction.
It's likely that this implicit <code>*%_</code> feature extends to other routines
declared in all-caps as well, and perhaps all submethods.</p>
<p>As in Perl 5, subroutines declared in all-caps are expected to be
called automatically most of the time--but not necessarily all the
time.  The BUILD routine is a good example, because it's only called
automatically when you rely on the default class initialization rules.
But you can override those rules, in which case you may have to call
BUILD yourself.  More on that in Apocalypse 12.  Or go to one of
Damian's Perl 6 talks...</p>


<h3><a name="other_kinds_of_subroutines">Other kinds of subroutines</a></h3>


<h4><a name="closures">Closures</a></h4>
<p>All blocks are considered closures in Perl 6, even the blocks
that declare modules or classes (presuming you use the block form).
A closure is just an anonymous subroutine that has access its lexical
context.  The fact that some closures are immediately associated
with names or have other kinds of parameter declarations does not
change the fact that an anonymous bare block without parameters is
also a kind of subroutine.  Of course, if the compiler can determine
that the block is only executed inline, it's free to optimize away
all the subroutine linkage--but not the lexical linkage.  It can only
optimize away the lexical linkage if no external lexicals are accessed
(or potentially accessed, in the case of <code>eval</code>).</p>


<h4><a name="pointy_subs">Pointy subs</a></h4>
<p>As introduced in Apocalypse 4, loops and topicalizers are often
written with a special form of closure declaration known these days
as &quot;pointy subs&quot;.  A pointy sub is exactly equivalent to a standard
anonymous sub declaration having the same parameters.  It's almost
pure syntactic sugar--except that we embrace syntactic sugar in Perl
when it serves a psychological purpose (not to be confused with a
logical psycho purpose, which we also have).</p>
<p>Anyway, when you say:</p>
<pre><code>
    -&gt; $a, $b, $c { ... }</code></pre>
<p>it's almost exactly the same as if you'd said:</p>
<pre><code>
    sub ($a, $b, $c) { ... }</code></pre>
<p>only without the parentheses, and with the cute arrow that indicates
the direction of data flow to that part of your brain that consumes
syntactic glucose at a prodigious rate.</p>
<p>Since the parentheses around the signature are missing, you can't
specify anything that would ordinarily go outside the parentheses,
such as the return type or other subroutine traits.  But you may
still put traits or zone markers on each individual formal parameter.</p>
<p>Also, as a &quot;sub-less&quot; declaration, you can't return from it using
<code>return</code>, because despite being a closure, it's supposed to <em>look</em>
like a bare <code>Block</code> embedded in a larger <code>Routine</code>, and users will
expect <code>return</code> to exit from the &quot;real&quot; subroutine.  All of which
just means that, if you need those fancy extras, use a real <code>sub</code>
sub, not a pointy one.</p>


<h4><a name="placeholders">Placeholders</a></h4>
<p>Also as discussed in Apocalypse 4, a bare block functioning as a
closure can have its parameters declared internally.  Such parameters
are of the form:</p>
<pre><code>
    rule placeholder { &lt;sigil&gt; \^ &lt;ident&gt; }</code></pre>
<p>Placeholder parameters are equivalent to required position parameters
declared in alphabetical order.  (Er, Unicodical order, really.)
For example, the closure:</p>
<pre><code>
    { $^fred &lt;=&gt; $^barney }</code></pre>
<p>has the same signature as the pointy sub:</p>
<pre><code>
    -&gt; $barney, $fred { $fred &lt;=&gt; $barney }</code></pre>
<p>or the standard anonymous sub:</p>
<pre><code>
    sub ($barney, $fred) { $fred &lt;=&gt; $barney }</code></pre>
<p>On first hearing about the alphabetical sorting policy, some otherwise
level-headed folks immediately panic, imagining all sorts of ways
to abuse the mechanism for the purposes of obfuscation.  And surely
there are many ways to abuse many of the features in Perl, more
so in Perl 6.  The point of this mechanism, however, is to make
it drop-dead easy to write small, self-contained closures with a
small number of parameters that you'd probably give single-character
alphabetical names to in any event.  If you want to get fancier than
that, you should probably be using a fancier kind of declaration.
I define &quot;small number&quot; as approximately <em>e</em> &#177; &#960;.  But as
is generally the case in Perl, you get to pick your own definition of
&quot;small number&quot;.  (Or at the very least, you get to pick whether to
work with a company that has already defined &quot;small number&quot; for you.)</p>
<p>As bare rvalue variables embedded in the code, you may not put any
traits or zone markers on the placeholders.  Again, the desire
to do so indicates you should be using a fancier form of declaration.</p>


<h4><a name="methods">Methods</a></h4>
<p>Perl 5 just used subroutines for methods.  This is okay as long as
you don't want to declare any utility subroutines in your class.
But as soon as you do, they're inherited in Perl 5, which is not what
you want.  In Perl 6, methods and subroutines still share the same
namespace, but a method must be declared using the <code>method</code> keyword.
This is good documentation in any event, and further allows us to
intuit an invocant where none is declared.  (And we know that none
is declared if there's no colon after the first argument, at least
in the case of an ordinary method.)</p>


<h4><a name="submethods">Submethods</a></h4>
<p>There are certain implementation methods that want to be inherited in
general so that you can specify a default implementation, but that
you want the class to be able to override without letting derived
classes inherit the overridden method from this class.  That is,
they are scoped like utility subroutines, but can be called as if
they are methods, without being visible outside the class.  We call
these hybrids &quot;submethods&quot;, and so there's a <code>submethod</code> keyword
to declare them.  Submethods are simultaneously subs and methods.
You can also think of them as something less than a method, as the
&quot;sub&quot; works in the word &quot;subhuman&quot;.  Or you can think of them as
underneath in the infrastructural sense, as in &quot;subterranean&quot;.</p>
<p>Routines that create, initialize, or destroy the current object tend
to fall into this category.  Hence, the <code>BUILD</code> routine we mentioned
earlier is ordinarily declared as a submethod, if you don't want to
inherit the standard <code>BUILD</code> method defined in the Object class.  But
if you override it, your children still inherit <code>BUILD</code> from Object.</p>
<p>Contrariwise, if you don't like <code>Object</code>'s default <code>BUILD</code> method,
you can define an entire new class of classes that all default to
your own <code>BUILD</code> method, as long as those classes derive from your
new base object with superior characteristics.  Each of those derived
classes could then define a submethod to override your method only
for that class, while classes derived from those classes could still
inherit your default.</p>
<p>And so on, ad OOium.</p>


<h4><a name="multimethods">Multimethods</a></h4>
<p>Some kinds of programming map easily onto the standard model in which
a method has a single invocant.  Other kinds of programming don't.
Perl 6 supplies support for the latter kind of programming, where
the relationships between classes are just as interesting as the
classes themselves.  In some languages, all methods are multimethods.
Perl 6 doesn't go quite that far--you must declare your multimethods
explicitly.  To do so, use the <code>multi</code> keyword in place of <code>method</code>,
and optionally place a colon after the list of invocants in the
declaration, unless you want them all to be invocants.  Then your
multimethod will be registered globally as a being of interest to
all the types of its invocants, and will participate in multimethod
dispatch.</p>
<p>It is beyond the scope of this Apocalypse to specify exactly how
multimethod dispatch works (see Apocalypse 12, someday), but we can
tell you that, in general, you call a multimethod as if it were an
ordinary subroutine, and the dispatcher figures out on your behalf how
many of the arguments are invocants.  This may sound fancy to you, but
many of the functions that are built into Perl 5 are <em>not</em> built into
Perl 6, at least, not as keywords.  Instead they are either defined as
global subroutines or as multimethods, single invocant multimethods
in many cases.  When you call a function like <code>close($handle)</code>,
it'll first look to see if there's a <code>close</code> subroutine defined in
your scope, and if not, it will dispatch it as a multimethod.  Likewise,
for something like <code>sysread</code>, you can call it either as a method:</p>
<pre><code>
    sysread $handle: $buffer, $length</code></pre>
<p>or as a function:</p>
<pre><code>
    sysread $handle, $buffer, $length</code></pre>
<p>In the first case, it's explicitly dispatching on the handle,
because a colon in place of the first comma indicates an invocant.
(That's our new indirect object syntax, in fact.  Perl 6 does not
support the Perl 5 syntax of just leaving whitespace between the
indirect object and the subsequent arguments.)</p>
<p>In the second case, it looks for a <code>sysread</code> subroutine, doesn't find
it (we hope), and calls multimethod dispatch on it.  And it happens
that the multimethod dispatch is smart enough to find the ordinary
single-invocant <code>sysread</code> method, even though it may not have been
explicitly declared a multimethod.  Multimethod dispatch happens to map
directly onto ordinary method dispatch when there's only one invocant.</p>
<p>At least, that's how it works this week...</p>














<p><em>Editor's Note: this Apocalypse is out of date and remains here for historic reasons.  See <a href="http://dev.perl.org/perl6/doc/design/syn/S06.html">Synopsis 06</a> for the latest information.</em></p>

<h4><a name="rules">Rules</a></h4>
<p>Rules were discussed in Apocalypse 5.  They are essentially methods
with an implicit invocant, consisting of the object containing the
current pattern matching context.  To match the internals of regex
syntax, traits attached to rules are typically written as &quot;<code>:w</code>&quot;
rather than &quot;<code>is w</code>&quot;, but they're essentially the same thing
underneath.</p>
<p>It's possible to call a rule as if it were a method, as long as
you give it the right arguments.  And a method defined in a grammar
can be called as if it were a rule.  They share the same namespace,
and a rule really is just a method with a funny syntax.</p>


<h4><a name="macros">Macros</a></h4>
<p>A macro is a function that is called immediately upon completion of
the parsing of its arguments.  Macros must be defined before they
are used--there are no forward declarations of macros, and while a
macro's name may be installed in either a package or a lexical scope,
its syntactic effect can only be lexical, from the point of declaration
(or importation) to the end of the current lexical scope.</p>
<p>Every macro is associated (implicitly or explicitly) with a particular
grammar rule that parses and reduces the arguments to the macro.
The formal parameters of a macro are special in that they must be
derived somehow from the results of that associated grammar rule.
We treat macros as if they were methods on the parse object returned
by the grammar rule, so the first argument is passed as if it were
an invocant, and it is always bound to the current parse tree object,
known as <code>$0</code> in Apocalypse 5.  (A macro is not a true method of that
class, however, because its name is in your scope, not the class's.)</p>
<p>Since the first parameter is treated as an invocant, you may either
declare it or leave it implicit in the actual declaration.  In either
case, the parse tree becomes the current topic for the macro.
Hence you may refer to it as either <code>$_</code> or <code>$0</code>, even if you don't
give it a name.</p>
<p>Subsequent parameters may be specified, in which case they bind to
internal values of <code>$0</code> in whatever way makes sense.  Positional
parameters bind to <code>$1</code>, <code>$2</code>, etc.  Named parameters bind to named
elements of <code>$0</code>.  A slurpy hash is really the same as <code>$0</code>, since
<code>$0</code> already behaves as a hash.  A slurpy array gets <code>$1</code>, <code>$2</code>,
etc., even if already bound to a positional parameter.</p>
<p>A macro can do anything it likes with the parse tree, but the return
value is treated specially by the parser.  You can return one of
several kinds of values:</p>
<ul>
<li>
A parse tree (the same one, a modified one, or a synthetic one) to be
passed up to the outer grammar rule that was doing pattern matching
when we hit the macro.
</li>


<li>
A closure functioning as a generic routine that is to be immediately
inlined, treating the closure as a template.  Within the template, any
variable referring back to one of the macro's parse parameters will
interpolate that parameter's value at that point in the template.
(It will be interpolated as a parse tree, a string, or a number
depending on the declaration of the parameter.)  Any variable not
referring back to a parameter is left alone, so that your template
can declare its own lexical variables, or refer to a package variable.
</li>


<li>
A string, to be shoved into the input stream and reparsed at the point
the macro was found, starting in exactly the same grammar state we
were before the macro.  This is slightly different from returning
the same string parsed into a parse tree, because a parse tree must
represent a complete construct at some level, while the string
could introduce a construct without terminating it.  This is the
most dangerous kind of return value, and the least likely to produce
coherent error messages with decent line numbers for the end user.
But it's also very powerful.  Hee, hee.
</li>


<li>
An <code>undef</code>, indicating that the macro is only used for its side
effects.  Such a macro would be one way of introducing an alternate
commenting mechanism, for instance.  I suppose returning &quot;&quot; has the
same effect, though.
</li>

</ul>
<p>A <code>macro</code> by default parses any subsequent text using whatever
<code>macro</code> rule is currently in effect.  Generally this will be the
standard <code>Perl::macro</code> rule, which parses subsequent arguments as a
list operator would--that is, as a comma-separated list with the same
policy on using or omitting parentheses as any other list operator.
This default may be overridden with the &quot;<code>is parsed</code>&quot; trait.</p>
<p>If there is no signature at all, <code>macro</code> defaults to using the null
rule, meaning it looks for no argument at all.  You can use it for
simple word substitutions where no argument processing is needed.
Instead of the long-winded:</p>
<pre><code>
    my macro this () is parsed(/&lt;null&gt;/) { &quot;self&quot; }</code></pre>
<p>you can just quietly turn your program into C++:</p>
<pre><code>
    my macro this { &quot;self&quot; }</code></pre>
<p>A lot of Perl is fun, and macros are fun, but in general, you should
never use a macro just for the fun of it.  It's far too easy to poke
someone's eye out with a macro.</p>


<h3><a name="outofband_parameters">Out-of-band parameters</a></h3>
<p>Certain kinds of routines want extra parameters in addition to
the ordinary parameter list.  Autoloading routines for instance
would like to know what function the caller was trying to call.
Routines sensitive to topicalizers may wish to know what the topic
is in their caller's lexical scope.</p>
<p>There are several possible approaches.  The Perl 5 autoloader actually
pokes a package variable into the package with the <code>AUTOLOAD</code>
subroutine.  It could be argued that something that's in your dynamic
scope should be accessed via dynamically scoped variables, and indeed
we may end up with a <code>$*AUTOLOAD</code> variable in Perl 6 that works
somewhat like Perl 5's, only better, because <code>AUTOLOAD</code> kinda sucks.
We'll address that in Apocalypse 10, for some definition of &quot;we&quot;.</p>
<p>Another approach is to give access to the caller's lexical scope in
some fashion.  The magical <code>caller()</code> function could return a handle
by which you can access the caller's <code>my</code> variables.  And in general,
there will be such a facility under the hood, because we have to be
able to construct the caller's lexical scope while it's being compiled.</p>
<p>In the particular case of grabbing the topic from the caller's lexical
scope (and it has to be in the caller's <em>lexical</em> scope because <code>$_</code>
is now lexically scoped in Perl 6), we think it'll happen often enough
that there should be a shorthand for it.  Or maybe it's more like a
&quot;midhand&quot;.  We don't want it too short, or people will unthinkingly
abuse it.  Something on the order of a <code>CALLER::</code> prefix, which
we'll discuss below.</p>


<h3><a name="lexical_context">Lexical context</a></h3>
<p>Works just like in Perl 5.  Why change something that works?</p>
<p>Well, okay, we are tweaking a few things related to lexical scopes.
<code>$_</code> (also known as the current topic) is always a lexically scoped
variable now.  In general, each subroutine will implicitly declare its
own <code>$_</code>.  Methods, submethods, macros, rules, and pointy subs all
bind their first argument to <code>$_</code>; ordinary subs declare a lexical
<code>$_</code> but leave it undefined.  Every sub definition declares its own
<code>$_</code> and hides any outer <code>$_</code>.  The only exception is bare closures
that are pretending to be ordinary blocks and don't commandeer <code>$_</code>
for a placeholder.  These continue to see the outer scope's <code>$_</code>,
just as they would any other lexically scoped variable declared in
the outer scope.</p>


<h3><a name="dynamic_context">Dynamic context</a></h3>
<p>On the flipside, <code>$_</code> is no longer visible in the dynamic context.
You can still temporize (localize) it, but you'll be temporizing
the current subroutine's lexical <code>$_</code>, not the global <code>$_</code>.
Routines which used to use dynamic scoping to view the <code>$_</code> of a calling
subroutine will need some tweaking.  See <code>CALLER::</code> below.</p>


<h4><a name="the_caller_function">The <code>caller</code> function</a></h4>
<p>As in Perl 5, the <code>caller</code> function will return information about
the dynamic context of the current subroutine.  Rather than always
returning a list, it will return an object that represents the selected
caller's context.  (In a list context, the object can still return the
old list as Perl 5-ers are used to.) Since contexts are polymorphic,
different context objects might in fact supply different methods.
The <code>caller</code> function doesn't have to know anything about that,
though.</p>
<p>What <code>caller</code> does know in Perl 6 is that it takes an optional
argument. That argument says where to stop when scanning up the call
stack, and so can be used to tell <code>caller</code> which kinds of context
you're interested in.  By default, it'll skip any &quot;wrapper&quot; functions
(see &quot;The <code>.wrap</code> method&quot; below) and return the outermost context
that thought it was calling your routine directly.  Here's a possible
declaration:</p>
<pre><code>
    multi *caller (?$where = &amp;CALLER::_, Int +$skip = 0, Str +$label)
        returns CallerContext {...}</code></pre>
<p>The <code>$where</code> argument can be anything that matches a particular
context, including a subroutine reference or any of these Code types:</p>
<pre><code>
    Code Routine Block Sub Method Submethod Multi Macro Bare Parametric</code></pre>
<p><code>&amp;_</code> produces a reference to your current <code>Routine</code>, though in the
signature above we have to use <code>&amp;CALLER::_</code> to get at the caller's
<code>&amp;_</code>.</p>
<p>Note that use of <code>caller</code> can prevent certain kinds of optimizations,
such as tail recursion elimination.</p>


<h4><a name="the_want_function">The <code>want</code> function</a></h4>
<p>The <code>want</code> function is really just the <code>caller</code> function in disguise.
It also takes an argument telling it which context to pay attention
to, which defaults to the one you think it should default to.  It's
declared like this:</p>
<pre><code>
    multi *want (?$where = &amp;CALLER::_, Int +$skip = 0, Str +$label)
        returns WantContext {...}</code></pre>
<p>Note that, as a variant of <code>caller</code>, use of <code>want</code> can prevent
certain kinds of optimizations.</p>
<p>When <code>want</code> is called in a scalar context:</p>
<pre><code>
        $primary_context = want;</code></pre>
<p>it returns a synthetic object whose type behaves as the junction of
all the valid contexts currently in effect, whose numeric overloading
returns the count of arguments expected, and whose string overloading
produces the primary context as one of 'Void', 'Scalar', or 'List'.
The boolean overloading produces true unless in a void context.</p>
<p>When <code>want</code> is called in a list context like this:</p>
<pre><code>
        ($primary, $count, @secondary) = want;</code></pre>
<p>it returns a list of at least two values, indicating the contexts
in which the current subroutine was called. The first two values
in the list are the primary context (i.e the scalar return value)
and the expectation count (see Expectation counts below). Any
extra contexts that <code>want</code> may detect (see Valid contexts below)
are appended to these two items.</p>
<p>When <code>want</code> is used as an object, it has methods corresponding to
its valid contexts:</p>
<pre><code>
        if want.rw { ... }
        unless want.count &lt; 2 { ... }
        when want.List { ... }</code></pre>
<p>The <code>want</code> function can be used with smart matching:</p>
<pre><code>
        if want ~~ List &amp; 2 &amp; Lvalue { ... }</code></pre>
<p>Which means it can also be used in a switch:</p>
<pre><code>
    given want {
        when List &amp; 2 &amp; Lvalue { ... }
        when .count &gt; 2 {...}
    }</code></pre>
<p>The numeric value of the <code>want</code> object is the &quot;expectation
count&quot;. This is an integer indicating the number of return values
expected by the subroutine's caller. For void contexts, the expectation
count is always zero; for scalar contexts, it is always zero or one;
for list contexts it may be any non-negative number.  The <code>want</code>
value can simply be used as a number:</p>
<pre><code>
    if want &gt;= 2 { return ($x, $y) }         # context wants &gt;= 2 values
    else         { return ($x); }            # context wants &lt; 2 values</code></pre>
<p>Note that <code>Inf &gt;= 2</code> is true.  (<code>Inf</code> is not the same as
<code>undef</code>.)  If the context is expecting an unspecified number of
return values (typically because the result is being assigned to
an array variable), the expectation count is <code>Inf</code>.  You shouldn't
actually return an infinite list, however, unless <code>want ~~ Lazy</code>.
The opposite of <code>Lazy</code> context is <code>Eager</code> context (the Perl 5 list
context, which always flattened immediately).  <code>Eager</code> and <code>Lazy</code>
are subclasses of <code>List</code>.</p>
<p>The valid contexts are pretty much as listed in RFC 21, though to the
extent that the various contexts can be considered types, they can
be specified without quotes in smart matches.  Also, types are not
all-caps any more.  We know we have a <code>Scalar</code> type--hopefully we also
get types or pseudo-types like <code>Void</code>, <code>List</code>, etc.  The <code>List</code>
type in particular is an internal type for the temporary lists that
are passed around in Perl.  Preflattened lists are <code>Eager</code>, while
those lists that are not preflattened are <code>Lazy</code>.  When you call
<code>@array.specs</code>, for instance, you actually get back an object of
type <code>Lazy</code>.  Lists (<code>Lazy</code> or otherwise) are internal
generator objects, and in general you shouldn't be doing operations
on them, but on the arrays to which they are bound.  The bound array manages its
hidden generators on your behalf to &quot;harden&quot; the abstract list into concrete
array values on demand.</p>


<h4><a name="the_caller::_pseudopackage">The <code>CALLER::</code> pseudopackage</a></h4>
<p>Just as the <code>SUPER::</code> pseudopackage lets you name a method somewhere
in your set of superclasses, the <code>CALLER::</code> pseudoclass lets you
name a variable that is in the lexical scope of your (dynamically
scoped) caller.  It may not be used to create a variable that does
not already exist in that lexical scope.  As such, it is is primarily
intended for a particular variable that <em>is</em> known to exist in every
caller's lexical scope, namely <code>$_</code>.  Your caller's current topic
is named <code>$CALLER::_</code>.  Your caller's current <code>Routine</code> reference
is named <code>&amp;CALLER::_</code>.</p>
<p>Note again that, as a form of <code>caller</code>, use of <code>CALLER::</code> can
prevent certain kinds of optimizations.  However, if your signature
uses <code>$CALLER::_</code> as a default value, the optimizer may be able to
deal with that as a special case.  If you say, for instance:</p>
<pre><code>
    sub myprint (IO $handle, *@list = ($CALLER::_)) {
        print $handle: *@list;
    }</code></pre>
<p>then the compiler can just turn the call:</p>
<pre><code>
    myprint($*OUT);</code></pre>
<p>into:</p>
<pre><code>
    myprint($*OUT, $_);</code></pre>
<p>Our earlier example of <code>trim</code> might want to default the first argument
to the caller's <code>$_</code>.  In which case you can declare it as:</p>
<pre><code>
    sub trim ( Str ?$_ is rw = $CALLER::_, Rule ?$remove = /\s+/ ) {
            s:each/^ &lt;$remove&gt; | &lt;$remove&gt; $//;
    }</code></pre>
<p>which lets you call it like this:</p>
<pre><code>
    trim;   # trims $_</code></pre>
<p>or even this:</p>
<pre><code>
    trim remove =&gt; /\n+/;</code></pre>
<p>Do not confuse the caller's lexical scope with the <em>callee</em>'s
lexical scope.  In particular, when you put a bare block into your
program that uses <code>$_</code> like this:</p>
<pre><code>
    for @array {
        mumble { s/foo/bar/ };
    }</code></pre>
<p>the compiler may not know whether or not the <code>mumble</code> routine
is intending to pass <code>$_</code> as the first argument of the closure,
which <code>mumble</code> needs to do if it's some kind of looping construct,
and doesn't need to do if it's a one-shot.  So such a bare block
actually compiles down to something like this:</p>
<pre><code>
    for @array {
        mumble(sub ($_ is rw = $OUTER::_) { s/foo/bar/ });
    }</code></pre>
<p>(If you put <code>$CALLER::_</code> there instead, it would be wrong, because
that would be referring to <code>mumble</code>'s <code>$_</code>.)</p>
<p>With <code>$OUTER::_</code>, if <code>mumble</code> passes an argument to the block, that
argument becomes <code>$_</code> each time <code>mumble</code> calls the block.  Otherwise,
it's just the same outer <code>$_</code>, as if ordinary lexical scoping were
in effect.  And, indeed, if the compiler knows that <code>mumble</code> takes
a sub argument with a signature of <code>()</code>, it may optimize it down
to ordinary lexical scoping, and if it has a signature of <code>($)</code>,
it can assume it doesn't need the default.  A signature of <code>(?$)</code>
means all bets are off again.</p>














<p><em>Editor's Note: this Apocalypse is out of date and remains here for historic reasons.  See <a href="http://dev.perl.org/perl6/doc/design/syn/S06.html">Synopsis 06</a> for the latest information.</em></p>

<h4><a name="where_return/leave_returns_to">Where <code>return</code>/<code>leave</code> returns to</a></h4>
<p>A <code>return</code> statement needs to return to where the user thinks
it ought to return to.  Since any block is a closure, any block is
really a subroutine in disguise.  But the user doesn't generally want
<code>return</code> to return from the innermost block, but from the innermost
block that was actually defined using an explicit <code>sub</code>-ish keyword.
So that's what Perl 6 does.  If it can, it will implement the <code>return</code>
internally as a simple jump to the end of the subroutine.  If it can't,
it implements <code>return</code> by throwing a control exception that is caught
by the proper context frame.</p>
<p>There will be a <code>leave</code> function that can return from other scopes.
By default it exits from the innermost block (anything matching base
class <code>Code</code>), but, as with <code>caller</code> and <code>want</code>, you can optionally
select the scope you want to return from.  It's declared like this:</p>
<pre><code>
    multi leave (?$where = Code, *@value, Int +$skip, Str +$label) {...}</code></pre>
<p>which lets you say things like:</p>
<pre><code>
    leave;
    leave Block;
    leave &amp;_ &lt;== 1,2,3; # same as &quot;return 1,2,3&quot;
    leave where =&gt; Parametric, value =&gt; (1,2,3);
    leave Loop, label =&gt; 'LINE', $retval
    leave { $_ ~~ Block and $_ !~ Sub } 1,2,3;
    leave () &lt;== 1,2,3;</code></pre>
<p>As it currently stands, the parens aren't optional on that last one,
because <code>&lt;==</code> is a binary operator.  You could always define
yourself a &quot;small&quot; return, <code>ret</code>, that leaves the innermost
block:</p>
<pre><code>
    my macro ret { &quot;leave Code &lt;== &quot; }
    # and later...
    { ret 1,2,3 }</code></pre>
<p>Note that unlike a <code>return</code>, <code>leave</code> always evaluates any return
value in list context.  Another thing to iron out is that the
context we choose to leave must have set up an exception handler
that can handle the control exception that <code>leave</code> must in some
cases throw.  This seems to imply that any context must miminally
catch a control exception that is bound to its own identity, since
<code>leave</code> is doing the picking, not the exception handlers.</p>


<h3><a name="subroutine_object_methods">Subroutine object methods</a></h3>


<h4><a name="the_.wrap_method">The <code>.wrap</code> method</a></h4>
<p>You may ask a subroutine to wrap itself up in another subroutine in
place, so that calls to the original are intercepted and interpreted
by the wrapper, even if access is only through the reference:</p>
<pre><code>
    $id = $subref.wrap({
        # preprocessing here
        call;
        # postprocessing here
    }</code></pre>
<p>The <code>call</code> built-in knows how to call the inner function that this
function is wrapped around.  In a void context, <code>call</code> arranges for
the return value of the wrapped routine to be returned implicitly.
Alternately, you can fetch the return value yourself from <code>call</code> and
return it explicitly:</p>
<pre><code>
    $id = $subref.wrap({
        my @retval = call;
        push(@retval, &quot;...and your little dog, too!&quot;;
        return @retval;
    })</code></pre>
<p>The arguments arrive in whatever form you request them, independently
of how the parameters look to the wrapped routine.  If you wish to
modify the parameters, supply a new argument list to <code>call</code>:</p>
<pre><code>
    $id = $subref.wrap(sub (*@args) {
        call(*@args,1,2,3);
    })</code></pre>
<p>You need to be careful not to preflatten those generators, though.</p>
<p>The <code>$id</code> is useful for removing a particular wrapper:</p>
<pre><code>
    $subref.unwrap($id);</code></pre>
<p>We might also at some point allow a built-in <code>sub</code>-like keyword
<code>wrap</code>.  If we don't, someone will write it anyway.</p>
<p>There is also likely a <code>.wrappers</code> method that represents the list
of all the current wrappers of the subroutine.  The ordering and
manipulation of this list is beyond the scope of this document, but
such activity will be necessary for anyone implementing Aspect-Oriented
Programming in Perl 6.</p>


<h4><a name="the_.assuming_method">The <code>.assuming</code> method</a></h4>
<p>Currying is done with the <code>.assuming</code> method.  It works a bit like
the <code>.wrap</code> method, except that instead of wrapping in place, it
returns a new function to you with a different signature, one in which
some of the parameters are assumed to be certain values:</p>
<pre><code>
    my &amp;say ::= &amp;*print.assuming(handle =&gt; $*TERM);</code></pre>
<p>You can even curry built-in operators:</p>
<pre><code>
    my &amp;prefix:&frac12; ::= &amp;infix:/ .assuming(y =&gt; 2);</code></pre>
<p>(assuming here that built-in infix operators always use <code>$x</code>
and <code>$y</code>).</p>


<h4><a name="the_.req_method">The <code>.req</code> method</a></h4>
<p>The <code>.req</code> method returns the number of required args requested
by the sub in question.  It's just a shortcut for digging down
into the <code>signature</code> trait and counting up how many required
parameters there are.  The count includes any invocant (or invocants,
for multimethods).</p>
<p>If you want to know how many optional arguments there are, you can do
your own digging.  This call is primarily for use by madmen who wish
to write variants of <code>map</code> and <code>reduce</code> that are sensitive to the
number of parameters declared for the supplied block.  (Certainly the
implementation of <code>for</code> will make heavy use of this information.)</p>


<h3><a name="subroutine_traits">Subroutine traits</a></h3>
<p>These are traits that are declared on the subroutine as a whole,
not on any individual parameter.</p>


<h4><a name="internal_traits">Internal traits</a></h4>
<p>The <code>signature</code>, <code>returns</code>, and <code>do</code> traits are internal traits
containing, respectively, the type signature of the parameters, the
type signature of the return value, and the body of the function.
Saying:</p>
<pre><code>
    sub Num foo (int $one, Str *@many) { return +@many[$one] }</code></pre>
<p>is short for saying something like:</p>
<pre><code>
    sub foo is signature( sig(int $one, Str *@many) )
            is returns( sig(Num) )
            will do { return +@many[$one] }</code></pre>
<p>In fact, it's likely that the &quot;do&quot; trait handler has to set up all
the linkage to pass parameters in and to trap &quot;return&quot; exceptions.</p>
<p>Many of these pre-defined traits just map straight onto the container
object's attribute methods of the same name.  Underneath they're just
accessors, but we use the trait notation in declarations for several
reasons.  For one thing, you can string a bunch of them together
without repeating the original object, which might be anonymous in
any event.  It also gives us liberty behind the scenes to promote
or demote various traits from mere properties to attributes of every
object of a class.  It's one of those levels of indirection computer
scientists keep talking about...</p>
<p>Going the other direction, it allows us to pretend that accessors are
just another form of metadata when accessed as a trait.  By the same
token it allows us to transparently make our metadata active rather
than passive, without rewriting our declarations.  This seems useful.</p>
<p>The basic rule of thumb is that you can use any of a container's
<code>rw</code> methods as if it were a trait.  For subroutine containers,
the example above really turns into something like this:</p>
<pre><code>
    BEGIN {
        &amp;foo.signature = sig(int $one, Str *@many);
        &amp;foo.returns = sig(Num);
        &amp;foo.do = { return +@many[$one] }
    }</code></pre>


<h4><a name="is_rw"><code>is rw</code></a></h4>
<p>This trait identifies lvalue subs or methods.  See the section on
lvalue subs below.</p>


<h4><a name="is_parsed(<rule>)"><code>is parsed(&lt;rule&gt;)</code></a></h4>
<p>This trait binds a macro to a grammar rule for parsing it.  The grammar
rule is invoked as soon as the initial keyword is seen and before
anything else is parsed, so you can completely change the grammar on
the fly.  For example, the <code>sig()</code> function above might well invoke
special parsing rules on its arguments, since what is inside is not
an ordinary expression.</p>
<p>In the absence of an explicit &lt;is parsed&gt; trait, a macro's arguments
are parsed with whatever <code>macro</code> rule is in effect, by default the
standard <code>Perl::macro</code>.</p>


<h4><a name="is_cloned(begin)"><code>is cloned(&quot;BEGIN&quot;)</code></a></h4>
<p>Perhaps this is an alternate way of specifying the parsing and
semantics of a macro or function.  Or perhaps not.  Just an idea
for now...</p>


<h4><a name="is_cached"><code>is cached</code></a></h4>
<p>This is the English translation of what some otherwise sane folks call
&quot;memoization&quot;.  This trait asserts that Perl can do automatic caching
of return values based on the assumption that, for any particular set
of arguments, the return value is always the same.  It can dramatically
speed up certain kinds of recursive functions that shouldn't have
been written recursively in the first place.  <code>;-)</code></p>


<h4><a name="is_inline"><code>is inline</code></a></h4>
<p>This says you think performance would be enhanced if the code were
inlined into the calling code.  Of course, it also constitutes a
promise that you're not intending to redefine it or wrap it or do
almost anything else fancy with it, such as expecting it to get
called by a method dispatcher.  In early versions of Perl 6, it's
likely to be completely ignored, I suspect.  (If not, it's likely to
be completely broken...)</p>


<h4><a name="pre/post/first/last/etc."><code>PRE</code>/<code>POST</code>/<code>FIRST</code>/<code>LAST</code>/etc.</a></h4>
<p>These all-caps traits are generally set from the inside of a
subroutine as special blocks.  <code>FIRST</code> and <code>LAST</code> are expected
to have side effects.  <code>PRE</code> and <code>POST</code> are expected to not have
side effects, but return a boolean value indicating whether pre/post
conditions have been met.  If you declare any <code>PRE</code> or <code>POST</code> conditions,
your routine will automatically be wrapped in a wrapper that evaluates
them according to Design-by-Contract principles (ORing preconditions,
ANDing postconditions).</p>
<p>Note that the actual &quot;first&quot; or &quot;last&quot; property attached to a
subroutine may well be a list of <code>FIRST</code> or <code>LAST</code> blocks, since
there can be more than one of them.</p>


<h3><a name="overriding_builtins">Overriding built-ins</a></h3>
<p>All built-in functions that can be overridden are either multimethods
or global subroutines.  To override one of these, just declare your
own subroutine of that name in your current package or lexical scope.
For instance, the standard non-filehandle print function may well be
declared as:</p>
<pre><code>
    multi *print (*@list) {...}</code></pre>
<p>Just declare your own sub:</p>
<pre><code>
    sub print (*@list) {...}</code></pre>
<p>to override all <code>print</code> multimethods in the current package, or:</p>
<pre><code>
    my sub print (*@list) {...}</code></pre>
<p>to override in the current lexical scope.</p>
<p>To override or wrap a built-in function for everyone (dangerous),
you have to play with the globally named version, but we're not going
to tell you how to do that.  If you can't figure it out, you
shouldn't be doing it.</p>














<p><em>Editor's Note: this Apocalypse is out of date and remains here for historic reasons.  See <a href="http://dev.perl.org/perl6/doc/design/syn/S06.html">Synopsis 06</a> for the latest information.</em></p>

<h3><a name="subs_with_special_parsing">Subs with special parsing</a></h3>
<p>Any macro can have special parsing rules if you use the <code>is parsed</code>
trait.  But some subs are automatically treated specially.</p>


<h4><a name="operator_subroutines">Operator subroutines</a></h4>
<p>In Perl 6, operators are just subroutines with special names.  When you
say:</p>
<pre><code>
    -$a + $b</code></pre>
<p>you're really doing this internally:</p>
<pre><code>
    infix:+( prefix:-($a), $b)</code></pre>
<p>Operator names start with one of four names followed by a colon:</p>
<pre><code>
    prefix:     a unary prefix operator
    infix:      a binary infix operator
    postfix:    a binary suffix operator
    circumfix:  a bracketing operator</code></pre>
<p>Everything after the colon and up to the next whitespace or left
parenthesis will be taken as the spelling of the actual operator.
Unicode is specifically allowed.  The null operator is not allowed,
so if the first thing after the colon is a left parenthesis, it
is part of the operator, and if the first thing is whitespace,
it's an illegal name.  Boom!</p>
<p>You can make your own lexically scoped operators like this:</p>
<pre><code>
    my sub postfix:! (Int $x) { return factorial($x) }
    print 5!, &quot;\n&quot;;     # print 120</code></pre>
<p>You can use a newly declared operator recursively as soon as its name
is introduced, including in its own definition:</p>
<pre><code>
    my sub postfix:! (Int $x) { $x&lt;=1 ?? 1 :: $x*($x-1)! }</code></pre>
<p>You can declare multimethods that create new syntax like this:</p>
<pre><code>
    multi postfix:! (Int $x) { $x&lt;=1 ?? 1 :: $x*($x-1)! }</code></pre>
<p>However, regardless of the scope of the name, the new <em>syntax</em> is
considered to be a lexically scoped declaration, and is only valid
after the name is declared (or imported) and after any precedence
traits have been parsed.</p>
<p>If you want to specify a precedence, you always do it relative to
some existing operator:</p>
<pre><code>
    multi infix:coddle   (PDL $a, PDL $b) is equiv(&amp;infix:+) { ... }
    multi infix:poach    (PDL $a, PDL $b) is looser(&amp;infix:+) { ... }
    multi infix:scramble (PDL $a, PDL $b) is tighter(&amp;infix:+) { ... }</code></pre>
<p>If you base a tighter operator on a looser one, or a looser one on
a tighter one, you don't get back to where you were.  It always goes
into the cracks no matter how many times you derive.</p>
<p>Just a note on implementation: if you've played with numerically
oriented precedence tables in the past, and are thinking, &quot;but he'll
run out of bits in his number eventually.&quot;  The answer to that is that
we don't use precedence numbers.  The actual precedence level can be
represented internally by an arbitrarily long string of bytes that are
compared byte by byte.  When you make a tighter or looser operator,
the string just gets one byte longer.  A looser looser looser looser
<code>infix:*</code> is still tighter than a tighter tighter tighter tighter
<code>infix:+</code>, because the string comparison bails out on the first byte.
The first byte compares the built-in multiplication operator against
the built-in addition operator, and those are already different,
so we don't have to compare any more.</p>
<p>However, two operators derived by the same path have the same
precedence.  All binary operators of a given precedence level are
assumed to be left associative unless declared otherwise with an
<code>assoc('right')</code> or <code>assoc('non')</code> trait.  (Unaries pay no attention
to associativity--they always go from the outside in.)</p>
<p>This may sound complicated, and it is, if you're implementing
it internally.  But from the user's point of view, it's much less
complicated than trying to keep track of numeric precedence levels
yourself.  By making the precedence levels relative to existing
operators, we keep the user from having to think about how to keep
those cracks open.  And most user-defined operators will have exactly
the same precedence as something built-in anyway.  Not to mention the
fact that it's just plain better documentation to say that an operator
works like a familiar operator such as &quot;<code>+</code>&quot;.  Who the heck can
remember what precedence level 17 is, anyway?</p>
<p>If you don't specify a precedence on an operator, it will default
to something reasonable.  A named unary operator, whether prefix or
postfix, will default to the same precedence as other named unary
operators like <code>abs()</code>.  Symbolic unaries default to the same
precedence as unary <code>+</code> or <code>-</code> (hence the <code>!</code> in our factorial
example is tighter than the <code>*</code> of multiplication.)  Binaries default
to the same precedence as binary <code>+</code> or <code>-</code>.  So in our <code>coddle</code>
example above, the <code>is equiv(&amp;infix::+)</code> is completely redundant.</p>
<p>Unless it's completely wrong.  For multimethods, it's an error to
specify two different precedences for the same name.  Multimethods that
overload an existing name will be assumed to have the same precedence
as the existing name.</p>
<p>You'll note that the rules for the scope of syntax warping are similar
to those for macros.  In essence, these definitions are macros,
but specialized ones.  If you declare one as a macro, the body is
executed at compile time, and returns a string, a parse tree, or a
closure just as a macro would:</p>
<pre><code>
    # define Pascal comments:
    macro circumfix:(**) () is parsed(/.*?/ { &quot;&quot; }
                                # &quot;Comment? What comment?&quot;</code></pre>
<p>A circumfix operator is assumed to be split symmetrically between
prefix and postfix.  In this case the circumfix of four characters
is split exactly in two, but if you don't want it split in the
middle (which is particularly gruesome when there's an odd number
of characters) you may specify exactly where the parse rule is
interpolated with a special <code> ... </code> marker, which is considered part
of the name:</p>
<pre><code>
    macro circumfix:(*...*) () is parsed(/.*?/ { &quot;&quot; }</code></pre>
<p>The default parse rule for a circumfix is an ordinary Perl expression of
lowest precedence, the same one Perl uses inside ordinary parentheses.
The defaults for other kinds of operators depend on the precedence of
the operator, which may or may not be reflected in the actual name of
the grammatical rule.</p>
<p>Note that the ternary operator <code>??::</code> has to be parsed as an infix
<code>??</code> operator with a special parsing rule to find the associated
<code>::</code> part.  I'm not gonna explain that here, partly because
user-defined ternary operators are discouraged, and partly because
I haven't actually bothered to figure out the details yet.  This
Apocalypse is already late enough.</p>
<p>Also please note that it's perfectly permissible (but not extremely
expeditious) to rapidly reduce the Perl grammar to a steaming pile
of gopher guts by redefining built-in operators such as commas or
parentheses.</p>


<h4><a name="named_unaries">Named unaries</a></h4>
<p>As in Perl 5, a named unary operator by default parses with the
same precedence as all other named unary operators like <code>sleep</code>
and <code>rand</code>.  Any sub declared with a single scalar argument counts
as a named unary, not just explicit operator definitions.  So it
doesn't really matter whether you say:</p>
<pre><code>
    sub plaster ($x) {...}</code></pre>
<p>or:</p>
<pre><code>
    sub prefix:plaster ($x) {...}</code></pre>


<h4><a name="argumentless_subs">Argumentless subs</a></h4>
<p>As in Perl 5, a 0-ary subroutine (one with a <code>()</code> signature) parses
without looking for any argument at all, much like the <code>time</code>
built-in.  (An optional pair of empty parens are allowed on the call,
as in <code>time()</code>.)  Constant subs with a null signature will likely
be inlined as they are in Perl 5, though the preferred way to declare
constants will be as standard variables with the <code>is constant</code> trait.</p>


<h3><a name="matching_of_forward_declarations">Matching of forward declarations</a></h3>
<p>If you define a subroutine for which you earlier had a stub
declaration, its signature and traits must match the stub's subroutine
signature and traits, or it will be considered to be declaring a
different subroutine of the same name, which may be any of illegal,
immoral, or fattening.  In the case of standard subs, it would be
illegal, but in the case of multimethods, it would merely be fattening.
(Well, you'd also get a warning if you called the stub instead of the
&quot;real&quot; definition.)</p>
<p>The declaration and the definition should have the same defaults.  That
does not just mean that they should merely <em>look</em> the same.  If you say:</p>
<pre><code>
    our $x = 1;
    sub foo ($y = $x) {...}             # default to package var</code></pre>
<pre><code>
    {
        my $x = 2;
        sub foo ($y = $x) { print $y }  # default to lexical var
        foo();
    }</code></pre>
<p>then what you've said is an error if the compiler can catch it, and
is erroneous if it can't.  In any event, the program may correctly
print any of these values:</p>
<pre><code>
    1
    2
    1.5
    12
    1|2
    (1,2)
    Thbthbthbthth...
    1|2|1.5|12|(1|2)|(1,2)|Thbthbthbthth...</code></pre>


<h3><a name="lvalue_subroutines">Lvalue subroutines</a></h3>
<p>The purpose of an lvalue subroutine is to return a &quot;proxy&quot;--that is,
to return an object that represents a &quot;single evaluation&quot; of the
subroutine while actually allowing multiple accesses within a single
transaction.  An lvalue subroutine has to pretend to be a storage
location, with all the rights, privileges, and responsibilities
pertaining thereto.  But it has to do this without repeatedly
calculating the <em>identity</em> of whatever it is you're actually modifying
underneath--especially if that calculation entails side effects.
(Or is expensive--meaning that it has the side-effect of chewing up
computer resources...)</p>
<p>An lvalue subroutine is declared with the <code>is rw</code> trait.  The compiler
will take whatever steps necessary to ensure that the returned value
references a storage location that can be treated as an lvalue.
If you merely return a variable (such as an object attribute), that
variable can act as its own proxy.  You can also return the result
of a call to another lvalue subroutine or method.  If you need to do
pre- or post-processing on the &quot;public&quot; value, however, you'll need
to return a tied proxy variable.</p>
<p>But if you know how hard it is to tie variables in Perl 5, you'll be
pleasantly surprised that we're providing some syntactic relief for the
common cases.  In particular, you can say something like:</p>
<pre><code>
    my sub thingie is rw {
        return my $var
            is Proxy( for =&gt; $hidden_var,
                      FETCH =&gt; { ... },
                      STORE =&gt; { ... },
                      TEMP  =&gt; { ... },
                      ...
            );
    }</code></pre>
<p>in order to generate a tie class on the fly, and only override the
standard proxy methods you need to, while letting others default to
doing the standard behavior.  This is particularly important when
proxying things like arrays and hashes that have oodles of potential
service routines.</p>
<p>But in particular, note that we want to be able to temporize object
attributes, which is why there's a <code>TEMP</code> method in our proxy.  In Perl 5
you could only temporize (localize) variables.  But we want accessors
to be usable exactly as if they were variables, which implies that
temporization is part of the interface.  When you use a <code>temp</code>
or <code>let</code> context specifier:</p>
<pre><code>
    temp $obj.foo = 42;
    let $obj.bar = 43;</code></pre>
<p>the proxy attribute returned by the lvalue method needs to know how to
temporize the value.  More precisely, it needs to know how to restore
the old value at the end of the dynamic scope.  So what the <code>.TEMP</code>
method returns is a closure that knows how to restore the old value.
As a closure, it can simply keep the old value in a lexical created
by <code>.TEMP</code>.  The same method is called for both <code>temp</code> and <code>let</code>.
The only difference is that <code>temp</code> executes the returned closure
unconditionally at end of scope, while <code>let</code> executes the closure
conditionally only upon failure (where failure is defined as throwing
a non-control exception or returning undef in scalar context or <code>()</code>
in list context).</p>
<p>After the <code>.TEMP</code> method returns the closure, you never have to worry
about it again.  The <code>temp</code> or <code>let</code> will squirrel away the closure
and execute it later when appropriate.  That's where the real power of
<code>temp</code> and <code>let</code> comes from--they're fire-and-forget operators.</p>
<p>The standard <code>Scalar</code>, <code>Array</code>, and <code>Hash</code> classes also have
a <code>.TEMP</code> method (or equivalent). So <em>any</em> such variable can be
temporized, even lexicals:</p>
<pre><code>
    my $identity = 'Clark Kent';</code></pre>
<pre><code>
    for @emergencies {
         temp $identity = 'SUPERMAN';   # still the lexical $identity
         ...
    }</code></pre>
<pre><code>
    print $identity;    # prints 'Clark Kent'</code></pre>
<p>We'll talk more about lvalues below in reference to various RFCs that
espouse lvalue subs--all of which were rejected. <code>:-)</code></p>














<p><em>Editor's Note: this Apocalypse is out of date and remains here for historic reasons.  See <a href="http://dev.perl.org/perl6/doc/design/syn/S06.html">Synopsis 06</a> for the latest information.</em></p>

<h3><a name="temporizing_any_subroutine_call">Temporizing any subroutine call</a></h3>
<p>Lvalue subroutines have a special way to return a proxy that can be
temporized, but sometimes that's overkill.  Maybe you don't want an
lvalue; you just want a subroutine that can do something temporarily
in an rvalue context.  To do that, you can declare a subroutine with
a <code>TEMP</code> block that works just like the <code>.TEMP</code> method described
earlier.  The <code>TEMP</code> block returns a closure that will be called
when the <em>call</em> to this function goes out of scope.</p>
<p>So if you declare a function with a <code>TEMP</code> property:</p>
<pre><code>
    sub setdefout ($x) {
        my $oldout = $*OUT;
        $*DEFOUT = $x;
        TEMP {{ $*DEFOUT = $oldout }}
    }</code></pre>
<p>then you can call it like this:</p>
<pre><code>
    temp setdefout($MYFILE);</code></pre>
<p>and it will automatically undo itself on scope exit.  One place where
this might be useful is for wrappers:</p>
<pre><code>
    temp &amp;foo.wrap({...})</code></pre>
<p>The routine will automatically unwrap itself at the end of the current
dynamic scope.  A <code>let</code> would similarly put a hypothetical wrapper
in place, but keep it wrapped on success.</p>
<p>The <code>TEMP</code> block is called only if you invoke the subroutine or method
with <code>temp</code> or <code>let</code>.  Otherwise the <code>TEMP</code> block is ignored.  So if
you just call:</p>
<pre><code>
    setdefout($MYFILE);</code></pre>
<p>then the side-effects are permanent.</p>
<p>That being said...</p>
<p>I don't think we'll actually be using explicit <code>TEMP</code> closures all
over the place, because I'd like to extend the semantics of <code>temp</code>
and <code>let</code> such that they automatically save state of anything within
their dynamic scopes.  In essence, Perl writes most of the <code>TEMP</code>
methods for you, and you don't have to worry about them unless you're
interfacing to external code or data that doesn't know how to save
its own state.  (Though there's certainly plenty of all that out
in the wide world.)</p>
<p>See appendix C for more about this line of thought.</p>


<h2><a name="the_rfcs">The RFCs</a></h2>
<p>Let me reiterate that there's little difference between an RFC accepted
with major caveats and a rejected RFC from which some ideas may have
been stolen.  Please don't take any of this personally--I ignore
author names when evaluating RFCs.</p>


<h3><a name="rejected_rfcs">Rejected RFCs</a></h3>


<h4><a name="rfc_59:_proposal_to_utilize_*_as_the_prefix_to_magic_subroutines" href="http://dev.perl.org/rfc/59.html">RFC 59: Proposal to utilize <code>*</code> as the prefix to magic
subroutines</a></h4>
<p>There are several problems with doing this.</p>
<ul>
<li>
The <code>*</code> prefix is already taken for two other meanings.  (It indicates
a completely global symbol or a splatlist.)  We could come up with
something else, but we're running out of keyboard.  And I don't think
it's important enough to inflict a Unicode character on people.
</li>


<li>
It would be extra clutter that conveys little extra information
over what is already conveyed by all-caps.
</li>


<li>
All-caps routines are a fuzzy set.  Some of these routines are
always called implicitly, while others are only <em>usually</em> called
implicitly.  We'd have to be continually making arbitrary decisions
on where to cut it off.
</li>


<li>
Some routines are in the process of migrating into (or out of)
the core.  We don't want to force people to rewrite their programs
when that happens.
</li>


<li>
People are already used to the all-caps convention.
</li>


<li>
Most importantly, I have an irrational dislike for anything that
resembles Python's <code>__foo__</code> convention.  <code>:-)</code>
</li>

</ul>
<p>So we'll continue to half-heartedly reserve the all-caps space for
Perl magic.</p>


<h4><a name="rfc_75:_structures_and_interface_definitions" href="http://dev.perl.org/rfc/75.html">RFC 75: structures and interface definitions</a></h4>
<p>In essence, this proposal turns every subroutine call into a
constructor of a parameter list object.  That's an interesting way to
look at it, but the proposed notation for class declaration suffers
from some problems.  It's run-time rather than compile-time, and
it's based on a value list rather than a statement list.  In other
words, it's not what we're gonna do, because we'll have a more
standard-looking way of declaring classes.  (On the other hand, I
think the proposed functionality can probably be modeled by suitable
use of constructors.)</p>
<p>The proposal also runs afoul of the rule that a lexically scoped
variable ought generally to be declared explicitly at the beginning
of its lexical scope.  The parameters to subroutines will be lexically
scoped in Perl 6, so there needs to be something equivalent to a <code>my</code>
declaration at the beginning.</p>
<p>Unifying parameter passing with <code>pack</code>/<code>unpack</code> syntax is, I
think, a false economy.  <code>pack</code> and <code>unpack</code> are serialization
operators, while parameter lists are about providing useful aliases
to caller-provided data without any implied operation.  The fact that
both deal with lists of values on some level doesn't mean we should
strain to make them the same on every level.  That will merely make
it impossible to implement subroutine calls efficiently, particularly
since the Parrot engine is register-based, not stack-based as this
RFC assumes.  Register-based machines don't access parameters by
offsets from the stack pointer.</p>


<h4><a name="rfc_107:_lvalue_subs_should_receive_the_rvalue_as_an_argument" href="http://dev.perl.org/rfc/107.html">RFC 107: lvalue subs should receive the rvalue as an argument</a></h4>
<p>This would make it hard to dynamically scope an attribute.  You'd have
to call the method twice--once to get the old value, and once to set
the new value.</p>
<p>The essence of the lvalue problem is that you'd like to separate
the identification of the object from its manipulation.  Forcing
the new value into the same argument list as arguments meant to
identify the object is going to mess up all sorts of things like
assignment operators and temporization.</p>


<h4><a name="rfc_118:_lvalue_subs:_parameters,_explicit_assignment,_and_wantarray()_changes" href="http://dev.perl.org/rfc/118.html">RFC 118: lvalue subs: parameters, explicit assignment, and
<code>wantarray()</code> changes</a></h4>
<p>This proposal has a similar problem in that it doesn't separate
the identity from the operation.</p>


<h4><a name="rfc_132:_subroutines_should_be_able_to_return_an_lvalue" href="http://dev.perl.org/rfc/132.html">RFC 132: Subroutines should be able to return an lvalue</a></h4>
<p>This RFC proposes a keyword <code>lreturn</code> to return an lvalue.</p>
<p>I'd rather the lvalue hint be available to the compiler, I think, even
if the body has not been compiled yet.  So it needs to be declared
in the signature somehow.  The compiler would like to know whether
it's even legal to assign to the subroutine.  Plus it might have to
deal with the returned value as a different sort of object.</p>
<p>At least this proposal doesn't confuse identification with
modification.  The lvalue is presumably an object with a <code>STORE</code>
method that works independently of the original arguments.  But this
proposal also doesn't provide any mechanism to do postprocessing on
the stored value.</p>


<h4><a name="rfc_149:_lvalue_subroutines:_implicit_and_explicit_assignment" href="http://dev.perl.org/rfc/149.html">RFC 149: Lvalue subroutines: implicit and explicit assignment</a></h4>
<p>This is sort of the don't-have-your-cake-and-don't-eat-it-too
approach.  The implicit assignment doesn't allow for virtual
attributes.  The explicit assignment doesn't allow for delayed
modification.</p>


<h4><a name="rfc_154:_simple_assignment_lvalue_subs_should_be_on_by_default" href="http://dev.perl.org/rfc/154.html">RFC 154: Simple assignment lvalue subs should be on by default</a></h4>
<p>Differentiating &quot;simple&quot; lvalue subs is a problem.  A user ought to
just be able to say something fancy like</p>
<pre><code>
    temp $obj.attr += 3;</code></pre>
<p>and have it behave right, provided <code>.attr</code> allows that.</p>
<p>Even with:</p>
<pre><code>
    $obj.attr = 3;</code></pre>
<p>we have a real problem with knowing what can be done at compile time,
since we might not know the exact type of <code>$obj</code>.  Even if <code>$obj</code>
is declared with a type, it's only an &quot;isa&quot; assertion.  We could
enforce things based on the declared type with the assumption that a
derived type won't violate the contract, but I'm a little worried about
large semantic changes happening just because one adds an optional
type declaration.  It seems safer that the untyped method behave
just like the typed method, only with run-time resolution rather than
compile-time resolution.  Anything else would violate the principle of
least surprise.  So if it is not known whether <code>$obj.attr</code> can be an
lvalue, it must be assumed that it can, and compiled with a mechanism
that will work consistently, or throw a run-time exception if it can't.</p>
<p>The same goes for argument lists, actually.  <code>$obj.meth(@foo)</code>
can't assume that <code>@foo</code> is either scalar or list until it knows the
signature of the <code>.meth</code> method.  And it probably doesn't know that
until dispatch time, unless it can analyze the entire set of available
methods in advance.  In general, modification of an invalid lvalue
(an object without a write method, essentially) has to be handled by
throwing an exception.  This may well mean that it is illegal for a
method to have an <code>rw</code> parameter!</p>
<p>Despite the fact that there are similar constraints on the arguments
and on the lvalue, we cannot combine them, because the values are
needed at different times.  The arguments are needed when identifying
the object to modify, since lvalue objects often act as proxies for
other objects elsewhere.` Think of subscripting an array, for instance,
where the subscripts function as arguments, so you can say:</p>
<pre><code>
    $elem := @a[0][1][2];
    $elem = 3;</code></pre>
<p>Likewise we should be able to say:</p>
<pre><code>
    $ref := a(0,1,2);
    $ref = 3;</code></pre>
<p>and have <code>$ref</code> be the lvalue returned by <code>a()</code>.  It's the implied
&quot;<code>is rw</code>&quot; on the left that causes <code>a()</code> to return an lvalue, just
as a subroutine parameter that is &quot;<code>rw</code>&quot; causes lvaluehood to be
passed to its actual argument.</p>
<p>Since we can't in general know at compile time whether a method is
&quot;simple&quot; or not, we don't know whether it's appropriate to treat
an assignment as an extra argument or as a parameter to an internal
<code>STORE</code> method.  We have to compile the call assuming there's a separate
<code>STORE</code> method on the lvalue object.  Which means there's no such thing
as a &quot;simple&quot; lvalue from the viewpoint of the caller.</p>


<h3><a name="accepted_rfcs">Accepted RFCs</a></h3>


<h4><a name="rfc_168:_builtin_functions_should_be_functions" href="http://dev.perl.org/rfc/168.html">RFC 168: Built-in functions should be functions</a></h4>
<p>This all seems fine to me in principle.  All built-in functions and
multimethods exist in the &quot;<code>*</code>&quot; space, so <code>system()</code> is really
<code>&amp;*system();</code> in Perl 6 .</p>
<p>We do need to consider whether &quot;<code>sub system</code>&quot; changes the meaning
of calls to <code>system()</code> earlier in the lexical scope.  Or are
built-ins imported as third-class keywords like <code>lock()</code> is in
Perl 5?  It's probably best if we detect the ambiguous situation and
complain.  A &quot;late&quot; definition of <code>system()</code> could be considered
a redefinition, in fact, any definition of <code>system()</code> could be
considered a redefinition.  We could require &quot;<code>is redefined</code>&quot; or
some such on all such redefinitions.</p>
<p>The &quot;<code>lock</code>&quot; situation arises when we add a new built-in, however.
Do we want to force people to add in an &quot;<code>is redefined</code>&quot; where they
didn't have to before?  Worse, if their definition of &quot;<code>lock</code>&quot; is
retroactive to the front of the file, merely adding &quot;<code>sub lock is
redefined</code>&quot; is not necessarily good enough to become retroactive.</p>
<p>This is not a problem with <code>my</code> subs, since they have to be declared
in advance.  If we defer committing compilation of package-named
subs to the end of the compilation unit, then we can just say that
the current package overrides the &quot;<code>*</code>&quot; package.  All built-ins
become &quot;third class&quot; keywords in that case.  But does that mean
that a built-in can't override ordinary function-call syntax?
Built-ins should at least be able to be used as list operators, but
in Perl 5 you couldn't use your own sub as a list operator unless it
was predeclared.  Maybe we could relax that.</p>
<p>Since there are no longer any barewords, we can assume that any
unrecognized word is a subroutine or method call of some sort even
in the absence of parens.  We could assume all such words are list
operators.  That works okay for overriding built-ins that actually
*are* list operators--but not all of them are.  If you say:</p>
<pre><code>
    print rand 1, 2;
    sub rand (*@x) { ... }</code></pre>
<p>then it cannot be determined whether <code>rand</code> should be parsed as a
unary operator <code>($)</code> or as a list operator <code>(*@)</code>.</p>
<p>Perl has to be able to parse its unary operators.  So that code
must be interpreted as:</p>
<pre><code>
    print rand(1), 2;</code></pre>
<p>At that point in the parse, we've essentially committed to a signature
of <code>($)</code>, which makes the subsequent sub declaration a redefinition
with a different signature, which is illegal.  But when someone says:</p>
<pre><code>
    print foo 1, 2;
    sub foo (*@x) { ... }</code></pre>
<p>it's legal until someone defines <code>&amp;*foo($)</code>.  We can protect ourselves
from the backward compatibility problem by use of parens.  When there
are parens, we can probably defer the decision about the binding of
its arguments to the end of the compilation.  So either of:</p>
<pre><code>
    print foo(1), 2;
    sub foo (*@x) { ... }</code></pre>
<p>or:</p>
<pre><code>
    print foo(1, 2);
    sub foo (*@x) { ... }</code></pre>
<p>remain legal even if we later add a unary <code>&amp;*foo</code> operator, as long as
no other syntactic monkey business is going on with the functions args.
So I think we keep the rule that says post-declared subs have to be
called using parens, even though we could theoretically relax it.</p>
<p>On the other hand, this means that any unrecognized word followed by
a list may unambiguously be taken to be a multimethod being called
as a list operaotr.  After all, we don't know when someone will be
adding more multimethods.  I currently think this is a feature, but
I could be sadly mistaken.  It has happened once or twice in the past.</p>














<p><em>Editor's Note: this Apocalypse is out of date and remains here for historic reasons.  See <a href="http://dev.perl.org/perl6/doc/design/syn/S06.html">Synopsis 06</a> for the latest information.</em></p>

<h4><a name="rfc_57:_subroutine_prototypes_and_parameters" href="http://dev.perl.org/rfc/57.html">RFC 57: Subroutine prototypes and parameters</a></h4>
<p>We ended up with something like this proposal, though with some
differences.  Instead of <code>=</code>, we're using <code>=&gt;</code> to specify
names because it's a pair constructor in Perl 6, so there's little
ambiguity with positional parameters.  Unless a positional parameter
is explicitly declared with a <code>Pair</code> or <code>Hash</code> type, it's assumed
not to be interested in named arguments.</p>
<p>Also, as the RFC points out, use of <code>=</code> would be incompatible with
lvalue subs, which we're supporting.</p>
<p>The RFC allows for mixing of positional and named parameters, both
in declaration and in invocation.  I think such a feature would
provide far more confusion than functionality, so we won't allow it.
You can always process your own argument list if you want to.  You
could even install your own signature handler in place of Perl's.</p>
<p>The RFC suggests treating the first parameter with a default as the
first optional parameter.  I think I'd rather mark optional parameters
explicitly, and then disallow defaults on required parameters as
a semantic constraint.</p>
<p>It's also suggested that something like:</p>
<pre><code>
    sub waz ($one, $two, 
             $three = add($one, $two), 
             $four  = add($three, 1)) {
        ...
    }</code></pre>
<p>be allowed, where defaults can refer back to previous parameters.
It seems as though we could allow that, if we assume that symbols
are introduced in signatures as soon as they are seen.  That would
be consistent with how we've said <code>my</code> variables are introduced.
It does mean that a prototype that defaults to the prior <code>$_</code> would
have to be written like this:</p>
<pre><code>
    $myclosure = sub ($_ = $OUTER::_) { ... }</code></pre>
<p>On the other hand, that's exactly what:</p>
<pre><code>
    $myclosure = { ... }</code></pre>
<p>means in the absence of placeholder variables, so the situation will
likely not arise all that often.  So I'd say yes, defaults should
be able to refer back to previous parameters in the same signature,
unless someone thinks of a good reason not to.</p>
<p>As explained in Apocalypse 4, <code>$OUTER::</code> is for getting at an outer
lexical scope.  This ruling about formal parameters means that,
effectively, the lexical scope of a subroutine &quot;starts to begin&quot;
where the formal parameters are declared, and &quot;finishes beginning&quot; at
the opening brace.  Whether a given symbol in the signature actually
belongs to the inner scope or the outer scope depends on whether it's
already been introduced by the inner scope.  Our sub above needed
<code>$OUTER::_</code> because <code>$_</code> had already been introduced as the name
of the first argument.  Had some other name been introduced, <code>$_</code>
might still be taken to refer to the outer <code>$_</code>:</p>
<pre><code>
    $myclosure = sub ($arg = $_) { ... }</code></pre>
<p>If so, use of <code>$OUTER::_</code> would be erroneous in that case, because
the subroutine's implicit <code>$_</code> declaration wouldn't happen till
the opening curly, and instead of getting <code>$OUTER::_</code>, the user would
unexpectedly be getting <code>$OUTER::OUTER::_</code>, as it were.  So instead, we'll
say that the implicit introduction of the new sub's <code>$_</code> variable
<em>always</em> happens after the <code>&lt;subintro&gt;</code> and before the <code>&lt;signature&gt;</code>,
so any use of <code>$_</code> as a default in a signature or
as an argument to a property can only refer to the subroutine's own
topic, if any.  To refer to any external <code>$_</code> you must say either
<code>$CALLER::_</code> or <code>$OUTER::_</code>.  This approach seems much cleaner.</p>


<h4><a name="rfc_160:_functioncall_named_parameters_(with_compiler_optimizations)" href="http://dev.perl.org/rfc/160.html">RFC 160: Function-call named parameters (with compiler
optimizations)</a></h4>
<p>For efficiency, we have to be able to hoist the semantics from the
signature into the calling module when that's practical, and that
has to happen at compile time.  That means the information has to be
in the signature, not embedded in a <code>fields()</code> function within the
body of the subroutine.  In fact, my biggest complaint about
this RFC is that it arbitrarily separates the prototype characters,
the parameter names, and the variable names.  That's a recipe for
things getting out of sync.</p>
<p>Basically, this RFC has a lot of the right ideas, but just doesn't
go far enough in the signature direction, based on the (at the
time) laudable notion that we were interested in keeping Perl 6 as
close to Perl 5 as possible.  Which turned out not to be <em>quite</em>
the case. <code>:-)</code> Our new signatures look more hardwired than the
attribute syntax proposed here, but it's all still very hookable
underneath via the sub and parameter traits.  And everything is
together that should be together.</p>
<p>Although the signature is really just a trait underneath, I thought it
important to have special syntax for it, just as there's special syntax
for the body of the function.  Signatures are very special traits, and
people like special things to look special.  It's just more of those
darn psychological reasons that keep popping up in the design of Perl.</p>
<p>Still and all, the current design is optimized for many of the
same sensitivities described in this RFC.</p>


<h4><a name="rfc_128:_subroutines:_extend_subroutine_contexts_to_include_name_parameters_and_lazy_arguments" href="http://dev.perl.org/rfc/128.html">RFC 128: Subroutines: Extend subroutine contexts to include
name parameters and lazy arguments</a></h4>
<p>This RFC also has lots of good ideas, but tends to stay a little
too close to Perl 5 in various areas where I've decided to swap
the defaults around.  For instance, marking reference parameters in
prototypes rather than slurpy parameters in signatures, identifying
lazy parameters rather than flattening, and defaulting to <code>rw</code>
(autovivifying lvalue args) rather than <code>constant</code> (rvalue args).</p>
<p>Context classes are handled by the automatic coercion to references
within scalar context, and by type junctions.</p>
<p>Again, I don't buy into two-pass, fill-in-the-blanks argument
processing.</p>
<p>Placeholders are now just for argument declaration, and imply
no currying.  Currying on the other hand is done with an explicit
<code>.assuming</code> method, which requires named args that will be bound to
the corresponding named parameters in the function being curried.</p>
<p>Or should I say functions?  When module and class writers write
systems of subroutines or methods, they usually go to great pains
to make sure all the parameter names are consistent.  Why not take
advantage of that?</p>
<p>So currying might even be extended to classes or modules, where all
methods or subs with a given argument name are curried simultaneously:</p>
<pre><code>
    my module MyIO ::= (use IO::Module).assuming(ioflags =&gt; &quot;:crlf&quot;);
    my class UltAnswer ::= (use Answer a,b,c).assuming(answer =&gt; 42);</code></pre>
<p>If you curry a class's invocant, it would turn the class into a module instead
of another class, since there are no longer any methods if there are no invocants:</p>
<pre><code>
    my module UltAnswer ::=
        (use Answer a,b,c).assuming(self =&gt; new Answer: 42);</code></pre>
<p>Or something like that.  If you think this implies that there are
class and module objects that can be sufficiently introspected to do
this sort of chicanery, you'd be right.  On the other hand, given
that we'll have module name aliasing anyway to support running multiple
versions of the same module, why not support multiple curried versions
without explicit renaming of the module:</p>
<pre><code>
    (use IO::Module).assuming(ioflags =&gt; &quot;:crlf&quot;);</code></pre>
<p>Then for the rest of this scope, IO::Module really points to your
aliased idea of IO::Module, without explicitly binding it to a
different name.  Well, that's for Apocalypse 11, really...</p>
<p>One suggestion from this RFC I've taken to heart, which is to banish
the term &quot;prototype&quot;.  You'll note we call them signatures now.
(You may still call Perl 5's prototypes &quot;prototypes&quot;, of course,
because Perl 5's prototypes really <em>were</em> a prototype of signatures.)</p>


<h4><a name="rfc_344:_elements_of_@__should_be_readonly_by_default" href="http://dev.perl.org/rfc/344.html">RFC 344: Elements of <code>@_</code> should be read-only by default</a></h4>
<p>I admit it, I waffled on this one.  Up until the last moment, I was
going to reject it, because I wanted <code>@_</code> to work exactly like it
does in Perl 5 in subs without a signature.  It seemed like a nice
sop towards backward compatibility.</p>
<p>But when I started writing about why I was rejecting it, I started
thinking about whether a sig-less sub is merely a throwback to Perl 5,
or whether we'll see it continue as a viable Perl 6 syntax.  And if
the latter, perhaps it should be designed to work right rather than
merely to work the same.  The vast majority of subroutines in Perl
5 refrain from modifying their arguments via <code>@_</code>, and it somehow
seems wrong to punish such good deeds.</p>
<p>So I changed my mind, and the default signature on a sub without
a signature is simply <code>(*@_)</code>, meaning that <code>@_</code> is considered an
array of constants by default.  This will probably have good effects
on performance, in general.  If you really want to write through
the <code>@_</code> parameter back into the actual arguments, you'll have to
declare an explicit signature of <code>(*@_ is rw)</code>.</p>
<p>The Perl5-to-Perl6 translator will therefore need to translate:</p>
<pre><code>
    sub {...}</code></pre>
<p>to:</p>
<pre><code>
    sub (*@_ is rw) {...}</code></pre>
<p>unless it can be determined that elements of <code>@_</code> are not modified
within the sub.  (It's okay to shift a constant <code>@_</code> though, since
that doesn't change the elements passed to the call; remember that
for slurpy arrays the implied &quot;<code>is constant</code>&quot; or explicit &quot;<code>is rw</code>&quot;
distributes to the individual elements.)</p>


<h4><a name="rfc_194:_standardise_function_pre_and_posthandling" href="http://dev.perl.org/rfc/194.html">RFC 194: Standardise Function Pre- and Post-Handling</a></h4>
<p>Yes, this needs to be standardized, but we'll be generalizing to the
notion of wrappers, which can automatically keep their pre and post
routines in sync, and, more importantly, keep a single lexical scope
across the related pre and post processing.  A wrapper is installed
with the <code>.wrap</code> method, which can have optional parameters to tell it
how to wrap, and which can return an identifier by which the particular
wrapper can be named when unwrapping or otherwise rearranging the
wrappings.  A wrapper automatically knows what function it's wrapped
around, and invoking the <code>call</code> builtin automatically invokes the
next level routine, whether that's the actual routine or another layer
of wrapper.  That does matter, because with that implicit knowledge
<code>call</code> doesn't need to be given the name of the routine to invoke.</p>
<dl>
<dt></dt>
<dd>
<em>The implementation is dependent on what happens to typeglobs in Perl
6, how does one inspect and modify the moral equivalent of the symbol
table?</em>
</dd>

</dl>
<p>This is not really a problem, since we've merely split the typeglob up
into separate entries.</p>
<dl>
<dt></dt>
<dd>
<em>Also: what will become of prototypes?  Will it become possible
to declare return types of functions?</em>
</dd>

</dl>
<p>Yes.  Note that if you do introspection on a sub ref, by default you're
going to get the signature and return type of the actual routine,
not of any wrappers.  There needs to be some method for introspecting
the wrappers as well, but it's not the default.</p>
<dl>
<dt></dt>
<dd>
<em>As pointed out in [JP:HWS] certain intricacies are involved: what are
the semantic of caller()?  Should it see the prehooks?  If yes, how?</em>
</dd>

</dl>
<p>It seems to me that sometimes you want to see the wrappers, and
sometimes you don't.  I think <code>caller</code> needs some kind of argument that
says which levels to recognize and which levels to ignore.  It's not
necessarily a simple priority either.  One invocation may want to find
the innermost enclosing loop, while another might want the innermost
enclosing <code>try</code> block.  A general matching term will be supplied on
such calls, defaulting to ignore the wrappers.</p>
<dl>
<dt></dt>
<dd>
<em>How does this relate to the proposed generalized want() [DC:RFC21]?</em>
</dd>

</dl>
<p>The <code>want()</code> function can be viewed as based on <code>caller()</code>, but
with a different interface to the information available at the the
particular call level.</p>
<p>I worry that generalized wrappers will make it impossible to compile
fast subroutine calls, if we always have to allow for run-time
insertion of handlers.  Of course, that's no slower than Perl 5, but
we'd like to do better than Perl 5.  Perhaps we can have the default
be to have wrappable subs, and then turn that off with specific
declarations for speed, such as &quot;<code>is inline</code>&quot;.</p>


<h4><a name="rfc_271:_subroutines_:_pre_and_post_handlers_for_subroutines" href="http://dev.perl.org/rfc/271.html">RFC 271: Subroutines : Pre- and post- handlers for subroutines</a></h4>
<p>I find it odd to propose using <code>PRE</code> for something with side effects
like flock.  Of course, this RFC was written before <code>FIRST</code> blocks
existed...</p>
<p>On the other hand, it's possible that a system of <code>PRE</code> and <code>POST</code>
blocks would need to keep &quot;dossiers&quot; of its own internal state
independent of the &quot;real&quot; data.  So I'm not exactly sure what the
effective difference is between <code>PRE</code> and <code>FIRST</code>.  But we can
always put a <code>PRE</code> into a lexical wrapper if we need to keep info
around till the <code>POST</code>.  So we can keep <code>PRE</code> and <code>POST</code> with the
semantics of simply returning boolean expressions, while <code>FIRST</code>
and <code>LAST</code> are evaluated primarily for side effects.</p>
<p>You might think that you wouldn't need a signature on any pre or post
handler, since it's gonna be the same as the primary.  However, we
have to worry about multimethods of the same name, if the handlers
are defined outside of the subroutine. Again, embedding PRE and
POST blocks either in the routine itself or inside a wrapper around
the routine should handle that.  (And turning the problem into
one of being able to generate a reference to a multimethod with
a particular signature, in essence, doing method dispatch without
actually dispatching at the end.)</p>
<p>My gut feeling is that <code>$_[-1]</code> is a bad place to keep the return
value.  With the <code>call</code> interface we're proposing, you just harvest
the return value of <code>call</code> if you're interested in the return value.
Or perhaps this is a good place for a return signature to actually
have formal variables bound to the return values.</p>
<p>Also, defining pre and post conditions in terms of exceptions is
probably a mistake.  If they're just boolean expressions, they can
be ANDed and ORed together more easily in the approved DBC fashion.</p>
<p>We haven't specified a declarative form of wrapper, merely a <code>.wrap</code>
method that you can call at run time.  However, as with most of Perl,
anything you can do at run time, you can also do at compile time, so
it'd be fairly trivial to come up with a syntax that used a <code>wrap</code>
keyword in place of a <code>sub</code>:</p>
<pre><code>
    wrap split(Regex ?$re, ?$src = $CALLER::_, ?$limit = Inf) {
        print &quot;Entering split\n&quot;;
        call;
        print &quot;Leaving split\n&quot;;
    }</code></pre>
<p>I keep mistyping &quot;wrap&quot; as &quot;warp&quot;.  I suppose that's not so far off,
actually...</p>


<h4><a name="rfc_21:_subroutines:_replace_wantarray_with_a_generic_c<want>_function" href="http://dev.perl.org/rfc/21.html">RFC 21: Subroutines: Replace <code>wantarray</code> with a generic
<code>want</code> function</a></h4>
<p>Overall, I like it, except that it's reinventing several wheels.
It seems that this has evolved into a powerful method for each sub to
do its own overloading based on return type.  How does this play with
a more declarative approach to return types?  I dunno.  For now we're
assuming multmethod dispatch only pays attention to argument types.
We might get rid of a lot of calls to <code>want</code> if we could dispatch
on return type as well.  Perhaps we could do primary dispatch on
the arguments and then do tie-breaking on return type when more
then one multimethod has the same parameter profile.</p>
<p>I also worry a bit that we're assuming an interpreter here that
<em>can</em> keep track of all the context information in a way suitable
for searching by the called subroutine.  When running on top of a
JVM or CLR, this info might not be convenient to provide, and I'd
hate to have to keep a descriptor of every call, or do some kind of
double dispatch, just because the called routine <em>might</em> want to
use <code>want()</code>, or might want to call another routine that might want
to use <code>want</code>, or so on.  Maybe the situation is not that bad.</p>
<p>I sometimes wonder if <code>want</code> should be a method on the context object:</p>
<pre><code>
    given caller.want {...}</code></pre>
<p>or perhaps the two could be coalesced into a single call:</p>
<pre><code>
    given context { ... }</code></pre>
<p>But for the moment let's assume for readability that there's a <code>want</code>
function distinct from <code>caller</code>, though with a similar signature:</p>
<pre><code>
    multi *want (?$where = &amp;CALLER::_, Int +$skip = 0, Str +$label)
        returns WantContext {...}</code></pre>
<p>As with <code>caller</code>, calling <code>want</code> with no arguments looks for
the context of the currently executing subroutine or method.
Like <code>return</code>, it specifically ignores bare blocks and routines
interpreting bare blocks, and finds the context for the lexically
enclosing explicit sub or method declaration, named by <code>&amp;_</code>.</p>
<p>You'll note that unlike in the proposal, we don't pass a list to
<code>want</code>, so we don't support the implicit <code>&amp;&amp;</code> that is proposed for
the arguments to <code>want</code>.  But that's one of the re-invented wheels,
anyway, so I'm not too concerned about that.  What we really want is
a <code>want</code> that works well with smart matching and switch statements.</p>



<h4><a name="rfc_23:_higher_order_functions" href="http://dev.perl.org/rfc/23.html">RFC 23: Higher order functions</a></h4>
<p>In general, this RFC proposes some interesting semantic sugar,
but the rules are too complicated.  There's really no need for
special numbered placeholders.  And the special <code>^_</code> placeholder is
too confusing.  Plus we really need regular sigils on our placeholder
variables so we can distinguish <code>$^x</code> from <code>@^x</code> from <code>%^x</code>.</p>
<p>But the main issue is that the RFC is confusing two separate concepts
(though that can be blamed on the languages this idea was borrowed
from).  Anyway, it turns out we'll have an explicit pre-binding method
called <code>.assuming</code> for actual currying.</p>
<p>We'll make the self-declaring parameters a separate concept, called
placeholder variables.  They don't curry.  Some of the examples of
placeholders in the RFC are actually replaced by topics and junctions
in our smart matching mode, but there are still lots of great uses
for placeholder variables.</p>


<h4><a name="rfc_176:_subroutine_/_generic_entity_documentation" href="http://dev.perl.org/rfc/176.html">RFC 176: subroutine / generic entity documentation</a></h4>
<p>This would be trivial to do with declared traits and here docs.
But it might be better to use a POD directive that is accessible to
the program.  An entity might even have implicit traits that bind
to nearby chunks of the right sort.  Maybe we could get Don Knuth
to come up with something literate...</p>


<h4><a name="rfc_298:_make_subroutines'_prototypes_accessible_from_perl" href="http://dev.perl.org/rfc/298.html">RFC 298: Make subroutines' prototypes accessible from Perl</a></h4>
<p>While I'm all in favor of a sub's signature being available for
inspection, this RFC goes beyond that to make indirection in the
signature the norm.  This seems to be a solution in search of a
problem.  I'm not sure the confusion of the indirection is worth the
ability to factor out common parameter lists.  Certainly parameter
lists must have introspection, but using it to <em>set</em> the prototype
seems potentially confusing.  That being said, the signatures are
just traits, so this may be one of those things that is permitted,
but not advised, like shooting your horse in the middle of the desert,
or chewing out your SO for burning dinner.  Implicit declaration of
lexically scoped variables will undoubtedly be considered harmful by
somebody someday.  [Damian says, &quot;Me. Today.&quot;]</p>


<h4><a name="rfc_334:_perl_should_allow_specially_attributed_subs_to_be_called_as_c_functions" href="http://dev.perl.org/rfc/334.html">RFC 334: Perl should allow specially attributed subs to be
called as C functions</a></h4>
<p>Fine, Dan, you implement it.  ;-)</p>
<p>Did I claim I ignore the names of RFC authors?  Hmm.</p>
<p>The syntax for the suggested:</p>
<pre><code>
    sub foo : C_visible(&quot;i&quot;, &quot;iii&quot;) {#sub body}</code></pre>
<p>is probably a bit more verbose in real life:</p>
<pre><code>
    my int sub foo (int $a, int $b, int $c)
         is callable(&quot;C&quot;,&quot;Python&quot;,&quot;COBOL&quot;) { ... }</code></pre>
<p>If we can't figure out the &quot;i&quot; and &quot;iii&quot; bits from introspection of
the <code>signature</code> and <code>returns</code> traits, we haven't done introspection
right.  And if we're gonna have an optional type system, I can't think
of a better place to use it than for interfaces to optional languages.</p>


<h2><a name="acknowledgements">Acknowledgements</a></h2>
<p>This work was made possible by a grant from the Perl Foundation.
I would like to thank everyone who made this dissertation possible by
their generous support.  So, I will...</p>
<p>Thank you all very, very, very, very much!!!</p>
<p>I should also point out that I would have been stuck forever on some
of these design issues without the repeated prodding (as in cattle)
of the Perl 6 design team.  So I would also like to publicly thank
Allison, chromatic, Damian, Dan, Hugo, Jarkko, Gnat, and Steve.
Thanks, you guys!  Many of the places we said &quot;I&quot; above, I should
have said &quot;we&quot;.</p>
<p>I'd like to publicly thank O'Reilly &amp; Associates for facilitating
the design process in many ways.</p>
<p>I would also like to thank my wife Gloria, but not publicly.</p>


<h2><a name="future_plans">Future Plans</a></h2>
<p>From here on out, the Apocalypses are probably going to be coming out
in priority order rather than sequential order.  The next major one
will probably be Apocalypse 12, Objects, though it may take a while
since (like a lot of people in Silicon Valley) I'm in negative cash
flow at the moment, and need to figure out how to feed my family.
But we'll get it done eventually.  Some Apocalypses might be written
by other people, and some of them hardly need to be written at all.
In fact, let's write Apocalypse 7 right now...</p>




<h1><a name="apocalypse_7:_formats">Apocalypse 7: Formats</a></h1>
<p>Gone from the core.  See Damian.</p>














<p><em>Editor's Note: this Apocalypse is out of date and remains here for historic reasons.  See <a href="http://dev.perl.org/perl6/doc/design/syn/S06.html">Synopsis 06</a> for the latest information.</em></p>

<h1><a name="appendix_a:_rationale_for_pipe_operators">Appendix A: Rationale for pipe operators</a></h1>
<p>As we pointed out in the text, the named form of passing a list has
the disadvantage that you have to know what the formal parameter's
name is.  We could get around that by saying that a null name maps
to the slurp array.  In other words, we could define a <code>=&gt;</code>
unary operator that creates a null key:</p>
<pre><code>
    stuff(@foo, =&gt;(1,2,3))</code></pre>
<p>We can at least lose the outer parens in this case:</p>
<pre><code>
    stuff @foo, =&gt;(1,2,3)</code></pre>
<p>But darn it, we can't get rid of those pesky inner parens because of
the precedence of <code>=&gt;</code> with respect to comma.  So perhaps it's
time for a new operator with looser precedence than comma:</p>
<pre><code>
    stuff @foo *: 1,2,3         # * to match * zone marker
    stuff @foo +* 1,2,3         # put the * on the list side
    stuff @foo *=&gt; 1,2,3        # or combine with =&gt; above
    stuff @foo ==&gt; 1,2,3        # maybe just lengthen =&gt;
    stuff @foo &lt;== 1,2,3        # except the dataflow is to the left
    stuff @foo with 1,2,3       # could use a word</code></pre>
<p>Whichever one we pick, it'd still probably want to construct a special
pair internally, because we have to be able to use it indirectly:</p>
<pre><code>
    @args = (\@foo, '*@' =&gt; (1,2,3));
    stuff *@args;</code></pre>
<p>But if we're going to have a special operator to switch explicitly to
the list part, it really needs to earn its keep, and do more work.
A special operator could also force scalar context on the left and
list context on the right.  So with implied scalar context we could
omit the backslash above:</p>
<pre><code>
    @args = (@foo with 1,2,3);
    stuff *@args;</code></pre>
<p>That's all well and good, and some language designers would stop
right there, if not sooner.  But if we think about this in relation
to cascaded list operators, we'll see a different pattern emerging.
Here's a left-to-right variant on the Schwartzian Transform:</p>
<pre><code>
    my @x := map {...} @input;
    my @y := sort {...} with @x;
    my @z := map {...} with @y;</code></pre>
<p>When we think of data flowing left-to-right, it's more like a pipe
operator from a shell, except that we're naming our pipes <code>@x</code>
and <code>@y</code>.  But it'd be nice not to have to name the temporary
array values.  If we do have a pipe operator in Perl, it's not going
to be <code>|</code>, for two reasons.  First, <code>|</code> is taken for junctions.
Second, piping is a big, low-precedence operation, and I want a big
fat operator that will show up to the eye.  Of our candidate list
above, I think the big, fat arrows really stand out, and look like
directed pipes.  So assuming we have the <code>==&gt;</code> operator to go
with the <code>&lt;==</code>, we could write our ST like this:</p>
<pre><code>
    @input     ==&gt;
    map {...}  ==&gt;
    sort {...} ==&gt;
    map {...}  ==&gt;
    push my @z;</code></pre>
<p>That argues that the scalar-to-list transition operator should be <code>&lt;==</code>:</p>
<pre><code>
    my @x := map {...} @input;
    my @y := sort {...} &lt;== @x;
    my @z := map {...} &lt;== @y;</code></pre>
<p>And that means this should maybe dwim:</p>
<pre><code>
    @args = (@foo &lt;== 1,2,3);
    stuff *@args;</code></pre>
<p>Hmm.</p>
<p>That does imply that <code>&lt;==</code> is (at least in this case) a data
composition operator, unlike the <code>==&gt;</code> operator which merely sends
the output of one function to the next.  Maybe that's not a problem.
But people might see:</p>
<pre><code>
    @x &lt;== 1,2,3</code></pre>
<p>and expect it does assignment when it in fact doesn't.  Internally it
would really do something more like appending a named argument:</p>
<pre><code>
    @x, '*@' =&gt; (1,2,3)</code></pre>
<p>or however we decide to mark the beginning of the &quot;real&quot; list within
a larger list.</p>
<p>But I do rather like the looks of:</p>
<pre><code>
    push @foo &lt;== 1,2,3;</code></pre>
<p>not to mention the symmetrical:</p>
<pre><code>
    1,2,3 ==&gt;
    push @foo;</code></pre>
<p>Note however that the pointy end of <code>==&gt;</code> <em>must</em> be bound to a
function that takes a list.  You can't say:</p>
<pre><code>
    1,2,3 ==&gt;
    my @foo;</code></pre>
<p>because you can't say:</p>
<pre><code>
    my @foo &lt;== 1,2,3;</code></pre>
<p>Or rather, you can, if we allow:</p>
<pre><code>
    (@foo &lt;== 1,2,3)</code></pre>
<p>but it would mean the Wrong Thing.  Ouch.  So maybe that should not
be legal.  The asymmetry was bugging me anyway.</p>
<p>So let's say that <code>&lt;==</code> and <code>==&gt;</code> must always be bound on
their pointy end to a slurpy function, and if you want to build an
indirect argument list, you have to use some kind of explicit list
function such as <code>args</code>:</p>
<pre><code>
    @args = args @foo &lt;== 1,2,3;
    stuff *@args;</code></pre>
<p>The <code>args</code> function would really be a no-op, much like other context
enforcers such as <code>scalar</code> and <code>list</code>.  In fact, I'd be tempted to
just use <code>list</code> like this:</p>
<pre><code>
    @args = list @foo &lt;== 1,2,3;</code></pre>
<p>But unless we can get people to see <code>&lt;==</code> as a strange kind of
comma, that will likely be misread as:</p>
<pre><code>
    @args = list(@foo) &lt;== 1,2,3;</code></pre>
<p>when it's really this:</p>
<pre><code>
    @args = list(@foo &lt;== 1,2,3);</code></pre>
<p>On the other hand, using <code>list</code> would cut out the need for yet another
built-in, for which there is much to be said...  I'd say, let's go
with <code>list</code> on the assumption that people <em>will</em> learn to read <code>&lt;==</code>
as a pipe comma.  If someone wants to use <code>args</code> for clarity,
they can always just alias <code>list</code>:</p>
<pre><code>
    my &amp;args ::= &amp;*list;</code></pre>
<p>More likely, they'll just use the parenthesized form:</p>
<pre><code>
    @args = list(@foo &lt;== 1,2,3);</code></pre>
<p>I suppose there could also be a prefix unary form, in case they want
to use it without scalar arguments:</p>
<pre><code>
    @args = list(&lt;== 1,2,3);</code></pre>
<p>or in case they want to put a comma after the scalar arguments:</p>
<pre><code>
    @args = list(@foo, &lt;== 1,2,3);</code></pre>
<p>In fact, it could be argued that we should <em>only</em> have the unary form,
since in this:</p>
<pre><code>
    stan @array, ollie &lt;== 1,2,3</code></pre>
<p>it's visually ambiguous whether the pointy pipe belongs to <code>stan</code> or
<code>ollie</code>.  It could be ambiguous to the compiler as well.  With a unary
operator, it unambiguously belongs to <code>ollie</code>.  You'd have to say:</p>
<pre><code>
    stan @array, ollie, &lt;== 1,2,3</code></pre>
<p>to make it belong to <code>stan</code>.  And yet, it'd be really strange for a
unary <code>&lt;==</code> to force the arguments to its left into scalar context
if the operator doesn't govern those arguments syntactically.  And I
still think I want <code>&lt;==</code> to do that.  And it's probably better to
disambiguate with parentheses anyway.  So we keep it a binary operator.
There's no unary variant, either prefix or postfix.  You can always say:</p>
<pre><code>
    list( () &lt;== 1,2,3 )
    list( @foo &lt;== () )</code></pre>
<p>Similarly, <code>==&gt;</code> is also always a binary operator.  As the
reverse of <code>&lt;==</code>, it forces its left side into list context,
and it also forces all the arguments of the list operator on the
right into scalar context.  Just as:</p>
<pre><code>
    mumble @foo &lt;== @bar</code></pre>
<p>tells you that <code>@foo</code> is in scalar context and <code>@bar</code> is in list
context regardless of the signature of mumble, so too:</p>
<pre><code>
    @bar ==&gt;
    mumble @foo</code></pre>
<p>tells you exactly the same thing.  This is particularly useful when you
have a method with an unknown signature that you have to dispatch on:</p>
<pre><code>
    @bar ==&gt;
    $objects[$x].mumble(@foo)</code></pre>
<p>The <code>==&gt;</code> unambiguously indicates that all the other arguments to
<code>mumble</code> are in scalar context.  It also allows <code>mumble</code>'s signature
to check to see if the number of scalar arguments is within the correct
range, counting only required and optional parameters, since we don't
have to allow for extra arguments to slop into the slurp array.</p>
<p>If we do want extra list arguments, we could conceivably allow both
kinds of pipe at once:</p>
<pre><code>
    @bar ==&gt;
    $objects[$x].mumble(@foo &lt;== 1,2,3)</code></pre>
<p>If we did that, it could be equivalent to either:</p>
<pre><code>
    $objects[$x].mumble(@foo &lt;== 1,2,3,@bar)</code></pre>
<p>or:</p>
<pre><code>
    $objects[$x].mumble(@foo &lt;== @bar,1,2,3)</code></pre>
<p>Since I can argue it both ways, we'll have to disallow it
entirely. <code>:-)</code></p>
<p>Seriously, the conservative thing to do is to disallow it until we
know what we want it to mean, if anything.</p>
<p>On the perl6-language list, an operator was discussed that would do
argument rearrangement, but this is a little different in that it is
constrained (by default) to operate only with the slurpy list part
of the input to a function.  This is as it should be, if you think
about it.  When you pipe things around in Unix, you don't expect
the command line switches to come in via the pipe, but from the
command line.  The scalar arguments of a list operator function as
the command line, and the list argument functions as the pipe.</p>
<p>That being said, if you want to pull the scalar arguments from the
front of the pipe, we already have a mechanism for that:</p>
<pre><code>
    @args = list(@foo &lt;== 1,2,3);
    stuff *@args;</code></pre>
<p>By extension, we also have this:</p>
<pre><code>
    list(@foo &lt;== 1,2,3) ==&gt;
      stuff *();</code></pre>
<p>So there's no need for a special syntax to put the invocant after
all the arguments.  It's just this:</p>
<pre><code>
    list(@foo &lt;== 1,2,3) ==&gt;
     $object.stuff *();</code></pre>
<p>Possibly the <code>*()</code> could be inferred in some cases, but it may be
better not to if we can't do it consistently.  If <code>stuff</code>'s signature
started with optional positional parameters, we wouldn't know whether
the pipe starts with positional arguments or list elements.  I think
that passing positionals at the front of the pipe is rare enough that
it ought to be specially marked with <code>*()</code>.  Maybe we can reduce it
to a <code>*</code>, like a unary that has an optional argument:</p>
<pre><code>
    list(@foo &lt;== 1,2,3) ==&gt;
     $object.stuff *;</code></pre>
<p>By the way, you may think that we're being silly calling these pipes,
since we're just passing lists around.  But remember that these can
potentially be lazy lists produced by a generator.  Indeed, a common
idiom might be something like:</p>
<pre><code>
    &lt;$*IN&gt; ==&gt; process() ==&gt; print;</code></pre>
<p>which arguably reads better than:</p>
<pre><code>
    print process &lt;$*IN&gt;;</code></pre>
<p>Another possibility is that we extend the argumentless <code>*</code> to mark
where the list goes in constructs that take lists but aren't officially
list operators:</p>
<pre><code>
    1,2,3 ==&gt;
    my @foo = (*)</code></pre>
<p>But maybe we should just make:</p>
<pre><code>
    1,2,3 ==&gt; my @foo;</code></pre>
<p>do what people will expect it to.  Since we require the <code>list</code>
operator for the other usage, it's easy enough to recognize that this
is not a list operator, and that we should therefore assign it.
It seems to have a kind of inevitability about it.</p>
<p>Damian: &quot;Certainly, if we don't support it, someone (*ahem*) will
immediately write:</p>
<pre><code>
    multi infix:==&gt; (Lazy $list, @array is rw) { @array = $list }
    multi infix:&lt;== (@array is rw, Lazy $list) { @array = $list }</code></pre>
<p>&quot;So we might as well make it standard.&quot;</p>
<p>On the other hand...</p>
<p>I'm suddenly wondering if assignment and binding can change precedence
on the right like list operators do if it's known we're assigning to
a list.   I, despite my credentials as TheLarry, keep finding myself
writing list assignments like this:</p>
<pre><code>
    my @foo := 0..9,'a'..'z';</code></pre>
<p>Oops.  But what if it wasn't an oops.  What if that parsed like a list
operator, and slurped up all the commas to the right?  Parens would
still be required around a list on the left though.  And it might
break weird things like:</p>
<pre><code>
    (@a = (1,2), @b = (3,4))</code></pre>
<p>But how often do you do a list assignment inside a list?  On the
other hand, making list assignment a different precedence than scalar
is weird.  But it'd have to be that way if we still wanted:</p>
<pre><code>
    ($a = 1, $b = 2)</code></pre>
<p>to work as a C programmer expects.  Still, I think I like it.  In particular,
it'd let us write what we mean explicitly:</p>
<pre><code>
    1,2,3 ==&gt;
    my @foo = *;</code></pre>
<p>So let's go ahead and do that, and then maybe someone (*ahem*) might
just forget to overload the pipe operators on arrays.*</p>
<dl>
<dt></dt>
<dd>
* The words &quot;fat&quot;, &quot;slim&quot;, and &quot;none&quot; come to mind.
</dd>

</dl>














<p><em>Editor's Note: this Apocalypse is out of date and remains here for historic reasons.  See <a href="http://dev.perl.org/perl6/doc/design/syn/S06.html">Synopsis 06</a> for the latest information.</em></p>

<h1><a name="appendix_b:_how_to_bind_strange_arguments_to_weird_parameters">Appendix B: How to bind strange arguments to weird parameters</a></h1>
<p>It may seem like the declaration syntax has too many options (and
it does), but it's actually saving you a good deal of complexity.
When you say something excruciatingly fancy like this:</p>
<pre><code>
    method x ($me: $req, ?$opt, *%named, *@list, +$namedopt) {...}</code></pre>
<p>you're actually getting a whole pile of semantics resembling this
pseudocode:</p>
<pre><code>
    method x (*@list) {
        my %named;
        my $argnum = 0;</code></pre>
<pre><code>
        # find beginning of named arguments
        while exists @list[$argnum] and @list[$argnum] !~ Pair|Hash {
            $argnum++;
            last if $argnum == 3;               # force transition to named or list
        }
        my $posmax = $argnum;</code></pre>
<pre><code>
        # pull out named actuals (pairs or hashes)
        while exists @list[$argnum] and @list[$argnum] ~~ Pair|Hash {
            %named.add(@list[$argnum++].pairs);
        }</code></pre>
<pre><code>
        # the invocant comes in like this
        my $_   := $posmax &gt; 0 ?? @list[0] :: delete %named{me}  // die &quot;Not enough args&quot;;
        my $me  := $_;                          # only if invocant declared</code></pre>
<pre><code>
        # required parameters are bound like this
        my $req := $posmax &gt; 1 ?? @list[1] :: delete %named{req} // die &quot;Not enough args&quot;;</code></pre>
<pre><code>
        # optional positional parameters are bound like this
        my $opt := $posmax &gt; 2 ?? @list[2] :: delete %named{opt};</code></pre>
<pre><code>
        # optional named parameters are bound like this
        my $namedopt := delete %named{namedopt};</code></pre>
<pre><code>
        # trim @list down to just the remaining list
        splice(@list, 0, $argnum, ());</code></pre>
<pre><code>
        if defined @list {
            die &quot;Can't have two lists&quot; if exists %named{'*@'};
        }
        else {
            @list := delete %named{'*@'} // [];
        }</code></pre>
<pre><code>
        ...     # Your ad here.
    }</code></pre>
<p>Only hopefully it runs a lot faster.  Regardless, I know which version
I'd rather write...</p>
<p>Or maintain...</p>
<p>You can get even more semantics than that if we need to process
default values or do run-time type checking.  It also gets hairier if
you have any positional parameters declared as <code>Pair</code> or <code>Hash</code>.
On the other hand, the compiler can probably optimize away lots
of the linkage code in general, particularly when it can compare
the actual arguments against the signature at compile time and, for
instance, turn named arguments into positional arguments internally.
Or prebuild a hash of the named args.  Even if it can't do that, it
could generate specially marked lists that already know where the named
arguments start and stop so we don't have to scan for those boundaries.
This gets easier if the caller marks the list part with <code>&lt;==</code>
or <code>==&gt;</code>.  Though it gets harder again if they use splat to pass
indirect positional arguments.</p>
<p>Note also that we don't necessarily have to build a real <code>%named</code>
slurphash.  The <code>%named</code> hash can just be a proxy for a function
that scans those args known to contain named arguments, whether
pairs or hashes.  In general, although there may be quite a few
optional parameters, most of them aren't set in the average call,
so the brute-force approach of scanning the call list linearly for
each possible parameter may well be faster than trying to build a
real hash (particularly if any or all of named parameters already
come in as a hash).</p>
<p>It might be tricky to make bound named arguments disappear from the
proxy hash, however.  In the code above, you'll note that we actually
delete named arguments from <code>%named</code> as we bind them to positional
parameters.  A proxy hash might have to figure out how to hide &quot;used&quot;
values somehow.  Or maybe we just leave them visible as aliases to
bound parameters.  I don't profess to know which is better.  Could be a
pragma for it...seems the usual cure for festering bogons these days...</p>
<p>In our pseudocode above, we don't ever actually evaluate the
arguments of the entire list, because it could be a generated list
like <code>1..Inf</code>, and flattening that kind of list would chew up just
a <em>wee</em> bit too much memory.  If <code>@list</code> were an ordinary array, its
boolean value would tell us if it will produce any values, but that's
not really what we want.  What we really want to know is whether the
caller specified anything, not whether what they specified is going
to produce any values.  If you say:</p>
<pre><code>
    push @foo, 1..0;</code></pre>
<p>the range doesn't generate any values, but you shouldn't look anywhere
else for the list either.  That is,</p>
<pre><code>
    1,2,3 ==&gt;
    push @foo, 1..0;</code></pre>
<p>should probably be an error.  It's equivalent to saying:</p>
<pre><code>
    push @foo, '*@'=&gt;(1,2,3), 1..0;</code></pre>
<p>or some such.  We try to catch that in our pseudocode above.</p>
<p>When you bind a lazy list to an array name such as <code>@_</code> or <code>@list</code>,
by default it's going to try to give the appearance that the array is
all there, even if behind the scenes it is having to generate values
for you.  In this case, we don't want to flatten the list, so instead
of trying to access any of the values of the variadic list, we just ask
if it is defined.  In Perl 6, an ordinary array is considered defined
if it either has some flattened arguments in it already, or it has an
associated list generator definition of how to produce more elements.
We can figure this out without changing the state of the array.</p>
<p>Contrast this with the array's boolean value, which is true only if
it is <em>known</em> that there are actual elements in the array.  If an
array has no remaining flattened elements but has a definition for how
to produce more, the boolean evaluation must evaluate the definition
sufficiently to determine whether there will be at least one more value.
In the case of a range object, it can ask the range object without
actually flattening another element, but in the limiting case of a
random generator subroutine, it would have to go ahead and call the
wretched generator to get the next flattened element, so that it
can know to return false if there were no next element.</p>
<p>Note that even the flat view of the array doesn't necessarily flatten
until you actually access the array, in which case it flattens as
much as it needs to in order to produce the value you requested,
and no more.</p>
<p>We need a name for the list of internal generators bound to the array.
Since they're behaving as specifications for the array, we'll get at
them using the predefined <code>.specs</code> method that arrays support.</p>
<p>So, for instance, if you say:</p>
<pre><code>
    my @foo := (0..9,'a'..'z');</code></pre>
<p>then:</p>
<pre><code>
    @foo.length</code></pre>
<p>would return <code>36</code>, but:</p>
<pre><code>
    @foo.specs.length</code></pre>
<p>would return 2, one for each range object.  (That's presuming you
didn't already ask for the length of the array, since in general
asking for the length of an array flattens it completely and blows
away the specs--though perhaps in this case the range specs can
calculate their lengths non-destructively.)</p>
<p>Anyway, in the absence of such a flattening event, both <code>@foo</code>
and <code>@foo.specs</code> are true.  However, if instead you'd given it a
null range:</p>
<pre><code>
    my @foo := 1..0;</code></pre>
<p>then <code>@foo.specs</code> would be true at least temporarily, but <code>@foo</code>
would be false, because the flattened list contains no values.</p>
<p>Now here's where it gets interesting.  As you process a flat array
view, the corresponding specs mutate:</p>
<pre><code>
    my @flat = 1..10;
    shift @flat;
    print @flat.specs;   # prints 2..10</code></pre>
<p>The specs aren't just a queue, but also a stack:</p>
<pre><code>
    my @flat = 1..10;
    pop @flat;
    print @flat.specs;   # prints 1..9</code></pre>
<p>Note that you can <code>pop</code> an array without committing to flattening the
entire list:</p>
<pre><code>
    my @flat = (1..Inf, 1..10);
    pop @flat;
    print @flat.specs;   # prints 1..Inf, 1..9</code></pre>
<p>If you pop the array 9 more times, the resulting null spec pops itself
from the specs list, and you get a single spec of <code>1..Inf</code> out of
<code>@flat.specs</code>.  (Continuing to pop <code>@flat</code> returns <code>Inf</code> forever,
of course, with no change to the spec.)</p>
<p>However, if you access the last element using the <em>length</em> of the
array, it may try to flatten, and fail:</p>
<pre><code>
    my @flat = (1..Inf, 1..10);
    $last = @flat[@flat - 1];   # Kaboom!</code></pre>
<p>Still, we should be able to detect the attempt to flatten an infinite
list and give a better diagnostic than Perl 5's &quot;Out of memory&quot;.
Either that, or someone should just up and figure out how to subscript
arrays using transfinite numbers.</p>














<p><em>Editor's Note: this Apocalypse is out of date and remains here for historic reasons.  See <a href="http://dev.perl.org/perl6/doc/design/syn/S06.html">Synopsis 06</a> for the latest information.</em></p>

<h1><a name="appendix_c:_hypotheticality_and_flight_recorders">Appendix C: Hypotheticality and Flight Recorders</a></h1>
<p>[This is a portion of a letter I sent to the design team.  This stuff
is still in discussion with the internals folks, so please take this
as informative rather than definitive.  But I just thought you might
like to see how sausage is made.  <code>:-)</code>  --Larry]</p>
<pre><code>
    : Seems like you're going to have to explain the C&lt;TEMP&gt;/C&lt;RESTORE&gt; 
    : relationship in A6, Larry, since C&lt;RESTORE&gt; isn't even mentioned
    : there at present.</code></pre>
<p>I'd like to explain it primarily by making both of them unnecessary
most of the time.</p>
<pre><code>
    : But maybe after a good nights sleep, eh? ;-)</code></pre>
<p>Okay, I've had a night's sleep.  Whether it was a good one remains
to be seen.  But here's what I'm after.  Forget implementation for
a moment.  What's the interface that people want, in the abstract?
You were starting to think this way yourself with &quot;<code>suppose {...}</code>&quot;.
So let's do some supposin'.</p>
<p>I'll talk about caller and callee here, but I'm really talking about
the user's abstract view vs. the user's implementation view, so it
applies to variables, lvalue routines, and rvalue routines alike.</p>
<p>On the caller side, people want to be able to make a temporary
assumption or a hypothesis.  There is some scope over which the
hypothesis is stated, and then some scope over which the hypothesis
is assumed.  At the end of that scope, the hypothesis may or may
not be retracted.  (I'm trying not to state this in terms of <code>temp</code>
and <code>let</code>, just to keep our current ideas out of it.)</p>
<p>Historically, the scope of the hypothesis <em>statement</em> is a single
variable/value, because <code>local</code> only knew how to temporize that kind
of thing.  The scope of the hypothesis assumption has always extended
to the end of the current dynamic scope.</p>
<p>In the very abstract view, supposing is a transactional function with
two arguments, the first one of which establishes a scope in which
any state change is labelled as provisional.  The second argument
establishes a scope in which we work out the ramifications of that
supposing, which may include other supposings.  In classical terms,
they're the <em>protasis</em> and <em>apodosis</em>:</p>
<pre><code>
    suppose { &lt;pro&gt; } { &lt;apo&gt; }</code></pre>
<p>At the end of the second scope we decide whether to succeed or fail.
On failure, we unsuppose everything that was supposed from the
beginning, and upon success, we allow certain new &quot;facts&quot; to leak
out into a larger reality (which may itself be a hypothesis, but
leave that aside for the moment).  It's basically commit/rollback.</p>
<p>It could also be written:</p>
<pre><code>
    suppose &lt;pro&gt; {
        &lt;apo&gt;
    }</code></pre>
<p>to make it look more like an <code>if</code>.  But up till now we've written it:</p>
<pre><code>
    {
        temp &lt;pro&gt;;
        &lt;apo&gt;
    }</code></pre>
<p>which actually works out fine as a syntax, since every statement
is in a sense conditional on preceding statements.  If we want to
allow a hypothetical result to leak out, we use &quot;let&quot; instead of
&quot;temp&quot;.  Whatever.  I'm not caring about the syntax yet, just the
abstract interface.</p>
<p>And the abstract interface wants both &lt;pro&gt; and &lt;apo&gt; to be as
general as possible.  We already have a completely general &lt;apo&gt;,
but we've severely restricted the &lt;pro&gt; so far to be (in Perl 5)
a storage location, or in Perl 6 (Seb), anything with a <code>.TEMP</code>
method.  You'd like to be able to turn anything involving state
changes into an &lt;pro&gt;, but we can't.  We can only do it to values
that cooperate.</p>
<p>So the real question is what does cooperation look like from the
&quot;callee&quot; end of things?  What's the best interface for cooperating?
I submit that the best interface for that does not look like
<code>TEMP =&gt; {}</code>, or <code>RESTORE {}</code>.  It looks like nothing at all!</p>
<pre><code>
    sub foo { $x = 1234; }
    $x = 0;
    {
        temp foo();
        print $x;       # prints 1234
    }
    print $x;           # prints 0</code></pre>
<p>How might this work in practice?  If Perl (as a language) is aware
of when it is making a state change, and if it also aware of when it
is doing so in a hypothetical context (*any* hypothetical context in
the dynamic scope), then Perl (as a language) can save its own record
of that state change, filing it with the proper hypothetical context
management authorities, to be undone (or committed) at the appropriate
moment.</p>
<p>That's fine as long as we're running in Perl.  Where an explicit <code>TEMP</code>
method is useful is in the interface to foreign code or data that
doesn't support dynamically scoped hypotheticality.  If a Proxy is
proxying for a Perl variable or attribute, however, then the <code>STORE</code>
already knows its dynamic context, and handles <code>temp</code> and <code>let</code>
implicitly just as any other Perl code running in hypothetical context
would.</p>
<p>As for a hypothesis within a hypothesis, I think it just means that
when you refrain from <code>UNDO</code>ing the <code>let</code> state changes, you actually
<code>KEEP</code> them into a higher undo list, if there is one.  (In practice,
this may mean there aren't separate <code>LAST</code> and <code>UNDO</code> lists.  Just a <code>LAST</code>
list, in which some entries do a <code>KEEP</code> or <code>UNDO</code> at the last moment.
Otherwise a <code>let</code> within a <code>let</code> has to poke something onto both a
keep list and an undo list.  But maybe it comes out to the same thing.)</p>
<p>(In any event, we do probably need a name for the current innermost
supposition we're in the dynamic scope of.  I have my doubts that <code>$?_</code>
is that name, however.  <code>$0</code> is closer to it.  Can thrash that out later.)</p>
<p>That's all very powerful.  But here's where it borders on disruptive
technology.  I mentioned a while back the talk by Todd A. Proebsting
on Disruptive Language Technologies.  In it he projects which
new disruptive language technologies will take over the world someday.
The one that stuck in my head was the flight data recorder, where
every state change for the last N instructions was recorded for
analysis in case of failure.  Sound familiar?</p>
<p>Taken together with my hypotheticality hypothesis, I think this likely
indicates a two-birds-with-one-stone situation that we must design for.
If state changes are automatically stored in a type-appropriate
manner, we don't necessarily have to generate tons of artificial
closures merely to create artificial lexical variables just so we
have them around later at the right moment.  I don't mind writing
double closures for things like macros, where they're not in hot code.
But <code>let</code> and friends need to be blazing fast if we're ever going to
use Perl for logic programming, or even recursive descent parsing.
And if we want a flight data recorder, it had better not hang on
the outside of the airplane where it'll induce drag.</p>
<p>And that's what I think is wrong with our Sebastopolian formulation
of <code>.TEMP</code>.  Am I making any sense?</p>
<p>Larry</p>

        </div>



    </div>
    <div class="asset-footer"></div>
</div>


                            
                            <div id="entry-1082" class="entry-asset asset hentry">
    <div class="asset-header">
        <h2 class="asset-name entry-title"><a href="/pub/2003/03/04/mod_perl.html" rel="bookmark">Improving mod_perl Sites' Performance: Part 8</a></h2>
        <div class="asset-meta">
            <span class="byline">
    
                By <span class="vcard author">Stas Bekman</span> on <abbr class="published" title="2003-03-04T00:00:00-08:00">March  4, 2003 12:00 AM</abbr>
    
            </span>

            
            

        </div>
    </div>
    <div class="asset-content entry-content">

        <div class="asset-body">
            
<!-- sidebar begins -->
<!-- don't move sidebars -->
<!-- sidebar ends -->


<p>In this article we continue talking about how to optimize your site
for performance without touching code, buying new hardware or telling
casts. A few simple <em>httpd.conf</em> configuration changes can improve the
performance tremendously.</p>


<h3><a name="choosing_minspareservers,_maxspareservers_and_startservers">Choosing MinSpareServers, MaxSpareServers and StartServers</a></h3>
<p>With mod_perl enabled, it might take as much as 20 seconds from the
time you start the server until it is ready to serve incoming
requests.  This delay depends on the OS, the number of preloaded
modules and the process load of the machine.  It's best to set
<a href="#item_startservers"><code>StartServers</code></a> and <a href="#item_minspareservers"><code>MinSpareServers</code></a> to high numbers, so that if you
get a high load just after the server has been restarted, the fresh
servers will be ready to serve requests immediately.  With mod_perl,
it's usually a good idea to raise all three variables higher than normal.</p>
<p>In order to maximize the benefits of mod_perl, you don't want to kill
servers when they are idle, rather you want them to stay up and
available to handle new requests immediately.  I think an ideal
configuration is to set <a href="#item_minspareservers"><code>MinSpareServers</code></a> and <a href="#item_maxspareservers"><code>MaxSpareServers</code></a> to
similar values, maybe even the same.  Having the <a href="#item_maxspareservers"><code>MaxSpareServers</code></a>
close to <a href="#item_maxclients"><code>MaxClients</code></a> will completely use all of your resources (if
<a href="#item_maxclients"><code>MaxClients</code></a> has been chosen to take the full advantage of the
resources), but it'll make sure that at any given moment your system
will be capable of responding to requests with the maximum speed
(assuming that number of concurrent requests is not higher than
<a href="#item_maxclients"><code>MaxClients</code></a>).</p>
<p>Let's try some numbers.  For a heavily loaded Web site and a dedicated
machine, I would think of (note 400Mb is just for example):</p>
<pre><code>
  Available to webserver RAM:   400Mb
  Child's memory size bounded:  10Mb
  MaxClients:                   400/10 = 40 (larger with mem sharing)
  StartServers:                 20
  MinSpareServers:              20
  MaxSpareServers:              35</code></pre>
<p>However, if I want to use the server for many other tasks, but make it
capable of handling a high load, I'd try:</p>
<pre><code>
  Available to webserver RAM:   400Mb
  Child's memory size bounded:  10Mb
  MaxClients:                   400/10 = 40
  StartServers:                 5
  MinSpareServers:              5
  MaxSpareServers:              10</code></pre>
<p>These numbers are taken off the top of my head, and shouldn't be used
as a rule, but rather as examples to show you some possible scenarios.
Use this information with caution.</p>

<csperl file="grab" domain="on" record="b/832" template="b/article_sidebar2.view">

<h3><a name="summary_of_benchmarking_to_tune_all_5_parameters">Summary of Benchmarking to Tune All 5 Parameters</a></h3>
<p>OK, we've run various benchmarks -- let's summarize the conclusions:</p>
<ul>
<li><strong><a name="item_maxrequestsperchild">MaxRequestsPerChild</a></strong><br />

If your scripts are clean and don't leak memory, then set this variable to
a number as large as possible (10000?). If you use
<code>Apache::SizeLimit</code>, then you can set this parameter to 0 (treated as
infinity). You will want this parameter to be smaller if your code
becomes gradually more unshared over the process' life. As well as this,
<code>Apache::GTopLimit</code>
can help, with its shared memory limitation feature.</li>


<li><strong><a name="item_startservers">StartServers</a></strong><br />

If you keep a small number of servers active most of the time, then keep
this number low.  Keep it low especially if <a href="#item_maxspareservers"><code>MaxSpareServers</code></a> is also
low, as if there is no load, Apache will kill its children before they
have been utilized at all. If your service is heavily loaded, then make
this number close to <a href="#item_maxclients"><code>MaxClients</code></a>, and keep <a href="#item_maxspareservers"><code>MaxSpareServers</code></a> equal
to <a href="#item_maxclients"><code>MaxClients</code></a>.</li>


<li><strong><a name="item_minspareservers">MinSpareServers</a></strong><br />

If your server performs other work besides Web serving, then make this low
so the memory of unused children will be freed when the load is light.
If your server's load varies (you get loads in bursts) and you want
fast response for all clients at any time, then you will want to make it
high, so that new children will be respawned in advance and are
waiting to handle bursts of requests.</li>


<li><strong><a name="item_maxspareservers">MaxSpareServers</a></strong><br />

The logic is the same as for <a href="#item_minspareservers"><code>MinSpareServers</code></a> - low if you need the
machine for other tasks, high if it's a dedicated Web host and you
want a minimal delay between the request and the response.</li>


<li><strong><a name="item_maxclients">MaxClients</a></strong><br />

Not too low, so you don't get into a situation where clients are
waiting for the server to start serving them (they might wait, but not
for very long).  However, do not set it too high.  With a high
MaxClients, if you get a high load, then the server will try to serve all
requests immediately.  Your CPU will have a hard time keeping up, and
if the child size * number of running children is larger than the
total available RAM, then your server will start swapping.  This will slow
down everything, which in turn will make things even slower, until
eventually your machine will die.  It's important that you take pains
to ensure that swapping does not normally happen.  Swap space is an
emergency pool, not a resource to be used routinely. If you are low on
memory and you badly need it, then buy it.  Memory is cheap.
<p>But based on the test I conducted above, even if you have plenty of
memory like I have (1Gb), increasing <a href="#item_maxclients"><code>MaxClients</code></a> sometimes will give
you no improvement in performance.  The more clients are running, the
more CPU time will be required, the less CPU time slices each process
will receive.  The response latency (the time to respond to a request)
will grow, so you won't see the expected improvement.  The best
approach is to find the minimum requirement for your kind of service
and the maximum capability of your machine.  Then start at the minimum
and test as I did, successively raising this parameter until you
find the region on the curve of the graph of latency and/or throughput
against MaxClients where the improvement starts to diminish.  Stop
there and use it.  When you make the measurements on a production
server you will have the ability to tune them more precisely, since
you will see the real numbers.</p>
<p>Don't forget that if you add more scripts, or even just modify the
existing ones, then the processes will grow in size as you compile in more
code.  When you do this, your parameters probably will need to be recalculated.</p></li>

</ul>


<h3><a name="keepalive">KeepAlive</a></h3>
<p>If your mod_perl server's <em>httpd.conf</em> includes the following
directives:</p>
<pre><code>
  KeepAlive On
  MaxKeepAliveRequests 100
  KeepAliveTimeout 15</code></pre>
<p>you have a real performance penalty, since after completing the
processing for each request, the process will wait for
<code>KeepAliveTimeout</code> seconds before closing the connection and will
therefore not be serving other requests during this time.  With this
configuration, you will need many more concurrent processes on a server
with high traffic.</p>
<p>If you use some server status reporting tools, then you will see the
process in <em>K</em> status when it's in <code>KeepAlive</code> status.</p>
<p>The chances are that you don't want this feature enabled. Set it Off
with:</p>
<pre><code>
  KeepAlive Off</code></pre>
<p>The other two directives don't matter if <code>KeepAlive</code> is <code>Off</code>.</p>
<p>You might want to consider enabling this option if the client's
browser needs to request more than one object from your server for a
single HTML page.  If this is the situation, then by setting
<code>KeepAlive</code> <code>On</code> you will save
the HTTP connection overhead for all requests but the first one for each
page.</p>
<p>For example: If you have a page with 10 ad banners, which is not
uncommon today, then your server will work more effectively if a single
process serves them all during a single connection.  However, your
client will see a slightly slower response, since banners will be
brought one at a time and not concurrently as is the case if each
<code>IMG</code> tag opens a separate connection.</p>
<p>Since keepalive connections will not incur the additional three-way
TCP handshake, turning it on will be kinder to the network.</p>
<p>SSL connections benefit the most from <code>KeepAlive</code> in cases
where you haven't configured the server to cache session ids.</p>
<p>You have probably followed the usual advice to send all the requests for
static objects to a plain Apache server.  Since most pages include
more than one unique static image, you should keep the default
<code>KeepAlive</code> setting of the non-mod_perl server, i.e. keep it <code>On</code>.
It will probably be a good idea also to reduce the timeout a little.</p>
<p>One option would be for the proxy/accelerator to keep the connection
open to the client but make individual connections to the server, read
the response, buffer it for sending to the client and close the server
connection.  Obviously, you would make new connections to the server as
required by the client's requests.</p>
<p>Also, you should know that <code>KeepAlive</code> requests only work with
responses that contain a <code>Content-Length</code> header. To send this header
do:</p>
<pre><code>
  $r-&gt;header_out('Content-Length', $length);</code></pre>


<h3><a name="perlsetupenv_off">PerlSetupEnv Off</a></h3>
<p><code>PerlSetupEnv Off</code> is another optimization you might consider. This
directive requires mod_perl 1.25 or later.</p>
<p><em>mod_perl</em> fiddles with the environment to make it appear as if the
script were being called under the CGI protocol.  For example, the
<code>$ENV{QUERY_STRING}</code> environment variable is initialized with the
contents of <em>Apache::args()</em>, and the value returned by
<em>Apache::server_hostname()</em> is put into <code>$ENV{SERVER_NAME}</code>.</p>
<p>But <code>%ENV</code> population is expensive.  Those who have moved to the Perl
Apache API no longer need this extra <code>%ENV</code> population, and can gain by
turning it <strong>Off</strong>. Scripts using the <code>CGI.pm</code> module require
<code>PerlSetupEnv On</code> because that module relies on a properly populated
CGI environment table.</p>
<p>By default it is "On."</p>
<p>Note that you can still set environment variables.  For example, when
you use the following configuration:</p>
<pre><code>
  PerlSetupEnv Off
  PerlModule Apache::RegistryNG
  &lt;Location /perl&gt;
    PerlSetupEnv On
    PerlSetEnv TEST hi
    SetHandler perl-script
    PerlHandler Apache::RegistryNG
    Options +ExecCGI
  &lt;/Location&gt;</code></pre>
<p>and issue a request (for example
<a href="http://localhost/perl/setupenvoff.pl)">http://localhost/perl/setupenvoff.pl)</a> for this script:</p>
<pre><code>
  setupenvoff.pl
  --------------
  use Data::Dumper;
  my $r = Apache-&gt;request();
  $r-&gt;send_http_header('text/plain');
  print Dumper(\%ENV);</code></pre>
<p>you should see something like this:</p>
<pre><code>
  $VAR1 = {
            'GATEWAY_INTERFACE' =&gt; 'CGI-Perl/1.1',
            'MOD_PERL' =&gt; 'mod_perl/1.25',
            'PATH' =&gt; '/usr/lib/perl5/5.00503:... snipped ...',
            'TEST' =&gt; 'hi'
          };</code></pre>
<p>Notice that we have got the value of the environment variable <em>TEST</em>.</p>
















<h3><a name="reducing_the_number_of_stat()_calls_made_by_apache">Reducing the Number of <code>stat()</code> Calls Made by Apache</a></h3>

<p>If you watch the system calls that your server makes (using <em>truss</em>
or <em>strace</em>) while processing a request, then you will notice that a few
<code>stat()</code> calls are made. For example, when I fetch
http://localhost/perl-status and I have my DocRoot set to
<em>/home/httpd/docs</em> I see:</p>
<pre><code>
  [snip]
  stat(&quot;/home/httpd/docs/perl-status&quot;, 0xbffff8cc) = -1 
                      ENOENT (No such file or directory)
  stat(&quot;/home/httpd/docs&quot;, {st_mode=S_IFDIR|0755, 
                                 st_size=1024, ...}) = 0
  [snip]</code></pre>
<p>If you have some dynamic content and your virtual relative URI is
something like <em>/news/perl/mod_perl/summary</em> (i.e., there is no such
directory on the web server, the path components are only used for
requesting a specific report), then this will generate <code>five(!)</code> <code>stat()</code>
calls, before the <code>DocumentRoot</code> is found. You will see something
like this:</p>
<pre><code>
  stat(&quot;/home/httpd/docs/news/perl/mod_perl/summary&quot;, 0xbffff744) = -1 
                      ENOENT (No such file or directory)
  stat(&quot;/home/httpd/docs/news/perl/mod_perl&quot;,         0xbffff744) = -1
                      ENOENT (No such file or directory)
  stat(&quot;/home/httpd/docs/news/perl&quot;,                  0xbffff744) = -1
                      ENOENT (No such file or directory)
  stat(&quot;/home/httpd/docs/news&quot;,                       0xbffff744) = -1
                      ENOENT (No such file or directory)
  stat(&quot;/home/httpd/docs&quot;, 
                      {st_mode=S_IFDIR|0755, st_size=1024, ...})  =  0</code></pre>
<p>How expensive are those calls? Let's use the <code>Time::HiRes</code> module to
find out.</p>
<pre><code>
  stat_call_sample.pl
  -------------------
  use Time::HiRes qw(gettimeofday tv_interval);
  my $calls = 1_000_000;
  
  my $start_time = [ gettimeofday ];
  
  stat &quot;/app&quot; for 1..$calls;
  
  my $end_time = [ gettimeofday ];
  
  my $elapsed = tv_interval($start_time,$end_time) / $calls;
  
  print &quot;The average execution time: $elapsed seconds\n&quot;;</code></pre>
<p>This script takes a time sample at the beginning, then does 1,000,000
<code>stat()</code> calls to a nonexisting file, samples the time at the end
and prints the average time it took to make a single <code>stat()</code> call.
I'm sampling a million stats, so I'd get a correct average result.</p>
<p>Before we actually run the script, one should distinguish between two
different situations. When the server is idle, the time between the
first and the last system call will be much shorter than the same time
measured on the loaded system. That is because on the idle system, a
process can use CPU very often, and on the loaded system lots of
processes compete over it and each process has to wait for a longer
time to get the same amount of CPU time.</p>
<p>So first we run the above code on the unloaded system:</p>
<pre><code>
  % perl stat_call_sample.pl
  The average execution time: 4.209645e-06 seconds</code></pre>
<p>So it takes about 4 microseconds to execute a <code>stat()</code> call. Now let's
start a CPU intensive process in one console. The following code keeps
the CPU busy all the time.</p>
<pre><code>
  % perl -e '1**1 while 1'</code></pre>
<p>And now run the <em>stat_call_sample.pl</em> script in the other console.</p>
<pre><code>
  % perl stat_call_sample.pl
  The average execution time: 8.777301e-06 seconds</code></pre>
<p>You can see that the average time has more than doubled (about 8
microseconds). And this is obvious, since there were two processes
competing for the CPU. Now if we run 4 occurrences of the above code:</p>
<pre><code>
  % perl -e '1**1 while 1' &amp;
  % perl -e '1**1 while 1' &amp;
  % perl -e '1**1 while 1' &amp;
  % perl -e '1**1 while 1' &amp;</code></pre>
<p>And when running our script in parallel with these processes, we get:</p>
<pre><code>
  % perl stat_call_sample.pl
  2.0853558e-05 seconds</code></pre>
<p>about 20 microseconds. So the average <code>stat()</code> system call is five times
longer now. Now, if you have 50 mod_perl processes that keep the CPU
busy all the time, the <code>stat()</code> call will be 50 times slower and it'll
take 0.2 milliseconds to complete a series of call. If you have five
redundant calls as in the strace example above, then they add up to 1
millisecond. If you have more processes constantly consuming CPU, then this
time adds up. Now multiply this time by the number of processes that
you have and you get a few seconds lost. As usual, for some services,
this loss is insignificant, while for others a very significant one.</p>
<p>So why does Apache make all these redundant <code>stat()</code> calls?  You can blame
the default installed <code>TransHandler</code> for this inefficiency.  Of
course, you could supply your own, which will be smart enough not to
look for this virtual path and immediately return <code>OK</code>. But in cases
where you have a virtual host that serves only dynamically generated
documents, you can override the default <code>PerlTransHandler</code> with this
one:</p>
<pre><code>
  &lt;VirtualHost 10.10.10.10:80&gt;
    ...
    PerlTransHandler  Apache::OK
    ...
  &lt;/VirtualHost&gt;</code></pre>
<p>As you see it affects only this specific virtual host.</p>
<p>This has the effect of short circuiting the normal <code>TransHandler</code>
processing of trying to find a filesystem component that matches the
given URI -- no more 'stat's!</p>
<p>Watching your server under strace/truss can often reveal more
performance hits than trying to optimize the code itself!</p>
<p>For example, unless configured correctly, Apache might look for the
<em>.htaccess</em> file in many places, even if you don't have one, and
make many unnecessary
<code>open()</code> calls.</p>
<p>Let's start with this simple configuration. We will try to reduce the
number of irrelevant system calls.</p>
<pre><code>
  DocumentRoot &quot;/home/httpd/docs&quot;
  &lt;Location /app/test&gt;
    SetHandler perl-script
    PerlHandler Apache::MyApp
  &lt;/Location&gt;</code></pre>
<p>The above configuration allows us to make a request to <em>/app/test</em>
and the Perl <code>handler()</code> defined in <code>Apache::MyApp</code> will be
executed. Notice that in the test setup there is no file to be
executed (like in <code>Apache::Registry</code>). There is no <em>.htaccess</em> file
as well.</p>
<p>This is a typical generated trace.</p>
<pre><code>
  stat(&quot;/home/httpd/docs/app/test&quot;, 0xbffff8fc) = -1 ENOENT 
        (No such file or directory)
  stat(&quot;/home/httpd/docs/app&quot;,      0xbffff8fc) = -1 ENOENT 
        (No such file or directory)
  stat(&quot;/home/httpd/docs&quot;, 
        {st_mode=S_IFDIR|0755, st_size=1024, ...}) = 0
  open(&quot;/.htaccess&quot;, O_RDONLY)                 = -1 ENOENT 
        (No such file or directory)
  open(&quot;/home/.htaccess&quot;, O_RDONLY)            = -1 ENOENT 
        (No such file or directory)
  open(&quot;/home/httpd/.htaccess&quot;, O_RDONLY)      = -1 ENOENT 
        (No such file or directory)
  open(&quot;/home/httpd/docs/.htaccess&quot;, O_RDONLY) = -1 ENOENT 
        (No such file or directory)
  stat(&quot;/home/httpd/docs/test&quot;, 0xbffff774)    = -1 ENOENT 
        (No such file or directory)
  stat(&quot;/home/httpd/docs&quot;, 
        {st_mode=S_IFDIR|0755, st_size=1024, ...}) = 0</code></pre>
<p>Now we modify the <code>&lt;Directory&gt;</code> entry and add AllowOverride&nbsp;None,
which among other things disables <em>.htaccess</em> files and will not try
to open them.</p>
<pre><code>
  &lt;Directory /&gt;
    AllowOverride None
  &lt;/Directory&gt;</code></pre>
<p>We see that the four <code>open()</code> calls for <em>.htaccess</em>
have gone:</p>
<pre><code>
  stat(&quot;/home/httpd/docs/app/test&quot;, 0xbffff8fc) = -1 ENOENT 
        (No such file or directory)
  stat(&quot;/home/httpd/docs/app&quot;,      0xbffff8fc) = -1 ENOENT 
        (No such file or directory)
  stat(&quot;/home/httpd/docs&quot;, 
        {st_mode=S_IFDIR|0755, st_size=1024, ...}) = 0
  stat(&quot;/home/httpd/docs/test&quot;, 0xbffff774)    = -1 ENOENT 
        (No such file or directory)
  stat(&quot;/home/httpd/docs&quot;, 
        {st_mode=S_IFDIR|0755, st_size=1024, ...}) = 0</code></pre>
<p>Let's try to shortcut the <em>app</em> location with:</p>
<pre><code>
  Alias /app /</code></pre>
<p>Which makes Apache to look for the file in the <em>/</em> directory and not
under <em>/home/httpd/docs/app</em>. Let's run it:</p>
<pre><code>
  stat(&quot;//test&quot;, 0xbffff8fc) = -1 ENOENT (No such file or directory)</code></pre>
<p>Wow, we've got only one stat call left!</p>
<p>Let's remove the last <code>Alias</code> setting and use:</p>
<pre><code>
    PerlTransHandler  Apache::OK</code></pre>
<p>as explained above. When we issue the request, we see no <code>stat()</code>
calls. But this is possible only if you serve only dynamically
generated documents, i.e. no CGI scripts. Otherwise, you will have to
write your own <em>PerlTransHandler</em> to handle requests as desired.</p>
<p>For example, this <em>PerlTransHandler</em> will not lookup the file on the
filesystem if the URI starts with <em>/app</em>, but will use the default
<em>PerlTransHandler</em> otherwise:</p>
<pre><code>
  PerlTransHandler 'sub { return shift-&gt;uri() =~ m|^/app| \
                        ? Apache::OK : Apache::DECLINED;}'</code></pre>
<p>Let's see the same configuration using the <code>&lt;Perl&gt;</code> section and a
dedicated package:</p>
<pre><code>
  &lt;Perl&gt;  
    package My::Trans;
    use Apache::Constants qw(:common);
    sub handler{
       my $r = shift;
       return OK if $r-&gt;uri() =~ m|^/app|;
       return DECLINED;
    }</code></pre>
<pre><code>
    package Apache::ReadConfig;  
    $PerlTransHandler = &quot;My::Trans&quot;;
  &lt;/Perl&gt;</code></pre>
<p>As you see we have defined the <code>My::Trans</code> package and implemented
the <code>handler()</code> function. Then we have assigned this handler to the
<code>PerlTransHandler</code>.</p>
<p>Of course you can move the code in the module into an external file,
(e.g. <em>My/Trans.pm</em>) and configure the <code>PerlTransHandler</code> with</p>
<pre><code>
  PerlTransHandler My::Trans</code></pre>
<p>in the normal way (no <code>&lt;Perl&gt;</code> section required).</p>


<hr />
<h1><a name="references">References</a></h1>
<ul>
<li>
The mod_perl site's URL: <a href="http://perl.apache.org/">http://perl.apache.org/</a></li>


<li>
<code>Time::HiRes</code>:
<a href="http://search.cpan.org/search?dist=Time-HiRes">http://search.cpan.org/search?dist=Time-HiRes</a></li>

</ul>


        </div>



    </div>
    <div class="asset-footer"></div>
</div>


                            
                            <div id="entry-1092" class="entry-asset asset hentry">
    <div class="asset-header">
        <h2 class="asset-name entry-title"><a href="/pub/2003/03/p6pdigest/20030302.html" rel="bookmark">This week on Perl 6, week ending 2003-03-02</a></h2>
        <div class="asset-meta">
            <span class="byline">
    
                By <span class="vcard author">Piers Cawley</span> on <abbr class="published" title="2003-03-03T00:00:00-08:00">March  3, 2003 12:00 AM</abbr>
    
            </span>

            
            

        </div>
    </div>
    <div class="asset-content entry-content">

        <div class="asset-body">
            
<!-- sidebar begins -->
<!-- don't move sidebars -->
<!-- sidebar ends -->

<p>Welcome back to another episode in the ongoing saga that is the Perl 6
development process (or at least my attempt to describe it).</p>
<p>We kick off with perl6-internals.</p>


<h4><a name="imcc_calling_conventions">IMCC calling conventions</a></h4>
<p>Piers Cawley attempted to describe tail call optimizations, why they
were a good thing and why a caller saves calling convention made such
optimizations easier (possible?). He wondered if he hadn't just
succeeded in muddying the waters still further. Jerome Vouillon
appeared to understand what Piers was going on about and pointed out
that a caller saves scheme also helps with exception
handling. Benjamin Goldberg wondered about Perl 5's <code>goto &amp;func</code>
semantics which can be looked at as a 'sort of' tail call (except you
don't actually get much of an optimization with Perl 5 as it stands)
and proposed a callee saves scheme for doing tail call optimization
which didn't optimize away an unnecessary pair of save/restores. Dan
pointed out that, while <code>goto &amp;func</code> (which is sort of like tail call
optimization in Perl 5) would have to be supported, tail call
optimization made more sense if you didn't have to use any special
syntax to make use of it.</p>
<p><a href="http://groups.google.com/groups?threadm=m2el5xzix5.fsf%40TiBook.bofh.org.uk">http://groups.google.com/groups</a></p>


<h4><a name="a_couple_of_easy_questions...">A couple of easy questions...</a></h4>
<p>David (Cuny?) wondered how he could determine the data type of an
arbitrary PMC and whether there were any pre-built Windows binaries of
Parrot available. Leon Brocard pointed him at the <code>typeof</code> operator
in answer to the first question but punted on the second. Leo
T&ouml;tsch also pointed at <code>typeof</code>. David noted that it didn't
seem to be available in his 0.0.9 installation and was recommended to
use the CVS version, and discussion drifted toward wondering when
Parrot 0.1.0 would see the light of day. (Not before at least one of
either objects or exceptions is implemented apparently).</p>
<p>Nobody answered the 'pre built Windows binary' part of David's
question.</p>
<p><a href="http://groups.google.com/groups?threadm=200302250146.32194.dcuny%40lanset.com">http://groups.google.com/groups</a></p>


<h4><a name="more_on_optimizing_the_jit_with_imcc">More on optimizing the JIT with IMCC</a></h4>
<p>In last week's summary I mentioned that Sean O'Rourke had suggested
getting IMCC to store a control flow graph in bytecode, which the JIT
could use to optimize things more effectively. Sean read this and
pointed out that it wasn't his idea but was actually an area of active
research and gave a pointer to some information. He also pointed to a
USENIX paper which discussed adding a full data-flow compiler into a
JVM which could then generate code that ran faster than a lightweight
JIT, especially for long-running programs. Sean's original link was to
a subscription only site but Jason 'Research wants to be free' Gloudon
found a public version of the paper. Dan was fascinated, but was
worried about availability of engineering time, not wishing to presume
on Leo, Daniel and everyone who's done JIT work.</p>
<p>Dan said that he'd 'rather have a lower-overhead JIT with a win for
shorter programs than a high-overhead one with a win for long-running
programs'. Leo pointed out that, at the moment we already have a high
overhead JIT with most of the cost paid at load time and showed some
of these costs. Dan and Leo then discussed what kind of metadata would
be needed from IMCC (or some external tool) in order to improve
matters.</p>
<p>Meanwhile, the original 'Using IMCC as JIT optimizer' thread continued
as Leo committed some more changes both to code and to the
documentation in <em>jit.pod</em>. The new version of the JIT optimizing
IMCC should be platform independent and apparently runs 95% of
Parrot's tests on an i386.</p>
<p>Phil Hassey wondered why we even had a set number of registers in the
JVM in the first place. He wondered if it would be possible to have
each block of code declare 'I need 12 registers for this bloc' and let
the JIT system do the appropriate register spilling magic with the
system registers. Leo said that this is approximately what the JIT
optimizer does at the moment and outlined some of the problems
associated with it.</p>
<p>Angel Faus had some questions and suggestions about the optimization
approach that Leo was taking, with particular reference to the amount
of copies to and from memory and proposed an efficient way
forward. Nicholas Clark wondered if some of Angel's suggestions mean
that imc (IMCC source code) had now usurped the role of parrot bytecode
and muttered something about premature optimization and the lack of
objects, exceptions, IO or a Z-code interpreter. Leo bridled slightly
at 'premature optimization' and wondered what was important about a
Z-code interpreter ('Z-code interpreter' is, according to Nicholas,
'obfuscated shorthand for ``dynamic opcode libraries'' and ``reading
foreign bytecode''.')</p>
<p>Toward the end of the week, Leo checked in a final patch related to
this experiment and commented that, to do things <em>right</em>, JIT
optimization should move in the direction that Angel Faus had
outlined.</p>
<p><a href="http://groups.google.com/groups?threadm=Pine.GSO.4.32.0302260915220.20398-100000%40gradlab.ucsd.edu">http://groups.google.com/groups</a></p>
<p><a href="http://citeseer.nj.nec.com/krintz01using.html">http://citeseer.nj.nec.com/krintz01using.html</a> -- Sean's first link</p>
<p><a href="http://www-hydra.stanford.edu/publications/JVM02.pdf">http://www-hydra.stanford.edu/publications/JVM02.pdf</a> -- 'Free'
paper</p>
<p><a href="http://groups.google.com/groups?threadm=3E5B428A.8020809%40toetsch.at">http://groups.google.com/groups</a> -- IMCC as JIT Optimizer thread</p>
<p><a href="http://groups.google.com/groups?threadm=3E5F6F31.4010801%40toetsch.at">http://groups.google.com/groups</a> -- Leo's Last (-Oj) patch</p>


<h4><a name="parrot_0.0.10_freeze">Parrot 0.0.10 freeze</a></h4>
<p>Steve Fink announced that it had been brought to his attention that we
were overdue for another release and announced that he'd like to have
a Parrot feature freeze on March 8, with a Parrot 0.0.10 release a
week after that (or a Parrot 0.1.0 release if someone sneaks objects
or exceptions in under the wire...).</p>
<p>Jerome Quelin wondered about a codename and Benjamin Goldberg
commented that 'we don't have any of objects, exceptions, or a
real IO system' and suggested that we use 'Kakapo', which is a large,
flightless parrot. Garret G&ouml;bbel suggested the rather wonderful
'Orange Juice' in homage to Leo's recent work on the <code>-Oj</code> JIT
optimization switch.</p>
<p><a href="http://groups.google.com/groups?threadm=20030226051941.GD4244%40foxglove">http://groups.google.com/groups</a></p>


<h4><a name="dan's_plans">Dan's plans</a></h4>
<p>Dan outlined his plan for the string rework (discussed last
week). Nobody said anything, maybe they liked it.</p>
<p>Dan also outlined some requirements for the final Parrot build system,
again, nobody comment.</p>
<p>And, right at the end of the week, he released his second attempt at
an object spec. This one definitely got comments, but I'll cover them
in the next summary.</p>
<p><a href="http://groups.google.com/groups?threadm=a05200f00ba82ac3472f2%40%5B63.120.19.221%5D">http://groups.google.com/groups</a> -- Strings</p>
<p><a href="http://groups.google.com/groups?threadm=a05200f0aba83fd7ecc50%40%5B63.120.19.221%5D">http://groups.google.com/groups</a> -- Builds</p>
<p><a href="http://groups.google.com/groups?threadm=a05200f03ba882e2a2fcb%40%5B63.120.19.221%5D">http://groups.google.com/groups</a> -- Objects</p>


<h4><a name="psteve_peters'_patches_prevent_parrot_peeves">PSteve Peters' Patches Prevent Parrot Peeves</a></h4>
<p>Steve Peters released a flurry of patches to eliminate compilation
warnings during Parrot compilation. Leo wasn't sure about one of them,
but I assume that most of them will be applied at some point.</p>




<h3><a name="meanwhile,_in_perl6language">Meanwhile, in perl6-language</a></h3>
<p>Things were even quieter than last week with all of 10 messages, one
of which was last week's summary.</p>


<h4><a name="arrays,_lists,_referencing">Arrays, lists, referencing</a></h4>
<p>Paul Johnson had observed that changing the order of evaluation (of
terms in a list) -- which is currently undefined in theory whilst being
left to right in practice -- would almost certainly break a great
deal. He suggested that it would be sensible for Perl 6 to define such
an order.</p>
<p>Larry agreed, commenting that 'The fact that Perl 5 doesn't define it
is merely an oversight, brought on no doubt by a lack of oversight.
But as you point out it can deduced by observation of all the various
implementations of Perl.' Which made at least one person smile.</p>


<h4><a name="predefined_properties/traits/etc.">Predefined properties/traits/etc.</a></h4>
<p>Last week, Simon Cozens asked that someone 'please compile a list of
all the ``is foo'' properties that have been suggested/accepted as being
pre-defined by the language.' as he couldn't keep track of them all.</p>
<p>This week someone (who also happened to be Simon Cozens) did just
that. Allison Randal went through Simon's list commenting on what he'd
got right and wrong, and explaining the general rule (properties and
traits are lower case, class names are capitalized, so <code>is Foo</code>
mean that something is a 'Foo', while <code>is bar</code> relates to a 'bar'
property). The rest of the thread was taken up with confusion between
Munich and Zurich.</p>
<p><a href="http://groups.google.com/groups?threadm=87k7fjnidx.fsf_-_%40simoncozens-2.dsl.easynet.co.uk">http://groups.google.com/groups</a></p>




<h3><a name="acknowledgements,_announcements_and_apologies">Acknowledgements, Announcements and Apologies</a></h3>
<p>I'm getting the feeling of someone sat in the calm before the
storm. perl6-language has been very quiet these last few weeks, I'm
guessing that people don't want to distract Larry from the important
business of producing an Apocalypse. Rumours abound of a draft in
circulation among the Perl 6 core design team... Maybe this week will
see its publication and the level of discussion in the language list
will rise once more. Until then I'm enjoying the calm.</p>
<p>Still no American Odyssey web page. One day, I promise.</p>
<p>If you appreciated this summary, please consider one or more of the
following options:</p>

<ul>
<li>
Send money to the Perl Foundation at
<a href="http://donate.perl-foundation.org/">http://donate.perl-foundation.org/</a> and help support the ongoing
development of Perl.</li>


<li>
Get involved in the Perl 6 process. The mailing lists are open  to
all. <a href="http://dev.perl.org/perl6/">http://dev.perl.org/perl6/</a> and <a href="http://www.parrotcode.org/">http://www.parrotcode.org/</a>
are good starting points with links to the appropriate mailing lists.</li>


<li>
Send feedback, flames, money, job offers or a Schneider 90/5.8 Super
Angulon XL lens to <em><a href="mailto:p6summarizer@bofh.org.uk">p6summarizer@bofh.org.uk</a></em></li>

</ul>
<p>This week's summary was again sponsored by Darren Duncan. Thanks
Darren. If you'd like to become a summary sponsor, drop me a line at
<em><a href="mailto:p6summarizer@bofh.org.uk">p6summarizer@bofh.org.uk</a></em>.</p>

        </div>



    </div>
    <div class="asset-footer"></div>
</div>




                            <div class="content-nav">
                                <a href="/pub/2003/02/">&laquo; February 2003</a> |
                                <a href="/pub/">Main Index</a> |
                                <a href="/pub/archives.html">Archives</a>
                                | <a href="/pub/2003/04/">April 2003 &raquo;</a>
                            </div>


                        </div>
                    </div>


                    <div id="beta">
    <div id="beta-inner">


    
    <div class="widget-what-is-perl widget">
    <div class="widget-content widget-content-what-is-perl">
       Visit the home of the  Perl programming language: <a href="http://www.perl.org/">Perl.org</a
    </div>
</div>
<div class="widget-find-out-more widget-archives widget">
    <div class="widget-content">
        <ul>
            <li><a href="http://www.perl.org/get.html">Download</a></li>
            <li><a href="http://perldoc.perl.org/">Documentation</a></li>
            <li><a href="http://blogs.perl.org/">Perl Bloggers</a></li>
            <li><a href="http://news.perlfoundation.org/">Foundation News</a></li>
        </ul>
    </div>
</div><div class="widget-tcpc widget">
<h3 class="widget-header">Sponsored by</h3>
    <div class="widget-content">
        <a href="http://training.perl.com/" alt="Perl Training" target="_blank"><img src="/i/tcpc.png" width="150" height="50"></a>
    </div>
</div>

<div class="widget-syndication widget">
    <div class="widget-content">
        <ul>
            <li><img src="/mt-static/images/status_icons/feed.gif" alt="Subscribe to feed" width="9" height="9" /> <a href="/pub/atom.xml">Subscribe to this website's feed</a></li>

        </ul>
    </div>
</div>
<div class="widget-archive-monthly widget-archive widget">
    <h3 class="widget-header">Monthly <a href="/pub/archives.html">Archives</a></h3>
    <div class="widget-content">
        <ul>
        
            <li><a href="/pub/2014/02/">February 2014 (1)</a></li>
        
    
        
            <li><a href="/pub/2014/01/">January 2014 (1)</a></li>
        
    
        
            <li><a href="/pub/2013/10/">October 2013 (1)</a></li>
        
    
        
            <li><a href="/pub/2013/01/">January 2013 (1)</a></li>
        
    
        
            <li><a href="/pub/2012/12/">December 2012 (1)</a></li>
        
    
        
            <li><a href="/pub/2012/11/">November 2012 (1)</a></li>
        
    
        
            <li><a href="/pub/2012/10/">October 2012 (2)</a></li>
        
    
        
            <li><a href="/pub/2012/08/">August 2012 (2)</a></li>
        
    
        
            <li><a href="/pub/2012/06/">June 2012 (11)</a></li>
        
    
        
            <li><a href="/pub/2012/05/">May 2012 (18)</a></li>
        
    
        
            <li><a href="/pub/2012/04/">April 2012 (17)</a></li>
        
    
        
            <li><a href="/pub/2012/02/">February 2012 (1)</a></li>
        
    
        
            <li><a href="/pub/2011/12/">December 2011 (1)</a></li>
        
    
        
            <li><a href="/pub/2011/09/">September 2011 (1)</a></li>
        
    
        
            <li><a href="/pub/2011/08/">August 2011 (2)</a></li>
        
    
        
            <li><a href="/pub/2011/06/">June 2011 (1)</a></li>
        
    
        
            <li><a href="/pub/2011/05/">May 2011 (3)</a></li>
        
    
        
            <li><a href="/pub/2011/04/">April 2011 (1)</a></li>
        
    
        
            <li><a href="/pub/2011/03/">March 2011 (1)</a></li>
        
    
        
            <li><a href="/pub/2011/02/">February 2011 (1)</a></li>
        
    
        
            <li><a href="/pub/2011/01/">January 2011 (1)</a></li>
        
    
        
            <li><a href="/pub/2010/11/">November 2010 (1)</a></li>
        
    
        
            <li><a href="/pub/2010/10/">October 2010 (2)</a></li>
        
    
        
            <li><a href="/pub/2010/09/">September 2010 (1)</a></li>
        
    
        
            <li><a href="/pub/2010/08/">August 2010 (3)</a></li>
        
    
        
            <li><a href="/pub/2010/07/">July 2010 (2)</a></li>
        
    
        
            <li><a href="/pub/2010/04/">April 2010 (2)</a></li>
        
    
        
            <li><a href="/pub/2010/03/">March 2010 (4)</a></li>
        
    
        
            <li><a href="/pub/2008/05/">May 2008 (1)</a></li>
        
    
        
            <li><a href="/pub/2008/04/">April 2008 (2)</a></li>
        
    
        
            <li><a href="/pub/2008/03/">March 2008 (1)</a></li>
        
    
        
            <li><a href="/pub/2008/02/">February 2008 (1)</a></li>
        
    
        
            <li><a href="/pub/2008/01/">January 2008 (1)</a></li>
        
    
        
            <li><a href="/pub/2007/12/">December 2007 (2)</a></li>
        
    
        
            <li><a href="/pub/2007/09/">September 2007 (1)</a></li>
        
    
        
            <li><a href="/pub/2007/08/">August 2007 (1)</a></li>
        
    
        
            <li><a href="/pub/2007/07/">July 2007 (1)</a></li>
        
    
        
            <li><a href="/pub/2007/06/">June 2007 (1)</a></li>
        
    
        
            <li><a href="/pub/2007/05/">May 2007 (1)</a></li>
        
    
        
            <li><a href="/pub/2007/04/">April 2007 (1)</a></li>
        
    
        
            <li><a href="/pub/2007/03/">March 2007 (1)</a></li>
        
    
        
            <li><a href="/pub/2007/02/">February 2007 (1)</a></li>
        
    
        
            <li><a href="/pub/2007/01/">January 2007 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/12/">December 2006 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/11/">November 2006 (2)</a></li>
        
    
        
            <li><a href="/pub/2006/10/">October 2006 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/09/">September 2006 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/08/">August 2006 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/07/">July 2006 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/06/">June 2006 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/05/">May 2006 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/04/">April 2006 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/03/">March 2006 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/02/">February 2006 (4)</a></li>
        
    
        
            <li><a href="/pub/2006/01/">January 2006 (4)</a></li>
        
    
        
            <li><a href="/pub/2005/12/">December 2005 (4)</a></li>
        
    
        
            <li><a href="/pub/2005/11/">November 2005 (3)</a></li>
        
    
        
            <li><a href="/pub/2005/10/">October 2005 (2)</a></li>
        
    
        
            <li><a href="/pub/2005/09/">September 2005 (2)</a></li>
        
    
        
            <li><a href="/pub/2005/08/">August 2005 (9)</a></li>
        
    
        
            <li><a href="/pub/2005/07/">July 2005 (8)</a></li>
        
    
        
            <li><a href="/pub/2005/06/">June 2005 (9)</a></li>
        
    
        
            <li><a href="/pub/2005/05/">May 2005 (8)</a></li>
        
    
        
            <li><a href="/pub/2005/04/">April 2005 (7)</a></li>
        
    
        
            <li><a href="/pub/2005/03/">March 2005 (6)</a></li>
        
    
        
            <li><a href="/pub/2005/02/">February 2005 (7)</a></li>
        
    
        
            <li><a href="/pub/2005/01/">January 2005 (6)</a></li>
        
    
        
            <li><a href="/pub/2004/12/">December 2004 (8)</a></li>
        
    
        
            <li><a href="/pub/2004/11/">November 2004 (8)</a></li>
        
    
        
            <li><a href="/pub/2004/10/">October 2004 (5)</a></li>
        
    
        
            <li><a href="/pub/2004/09/">September 2004 (9)</a></li>
        
    
        
            <li><a href="/pub/2004/08/">August 2004 (6)</a></li>
        
    
        
            <li><a href="/pub/2004/07/">July 2004 (8)</a></li>
        
    
        
            <li><a href="/pub/2004/06/">June 2004 (6)</a></li>
        
    
        
            <li><a href="/pub/2004/05/">May 2004 (7)</a></li>
        
    
        
            <li><a href="/pub/2004/04/">April 2004 (8)</a></li>
        
    
        
            <li><a href="/pub/2004/03/">March 2004 (8)</a></li>
        
    
        
            <li><a href="/pub/2004/02/">February 2004 (9)</a></li>
        
    
        
            <li><a href="/pub/2004/01/">January 2004 (7)</a></li>
        
    
        
            <li><a href="/pub/2003/12/">December 2003 (4)</a></li>
        
    
        
            <li><a href="/pub/2003/11/">November 2003 (7)</a></li>
        
    
        
            <li><a href="/pub/2003/10/">October 2003 (8)</a></li>
        
    
        
            <li><a href="/pub/2003/09/">September 2003 (6)</a></li>
        
    
        
            <li><a href="/pub/2003/08/">August 2003 (7)</a></li>
        
    
        
            <li><a href="/pub/2003/07/">July 2003 (9)</a></li>
        
    
        
            <li><a href="/pub/2003/06/">June 2003 (9)</a></li>
        
    
        
            <li><a href="/pub/2003/05/">May 2003 (8)</a></li>
        
    
        
            <li><a href="/pub/2003/04/">April 2003 (8)</a></li>
        
    
        
            <li><a href="/pub/2003/03/">March 2003 (10)</a></li>
        
    
        
            <li><a href="/pub/2003/02/">February 2003 (8)</a></li>
        
    
        
            <li><a href="/pub/2003/01/">January 2003 (8)</a></li>
        
    
        
            <li><a href="/pub/2002/12/">December 2002 (5)</a></li>
        
    
        
            <li><a href="/pub/2002/11/">November 2002 (9)</a></li>
        
    
        
            <li><a href="/pub/2002/10/">October 2002 (7)</a></li>
        
    
        
            <li><a href="/pub/2002/09/">September 2002 (11)</a></li>
        
    
        
            <li><a href="/pub/2002/08/">August 2002 (8)</a></li>
        
    
        
            <li><a href="/pub/2002/07/">July 2002 (8)</a></li>
        
    
        
            <li><a href="/pub/2002/06/">June 2002 (4)</a></li>
        
    
        
            <li><a href="/pub/2002/05/">May 2002 (6)</a></li>
        
    
        
            <li><a href="/pub/2002/04/">April 2002 (6)</a></li>
        
    
        
            <li><a href="/pub/2002/03/">March 2002 (7)</a></li>
        
    
        
            <li><a href="/pub/2002/02/">February 2002 (5)</a></li>
        
    
        
            <li><a href="/pub/2002/01/">January 2002 (8)</a></li>
        
    
        
            <li><a href="/pub/2001/12/">December 2001 (7)</a></li>
        
    
        
            <li><a href="/pub/2001/11/">November 2001 (5)</a></li>
        
    
        
            <li><a href="/pub/2001/10/">October 2001 (9)</a></li>
        
    
        
            <li><a href="/pub/2001/09/">September 2001 (7)</a></li>
        
    
        
            <li><a href="/pub/2001/08/">August 2001 (13)</a></li>
        
    
        
            <li><a href="/pub/2001/07/">July 2001 (8)</a></li>
        
    
        
            <li><a href="/pub/2001/06/">June 2001 (13)</a></li>
        
    
        
            <li><a href="/pub/2001/05/">May 2001 (11)</a></li>
        
    
        
            <li><a href="/pub/2001/04/">April 2001 (9)</a></li>
        
    
        
            <li><a href="/pub/2001/03/">March 2001 (8)</a></li>
        
    
        
            <li><a href="/pub/2001/02/">February 2001 (8)</a></li>
        
    
        
            <li><a href="/pub/2001/01/">January 2001 (8)</a></li>
        
    
        
            <li><a href="/pub/2000/12/">December 2000 (6)</a></li>
        
    
        
            <li><a href="/pub/2000/11/">November 2000 (10)</a></li>
        
    
        
            <li><a href="/pub/2000/10/">October 2000 (10)</a></li>
        
    
        
            <li><a href="/pub/2000/09/">September 2000 (2)</a></li>
        
    
        
            <li><a href="/pub/2000/08/">August 2000 (2)</a></li>
        
    
        
            <li><a href="/pub/2000/07/">July 2000 (5)</a></li>
        
    
        
            <li><a href="/pub/2000/06/">June 2000 (7)</a></li>
        
    
        
            <li><a href="/pub/2000/05/">May 2000 (7)</a></li>
        
    
        
            <li><a href="/pub/2000/04/">April 2000 (3)</a></li>
        
    
        
            <li><a href="/pub/2000/03/">March 2000 (2)</a></li>
        
    
        
            <li><a href="/pub/2000/02/">February 2000 (2)</a></li>
        
    
        
            <li><a href="/pub/2000/01/">January 2000 (2)</a></li>
        
    
        
            <li><a href="/pub/1999/12/">December 1999 (6)</a></li>
        
    
        
            <li><a href="/pub/1999/11/">November 1999 (6)</a></li>
        
    
        
            <li><a href="/pub/1999/10/">October 1999 (5)</a></li>
        
    
        
            <li><a href="/pub/1999/09/">September 1999 (4)</a></li>
        
    
        
            <li><a href="/pub/1999/08/">August 1999 (3)</a></li>
        
    
        
            <li><a href="/pub/1999/07/">July 1999 (2)</a></li>
        
    
        
            <li><a href="/pub/1999/06/">June 1999 (3)</a></li>
        
    
        
            <li><a href="/pub/1999/04/">April 1999 (1)</a></li>
        
    
        
            <li><a href="/pub/1999/03/">March 1999 (1)</a></li>
        
    
        
            <li><a href="/pub/1999/01/">January 1999 (1)</a></li>
        
    
        
            <li><a href="/pub/1998/12/">December 1998 (1)</a></li>
        
    
        
            <li><a href="/pub/1998/11/">November 1998 (1)</a></li>
        
    
        
            <li><a href="/pub/1998/07/">July 1998 (2)</a></li>
        
    
        
            <li><a href="/pub/1998/06/">June 1998 (1)</a></li>
        
    
        
            <li><a href="/pub/1998/03/">March 1998 (1)</a></li>
        
        </ul>
    </div>
</div>
        
    

<div class="widget-powered widget">
    <div class="widget-content">
        <a href="http://www.movabletype.com/"><img src="/mt-static/images/bug-pbmt-white.png" alt="Powered by Movable Type 5.13-en" width="120" height="75" /></a>
    </div>
</div>



    </div>
</div>






                </div>
            </div>


            <div id="footer">
    <div id="footer-inner">
        <div id="footer-content">
            <div class="widget-powered widget">
                <div class="widget-content">
                    Powered by <a href="http://www.movabletype.com/" rel="generator">Movable Type Pro</a>
                </div>
            </div>

            <div class="widget-creative-commons widget">
                <div class="widget-content">
                    This blog is licensed under a <a href="http://creativecommons.org/licenses/by-nc-nd/3.0/">Creative Commons License</a>.
                </div>
            </div>

        </div>
    </div>
</div>



        </div>
    </div>
</body>
</html>
