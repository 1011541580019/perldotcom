<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" id="sixapart-standard">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="generator" content="Movable Type Pro 5.02" />
<link rel="stylesheet" href="/pub/styles.css" type="text/css" />
<link rel="start" href="/pub/" title="Home" />
<link rel="alternate" type="application/atom+xml" title="Recent Entries" href="/pub/atom.xml" />
<script type="text/javascript" src="/pub/mt.js"></script>

<script type="text/javascript">

 var _gaq = _gaq || [];
 _gaq.push(['_setAccount', 'UA-50555-22']);
 _gaq.push(['_trackPageview']);

 (function() {
   var ga = document.createElement('script'); ga.type =
   'text/javascript'; ga.async = true;
   ga.src = ('https:' == document.location.protocol ? 'https://ssl' :
   'http://www') + '.google-analytics.com/ga.js';
   var s = document.getElementsByTagName('script')[0];
   s.parentNode.insertBefore(ga, s);
 })();

</script>
    
    <link rel="prev bookmark" href="/pub/2003/10/musicbrainz.html" title="Identifying Audio Files with MusicBrainz" />
    <link rel="next bookmark" href="/pub/2003/10/20031012.html" title="This week on Perl 6, week ending 2003-10-12" />
    
    
    <title>A Refactoring Example - Perl.com</title>
</head>
<body id="perl-com" class="mt-entry-archive layout-wt">
    <div id="container">
        <div id="container-inner">


            <div id="header">
    <div id="header-inner">
        <div id="header-content">
        <div id="top_advert"> 
<!-- Put any landscape advert in here -->
<a href="http://www.perlfoundation.org/" target="_new">
<img src="/i/tpf_banner.png" width="468" height="60" /></a>
        </div> 



            <div id="header-name"><a href="/pub/" accesskey="1">Perl.com</a></div>
            <div id="header-description"></div>




        </div>
    </div>
</div>



            <div id="content">
                <div id="content-inner">


                    <div id="alpha">
                        <div id="alpha-inner">


                            <div id="entry-1200" class="entry-asset asset hentry">
                                <div class="asset-header">
                                    <h1 id="page-title" class="asset-name entry-title">A Refactoring Example</h1>
                                    <div class="asset-meta">
                                        <span class="byline">

                                            By <span class="vcard author">Michael Schwern</span> on <abbr class="published" title="2003-10-09T00:00:00-08:00">October  9, 2003 12:00 AM</abbr>

                                        </span>


                                    </div>
                                </div>
                                <div class="asset-content entry-content">

                                    <div class="asset-body">
                                        
<!-- sidebar begins -->
<!-- don't move sidebars -->
<!-- sidebar ends -->

<p>
About a year ago, a person asked the <a href="http://www.technofile.org/technofile/depts/mlists/fwp.html">Fun With Perl</a> mailing list about some
code they had written to do database queries.  It's important to note that this person was posting from an .it address; why will become apparent later.  The code was reading records
in from a text file and then doing a series of queries based on that
information.  They wanted to make it faster.
</p>


<p>
Here's his code:
</p>


<pre><code>open (INPUT, "&lt; $filepageid") || &amp;file_open_error("$filepageid");

while ($riga=&lt;INPUT&gt;){
$nump++;
chop($riga);
$pagina[$nump] = $riga;

$sth= $dbh-&gt;prepare("SELECT count(*) FROM lognew WHERE
pageid='$pagina[$nump]' and data&gt;='$startdate'");
$sth-&gt;execute;
$totalvisit[$nump] = $sth-&gt;fetchrow_array();

$sth = $dbh-&gt;prepare("SELECT count(*) FROM lognew WHERE
(pageid='$pagina[$nump]' and data='$dataoggi')");
$sth-&gt;execute;
$totalvisittoday[$nump] = $sth-&gt;fetchrow_array();

 $sth = $dbh-&gt;prepare("SELECT count(*) FROM lognew WHERE
(pageid='$pagina[$nump]' and data='$dataieri')");
$sth-&gt;execute;
$totalyvisit[$nump] = $sth-&gt;fetchrow_array();

 $sth= $dbh-&gt;prepare("SELECT count(*) FROM lognew WHERE
(pageid='$pagina[$nump]' and data&lt;='$fine30gg' and data&gt;='$inizio30gg')");
$sth-&gt;execute;
$totalmvisit[$nump] = $sth-&gt;fetchrow_array();

 }

</code></pre>
<p>
I decided that rather than try to read through this code and figure
out what it's doing and how to make it faster, I'd clean it up first.
Clean it up <b>before</b> you figure out how it works?  Yes, using a
technique called <em>Refactoring</em>.
</p>



<h3>Refactoring?</h3>
<p>

In his book, Martin Fowler defines Refactoring as <em>"the process of changing a software system in such a way that it does not alter the external behavior of the code yet improves its internal structure."</em>
In other words, you clean up your code but don't change what it does.
</p>


<p>
Refactoring can be as simple as changing this code:
</p>


<pre><code>$exclamation = 'I like '.$pastry.'!';

</code></pre>
<p>
To this:
</p>


<pre><code>$exclamation = "I like $pastry!";

</code></pre>
<p>
Still does the same thing, but it's easier to read.
</p>


<p>
It's important to note that I don't need to know anything about the
contents of <code>$pastry</code> or how <code>$exclamation</code> is used.  The change is
completely self-contained and does not affect surrounding code or
change what it does.  This is Refactoring.
</p>


<p>
On the principle of "show me don't tell me," rather than talk about it,
we'll dive right into refactoring our bit of code.
</p>



<h3>Fix the Indentation</h3>
<p>

Your first impulse when faced with a hunk of code slammed against the
left margin is to indent it.  This is our first refactoring.
</p>


<pre><code>open (INPUT, "&lt; $filepageid") || &amp;file_open_error("$filepageid");

while ($riga=&lt;INPUT&gt;){
<font color="#808000">    $nump++;
    chop($riga);
    $pagina[$nump] = $riga;

    $sth= $dbh-&gt;prepare("SELECT count(*) FROM lognew WHERE
                         pageid='$pagina[$nump]' and data&gt;='$startdate'");
    $sth-&gt;execute;
    $totalvisit[$nump] = $sth-&gt;fetchrow_array();

    $sth = $dbh-&gt;prepare("SELECT count(*) FROM lognew WHERE
                          (pageid='$pagina[$nump]' and data='$dataoggi')");
    $sth-&gt;execute;
    $totalvisittoday[$nump] = $sth-&gt;fetchrow_array();

    $sth = $dbh-&gt;prepare("SELECT count(*) FROM lognew WHERE
                          (pageid='$pagina[$nump]' and data='$dataieri')");
    $sth-&gt;execute;
    $totalyvisit[$nump] = $sth-&gt;fetchrow_array();

    $sth= $dbh-&gt;prepare("SELECT count(*) FROM lognew WHERE
                         (pageid='$pagina[$nump]' and data&lt;='$fine30gg' 
						 and data&gt;='$inizio30gg')");
    $sth-&gt;execute;
    $totalmvisit[$nump] = $sth-&gt;fetchrow_array();
}</font>

close (INPUT);

</code></pre>
<p>
Already it looks better.  We can see that we're iterating over a file,
performing some SELECTs on each line and shoving the results into a
bunch of arrays.
</p>



<h3>A Single, Simple Change</h3>
<p>

One of the most important principles of Refactoring is that you work
in small steps.  This re-indentation is a single step.  And part of this single step includes running the test suite, logging the change, and checking it into CVS.
</p>


<p>
Checking into CVS after something this simple?  Yes.  Many programmers
ask the question, "When should I check in?"  When you're refactoring
it's simple: check in when you've done one refactoring and have tested that it
works.  Our re-indentation is one thing; we test that it works and
check it in.
</p>


<p>
This may seem excessive, but it prevents us from entangling two
unrelated changes together.  By doing one change at a time we know
that any new bugs were introduced by that one change.  Also, you will
often decide in the middle of a refactoring that it's not such a good
idea.  When you've checked in at every one you can simply rollback to
the last version rather than having to undo it by hand.  Convenient,
and you're sure no stray bits of your aborted change are hanging around.
</p>


<p>
So our procedure for doing a proper refactoring is:
</p>


<ul>
<li>Make one logical change to the code.</li>
<li>Make sure it passes tests.</li>
<li>Log and check in.</li>
</ul>


<h3>Big Refactorings from Small</h3>
<p>

The goal of this refactoring is to make the code go faster.  One of
the simplest ways to do achieve that is to pull necessary code out of
the loop.  Preparing four new statements in every iteration of the
loop seems really unnecessary.  We'd like to pull those
<code>prepare()</code>
statements out of the loop.  This is a refactoring.  To achieve this
larger refactoring, a series of smaller refactorings must be done.
</p>



<h3>Use Bind Variables</h3>
<p>

Each time through the loop, a new set of SQL statements is created
based on the line read in.  But they're all basically the same, just
the data is changing.  If we could pull that data out of the statement
we'd be closer to our goal of pulling the <code>prepare()</code>s out of the loop.
</p>


<p>
So my next refactoring pulls variables out of the SQL statements and
replaces them with placeholders.  Then the data is bound to the
statement using bind variables.  This means we're now
<code>prepare()</code>ing the
same statements every time through the loop.
</p>


<p>
Before refactoring:
</p>


<pre><code>$sth= $dbh-&gt;prepare("SELECT count(*) FROM lognew WHERE
                     pageid='$pagina[$nump]' and data&gt;='$startdate'");
$sth-&gt;execute;

</code></pre>
<p>
After refactoring:
</p>


<pre><code>$sth= $dbh-&gt;prepare('SELECT count(*) FROM lognew WHERE 
                     pageid=<font color="#808000">?</font> and data&gt;=<font color="#808000">?</font>');
$sth-&gt;execute<font color="#808000">($pagina[$nump], $startdate)</font>;

</code></pre>
<p>
Bind variables also protect against a naughty user from trying to slip
some extra SQL into your program via the data you read in.  As a
side-effect of our code cleanup, we've closed a potential security
hole.
</p>


<pre><code>open (INPUT, "&lt; $filepageid") || &amp;file_open_error("$filepageid");

while ($riga=&lt;INPUT&gt;){
    $nump++;
    chop($riga);
    $pagina[$nump] = $riga;

    $sth= $dbh-&gt;prepare('SELECT count(*) FROM lognew WHERE 
                         pageid=<font color="#808000">?</font> and data&gt;=<font color="#808000">?</font>');
    $sth-&gt;execute<font color="#808000">($pagina[$nump], $startdate)</font>;
    $totalvisit[$nump] = $sth-&gt;fetchrow_array();

    $sth = $dbh-&gt;prepare('SELECT count(*) FROM lognew WHERE
                          (pageid=<font color="#808000">?</font> and data=<font color="#808000">?</font>)');
    $sth-&gt;execute<font color="#808000">($pagina[$nump], $dataoggi)</font>;
    $totalvisittoday[$nump] = $sth-&gt;fetchrow_array();

    $sth = $dbh-&gt;prepare('SELECT count(*) FROM lognew WHERE
                          (pageid=<font color="#808000">?</font> and data=<font color="#808000">?</font>)');
    $sth-&gt;execute<font color="#808000">($pagina[$nump], $dataieri)</font>;
    $totalyvisit[$nump] = $sth-&gt;fetchrow_array();

    $sth= $dbh-&gt;prepare('SELECT count(*) FROM lognew WHERE
                         (pageid=<font color="#808000">?</font> and data&lt;=<font color="#808000">?</font> and data&gt;=<font color="#808000">?</font>)');
    $sth-&gt;execute<font color="#808000">($pagina[$nump], $fine30gg, $inizio30gg)</font>;
    $totalmvisit[$nump] = $sth-&gt;fetchrow_array();
}

close (INPUT);

</code></pre>
<p>
Test.  Log.  Check in.
</p>



<h3>Split a Poorly Reused Variable</h3>
<p>

The next stumbling block to pulling the <code>prepare()</code> statements out of
the loop is that they all use the same variable, <code>$sth</code>.  We'll have
to change it so they all use different variables.  While we're at it,
we'll name those statement handles something more descriptive of what
the statement does.  Since at this point we haven't figured out what
the statements do, we can base the name on the array it gets assigned
to.
</p>


<p>
While we're at it, throw in some <code>my()</code> declarations to limit the scope
of these variables to just the loop.
</p>


<pre><code>open (INPUT, "&lt; $filepageid") || &amp;file_open_error("$filepageid");

while ($riga=&lt;INPUT&gt;){
    $nump++;
    chop($riga);
    $pagina[$nump] = $riga;

    <font color="#808000">my $totalvisit_sth</font> = $dbh-&gt;prepare('SELECT count(*) FROM lognew WHERE 
                                        pageid=? and data&gt;=?');
    <font color="#808000">$totalvisit_sth</font>-&gt;execute($pagina[$nump], $startdate);
    $totalvisit[$nump] = <font color="#808000">$totalvisit_sth</font>-&gt;fetchrow_array();

    <font color="#808000">my $totalvisittoday_sth</font> = $dbh-&gt;prepare('SELECT count(*) FROM lognew WHERE
                                             (pageid=? and data=?)');
    <font color="#808000">$totalvisittoday_sth</font>-&gt;execute($pagina[$nump], $dataoggi);
    $totalvisittoday[$nump] = <font color="#808000">$totalvisittoday_sth</font>-&gt;fetchrow_array();

    <font color="#808000">my $totalyvisit_sth</font> = $dbh-&gt;prepare('SELECT count(*) FROM lognew WHERE
                                         (pageid=? and data=?)');
    <font color="#808000">$totalyvisit_sth</font>-&gt;execute($pagina[$nump], $dataieri);
    $totalyvisit[$nump] = <font color="#808000">$totalyvisit_sth</font>-&gt;fetchrow_array();

    <font color="#808000">my $totalmvisit_sth</font>= $dbh-&gt;prepare('SELECT count(*) FROM lognew WHERE
                                        (pageid=? and data&lt;=? and data&gt;=?)');
    <font color="#808000">$totalmvisit_sth</font>-&gt;execute($pagina[$nump], $fine30gg, $inizio30gg);
    $totalmvisit[$nump] = <font color="#808000">$totalmvisit_sth</font>-&gt;fetchrow_array();
}

close (INPUT);

</code></pre>
<p>
Test.  Log.  Check in.
</p>













<h3>Getting Better All the Time</h3>
<p>

The new names are better, but they're not great.  This is ok.  Naming is
something people often get hung up on.  One can spend hours wracking
their brains thinking of the perfect name for a variable or a
function.  If you can think of a better one than what's there right
now, use it.  The beauty of Refactoring is you an always improve upon
it later.
</p>


<p>
This is an important lesson of Refactoring.  Voltare said, "the best
is the enemy of the good".  We often get so wound up trying to make
code <em>great</em> that we fail to improve it at all.  In refactoring,
it's
not so important to make your code great in one leap, just a little
better all the time (it's a little known fact John Lennon was into
Refactoring.)  These small improvements will build up into a clean
piece of code, with less bugs, more surely than a large-scale code
cleanup would.
</p>



<h3>Pull Code Out of the Loop</h3>
<p>

Now it's a simple cut and paste to pull the four <code>prepare()</code> statements
out of the loop.
</p>



<pre><code><font color="#808000">my $totalvisit_sth = $dbh-&gt;prepare('SELECT count(*) FROM lognew WHERE 
                                    pageid=? and data&gt;=?');

my $totalvisittoday_sth = $dbh-&gt;prepare('SELECT count(*) FROM lognew WHERE
                                         (pageid=? and data=?)');

my $totalyvisit_sth = $dbh-&gt;prepare('SELECT count(*) FROM lognew WHERE
                                     (pageid=? and data=?)');

my $totalmvisit_sth = $dbh-&gt;prepare('SELECT count(*) FROM lognew WHERE
                                     (pageid=? and data&lt;=? and data&gt;=?)');
</font>
open (INPUT, "&lt; $filepageid") || &amp;file_open_error("$filepageid");

while ($riga=&lt;INPUT&gt;){
    $nump++;
    chop($riga);
    $pagina[$nump] = $riga;

    $totalvisit_sth-&gt;execute($pagina[$nump], $startdate);
    $totalvisit[$nump] = $totalvisit_sth-&gt;fetchrow_array();

    $totalvisittoday_sth-&gt;execute($pagina[$nump], $dataoggi);
    $totalvisittoday[$nump] = $totalvisittoday_sth-&gt;fetchrow_array();

    $totalyvisit_sth-&gt;execute($pagina[$nump], $dataieri);
    $totalyvisit[$nump] = $totalyvisit_sth-&gt;fetchrow_array();

    $totalmvisit_sth-&gt;execute($pagina[$nump], $fine30gg, $inizio30gg);
    $totalmvisit[$nump] = $totalmvisit_sth-&gt;fetchrow_array();
}

close (INPUT);

</code></pre>
<p>
Already the code is looking better.  With the SQL separated, the inner
workings of the loop are much less daunting.
</p>


<p>
Test.  Log.  Check in.
</p>



<h3>A Place to Stop</h3>
<p>

Remember our goal, to make this code run faster.  By pulling the
<code>prepare()</code> statements outside the loop we've likely achieved this goal.
Additionally, it still does exactly what it did before even though we
still don't fully understand what that is.  If this were a real
project, you'd do some benchmarking to see if the code is fast enough
and move on to another task.
</p>


<p>
Since this is an example, I'll continue with more refactorings with
the goal of clarifying the code further and figuring out what it does.
</p>


<p>
Keep in mind that after every refactoring the code still does <i>exactly
what it did before</i>.  This means we can stop choose to stop after any
refactoring.  If a more pressing task suddenly pops up we can pause
our refactoring work and attend to that feeling confident we didn't
leave any broken code lying around.
</p>



<h3>Reformat SQL for Better Readability</h3>
<p>

In order to make sense of the code, we have to make sense of the SQL.
The simplest way to better understand the SQL is to put it into a
clearer format.
</p>


<p>
The three major parts of an SQL SELECT statement are:
</p>


<ul>
<li>The rows (ie. <code>SELECT count(*)</code>)</li>
<li>The table (ie. <code>FROM lognew</code>)</li>
<li>The predicate (ie. <code>WHERE pageid = ...</code>)</li>
</ul>
<p>

I've chosen a new format that highlights these parts.
</p>


<p>
I've also removed some unnecessary parenthesis because they just serve to
clutter things up rather than disambiguate an expression.
</p>


<p>
I've also decided to change the quoting style from single quotes to a
here-doc.  It would have also been okay to use <code>q{}</code>.
</p>


<pre><code>my $totalvisit_sth = $dbh-&gt;prepare(<font color="#808000">&lt;&lt;'SQL'</font>);
<font color="#808000">SELECT count(*)
FROM   lognew 
WHERE  pageid =  ? AND 
       data   &gt;= ?
SQL</font>

my $totalvisittoday_sth = $dbh-&gt;prepare(<font color="#808000">&lt;&lt;'SQL'</font>);
<font color="#808000">SELECT count(*) 
FROM   lognew 
WHERE  pageid = ? AND 
       data   = ?
SQL</font>

my $totalyvisit_sth = $dbh-&gt;prepare(<font color="#808000">&lt;&lt;'SQL'</font>);
<font color="#808000">SELECT count(*) 
FROM   lognew 
WHERE  pageid = ? AND 
       data   = ?
SQL</font>

my $totalmvisit_sth = $dbh-&gt;prepare(<font color="#808000">&lt;&lt;'SQL'</font>);
<font color="#808000">SELECT count(*) 
FROM   lognew 
WHERE  pageid =  ? AND
       data   &lt;= ? AND 
       data   &gt;= ?
SQL</font>

open (INPUT, "&lt; $filepageid") || &amp;file_open_error("$filepageid");

while ($riga=&lt;INPUT&gt;){
    $nump++;
    chop($riga);
    $pagina[$nump] = $riga;

    $totalvisit_sth-&gt;execute($pagina[$nump], $startdate);
    $totalvisit[$nump] = $totalvisit_sth-&gt;fetchrow_array();

    $totalvisittoday_sth-&gt;execute($pagina[$nump], $dataoggi);
    $totalvisittoday[$nump] = $totalvisittoday_sth-&gt;fetchrow_array();

    $totalyvisit_sth-&gt;execute($pagina[$nump], $dataieri);
    $totalyvisit[$nump] = $totalyvisit_sth-&gt;fetchrow_array();

    $totalmvisit_sth-&gt;execute($pagina[$nump], $fine30gg, $inizio30gg);
    $totalmvisit[$nump] = $totalmvisit_sth-&gt;fetchrow_array();
}

close (INPUT);

</code></pre>
<p>
Test.  Log.  Check in.
</p>



<h3>Remove Redundancy</h3>
<p>

With the SQL in a more readable format, some commonalities become clear.
</p>


<ul>
<li>All the statements are doing a <code>count(*)</code>.</li>
<li>They're all using the <code>lognew</code> table</li>
<li>They're all looking for a certain <code>pageid</code>.</li>
</ul>
<p>

In fact, <code>$totalvisittoday_sth</code> and <code>$totalyvisit_sth</code> are exactly
the same!  Let's eliminate one of them, doesn't matter which, we're
going to rename them in a moment anyway.  <code>$totalyvisit_sth</code> goes
away, making sure to change all references to it to <code>$totalvisittoday_sth</code>.
</p>


<pre><code>my $totalvisit_sth = $dbh-&gt;prepare(&lt;&lt;'SQL');
SELECT count(*)
FROM   lognew 
WHERE  pageid =  ? AND 
       data   &gt;= ?
SQL

my $totalvisittoday_sth = $dbh-&gt;prepare(&lt;&lt;'SQL');
SELECT count(*) 
FROM   lognew 
WHERE  pageid = ? AND 
       data   = ?
SQL

my $totalmvisit_sth = $dbh-&gt;prepare(&lt;&lt;'SQL');
SELECT count(*) 
FROM   lognew 
WHERE  pageid =  ? AND
       data   &lt;= ? AND 
       data   &gt;= ?
SQL

open (INPUT, "&lt; $filepageid") || &amp;file_open_error("$filepageid");

while ($riga=&lt;INPUT&gt;){
    $nump++;
    chop($riga);
    $pagina[$nump] = $riga;

    $totalvisit_sth-&gt;execute($pagina[$nump], $startdate);
    $totalvisit[$nump] = $totalvisit_sth-&gt;fetchrow_array();

    $totalvisittoday_sth-&gt;execute($pagina[$nump], $dataoggi);
    $totalvisittoday[$nump] = $totalvisittoday_sth-&gt;fetchrow_array();

    <font color="#808000">$totalvisittoday_sth</font>-&gt;execute($pagina[$nump], $dataieri);
    $totalyvisit[$nump] = <font color="#808000">$totalvisittoday_sth</font>-&gt;fetchrow_array();

    $totalmvisit_sth-&gt;execute($pagina[$nump], $fine30gg, $inizio30gg);
    $totalmvisit[$nump] = $totalmvisit_sth-&gt;fetchrow_array();
}

close (INPUT);

</code></pre>
<p>
Test.  Log.  Check in.
</p>













<h3>Fix Conflicting Styles</h3>
<p>

Now the only difference between the statements is the choice of
<code>data</code> ranges.
</p>


<p>
Using the variables are passed into each statement we can
make some more deductions.  Let's have a look...
</p>


<ul>
<li><code>$startdate</code></li>
<li><code>$dataoggi</code></li>
<li><code>$dataieri</code></li>
<li><code>$fine30gg, $inizio30gg</code></li>
</ul>
<p>

<em>One of these things is not like the other.</em> What's <code>$startdate</code>
doing there?  Everything else is talking about 'data'.  What's 'ieri'?
'oggi'?  Remember, the programmer who submitted this code is Italian.
Maybe the names are in Italian.  Grabbing an <a href="http://dictionaries.travlang.com/ItalianEnglish/">Italian-English dictionary</a> we find
out that 'data' is Italian for 'date'!  Now it makes sense, this code
was probably originally written in English, then worked on by an
Italian (or vice-versa).
</p>


<p>
This code has committed a cardinal stylistic sin.  It uses two
different languages for naming variables.  Not just different
languages, languages which have different meanings for the same words.
Taken out of context, we can't know if <code>$data</code> represents a hunk of
facts or "Thursday."
</p>


<p>
Since the styles conflict, one of them has to go.  Since I don't speak
Italian, I'm going to translate it into English.
</p>


<p>
Pulling out our Italian-to-English dictionary...
</p>


<ul>
<li>"riga" is "line"</li>
<li>"pagina" is "page"</li>
<li>"nump" is probably short for "numero pagina" which is "page number"</li>
<li>"data" is "date"</li>
<li>"oggi" is "today"</li>
<li>"ieri" is "yesterday"</li>
<li>"inizio" is "start"</li>
<li>"fine" is "end"</li>
<li>"gg" is probably short for "giorni" which is "days"
 <ul>
 <li>"fine30gg" would then be "the end of 30 days"</li>
 <li>"inizio30gg" would be "the beginning of 30 days"</li>
 </ul></li>
</ul>
<p>

It would be a straightforward matter of a bunch of search-and-replaces
in any good editor but for one snag, the SQL column 'data.'  We'd like
to change this to its English 'date', but databases are very global
with possibly lots of other programs using it.  So we can't change the
column name without breaking other code. While in a well-organized
programming shop you might have the ability to find all the code which
uses your database, we won't assume we have that luxury here.  For the
moment then, we'll leave that be and deal with it in a separate
refactoring.
</p>


<pre><code>my $totalvisit_sth = $dbh-&gt;prepare(&lt;&lt;'SQL');
SELECT count(*)
FROM   lognew 
WHERE  pageid =  ? AND 
       data   &gt;= ?
SQL

my $totalvisittoday_sth = $dbh-&gt;prepare(&lt;&lt;'SQL');
SELECT count(*) 
FROM   lognew 
WHERE  pageid = ? AND 
       data   = ?
SQL

my $totalmvisit_sth = $dbh-&gt;prepare(&lt;&lt;'SQL');
SELECT count(*) 
FROM   lognew 
WHERE  pageid =  ? AND
       data   &lt;= ? AND 
       data   &gt;= ?
SQL

open (INPUT, "&lt; $filepageid") || &amp;file_open_error("$filepageid");

while ($<font color="#808000">line</font>=&lt;INPUT&gt;){
    $<font color="#808000">page_num</font>++;
    chop($<font color="#808000">line</font>);
    $<font color="#808000">pages</font>[$<font color="#808000">page_num</font>] = $<font color="#808000">line</font>;

    $totalvisit_sth-&gt;execute($<font color="#808000">pages</font>[$<font color="#808000">page_num</font>], $<font color="#808000">start_date</font>);
    $totalvisit[$<font color="#808000">page_num</font>] = $totalvisit_sth-&gt;fetchrow_array();

    $totalvisittoday_sth-&gt;execute($<font color="#808000">pages</font>[$<font color="#808000">page_num</font>], $<font color="#808000">today</font>);
    $totalvisittoday[$<font color="#808000">page_num</font>] = $totalvisittoday_sth-&gt;fetchrow_array();

    $totalvisittoday_sth-&gt;execute($<font color="#808000">pages</font>[$<font color="#808000">page_num</font>], $<font color="#808000">yesterday</font>);
    $totalyvisit[$<font color="#808000">page_num</font>] = $totalvisittoday_sth-&gt;fetchrow_array();

    $totalmvisit_sth-&gt;execute($<font color="#808000">pages</font>[$<font color="#808000">page_num</font>], $<font color="#808000">end_of_30_days</font>,
                                                 $<font color="#808000">start_of_30_days</font>);
    $totalmvisit[$<font color="#808000">page_num</font>] = $totalmvisit_sth-&gt;fetchrow_array();
}

close (INPUT);

</code></pre>
<p>
Test.  Log.  Check in.
</p>



<h3>Better Names</h3>
<p>

With decent variable names in place, the purpose of the program
becomes <b>much</b> clearer.  This is a program to calculate the number of
visits to a page for various date ranges.  Based on this new
information we can give the statement handles and the arrays they put
data into better names.
</p>


<p>
Looking at the SQL we see we've got:
</p>


<ul>
<li>One to get all the visits up to a single day.</li>
<li>One to get the visits for a certain date.</li>
<li>One to get the visits for a range of dates.</li>
</ul>
<p>

A good set of new names would be:
</p>


<ul>
<li>daily</li>
<li>up to</li>
<li>range</li>
</ul>
<p>

Also, Total Visits is too long.  We could shorten that to just
Visits, or even shorter to Hits.
</p>


<pre><code>my $<font color="#808000">hits_upto</font>_sth = $dbh-&gt;prepare(&lt;&lt;'SQL');
SELECT count(*)
FROM   lognew 
WHERE  pageid =  ? AND 
       data   &gt;= ?
SQL

my $<font color="#808000">hits_daily</font>_sth = $dbh-&gt;prepare(&lt;&lt;'SQL');
SELECT count(*) 
FROM   lognew 
WHERE  pageid = ? AND 
       data   = ?
SQL

my $<font color="#808000">hits_range</font>_sth = $dbh-&gt;prepare(&lt;&lt;'SQL');
SELECT count(*) 
FROM   lognew 
WHERE  pageid =  ? AND
       data   &lt;= ? AND 
       data   &gt;= ?
SQL

open (INPUT, "&lt; $filepageid") || &amp;file_open_error("$filepageid");

while ($line=&lt;INPUT&gt;){
    $page_num++;
    chop($line);
    $pages[$page_num] = $line;

    $<font color="#808000">hits_upto</font>_sth-&gt;execute($pages[$page_num], $start_date);
    $totalvisit[$page_num] = $<font color="#808000">hits_upto</font>_sth-&gt;fetchrow_array();

    $<font color="#808000">hits_daily</font>_sth-&gt;execute($pages[$page_num], $today);
    $totalvisittoday[$page_num] = $<font color="#808000">hits_daily</font>_sth-&gt;fetchrow_array();

    $<font color="#808000">hits_daily</font>_sth-&gt;execute($pages[$page_num], $yesterday);
    $totalyvisit[$page_num] = $<font color="#808000">hits_daily</font>_sth-&gt;fetchrow_array();

    $<font color="#808000">hits_range</font>_sth-&gt;execute($pages[$page_num], $end_of_30_days,
                                                $start_of_30_days);
    $totalmvisit[$page_num] = $<font color="#808000">hits_range</font>_sth-&gt;fetchrow_array();
}

close (INPUT);

</code></pre>
<p>
Test.  Log.  Check in.
</p>



<h3>Changing Global Variable Names</h3>
<p>

The array names need work, too.  Currently, they're rather ambiguous.
<code>@totalyvisit</code>, what does the <i>y</i> mean?  Looking at each variable
name and the variables that got passed to <code>execute()</code> to produce it...
</p>


<ul>
<li><code>@totalvisit</code> comes up to a <code>$start_date</code>.  So that can be <code>@hits_upto</code></li>
<li><code>@totalvisittoday</code> comes from <code>$today</code> and is pretty obvious.  <code>@hits_today</code></li>
<li><code>@totalyvisit</code> comes from <code>$yesterday</code> so 'y' must be for 'yesterday'.  <code>@hits_yesterday</code></li>
<li><code>@totalmvisit</code> comes from the range produced by the $start_of_30_days and the $end_of_30_days.  So 'm' must be 'month'.  <code>@hits_monthly</code></li>
</ul>
<pre><code>my $hits_upto_sth = $dbh-&gt;prepare(&lt;&lt;'SQL');
SELECT count(*)
FROM   lognew 
WHERE  pageid =  ? AND 
       data   &gt;= ?
SQL

my $hits_daily_sth = $dbh-&gt;prepare(&lt;&lt;'SQL');
SELECT count(*) 
FROM   lognew 
WHERE  pageid = ? AND 
       data   = ?
SQL

my $hits_range_sth = $dbh-&gt;prepare(&lt;&lt;'SQL');
SELECT count(*) 
FROM   lognew 
WHERE  pageid =  ? AND
       data   &lt;= ? AND 
       data   &gt;= ?
SQL

open (INPUT, "&lt; $filepageid") || &amp;file_open_error("$filepageid");

while ($line=&lt;INPUT&gt;){
    $page_num++;
    chop($line);
    $pages[$page_num] = $line;

    $hits_upto_sth-&gt;execute($pages[$page_num], $start_date);
    $<font color="#808000">hits_upto</font>[$page_num] = $hits_upto_sth-&gt;fetchrow_array();

    $hits_daily_sth-&gt;execute($pages[$page_num], $today);
    $<font color="#808000">hits_today</font>[$page_num] = $hits_daily_sth-&gt;fetchrow_array();

    $hits_daily_sth-&gt;execute($pages[$page_num], $yesterday);
    $<font color="#808000">hits_yesterday</font>[$page_num] = $hits_daily_sth-&gt;fetchrow_array();

    $hits_range_sth-&gt;execute($pages[$page_num], $end_of_30_days,
                                                $start_of_30_days);
    $<font color="#808000">hits_monthly</font>[$page_num] = $hits_range_sth-&gt;fetchrow_array();
}

close (INPUT);

</code></pre>
<p>
Test... uh-oh, test failed!
</p>


<p>
There's something <b>very</b> different about this change compared to the
others.  The variables we changed were <em>not</em> declared in our little
code block.  Likely they're used in other parts of the code, such as
our test which caused it to break.
</p>


<p>
In the Real World, we would be sure to <b>replace all occurrences of the
variable</b>.  The simplest way to do this is to use your editor to
perform a search and replace rather than doing it by your all too
fallible hands.  If it could be used over a set of files, grepping
through those files for all occurrences of it and changing those as
well would be necessary.
</p>


<pre><code># If you don't have rgrep, grep -r does the same thing.
rgrep '[@$]totalvisit' /path/to/your/project

</code></pre>
<p>
I do this so often that I've taken to calling grep -r, 'Refactoring
Grep'.  Other languages who's syntax is -- ummm -- not as inspired as
Perl's, such as Java, C++ and Python, have tools for doing this sort
of thing automatically.  Because of the complexity of Perl's syntax, we
still have to do it mostly by hand, though there are some efforts
underway to rectify this. 
</p>


<p>
Changing the array names in our test as well we get them to pass.
</p>


<p>
Log.  Check in.
</p>













<h3>Improve Overly Generic Names</h3>
<p>

Continuing with our variable name improvements, we're left with the
last few unimproved names.  Let's start with <code>$line</code>.
</p>


<p>
Since we can see clearly that <code>$line = &lt;INPUT&gt;</code>, calling the variable
'line' tells us nothing new.  A better name might be what each line
contains.  Looking at how the line is used we see <code>$pages[$page_num]
= $line</code> and how that is then used in the SQL.  It's a page id.
</p>


<p>
But it doesn't make much sense to put a page id into an array called
<code>@pages</code>.  It doesn't contain pages, it contains <code>@page_ids</code>.
</p>


<p>
What about <code>$page_num</code>?  It doesn't contain a page number, it contains
the line number of the file we're reading in.  Or more conventionally,
an <code>$index</code> or <code>$idx</code>.
</p>


<pre><code>my $hits_upto_sth = $dbh-&gt;prepare(&lt;&lt;'SQL');
SELECT count(*)
FROM   lognew 
WHERE  pageid =  ? AND 
       data   &gt;= ?
SQL

my $hits_daily_sth = $dbh-&gt;prepare(&lt;&lt;'SQL');
SELECT count(*) 
FROM   lognew 
WHERE  pageid = ? AND 
       data   = ?
SQL

my $hits_range_sth = $dbh-&gt;prepare(&lt;&lt;'SQL');
SELECT count(*) 
FROM   lognew 
WHERE  pageid =  ? AND
       data   &lt;= ? AND 
       data   &gt;= ?
SQL

open (INPUT, "&lt; $filepageid") || &amp;file_open_error("$filepageid");

while ($<font color="#808000">page_id</font>=&lt;INPUT&gt;){
    $<font color="#808000">idx++</font>;
    chop($<font color="#808000">page_id</font>);
    $<font color="#808000">page_ids</font>[$idx] = $<font color="#808000">page_id</font>;

    $hits_upto_sth-&gt;execute($<font color="#808000">page_ids</font>[$<font color="#808000">idx</font>], $start_date);
    $hits_upto[$<font color="#808000">idx</font>] = $hits_upto_sth-&gt;fetchrow_array();

    $hits_daily_sth-&gt;execute($<font color="#808000">page_ids</font>[$<font color="#808000">idx</font>], $today);
    $hits_today[$<font color="#808000">idx</font>] = $hits_daily_sth-&gt;fetchrow_array();

    $hits_daily_sth-&gt;execute($<font color="#808000">page_ids</font>[$<font color="#808000">idx</font>], $yesterday);
    $hits_yesterday[$<font color="#808000">idx</font>] = $hits_daily_sth-&gt;fetchrow_array();

    $hits_range_sth-&gt;execute($<font color="#808000">page_ids</font>[$<font color="#808000">idx</font>], $end_of_30_days,
                                                   $start_of_30_days);
    $hits_monthly[$<font color="#808000">idx</font>] = $hits_range_sth-&gt;fetchrow_array();
}

close (INPUT);

</code></pre>
<p>
Test.  Log.  Check in.
</p>



<h3>Fixing Odd Interfaces</h3>
<p>

What's wrong with this picture?
</p>


<pre><code>$hits_range_sth-&gt;execute($page_ids[$idx], $end_of_30_days,
                                               $start_of_30_days);

</code></pre>
<p>
Isn't it a little odd to specify a date range with the end first?
Sure is.  It also guarantees someone is going to get it backwards.
Reverse it.  Don't forget the SQL, too.
</p>


<pre><code>my $hits_upto_sth = $dbh-&gt;prepare(&lt;&lt;'SQL');
SELECT count(*)
FROM   lognew 
WHERE  pageid =  ? AND 
       data   &gt;= ?
SQL

my $hits_daily_sth = $dbh-&gt;prepare(&lt;&lt;'SQL');
SELECT count(*) 
FROM   lognew 
WHERE  pageid = ? AND 
       data   = ?
SQL

my $hits_range_sth = $dbh-&gt;prepare(&lt;&lt;'SQL');
SELECT count(*) 
FROM   lognew 
WHERE  pageid =  ? AND
<font color="#808000">       data   &gt;= ? AND
       data   &lt;= ? </font>
SQL

open (INPUT, "&lt; $filepageid") || &amp;file_open_error("$filepageid");

while ($page_id=&lt;INPUT&gt;){
    $idx++;
    chop($page_id);
    $page_ids[$idx] = $page_id;

    $hits_upto_sth-&gt;execute($page_ids[$idx], $start_date);
    $hits_upto[$idx] = $hits_upto_sth-&gt;fetchrow_array();

    $hits_daily_sth-&gt;execute($page_ids[$idx], $today);
    $hits_today[$idx] = $hits_daily_sth-&gt;fetchrow_array();

    $hits_daily_sth-&gt;execute($page_ids[$idx], $yesterday);
    $hits_yesterday[$idx] = $hits_daily_sth-&gt;fetchrow_array();

    $hits_range_sth-&gt;execute($page_ids[$idx], <font color="#808000">$start_of_30_days,
                                                   $end_of_30_days</font>);
    $hits_monthly[$idx] = $hits_range_sth-&gt;fetchrow_array();
}

close (INPUT);

</code></pre>
<p>
Test.  Log.  Check in.
</p>



<h3>s/chop/chomp/</h3>
<p>

Now that we've stared at the code for a while, you might have noticed
the use of <code>chop()</code>.  Using <code>chop()</code> to strip a newline is asking
for portability problems, so let's fix it by using <code>chomp()</code>.
</p>


<p>
Technically this <em>isn't</em> a refactoring since we altered the behavior
of the code by fixing the bug.  But using <code>chop()</code> where you meant
<code>chomp()</code> is such a common mistake we'll make it an honorary
refactoring.
</p>


<pre><code>my $hits_upto_sth = $dbh-&gt;prepare(&lt;&lt;'SQL');
SELECT count(*)
FROM   lognew 
WHERE  pageid =  ? AND 
       data   &gt;= ?
SQL

my $hits_daily_sth = $dbh-&gt;prepare(&lt;&lt;'SQL');
SELECT count(*) 
FROM   lognew 
WHERE  pageid = ? AND 
       data   = ?
SQL

my $hits_range_sth = $dbh-&gt;prepare(&lt;&lt;'SQL');
SELECT count(*) 
FROM   lognew 
WHERE  pageid =  ? AND
       data   &gt;= ? AND
       data   &lt;= ? 
SQL

open (INPUT, "&lt; $filepageid") || &amp;file_open_error("$filepageid");

while ($page_id=&lt;INPUT&gt;){
    $idx++;
    <font color="#808000">chomp</font>($page_id);
    $page_ids[$idx] = $page_id;

    $hits_upto_sth-&gt;execute($page_ids[$idx], $start_date);
    $hits_upto[$idx] = $hits_upto_sth-&gt;fetchrow_array();

    $hits_daily_sth-&gt;execute($page_ids[$idx], $today);
    $hits_today[$idx] = $hits_daily_sth-&gt;fetchrow_array();

    $hits_daily_sth-&gt;execute($page_ids[$idx], $yesterday);
    $hits_yesterday[$idx] = $hits_daily_sth-&gt;fetchrow_array();

    $hits_range_sth-&gt;execute($page_ids[$idx], $start_of_30_days,
                                                   $end_of_30_days,);
    $hits_monthly[$idx] = $hits_range_sth-&gt;fetchrow_array();
}

close (INPUT);

</code></pre>
<p>
Test.  Log.  Check in.
</p>



<h3>Collect Related Variables into Hashes</h3>
<p>

The common prefix <code>hits_</code> is a dead giveaway that much of the data in
this code is related.  Related variables should be grouped together
into a single structure, probably a hash to make the relation obvious
and allow them to be passed around to subroutines more easily.  Its
easier to move around one hash than four arrays.
</p>


<p>
I've decided to collect together all the <code>@hit_</code> arrays into a single
hash <code>%hits</code> since they'll probably be used together parts of the
program.  If this code snippet represents a function it means I can
return one hash reference rather than four array refs.  It also makes
future expansion easier, rather than returning an additional array it
simply becomes another key in the hash.
</p>


<p>
Before.
</p>


<pre><code>$hits{upto}[$idx] = $hits_upto_sth-&gt;fetchrow_array();

</code></pre>
<p>
After.
</p>


<pre><code>$hits_upto[$idx]  = $hits_upto_sth-&gt;fetchrow_array();

</code></pre>
<p>
It's interesting to note what a small, natural change this is.
Circumstantial evidence that this is a good refactoring.
</p>


<p>
As before, since these arrays are global data, we must be sure to
change them everywhere.  This includes the tests.
</p>


<pre><code>my $hits_upto_sth = $dbh-&gt;prepare(&lt;&lt;'SQL');
SELECT count(*)
FROM   lognew 
WHERE  pageid =  ? AND 
       data   &gt;= ?
SQL

my $hits_daily_sth = $dbh-&gt;prepare(&lt;&lt;'SQL');
SELECT count(*) 
FROM   lognew 
WHERE  pageid = ? AND 
       data   = ?
SQL

my $hits_range_sth = $dbh-&gt;prepare(&lt;&lt;'SQL');
SELECT count(*) 
FROM   lognew 
WHERE  pageid =  ? AND
       data   &gt;= ? AND
       data   &lt;= ? 
SQL

open (INPUT, "&lt; $filepageid") || &amp;file_open_error("$filepageid");

while ($page_id=&lt;INPUT&gt;){
    $idx++;
    chomp($page_id);
    $page_ids[$idx] = $page_id;

    $hits_upto_sth-&gt;execute($page_ids[$idx], $start_date);
    $hits<font color="#808000">{upto}</font>[$idx] = $hits_upto_sth-&gt;fetchrow_array();

    $hits_daily_sth-&gt;execute($page_ids[$idx], $today);
    $hits<font color="#808000">{today}</font>[$idx] = $hits_daily_sth-&gt;fetchrow_array();

    $hits_daily_sth-&gt;execute($page_ids[$idx], $yesterday);
    $hits<font color="#808000">{yesterday}</font>[$idx] = $hits_daily_sth-&gt;fetchrow_array();

    $hits_range_sth-&gt;execute($page_ids[$idx], $start_of_30_days,
                                                   $end_of_30_days,);
    $hits<font color="#808000">{monthly}</font>[$idx] = $hits_range_sth-&gt;fetchrow_array();
}

close (INPUT);

</code></pre>
<p>
Test.  Log.  Check in.
</p>



<h3>When Not to Refactor</h3>
<p>

The statement handles are also related, but I'm not going to collect
them together into a hash.  The statement handles are short-lived
lexicals, they're never likely to be passed around.  Their short scope
and grouping within the code makes their relationship obvious.  The
design would not be improved by the refactoring.
</p>


<p>
Refactoring is not a set of rules to be slavishly followed, it's a
collection of tools.  And like any other tool you must carefully
consider when and when not to use it.  Since collecting the statement
handles together doesn't improve the design, I won't do it.
</p>













<h3>Eliminate Unnecessary Longhand</h3>
<p>

Boy, we sure use <code>$page_ids[$idx]</code> a lot.  It's the current page
ID.  But don't we have a variable for that?  
</p>


<p>
Replace all the unnecessary array accesses and just use the more
concise and descriptive <code>$page_id</code>.
</p>


<pre><code>my $hits_upto_sth = $dbh-&gt;prepare(&lt;&lt;'SQL');
SELECT count(*)
FROM   lognew 
WHERE  pageid =  ? AND 
       data   &gt;= ?
SQL

my $hits_daily_sth = $dbh-&gt;prepare(&lt;&lt;'SQL');
SELECT count(*) 
FROM   lognew 
WHERE  pageid = ? AND 
       data   = ?
SQL

my $hits_range_sth = $dbh-&gt;prepare(&lt;&lt;'SQL');
SELECT count(*) 
FROM   lognew 
WHERE  pageid =  ? AND
       data   &gt;= ? AND
       data   &lt;= ? 
SQL

open (INPUT, "&lt; $filepageid") || &amp;file_open_error("$filepageid");

while ($page_id=&lt;INPUT&gt;){
    $idx++;
    chomp($page_id);
    $page_ids[$idx] = $page_id;

    $hits_upto_sth-&gt;execute($<font color="#808000">page_id</font>, $start_date);
    $hits{upto}[$idx] = $hits_upto_sth-&gt;fetchrow_array();

    $hits_daily_sth-&gt;execute($<font color="#808000">page_id</font>, $today);
    $hits{today}[$idx] = $hits_daily_sth-&gt;fetchrow_array();

    $hits_daily_sth-&gt;execute($<font color="#808000">page_id</font>, $yesterday);
    $hits{yesterday}[$idx] = $hits_daily_sth-&gt;fetchrow_array();

    $hits_range_sth-&gt;execute($<font color="#808000">page_id</font>, $start_of_30_days,
                                       $end_of_30_days,);
    $hits{monthly}[$idx] = $hits_range_sth-&gt;fetchrow_array();
}

</code></pre>
<p>
Test.  Log.  Check in.
</p>



<h3>Rearrange Data Structures to Fit Their Use</h3>
<p>

Currently, <code>%hits</code> is accessed by the order the page ID was read out
of the file.  Well, that doesn't seem very useful at all.  Its purpose
seems to be for listing the page counts in exactly the same order as
you read them in.  Even then you need to iterate through <code>@page_ids</code>
simultaneously because no where in <code>%hits</code> is the page ID stored.
</p>


<p>
Consider a common operation, looking up the hit counts for a given
page ID.  You have to iterate through the whole list of page IDs to do
it.
</p>


<pre><code>foreach my $idx (0..$#page_ids) {
    if( $page_ids[$idx] eq $our_page_id ) {
        print "Hits for $our_page_id today: $hits{today}[$idx]\n";
        last;
    }
}

</code></pre>
<p>
Cumbersome.  A much better layout would be a hash keyed on the page ID.
</p>


<pre><code>$hits{upto}{$page_id} = $hits_upto_sth-&gt;fetchrow_array();

</code></pre>
<p>
Now we can directly access the data for a given page ID.  If
necessary, we can still list the hits in the same order they were read
in by iterating through <code>@page_ids</code>.
</p>


<pre><code>my $hits_upto_sth = $dbh-&gt;prepare(&lt;&lt;'SQL');
SELECT count(*)
FROM   lognew 
WHERE  pageid =  ? AND 
       data   &gt;= ?
SQL

my $hits_daily_sth = $dbh-&gt;prepare(&lt;&lt;'SQL');
SELECT count(*) 
FROM   lognew 
WHERE  pageid = ? AND 
       data   = ?
SQL

my $hits_range_sth = $dbh-&gt;prepare(&lt;&lt;'SQL');
SELECT count(*) 
FROM   lognew 
WHERE  pageid =  ? AND
       data   &gt;= ? AND
       data   &lt;= ? 
SQL

open (INPUT, "&lt; $filepageid") || &amp;file_open_error("$filepageid");

while ($page_id=&lt;INPUT&gt;){
    $idx++;
    chomp($page_id);
    $page_ids[$idx] = $page_id;

    $hits_upto_sth-&gt;execute($page_id, $start_date);
    $hits{upto}<font color="#808000">{$page_id}</font> = $hits_upto_sth-&gt;fetchrow_array();

    $hits_daily_sth-&gt;execute($page_id, $today);
    $hits{today}<font color="#808000">{$page_id}</font> = $hits_daily_sth-&gt;fetchrow_array();

    $hits_daily_sth-&gt;execute($page_id, $yesterday);
    $hits{yesterday}<font color="#808000">{$page_id}</font> = $hits_daily_sth-&gt;fetchrow_array();

    $hits_range_sth-&gt;execute($page_id, $start_of_30_days,
                                       $end_of_30_days,);
    $hits{monthly}<font color="#808000">{$page_id}</font> = $hits_range_sth-&gt;fetchrow_array();
}

</code></pre>
<p>
Test.  Log.  Check in.
</p>



<h3>Eliminate Unnecessary Variables</h3>
<p>

Now that <code>%hits</code> is no longer ordered by how it was read in, <code>$idx</code>
isn't used much anymore.  It's only used to stick <code>$page_id</code> onto the
end of <code>@page_ids</code>, but we can do that with <code>push</code>.
</p>


<p>
This is minor but little things build up to cause big messes.
</p>


<pre><code>my $hits_upto_sth = $dbh-&gt;prepare(&lt;&lt;'SQL');
SELECT count(*)
FROM   lognew 
WHERE  pageid =  ? AND 
       data   &gt;= ?
SQL

my $hits_daily_sth = $dbh-&gt;prepare(&lt;&lt;'SQL');
SELECT count(*) 
FROM   lognew 
WHERE  pageid = ? AND 
       data   = ?
SQL

my $hits_range_sth = $dbh-&gt;prepare(&lt;&lt;'SQL');
SELECT count(*) 
FROM   lognew 
WHERE  pageid =  ? AND
       data   &gt;= ? AND
       data   &lt;= ? 
SQL

open (INPUT, "&lt; $filepageid") || &amp;file_open_error("$filepageid");

while ($page_id=&lt;INPUT&gt;){
    chomp($page_id);
    <font color="#808000">push @page_ids, $page_id;</font>

    $hits_upto_sth-&gt;execute($page_id, $start_date);
    $hits{upto}{$page_id} = $hits_upto_sth-&gt;fetchrow_array();

    $hits_daily_sth-&gt;execute($page_id, $today);
    $hits{today}{$page_id} = $hits_daily_sth-&gt;fetchrow_array();

    $hits_daily_sth-&gt;execute($page_id, $yesterday);
    $hits{yesterday}{$page_id} = $hits_daily_sth-&gt;fetchrow_array();

    $hits_range_sth-&gt;execute($page_id, $start_of_30_days,
                                       $end_of_30_days,);
    $hits{monthly}{$page_id} = $hits_range_sth-&gt;fetchrow_array();
}

</code></pre>
<p>
Test.  Log.  Check in.
</p>



<h3>Pull Logical Chunks Out into Functions</h3>
<p>

Our final refactoring is one of the most common and most useful.
</p>


<p>
Let's assume that we need to generate page counts somewhere else in
the code.  Rather than repeat the code to do this, we want to put it
in a subroutine so it can be reused.  One subroutine for each
statement.
</p>


<p>
In order to do this, start by identifying the code that would go into
the routine.
</p>


<pre><code>$hits_upto_sth-&gt;execute($page_id, $start_date);
$hits{upto}{$page_id} = $hits_upto_sth-&gt;fetchrow_array();

</code></pre>
<p>
Then wrap a subroutine around it.
</p>


<pre><code><font color="#808000">sub hits_upto {</font>
    $hits_upto_sth-&gt;execute($page_id, $start_date);
    $hits{upto}{$page_id} = $hits_upto_sth-&gt;fetchrow_array();
<font color="#808000">}</font>

</code></pre>
<p>
Now look at all the variables used.
</p>


<p>
<code>$hits_upto_sth</code> is a global (well, file-scoped lexical) and is
defined entirely outside the function.  We can keep using it in our
subroutine in the same way we are now.
</p>


<p>
<code>$hits{upto}{$page_id}</code> is receiving the result of the calculation.
It contains the return value.  So it goes outside the function to
receive the return value.  Where its assignment was, we put a <code>return</code>.
</p>


<pre><code>sub hits_upto {
    $hits_upto_sth-&gt;execute($page_id, $start_date);
    <font color="#808000">return</font> $hits_upto_sth-&gt;fetchrow_array();
}

</code></pre>
<p>
<code>$page_id</code> and <code>$start_date</code> vary from call to call.  These are our
function arguments.
</p>


<pre><code>sub hits_upto {
    <font color="#808000">my($page_id, $start_date) = @_;</font>
    $hits_upto_sth-&gt;execute($page_id, $start_date);
    return $hits_upto_sth-&gt;fetchrow_array();
}

</code></pre>
<p>
Finally, rename things in a more generic manner.  This is a subroutine
for calculating the number of hits up to a certain date.  Instead of
<code>$start_date</code> which was specific to one calculation, we'd call it
<code>$date</code>.
</p>


<pre><code>sub hits_upto {
    my($page_id, <font color="#808000">$date</font>) = @_;
    $hits_upto_sth-&gt;execute($page_id, <font color="#808000">$date</font>);
    return $hits_upto_sth-&gt;fetchrow_array();
}

</code></pre>
<p>
And that's our new subroutine, does the same thing as the original
code.  Then it's a simple matter to use it in the code.
</p>

   
<pre><code>    $hits{upto}{$page_id} = <font color="#808000">hits_upto($page_id, $start_date)</font>;


my $hits_upto_sth = $dbh-&gt;prepare(&lt;&lt;'SQL');
SELECT count(*)
FROM   lognew 
WHERE  pageid =  ? AND 
       data   &gt;= ?
SQL

my $hits_daily_sth = $dbh-&gt;prepare(&lt;&lt;'SQL');
SELECT count(*) 
FROM   lognew 
WHERE  pageid = ? AND 
       data   = ?
SQL

my $hits_range_sth = $dbh-&gt;prepare(&lt;&lt;'SQL');
SELECT count(*) 
FROM   lognew 
WHERE  pageid =  ? AND
       data   &gt;= ? AND
       data   &lt;= ? 
SQL

open (INPUT, "&lt; $filepageid") || &amp;file_open_error("$filepageid");

while ($page_id=&lt;INPUT&gt;){
    chomp($page_id);
    <font color="#808000">push @page_ids, $page_id;</font>

    $hits{upto}{$page_id}      = <font color="#808000">hits_upto($page_id, $start_date)</font>;
    $hits{today}{$page_id}     = <font color="#808000">hits_daily($page_id, $today)</font>;
    $hits{yesterday}{$page_id} = <font color="#808000">hits_daily($page_id, $yesterday)</font>;
    $hits{monthly}{$page_id}   = <font color="#808000">hits_range($page_id, $start_of_30_days,
                                                        $end_of_30_days,)</font>;
}

sub hits_upto {
    my($page_id, $date) = @_;
    $hits_upto_sth-&gt;execute($page_id, $date);
    return scalar $hits_upto_sth-&gt;fetchrow_array();
}

sub hits_daily {
    my($page_id, $date) = @_;
    $hits_daily_sth-&gt;execute($page_id, $date);
    return scalar $hits_daily_sth-&gt;fetchrow_array();
}

sub hits_range {
    my($page_id, $start, $end) = @_;
    $hits_range_sth-&gt;execute($page_id, $start, $end);
    return scalar $hits_range_sth-&gt;fetchrow_array();
}

</code></pre>
<p>
Test.  Log.  Check in.
</p>



<h3>Undo.</h3>
<p>

Some may balk at putting that small of a snippet of code into a
subroutine like that.  There are definite performance concerns about
adding four subroutine calls to a loop.  But I'm not worried about
that at all.
</p>


<p>
One of the beauties of Refactoring is that it's reversible.
Refactorings don't change how the program works.  We can reverse any
of these refactorings and the code will work exactly the same.  If a
refactoring turns out to be a bad idea, undo it.  Logging each
refactoring in version control makes the job even easier.
</p>


<p>
So if it turns out moving the executes into their own functions causes
a performance problem the change can easily be undone.
</p>



<h3>Done?</h3>
<p>

At this point, things are looking pretty nice.  The code is well
structured, readable, and efficient.  The variables are sensibly named.
The data is organized in a fairly flexible manner.
</p>


<p>
It's good enough.  This is not to say that there's not more that could
be done, but we don't need to.  And Refactoring is about doing as much
redesign as you need instead of what you might need.
</p>



<h3>Refactoring and the Swiss Army Knife</h3>
<p>

As programmers we have a tendency towards over-design.  We like to
design our code to deal with any possible situation that might arise,
since it was hard to change the design later.  This is known as Big
Design Up Front (BDUF).  It's like one of those <a href="http://www.victorinox.com/newsite/en/produkte/neu/inhalt2.cfm?pid=1-6795-XLT">enormous Swiss Army Knives with 50 functions</a>.  Most of the time all you need is <a href="http://www.victorinox.com/newsite/en/produkte/neu/inhalt2.cfm?pid=2-2363">a knife with something to open your beer with and then maybe pick your teeth afterwards</a> but you never know.  
So you over-engineer because it's hard to improve it later.  If it never gets used then a lot of effort has been wasted.
</p>


<p>
Refactoring turns design on its ear.  Now you can continually evolve
your design as needed.  There's no longer a need to write for every
possible situation up front so you can focus on just what you need
right now.  If you need more flexibility later, you can add that
flexibility through refactoring.  It's like having a Swiss Army knife
that you can add tools to as you need them.
</p>



<h3>Further Reference</h3>
<ul>
<li><a href="http://groups.google.com/groups?th=11b4e3caaafb9849&amp;seekm=20021005063711.GE15102%40ool-18b93024.dyn.optonline.net#link1">The original thread on Fun With Perl</a></li>
<li>The <a href="http://www.c2.com/cgi/wiki?WelcomeVisitors">Portland Pattern Repository</a> answers the question -- <a href="http://www.c2.com/cgi/wiki?WhatIsRefactoring">WhatIsRefactoring?</a></li>
<li><a href="http://www.amazon.com/exec/obidos/tg/detail/-/0201485672">The Refactoring Book</a> by <a href="http://www.martinfowler.com">Martin Fowler</a></li>
</ul>
                                    </div>


                                </div>
                                <div class="asset-footer">

    
                                    <div class="entry-categories">
                                        <h4>Categories<span class="delimiter">:</span></h4>
                                        <ul>
                                            <li><a href="/pub/style-guides/" rel="tag">Style Guides</a></li>
                                        </ul>
                                    </div>
    


                                    <div class="entry-tags">
                                        <h4>Tags<span class="delimiter">:</span></h4>
                                        <ul>
                                            <li><a href="javascript:void(0)" onclick="location.href='http://www.perl.com/mt-search.cgi?blog_id=2&amp;tag=faster&amp;limit=20';return false;" rel="tag">faster</a><span class="delimiter">,</span></li> <li><a href="javascript:void(0)" onclick="location.href='http://www.perl.com/mt-search.cgi?blog_id=2&amp;tag=optimization&amp;limit=20';return false;" rel="tag">optimization</a><span class="delimiter">,</span></li> <li><a href="javascript:void(0)" onclick="location.href='http://www.perl.com/mt-search.cgi?blog_id=2&amp;tag=perl&amp;limit=20';return false;" rel="tag">perl</a><span class="delimiter">,</span></li> <li><a href="javascript:void(0)" onclick="location.href='http://www.perl.com/mt-search.cgi?blog_id=2&amp;tag=refactoring&amp;limit=20';return false;" rel="tag">refactoring</a><span class="delimiter">,</span></li> <li><a href="javascript:void(0)" onclick="location.href='http://www.perl.com/mt-search.cgi?blog_id=2&amp;tag=refactoring%20techniques&amp;limit=20';return false;" rel="tag">refactoring techniques</a><span class="delimiter">,</span></li> <li><a href="javascript:void(0)" onclick="location.href='http://www.perl.com/mt-search.cgi?blog_id=2&amp;tag=speed&amp;limit=20';return false;" rel="tag">speed</a></li>
                                        </ul>
                                    </div>

                                </div>
                            </div>


                    
                    


                        </div>
                    </div>


                    <div id="beta">
    <div id="beta-inner">


    
    <div class="widget-what-is-perl widget">
    <div class="widget-content widget-content-what-is-perl">
       Visit the home of the  Perl programming language: <a href="http://www.perl.org/">Perl.org</a
    </div>
</div>
<div class="widget-find-out-more widget-archives widget">
    <div class="widget-content">
        <ul>
            <li><a href="http://www.perl.org/get.html">Download</a></li>
            <li><a href="http://perldoc.perl.org/">Documentation</a></li>
            <li><a href="http://blogs.perl.org/">Perl Bloggers</a></li>
            <li><a href="http://news.perlfoundation.org/">Foundation News</a></li>
        </ul>
    </div>
</div><div class="widget-tcpc widget">
<h3 class="widget-header">Sponsored by</h3>
    <div class="widget-content">
        <a href="http://training.perl.com/" alt="Perl Training" target="_blank"><img src="/i/tcpc.png" width="150" height="50"></a>
    </div>
</div>

<div class="widget-syndication widget">
    <div class="widget-content">
        <ul>
            <li><img src="/mt-static/images/status_icons/feed.gif" alt="Subscribe to feed" width="9" height="9" /> <a href="/pub/atom.xml">Subscribe to this website's feed</a></li>

        </ul>
    </div>
</div>
<div class="widget-archive-monthly widget-archive widget">
    <h3 class="widget-header">Monthly <a href="/pub/archives.html">Archives</a></h3>
    <div class="widget-content">
        <ul>
        
            <li><a href="/pub/2010/07/">July 2010 (1)</a></li>
        
    
        
            <li><a href="/pub/2008/05/">May 2008 (1)</a></li>
        
    
        
            <li><a href="/pub/2008/04/">April 2008 (2)</a></li>
        
    
        
            <li><a href="/pub/2008/03/">March 2008 (1)</a></li>
        
    
        
            <li><a href="/pub/2008/02/">February 2008 (1)</a></li>
        
    
        
            <li><a href="/pub/2008/01/">January 2008 (1)</a></li>
        
    
        
            <li><a href="/pub/2007/12/">December 2007 (2)</a></li>
        
    
        
            <li><a href="/pub/2007/09/">September 2007 (1)</a></li>
        
    
        
            <li><a href="/pub/2007/08/">August 2007 (1)</a></li>
        
    
        
            <li><a href="/pub/2007/07/">July 2007 (1)</a></li>
        
    
        
            <li><a href="/pub/2007/06/">June 2007 (1)</a></li>
        
    
        
            <li><a href="/pub/2007/05/">May 2007 (1)</a></li>
        
    
        
            <li><a href="/pub/2007/04/">April 2007 (1)</a></li>
        
    
        
            <li><a href="/pub/2007/03/">March 2007 (1)</a></li>
        
    
        
            <li><a href="/pub/2007/02/">February 2007 (1)</a></li>
        
    
        
            <li><a href="/pub/2007/01/">January 2007 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/12/">December 2006 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/11/">November 2006 (2)</a></li>
        
    
        
            <li><a href="/pub/2006/10/">October 2006 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/09/">September 2006 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/08/">August 2006 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/07/">July 2006 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/06/">June 2006 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/05/">May 2006 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/04/">April 2006 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/03/">March 2006 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/02/">February 2006 (4)</a></li>
        
    
        
            <li><a href="/pub/2006/01/">January 2006 (4)</a></li>
        
    
        
            <li><a href="/pub/2005/12/">December 2005 (4)</a></li>
        
    
        
            <li><a href="/pub/2005/11/">November 2005 (3)</a></li>
        
    
        
            <li><a href="/pub/2005/10/">October 2005 (2)</a></li>
        
    
        
            <li><a href="/pub/2005/09/">September 2005 (2)</a></li>
        
    
        
            <li><a href="/pub/2005/08/">August 2005 (9)</a></li>
        
    
        
            <li><a href="/pub/2005/07/">July 2005 (8)</a></li>
        
    
        
            <li><a href="/pub/2005/06/">June 2005 (9)</a></li>
        
    
        
            <li><a href="/pub/2005/05/">May 2005 (8)</a></li>
        
    
        
            <li><a href="/pub/2005/04/">April 2005 (7)</a></li>
        
    
        
            <li><a href="/pub/2005/03/">March 2005 (6)</a></li>
        
    
        
            <li><a href="/pub/2005/02/">February 2005 (7)</a></li>
        
    
        
            <li><a href="/pub/2005/01/">January 2005 (6)</a></li>
        
    
        
            <li><a href="/pub/2004/12/">December 2004 (8)</a></li>
        
    
        
            <li><a href="/pub/2004/11/">November 2004 (8)</a></li>
        
    
        
            <li><a href="/pub/2004/10/">October 2004 (5)</a></li>
        
    
        
            <li><a href="/pub/2004/09/">September 2004 (9)</a></li>
        
    
        
            <li><a href="/pub/2004/08/">August 2004 (6)</a></li>
        
    
        
            <li><a href="/pub/2004/07/">July 2004 (8)</a></li>
        
    
        
            <li><a href="/pub/2004/06/">June 2004 (6)</a></li>
        
    
        
            <li><a href="/pub/2004/05/">May 2004 (7)</a></li>
        
    
        
            <li><a href="/pub/2004/04/">April 2004 (8)</a></li>
        
    
        
            <li><a href="/pub/2004/03/">March 2004 (8)</a></li>
        
    
        
            <li><a href="/pub/2004/02/">February 2004 (9)</a></li>
        
    
        
            <li><a href="/pub/2004/01/">January 2004 (7)</a></li>
        
    
        
            <li><a href="/pub/2003/12/">December 2003 (4)</a></li>
        
    
        
            <li><a href="/pub/2003/11/">November 2003 (7)</a></li>
        
    
        
            <li><a href="/pub/2003/10/">October 2003 (8)</a></li>
        
    
        
            <li><a href="/pub/2003/09/">September 2003 (6)</a></li>
        
    
        
            <li><a href="/pub/2003/08/">August 2003 (7)</a></li>
        
    
        
            <li><a href="/pub/2003/07/">July 2003 (9)</a></li>
        
    
        
            <li><a href="/pub/2003/06/">June 2003 (9)</a></li>
        
    
        
            <li><a href="/pub/2003/05/">May 2003 (8)</a></li>
        
    
        
            <li><a href="/pub/2003/04/">April 2003 (8)</a></li>
        
    
        
            <li><a href="/pub/2003/03/">March 2003 (10)</a></li>
        
    
        
            <li><a href="/pub/2003/02/">February 2003 (8)</a></li>
        
    
        
            <li><a href="/pub/2003/01/">January 2003 (8)</a></li>
        
    
        
            <li><a href="/pub/2002/12/">December 2002 (5)</a></li>
        
    
        
            <li><a href="/pub/2002/11/">November 2002 (9)</a></li>
        
    
        
            <li><a href="/pub/2002/10/">October 2002 (7)</a></li>
        
    
        
            <li><a href="/pub/2002/09/">September 2002 (11)</a></li>
        
    
        
            <li><a href="/pub/2002/08/">August 2002 (8)</a></li>
        
    
        
            <li><a href="/pub/2002/07/">July 2002 (8)</a></li>
        
    
        
            <li><a href="/pub/2002/06/">June 2002 (4)</a></li>
        
    
        
            <li><a href="/pub/2002/05/">May 2002 (6)</a></li>
        
    
        
            <li><a href="/pub/2002/04/">April 2002 (6)</a></li>
        
    
        
            <li><a href="/pub/2002/03/">March 2002 (7)</a></li>
        
    
        
            <li><a href="/pub/2002/02/">February 2002 (5)</a></li>
        
    
        
            <li><a href="/pub/2002/01/">January 2002 (8)</a></li>
        
    
        
            <li><a href="/pub/2001/12/">December 2001 (7)</a></li>
        
    
        
            <li><a href="/pub/2001/11/">November 2001 (5)</a></li>
        
    
        
            <li><a href="/pub/2001/10/">October 2001 (9)</a></li>
        
    
        
            <li><a href="/pub/2001/09/">September 2001 (7)</a></li>
        
    
        
            <li><a href="/pub/2001/08/">August 2001 (13)</a></li>
        
    
        
            <li><a href="/pub/2001/07/">July 2001 (8)</a></li>
        
    
        
            <li><a href="/pub/2001/06/">June 2001 (13)</a></li>
        
    
        
            <li><a href="/pub/2001/05/">May 2001 (11)</a></li>
        
    
        
            <li><a href="/pub/2001/04/">April 2001 (9)</a></li>
        
    
        
            <li><a href="/pub/2001/03/">March 2001 (8)</a></li>
        
    
        
            <li><a href="/pub/2001/02/">February 2001 (8)</a></li>
        
    
        
            <li><a href="/pub/2001/01/">January 2001 (8)</a></li>
        
    
        
            <li><a href="/pub/2000/12/">December 2000 (6)</a></li>
        
    
        
            <li><a href="/pub/2000/11/">November 2000 (10)</a></li>
        
    
        
            <li><a href="/pub/2000/10/">October 2000 (10)</a></li>
        
    
        
            <li><a href="/pub/2000/09/">September 2000 (2)</a></li>
        
    
        
            <li><a href="/pub/2000/08/">August 2000 (2)</a></li>
        
    
        
            <li><a href="/pub/2000/07/">July 2000 (5)</a></li>
        
    
        
            <li><a href="/pub/2000/06/">June 2000 (7)</a></li>
        
    
        
            <li><a href="/pub/2000/05/">May 2000 (7)</a></li>
        
    
        
            <li><a href="/pub/2000/04/">April 2000 (3)</a></li>
        
    
        
            <li><a href="/pub/2000/03/">March 2000 (2)</a></li>
        
    
        
            <li><a href="/pub/2000/02/">February 2000 (2)</a></li>
        
    
        
            <li><a href="/pub/2000/01/">January 2000 (2)</a></li>
        
    
        
            <li><a href="/pub/1999/12/">December 1999 (6)</a></li>
        
    
        
            <li><a href="/pub/1999/11/">November 1999 (6)</a></li>
        
    
        
            <li><a href="/pub/1999/10/">October 1999 (5)</a></li>
        
    
        
            <li><a href="/pub/1999/09/">September 1999 (4)</a></li>
        
    
        
            <li><a href="/pub/1999/08/">August 1999 (3)</a></li>
        
    
        
            <li><a href="/pub/1999/07/">July 1999 (2)</a></li>
        
    
        
            <li><a href="/pub/1999/06/">June 1999 (3)</a></li>
        
    
        
            <li><a href="/pub/1999/04/">April 1999 (1)</a></li>
        
    
        
            <li><a href="/pub/1999/03/">March 1999 (1)</a></li>
        
    
        
            <li><a href="/pub/1999/01/">January 1999 (1)</a></li>
        
    
        
            <li><a href="/pub/1998/12/">December 1998 (1)</a></li>
        
    
        
            <li><a href="/pub/1998/11/">November 1998 (1)</a></li>
        
    
        
            <li><a href="/pub/1998/07/">July 1998 (2)</a></li>
        
    
        
            <li><a href="/pub/1998/06/">June 1998 (1)</a></li>
        
    
        
            <li><a href="/pub/1998/03/">March 1998 (1)</a></li>
        
        </ul>
    </div>
</div>
        
    

<div class="widget-powered widget">
    <div class="widget-content">
        <a href="http://www.movabletype.com/"><img src="/mt-static/images/bug-pbmt-white.png" alt="Powered by Movable Type 5.02" width="120" height="75" /></a>
    </div>
</div>



    </div>
</div>






                </div>
            </div>


            <div id="footer">
    <div id="footer-inner">
        <div id="footer-content">
            <div class="widget-powered widget">
                <div class="widget-content">
                    Powered by <a href="http://www.movabletype.com/" rel="generator">Movable Type Pro</a>
                </div>
            </div>

        </div>
    </div>
</div>



        </div>
    </div>
</body>
</html>
