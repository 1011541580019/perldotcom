<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" id="sixapart-standard">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="generator" content="Movable Type Pro 5.13-en" />
<link rel="stylesheet" href="/pub/styles.css" type="text/css" />
<link rel="start" href="/pub/" title="Home" />
<link rel="alternate" type="application/atom+xml" title="Recent Entries" href="/pub/atom.xml" />
<script type="text/javascript" src="/pub/mt.js"></script>
<!--
<rdf:RDF xmlns="http://web.resource.org/cc/"
         xmlns:dc="http://purl.org/dc/elements/1.1/"
         xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#">
<Work rdf:about="/pub/">
<dc:title>Perl.com</dc:title>
<dc:description>news and views of the Perl programming language</dc:description>
<license rdf:resource="http://creativecommons.org/licenses/by-nc-nd/3.0/" />
</Work>
<License rdf:about="http://creativecommons.org/licenses/by-nc-nd/3.0/">
</License>
</rdf:RDF>
-->

<script type="text/javascript">

 var _gaq = _gaq || [];
 _gaq.push(['_setAccount', 'UA-50555-22']);
 _gaq.push(['_trackPageview']);

 (function() {
   var ga = document.createElement('script'); ga.type =
   'text/javascript'; ga.async = true;
   ga.src = ('https:' == document.location.protocol ? 'https://ssl' :
   'http://www') + '.google-analytics.com/ga.js';
   var s = document.getElementsByTagName('script')[0];
   s.parentNode.insertBefore(ga, s);
 })();

</script>
<script type='text/javascript' src='http://partner.googleadservices.com/gampad/google_service.js'></script>
<script type='text/javascript'>
GS_googleAddAdSenseService("ca-pub-4136420132070439");
GS_googleEnableAllServices();
</script>
<script type='text/javascript'>
GA_googleAddSlot("ca-pub-4136420132070439", "Perl_728x90");
</script>
<script type='text/javascript'>GA_googleFetchAds();</script>
    <title>Perl.com: October 2003 Archives</title>


    <link rel="prev" href="/pub/2003/09/" title="September 2003" />
    <link rel="next" href="/pub/2003/11/" title="November 2003" />

</head>
<body id="perl-com" class="mt-archive-listing mt-datebased-monthly-archive layout-wt">
    <div id="container">
        <div id="container-inner">


            <div id="header">
    <div id="header-inner">
        <div id="header-content">
        <span id="top_advert"> 
<!-- Put any landscape advert in here -->
<!-- Perl_728x90 -->
<script type='text/javascript'>
GA_googleFillSlot("Perl_728x90");
</script>
        </span> 



            <div id="header-name"><a href="/pub/" accesskey="1">Perl.com</a></div>
            <div id="header-description">news and views of the Perl programming language</div>




        </div>
    </div>
</div>



            <div id="content">
                <div id="content-inner">


                    <div id="alpha">
                        <div id="alpha-inner">


                            <h1 id="page-title" class="archive-title">October 2003 Archives</h1>





                            
                            <div id="entry-1208" class="entry-asset asset hentry">
    <div class="asset-header">
        <h2 class="asset-name entry-title"><a href="/pub/2003/10/31/openguides.html" rel="bookmark">Open Guides</a></h2>
        <div class="asset-meta">
            <span class="byline">
    
                By <span class="vcard author">Kake Pugh</span> on <abbr class="published" title="2003-10-31T00:00:00-08:00">October 31, 2003 12:00 AM</abbr>
    
            </span>

            
            

        </div>
    </div>
    <div class="asset-content entry-content">

        <div class="asset-body">
            
<!-- sidebar begins -->
<!-- don't move sidebars -->
<!-- sidebar ends -->

<p>First, a disclaimer.</p>

<p>I'm not a wiki celebrity.  I don't look good in StudlyCaps.  I'm
not part of the wiki culture &#8212; I've never contributed to <a href="http://c2.com/cgi/wiki?WelcomeVisitors">Ward's Wiki</a>, never
used <a href="http://twiki.org/">TWiki</a>, am baffled by <a href="http://twistedmatrix.com/users/jh.twistd/moin/moin.cgi/FrontPage">MoinMoin</a>,
and every time I look at <a href="http://www.usemod.com/cgi-bin/wiki.pl">UseMod</a> code, my brain
turns to mashed banana.  Most wiki people probably have no idea who I
am.</p>

<p>Having said that, I'm going to spend 2,500 words or so advocating
the possibilities of Ward Cunningham's simple, potent idea, and
explaining how I and a couple of other <a href="http://london.pm.org">Perlmongers</a> have applied it to create
what I think is one of the most exciting Perl applications currently
in existence &#8212; OpenGuides.</p>

<h3>Beginnings</h3>

<p>grubstreet, the predecessor to OpenGuides, was conceived in early 2002
when I asked Earle Martin whether he knew of a London wiki:</p>

<pre><code>
It seems that my friend's Wiki is running UseModWiki; I think I rather
like it.  It would be good if there was one of these for info about
London; do you know if anyone's done that?  Things like which pubs
serve food and good beer, etc.; which is the best end of the platform
to stand at to get a seat (discussed this kind of thing with blech
recently).
</code></pre>

<p>Earle was enthusiastic and made it so.  We both got very excited and
started filling the thing with content.  Wiki makes this easy!  You're
reading a web page and spot something that's wrong or missing.  Click
the &quot;edit&quot; link, add your comment, and it's right there.</p>

<h3>Continuings</h3>

<p>It didn't take long before we started bumping our heads against the
limitations of the <code>usemod</code> software.  Even leaving aside its tendency
to clamp down on its (custom-format) flat-file database and refuse
anyone edit access, I found myself writing umpteen screenscrapers to
do simple things like find a nice pub in Soho.  I hate screenscraping,
but I love my beer.</p>

<p>We tried to patch and amend <code>usemod</code>.  We tried very hard.  Ivor
Williams, in particular, spent a lot of time in its guts.  I decided in
the end that writing software should only hurt some of the time, and
after several beers one night, made a pact with Chris Ball that
grubstreet's software would be rewritten in Real Perl.  Chris held me
to it, and a CPAN-friendly wiki toolkit &#8212; <a href="http://search.cpan.org/~kake/CGI-Wiki/">CGI::Wiki</a> &#8212;
resulted.  Once we had that to build on, we started on the CGI script
that eventually turned into <a href="http://search.cpan.org/~kake/OpenGuides/">the OpenGuides
distribution</a>.</p>

<h3>What It Says on the Tin</h3>

<blockquote>
<a href="http://openguides.org/">OpenGuides</a> is a
complete web application for managing a collaboratively written guide
to a city or town.
</blockquote>

<p>Install OpenGuides, and what you get is a blank framework waiting
for you to put content into it.</p>


<!-- sidebar begins -->
<table width="220" border="0" cellspacing="8" cellpadding="4" align="right">
<tr>
<td width="220" valign="top" bgcolor="#efefef">
<div class="secondary"><p>There's an opportunity right here for anyone wanting to join the project team.
Write a set of pages for bundling with new installs of the OpenGuides
software &#8212; how to use the Guide, how to format your entries, maybe
stub pages for things that all cities have in common, maybe a category
framework for transport pages &#8212; you're bound to be able to come up
with better ideas than those of us who've been using the software for
ages and are blind to its confusing spots.</p>
</div>
</td></tr></table>
<!-- sidebar ends -->


<h3>Just a Skeleton, But a Damned Sturdy One</h3>

<p>No, we didn't just give you the equivalent of an empty directory to
put your HTML files into.  Start adding pages and you'll see.</p>

<p>Suppose I want to add a page about my local pub.  I'll click on
&quot;Create a new page&quot; and type in the page name.  What should
I call it?  Well, this is a new OpenGuides install, with no
established conventions, so I could call it &quot;The Drapers
Arms&quot;, &quot;Drapers Arms&quot;, &quot;The Drapers Arms
(Islington)&quot;, or whatever.  I just need to keep in mind that the name
needs to be unique, so if I expect there to be more than one Drapers
Arms in my city, I really should add some other kind of identifying
information.  <a href="http://london.openguides.org/">The Open Guide
to London</a> has a convention of including the postcode &#8212; thus
&quot;Drapers Arms, N1 1ER&quot;.</p>

<p>OK, so I've done that, and now I'm presented with an editing form with
several boxes for me to type into.  The first, Content, is a freeform
box where I can put any information that doesn't fit into the
particular boxes below.</p>

<p>Locales and Categories are the next boxes.  I can put whatever I like
into these, and so can later visitors to this Guide.  I don't need to
decide right now on a useful way to divide my city into locales; it'll
just emerge from the aggregated opinion of all the people who
contribute.  I can always come back to this, my first page, in a few
months and add any later-defined categories or locales that seem to
apply to it.  Or I may not need to; someone else may have got around
to it before me.</p>

<p>Locales and categories are excellent ways to make sure that your
newly added content doesn't drift off into a decoupled purgatory of
unlinked pages.  Just add the Pubs category and the Islington locale to
the Drapers Arms page, and anyone doing a search &#8212; whether a simple
type-into-box or a directed <a href="http://london.openguides.org/index.cgi?action=index;index_type=locale;index_value=Islington">locale</a>
or <a href="http://london.openguides.org/index.cgi?action=index;index_type=category;index_value=Pubs">category</a> search &#8212; will find it.</p>

<p>Next, we get a set of smaller boxes for entering things like more-detailed location information, contact information, and opening hours.
These boxes may be completely irrelevant to many, most, or all pages
in your Guide.  That's OK.  They're optional.  But if you <i>do</i>
fill them in, you get to play with what I feel is one of the most
innovative, yet simple, features of OpenGuides &#8212; <a href="http://london.openguides.org/index.cgi?distance_in_metres=500&id=Piccadilly+Circus+Station&action=find_within_distance&Go=Go">find
me everything within half a kilometre of Piccadilly Circus Tube station</a>.
Please.  Because my feet hurt and I could murder a glass of wine.</p>

<h3>Customization and Extension</h3>

<p>I meant it when I said I wanted to be able to find pubs.  I want to
find all pubs in Notting Hill that serve food and have a beer garden.
The Open Guide to London must have this information!  There's no
obvious way to get  to it directly, though.  I may have to write some
code.</p>

<p>Given that I'm one of the admins, I have access to the database on the
server &#8212; so I can call the CGI::Wiki <code>list_nodes_by_metadata</code> method
directly to find all pages in Category Pubs, Locale Notting Hill, and
Category Pub Food.</p>

<p>I wrote a CGI script to take in options for selecting pubs and output
results.  It's very useful, so will be in one of the next few official
OpenGuides releases.  Here's an excerpt.  Note that the locale and
categories are simply stored as CGI::Wiki metadata.  Note also the use
of CGI::Wiki::Plugin::Locator::UK to allow searching by nearest Tube
station.  You could easily adapt this if you live in a city where
people navigate by some other kind of landmark.</p>

<pre><code>
my %possible_features = (
    "beer gardens"    => "Has beer garden",
    "function room"   => "Has function room",
    "good beer guide" => "Appears in the CAMRA Good Beer Guide",
    "real cider"      => "Serves real cider",
    "belgian beer"    => "Serves Belgian beer",
    "pub food"        => "Serves food of some kind",
);

if ( $action eq "search" ) {
    my @locales       = CGI::param( "locale" );
    my @features      = CGI::param( "feature" );
    my @tube_stations = CGI::param( "tube" );

    # Ignore the blank "any locales" option.
    @locales = grep { $_ } @locales;

    # Ensure that we only look for 'allowed' features.
    @features = grep { $possible_features{$_} } @features;

    # Ensure that we only look for extant Tube stations.
    my %is_tube = map { $_ => 1 } list_tube_stations();
    @tube_stations = grep { $is_tube{$_} } @tube_stations;

    # Grab all the pubs, to start with.
    my @pubs = $wiki->list_nodes_by_metadata(
                   metadata_type => "category",
                   metadata_value => "pubs",
                   ignore_case   => 1,
    );

    # Filter by locale if specified.
    if ( scalar @locales > 0 ) {
        my @in_locale;
        foreach my $locale ( @locales ) {
            push @in_locale,
                 $wiki->list_nodes_by_metadata(
                     metadata_type  => "locale",
                     metadata_value => $locale,
                     ignore_case    => 1,
                 );
        }
        my %in_locale_hash = map { $_ => 1 } @in_locale;
        @pubs = grep { $in_locale_hash{$_} } @pubs;
    }

    # Filter by Tube station if specified.
    if ( scalar @tube_stations > 0 ) {
        my $locator = CGI::Wiki::Plugin::Locator::UK->new;
        $wiki->register_plugin( plugin => $locator );
        my @near_station;
        foreach my $station ( @tube_stations ) {
            push @near_station,
                $locator->find_within_distance(
                    node   => $station . " Station",
                    metres => 600,
                );
         }
         my %near_station_hash = map { $_ => 1 } @near_station;
         @pubs = grep { $near_station_hash{$_} } @pubs;
    }

    # Filter by features if specified.
    if ( scalar @features > 0 ) {
        my %has_feature = map { $_ => [] } @pubs;
        foreach my $feature ( @features ) {
            my @has_this_feature = $wiki->list_nodes_by_metadata(
                     metadata_type  => "category",
                     metadata_value => $feature,
                     ignore_case    => 1,
                 );
            foreach my $pub ( @has_this_feature ) {
                push @{ $has_feature{$pub} }, $feature;
            }
        }
        # Only keep pubs that have *all* the requested features.
        @pubs = grep { scalar @{ $has_feature{$_} } == scalar @features }
                     @pubs;
    }

    show_results(
                  pubs          => \@pubs,
                  locales       => \@locales,
                  tube_stations => \@tube_stations,
                  features      => [ @possible_features{ @features } ],
                );
</code></pre>

<h3>You Can Do It, Too</h3>

<p>Suppose I'd had the idea for this directed pub search but didn't have
direct access to any OpenGuides data store?  No problem &#8212; I can play
with the RDF interface.  Most OpenGuides pages have a link to an RDF
version, and this includes the auto-generated pages like locale or
category search results.</p>

<p>I can send a query like <a href="http://london.openguides.org/index.cgi?action=index;index_type=category;index_value=Pubs;format=rdf">http://london.openguides.org/index.cgi?action=index;index_type=category;index_value=Pubs;format=rdf</a> and then use RDF::Core::Parser to parse the returned RDF/XML and get
the data that otherwise would have required CGI::Wiki calls.</p>

<p class="another side note please"> The RDF interface isn't too well
advertised.  A list of places where any kind of link to an RDF version
is missing would be most useful.</p>

<p>Given the simple data model of an OpenGuides page, such an external
add-on would be trivial to incorporate into the core distribution.
So once you've written one, send it to us.</p>

<p>The RDF interface is also ideal for people interested in writing IRC
bots:</p>

<pre><code>
15:12 &lt;Kake&gt; grotbot: things in Chinatown
15:12 &lt;grotbot&gt; OK, working on it
&lt;grotbot&gt; Kake: things in Chinatown: Crispy Duck, W1D 6PR; De Hems,
          W1D 5BW; Golden Harvest, WC2H 7BE; HK Diner; Hung's, W1D 6PR;
          Misato, W1D 6PG; Tai, W1D 4DH; Tokyo Diner; Zipangu, WC2H 7JJ
</code></pre>

<h3>Caveats</h3>

<p>The OpenGuides software is still young.  The install procedure, in
particular, needs a good going-over, plus some of the location features
only currently work for guides to cities located in the UK.</p>

<h3>Live OpenGuides Installs</h3>

<ul>
<li>The biggest and most widely used install is <a href="http://london.openguides.org/">the original London one</a>.</li>
<li>Oxford has two OpenGuides sites &#8212; <a href="http://oxford.openguides.org/">The Oxford Guide</a> and <a href="http://the.earth.li/~kake/cgi-bin/openguides/vegan-oxford.cgi">The Vegan Guide to Oxford</a></li>
<li>... Your city belongs here! ...</li>
</ul>

<h3>Similar systems</h3>

<ul>
<li><a href="http://knowhere.co.uk/">Knowhere</a></li>
<li><a href="http://www.regveg.org">RegVeg</a></li>
<li><a href="http://www.capitancook.com">Capitan Cook</a></li>
</ul>

        </div>



    </div>
    <div class="asset-footer"></div>
</div>


                            
                            <div id="entry-1214" class="entry-asset asset hentry">
    <div class="asset-header">
        <h2 class="asset-name entry-title"><a href="/pub/2003/10/p6pdigest/20031026.html" rel="bookmark">This week on Perl 6, week ending 2003-10-26</a></h2>
        <div class="asset-meta">
            <span class="byline">
    
                By <span class="vcard author">Piers Cawley</span> on <abbr class="published" title="2003-10-26T00:00:00-08:00">October 26, 2003 12:00 AM</abbr>
    
            </span>

            
            

        </div>
    </div>
    <div class="asset-content entry-content">

        <div class="asset-body">
            
<p>Where does the time go? It seems like only yesterday that I was sat
hiding Leon Brocard in the first letters of the first 11 body
paragraphs of the last summary. Now, here I am, on the train, typing
away in a desperate attempt to get this mailed out before
Wednesday. Let's start with perl6-internals again.</p>

<h4><a name="object freezing">Object Freezing</a></h4>
<p>Whoever would have thought that freezing objects would be so
controversial? Object freezing is when you take an object and generate
a 'frozen' representation of it that can be used to make a copy of the
original object. It's what Storable, Data::Dumper and YAML (to name
three Perl 5 modules) all do more or less successfully. (Most of the
time there's no problem, the tricky case is a composite object which
involves a circular data structure. Consider this:</p>
<pre><code>
    Ring -&gt; A -&gt; B -&gt; C -&gt; D
            ^              |
            `--------------'</code></pre>
<p>(It's not <em>quite</em> a purely academic example, I can point to at least
one text editor that uses a similar data structure).</p>
<p>When you come to freeze your ring, you need some way of detecting the
cycle and generating a finite representation that works.  This isn't
the only problem; thread safety is hard, for instance.)</p>
<p>Dan's set some fairly stringent requirements on whatever mechanism is
used for freezing. The most important/stringent is the requirement
that (because freezing during object destruction will be a
possibility) object traversal is not allowed to use additional memory
for that traversal.</p>
<p>Dan is convinced that we can do this using the Garbage Collector's
object traversal system. Leo T&ouml;tsch is equally convinced that
we can't. The resulting thread is rather meaty and hard to summarize
without massive amounts of cut and paste so I'll just point you at
the root message. The upshot is that we're doing it Dan's way;
Glorious Leader continues to trump Pumpking Patchmonster.</p>
<p>In another subthread there was a good deal of misunderstanding about
XML declarations and parsing, which got cleared up surprisingly
quickly.</p>
<p><a href="http://groups.google.com/groups?threadm=Pine.LNX.4.58.0310201437430.399%40sprite.sidhe.org">http://groups.google.com/groups</a></p>

<h4><a name="object instantiation">Object Instantiation</a></h4>
<p>Dan had a moment of clarity and declared that the Parrot Way to
instantiate an object in class Foo will be:</p>
<pre><code>
  new P5, .Foo</code></pre>
<p>All we need now is a working implementation. And, apparently, knowing
what class a class is a member of might be handy, but Dan's punting
on (``ignoring the heck out of'') that one.</p>
<p><a href="http://groups.google.com/groups?threadm=Pine.LNX.4.58.0310211010440.20236%40sprite.sidhe.org">http://groups.google.com/groups</a></p>

<h4><a name="a less controversial api addition">A less controversial API addition</a></h4>
<p>In the middle of the discussion about object freezing, Dan popped up
another thread to discuss how to invoke Sub/Method PMCs from C
code. So Leo implemented <code>Parrot_runops_fromc_args()</code>, but he's not
exactly happy about the name. Regardless of the name, having this
implemented is rather spiffy.</p>
<p><a href="http://groups.google.com/groups?threadm=Pine.LNX.4.58.0310211059270.20236%40sprite.sidhe.org">http://groups.google.com/groups</a></p>

<h4><a name="old big problems before new big problems">Old Big Problems before New Big Problems</a></h4>
<p>Melvin Smith popped up with a rant about the Parrot development
effort's tendency to rush off to implement new stuff before making
double sure about the 'old' stuff is actually complete and robust. To
which I can only say ``Hear! Hear!'' Dan agreed, and threatened to give
Melvin the pumpkin after Leo had finished with it.</p>
<p><a href="http://groups.google.com/groups?threadm=OFCEA1143A.08EE30F7-ON85256DC6.00602BD2-85256DC6.0062F33E%40us.ibm.com">http://groups.google.com/groups</a></p>

<h4><a name="class metadata for pir/assembly files">Class metadata for PIR/assembly files</a></h4>
<p>Donning his designer's cap again, Dan posted a rough spec for class
metadata declarations in PIR and pasm files. It looks pretty decent
to me. Melvin Smith made a few telling comments though, so it looks
like Dan's post isn't quite the final word on the matter.</p>
<p><a href="http://groups.google.com/groups?threadm=Pine.LNX.4.58.0310211444150.20236%40sprite.sidhe.org">http://groups.google.com/groups</a></p>

<h4><a name="class creation in bytecode">Class creation in bytecode</a></h4>
<p>Mere moments after the metadata post, Dan went on to spec out the
assembly language needed to support it.</p>
<p><a href="http://groups.google.com/groups?threadm=Pine.LNX.4.58.0310211520570.20236%40sprite.sidhe.org">http://groups.google.com/groups</a></p>

<h4><a name="open patches">Open Patches</a></h4>
<p>Leo pointed everyone at <a href="http://www.parrotcode.org/openpatches/">http://www.parrotcode.org/openpatches/</a>,
the list of open Parrot patches and asked for a volunteer to go
through and make sure that the list is in agreement with reality.</p>
<p><a href="http://groups.google.com/groups?threadm=3F966072.109%40toetsch.at">http://groups.google.com/groups</a></p>

<h4><a name="leo's notes on objects and classes">Leo's notes on objects and classes</a></h4>
<p>Leo posted a list of thoughts about how classes and objects will work
in Parrot and offered a suggestion about using OrderedHashes to
handle things.</p>
<p><a href="http://groups.google.com/groups?threadm=3F9682D9.2020108%40toetsch.at">http://groups.google.com/groups</a></p>

<h4><a name="unifying vtables and method invocations">Unifying vtables and method invocations</a></h4>
<p>Leo wondered if we should arrange things so that PMC vtables could be
invoked in the same way as in methods on Parrot level objects are
invoked. Dan answered that it won't be quite like that, but it will
be close. (Yay! A reflective programmer writes).</p>
<p><a href="http://groups.google.com/groups?threadm=3F968934.4000504%40toetsch.at">http://groups.google.com/groups</a></p>

<h4><a name="more fixed number assignments">More fixed number assignments</a></h4>
<p>So, it turns out that adding PMC classes to the core breaks binary
compatibility. Which needs fixing. Dan asked for volunteers. I'm
afraid I don't know what fixing it would entail.</p>
<p><a href="http://groups.google.com/groups?threadm=Pine.LNX.4.58.0310221538200.19973%40sprite.sidhe.org">http://groups.google.com/groups</a></p>

<h4><a name="plotz!">Plotz!</a></h4>
<p>Plotz (the Pol(l)y-Lingual Opcode Translation for the Z-machine) is
Amir Karger's shot at Parrot immortality by getting Parrot to run
Infocom adventures. Right now he's prototyping his design in Perl and
he's apparently 10 opcodes away from a tool that will run around two
thirds of all released Infocom games. He's rather happy about this.</p>
<p><a href="http://groups.google.com/groups?threadm=20031022195153.2773.qmail%40web40709.mail.yahoo.com">http://groups.google.com/groups</a></p>

<h4><a name="halloween release">Halloween Release</a></h4>
<p>Melvin Smith proposed a ``just for fun'' Halloween release of
Parrot. Dan christened the putative release ``The Screaming Pumpkin'',
and Leo thought there was a little too much stuff in flux at the
moment. Me? I think it's going to happen. The codename is too good to
resist.</p>
<p><a href="http://groups.google.com/groups?threadm=5.1.1.6.2.20031022212058.06211230%40pop.mindspring.com">http://groups.google.com/groups</a></p>

<h4><a name="imcc leaves the languages ghetto">IMCC leaves the languages ghetto</a></h4>
<p>Melvin Smith checked in a large patch to move IMCC from
<em>parrot/languages/imcc/</em> to <em>parrot/imcc</em>, reflecting the
intention/reality that IMCC <em>is</em> parrot. As the week progressed,
various other directories got moved around in an attempt to make
things a little more logical. Everything is now, roughly in its
place, but at one point during the week it would have been, frankly,
foolhardy to attempt to check parrot out of CVS.</p>
<p><a href="http://groups.google.com/groups?threadm=5.1.1.6.2.20031022222631.02026000%40pop.mindspring.com">http://groups.google.com/groups</a></p>

<h4><a name="imcc, classes & metadata, oh my!">IMCC, Classes &amp; Metadata, oh my!</a></h4>
<p>Melvin Smith, who has returned from his Parrot holiday with a
seemingly enormous supply of tuits, announced that he'd started work
on implementing the class syntax for PIR and had reached a decision
point, so he asked for comments. The consensus was to go with a short
term hack for the time being, just to get something working, with a
big flag for the future.</p>
<p><a href="http://groups.google.com/groups?threadm=5.1.1.6.2.20031023223907.045d8ec8%40pop.mindspring.com">http://groups.google.com/groups</a></p>

<h4><a name="pir changes">PIR changes</a></h4>
<p>For those of you who are implementing things in IMCC, Melvin
announced that he'd added <code>newsub</code> and <code>newclosure</code> to
IMCC, allowing implementors to simply write 
<code>P0 = newsub &lt;label&gt;</code> and <code>P0 = newclosure &lt;label&gt;</code> which
is rather more efficient than the PASM equivalents.</p>
<p><a href="http://groups.google.com/groups?threadm=5.1.1.6.2.20031025001450.051fd768%40pop.mindspring.com">http://groups.google.com/groups</a></p>

<h4><a name="pmc initialization">PMC initialization</a></h4>
<p>Dan decided that the time has come to allow PMCs to be created with
initialization data rather than having separate creation and
initialization phases. Hes proposal, pending a Better <code>Idea(tm)</code> was to
have two <code>init</code> methods, one taking no arguments and simply creating
an empty PMC, and another which assumes that its parameters are in
the registers (using the standard calling conventions) and goes from
there. Leo thought it was a little heavy. I like it though, the more
things that use standard Parrot calling conventions, the less I have
to remember and the happier I am -- but I am a bear of very little brain.</p>
<p><a href="http://groups.google.com/groups?threadm=a05210607bbc06d9b76f4%40%5B10.0.1.2%5D">http://groups.google.com/groups</a></p>

<h3><a name="meanwhile, in perl6language">Meanwhile, in perl6-language</a></h3>
<p>Luke Palmer asked a question about named named return values and
<code>:=</code>. David Storrs boggled slightly.</p>
<p>Next week, Damian Conway answers Luke's question.</p>
<p><a href="http://groups.google.com/groups?threadm=20031024065718.GA13746%40babylonia.flatirons.org">http://groups.google.com/groups</a></p>

<h3><a name="acknowledgements, announcements, apologies">Acknowledgements, Announcements, Apologies</a></h3>
<p>Looks like the Wednesday ship date of the last summary was a
temporary aberration. Which is nice.</p>
<p>If you found this summary valuable, please consider one or more of:</p>
<ul>
<li>
Donating time to the project. We need more programmers, documenters
language implementers and generally useful
people. <a href="http://dev.perl.org/perl6/">http://dev.perl.org/perl6/</a> and
<a href="http://www.parrotcode.org/">http://www.parrotcode.org/</a> have details of mailing lists etc.</li>

<li>
Donating money to the Perl Foundation
(<a href="http://donate.perl-foundation.org/">http://donate.perl-foundation.org/</a>) to help support Larry, Dan
and Damian and enable them to spend more time working on Perl 6,
rather than petty things like making sure they're earning enough
money to feed themselves.</li>

<li>
Donating feedback to your summarizer (<em><a href="mailto:p6summarizer@bofh.org.uk">p6summarizer@bofh.org.uk</a></em>).</li>
</ul>

        </div>



    </div>
    <div class="asset-footer"></div>
</div>


                            
                            <div id="entry-1204" class="entry-asset asset hentry">
    <div class="asset-header">
        <h2 class="asset-name entry-title"><a href="/pub/2003/10/23/databases.html" rel="bookmark">Database Programming with Perl</a></h2>
        <div class="asset-meta">
            <span class="byline">
    
                By <span class="vcard author">Simon Cozens</span> on <abbr class="published" title="2003-10-23T00:00:00-08:00">October 23, 2003 12:00 AM</abbr>
    
            </span>

            
            

        </div>
    </div>
    <div class="asset-content entry-content">

        <div class="asset-body">
            
<!-- sidebar begins -->
<!-- don't move sidebars -->
<!-- sidebar ends -->

<h3><a name="an_embarrassing_confession">An Embarrassing Confession</a></h3>
<p>I'd like to think that I'm a reasonably decent Perl programmer now. I'd
like to think that I have a good grasp of how to solve relatively
common problems in Perl. But, you know, it hasn't always been this way.
Oh no.</p>
<p>A long, long time ago, when I was a tiny little programmer, I worked as
a trainee Perl coder and systems administrator for a large database
company. Naturally, at a database company, a lot of what we had to do
was talking to databases in Perl. As a fresh-faced programmer, the only
way I knew to interface with databases was through a command-line SQL
client.</p>
<p>I won't embarrass the company in question by giving away the name of the
database, so let's call this SQL client <code>sqlstar</code>. Very soon I was
writing horrendous Perl programs that did things like:</p>
<pre><code>
    my @rows = `sqlstar $database &quot;select * from $table&quot;`;
    for (@rows) {
        ...
    }</code></pre>
<p>Of course, things got terribly confused when we had complex <code>where</code>
clauses, and needed to escape metacharacters, and ...</p>
<pre><code>
    my @rows = `sqlstar $database &quot;select * from $table where
        $row LIKE \&quot;%pattern%\&quot;&quot;`;</code></pre>

<p>The code rapidly got ugly, error-prone, and dangerously unsafe. 
If someone had decided to search for a value with a double quote in it, I
don't know where we'd have been. But for the most part it worked, so
nobody really worried about it.</p>

<csperl file="grab" domain="on" record="b/522" template="b/article_sidebar.view">

<p>Looking back on programs like that makes me cringe today. Of course, a
better solution is obvious -- but only once someone tells you about it.
And if nobody tells you about it, you could end up writing horrible code
like this until someone does tell you or you get fired.</p>
<p>
</p>
<h3><a name="the_obvious_solution">The Obvious Solution</a></h3>
<p>So in case anyone hasn't told you yet: there's a better way. The better
way is called the <a href="http://dbi.perl.org/">DBI</a>, the DataBase Interface module. It was
initially written between 1992 and 1994, long before I was messing about
with <code>sqlstar</code> -- so I really have no excuse.</p>
<p>
      You see, there were many problems with my code. Not only was it
      ugly, susceptible to shell breakage, conceptually wrong, and
      inefficient, but it tied my code to the particular database
      engine we were using. Now, given we were a database company,
      it's unlikely that we'd ever be using a different database at
      anytime, but the principle of the thing remains.
</p>
<p>
      Historically, Perl had several different ways to talk to
      databases; back in the days of Perl 4, the best way to
      communicate with a database -- even better than my horrible
      command-line utility hack -- was to use one of the
      specially compiled Perl binaries that included functions for
      driving a database. For instance, there was one called
      <code>oraperl</code>, which allowed you to write code like so:
</p>
    <pre><code>
$lda = &amp;ora_login("master", $user, $pass);
$csr = &amp;ora_open($lda, "select * from $table");
while (@data = &amp;ora_fetch($csr)) {
    # ...
}
</code></pre>
    <p>
      This is obviously a bit of an improvement over the code I was
      writing -- it's a lot more robust, it allows you to do error
      checking on several different levels, and it saves you a lot of
      hassle parsing the output of the command-line tool. It's also
      more efficient, since everything stays inside the one Perl
      process, which again reduces the number of "moving parts" and
      things that can go wrong.
</p>
    <p>
      So these things were a good solution for Perl 4, but along came
      Perl 5 and plug-in modules, and suddenly people found a way to
      solve one of the big problems with these compiled-in database
      libraries. 
    </p>
    <p>
      We've just seen an example of <code>oraperl</code>, which works
      great if you're using Oracle -- and, of course, the version of
      Oracle your Perl was compiled for. If you decide to move your
      program to Informix, you don't have much option than to rewrite
      all your database code; this isn't very practical, especially if
      you want to write code that can be deployed to third parties.
    </p>
    <p>
      The Perl 5 solution was Tim Bunce's DBI. As well as providing a
      handy set of functions for all kinds of database access, DBI
      provides an abstraction layer between the Perl code and the
      underlying database, allowing you to switch database
      implementations really easily.
    </p>
    <p>
      Here's a little conceptual diagram of how the DBI does its stuff:
    </p>
    <img src="http://dbi.perl.org/images/dbiarch.gif" alt="" />
    <p>
      Your Perl program talks to the DBI, and the DBI talks to
      whichever Database Driver (DBD) is right for your backend
      database. This means that to use the DBI, you need to have four
      things:
    </p>
    <ul>
      <li>A C compiler to compile the XS code for DBI and the DBD
	drivers.</li>
      <li>A copy of the <code>DBI</code> module compiled and installed.</li>
      <li>A copy of the relevant client libraries and header files for the database you want to talk to. For instance, on my Debian system, to talk to mysql, I install the <code>libmysqlclient10-dev</code> package.</li>
      <li>The relevant DBD library compiled and installed -- for example, <code>DBD::MySQL</code>.</li>
    </ul>
    <p>Once that's all up and working, we can start writing some
    database code using the DBI.
    </p>
<h3><a name="using_the_dbi">Using the DBI</a></h3>
<p>
      To connect to a database with the DBI, we need to first construct
      a string that identifies the database we want to connect
      to; this is called a data source name, or DSN. Let's assume
      we're going to be working with a MySQL database called
      "phonebill." (Simply because that's what I was working with
      yesterday.) The DSN for this is made up of three parts, joined by
      colons: first, <code>dbi</code>, since that's what we're using
      to get our data; <code>mysql</code>, since that's the name of
      the driver we want to use to get it; and <code>phonebill</code>,
      since that's the database we're getting it from.
</p>
    <p>
      So, to connect to a database with the DBI, we'd write something
      like this:
</p>
    <pre><code>
use DBI;
my $dbh = DBI->connect("dbi:mysql:phonebill", $user, $password);
</code></pre>
    <p>
      In a lot of cases, you can do without the username and password
      if you're connecting as a local user. However, for a serious
      application, you'll probably want to create a specific user or
      prompt for a password.
    </p>
    <p>
      Now we have connected to the database, DBI returns us a database
      handle, which is typically stored into a variable called
      <code>$dbh</code>. (Of course, if you're connecting to multiple
      different databases, you may prefer to give it a name that identifies it to a particular database.) Now we have a database
      handle, and we can use it to make queries.
    </p>
    <p>
      Making a query in the DBI takes place in three stages. First,
      you <b>prepare</b> some SQL; then you <b>execute</b> the query;
      finally, you <b>get</b> the results. Let's do that now:
    </p>
    <pre><code>
my $sth = $dbh->prepare(&lt;&lt;SQL);
   select recipient, calldate, calltime, duration
   from call 
   where duration > 60
   order by duration desc
SQL

$sth->execute;

my %calls;
while (my @row = $sth->fetchrow_array()) {
   my ($recipient, $calldate, $calltime, $duration) = @row;
   $calls{$recipient} += $duration;
   print "Called $recipient on $calldate\n";
}

# Now do something with the total times here.
</code></pre>
    <p>
      Why, you might think, do we have to go through these three stages
      just to make an SQL query? Isn't Perl supposed to make things
      easy? Well it does, but it makes different things easy to what
      you're expecting. For instance, suppose you're inserting a lot
      of rows into a table. This is precisely the sort of thing you
      don't want to do:
    </p>
<pre><code>
&lt;![CDATA[
while (my $data = &lt;FILE&gt;) {
    my ($recipient, $date, $time, $duration) = split /:/, $data;
    # DON'T DO THIS
    my $sth = $dbh->prepare(&lt;&lt;SQL);
INSERT INTO call (recipient, calldate, calltime, duration)
VALUES ("$recipient", "$date", "$time", "$duration");
SQL
    # NO REALLY, DON'T DO THIS

    $sth->execute;
}
]]>
</code></pre>

    <p>There are two reasons why this is BAD, BAD, BAD. The first, of
      course, is that the moment someone comes along with a
      double-quote in the file, we're in big trouble. In fact, the
      moment someone comes along with <code>"; DROP DATABASE;</code>
      in the table, we're out of a job.</p>
    <p>
      The second is that it's really inefficient to set up a
      statement, execute it, tear it down, set up a statement,
      execute it, tear it down, and round we go again.
    </p>
    <p>
      The reason for the disconnect between preparing a statement and
      executing it is to enable us to use the same statement multiple
      times with slightly different values; we do this by using what
      DBI calls "bind parameters" -- portions of the SQL that will be
      replaced later. For instance, the right way to do our mass
      inserts would be something like this:
    </p>
<pre><code>
    my $sth = $dbh->prepare(&lt;&lt;SQL);
INSERT INTO call (recipient, calldate, calltime, duration)
VALUES (?, ?, ?, ?)
SQL

while (my $data = &lt;FILE&gt;) {
    my ($recipient, $date, $time, $duration) = split /:/, $data;
    $sth->execute($recipient, $date, $time, $duration);
}
    </code></pre>
<p>
      Isn't that just so much <i>neater</i>? We've hoisted the
      statement outside the loop, so it only gets prepared once -- much
      more efficient. We specify the parameters we want bound to the
      SQL using question marks, and we pass in the values to the
      <code>execute</code> call.
</p>
<p>
      As an additional bonus, when <code>execute</code> substitutes in
      the bind values to the SQL, it calls the database handle's
      <code>quote</code> method on each one; this is a
      database-specific method, which escapes any nasty characters like
      quotes and semicolons in the input, and makes our code safe
      against the <code>";drop database</code> attack.
</p>
<h3><a name="making_things_easier">Making Things Easier</a></h3>
<p>
      But in many cases, the prepare-execute-fetch process <b>is</b> a
      pain in the neck. Thankfully, DBI provides some easier ways to
      perform SQL statements; it has some canned
      methods that do prepare, execute, and fetch in one go.
</p>
<p>
      The first of these is <code>do</code>, which executes a
      statement when you don't care about the return value, when
      you're not trying to get results back, such as a <code>DELETE</code>:
    </p>
<pre><code>
# Ignore short calls.
$dbh->do("delete from calls where duration &lt; 5");
    </code></pre>
<p>
      For <code>SELECT</code> statements, there are a variety of
      methods that can help out. Perhaps the easiest to use is
      <code>selectall_arrayref</code>. This returns the results of the
      <code>SELECT</code> as an array of arrays:
    </p>
<pre><code>

my $results = $dbh->selectall_arrayref(&lt;&lt;SQL);
   select recipient, calldate, calltime, $duration 
   from call  
   where duration > 60 
   order by duration desc 
SQL

for my $row (@$results) {
   my ($recipient, $calldate, $calltime, $duration) = @$row;
   ...
}
    </code></pre>
    <p>
      There are many other DBI tricks, too many to go into here; for
      more information check out the <a href="http://search.cpan.org/perldoc?DBI">DBI documentation
      page</a>, or the <a href="http://dbi.perl.org/">DBI home
      page</a>; there's also <a href="http://www.oreilly.com/catalog/perldbi/">Programming the
      Perl DBI</a>, which was co-authored by the creator of DBI.
    </p>
 <h3><a name="where_to_from_here">Where to from Here?</a></h3>
<p>
These days, I actually don't write very much SQL; there are many more
Perlish abstraction layers on top of SQL, such as Tony Bowden's <a href="/pub/a/2002/11/27/classdbi.html"><code>Class::DBI</code></a>,
the <a href="/pub/a/2001/02/dbix.html"><code>DBIx::RecordSet</code></a>,
<a href="http://search.cpan.org/perldoc?DBIx::SearchBuilder"><code>DBIx::SearchBuilder</code></a>
and many more.
    </p>
<p>
      Additionally, there are some very interesting things going on in the
      world of database servers -- <a href="http://www.hwaci.com/sw/sqlite/">SQLite</a> is a very fast embedded SQL engine which doesn't require an external server process, and there are Perl bindings to that in the form of <code>DBD::SQLite</code>.
    </p>
<p>
We'll look at some more of these techniques at a later date, but
hopefully this should be enough to get you started using relational
databases in Perl ... and of course, the most important lesson of this
      article: don't worry if you look back at your code after five
      years and cringe -- so do I!
    </p>





        </div>



    </div>
    <div class="asset-footer"></div>
</div>


                            
                            <div id="entry-1212" class="entry-asset asset hentry">
    <div class="asset-header">
        <h2 class="asset-name entry-title"><a href="/pub/2003/10/p6pdigest/20031019.html" rel="bookmark">This week on Perl 6, week ending 2003-10-19</a></h2>
        <div class="asset-meta">
            <span class="byline">
    
                By <span class="vcard author">Piers Cawley</span> on <abbr class="published" title="2003-10-19T00:00:00-08:00">October 19, 2003 12:00 AM</abbr>
    
            </span>

            
            

        </div>
    </div>
    <div class="asset-content entry-content">

        <div class="asset-body">
            
<!-- sidebar begins -->
<!-- don't move sidebars -->
<!-- sidebar ends -->

<p>Lumme! Another week, another summary.</p>
<p>Every week (almost) we start with the perl6-internals list, so here goes.</p>

<h4><a name="an evil task for the interested">An Evil task for the interested</a></h4>
<p>Our Glorious Leader, Dan Sugalski, last week asked for volunteers to
work on making ordered destruction work. (Ordered destruction is
where the system tries to ensure that 'parent' objects get destroyed
before any of their children). Jeff Clites announced that he'd got a
partial implementation working.</p>
<p>Neither Leo T&#246;tsch nor J&#252;rgen B&#246;mmels were sure
that the approach Jeff was taking would be the Right Thing in the
long run, proposing instead a more general iterator mechanism.</p>
<p><a href="http://groups.google.com/groups?threadm=6E7C8CAE-FD5E-11D7-98E2-000393A6B9DA%40mac.com">http://groups.google.com/groups</a></p>

<h4><a name="perl 6 sub calling">Perl 6 Sub calling</a></h4>
<p>Bringing the perl6 compiler (in <em>languages/</em> back to live, Steve
Fink has committed a 'rather large' patch which implements a subset
of the Apocalypse 6 subroutine signature rules. The implementation is
apparently very ad hoc and shouldn't be regarded as the final
word. But it looks like a very good start to me.</p>
<p><a href="http://groups.google.com/groups?threadm=20031013171844.GG1892%40foxglove">http://groups.google.com/groups</a></p>

<h4><a name="website timeliness">Website timeliness</a></h4>
<p>Responding to Matt Fowles' observation that the parrot website is
rather behind the times, Robert Spier let slip that there would soon
be a revised website that will be easy for everyone to send patches
to, and which would be much easier to have multiple maintainers of
different areas of the site.</p>
<p>Of course, there are still a few 'technical chunks' that need to get
finished before it's ready to unveil, but it's good to know that work
continues in this area. Thanks Robert.</p>
<p><a href="http://groups.google.com/groups?threadm=courier.3F8B0F04.0000420E%40softhome.net">http://groups.google.com/groups</a></p>
<p><a href="http://www.vendian.org/parrot/wiki/bin/view.cgi">http://www.vendian.org/parrot/wiki/bin/view.cgi</a> &#8212; Mike Scott's Parrot Wiki</p>

<h4><a name="dynamic oplibs">Dynamic oplibs</a></h4>
<p>Chances are, you've never really needed a <code>fortytwo</code> operator, or
even a <code>what_do_you_get_if_you_multiply_six_by_nine</code> operator, and
you certainly don't need them cluttering up the parrot core. Which is
why Leo T&#246;tsch has implemented those ops as a dynamically
loadable ops library.</p>
<p>Admittedly, you're highly unlikely to load this particular ops
library, but the underpinning tools for dynamic loading of ops
libraries are new and potentially very useful.</p>
<p>Rather later in the week, once he'd got dynamic loading of ops
working in all the runtime cores, Leo posted an 'intermediate
summary' which explains how things work.</p>
<p><a href="http://groups.google.com/groups?threadm=3F8BEBDE.1050405%40toetsch.at">http://groups.google.com/groups</a></p>
<p><a href="http://groups.google.com/groups?threadm=3F8EBBEE.5030704%40toetsch.at">http://groups.google.com/groups</a></p>

<csperl file="grab" domain="on" record="b/940" template="b/article_sidebar.view">
<h4><a name="oplips, pmclibs, function libs">Oplips, pmclibs, function libs</a></h4>
<p>Dan has been thinking about the problems that can arise with dynamic
loading. One issue is that, if you have separate files for each PMC
class, opcode library and parrot function library, things get
unwieldy very quickly, and if you're not careful you'll exhaust the
OS file descriptor pool. Which would be bad. So, he asked for a
sanity check before going on to work out a scheme for bundling
libraries into larger files. Leo agreed that Dan was talking sense,
so I expect we'll be seeing some design in this area soon.</p>
<p><a href="http://groups.google.com/groups?threadm=Pine.LNX.4.58.0310140916100.15234%40sprite.sidhe.org">http://groups.google.com/groups</a></p>

<h4><a name="instantiating objects">Instantiating objects</a></h4>
<p>It's been a busy week on the parrot front for Dan. On Wednesday he
outlined his thinking on instantiating objects, with the aim of
getting single inheritance objects up and running. This sparked a
good deal of discussion, but nothing was actually agreed.</p>
<p><a href="http://groups.google.com/groups?threadm=Pine.LNX.4.58.0310151125550.4672%40sprite.sidhe.org">http://groups.google.com/groups</a></p>

<h4><a name="redoing imcc macros">Redoing IMCC macros</a></h4>
<p>Surprisingly, J&#252;rgen B&#246;mmels opened up a can of worms
when he redid IMCC's macro support to use a hash lookup instead of a
linear search through an array. This sparked a good deal of
discussion about the right scoping, which hash implementation to use,
and whether IMCC should be closely entwined with the interpreter.</p>
<p><a href="http://groups.google.com/groups?threadm=rt-24224-66091.17.3048638038286%40rt.perl.org">http://groups.google.com/groups</a></p>

<h4><a name="fixed opcode numbering infrastructure">Fixed opcode numbering infrastructure</a></h4>
<p>Dan checked in a patch to fix opcode numbers for the core ops,
deliberately breaking the JIT in the process. Leo wasn't happy. After
a bit of back and forth, we now have fixed opcodes, but the
implementation isn't quite what Dan originally did.</p>
<p>There was also some discussion of how many opcodes really needed to be
fixed; after all, in the presence of dynamically loaded oplibs, you
can't nail every opcode down. Leo worried that dynamically loaded
oplibs don't play well with JIT, and making it work would probably
need a total rewrite of the JIT core, but J&#252;rgen didn't think
it was all that bad.</p>
<p><a href="http://groups.google.com/groups?threadm=Pine.LNX.4.58.0310161200090.777%40sprite.sidhe.org">http://groups.google.com/groups</a></p>

<h4><a name="applying the pumpking patch">Applying the Pumpking Patch</a></h4>
<pre><code>    $ patch RESPONSIBLE_PARTIES 
    6c6
    &lt; Release pumpking              Steve Fink
    ---
    &gt; Release pumpking              Leopold Toetsch</code></pre>
<p>In other words, Steve Fink has stepped down from the role of
Parrot Pumpking and handed the his mantle on to Leo "Pumpking
Patchmonster" T&#246;tsch. I'm sure I'm not alone in wishing to thank
Steve for his sterling work as our release manager. Nor, I'm sure, am
I alone in wondering where Leo finds the time.</p>
<p><a href="http://groups.google.com/groups?threadm=Pine.LNX.4.58.0310171119460.10277%40sprite.sidhe.org">http://groups.google.com/groups</a></p>

<h4><a name="bounds checking in extension api">Bounds checking in extension API</a></h4>
<p>Simon Glover wanted to know what sort of bounds checking was/will be
done by the extension API's register access functions. At the time of
his writing they didn't do any, which meant you could trivially cause
a buffer overflow in your extension by accessing an illegal register
number, like 42. Dan said that what needed to happen is for the
access functions to do bounds checking and to throw an exception on
an illegal register number. Which wasn't quite as straightforward as
he thought.</p>
<p><a href="http://groups.google.com/groups?threadm=Pine.LNX.4.44.0310171334490.4564-100000%40nevis.internal.amnh.org">http://groups.google.com/groups</a></p>


<h3><a name="meanwhile, in perl6languagesubs">Meanwhile, in perl6-language-subs</a></h3>
<p>What's that you say? You've never heard of perl6-language-subs? Shame
on you. Actually, I'd forgotten about perl6-language-subs but,
judging by the messages I've seen on the list since I started writing
the summaries, it would appear that it's a mailing list where
students can ask the Perl 6 community to do their computer science
homework for them. I don't expect to be covering this list any
further.</p>


<h3><a name="meanwhile, in perl6language">Meanwhile, in perl6-language</a></h3>

<h4><a name="the wall returns">The Wall Returns</a></h4>
<p>Larry returned from what sounds like a horrible couple of months in
hospital and answered Luke Palmer's awkward question about block
returns from a couple of weeks ago.</p>
<p><a href="http://groups.google.com/groups?threadm=20031016003050.GA7845%40wall.org">http://groups.google.com/groups</a></p>


<h3><a name="acknowledgements, announcements, apologies">Acknowledgements, Announcements, Apologies</a></h3>
<p>Tuesday is no longer the new Monday. Wednesday is the new new Monday.</p>
<p>If you found this summary valuable, you might like to consider one or
more of:</p>
<ul>
<li>Get involved. Parrot (and Perl 6) needs programmers, authors, users
and other interested parties. Join the mailing lists and start to
contribute. (Check <a href="http://dev.perl.org/perl6/">http://dev.perl.org/perl6/</a> and
<a href="http://www.parrotcode.org/">http://www.parrotcode.org/</a> as good starting points).</li>
<p></p>
<li>Support Larry, Dan, Damian and company by donating to the Perl
Foundation at <a href="http://donate.perl-foundation.org/">http://donate.perl-foundation.org/</a>. I hate to think
what the Wall family medical bills must be like at the moment.</li>
<p></p>
<li>Give me lots of lovely feedback at <em><a href="mailto:p6summarizer@bofh.org.uk">p6summarizer@bofh.org.uk</a></em>, you
know you want to.</li>
<p></p></ul>

</body>

</html>

        </div>



    </div>
    <div class="asset-footer"></div>
</div>


                            
                            <div id="entry-1202" class="entry-asset asset hentry">
    <div class="asset-header">
        <h2 class="asset-name entry-title"><a href="/pub/2003/10/15/bioinformatics.html" rel="bookmark">A Chromosome at a Time with Perl, Part 2</a></h2>
        <div class="asset-meta">
            <span class="byline">
    
                By <span class="vcard author">James D. Tisdall</span> on <abbr class="published" title="2003-10-15T00:00:00-08:00">October 15, 2003 12:00 AM</abbr>
    
            </span>

            
            

        </div>
    </div>
    <div class="asset-content entry-content">

        <div class="asset-body">
            
<!-- sidebar begins -->
<!-- don't move sidebars -->
<!-- sidebar ends -->

<p><i>James D. Tisdall is the author of the recently released </i><a href="http://www.oreilly.com/catalog/mperlbio/index.html?CMP=IL7015">Mastering 
    Perl for Bioinformatics</a><i>.</i></p>

<p>
In my previous article, <a href="/pub/a/2003/09/10/bioinformatics.html">A Chromosome at a Time with Perl, Part I</a>, I showed you
some programming "tricks" that help you avoid the trap of using up all your main
memory when coding for very long strings, such as chromosomes and entire genomes.
</p>
<p>
The basic approach involved improving your code's running time by limiting the
amount of memory space the program uses.  The tricks discussed were calling subroutines
with references as arguments, and searching for a pattern in a very large file by
keeping only a small "window" of the file in memory at any one time, in a buffer.
</p>
<p>
This article will continue that discussion.  I'll show you more about how references
can greatly speed up a subroutine call by avoiding making copies of very large strings.
I'll show you how you can bypass the overhead of subroutine calls entirely.
I'll extend the previous example of a buffer window into a large file, making it
suited to any situation where you know the minimum and maximum length of a pattern
for which you're searching.  And I'll show you how to quantify the behavior of
your code by measuring its speed and space usage.
</p>

<csperl file="grab" domain="on" record="b/889" template="b/article_sidebar.view">

<h3>Why Space Puts a Lower Bound on Time</h3>
<p>
In Perl, as in any programming system, the size of the data that the program uses is
an absolute lower bound on how fast the program can perform.
</p>
<p>
In fact, algorithms are typically classified by how fast they perform on inputs of
varying sizes, by giving their speed as a function of the size of the input.
So a program that has to do <b>2<sup>n</sup></b> computations on an input of size <b>n</b> is a hell of a
lot slower than a program that has to do <b>n<sup>2</sup></b> computations on an input of size <b>n</b>.
The first is called <i>intractable</i> and <i>exponential</i>, or "bad"; the second is called
<i>tractable</i> and <i>polynomial</i>, or "good."
For instance, if <b>n</b>, the size of the input, is 100, then <b>n<sup>2</sup></b> is 10,000, while
<b>2<sup>n</sup></b> is bigger than the number of atoms in the universe.  But who's counting?
And is the universe really finite?  Oh well ... back to your regularly scheduled program.</p>

<p>This way of measuring an algorithm is called <i>time complexity</i>.  It's usually
written in a shorthand called <i>big Oh</i> notation.  (See the Suggested Reading at the end of 
this article, if you get that far.)
</p>
<p>
In particular, if an algorithm gets an input of size <b>n</b>, and then just to write the
answer it must write an output of size <b>2<sup>n</sup></b>, then the algorithm is taking <b>2<sup>n</sup></b> time,
at least.  So the space that an algorithm uses is intimately connected to the
time it uses.  Of course, a program could use just a small, constant amount of
space and still use <b>2<sup>n</sup></b> time, for instance if it added and subtracted the number one over
and over, <b>2<sup>n</sup></b>
times, for some perverse reason.  Still, the amount of space that an algorithm
uses establishes a lower bound for how much time the algorithm takes to complete.
</p>
<p>
What's all this got to do with Perl programming in bioinformatics?
Quite a lot, if you're writing code that manipulates, say, the 3 gigabases
of human DNA.
</p>
<p>
If you're new to the field, a base is one of the letters A, C, G, or T that
represents one of the four molecules that are the principal building blocks
of DNA.  Each base is typically represented in a computer language as one ASCII character
taking one 8-bit byte, so 3 gigabases equals 3 gigabytes.  Of course, you could
represent each of the four bases using only 2 bits, so considerable compression is
possible; but such space efficiency is not commonly employed.
Hmmm ... makes an interesting idea for another article, however!
"Perl and a Chromosome, Two Bits."  Watch this space.
</p>
<p>
Just to read in the 3 gigabytes of DNA is going to
take you some time.  If you're also making copies of the 3 gigabytes in
your variables, you're going to need more main memory than most computers
have available.  So the crafty Perl programmer needs to think of programming
solutions that minimize the amount of space used when computing with such
large input.  If she does, not only will she have a program that fits into
her computer's memory (always a wise move); she may also have a program that
runs pretty fast, if she does say so herself, with all due humility.
</p>

<h3>Subroutines Without Extra Space</h3>
<p>
In Part I, I briefly discussed how passing references to subroutines can save
you considerable space.  I'll just expand a little on that discussion in this section.
There are three main ways that references can be used to save space and
therefore time in the subroutines of your Perl program.
</p>
<h4>One: Collect Data in a Subroutine Argument</h4>
<p>
First, let's say you call a subroutine to get some data.  Typically this
takes a form such as this:
</p>
<pre><code>
my $chromosome1 = get_chromosome( 1 );
</code></pre>
<p>
Assuming that the data is about 100 megabases long, the Perl programmer can see that
the subroutine "get_chromosome" is collecting 100 megabases of DNA and then "returning"
it, which means that copies of those 100 megabases are being made.  And that's a Bad Thing.
</p>
<p>
Instead, the wily hacker could pass a reference to the <code>$chromosome1</code> string into the
subroutine, which could be written to "fill" the string with the 100 megabases without
the need for further copying.  Then after the subroutine call, say like so:
</p>
<pre><code>
get_chromosome(1, \$chromosome1);
</code></pre>
<p>
the variable <code>$chromosome1</code> would contain the same data as in the previous version, but
it would have gotten there without being copied by means of being "returned" from
a subroutine.  And that's a Good Thing.  The only gotcha here is that the subroutine
call is definitely changing what's in the <code>$chromosome1</code> variable.  No problem as long
as you remember that's what's happening.
</p>

<h4>Two: Pass the Subroutine a Reference to the Data</h4>
<p>
Here's a second way to use references as subroutine arguments to good advantage.
Let's say you have a chromosome's worth of DNA in a variable<code> $chromosome1</code>, and
you want to pass it to a subroutine that counts how many As, Cs, Gs, and Ts there
are in it.  (This might be important if you were looking for genes in the chromosome,
for instance -- in humans, genes tend to be GC rich.)
</p>
<p>
If you write your code like this:
</p>
<pre><code>
my($a, $c, $g, $t) = countacgt( $chromosome1 );
</code></pre>
<p>
then the "countacgt" subroutine is going to make a copy of the data in the argument
<code>$chromosome1</code>.  That's a Regrettable Occurence.
</p>
<p>
On the other hand, if you pass the subroutine a <i>reference</i> to the data in
<code>$chromosome1</code>, the data will not be copied, and that's a Fortunate Happenstance:
</p>
<pre><code>
my($a, $c, $g, $t) = countacgt( \$chromosome1 );
</code></pre>
<p>
However, once again you'll have to be aware that the subroutine has the power to
change what's in the <code>$chromosome1</code> variable, and either avoid changing it or take note of the change.
</p>

<p>As another alternative, you could use</p>

<pre><code>
my($a, $c, $g, $t) = countacgt( $chromosome1 );
</code></pre>

<p>but then <i>don't</i> assign a new variable to the argument within the <code>countacgt</code> subroutine, like so:

<pre><code>
my($chrom) = @_;
</code></pre>

<p>Instead, just use <code>$_[0]</code> to access the chromosome data without copying it. And that's a Perl Idiom. (For readability, you may want to add a comment explaining what kind of data <code>$_[0]</code> is, since you won't have an informative
variable name.)</p>

<h4>Three: Return a Reference to the Data</h4>
<p>
Now a third and final way to use references instead of space:
if you have a subroutine that collects a large amount of data,
you can have it return a reference to the data instead of the data itself; this will
also avoid the large string copies, which Ain't Bad:
</p>
<pre><code>
my $chromosome1ref = get_chromosome( 1 );
</code></pre>
<h3>Eliminating Subroutines Altogether</h3>
<p>
Organizing the code for a computation into a logical set of subroutines can make
for clean, easy-to-understand, and elegant programming.
</p>
<p>
Unfortunately, it can also make your program perform much slower.  Take this small
example.
(An <i>exon</i> is a stretch of a chromosome's DNA, transcribed into RNA, that contains part of the code for a gene.
In organisms such as humans, most genes are composed of multiple exons
separated by non-coding <i>introns</i>; the exons are <i>spliced</i> together to get the
actual code for the gene):
</p>
<pre><code>
while ((my $begin, my $end) =  each %exon_endpoints) {
    print get_exon($chromosome, $begin, $end), "\n\n";
}

sub get_exon {
    my($chromosome, $begin, $end) = @_;

    # The arguments to substr are: string, beginning, length
    return substr($chromosome, $begin - 1, $end - $begin + 1);
}
</code></pre>
<p>
This code takes the information about exon endpoints stored in the hash <code>%exon_endpoints</code>
(key = begin, value = end) to extract the exons from a chromosome and print them.
(You may remember from Part I that I translated between the Perl idea of location, where
the first location of a string is position 0, and the biologist's idea of location, where the
first location is position 1.) The code is short, to the point, and gets the job done.
<b>Unfortunately, it also makes as many copies of the entire chromosome as there are
exons to print out</b>.  <i>Ouch.</i>
</p>
<p>
In such circumstances, you can save a boatload of pain by eliminating the subroutine
entirely, like so:
</p>
<pre><code>
while ((my $begin, my $end) =  each %exon_endpoints) {
    print substr($chromosome, $begin - 1, $end - $begin + 1), "\n\n";
}
</code></pre>
<p>
The bad news: now the details of how to extract the desired exon from the chromosome 
are right in the loop, instead of being nicely tucked away in the
subroutine <code>get_exon</code>.  The good news: the program will finish running before the weekend.
</p>













<h3>Sequence Motifs with Bounded Lengths</h3>
<p>
In Part I, I showed you how to search for a small pattern in a very large file
of DNA data (in <i>FASTA</i> format) by only keeping at most two lines of the
file in the program's memory at any one time.
</p>
<p>
Here is some code that generalizes that approach.
It is more general because it allows you to declare the maximum and 
minimum pattern sizes. It uses no more than a certain maximum amount of main memory for the data at any one time.
For instance, if you're looking for a pattern and you know that
any match must be between 300 and 2,000 bases long,
you can use this subroutine to search any amount of DNA while keeping 
the amount of main memory used
for the DNA to within about 4,000 bytes, twice the maximum pattern size. Only matching patterns between 300 and 2,000 bases long will be 
reported.
</p>
<pre><code>
#!/usr/bin/perl
#
# find_size_bounded_pattern : find a pattern known to be between a min and max length
#   Keep small size of memory but handle arbitrarily large input files
#
#  Copyright (c) 2003 James Tisdall
#

use warnings;
use strict;
use Carp;

my $pattern  = "GGTGGAC[GT].{50,1500}[AC][GT][CG]ATAT";
my $filename = "Fly.dna";
my $min      = 65;
my $max      = 1515;

my @locations = find_size_bounded_pattern($pattern, $filename, $min, $max);

print "@locations\n";

exit;

### End of main program
##################################################

##################################################
### Subroutines:

sub find_size_bounded_pattern {

    ################# Arguments:
    # $pattern   - the pattern to search for, as a regular _expression
    # $filename  - the name of the DNA fasta file (may have multiple records)
    # $min       - the shortest length of a usable match to the pattern    
    # $max       - the longest length of a usable match to the pattern    
    #################
    my($pattern, $filename, $min, $max) = @_;

    ################# Other variables:
    # $buffer    - a buffer to store the DNA text, usually (2 * $max) in length
    # $position  - the position of the beginning of the buffer in the DNA
    # @locations - the locations where the pattern was found, to be returned
    #              @locations also includes headers for each fasta record
    # $header    - the one-line fasta header for each record in a fasta file
    my $buffer = '';
    my $position = 0;
    my @locations = ();
    my $header = '';
    #################
    
    # Open the DNA file
    open(DNA,"&lt;$filename") or croak("Cannot open $filename:$!\n");

    # Get the input lines and compute
    while(my $newline = &lt;DNA> ) {

        # If new fasta header, reinitialize buffer and location counter
        if($newline =~ /^>/) {
            # Complete previous search in buffer which contains end of fasta record
            while($buffer =~ /$pattern/gi) {
                if($-[0] &lt;= length($buffer) - $min) {
                    unless(($+[0] - $-[0] &lt; $min) or ($+[0] - $-[0] > $max)) {
                        push(@locations, $position + $-[0] + 1);
                    }
                }
            }
            # Reset $header, $buffer, $position for new fasta record
            $header = $newline;
            push(@locations, "\n$header");
            buffer = '';
	    $position = 0;

            # Get new line from file
            next;
        }

        # If new line of DNA data

        # Add the new line to the buffer
        chomp $newline;
        $buffer .= $newline;

        if(length($buffer) &lt; (2 * $max) ) {
            next;
        }
    
        # Search for the DNA pattern
        # (Report the character at position 0 as at position 1, as usual in biology)
        while($buffer =~ /$pattern/gi) {
            if($-[0] &lt; $max) {
                unless(($+[0] - $-[0] &lt; $min) or ($+[0] - $-[0] > $max)) {
                    push(@locations, $position + $-[0] + 1);
                }
            }else{
                last;
            }
        }
    
        # Reset the position counter
        # (will be accurate after you reset the buffer, next)
        $position = $position + $max;
    
        # Reset the buffer
        # Discard the first $max worth of data in the buffer
        $buffer = substr($buffer, $max);
    }

    # Complete search in final buffer
    while($buffer =~ /$pattern/gi) {
        if($-[0] &lt;= length($buffer) - $min) {
            unless(($+[0] - $-[0] < $min) or ($+[0] - $-[0] > $max)) {
                push(@locations, $position + $-[0] + 1);
            }
        }
    }

    # Computation complete
    return @locations;
}
</code></pre>
<h3>How the Code Works</h3>
<p>
This code gets its DNA from a FASTA-formatted file (FASTA is the most 
common format for a file of
DNA sequence data). It
would be fairly easy to rewrite this so that you could give multiple 
FASTA filenames on a command
line and all the files
would be processed by this code.   As it is, it can handle a single 
FASTA file that contains
multiple FASTA records.</p>

<p>The subroutine <code>find_size_bounded_pattern</code> returns an array of all the 
locations in the DNA that
contain the pattern.
Since the input may have several FASTA records, the one-line header of 
each record is also returned,
to
help identify the start of each new record. For instance, I tested this 
program on a file, <code>Fly.dna</code>, that contains all the
chromosomes of the fruit fly, <i>Drosophila melanogaster</i>. In this file, 
each new chromosome begins with
a new FASTA
header, which is added to the returned array.  The locations reported 
start afresh from 1 for each
chromosome. </p>

<p>The pattern to be searched for is only reported if it's between a 
certain minimum and maximum
length.
Twice the maximum desired pattern length (plus the length of an input 
line)
is the limit of the amount of DNA data that is read into the program's 
buffer.
That way you can search a <code>$max</code> worth of DNA for the beginning locations 
of patterns that may be up
to <code>$max</code> long.</p>

<p>The overall structure of this code is pretty simple, and the comments 
in the code should do most of
the explaining.
There are two situations dealt with in the loop as it reads input 
lines.
First is when there is a new FASTA header. Then you have to
finish searching in the buffer, and reset the variables to begin a 
search in a new sequence of DNA
from a
new FASTA record. Second is when there is
a new line of DNA.
And finally, after all the lines have been read and you exit the loop,
there may still be some unsearched
DNA in the buffer, so the subroutine ends by searching the DNA 
remaining in the last buffer.</p>

<p>In this code, the devil is in the details of how the specific locations 
and sizes are set. The
intermediate level Perl
programmer should be able to puzzle this out given the comments in the 
code. Note that after a
successful pattern match
the builtin variable <code>$-[0]</code> has the offset of the beginning of the 
match, and <code>$+[0]</code> has the offset of
the end of the match. This
avoids the use of the special variable <code>$&</code>, the use of which causes all 
manner of space to be used to
hold this and several
other special variables. But if your regular expression has any 
parentheses, that's enough to make
the special variables and
their considerable space get used too. 
Of course, regular expressions have their own rules of behavior, such 
as greedy matching and
so forth, that are not addressed by this code.  (Could you modify this 
program to find
patterns that overlap each other?  What happens if <code>$max</code> is less than 
the input line size?
What other assumptions are made by this code?)
</p>

<h3>Profiling the Speed of your Perl Program</h3>
<p>
You can profile the speed of your Perl program fairly easily.  Let's say
I put the program in a file called <i>sizebound.pl</i>.  Then I can get
a report on the time the various parts of the program require by running
the program like this:
</p>
<pre><code>
[tisdall@coltrane]$ perl -d:DProf sizebound.pl 
</code></pre>
<p>
And then getting a summary of the report (from the file tmon.out that DProf
creates) like so:
</p>
<pre><code>
[tisdall@coltrane]$ dprofpp
Total Elapsed Time =  95.1899 Seconds
  User+System Time =  94.9099 Seconds
Exclusive Times
%Time ExclSec CumulS #Calls sec/call Csec/c  Name
 99.9   94.87 94.870      1   94.870 94.870  main::find_size_bounded_pattern
 0.02   0.020  0.020      3   0.0067 0.0067  main::BEGIN
 0.00   0.000 -0.000      1   0.0000      -  warnings::BEGIN
 0.00   0.000 -0.000      2   0.0000      -  Exporter::import
 0.00   0.000 -0.000      1   0.0000      -  warnings::import
 0.00   0.000 -0.000      1   0.0000      -  strict::import
 0.00   0.000 -0.000      1   0.0000      -  strict::bits
</code></pre>
<p>
When you have lots of subroutines, this can really help you see where the
most time is being spent.  Here, I'm really just getting the information
that the program took about a minute and a half to look for the pattern
in the DNA of the fruit fly.
</p>
<p>
It's also possible to get information about the space usage of a program, but
you have to use a version of Perl that was compiled with -DDEBUG, which is not usually
the case.  If you have such a version, then the following will give you some information:
</p>
<pre><code>
[tisdall@coltrane]$ perl -DL sizebound.pl 
</code></pre>
<p>
But that's enough for here and now; take a look
at the Perl documentation section called perldebguts.  And drive safely.
</p>
<h3>Suggested Reading</h3>
<p>
Here are some of the many books that you might find useful.
I cut my teeth on the Bentley books, but the older ones are hard to find.</p>

<ul>
<li>Introduction to Algorithms, Second Edition, by Cormen et al, MIT Press, 2001. </li>
<li>Writing Efficient Programs, by Jon Bentley, Prentice Hall 1982.</li>
<li>Refactoring: Improving the Design of Existing Code, by Fowler et al, Addison-Wesley, 1999.</li>
<li>Programming Pearls, Second Edition, by Jon Bentley, Prentice Hall 1999.</li>
<li>More Programming Pearls: Confessions of a Coder, by Jon Bentley, Pearson Education, 1988.</li>
</ul>

<hr size="1" noshade="noshade" />

<p> O'Reilly &amp; Associates recently released (September 2003) <a href="http://www.oreilly.com/catalog/mperlbio/index.html?CMP=IL7015">Mastering 
    Perl for Bioinformatics</a>. </p>
<ul>
    <li>
        <p> <a href="http://www.oreilly.com/catalog/mperlbio/chapter/index.html?CMP=IL7015">Sample Chapter 9, Introduction to Bioperl</a>, is 
            available free online. </p>
    </li>
    <li>
        <p> You can also look at the <a href="http://www.oreilly.com/catalog/mperlbio/toc.html?CMP=IL7015">Table of Contents</a>, the 
            <a href="http://www.oreilly.com/catalog/mperlbio/inx.html?CMP=IL7015">Index</a>, and the <a href="http://www.oreilly.com/catalog/mperlbio/desc.html?CMP=IL7015">Full Description</a> 
            of the book. </p>
    </li>
    <li>
        <p> For more information, or to order the book, <a href="http://www.oreilly.com/catalog/mperlbio/index.html?CMP=IL7015">click 
            here</a>. </p>
    </li>
</ul>


        </div>



    </div>
    <div class="asset-footer"></div>
</div>


                            
                            <div id="entry-1210" class="entry-asset asset hentry">
    <div class="asset-header">
        <h2 class="asset-name entry-title"><a href="/pub/2003/10/p6pdigest/20031012.html" rel="bookmark">This week on Perl 6, week ending 2003-10-12</a></h2>
        <div class="asset-meta">
            <span class="byline">
    
                By <span class="vcard author">Piers Cawley</span> on <abbr class="published" title="2003-10-12T00:00:00-08:00">October 12, 2003 12:00 AM</abbr>
    
            </span>

            
            

        </div>
    </div>
    <div class="asset-content entry-content">

        <div class="asset-body">
            
<!-- sidebar begins -->
<!-- don't move sidebars -->
<!-- sidebar ends -->

<p>Good afternoon readers. You find me sitting comfortably and tired
after a vaguely frantic week involving large amounts of new (and
huge) equipment, the delivery of a new Mini Cooper, and four days
offline at a large format photography workshop (photos will be going
online soonish, if you're interested). All of which hopefully goes
some way to explaining the fact that I've only just started writing
the summary at ten to four on Tuesday.</p>
<p>We start (and finish) with the internals list.</p>

<h4><a name="new pmc compiler">New PMC compiler</a></h4>
<p>Leo T&ouml;tsch isn't exactly happy with the current
<em>classes/pmc2c.pl</em> PMC compiler. He outlined the drawbacks as he
sees them, proposed a scheme for reimplementing it, and asked for
comments. Dan said that so long as the resulting code is clearer than
the current PMC compiler, Leo should go for it. So he did.</p>
<p><a href="http://groups.google.com/groups?threadm=3F81348A.4050600%40toetsch.at">http://groups.google.com/groups</a></p>

<h4><a name="the status of language, credit where it's due">The Status of Language, Credit Where It's Due</a></h4>
<p>Melvin Smith has added a <em>LANGUAGES.STATUS</em> file in the <em>languages/</em>
subdirectory and asked for language authors to add summaries of the
various language subdirectories to the file.</p>
<p>Fresh from this success he added a <em>CREDITS</em> file for giving credit
where it's due. Rumours of an entry reading</p>
<pre><code>
    N: Leon Brocard
    D: Running Joke</code></pre>
<p>are (currently) false.</p>
<p>Later in the week, <em>LANGUAGES.STATUS</em> was extended to cover both the
languages found in <em>languages/</em> but any other languages that people
were working on and making available outside the Parrot distribution
for whatever reason.</p>
<p><a href="http://groups.google.com/groups?threadm=5.1.1.6.2.20031006233300.06005698%40pop.mindspring.com">http://groups.google.com/groups</a></p>
<p><a href="http://groups.google.com/groups?threadm=5.1.1.6.2.20031007003542.0613c818%40pop.mindspring.com">http://groups.google.com/groups</a></p>

<h4><a name="binary mmd vtable functions are go">Binary MMD vtable functions are go</a></h4>
<p>Dan's solved an off by one error with multimethod dispatch and checked
everything in, so now Parrot has working two argument multimethod
dispatch. Hurrah! There's still lots it doesn't do mind, but getting
started is always good.</p>
<p><a href="http://groups.google.com/groups?threadm=Pine.LNX.4.58.0310070846320.16822%40sprite.sidhe.org">http://groups.google.com/groups</a></p>

<h4><a name="attacking the unicode monster">Attacking the Unicode Monster</a></h4>
<p>Dan's searching for a Unicode Monster Wrangler. ICU is now building
on enough platforms that the time has come to build an encoding and
chartype library for it. Volunteers gratefully received.</p>
<p>Jeff Clites and Michael Scott have both been poking at it a bit;
hopefully they'll be able to put their heads together and emerge with
something wonderful.</p>
<p><a href="http://groups.google.com/groups?threadm=Pine.LNX.4.58.0310071149230.16822%40sprite.sidhe.org">http://groups.google.com/groups</a></p>

<h4><a name="more nci stuff">More NCI stuff</a></h4>
<p>Dan's been a busy boy this week. Parrot now comes with
<em>library/postgres.pasm</em>, an interface to libpq (the C library that
talks to Postgres). These NCI interface files are currently built by
hand. Tim Bunce wondered if it might be possible to
ExtUtils::XSBuilder to generate PASM from C header files instead of
XS code. It was generally agreed that this would be a cool thing, but
it's not been done yet.</p>
<p><a href="http://groups.google.com/groups?threadm=Pine.LNX.4.58.0310071556120.16822%40sprite.sidhe.org">http://groups.google.com/groups</a></p>
<p><a href="http://www.postgresql.org/">http://www.postgresql.org/</a></p>

<h4><a name="the parrot stack and zmachine">The Parrot Stack and Z-Machine</a></h4>
<p>Amir Karger is working on getting his head 'round the Z-Machine (The
virtual machine that runs Zork and the other Infocom games, amongst
others) by writing code to translate Z-code into a Perl
executable. He came up with a problem with saving and restoring the
stack in order to save the game state.</p>
<p><a href="http://groups.google.com/groups?threadm=20031007164754.57253.qmail%40web40703.mail.yahoo.com">http://groups.google.com/groups</a></p>

<h4><a name="references">References</a></h4>
<p>Leo's been giving the Reference PMC a hard look and, as a result,
suggests adding a couple of handy ops, <code>deref</code> and <code>ref</code> (which
finds the type of the thing the reference refers to) to use with
them. Melvin Smith pointed out that, actually we only needed one of
Leo's proposed ops. On the other hand, as Nicholas Clark pointed out,
<code>ref</code> avoids the need to grab another PMC register, which may cause
a register spill. On the gripping hand, Melvin argued that spillage
is pretty rare with the number of registers Parrot has.</p>
<p><a href="http://groups.google.com/groups?threadm=3F842968.1010606%40toetsch.at">http://groups.google.com/groups</a></p>

<h4><a name="the program's ending! destroy everything!">The program's ending! DESTROY everything!</a></h4>
<p>J&uuml;rgen B&ouml;mmels found a subtle bug where objects that had
active destruction weren't having their destroy functions called
correctly (at all) when parrot terminated. After a couple of goes
round the '``this would be so much easier if we were all in the same
room'' misunderstanding' loop, the Right Thing was settled upon and
implemented.</p>
<p><a href="http://groups.google.com/groups?threadm=m2fzi2y78e.fsf%40helium.physik.uni-kl.de">http://groups.google.com/groups</a></p>

<h4><a name="an interesting task for the evil">An interesting task for the evil</a></h4>
<p>One of the things that Dan would really like to be able to promise
with Parrot's GC is ordered destruction. Taking a leaf out of my
lightning talk on complexity management, he noted that ``we just need
to order the PMCs before destroying them, to make sure we don't call
the destructor for a PMC before we destroy the things that depend on
it'' and asked for volunteers to implement it.</p>
<p>Dave Mitchell spoilt the understatement party by pointing out that,
in the presence of circular dependencies things got a little more
complicated (but not that much more complicated, Dan claims).</p>
<p>Nobody's actually volunteered yet.</p>
<p><a href="http://groups.google.com/groups?threadm=Pine.LNX.4.58.0310091138510.9021%40sprite.sidhe.org">http://groups.google.com/groups</a></p>

<h4><a name="parrot gets pioctl">Parrot gets <code>pioctl</code></a></h4>
<p>Melvin Smith added a <code>pioctl</code> op for general purpose IO manipulation
in the style of the UNIX <code>ioctl</code> syscall. Dan reckoned it was almost
certainly time to start thinking about a better API (though we're not
sure if that's because he doesn't like <code>ioctl</code> as a name). Steve
Fink suggested using keyed access to the IO PMC, so you could do</p>
<pre>
   set IO, P0[.BUFSIZE]
   set P0[.BUFSIZE], 8192</pre>
<p>Steve later backed away from this suggestion, suggesting that maybe
<code>get/setprop</code> fit the semantics better, but Leo thought that
'fundamentals' like buffer size belonged as keyed access, with
properties being reserved for setting up things like encoding
layers.</p>
<p><a href="http://groups.google.com/groups?threadm=5.1.1.6.2.20031009214007.086e1850%40pop.mindspring.com">http://groups.google.com/groups</a></p>

<h4><a name="pcc and imc">PCC and IMC</a></h4>
<p>Gregor N. Purdy suggested that, instead of going through the hassle of
explicitly setting up a function call under the parrot calling
conventions, one could call the the function in the style of a macro
call. Leo wasn't keen, IMCC is still an assembler after all (just a
very sophisticated one). It looks like, unless Dan rules otherwise,
we're going to stick with the current explicit method of function
invocation setup, and human parrot programmers will just have to
set up convenience macros explicitly.</p>
<p><a href="http://groups.google.com/groups?threadm=1065972980.22829.13.camel%40borg.focusresearch.com">http://groups.google.com/groups</a></p>

<h3><a name="meanwhile in perl6language">Meanwhile in perl6-language</a></h3>


<h3><a name="acknowledgements, announcements, apologies, alliteration">Acknowledgements, Announcements, Apologies, Alliteration</a></h3>
<p>I'm really sorry I used the '...' joke about perl6-language
again. Write something people!</p>
<p>Tuesday continues to be the new Monday, and will probably remain so
for a while.</p>
<p><a href="http://www.bofh.org.uk:8080/">http://www.bofh.org.uk:8080/</a> will hopefully be hosting my photos
from the weekend's workshop.</p>
<p>If you found this summary valuable, you might like to consider one or
more of the following suggestions:</p>
<ul>
<li>
Get involved. There's at least two calls for volunteers out at the
moment related to Parrot. Okay, they're not necessarily easy, but if
you turn up on the lists (check <a href="http://dev.perl.org/perl6/">http://dev.perl.org/perl6/</a> and
<a href="http://www.parrotcode.org/">http://www.parrotcode.org/</a> for subscription details) and offer to
help I'm sure we'll find something that needs doing.
</li>

<li>
Support Larry, Dan, Damian and company by donating to the Perl
Foundation at <a href="http://donate.perl-foundation.org/">http://donate.perl-foundation.org/</a>. Fun as hacking
Perl 6 no doubt is, it's very easy to get distracted from it by the
pressing need to feed yourself.
</li>

<li>
Boost my ego. Praise my photos/this summary/my lackadaisical
weblog. Suggest improvements, point out my grammatical howlers, hire
me to do cool stuff, press gifts upon me. Contact me at
<em><a href="mailto:p6summarizer@bofh.org.uk">p6summarizer@bofh.org.uk</a></em>, unless you're a spamming scumbag I can
pretty much promise you a prompt response. Assuming I'm not out
hooning 'round the countryside in my new car...
</li>
</ul>
        </div>



    </div>
    <div class="asset-footer"></div>
</div>


                            
                            <div id="entry-1200" class="entry-asset asset hentry">
    <div class="asset-header">
        <h2 class="asset-name entry-title"><a href="/pub/2003/10/09/refactoring.html" rel="bookmark">A Refactoring Example</a></h2>
        <div class="asset-meta">
            <span class="byline">
    
                By <span class="vcard author">Michael Schwern</span> on <abbr class="published" title="2003-10-09T00:00:00-08:00">October  9, 2003 12:00 AM</abbr>
    
            </span>

            
            

        </div>
    </div>
    <div class="asset-content entry-content">

        <div class="asset-body">
            
<!-- sidebar begins -->
<!-- don't move sidebars -->
<!-- sidebar ends -->

<p>
About a year ago, a person asked the <a href="http://www.technofile.org/technofile/depts/mlists/fwp.html">Fun With Perl</a> mailing list about some
code they had written to do database queries.  It's important to note that this person was posting from an .it address; why will become apparent later.  The code was reading records
in from a text file and then doing a series of queries based on that
information.  They wanted to make it faster.
</p>


<p>
Here's his code:
</p>


<pre><code>open (INPUT, "&lt; $filepageid") || &amp;file_open_error("$filepageid");

while ($riga=&lt;INPUT&gt;){
$nump++;
chop($riga);
$pagina[$nump] = $riga;

$sth= $dbh-&gt;prepare("SELECT count(*) FROM lognew WHERE
pageid='$pagina[$nump]' and data&gt;='$startdate'");
$sth-&gt;execute;
$totalvisit[$nump] = $sth-&gt;fetchrow_array();

$sth = $dbh-&gt;prepare("SELECT count(*) FROM lognew WHERE
(pageid='$pagina[$nump]' and data='$dataoggi')");
$sth-&gt;execute;
$totalvisittoday[$nump] = $sth-&gt;fetchrow_array();

 $sth = $dbh-&gt;prepare("SELECT count(*) FROM lognew WHERE
(pageid='$pagina[$nump]' and data='$dataieri')");
$sth-&gt;execute;
$totalyvisit[$nump] = $sth-&gt;fetchrow_array();

 $sth= $dbh-&gt;prepare("SELECT count(*) FROM lognew WHERE
(pageid='$pagina[$nump]' and data&lt;='$fine30gg' and data&gt;='$inizio30gg')");
$sth-&gt;execute;
$totalmvisit[$nump] = $sth-&gt;fetchrow_array();

 }

</code></pre>
<p>
I decided that rather than try to read through this code and figure
out what it's doing and how to make it faster, I'd clean it up first.
Clean it up <b>before</b> you figure out how it works?  Yes, using a
technique called <em>Refactoring</em>.
</p>



<h3>Refactoring?</h3>
<p>

In his book, Martin Fowler defines Refactoring as <em>"the process of changing a software system in such a way that it does not alter the external behavior of the code yet improves its internal structure."</em>
In other words, you clean up your code but don't change what it does.
</p>


<p>
Refactoring can be as simple as changing this code:
</p>


<pre><code>$exclamation = 'I like '.$pastry.'!';

</code></pre>
<p>
To this:
</p>


<pre><code>$exclamation = "I like $pastry!";

</code></pre>
<p>
Still does the same thing, but it's easier to read.
</p>


<p>
It's important to note that I don't need to know anything about the
contents of <code>$pastry</code> or how <code>$exclamation</code> is used.  The change is
completely self-contained and does not affect surrounding code or
change what it does.  This is Refactoring.
</p>


<p>
On the principle of "show me don't tell me," rather than talk about it,
we'll dive right into refactoring our bit of code.
</p>



<h3>Fix the Indentation</h3>
<p>

Your first impulse when faced with a hunk of code slammed against the
left margin is to indent it.  This is our first refactoring.
</p>


<pre><code>open (INPUT, "&lt; $filepageid") || &amp;file_open_error("$filepageid");

while ($riga=&lt;INPUT&gt;){
<font color="#808000">    $nump++;
    chop($riga);
    $pagina[$nump] = $riga;

    $sth= $dbh-&gt;prepare("SELECT count(*) FROM lognew WHERE
                         pageid='$pagina[$nump]' and data&gt;='$startdate'");
    $sth-&gt;execute;
    $totalvisit[$nump] = $sth-&gt;fetchrow_array();

    $sth = $dbh-&gt;prepare("SELECT count(*) FROM lognew WHERE
                          (pageid='$pagina[$nump]' and data='$dataoggi')");
    $sth-&gt;execute;
    $totalvisittoday[$nump] = $sth-&gt;fetchrow_array();

    $sth = $dbh-&gt;prepare("SELECT count(*) FROM lognew WHERE
                          (pageid='$pagina[$nump]' and data='$dataieri')");
    $sth-&gt;execute;
    $totalyvisit[$nump] = $sth-&gt;fetchrow_array();

    $sth= $dbh-&gt;prepare("SELECT count(*) FROM lognew WHERE
                         (pageid='$pagina[$nump]' and data&lt;='$fine30gg' 
						 and data&gt;='$inizio30gg')");
    $sth-&gt;execute;
    $totalmvisit[$nump] = $sth-&gt;fetchrow_array();
}</font>

close (INPUT);

</code></pre>
<p>
Already it looks better.  We can see that we're iterating over a file,
performing some SELECTs on each line and shoving the results into a
bunch of arrays.
</p>



<h3>A Single, Simple Change</h3>
<p>

One of the most important principles of Refactoring is that you work
in small steps.  This re-indentation is a single step.  And part of this single step includes running the test suite, logging the change, and checking it into CVS.
</p>


<p>
Checking into CVS after something this simple?  Yes.  Many programmers
ask the question, "When should I check in?"  When you're refactoring
it's simple: check in when you've done one refactoring and have tested that it
works.  Our re-indentation is one thing; we test that it works and
check it in.
</p>


<p>
This may seem excessive, but it prevents us from entangling two
unrelated changes together.  By doing one change at a time we know
that any new bugs were introduced by that one change.  Also, you will
often decide in the middle of a refactoring that it's not such a good
idea.  When you've checked in at every one you can simply rollback to
the last version rather than having to undo it by hand.  Convenient,
and you're sure no stray bits of your aborted change are hanging around.
</p>


<p>
So our procedure for doing a proper refactoring is:
</p>


<ul>
<li>Make one logical change to the code.</li>
<li>Make sure it passes tests.</li>
<li>Log and check in.</li>
</ul>


<h3>Big Refactorings from Small</h3>
<p>

The goal of this refactoring is to make the code go faster.  One of
the simplest ways to do achieve that is to pull necessary code out of
the loop.  Preparing four new statements in every iteration of the
loop seems really unnecessary.  We'd like to pull those
<code>prepare()</code>
statements out of the loop.  This is a refactoring.  To achieve this
larger refactoring, a series of smaller refactorings must be done.
</p>



<h3>Use Bind Variables</h3>
<p>

Each time through the loop, a new set of SQL statements is created
based on the line read in.  But they're all basically the same, just
the data is changing.  If we could pull that data out of the statement
we'd be closer to our goal of pulling the <code>prepare()</code>s out of the loop.
</p>


<p>
So my next refactoring pulls variables out of the SQL statements and
replaces them with placeholders.  Then the data is bound to the
statement using bind variables.  This means we're now
<code>prepare()</code>ing the
same statements every time through the loop.
</p>


<p>
Before refactoring:
</p>


<pre><code>$sth= $dbh-&gt;prepare("SELECT count(*) FROM lognew WHERE
                     pageid='$pagina[$nump]' and data&gt;='$startdate'");
$sth-&gt;execute;

</code></pre>
<p>
After refactoring:
</p>


<pre><code>$sth= $dbh-&gt;prepare('SELECT count(*) FROM lognew WHERE 
                     pageid=<font color="#808000">?</font> and data&gt;=<font color="#808000">?</font>');
$sth-&gt;execute<font color="#808000">($pagina[$nump], $startdate)</font>;

</code></pre>
<p>
Bind variables also protect against a naughty user from trying to slip
some extra SQL into your program via the data you read in.  As a
side-effect of our code cleanup, we've closed a potential security
hole.
</p>


<pre><code>open (INPUT, "&lt; $filepageid") || &amp;file_open_error("$filepageid");

while ($riga=&lt;INPUT&gt;){
    $nump++;
    chop($riga);
    $pagina[$nump] = $riga;

    $sth= $dbh-&gt;prepare('SELECT count(*) FROM lognew WHERE 
                         pageid=<font color="#808000">?</font> and data&gt;=<font color="#808000">?</font>');
    $sth-&gt;execute<font color="#808000">($pagina[$nump], $startdate)</font>;
    $totalvisit[$nump] = $sth-&gt;fetchrow_array();

    $sth = $dbh-&gt;prepare('SELECT count(*) FROM lognew WHERE
                          (pageid=<font color="#808000">?</font> and data=<font color="#808000">?</font>)');
    $sth-&gt;execute<font color="#808000">($pagina[$nump], $dataoggi)</font>;
    $totalvisittoday[$nump] = $sth-&gt;fetchrow_array();

    $sth = $dbh-&gt;prepare('SELECT count(*) FROM lognew WHERE
                          (pageid=<font color="#808000">?</font> and data=<font color="#808000">?</font>)');
    $sth-&gt;execute<font color="#808000">($pagina[$nump], $dataieri)</font>;
    $totalyvisit[$nump] = $sth-&gt;fetchrow_array();

    $sth= $dbh-&gt;prepare('SELECT count(*) FROM lognew WHERE
                         (pageid=<font color="#808000">?</font> and data&lt;=<font color="#808000">?</font> and data&gt;=<font color="#808000">?</font>)');
    $sth-&gt;execute<font color="#808000">($pagina[$nump], $fine30gg, $inizio30gg)</font>;
    $totalmvisit[$nump] = $sth-&gt;fetchrow_array();
}

close (INPUT);

</code></pre>
<p>
Test.  Log.  Check in.
</p>



<h3>Split a Poorly Reused Variable</h3>
<p>

The next stumbling block to pulling the <code>prepare()</code> statements out of
the loop is that they all use the same variable, <code>$sth</code>.  We'll have
to change it so they all use different variables.  While we're at it,
we'll name those statement handles something more descriptive of what
the statement does.  Since at this point we haven't figured out what
the statements do, we can base the name on the array it gets assigned
to.
</p>


<p>
While we're at it, throw in some <code>my()</code> declarations to limit the scope
of these variables to just the loop.
</p>


<pre><code>open (INPUT, "&lt; $filepageid") || &amp;file_open_error("$filepageid");

while ($riga=&lt;INPUT&gt;){
    $nump++;
    chop($riga);
    $pagina[$nump] = $riga;

    <font color="#808000">my $totalvisit_sth</font> = $dbh-&gt;prepare('SELECT count(*) FROM lognew WHERE 
                                        pageid=? and data&gt;=?');
    <font color="#808000">$totalvisit_sth</font>-&gt;execute($pagina[$nump], $startdate);
    $totalvisit[$nump] = <font color="#808000">$totalvisit_sth</font>-&gt;fetchrow_array();

    <font color="#808000">my $totalvisittoday_sth</font> = $dbh-&gt;prepare('SELECT count(*) FROM lognew WHERE
                                             (pageid=? and data=?)');
    <font color="#808000">$totalvisittoday_sth</font>-&gt;execute($pagina[$nump], $dataoggi);
    $totalvisittoday[$nump] = <font color="#808000">$totalvisittoday_sth</font>-&gt;fetchrow_array();

    <font color="#808000">my $totalyvisit_sth</font> = $dbh-&gt;prepare('SELECT count(*) FROM lognew WHERE
                                         (pageid=? and data=?)');
    <font color="#808000">$totalyvisit_sth</font>-&gt;execute($pagina[$nump], $dataieri);
    $totalyvisit[$nump] = <font color="#808000">$totalyvisit_sth</font>-&gt;fetchrow_array();

    <font color="#808000">my $totalmvisit_sth</font>= $dbh-&gt;prepare('SELECT count(*) FROM lognew WHERE
                                        (pageid=? and data&lt;=? and data&gt;=?)');
    <font color="#808000">$totalmvisit_sth</font>-&gt;execute($pagina[$nump], $fine30gg, $inizio30gg);
    $totalmvisit[$nump] = <font color="#808000">$totalmvisit_sth</font>-&gt;fetchrow_array();
}

close (INPUT);

</code></pre>
<p>
Test.  Log.  Check in.
</p>













<h3>Getting Better All the Time</h3>
<p>

The new names are better, but they're not great.  This is ok.  Naming is
something people often get hung up on.  One can spend hours wracking
their brains thinking of the perfect name for a variable or a
function.  If you can think of a better one than what's there right
now, use it.  The beauty of Refactoring is you an always improve upon
it later.
</p>


<p>
This is an important lesson of Refactoring.  Voltare said, "the best
is the enemy of the good".  We often get so wound up trying to make
code <em>great</em> that we fail to improve it at all.  In refactoring,
it's
not so important to make your code great in one leap, just a little
better all the time (it's a little known fact John Lennon was into
Refactoring.)  These small improvements will build up into a clean
piece of code, with less bugs, more surely than a large-scale code
cleanup would.
</p>



<h3>Pull Code Out of the Loop</h3>
<p>

Now it's a simple cut and paste to pull the four <code>prepare()</code> statements
out of the loop.
</p>



<pre><code><font color="#808000">my $totalvisit_sth = $dbh-&gt;prepare('SELECT count(*) FROM lognew WHERE 
                                    pageid=? and data&gt;=?');

my $totalvisittoday_sth = $dbh-&gt;prepare('SELECT count(*) FROM lognew WHERE
                                         (pageid=? and data=?)');

my $totalyvisit_sth = $dbh-&gt;prepare('SELECT count(*) FROM lognew WHERE
                                     (pageid=? and data=?)');

my $totalmvisit_sth = $dbh-&gt;prepare('SELECT count(*) FROM lognew WHERE
                                     (pageid=? and data&lt;=? and data&gt;=?)');
</font>
open (INPUT, "&lt; $filepageid") || &amp;file_open_error("$filepageid");

while ($riga=&lt;INPUT&gt;){
    $nump++;
    chop($riga);
    $pagina[$nump] = $riga;

    $totalvisit_sth-&gt;execute($pagina[$nump], $startdate);
    $totalvisit[$nump] = $totalvisit_sth-&gt;fetchrow_array();

    $totalvisittoday_sth-&gt;execute($pagina[$nump], $dataoggi);
    $totalvisittoday[$nump] = $totalvisittoday_sth-&gt;fetchrow_array();

    $totalyvisit_sth-&gt;execute($pagina[$nump], $dataieri);
    $totalyvisit[$nump] = $totalyvisit_sth-&gt;fetchrow_array();

    $totalmvisit_sth-&gt;execute($pagina[$nump], $fine30gg, $inizio30gg);
    $totalmvisit[$nump] = $totalmvisit_sth-&gt;fetchrow_array();
}

close (INPUT);

</code></pre>
<p>
Already the code is looking better.  With the SQL separated, the inner
workings of the loop are much less daunting.
</p>


<p>
Test.  Log.  Check in.
</p>



<h3>A Place to Stop</h3>
<p>

Remember our goal, to make this code run faster.  By pulling the
<code>prepare()</code> statements outside the loop we've likely achieved this goal.
Additionally, it still does exactly what it did before even though we
still don't fully understand what that is.  If this were a real
project, you'd do some benchmarking to see if the code is fast enough
and move on to another task.
</p>


<p>
Since this is an example, I'll continue with more refactorings with
the goal of clarifying the code further and figuring out what it does.
</p>


<p>
Keep in mind that after every refactoring the code still does <i>exactly
what it did before</i>.  This means we can stop choose to stop after any
refactoring.  If a more pressing task suddenly pops up we can pause
our refactoring work and attend to that feeling confident we didn't
leave any broken code lying around.
</p>



<h3>Reformat SQL for Better Readability</h3>
<p>

In order to make sense of the code, we have to make sense of the SQL.
The simplest way to better understand the SQL is to put it into a
clearer format.
</p>


<p>
The three major parts of an SQL SELECT statement are:
</p>


<ul>
<li>The rows (ie. <code>SELECT count(*)</code>)</li>
<li>The table (ie. <code>FROM lognew</code>)</li>
<li>The predicate (ie. <code>WHERE pageid = ...</code>)</li>
</ul>
<p>

I've chosen a new format that highlights these parts.
</p>


<p>
I've also removed some unnecessary parenthesis because they just serve to
clutter things up rather than disambiguate an expression.
</p>


<p>
I've also decided to change the quoting style from single quotes to a
here-doc.  It would have also been okay to use <code>q{}</code>.
</p>


<pre><code>my $totalvisit_sth = $dbh-&gt;prepare(<font color="#808000">&lt;&lt;'SQL'</font>);
<font color="#808000">SELECT count(*)
FROM   lognew 
WHERE  pageid =  ? AND 
       data   &gt;= ?
SQL</font>

my $totalvisittoday_sth = $dbh-&gt;prepare(<font color="#808000">&lt;&lt;'SQL'</font>);
<font color="#808000">SELECT count(*) 
FROM   lognew 
WHERE  pageid = ? AND 
       data   = ?
SQL</font>

my $totalyvisit_sth = $dbh-&gt;prepare(<font color="#808000">&lt;&lt;'SQL'</font>);
<font color="#808000">SELECT count(*) 
FROM   lognew 
WHERE  pageid = ? AND 
       data   = ?
SQL</font>

my $totalmvisit_sth = $dbh-&gt;prepare(<font color="#808000">&lt;&lt;'SQL'</font>);
<font color="#808000">SELECT count(*) 
FROM   lognew 
WHERE  pageid =  ? AND
       data   &lt;= ? AND 
       data   &gt;= ?
SQL</font>

open (INPUT, "&lt; $filepageid") || &amp;file_open_error("$filepageid");

while ($riga=&lt;INPUT&gt;){
    $nump++;
    chop($riga);
    $pagina[$nump] = $riga;

    $totalvisit_sth-&gt;execute($pagina[$nump], $startdate);
    $totalvisit[$nump] = $totalvisit_sth-&gt;fetchrow_array();

    $totalvisittoday_sth-&gt;execute($pagina[$nump], $dataoggi);
    $totalvisittoday[$nump] = $totalvisittoday_sth-&gt;fetchrow_array();

    $totalyvisit_sth-&gt;execute($pagina[$nump], $dataieri);
    $totalyvisit[$nump] = $totalyvisit_sth-&gt;fetchrow_array();

    $totalmvisit_sth-&gt;execute($pagina[$nump], $fine30gg, $inizio30gg);
    $totalmvisit[$nump] = $totalmvisit_sth-&gt;fetchrow_array();
}

close (INPUT);

</code></pre>
<p>
Test.  Log.  Check in.
</p>



<h3>Remove Redundancy</h3>
<p>

With the SQL in a more readable format, some commonalities become clear.
</p>


<ul>
<li>All the statements are doing a <code>count(*)</code>.</li>
<li>They're all using the <code>lognew</code> table</li>
<li>They're all looking for a certain <code>pageid</code>.</li>
</ul>
<p>

In fact, <code>$totalvisittoday_sth</code> and <code>$totalyvisit_sth</code> are exactly
the same!  Let's eliminate one of them, doesn't matter which, we're
going to rename them in a moment anyway.  <code>$totalyvisit_sth</code> goes
away, making sure to change all references to it to <code>$totalvisittoday_sth</code>.
</p>


<pre><code>my $totalvisit_sth = $dbh-&gt;prepare(&lt;&lt;'SQL');
SELECT count(*)
FROM   lognew 
WHERE  pageid =  ? AND 
       data   &gt;= ?
SQL

my $totalvisittoday_sth = $dbh-&gt;prepare(&lt;&lt;'SQL');
SELECT count(*) 
FROM   lognew 
WHERE  pageid = ? AND 
       data   = ?
SQL

my $totalmvisit_sth = $dbh-&gt;prepare(&lt;&lt;'SQL');
SELECT count(*) 
FROM   lognew 
WHERE  pageid =  ? AND
       data   &lt;= ? AND 
       data   &gt;= ?
SQL

open (INPUT, "&lt; $filepageid") || &amp;file_open_error("$filepageid");

while ($riga=&lt;INPUT&gt;){
    $nump++;
    chop($riga);
    $pagina[$nump] = $riga;

    $totalvisit_sth-&gt;execute($pagina[$nump], $startdate);
    $totalvisit[$nump] = $totalvisit_sth-&gt;fetchrow_array();

    $totalvisittoday_sth-&gt;execute($pagina[$nump], $dataoggi);
    $totalvisittoday[$nump] = $totalvisittoday_sth-&gt;fetchrow_array();

    <font color="#808000">$totalvisittoday_sth</font>-&gt;execute($pagina[$nump], $dataieri);
    $totalyvisit[$nump] = <font color="#808000">$totalvisittoday_sth</font>-&gt;fetchrow_array();

    $totalmvisit_sth-&gt;execute($pagina[$nump], $fine30gg, $inizio30gg);
    $totalmvisit[$nump] = $totalmvisit_sth-&gt;fetchrow_array();
}

close (INPUT);

</code></pre>
<p>
Test.  Log.  Check in.
</p>













<h3>Fix Conflicting Styles</h3>
<p>

Now the only difference between the statements is the choice of
<code>data</code> ranges.
</p>


<p>
Using the variables are passed into each statement we can
make some more deductions.  Let's have a look...
</p>


<ul>
<li><code>$startdate</code></li>
<li><code>$dataoggi</code></li>
<li><code>$dataieri</code></li>
<li><code>$fine30gg, $inizio30gg</code></li>
</ul>
<p>

<em>One of these things is not like the other.</em> What's <code>$startdate</code>
doing there?  Everything else is talking about 'data'.  What's 'ieri'?
'oggi'?  Remember, the programmer who submitted this code is Italian.
Maybe the names are in Italian.  Grabbing an <a href="http://dictionaries.travlang.com/ItalianEnglish/">Italian-English dictionary</a> we find
out that 'data' is Italian for 'date'!  Now it makes sense, this code
was probably originally written in English, then worked on by an
Italian (or vice-versa).
</p>


<p>
This code has committed a cardinal stylistic sin.  It uses two
different languages for naming variables.  Not just different
languages, languages which have different meanings for the same words.
Taken out of context, we can't know if <code>$data</code> represents a hunk of
facts or "Thursday."
</p>


<p>
Since the styles conflict, one of them has to go.  Since I don't speak
Italian, I'm going to translate it into English.
</p>


<p>
Pulling out our Italian-to-English dictionary...
</p>


<ul>
<li>"riga" is "line"</li>
<li>"pagina" is "page"</li>
<li>"nump" is probably short for "numero pagina" which is "page number"</li>
<li>"data" is "date"</li>
<li>"oggi" is "today"</li>
<li>"ieri" is "yesterday"</li>
<li>"inizio" is "start"</li>
<li>"fine" is "end"</li>
<li>"gg" is probably short for "giorni" which is "days"
 <ul>
 <li>"fine30gg" would then be "the end of 30 days"</li>
 <li>"inizio30gg" would be "the beginning of 30 days"</li>
 </ul></li>
</ul>
<p>

It would be a straightforward matter of a bunch of search-and-replaces
in any good editor but for one snag, the SQL column 'data.'  We'd like
to change this to its English 'date', but databases are very global
with possibly lots of other programs using it.  So we can't change the
column name without breaking other code. While in a well-organized
programming shop you might have the ability to find all the code which
uses your database, we won't assume we have that luxury here.  For the
moment then, we'll leave that be and deal with it in a separate
refactoring.
</p>


<pre><code>my $totalvisit_sth = $dbh-&gt;prepare(&lt;&lt;'SQL');
SELECT count(*)
FROM   lognew 
WHERE  pageid =  ? AND 
       data   &gt;= ?
SQL

my $totalvisittoday_sth = $dbh-&gt;prepare(&lt;&lt;'SQL');
SELECT count(*) 
FROM   lognew 
WHERE  pageid = ? AND 
       data   = ?
SQL

my $totalmvisit_sth = $dbh-&gt;prepare(&lt;&lt;'SQL');
SELECT count(*) 
FROM   lognew 
WHERE  pageid =  ? AND
       data   &lt;= ? AND 
       data   &gt;= ?
SQL

open (INPUT, "&lt; $filepageid") || &amp;file_open_error("$filepageid");

while ($<font color="#808000">line</font>=&lt;INPUT&gt;){
    $<font color="#808000">page_num</font>++;
    chop($<font color="#808000">line</font>);
    $<font color="#808000">pages</font>[$<font color="#808000">page_num</font>] = $<font color="#808000">line</font>;

    $totalvisit_sth-&gt;execute($<font color="#808000">pages</font>[$<font color="#808000">page_num</font>], $<font color="#808000">start_date</font>);
    $totalvisit[$<font color="#808000">page_num</font>] = $totalvisit_sth-&gt;fetchrow_array();

    $totalvisittoday_sth-&gt;execute($<font color="#808000">pages</font>[$<font color="#808000">page_num</font>], $<font color="#808000">today</font>);
    $totalvisittoday[$<font color="#808000">page_num</font>] = $totalvisittoday_sth-&gt;fetchrow_array();

    $totalvisittoday_sth-&gt;execute($<font color="#808000">pages</font>[$<font color="#808000">page_num</font>], $<font color="#808000">yesterday</font>);
    $totalyvisit[$<font color="#808000">page_num</font>] = $totalvisittoday_sth-&gt;fetchrow_array();

    $totalmvisit_sth-&gt;execute($<font color="#808000">pages</font>[$<font color="#808000">page_num</font>], $<font color="#808000">end_of_30_days</font>,
                                                 $<font color="#808000">start_of_30_days</font>);
    $totalmvisit[$<font color="#808000">page_num</font>] = $totalmvisit_sth-&gt;fetchrow_array();
}

close (INPUT);

</code></pre>
<p>
Test.  Log.  Check in.
</p>



<h3>Better Names</h3>
<p>

With decent variable names in place, the purpose of the program
becomes <b>much</b> clearer.  This is a program to calculate the number of
visits to a page for various date ranges.  Based on this new
information we can give the statement handles and the arrays they put
data into better names.
</p>


<p>
Looking at the SQL we see we've got:
</p>


<ul>
<li>One to get all the visits up to a single day.</li>
<li>One to get the visits for a certain date.</li>
<li>One to get the visits for a range of dates.</li>
</ul>
<p>

A good set of new names would be:
</p>


<ul>
<li>daily</li>
<li>up to</li>
<li>range</li>
</ul>
<p>

Also, Total Visits is too long.  We could shorten that to just
Visits, or even shorter to Hits.
</p>


<pre><code>my $<font color="#808000">hits_upto</font>_sth = $dbh-&gt;prepare(&lt;&lt;'SQL');
SELECT count(*)
FROM   lognew 
WHERE  pageid =  ? AND 
       data   &gt;= ?
SQL

my $<font color="#808000">hits_daily</font>_sth = $dbh-&gt;prepare(&lt;&lt;'SQL');
SELECT count(*) 
FROM   lognew 
WHERE  pageid = ? AND 
       data   = ?
SQL

my $<font color="#808000">hits_range</font>_sth = $dbh-&gt;prepare(&lt;&lt;'SQL');
SELECT count(*) 
FROM   lognew 
WHERE  pageid =  ? AND
       data   &lt;= ? AND 
       data   &gt;= ?
SQL

open (INPUT, "&lt; $filepageid") || &amp;file_open_error("$filepageid");

while ($line=&lt;INPUT&gt;){
    $page_num++;
    chop($line);
    $pages[$page_num] = $line;

    $<font color="#808000">hits_upto</font>_sth-&gt;execute($pages[$page_num], $start_date);
    $totalvisit[$page_num] = $<font color="#808000">hits_upto</font>_sth-&gt;fetchrow_array();

    $<font color="#808000">hits_daily</font>_sth-&gt;execute($pages[$page_num], $today);
    $totalvisittoday[$page_num] = $<font color="#808000">hits_daily</font>_sth-&gt;fetchrow_array();

    $<font color="#808000">hits_daily</font>_sth-&gt;execute($pages[$page_num], $yesterday);
    $totalyvisit[$page_num] = $<font color="#808000">hits_daily</font>_sth-&gt;fetchrow_array();

    $<font color="#808000">hits_range</font>_sth-&gt;execute($pages[$page_num], $end_of_30_days,
                                                $start_of_30_days);
    $totalmvisit[$page_num] = $<font color="#808000">hits_range</font>_sth-&gt;fetchrow_array();
}

close (INPUT);

</code></pre>
<p>
Test.  Log.  Check in.
</p>



<h3>Changing Global Variable Names</h3>
<p>

The array names need work, too.  Currently, they're rather ambiguous.
<code>@totalyvisit</code>, what does the <i>y</i> mean?  Looking at each variable
name and the variables that got passed to <code>execute()</code> to produce it...
</p>


<ul>
<li><code>@totalvisit</code> comes up to a <code>$start_date</code>.  So that can be <code>@hits_upto</code></li>
<li><code>@totalvisittoday</code> comes from <code>$today</code> and is pretty obvious.  <code>@hits_today</code></li>
<li><code>@totalyvisit</code> comes from <code>$yesterday</code> so 'y' must be for 'yesterday'.  <code>@hits_yesterday</code></li>
<li><code>@totalmvisit</code> comes from the range produced by the $start_of_30_days and the $end_of_30_days.  So 'm' must be 'month'.  <code>@hits_monthly</code></li>
</ul>
<pre><code>my $hits_upto_sth = $dbh-&gt;prepare(&lt;&lt;'SQL');
SELECT count(*)
FROM   lognew 
WHERE  pageid =  ? AND 
       data   &gt;= ?
SQL

my $hits_daily_sth = $dbh-&gt;prepare(&lt;&lt;'SQL');
SELECT count(*) 
FROM   lognew 
WHERE  pageid = ? AND 
       data   = ?
SQL

my $hits_range_sth = $dbh-&gt;prepare(&lt;&lt;'SQL');
SELECT count(*) 
FROM   lognew 
WHERE  pageid =  ? AND
       data   &lt;= ? AND 
       data   &gt;= ?
SQL

open (INPUT, "&lt; $filepageid") || &amp;file_open_error("$filepageid");

while ($line=&lt;INPUT&gt;){
    $page_num++;
    chop($line);
    $pages[$page_num] = $line;

    $hits_upto_sth-&gt;execute($pages[$page_num], $start_date);
    $<font color="#808000">hits_upto</font>[$page_num] = $hits_upto_sth-&gt;fetchrow_array();

    $hits_daily_sth-&gt;execute($pages[$page_num], $today);
    $<font color="#808000">hits_today</font>[$page_num] = $hits_daily_sth-&gt;fetchrow_array();

    $hits_daily_sth-&gt;execute($pages[$page_num], $yesterday);
    $<font color="#808000">hits_yesterday</font>[$page_num] = $hits_daily_sth-&gt;fetchrow_array();

    $hits_range_sth-&gt;execute($pages[$page_num], $end_of_30_days,
                                                $start_of_30_days);
    $<font color="#808000">hits_monthly</font>[$page_num] = $hits_range_sth-&gt;fetchrow_array();
}

close (INPUT);

</code></pre>
<p>
Test... uh-oh, test failed!
</p>


<p>
There's something <b>very</b> different about this change compared to the
others.  The variables we changed were <em>not</em> declared in our little
code block.  Likely they're used in other parts of the code, such as
our test which caused it to break.
</p>


<p>
In the Real World, we would be sure to <b>replace all occurrences of the
variable</b>.  The simplest way to do this is to use your editor to
perform a search and replace rather than doing it by your all too
fallible hands.  If it could be used over a set of files, grepping
through those files for all occurrences of it and changing those as
well would be necessary.
</p>


<pre><code># If you don't have rgrep, grep -r does the same thing.
rgrep '[@$]totalvisit' /path/to/your/project

</code></pre>
<p>
I do this so often that I've taken to calling grep -r, 'Refactoring
Grep'.  Other languages who's syntax is -- ummm -- not as inspired as
Perl's, such as Java, C++ and Python, have tools for doing this sort
of thing automatically.  Because of the complexity of Perl's syntax, we
still have to do it mostly by hand, though there are some efforts
underway to rectify this. 
</p>


<p>
Changing the array names in our test as well we get them to pass.
</p>


<p>
Log.  Check in.
</p>













<h3>Improve Overly Generic Names</h3>
<p>

Continuing with our variable name improvements, we're left with the
last few unimproved names.  Let's start with <code>$line</code>.
</p>


<p>
Since we can see clearly that <code>$line = &lt;INPUT&gt;</code>, calling the variable
'line' tells us nothing new.  A better name might be what each line
contains.  Looking at how the line is used we see <code>$pages[$page_num]
= $line</code> and how that is then used in the SQL.  It's a page id.
</p>


<p>
But it doesn't make much sense to put a page id into an array called
<code>@pages</code>.  It doesn't contain pages, it contains <code>@page_ids</code>.
</p>


<p>
What about <code>$page_num</code>?  It doesn't contain a page number, it contains
the line number of the file we're reading in.  Or more conventionally,
an <code>$index</code> or <code>$idx</code>.
</p>


<pre><code>my $hits_upto_sth = $dbh-&gt;prepare(&lt;&lt;'SQL');
SELECT count(*)
FROM   lognew 
WHERE  pageid =  ? AND 
       data   &gt;= ?
SQL

my $hits_daily_sth = $dbh-&gt;prepare(&lt;&lt;'SQL');
SELECT count(*) 
FROM   lognew 
WHERE  pageid = ? AND 
       data   = ?
SQL

my $hits_range_sth = $dbh-&gt;prepare(&lt;&lt;'SQL');
SELECT count(*) 
FROM   lognew 
WHERE  pageid =  ? AND
       data   &lt;= ? AND 
       data   &gt;= ?
SQL

open (INPUT, "&lt; $filepageid") || &amp;file_open_error("$filepageid");

while ($<font color="#808000">page_id</font>=&lt;INPUT&gt;){
    $<font color="#808000">idx++</font>;
    chop($<font color="#808000">page_id</font>);
    $<font color="#808000">page_ids</font>[$idx] = $<font color="#808000">page_id</font>;

    $hits_upto_sth-&gt;execute($<font color="#808000">page_ids</font>[$<font color="#808000">idx</font>], $start_date);
    $hits_upto[$<font color="#808000">idx</font>] = $hits_upto_sth-&gt;fetchrow_array();

    $hits_daily_sth-&gt;execute($<font color="#808000">page_ids</font>[$<font color="#808000">idx</font>], $today);
    $hits_today[$<font color="#808000">idx</font>] = $hits_daily_sth-&gt;fetchrow_array();

    $hits_daily_sth-&gt;execute($<font color="#808000">page_ids</font>[$<font color="#808000">idx</font>], $yesterday);
    $hits_yesterday[$<font color="#808000">idx</font>] = $hits_daily_sth-&gt;fetchrow_array();

    $hits_range_sth-&gt;execute($<font color="#808000">page_ids</font>[$<font color="#808000">idx</font>], $end_of_30_days,
                                                   $start_of_30_days);
    $hits_monthly[$<font color="#808000">idx</font>] = $hits_range_sth-&gt;fetchrow_array();
}

close (INPUT);

</code></pre>
<p>
Test.  Log.  Check in.
</p>



<h3>Fixing Odd Interfaces</h3>
<p>

What's wrong with this picture?
</p>


<pre><code>$hits_range_sth-&gt;execute($page_ids[$idx], $end_of_30_days,
                                               $start_of_30_days);

</code></pre>
<p>
Isn't it a little odd to specify a date range with the end first?
Sure is.  It also guarantees someone is going to get it backwards.
Reverse it.  Don't forget the SQL, too.
</p>


<pre><code>my $hits_upto_sth = $dbh-&gt;prepare(&lt;&lt;'SQL');
SELECT count(*)
FROM   lognew 
WHERE  pageid =  ? AND 
       data   &gt;= ?
SQL

my $hits_daily_sth = $dbh-&gt;prepare(&lt;&lt;'SQL');
SELECT count(*) 
FROM   lognew 
WHERE  pageid = ? AND 
       data   = ?
SQL

my $hits_range_sth = $dbh-&gt;prepare(&lt;&lt;'SQL');
SELECT count(*) 
FROM   lognew 
WHERE  pageid =  ? AND
<font color="#808000">       data   &gt;= ? AND
       data   &lt;= ? </font>
SQL

open (INPUT, "&lt; $filepageid") || &amp;file_open_error("$filepageid");

while ($page_id=&lt;INPUT&gt;){
    $idx++;
    chop($page_id);
    $page_ids[$idx] = $page_id;

    $hits_upto_sth-&gt;execute($page_ids[$idx], $start_date);
    $hits_upto[$idx] = $hits_upto_sth-&gt;fetchrow_array();

    $hits_daily_sth-&gt;execute($page_ids[$idx], $today);
    $hits_today[$idx] = $hits_daily_sth-&gt;fetchrow_array();

    $hits_daily_sth-&gt;execute($page_ids[$idx], $yesterday);
    $hits_yesterday[$idx] = $hits_daily_sth-&gt;fetchrow_array();

    $hits_range_sth-&gt;execute($page_ids[$idx], <font color="#808000">$start_of_30_days,
                                                   $end_of_30_days</font>);
    $hits_monthly[$idx] = $hits_range_sth-&gt;fetchrow_array();
}

close (INPUT);

</code></pre>
<p>
Test.  Log.  Check in.
</p>



<h3>s/chop/chomp/</h3>
<p>

Now that we've stared at the code for a while, you might have noticed
the use of <code>chop()</code>.  Using <code>chop()</code> to strip a newline is asking
for portability problems, so let's fix it by using <code>chomp()</code>.
</p>


<p>
Technically this <em>isn't</em> a refactoring since we altered the behavior
of the code by fixing the bug.  But using <code>chop()</code> where you meant
<code>chomp()</code> is such a common mistake we'll make it an honorary
refactoring.
</p>


<pre><code>my $hits_upto_sth = $dbh-&gt;prepare(&lt;&lt;'SQL');
SELECT count(*)
FROM   lognew 
WHERE  pageid =  ? AND 
       data   &gt;= ?
SQL

my $hits_daily_sth = $dbh-&gt;prepare(&lt;&lt;'SQL');
SELECT count(*) 
FROM   lognew 
WHERE  pageid = ? AND 
       data   = ?
SQL

my $hits_range_sth = $dbh-&gt;prepare(&lt;&lt;'SQL');
SELECT count(*) 
FROM   lognew 
WHERE  pageid =  ? AND
       data   &gt;= ? AND
       data   &lt;= ? 
SQL

open (INPUT, "&lt; $filepageid") || &amp;file_open_error("$filepageid");

while ($page_id=&lt;INPUT&gt;){
    $idx++;
    <font color="#808000">chomp</font>($page_id);
    $page_ids[$idx] = $page_id;

    $hits_upto_sth-&gt;execute($page_ids[$idx], $start_date);
    $hits_upto[$idx] = $hits_upto_sth-&gt;fetchrow_array();

    $hits_daily_sth-&gt;execute($page_ids[$idx], $today);
    $hits_today[$idx] = $hits_daily_sth-&gt;fetchrow_array();

    $hits_daily_sth-&gt;execute($page_ids[$idx], $yesterday);
    $hits_yesterday[$idx] = $hits_daily_sth-&gt;fetchrow_array();

    $hits_range_sth-&gt;execute($page_ids[$idx], $start_of_30_days,
                                                   $end_of_30_days,);
    $hits_monthly[$idx] = $hits_range_sth-&gt;fetchrow_array();
}

close (INPUT);

</code></pre>
<p>
Test.  Log.  Check in.
</p>



<h3>Collect Related Variables into Hashes</h3>
<p>

The common prefix <code>hits_</code> is a dead giveaway that much of the data in
this code is related.  Related variables should be grouped together
into a single structure, probably a hash to make the relation obvious
and allow them to be passed around to subroutines more easily.  Its
easier to move around one hash than four arrays.
</p>


<p>
I've decided to collect together all the <code>@hit_</code> arrays into a single
hash <code>%hits</code> since they'll probably be used together parts of the
program.  If this code snippet represents a function it means I can
return one hash reference rather than four array refs.  It also makes
future expansion easier, rather than returning an additional array it
simply becomes another key in the hash.
</p>


<p>
Before.
</p>


<pre><code>$hits{upto}[$idx] = $hits_upto_sth-&gt;fetchrow_array();

</code></pre>
<p>
After.
</p>


<pre><code>$hits_upto[$idx]  = $hits_upto_sth-&gt;fetchrow_array();

</code></pre>
<p>
It's interesting to note what a small, natural change this is.
Circumstantial evidence that this is a good refactoring.
</p>


<p>
As before, since these arrays are global data, we must be sure to
change them everywhere.  This includes the tests.
</p>


<pre><code>my $hits_upto_sth = $dbh-&gt;prepare(&lt;&lt;'SQL');
SELECT count(*)
FROM   lognew 
WHERE  pageid =  ? AND 
       data   &gt;= ?
SQL

my $hits_daily_sth = $dbh-&gt;prepare(&lt;&lt;'SQL');
SELECT count(*) 
FROM   lognew 
WHERE  pageid = ? AND 
       data   = ?
SQL

my $hits_range_sth = $dbh-&gt;prepare(&lt;&lt;'SQL');
SELECT count(*) 
FROM   lognew 
WHERE  pageid =  ? AND
       data   &gt;= ? AND
       data   &lt;= ? 
SQL

open (INPUT, "&lt; $filepageid") || &amp;file_open_error("$filepageid");

while ($page_id=&lt;INPUT&gt;){
    $idx++;
    chomp($page_id);
    $page_ids[$idx] = $page_id;

    $hits_upto_sth-&gt;execute($page_ids[$idx], $start_date);
    $hits<font color="#808000">{upto}</font>[$idx] = $hits_upto_sth-&gt;fetchrow_array();

    $hits_daily_sth-&gt;execute($page_ids[$idx], $today);
    $hits<font color="#808000">{today}</font>[$idx] = $hits_daily_sth-&gt;fetchrow_array();

    $hits_daily_sth-&gt;execute($page_ids[$idx], $yesterday);
    $hits<font color="#808000">{yesterday}</font>[$idx] = $hits_daily_sth-&gt;fetchrow_array();

    $hits_range_sth-&gt;execute($page_ids[$idx], $start_of_30_days,
                                                   $end_of_30_days,);
    $hits<font color="#808000">{monthly}</font>[$idx] = $hits_range_sth-&gt;fetchrow_array();
}

close (INPUT);

</code></pre>
<p>
Test.  Log.  Check in.
</p>



<h3>When Not to Refactor</h3>
<p>

The statement handles are also related, but I'm not going to collect
them together into a hash.  The statement handles are short-lived
lexicals, they're never likely to be passed around.  Their short scope
and grouping within the code makes their relationship obvious.  The
design would not be improved by the refactoring.
</p>


<p>
Refactoring is not a set of rules to be slavishly followed, it's a
collection of tools.  And like any other tool you must carefully
consider when and when not to use it.  Since collecting the statement
handles together doesn't improve the design, I won't do it.
</p>













<h3>Eliminate Unnecessary Longhand</h3>
<p>

Boy, we sure use <code>$page_ids[$idx]</code> a lot.  It's the current page
ID.  But don't we have a variable for that?  
</p>


<p>
Replace all the unnecessary array accesses and just use the more
concise and descriptive <code>$page_id</code>.
</p>


<pre><code>my $hits_upto_sth = $dbh-&gt;prepare(&lt;&lt;'SQL');
SELECT count(*)
FROM   lognew 
WHERE  pageid =  ? AND 
       data   &gt;= ?
SQL

my $hits_daily_sth = $dbh-&gt;prepare(&lt;&lt;'SQL');
SELECT count(*) 
FROM   lognew 
WHERE  pageid = ? AND 
       data   = ?
SQL

my $hits_range_sth = $dbh-&gt;prepare(&lt;&lt;'SQL');
SELECT count(*) 
FROM   lognew 
WHERE  pageid =  ? AND
       data   &gt;= ? AND
       data   &lt;= ? 
SQL

open (INPUT, "&lt; $filepageid") || &amp;file_open_error("$filepageid");

while ($page_id=&lt;INPUT&gt;){
    $idx++;
    chomp($page_id);
    $page_ids[$idx] = $page_id;

    $hits_upto_sth-&gt;execute($<font color="#808000">page_id</font>, $start_date);
    $hits{upto}[$idx] = $hits_upto_sth-&gt;fetchrow_array();

    $hits_daily_sth-&gt;execute($<font color="#808000">page_id</font>, $today);
    $hits{today}[$idx] = $hits_daily_sth-&gt;fetchrow_array();

    $hits_daily_sth-&gt;execute($<font color="#808000">page_id</font>, $yesterday);
    $hits{yesterday}[$idx] = $hits_daily_sth-&gt;fetchrow_array();

    $hits_range_sth-&gt;execute($<font color="#808000">page_id</font>, $start_of_30_days,
                                       $end_of_30_days,);
    $hits{monthly}[$idx] = $hits_range_sth-&gt;fetchrow_array();
}

</code></pre>
<p>
Test.  Log.  Check in.
</p>



<h3>Rearrange Data Structures to Fit Their Use</h3>
<p>

Currently, <code>%hits</code> is accessed by the order the page ID was read out
of the file.  Well, that doesn't seem very useful at all.  Its purpose
seems to be for listing the page counts in exactly the same order as
you read them in.  Even then you need to iterate through <code>@page_ids</code>
simultaneously because no where in <code>%hits</code> is the page ID stored.
</p>


<p>
Consider a common operation, looking up the hit counts for a given
page ID.  You have to iterate through the whole list of page IDs to do
it.
</p>


<pre><code>foreach my $idx (0..$#page_ids) {
    if( $page_ids[$idx] eq $our_page_id ) {
        print "Hits for $our_page_id today: $hits{today}[$idx]\n";
        last;
    }
}

</code></pre>
<p>
Cumbersome.  A much better layout would be a hash keyed on the page ID.
</p>


<pre><code>$hits{upto}{$page_id} = $hits_upto_sth-&gt;fetchrow_array();

</code></pre>
<p>
Now we can directly access the data for a given page ID.  If
necessary, we can still list the hits in the same order they were read
in by iterating through <code>@page_ids</code>.
</p>


<pre><code>my $hits_upto_sth = $dbh-&gt;prepare(&lt;&lt;'SQL');
SELECT count(*)
FROM   lognew 
WHERE  pageid =  ? AND 
       data   &gt;= ?
SQL

my $hits_daily_sth = $dbh-&gt;prepare(&lt;&lt;'SQL');
SELECT count(*) 
FROM   lognew 
WHERE  pageid = ? AND 
       data   = ?
SQL

my $hits_range_sth = $dbh-&gt;prepare(&lt;&lt;'SQL');
SELECT count(*) 
FROM   lognew 
WHERE  pageid =  ? AND
       data   &gt;= ? AND
       data   &lt;= ? 
SQL

open (INPUT, "&lt; $filepageid") || &amp;file_open_error("$filepageid");

while ($page_id=&lt;INPUT&gt;){
    $idx++;
    chomp($page_id);
    $page_ids[$idx] = $page_id;

    $hits_upto_sth-&gt;execute($page_id, $start_date);
    $hits{upto}<font color="#808000">{$page_id}</font> = $hits_upto_sth-&gt;fetchrow_array();

    $hits_daily_sth-&gt;execute($page_id, $today);
    $hits{today}<font color="#808000">{$page_id}</font> = $hits_daily_sth-&gt;fetchrow_array();

    $hits_daily_sth-&gt;execute($page_id, $yesterday);
    $hits{yesterday}<font color="#808000">{$page_id}</font> = $hits_daily_sth-&gt;fetchrow_array();

    $hits_range_sth-&gt;execute($page_id, $start_of_30_days,
                                       $end_of_30_days,);
    $hits{monthly}<font color="#808000">{$page_id}</font> = $hits_range_sth-&gt;fetchrow_array();
}

</code></pre>
<p>
Test.  Log.  Check in.
</p>



<h3>Eliminate Unnecessary Variables</h3>
<p>

Now that <code>%hits</code> is no longer ordered by how it was read in, <code>$idx</code>
isn't used much anymore.  It's only used to stick <code>$page_id</code> onto the
end of <code>@page_ids</code>, but we can do that with <code>push</code>.
</p>


<p>
This is minor but little things build up to cause big messes.
</p>


<pre><code>my $hits_upto_sth = $dbh-&gt;prepare(&lt;&lt;'SQL');
SELECT count(*)
FROM   lognew 
WHERE  pageid =  ? AND 
       data   &gt;= ?
SQL

my $hits_daily_sth = $dbh-&gt;prepare(&lt;&lt;'SQL');
SELECT count(*) 
FROM   lognew 
WHERE  pageid = ? AND 
       data   = ?
SQL

my $hits_range_sth = $dbh-&gt;prepare(&lt;&lt;'SQL');
SELECT count(*) 
FROM   lognew 
WHERE  pageid =  ? AND
       data   &gt;= ? AND
       data   &lt;= ? 
SQL

open (INPUT, "&lt; $filepageid") || &amp;file_open_error("$filepageid");

while ($page_id=&lt;INPUT&gt;){
    chomp($page_id);
    <font color="#808000">push @page_ids, $page_id;</font>

    $hits_upto_sth-&gt;execute($page_id, $start_date);
    $hits{upto}{$page_id} = $hits_upto_sth-&gt;fetchrow_array();

    $hits_daily_sth-&gt;execute($page_id, $today);
    $hits{today}{$page_id} = $hits_daily_sth-&gt;fetchrow_array();

    $hits_daily_sth-&gt;execute($page_id, $yesterday);
    $hits{yesterday}{$page_id} = $hits_daily_sth-&gt;fetchrow_array();

    $hits_range_sth-&gt;execute($page_id, $start_of_30_days,
                                       $end_of_30_days,);
    $hits{monthly}{$page_id} = $hits_range_sth-&gt;fetchrow_array();
}

</code></pre>
<p>
Test.  Log.  Check in.
</p>



<h3>Pull Logical Chunks Out into Functions</h3>
<p>

Our final refactoring is one of the most common and most useful.
</p>


<p>
Let's assume that we need to generate page counts somewhere else in
the code.  Rather than repeat the code to do this, we want to put it
in a subroutine so it can be reused.  One subroutine for each
statement.
</p>


<p>
In order to do this, start by identifying the code that would go into
the routine.
</p>


<pre><code>$hits_upto_sth-&gt;execute($page_id, $start_date);
$hits{upto}{$page_id} = $hits_upto_sth-&gt;fetchrow_array();

</code></pre>
<p>
Then wrap a subroutine around it.
</p>


<pre><code><font color="#808000">sub hits_upto {</font>
    $hits_upto_sth-&gt;execute($page_id, $start_date);
    $hits{upto}{$page_id} = $hits_upto_sth-&gt;fetchrow_array();
<font color="#808000">}</font>

</code></pre>
<p>
Now look at all the variables used.
</p>


<p>
<code>$hits_upto_sth</code> is a global (well, file-scoped lexical) and is
defined entirely outside the function.  We can keep using it in our
subroutine in the same way we are now.
</p>


<p>
<code>$hits{upto}{$page_id}</code> is receiving the result of the calculation.
It contains the return value.  So it goes outside the function to
receive the return value.  Where its assignment was, we put a <code>return</code>.
</p>


<pre><code>sub hits_upto {
    $hits_upto_sth-&gt;execute($page_id, $start_date);
    <font color="#808000">return</font> $hits_upto_sth-&gt;fetchrow_array();
}

</code></pre>
<p>
<code>$page_id</code> and <code>$start_date</code> vary from call to call.  These are our
function arguments.
</p>


<pre><code>sub hits_upto {
    <font color="#808000">my($page_id, $start_date) = @_;</font>
    $hits_upto_sth-&gt;execute($page_id, $start_date);
    return $hits_upto_sth-&gt;fetchrow_array();
}

</code></pre>
<p>
Finally, rename things in a more generic manner.  This is a subroutine
for calculating the number of hits up to a certain date.  Instead of
<code>$start_date</code> which was specific to one calculation, we'd call it
<code>$date</code>.
</p>


<pre><code>sub hits_upto {
    my($page_id, <font color="#808000">$date</font>) = @_;
    $hits_upto_sth-&gt;execute($page_id, <font color="#808000">$date</font>);
    return $hits_upto_sth-&gt;fetchrow_array();
}

</code></pre>
<p>
And that's our new subroutine, does the same thing as the original
code.  Then it's a simple matter to use it in the code.
</p>

   
<pre><code>    $hits{upto}{$page_id} = <font color="#808000">hits_upto($page_id, $start_date)</font>;


my $hits_upto_sth = $dbh-&gt;prepare(&lt;&lt;'SQL');
SELECT count(*)
FROM   lognew 
WHERE  pageid =  ? AND 
       data   &gt;= ?
SQL

my $hits_daily_sth = $dbh-&gt;prepare(&lt;&lt;'SQL');
SELECT count(*) 
FROM   lognew 
WHERE  pageid = ? AND 
       data   = ?
SQL

my $hits_range_sth = $dbh-&gt;prepare(&lt;&lt;'SQL');
SELECT count(*) 
FROM   lognew 
WHERE  pageid =  ? AND
       data   &gt;= ? AND
       data   &lt;= ? 
SQL

open (INPUT, "&lt; $filepageid") || &amp;file_open_error("$filepageid");

while ($page_id=&lt;INPUT&gt;){
    chomp($page_id);
    <font color="#808000">push @page_ids, $page_id;</font>

    $hits{upto}{$page_id}      = <font color="#808000">hits_upto($page_id, $start_date)</font>;
    $hits{today}{$page_id}     = <font color="#808000">hits_daily($page_id, $today)</font>;
    $hits{yesterday}{$page_id} = <font color="#808000">hits_daily($page_id, $yesterday)</font>;
    $hits{monthly}{$page_id}   = <font color="#808000">hits_range($page_id, $start_of_30_days,
                                                        $end_of_30_days,)</font>;
}

sub hits_upto {
    my($page_id, $date) = @_;
    $hits_upto_sth-&gt;execute($page_id, $date);
    return scalar $hits_upto_sth-&gt;fetchrow_array();
}

sub hits_daily {
    my($page_id, $date) = @_;
    $hits_daily_sth-&gt;execute($page_id, $date);
    return scalar $hits_daily_sth-&gt;fetchrow_array();
}

sub hits_range {
    my($page_id, $start, $end) = @_;
    $hits_range_sth-&gt;execute($page_id, $start, $end);
    return scalar $hits_range_sth-&gt;fetchrow_array();
}

</code></pre>
<p>
Test.  Log.  Check in.
</p>



<h3>Undo.</h3>
<p>

Some may balk at putting that small of a snippet of code into a
subroutine like that.  There are definite performance concerns about
adding four subroutine calls to a loop.  But I'm not worried about
that at all.
</p>


<p>
One of the beauties of Refactoring is that it's reversible.
Refactorings don't change how the program works.  We can reverse any
of these refactorings and the code will work exactly the same.  If a
refactoring turns out to be a bad idea, undo it.  Logging each
refactoring in version control makes the job even easier.
</p>


<p>
So if it turns out moving the executes into their own functions causes
a performance problem the change can easily be undone.
</p>



<h3>Done?</h3>
<p>

At this point, things are looking pretty nice.  The code is well
structured, readable, and efficient.  The variables are sensibly named.
The data is organized in a fairly flexible manner.
</p>


<p>
It's good enough.  This is not to say that there's not more that could
be done, but we don't need to.  And Refactoring is about doing as much
redesign as you need instead of what you might need.
</p>



<h3>Refactoring and the Swiss Army Knife</h3>
<p>

As programmers we have a tendency towards over-design.  We like to
design our code to deal with any possible situation that might arise,
since it was hard to change the design later.  This is known as Big
Design Up Front (BDUF).  It's like one of those <a href="http://www.victorinox.com/newsite/en/produkte/neu/inhalt2.cfm?pid=1-6795-XLT">enormous Swiss Army Knives with 50 functions</a>.  Most of the time all you need is <a href="http://www.victorinox.com/newsite/en/produkte/neu/inhalt2.cfm?pid=2-2363">a knife with something to open your beer with and then maybe pick your teeth afterwards</a> but you never know.  
So you over-engineer because it's hard to improve it later.  If it never gets used then a lot of effort has been wasted.
</p>


<p>
Refactoring turns design on its ear.  Now you can continually evolve
your design as needed.  There's no longer a need to write for every
possible situation up front so you can focus on just what you need
right now.  If you need more flexibility later, you can add that
flexibility through refactoring.  It's like having a Swiss Army knife
that you can add tools to as you need them.
</p>



<h3>Further Reference</h3>
<ul>
<li><a href="http://groups.google.com/groups?th=11b4e3caaafb9849&amp;seekm=20021005063711.GE15102%40ool-18b93024.dyn.optonline.net#link1">The original thread on Fun With Perl</a></li>
<li>The <a href="http://www.c2.com/cgi/wiki?WelcomeVisitors">Portland Pattern Repository</a> answers the question -- <a href="http://www.c2.com/cgi/wiki?WhatIsRefactoring">WhatIsRefactoring?</a></li>
<li><a href="http://www.amazon.com/exec/obidos/tg/detail/-/0201485672">The Refactoring Book</a> by <a href="http://www.martinfowler.com">Martin Fowler</a></li>
</ul>
        </div>



    </div>
    <div class="asset-footer"></div>
</div>


                            
                            <div id="entry-1198" class="entry-asset asset hentry">
    <div class="asset-header">
        <h2 class="asset-name entry-title"><a href="/pub/2003/10/03/musicbrainz.html" rel="bookmark">Identifying Audio Files with MusicBrainz</a></h2>
        <div class="asset-meta">
            <span class="byline">
    
                By <span class="vcard author">Paul Mison</span> on <abbr class="published" title="2003-10-03T00:00:00-08:00">October  3, 2003 12:00 AM</abbr>
    
            </span>

            
            

        </div>
    </div>
    <div class="asset-content entry-content">

        <div class="asset-body">
            <p>It's quite possible to end up with digital music files that don't have
good information about what they are. Files that don't have ID3
information can rely on paths for album information, for example, and
that is lost easily. M3U files describing track order can be deleted or
ignored by naive archiving.</p>
<p>Wouldn't it be nice if, once you had a music file, you could use Perl to
take what information you did have about a track, send it to the
Internet, and get back the data you were missing? Well, you can.</p>
<p>
</p>


<h3><a name="a_step_through_history">A Step Through History</a></h3>
<p>In the beginning (well, more or less), music was on CDs. People started
listening to CDs on computers shortly after that, and they found that it
would be nice to know the track's name, not just the number.
Applications were developed that could store the CD metadata locally.
Still, it was tedious to type in all those CD lists, so people shared
the metadata in a single index file on the Internet.</p>
<p>As with most other single-file data stores in Internet history, soon it
became sensible to turn this into a proper database. And so the CDDB was
born. Clients could upload a description of the disc (the Table of
Contents, which described how long each track is) and either download the
information for that CD, or contribute it if it wasn't in the database.</p>
<p>During 1999 and 2000, however, the CDDB (after its acquisition by
Gracenote) moved from an open position (with GPLed downloads of its data
files) to a proprietary one. During this time it stopped access to
clients speaking the first version of the CDDB protocol, and instead
moved to licensing -- at some cost -- CDDB2 clients, and stopped offering
downloads of its data.</p>
<p>However, a few projects started up, taking advantage of the data that
had been freely available until this point. One of these was FreeDB,
which quickly established an open replacement for the CDDB. The other is
MusicBrainz, which is much more interesting.</p>
<p>
</p>


<h3><a name="freedb">FreeDB</a></h3>
<p>FreeDB replicates the structure of the old CDDB very faithfully. This means that a number of Perl modules for handling CDDB data are applicable to the FreeDB as well.</p>
<p>However, despite the large number of FreeDB modules on CPAN, it's not
really well suited to the task of finding or correcting digital music
file metadata. FreeDB grew out of CDDB, which was designed around the
task of identifying entire CDs, not merely single tracks, and that is
still reflected in the way most of the modules work; they require you to
either have or fake the CD's table of contents to get results.</p>
<p>FreeDB also has a search form on its web site, and there's a Perl module
-- <code>Webservice::FreeDB</code> -- that you can use to find out information on a
per-track basis. However, wherever possible a web service is probably
preferable to using a screen scraper, and thankfully such a service is
available.</p>
<p>
</p>


<h3><a name="musicbrainz">MusicBrainz</a></h3>
<p>MusicBrainz has similar origins to FreeDB in the post-Gracenote era.
Unlike FreeDB, MB was much more ambitious; as the description says,
`"MusicBrainz is a community music metadatabase that attempts to create a
comprehensive music information site.''</p>
<p>In addition to taking the FreeDB data and making it available (in fact,
the FreeDB changes appear to be regularly merged into MusicBrainz), MB
takes care to make sure that their data is moderated regularly. FreeDB's
discid-based system didn't always make sure that different versions CDs
were recognized as duplicates, for example, whereas the MB volunteers
attempt to consolidate such data. They also offer fairly powerful
searches of the data from a web-based front end.</p>
<p>More importantly for our purposes, MusicBrainz has a web services API. Rather than using SOAP, it's a REST-based service based on RDF.</p>
<p>You can see an example of this by downloading the data at a URL like <a href="http://mm.musicbrainz.org/mm-2.1/album/1073abfc-768e-455b-9937-9b41b923c746/4">http://mm.musicbrainz.org/mm-2.1/album/1073abfc-768e-455b-9937-9b41b923c746/4</a>. This returns RDF for the Underworld album <i>Beaucoup Fish</i>. The long hex string is the album's unique identifier within MusicBrainz, and the number at the end (4) tells MusicBrainz how deeply to go when building the RDF graph. This level of depth means that as well as merely getting a track listing as references to other RDF documents (like <a href="http://musicbrainz.org/track/55ef9194-bb58-4397-a8a2-e0d41d2e1435">http://musicbrainz.org/track/55ef9194-bb58-4397-a8a2-e0d41d2e1435</a>), you get the name of the track inlined in the document.</p>
<p>
</p>
<h4><a name="using_musicbrainz::client">Using MusicBrainz::Client</a></h4>
<p>However, requesting that URL directly requires you know the MusicBrainz ID for that album, track, or artist, and that you can parse RDF. Unsurprisingly, there's code out there that can do both from a given piece of information.</p>
<p><code>the MusicBrainz::Client manpage</code> is a Perl interface to the C client library for MB, and is available as part of the <a href="http://musicbrainz.org/products/client/download.html">Client SDK download</a>, as well as on CPAN.</p>
<p>Here's a small example of using one of the more useful queries provided, the snappily-entitled <code>MBQ_FileInfoLookup</code>. This takes up to 10 parameters, as documented in the <a href="http://musicbrainz.org/docs/mb_client/queries_h.html#a84">Query reference</a>. However, you can provide as many or as few items as you wish, and in this example, merely two pieces of information are provided: an artist, and a track name.</p>
<pre><code>
  #!/usr/bin/perl -w
  use strict;
  
  use MusicBrainz::Client;
  use MusicBrainz::Queries qw(:all);

  my $mb = MusicBrainz::Client-&gt;new();
  my $query = [ '', 'Underworld', '', 'Air Towel' ];
  my $result;</code></pre>
<p>Now we've set up the script, and initialized a client object, let's actually talk to the server.</p>
<pre><code>
  if (!$mb-&gt;query_with_args( MBQ_FileInfoLookup, $query )) {
    die &quot;Query failed &quot;.$mb-&gt;get_query_error();
  }
  
  if (!$mb-&gt;select1(MBS_SelectLookupResult, 1)) {
    die &quot;No lookup result&quot;;
  }</code></pre>
<p>This sends off a query to the MusicBrainz server, and does two checks to see if it's worth continuing. If there's no return value from query_with_args, the script dies with the error returned. If there's not at least one result in the returned data, it also dies.</p>
<p>The exact arguments that <code>MBQ_FileInfoLookUp</code> take are documented in the query reference above. Notably, the first argument is the TRM ID. This is a generated, unique identifier for the file, based on a number of weighted checks, including wavelet analysis. Generally I've found it's still possible to get good results without including it, though.</p>
<pre><code>
  my $type = $mb-&gt;get_result_data(MBE_LookupGetType);
  my $frag = $mb-&gt;get_fragment_from_url($type);
  
  if ($frag eq 'AlbumTrackResult') {
    $result = handle_album_track_list($mb);
  }
  else {
    die &quot;Not an AlbumTrackResult; instead of type '$frag'&quot;;
  }</code></pre>
<p><code>MBQ_FileInfoLookup</code> can return different types of result. This code uses two more functions from MusicBrainz to find out the type of the result (the LookupGetType function) and then to parse out from the URL what type of result that is. We're only interested in AlbumTrackResult type, so we die if that's not what's found. If it is of that type, it's handled by a subroutine, which we'll look at now.</p>
<pre><code>
  sub handle_album_track_list {
    my $mb = shift;
    my $result;</code></pre>
<p>First, we get the MusicBrainz client object and pre-declare our result variable.
</p>
<pre><code>

    for (my $i = 1;; $i++) {
      $mb-&gt;select(MBS_Rewind);

      if (!$mb-&gt;select1(MBS_SelectLookupResult, $i)) {
        last;
      }</code></pre>
<p>MusicBrainz results sets are a lot like database rows. You loop over them, and pull out the data you want.</p>
<p>However, the interface to the results is somewhat C-like. As you can see, we loop over the results one by one, stopping only when there isn't a result in the set.</p>
<pre><code>
      my $relevance = $mb-&gt;get_result_int(MBE_LookupGetRelevance);</code></pre>
<p>However, once there is a result, we can pull out information from it, like the relevance of that data.
</p>
<pre><code>

      # get track info
      $mb-&gt;select(MBS_SelectLookupResultTrack);
      my $track   = $mb-&gt;get_result_data(MBE_TrackGetTrackName);
      my $length  = $mb-&gt;get_result_data(MBE_TrackGetTrackDuration);     
      my $artist  = $mb-&gt;get_result_data(MBE_TrackGetArtistName);
      $mb-&gt;select(MBS_Back);</code></pre>
<p>To get the information about the track, you select the track portion of that result, then issue get_result_data calls for each of the pieces of information you want (such as the artist name, track name and so on).</p>
<pre><code>
      # get album info
      $mb-&gt;select(MBS_SelectLookupResultAlbum);
      my $album   = $mb-&gt;get_result_data(MBE_AlbumGetAlbumName);
      my $trackct = $mb-&gt;get_result_int(MBE_AlbumGetNumTracks);
      $mb-&gt;select(MBS_Back);</code></pre>
<p>Similarly, you select the album data, and then select the information about the album you want to return.
</p>
<pre><code>

      $result-&gt;[$i-1] = { relevance =&gt; $relevance,
                          track     =&gt; $track,
                          album     =&gt; $album,
                          artist    =&gt; $artist,
                          total     =&gt; $trackct,
                          time      =&gt; $length,
                        };</code></pre>
<p>This is stored in a hash reference, itself stored in the list of results. (Note we move from MusicBrainz offset of 1 to the Perl offset of 0 here.)</p>
<pre><code>
    }
    return $result;
  }

  use Data::Dumper;
  print Dumper($result);</code></pre>
<p>Finally the result is returned and (crudely) inspected. Of course, you could instead take the result with the highest relevance and tag a file here, or offer the choice via some user interface of which result is more likely to be appropriate.</p>
<p>
</p>
<h4><a name="using_audiofile::identify::musicbrainz">Using AudioFile::Identify::MusicBrainz</a></h4>
<p>As you can see, returning the data from MusicBrainz::Client is a fairly verbose procedure. In addition, it's not a pure Perl implementation, so installing the module isn't as easy as it could be, and in some places it's not possible at all.</p>
<p>Given that the REST interface is open, Tom Insam and I decided to play with getting the RDF results and parsing them, putting together Perl modules along the way to help. The result is <code>the AudioFile::Identify::MusicBrainz manpage</code>:</p>
<pre><code>
  #!/usr/bin/perl -w
  use strict;

  use AudioFile::Identify::MusicBrainz::Query;
  my $query = { artist =&gt; 'Underworld', 
                track  =&gt; 'Air Towel',
              };
  my $result;</code></pre>
<p>Again, this is simple setup stuff. You'll note that instead of a list, AIM takes a hash reference with named fields, which is hopefully a little easier to use.</p>
<pre><code>
  my $aim = AudioFile::Identify::MusicBrainz::Query-&gt;new()
            or die &quot;Can't make query&quot;;
  
  $aim-&gt;FileInfoLookup($query);</code></pre>
<p>This block of code instantiates the AIM object and sends off the query.</p>
<pre><code>
  for my $record (@{ $aim-&gt;results }) {
    push @{ $result }, {  relevance =&gt; $record-&gt;relevance,
                          track     =&gt; $record-&gt;track-&gt;title,
                          album     =&gt; $record-&gt;album-&gt;title,
                          artist    =&gt; $record-&gt;track-&gt;artist-&gt;title,
                          tracknum  =&gt; $record-&gt;track-&gt;trackNum,
                          total     =&gt; scalar @{$record-&gt;album-&gt;tracks},
                          time      =&gt; $record-&gt;track-&gt;duration,
                       };
  };</code></pre>
<p>This manipulates the results from AIM such that they match the result list that we created from MusicBrainz::Client. Each of them is a method on the returned object. Some, such as the artist name, are objects referenced from other objects.</p>
<pre><code>
  use Data::Dumper;
  print Dumper($result);</code></pre>
<p>Again, we crudely inspect the output, which is identical but for the addition of the track number.</p>
<p>
</p>


<h3><a name="inside_audofile::identify::musicbrainz">Inside AudoFile::Identify::MusicBrainz</a></h3>
<p>As you'd expect, Perl (and its retinue of modules) made writing this module fairly straightforward. Firstly, LWP makes requesting data from the MusicBrainz server pretty easy. (This code is in <code>the AudioFile::Identify::MusicBrainz::Query manpage</coge>, for the curious.)</p>
<pre><code>
  use LWP;
  use LWP::UserAgent;

  # ...

  my $ua = LWP::UserAgent-&gt;new();

  my $req = HTTP::Request-&gt;new(POST =&gt; $self-&gt;url,);
  $req-&gt;content($rdf);

  my $res = $ua-&gt;request($req);</code></pre>
<p>This sets up an LWP user agent, and sends the RDF query (more on that later) to a URL (returned by another method in the module). That's all you need to get the returned result into the string $res. (The real module has a custom UserAgent string that I've omitted to save space.)</p>
<pre><code>
  # Check the outcome of the response
  if ($res-&gt;is_success) {
    $self-&gt;response($res-&gt;content);
    return $self-&gt;parse();
  }</code></pre>  

<p>As long as there's a result, it gets stored and then parsed. (Don't worry; the real module also handles errors.) So, what does the parser do?
</p>
<pre><code>
  my $parser = new XML::DOM::Parser;
  my $doc = $parser-&gt;parse($self-&gt;response);</code></pre>
<p>MusicBrainz returns results in RDF, but that RDF is itself encapsulated in XML. Although it's not ideal to use XML tools on RDF, it works well enough in this case.</p>
<pre><code>
  my $result_nodes = $doc-&gt;getElementsByTagName('mq:AlbumTrackResult');
  
  $n = $result_nodes-&gt;getLength;
  for (my $i = 0; $i &lt; $n; $i++) {
    my $node = $result_nodes-&gt;item($i);
    my $result =
      AudioFile::Identify::MusicBrainz::Result-&gt;new()
                                              -&gt;store($self-&gt;store)
                                              -&gt;type('Track')
                                              -&gt;parse($node);
    push @$results, $result;
  }</code></pre>
<p>This block of code is a good example of how the XML is parsed. Firstly, all elements with the name mq:AlbumTrackResult are found. These are progressively looped over, and stored in a new Result object (of type Track), and parsed. So, what happens within the parser?</p>
<pre><code>
  my $child = $node-&gt;getFirstChild();
  while($child) {
    if ($child-&gt;getNodeType == 1) {
      my $tag = $child-&gt;getTagName;
      $tag =~ s/.*://;
      if ($self-&gt;can($tag)) {
        $self-&gt;$tag($child);
      }
    }
    $child = $child-&gt;getNextSibling();
  }</code></pre>
<p>The node (as passed in above) is examined, and the first child node is examined. While we have a child node to examine, the program checks that it's an element (of node type 1), gets the tag name and removes the namespace, then calls the appropriate get/set method with the appropriate XML node, before moving on to the next child. (This is a somewhat simplified version, with the error checking removed.)</p>
<p>What happens in an example get/set method? Here's part of the title method from the Track package.</p>
<pre><code>
  if (defined($set)) {
    if ($set-&gt;isa('XML::DOM::Element') and $set-&gt;getFirstChild) {
      $self-&gt;{title} = $set-&gt;getFirstChild-&gt;toString;
    } else {
      $self-&gt;{title} = $set;
    }
    return $self;
  } else {
    return $self-&gt;{title};
  }</code></pre>
<p>If the method is called with some data, the program makes sure it's an XML::DOM element, then parses it and stores the string within that element, or stores the data that was passed in. Otherwise, it returns the data that was previously stored.</p>
<p>One point to note is that MusicBrainz doesn't return all the track information you might need in the initial FileInfoLookup query. Therefore the Result package uses another method, called getData in the Track package, to download the RDF for the track from MusicBrainz. This is then parsed and stored in the same way as the RDF above.

</p>
<p>
</p>


<h3><a name="conclusion">Conclusion</a></h3>
<p>In this article I've shown you how to connect to MusicBrainz and retrieve information from their web services API with both the MusicBrainz::Client and AudioFile::Identify::MusicBrainz modules, and a little of the internal workings of the latter. This should allow you to find out all those niggling missing pieces of information about the tracks at the bottom of your music collection.
</p>
        </div>



    </div>
    <div class="asset-footer"></div>
</div>




                            <div class="content-nav">
                                <a href="/pub/2003/09/">&laquo; September 2003</a> |
                                <a href="/pub/">Main Index</a> |
                                <a href="/pub/archives.html">Archives</a>
                                | <a href="/pub/2003/11/">November 2003 &raquo;</a>
                            </div>


                        </div>
                    </div>


                    <div id="beta">
    <div id="beta-inner">


    
    <div class="widget-what-is-perl widget">
    <div class="widget-content widget-content-what-is-perl">
       Visit the home of the  Perl programming language: <a href="http://www.perl.org/">Perl.org</a
    </div>
</div>
<div class="widget-find-out-more widget-archives widget">
    <div class="widget-content">
        <ul>
            <li><a href="http://www.perl.org/get.html">Download</a></li>
            <li><a href="http://perldoc.perl.org/">Documentation</a></li>
            <li><a href="http://blogs.perl.org/">Perl Bloggers</a></li>
            <li><a href="http://news.perlfoundation.org/">Foundation News</a></li>
        </ul>
    </div>
</div><div class="widget-tcpc widget">
<h3 class="widget-header">Sponsored by</h3>
    <div class="widget-content">
        <a href="http://training.perl.com/" alt="Perl Training" target="_blank"><img src="/i/tcpc.png" width="150" height="50"></a>
    </div>
</div>

<div class="widget-syndication widget">
    <div class="widget-content">
        <ul>
            <li><img src="/mt-static/images/status_icons/feed.gif" alt="Subscribe to feed" width="9" height="9" /> <a href="/pub/atom.xml">Subscribe to this website's feed</a></li>

        </ul>
    </div>
</div>
<div class="widget-archive-monthly widget-archive widget">
    <h3 class="widget-header">Monthly <a href="/pub/archives.html">Archives</a></h3>
    <div class="widget-content">
        <ul>
        
            <li><a href="/pub/2014/02/">February 2014 (1)</a></li>
        
    
        
            <li><a href="/pub/2014/01/">January 2014 (1)</a></li>
        
    
        
            <li><a href="/pub/2013/10/">October 2013 (1)</a></li>
        
    
        
            <li><a href="/pub/2013/01/">January 2013 (1)</a></li>
        
    
        
            <li><a href="/pub/2012/12/">December 2012 (1)</a></li>
        
    
        
            <li><a href="/pub/2012/11/">November 2012 (1)</a></li>
        
    
        
            <li><a href="/pub/2012/10/">October 2012 (2)</a></li>
        
    
        
            <li><a href="/pub/2012/08/">August 2012 (2)</a></li>
        
    
        
            <li><a href="/pub/2012/06/">June 2012 (11)</a></li>
        
    
        
            <li><a href="/pub/2012/05/">May 2012 (18)</a></li>
        
    
        
            <li><a href="/pub/2012/04/">April 2012 (17)</a></li>
        
    
        
            <li><a href="/pub/2012/02/">February 2012 (1)</a></li>
        
    
        
            <li><a href="/pub/2011/12/">December 2011 (1)</a></li>
        
    
        
            <li><a href="/pub/2011/09/">September 2011 (1)</a></li>
        
    
        
            <li><a href="/pub/2011/08/">August 2011 (2)</a></li>
        
    
        
            <li><a href="/pub/2011/06/">June 2011 (1)</a></li>
        
    
        
            <li><a href="/pub/2011/05/">May 2011 (3)</a></li>
        
    
        
            <li><a href="/pub/2011/04/">April 2011 (1)</a></li>
        
    
        
            <li><a href="/pub/2011/03/">March 2011 (1)</a></li>
        
    
        
            <li><a href="/pub/2011/02/">February 2011 (1)</a></li>
        
    
        
            <li><a href="/pub/2011/01/">January 2011 (1)</a></li>
        
    
        
            <li><a href="/pub/2010/11/">November 2010 (1)</a></li>
        
    
        
            <li><a href="/pub/2010/10/">October 2010 (2)</a></li>
        
    
        
            <li><a href="/pub/2010/09/">September 2010 (1)</a></li>
        
    
        
            <li><a href="/pub/2010/08/">August 2010 (3)</a></li>
        
    
        
            <li><a href="/pub/2010/07/">July 2010 (2)</a></li>
        
    
        
            <li><a href="/pub/2010/04/">April 2010 (2)</a></li>
        
    
        
            <li><a href="/pub/2010/03/">March 2010 (4)</a></li>
        
    
        
            <li><a href="/pub/2008/05/">May 2008 (1)</a></li>
        
    
        
            <li><a href="/pub/2008/04/">April 2008 (2)</a></li>
        
    
        
            <li><a href="/pub/2008/03/">March 2008 (1)</a></li>
        
    
        
            <li><a href="/pub/2008/02/">February 2008 (1)</a></li>
        
    
        
            <li><a href="/pub/2008/01/">January 2008 (1)</a></li>
        
    
        
            <li><a href="/pub/2007/12/">December 2007 (2)</a></li>
        
    
        
            <li><a href="/pub/2007/09/">September 2007 (1)</a></li>
        
    
        
            <li><a href="/pub/2007/08/">August 2007 (1)</a></li>
        
    
        
            <li><a href="/pub/2007/07/">July 2007 (1)</a></li>
        
    
        
            <li><a href="/pub/2007/06/">June 2007 (1)</a></li>
        
    
        
            <li><a href="/pub/2007/05/">May 2007 (1)</a></li>
        
    
        
            <li><a href="/pub/2007/04/">April 2007 (1)</a></li>
        
    
        
            <li><a href="/pub/2007/03/">March 2007 (1)</a></li>
        
    
        
            <li><a href="/pub/2007/02/">February 2007 (1)</a></li>
        
    
        
            <li><a href="/pub/2007/01/">January 2007 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/12/">December 2006 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/11/">November 2006 (2)</a></li>
        
    
        
            <li><a href="/pub/2006/10/">October 2006 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/09/">September 2006 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/08/">August 2006 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/07/">July 2006 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/06/">June 2006 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/05/">May 2006 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/04/">April 2006 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/03/">March 2006 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/02/">February 2006 (4)</a></li>
        
    
        
            <li><a href="/pub/2006/01/">January 2006 (4)</a></li>
        
    
        
            <li><a href="/pub/2005/12/">December 2005 (4)</a></li>
        
    
        
            <li><a href="/pub/2005/11/">November 2005 (3)</a></li>
        
    
        
            <li><a href="/pub/2005/10/">October 2005 (2)</a></li>
        
    
        
            <li><a href="/pub/2005/09/">September 2005 (2)</a></li>
        
    
        
            <li><a href="/pub/2005/08/">August 2005 (9)</a></li>
        
    
        
            <li><a href="/pub/2005/07/">July 2005 (8)</a></li>
        
    
        
            <li><a href="/pub/2005/06/">June 2005 (9)</a></li>
        
    
        
            <li><a href="/pub/2005/05/">May 2005 (8)</a></li>
        
    
        
            <li><a href="/pub/2005/04/">April 2005 (7)</a></li>
        
    
        
            <li><a href="/pub/2005/03/">March 2005 (6)</a></li>
        
    
        
            <li><a href="/pub/2005/02/">February 2005 (7)</a></li>
        
    
        
            <li><a href="/pub/2005/01/">January 2005 (6)</a></li>
        
    
        
            <li><a href="/pub/2004/12/">December 2004 (8)</a></li>
        
    
        
            <li><a href="/pub/2004/11/">November 2004 (8)</a></li>
        
    
        
            <li><a href="/pub/2004/10/">October 2004 (5)</a></li>
        
    
        
            <li><a href="/pub/2004/09/">September 2004 (9)</a></li>
        
    
        
            <li><a href="/pub/2004/08/">August 2004 (6)</a></li>
        
    
        
            <li><a href="/pub/2004/07/">July 2004 (8)</a></li>
        
    
        
            <li><a href="/pub/2004/06/">June 2004 (6)</a></li>
        
    
        
            <li><a href="/pub/2004/05/">May 2004 (7)</a></li>
        
    
        
            <li><a href="/pub/2004/04/">April 2004 (8)</a></li>
        
    
        
            <li><a href="/pub/2004/03/">March 2004 (8)</a></li>
        
    
        
            <li><a href="/pub/2004/02/">February 2004 (9)</a></li>
        
    
        
            <li><a href="/pub/2004/01/">January 2004 (7)</a></li>
        
    
        
            <li><a href="/pub/2003/12/">December 2003 (4)</a></li>
        
    
        
            <li><a href="/pub/2003/11/">November 2003 (7)</a></li>
        
    
        
            <li><a href="/pub/2003/10/">October 2003 (8)</a></li>
        
    
        
            <li><a href="/pub/2003/09/">September 2003 (6)</a></li>
        
    
        
            <li><a href="/pub/2003/08/">August 2003 (7)</a></li>
        
    
        
            <li><a href="/pub/2003/07/">July 2003 (9)</a></li>
        
    
        
            <li><a href="/pub/2003/06/">June 2003 (9)</a></li>
        
    
        
            <li><a href="/pub/2003/05/">May 2003 (8)</a></li>
        
    
        
            <li><a href="/pub/2003/04/">April 2003 (8)</a></li>
        
    
        
            <li><a href="/pub/2003/03/">March 2003 (10)</a></li>
        
    
        
            <li><a href="/pub/2003/02/">February 2003 (8)</a></li>
        
    
        
            <li><a href="/pub/2003/01/">January 2003 (8)</a></li>
        
    
        
            <li><a href="/pub/2002/12/">December 2002 (5)</a></li>
        
    
        
            <li><a href="/pub/2002/11/">November 2002 (9)</a></li>
        
    
        
            <li><a href="/pub/2002/10/">October 2002 (7)</a></li>
        
    
        
            <li><a href="/pub/2002/09/">September 2002 (11)</a></li>
        
    
        
            <li><a href="/pub/2002/08/">August 2002 (8)</a></li>
        
    
        
            <li><a href="/pub/2002/07/">July 2002 (8)</a></li>
        
    
        
            <li><a href="/pub/2002/06/">June 2002 (4)</a></li>
        
    
        
            <li><a href="/pub/2002/05/">May 2002 (6)</a></li>
        
    
        
            <li><a href="/pub/2002/04/">April 2002 (6)</a></li>
        
    
        
            <li><a href="/pub/2002/03/">March 2002 (7)</a></li>
        
    
        
            <li><a href="/pub/2002/02/">February 2002 (5)</a></li>
        
    
        
            <li><a href="/pub/2002/01/">January 2002 (8)</a></li>
        
    
        
            <li><a href="/pub/2001/12/">December 2001 (7)</a></li>
        
    
        
            <li><a href="/pub/2001/11/">November 2001 (5)</a></li>
        
    
        
            <li><a href="/pub/2001/10/">October 2001 (9)</a></li>
        
    
        
            <li><a href="/pub/2001/09/">September 2001 (7)</a></li>
        
    
        
            <li><a href="/pub/2001/08/">August 2001 (13)</a></li>
        
    
        
            <li><a href="/pub/2001/07/">July 2001 (8)</a></li>
        
    
        
            <li><a href="/pub/2001/06/">June 2001 (13)</a></li>
        
    
        
            <li><a href="/pub/2001/05/">May 2001 (11)</a></li>
        
    
        
            <li><a href="/pub/2001/04/">April 2001 (9)</a></li>
        
    
        
            <li><a href="/pub/2001/03/">March 2001 (8)</a></li>
        
    
        
            <li><a href="/pub/2001/02/">February 2001 (8)</a></li>
        
    
        
            <li><a href="/pub/2001/01/">January 2001 (8)</a></li>
        
    
        
            <li><a href="/pub/2000/12/">December 2000 (6)</a></li>
        
    
        
            <li><a href="/pub/2000/11/">November 2000 (10)</a></li>
        
    
        
            <li><a href="/pub/2000/10/">October 2000 (10)</a></li>
        
    
        
            <li><a href="/pub/2000/09/">September 2000 (2)</a></li>
        
    
        
            <li><a href="/pub/2000/08/">August 2000 (2)</a></li>
        
    
        
            <li><a href="/pub/2000/07/">July 2000 (5)</a></li>
        
    
        
            <li><a href="/pub/2000/06/">June 2000 (7)</a></li>
        
    
        
            <li><a href="/pub/2000/05/">May 2000 (7)</a></li>
        
    
        
            <li><a href="/pub/2000/04/">April 2000 (3)</a></li>
        
    
        
            <li><a href="/pub/2000/03/">March 2000 (2)</a></li>
        
    
        
            <li><a href="/pub/2000/02/">February 2000 (2)</a></li>
        
    
        
            <li><a href="/pub/2000/01/">January 2000 (2)</a></li>
        
    
        
            <li><a href="/pub/1999/12/">December 1999 (6)</a></li>
        
    
        
            <li><a href="/pub/1999/11/">November 1999 (6)</a></li>
        
    
        
            <li><a href="/pub/1999/10/">October 1999 (5)</a></li>
        
    
        
            <li><a href="/pub/1999/09/">September 1999 (4)</a></li>
        
    
        
            <li><a href="/pub/1999/08/">August 1999 (3)</a></li>
        
    
        
            <li><a href="/pub/1999/07/">July 1999 (2)</a></li>
        
    
        
            <li><a href="/pub/1999/06/">June 1999 (3)</a></li>
        
    
        
            <li><a href="/pub/1999/04/">April 1999 (1)</a></li>
        
    
        
            <li><a href="/pub/1999/03/">March 1999 (1)</a></li>
        
    
        
            <li><a href="/pub/1999/01/">January 1999 (1)</a></li>
        
    
        
            <li><a href="/pub/1998/12/">December 1998 (1)</a></li>
        
    
        
            <li><a href="/pub/1998/11/">November 1998 (1)</a></li>
        
    
        
            <li><a href="/pub/1998/07/">July 1998 (2)</a></li>
        
    
        
            <li><a href="/pub/1998/06/">June 1998 (1)</a></li>
        
    
        
            <li><a href="/pub/1998/03/">March 1998 (1)</a></li>
        
        </ul>
    </div>
</div>
        
    

<div class="widget-powered widget">
    <div class="widget-content">
        <a href="http://www.movabletype.com/"><img src="/mt-static/images/bug-pbmt-white.png" alt="Powered by Movable Type 5.13-en" width="120" height="75" /></a>
    </div>
</div>



    </div>
</div>






                </div>
            </div>


            <div id="footer">
    <div id="footer-inner">
        <div id="footer-content">
            <div class="widget-powered widget">
                <div class="widget-content">
                    Powered by <a href="http://www.movabletype.com/" rel="generator">Movable Type Pro</a>
                </div>
            </div>

            <div class="widget-creative-commons widget">
                <div class="widget-content">
                    This blog is licensed under a <a href="http://creativecommons.org/licenses/by-nc-nd/3.0/">Creative Commons License</a>.
                </div>
            </div>

        </div>
    </div>
</div>



        </div>
    </div>
</body>
</html>
