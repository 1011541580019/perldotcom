</P>

<P>


<!-- This week on perl5-porters (28 Nov--03 Dec 2000) -->

<br />
<!::field::date::><br />
<ul>
  <li><a href="#Notes">Notes</a>
  <li><a href="#Tests">Tests</a>
  <li><a href="#Charnames">Charnames</a>
  <li><a href="#Regular_expression_bug">Regular Expression Bug</a>
  <li><a href="#xsubpp">xsubpp</a>
  <li><a href="#perlipc_examples_buggy">Perlipc Examples Buggy</a>
  <li><a href="#PerlIO_news">PerlIO news</a>
  <li><a href="#Dodgy_function_names">Dodgy Function Names</a>
  <li><a href="#Lvalue_subs">Lvalue Subs</a>
  <li><a href="#Various">Various</a>
</ul>


      <H3><a name="Notes">Notes</a></H3>

</P>

<P>

You can subscribe to an e-mail version of this summary by sending an
empty message to 
<a href="mailto:p5p-digest-subscribe@plover.com"><tt>p5p-digest-subscribe@plover.com</tt>.</a></P>

<P>
Please send corrections and additions to 
<CODE>simon@cozens.net</CODE>.

<H3><a name="Tests">Tests</a></H3>

</P>

<P>

I opted not to mention this last week, but Casey Tweten pointed out that
it was quite important for module authors: regression tests. You write
regression tests, right? Of course, you do. The problem is that there are
umpteen gazillion ways to write regression tests, which makes it
horrible to debug them and find out what's really happening when a test
fails. There's a core module called 
<CODE>Test</CODE> that gives a neat framework for writing tests. There was some
noise on perl5-porters to the effect that people wanted the core
regression tests to use 
<CODE>Test</CODE>, but the counter-argument was that the core tests should be kept as
free from outside interference as possible - the 
<CODE>Test</CODE> module may contain some constructs that the core tests are trying to
test. It's no good loading a module to help with your tests if one of
your tests is whether you can load a module or not! Nevertheless, it
would be nice if some of the more advanced tests were converted to the  
<CODE>Test</CODE> interface. (That was a hint, by the way, for anyone who fancies
doing that.)
</P>

<P>
The real outcome of this was a patch by Casey to convert the standard
module template generated by 
<CODE>h2xs</CODE> to use the 
<CODE>Test</CODE> module, and to encourage (i.e. force) module authors to use it. So, module
authors, if you don't know about 
<CODE>Test.pm</CODE>, you will soon.
<H3><a name="Charnames">Charnames</a></H3>

</P>

<P>

<a href="http://www.xray.mpe.mpg.de/mailing-lists/perl5-porters/2000-12/msg01394.html">This patch</a> from Ilya took me a while to get my head around, but now I have and I
think it's beautiful. When doing Unicode testing and entering Unicode
data without a Unicode editor, we have to resort to things like
</P>

</P><PRE>
    $x =
    "\x{395}\x{3CD}\x{3B1}\x{3B3}\x{3B3}\x{3B5}\x{3BB}\x{3CA}\x{3B1}";
</PRE>

<P>
or
</P>

</P><PRE>
    $x =
    v917.973.945.947.947.949.955.970.945;
</PRE>

<P>
or even
</P>

</P><PRE>
    $x = 
    "\N{GREEK CAPITAL LETTER EPSILON}\N{GREEK SMALL LETTER UPSILON}...";
</PRE>

<P>
This is a nightmare.
</P>

<P>
Ilya's solution allows you to enter Unicode texts in foreign languages
as Latin transliterations. He gives a module that provides Russian
transliterations, so with Ilya's module you can now do:
</P>

</P><PRE>
    use Charnames qw(cyrillic);
    $x = "\N{Il'ya Zakharevich}";
</PRE>

<P>
and Perl will do the right thing. The suggestion is to have a few
transliteration modules in the core for testing and to have
less-commonly used ones on CPAN. 
</P>

<P>
However, in many non-Latin languages, transliteration to the Latin
alphabet is vague at best, and there are usually several different
methods of doing so; worse, the mappings are sometimes nonreversable
and/or non-one-to-one. Ilya's module for Russian is neat, but
doesn't cover everything.
<H3><a name="Regular_expression_bug">Regular Expression Bug</a></H3>

</P>

<P>

Jarkko has been turning up all sorts of wonders with his experiments in
UTF8 regular-expression land. This time, he has found that
</P>

</P><PRE>
    use utf8; @a=("b" =~ /(.)/)
</PRE>

<P>
will cause a segmentation fault, which is horrid. Worse, this only seems
to fail on 64-bit platforms, regardless of the setting of 
<CODE>use64bitint</CODE>, which suggested some hidden assumption. Eventually, it was traced to a
careless read in 
<CODE>sv_utf8_downgrade</CODE>; Jarkko says:
</P>

</P>
<blockquote>
        Why the different platforms behave so differently (core dump vs.
        no core dump) on this bug is a but of a mystery, but if I had to
        guess I would mumble something like 'alignment.'
</blockquote>

<P>
This is why being the Configure pumpkin is such a demanding job.
</P>

<P>
Another core dump came from
</P>

</P><PRE>
    use utf8; "," =~ /([^,]*,)*/
</PRE>

<P>
and another from
</P>

</P><PRE>
    use utf8; 
    $x = $^R = 67;
    "foot" =~ /foo(?{ $^R + 12 })((?{ +$x = 12; $^R + 17 })[xy])?/;
</PRE>

<P>
which was traced to a failure to save and restore the parantheses count.
Again, the symptoms were confusingly different on different machines.
<H3><a name="xsubpp">xsubpp</a></H3>

</P>

<P>

Ilya produced a patch for 
<CODE>xsubpp</CODE> that allows the 
<CODE>OUT</CODE> and 
<CODE>IN_OUT</CODE> keywords; this is in addition to the old 
<CODE>IN_OUTLIST</CODE> and 
<CODE>OUTLIST</CODE> keywords. 
</P>

<P>
These are somewhat confusing, but here's my understanding of what they
do: A parameter in a C function marked 
<CODE>OUTLIST</CODE> will have its value at the end of the function added to the list of return 
values to Perl. A parameter labeled 
<CODE>IN_OUT</CODE> will be read from a Perl variable
at the beginning of the C function, and the value of the C variable at the
end of the C function will be put back into the Perl variable. In effect, 
<CODE>IN_OUT</CODE> gives you a pointer to write through, which is &quot;tied&quot; to a Perl variable. 
[IN_OUTLIST] does the same, but instead of writing the value back to the
Perl variable, it goes onto the list of return values. 
</P>

<P>
An 
<CODE>OUT</CODE> value is set to the return value of the C function - I think.
<a href="http://www.xray.mpe.mpg.de/mailing-lists/perl5-porters/2000-12/msg01402.html">Decide for yourself.</a></P>

<P>

<H3><a name="perlipc_examples_buggy">Perlipc Examples Buggy</a></H3>

</P>

<P>
Nicholas Clark gave what I shall call an &quot;impassioned appeal&quot; about the
state of the 
<CODE>perlipc</CODE> documentation; some of the examples didn't even compile, much less do
 what they claimed to do. This also turned up a problem with 
<CODE>Net::hostent</CODE>, which was particularly embarrassing since 
<CODE>Net::hostent</CODE> didn't have a regression test. Nicholas wiped up the worst of the 
<CODE>perlipc</CODE> bugs, and provided a basic regression test, which Robert Spier 
expanded. As Jarkko pointed out, writing a portable test for it is
tricky, but any test is better than none ... .
</P>

<P>
(Hey, maybe someone would like to try writing a program that
automatically extracts example code from the documentation and makes
sure it compiles?)
<H3><a name="PerlIO_news">PerlIO news</a></H3>

</P>

<P>

Using my magic crystal ball, I found that this week saw 500 patches to
the Perl repository. Naturally, the bulk of them - a massive 400 - were
the development main line, 32 were Sarathy integrating bunches of
patches into 5.6.1-to-be, but the remaining 67 were Nick beavering away on
the PerlIO branch. This should remind you that most of the PerlIO
improvements happen without much advertisement, and it's easy to be
unaware of exactly how much work is going on there. 
</P>

<P>
Here's what Nick says about how PerlIO is going:
<BLOCKQUOTE><CODE>-Duseperlio</CODE> now works as a replacement for stdio on UNIX platforms. As of last weekend, it was also working in &quot;same functions as before&quot;
   mode
   on Win32 in Win32's &quot;simple&quot; configuration.
   There has been some progress, but not success, in getting OS/2 in
   line.
   (Nothing on VMS yet.)
</P>

<P>
   This week's target is the 
<CODE>PERL_IMPLICIT_SYS</CODE> scheme on Win32 that is needed for 
<CODE>fork()</CODE> emulation. Once that is built, the plan is to
   replace low-level pseudo-unix 
<CODE>read()</CODE> on Win32 with our own version.</P>

<P>

   The other area of work is to turn on use of PerlIO to allow
   files to be read/written as utf8 under programmer control.
</P>

<P>
   Once that works, then we hook PerlIO to Encode - and we are &quot;done&quot; ;-)
   (This is actually a bit messy right now as PerlIO is deep under the
   core, and Encode.pm is an external XS module.)
</BLOCKQUOTE></P>

<P>

Since Nick is going to be allowing layers to be accessible under
programmer control, we need to know what layers ought to do, and this
was Nick's question: &quot;So would anyone care to remind me what the Unicode
issues were that we want to solve?&quot;
</P>

<P>
Briefly, we want to be able to read in UTF8-encoded text into
UTF8-encoded SVs, and have the same output. One of the other uses of layers
would be the CRLF translation magic used on DOS-derived systems and to
replace the source filter mechanism. 
<H3><a name="Dodgy_function_names">Dodgy Function Names</a></H3>

</P>

<P>

This causes a syntax error:
</P>

</P><PRE>
    sub f {}
    $x-f($y);
</PRE>

<P>
This is because Perl assumes that 
<CODE>-f</CODE> is a file-test operator, and wonders what it's doing next to a
variable with no binary operator in the middle. Some people, including
Jarkko, thought that was silly; if I define a sub 
<CODE>f</CODE>, Perl should know that I'm trying to call that subroutine. 
</P>

<P>
This naturally applies not just for the file tests, but any other
operators that look like functions, such as 
<CODE>y</CODE> and 
<CODE>s</CODE>. Several solutions were proposed, such as forcing Perl to use the
subroutine, or outlawing subroutines with &quot;reserved&quot; names. In the end, 
Jarkko produced a patch for the file tests that spits out a warning
in the above case - I think the 
<CODE>y</CODE>,  
<CODE>m</CODE>, and other cases are still on the loose. 
<a href="http://www.xray.mpe.mpg.de/mailing-lists/perl5-porters/2000-12/msg01574.html">The whole thread </a>
 (36 messages) is worth reading, if only so you can get an idea of what nefarious things
Perl porters get up to when syntax goes bad.
<H3><a name="Lvalue_subs">Lvalue subs</a></H3>

</P>

<P>

Casey asked for more useful lvalue subroutines. At the moment, you can
say things like:
</P>

<PRE>
  package Person;
  sub new { bless { name =&gt; $name }, shift }
  sub name : lvalue { $_[0]-&gt;{name} }

  package main;

  my $p    = Person-&gt;new;
  $p-&gt;name = &quot;casey&quot;;
  print $p-&gt;name . &quot;\n&quot;;
</PRE>

<P>
Note that 
<CODE>$p->name</CODE> on the left-hand side of that assignment is actually a method call returning
an lvalue. Cool, huh?
</P>

<P>
Casey mentioned that he'd really like some way of getting at the
right-hand side of the assignment as well, in order to do things like 
implementing 
<CODE>substr</CODE> in pure Perl. Rick Delaney suggested that you could return a tied lvalue, 
but Casey replied that that was slow; the alternative was yet another 
global. Piers appealed for a faster tie system, which is fine, but someone has
to design it, code it and make it better than the current
one while doing all the same things.
</P>

<P>
Yitzchak pointed out that there's more to lvalues than just the assignment
context, and having a way to get at the rvalue would probably break in 
nonassignment cases. 
<H3><a name="Various">Various</a></H3>

</P>

<P>

Yes, floating-point numbers are imprecise. We know. However, thanks to Nick
Clarke, there's now far fewer of them.
</P>

<P>
Until next week, I remain, your humble and obedient servant,
</P>

<hr>

<a href="mailto:simon@brecon.co.uk">Simon Cozens</a>
