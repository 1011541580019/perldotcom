<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" id="sixapart-standard">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="generator" content="Movable Type Pro 5.13-en" />
<link rel="stylesheet" href="/pub/styles.css" type="text/css" />
<link rel="start" href="/pub/" title="Home" />
<link rel="alternate" type="application/atom+xml" title="Recent Entries" href="/pub/atom.xml" />
<script type="text/javascript" src="/pub/mt.js"></script>
<!--
<rdf:RDF xmlns="http://web.resource.org/cc/"
         xmlns:dc="http://purl.org/dc/elements/1.1/"
         xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#">
<Work rdf:about="/pub/2000/04/raceinfo.html">
<dc:title>Program Repair Shop and Red Flags</dc:title>
<dc:description>What&apos;s wrong with this picture? -&gt; What&apos;s wrong with this picture? Reading the Input Computing Average and Total Times Sort Order Printing the Report Red Flags Get Rid of Array Size Variables Use Compound Data Structures Instead of Variable Families...</dc:description>
<dc:creator>Mark-Jason Dominus</dc:creator>
<dc:date>2000-05-02T00:00:00-08:00</dc:date>
<license rdf:resource="http://creativecommons.org/licenses/by-nc-nd/3.0/" />
</Work>
<License rdf:about="http://creativecommons.org/licenses/by-nc-nd/3.0/">
</License>
</rdf:RDF>
-->

<script type="text/javascript">

 var _gaq = _gaq || [];
 _gaq.push(['_setAccount', 'UA-50555-22']);
 _gaq.push(['_trackPageview']);

 (function() {
   var ga = document.createElement('script'); ga.type =
   'text/javascript'; ga.async = true;
   ga.src = ('https:' == document.location.protocol ? 'https://ssl' :
   'http://www') + '.google-analytics.com/ga.js';
   var s = document.getElementsByTagName('script')[0];
   s.parentNode.insertBefore(ga, s);
 })();

</script>
<script type='text/javascript' src='http://partner.googleadservices.com/gampad/google_service.js'></script>
<script type='text/javascript'>
GS_googleAddAdSenseService("ca-pub-4136420132070439");
GS_googleEnableAllServices();
</script>
<script type='text/javascript'>
GA_googleAddSlot("ca-pub-4136420132070439", "Perl_728x90");
</script>
<script type='text/javascript'>GA_googleFetchAds();</script>
    
    <link rel="prev bookmark" href="/pub/2000/04/p5pdigest/THISWEEK-20000430.html" title="This Week on p5p 2000/04/30" />
    <link rel="next bookmark" href="/pub/2000/05/p5pdigest/THISWEEK-20000507.html" title="This Week on p5p 2000/05/07" />
    
    
    <title>Program Repair Shop and Red Flags - Perl.com</title>
</head>
<body id="perl-com" class="mt-entry-archive layout-wt">
    <div id="container">
        <div id="container-inner">


            <div id="header">
    <div id="header-inner">
        <div id="header-content">
        <span id="top_advert"> 
<!-- Put any landscape advert in here -->
<!-- Perl_728x90 -->
<script type='text/javascript'>
GA_googleFillSlot("Perl_728x90");
</script>
        </span> 



            <div id="header-name"><a href="/pub/" accesskey="1">Perl.com</a></div>
            <div id="header-description">news and views of the Perl programming language</div>




        </div>
    </div>
</div>



            <div id="content">
                <div id="content-inner">


                    <div id="alpha">
                        <div id="alpha-inner">


                            <div id="entry-1664" class="entry-asset asset hentry">
                                <div class="asset-header">
                                    <h1 id="page-title" class="asset-name entry-title">Program Repair Shop and Red Flags</h1>
                                    <div class="asset-meta">
                                        <span class="byline">

                                            By <span class="vcard author">Mark-Jason Dominus</span> on <abbr class="published" title="2000-05-02T00:00:00-08:00">May  2, 2000 12:00 AM</abbr>

                                        </span>


                                    </div>
                                </div>
                                <div class="asset-content entry-content">

                                    <div class="asset-body">
                                        <!-- <A NAME="What_s_wrong_with_this_picture_">What's wrong with this picture?</A> -->

<br />
<!-- INDEX BEGIN -->
<UL>

 <LI><A HREF="#What_s_wrong_with_this_picture_">What's wrong with this picture?</A>
 <UL>

  <LI><A HREF="#Reading_the_Input">Reading the Input</A>
  <LI><A HREF="#Computing_Average_and_Total_Time">Computing Average and Total Times</A>
  <LI><A HREF="#Sort_Order">Sort Order</A>
  <LI><A HREF="#Printing_the_Report">Printing the Report</A>
 </UL>

 <LI><A HREF="#Red_Flags">Red Flags</A>
 <UL>

  <LI><A HREF="#Get_Rid_of_Array_Size_Variables">Get Rid of Array Size Variables</A>
  <LI><A HREF="#Use_Compound_Data_Structures_Ins">Use Compound Data Structures Instead of Variable Families</A>
  <LI><A HREF="#Use_C_foreach_to_Loop_Over_Arra">Use <code>foreach</code> to Loop Over Arrays</A>
 </UL>

</UL>
<!-- INDEX END -->

<P>
Someone recently asked me to take a look at his report-generating program
because he wasn't able to get the final report sorted the way he wanted.

<P>
The program turned out to require only a minor change to get the report in
order, but it also turned out to be a trove of common mistakes--which is
wonderful, because I can use one program to show how to identify and fix
all the common mistakes at once!

<P>
First I'll show the program, and then I'll show how to make it better.
Here's the original. (Note: Lines of code may be broken for display purposes.)

<P>
<PRE>
     1  #!/usr/bin/perl
     2  use Getopt::Std;
     3  getopt('dV');
     4  $xferlog=&quot;./xferlog&quot;;
     5  $\ = &quot;\n&quot;;
     6  $i=0;
     7  open XFERLOG, $xferlog or die &quot;Cant't find file $xferlog&quot;;
     8  
     9  foreach $line (&lt;XFERLOG&gt;) {
    10        chomp($line);
    11        if (( $line =~ /$opt_d/i) &amp;&amp; ( $line !~ /_ o r/)) 
    12           {
    13           ($Fld1,$Fld2,$Fld3,$Fld4,$Fld5,$Fld6,$Fld7,$Fld8,
               $Fld9,$Fld10,$Fld11,$Fld12,$Fld13,$Fld14,$Fld15) = split(' ',$line);
 
    14            $uplist[$i] = join ' ',$Fld6, $Fld8, $Fld9, $Fld14, $Fld15;
    15            $time[$i]=$Fld6; $size[$i]=$Fld8; $file[$i]=$Fld9; 
               $user[$i]=$Fld14; $group[$i]=$Fld15;
      
    16            $username= join '@', $user[$i], $group[$i];
    17            push @{$table{$username}}, $uplist[$i];
    18            $i++;     
    19      }
    20  }
    21  close XFERLOG;
    22  
    23  undef %saw;
    24  # @newuser = grep(!$saw{$_}++, @user);
    25  $j=0;
    26  foreach  $username ( sort keys %table )
    27          {
    28          my @mylist = @{$table{$username}};
    29          $m=0;
    30          $totalsize=0;
    31          $totaltime=0;
    32          $gtotal=0;
    33          $x=0;
    34          $x=@mylist;
    35          for ($m = 0 ; $m &lt; ($x); $m++)
    36          {
    37                  ( $seconds, $size, $file, $user, $group) = split(' ', $mylist[$m]);
    38                  $totaltime = ($totaltime + $seconds);
    39                  $totalsize = ($totalsize + $size);
    40          }
    41          if ($totaltime==0) { $totaltime=1; }
    42          if ($totalsize==0) { $totalsize=1; }
    43          $avgtr = (($totalsize/$totaltime)/1024);
    44          $gtotal=($totalsize+$gtotal);
    45          $finale[$j]= join ' ', ($totalsize/(1024*1024)), $username, ($x), $totaltime, $avgtr;
    46  #       print $finale[$j];
    47          $j++;
    48  }
    49  @realfinal =  sort @finale;
    50  #print @finale;
    51  $p=0;
    52  $w=0;
    53  $w=@realfinal;
    54  #print $w;
    55  for ($p=($w-1) ; $p&gt;=0; $p--)
    56  {
    57          ($Size, $User, $Files, $Time, $AvgSpeed)= split &quot; &quot;, $realfinal[$p];
    58          $position= ($w-$p);
    59          $percent=(($Size/($gtotal/(1024*1024)))*100);
    60          printf (&quot;$position. $User $Files files &quot;);
    61          printf(&quot;%.2fMB&quot;, $Size) ;
    62          printf &quot; $Time(s) &quot;;
    63          printf (&quot;%.2f% &quot;, $percent);
    64          printf(&quot;%.2fK/s&quot;, $AvgSpeed);
    65          print &quot; &quot;;
    66  }
    67          
</PRE>
<P>
Let's start at the top, with the argument and file handling.

<P>
<PRE>     1  #!/usr/bin/perl
     2  use Getopt::Std;
     3  getopt('dV');
     4  $xferlog=&quot;./xferlog&quot;;
     5  $\ = &quot;\n&quot;;
     6  $i=0;
     7  open XFERLOG, $xferlog or die &quot;Cant't find file $xferlog&quot;;
     8  
     9  foreach $line (&lt;XFERLOG&gt;) {
        ...
    20  }
    21  close XFERLOG;
</PRE>
<P>
The name of the input file is hardwired on line 4. Getting the filename
from the command line is more flexible. We can leave the old filename in
place as a default, retaining compatibility with the original version. I've
also added error handling to the <CODE>getopt</CODE>
argument parsing.

<P>
<PRE> 
       getopt('dV') or die &quot;Usage: $0 [-d] [-V] [filename]\n&quot;;
        @ARGV = ('./xferlog') unless @ARGV;
        while (&lt;&gt;) {
          ...
        }
</PRE>        

<CODE>getopt</CODE> removes the options from
<CODE>@ARGV</CODE>, leaving only the filenames,
if any.  If there weren't any, we put the default filename,
<CODE>/.xferlog</CODE>, into <CODE>@ARGV</CODE> as if the user 
had supplied it themselves.
Since the <code>&lt;&gt;</CODE> operator reads from the files named in 
<CODE>@ARGV</CODE>, it
will read from <CODE>./xferlog</CODE> if no file was specified on the command
line.  Using <CODE>&lt;&gt;</CODE> handles <CODE>open</CODE> errors for us automatically,
and we can omit the <CODE>close</CODE> call because it's already taken care of
for us.  
<P>
Line 5 is superfluous, because <CODE>$\</CODE> already defaults to <CODE>"\n"</CODE>. Line 6 is
superfluous, since <CODE>$i</CODE> would be implicitly initialized to 0,
but it won't matter because we're going to get rid of <CODE>$i</CODE>
anyway.

<P>
I replaced the <CODE>foreach</CODE> loop with a <CODE>while</CODE> loop. The <CODE>foreach</CODE>
loaded the entire file into memory at once, then iterated over the list of
lines.  <CODE>while</CODE> reads one line at a time into <CODE>$_</CODE>, discarding each line after it has been examined. If the input file is
large, this will save a huge amount of memory. If available memory is
small, the original program might have run very slowly because of thrashing
problems; the new program is unlikely to have the same trouble, and might
run many times faster as a result.

<P>
<HR>
<!-- <A NAME="Reading_the_Input">Reading the Input</A> -->
<P>
<PRE>
     9  foreach $line (&lt;XFERLOG&gt;) {
    10        chomp($line);
    11        if (( $line =~ /$opt_d/i) &amp;&amp; ( $line !~ /_ o r/)) 
    12           {
    13           ($Fld1,$Fld2,$Fld3,$Fld4,$Fld5,$Fld6,$Fld7,$Fld8,
               $Fld9,$Fld10,$Fld11,$Fld12,$Fld13,$Fld14,$Fld15) = split(' ',$line);
      
    14            $uplist[$i] = join ' ',$Fld6, $Fld8, $Fld9, $Fld14, $Fld15;
    15            $time[$i]=$Fld6; $size[$i]=$Fld8; $file[$i]=$Fld9; 
               $user[$i]=$Fld14; $group[$i]=$Fld15;
      
    16            $username= join '@', $user[$i], $group[$i];
    17            push @{$table{$username}}, $uplist[$i];
    18            $i++;     
    19      }
    20  }
</PRE>
<P>
Here's my replacement:

<P>
<PRE>        while (&lt;&gt;) {
          chomp;
          if (/$opt_d/oi &amp;&amp;  ! /_ o r/) {
            my @Fld = split;
            my $uplist = {time =&gt; $Fld[5],      size =&gt; $Fld[7],
                          file =&gt; $Fld[8],      user =&gt; $Fld[13],
                          group =&gt; $Fld[14],
                         };
            my $username = &quot;$Fld[13]\@$Fld[14]&quot;;
            push @{$table{$username}}, $uplist;
          }
        }
</PRE>
<P>
Because the current line is in <CODE>$_</CODE> now instead of <CODE>$line</CODE>, we can
use the argumentless versions of <CODE>chomp</CODE> and <CODE>split</CODE> and the unbound version of the pattern match operators, which apply to
<CODE>$_</CODE> by default. I added the <CODE>/o</CODE> option on the first pattern match to tell Perl that <CODE>$opt_d</CODE>
will not change over the lifetime of the program.

<P>
Any time you have a series of variables named <code>$Fld1</code>, <code>$Fld2</code>, etc., it means
you made a mistake, because they should have been in an array. I've
replaced the <code>$Fld1</code>, <code>$Fld2</code>, ... family with a single array, <code>@Fld</code>.

<P>
<CODE>$uplist</CODE> was a problem before. It's a large string continaing
several fields. Later on, the program would have had to split this string
to get at the various fields; this is a waste of time because we have the
fields already split up right here and there's no point in joining them
just to split them up again later. Instead of turning the relevant fields
into a string, I've put them into an anonymous hash, indexed by key, so
that the filename is in $uplist-&gt;{file} instead of the third section of
a whitespace separated string.

<P>
This way of doing things is not only faster, it's more robust. If the input
file format changes so that a filename might contain space characters, we
only need to change the initial <CODE>split</CODE> that parses the input data itself. The original version of the program
would have needed to have the <CODE>join</CODE> changed also, as well as the later <CODE>split</CODE>
the re-separated the data. Storing the fields in a hash eliminates this
problem entirely.

<P>
I also eliminated the superfluous <code>@time</code>, 
<code>@size</code>, <code>@user</code>, <code>@group</code>, and
<CODE>@uplist</CODE> arrays. They were never used. Packaging all the
relevant data into a single hash obviates any possible use of these arrays
anyway. Because all the arrays have gone away, we no longer need the index
variable <code>$i</code>. Such a variable, which exists only to allow data to be added
to the end of an array, is rarely needed in Perl. It is almost always
preferable to use <CODE>push</CODE>. The <CODE>push</CODE> line itself is essentially the same.

<P>
<HR>
<!-- <A NAME="Computing_Average_and_Total_Time">Computing Average and Total Times</A> -->
<P>
This next section is way too long:

<P>
<PRE>
    23  undef %saw;
    24  # @newuser = grep(!$saw{$_}++, @user);
    25  $j=0;
    26  foreach  $username ( sort keys %table )
    27          {
    28          my @mylist = @{$table{$username}};
    29          $m=0;
    30          $totalsize=0;
    31          $totaltime=0;
    32          $gtotal=0;
    33          $x=0;
    34          $x=@mylist;
    35          for ($m = 0 ; $m &lt; ($x); $m++)
    36          {
    37                  ( $seconds, $size, $file, $user, $group) = split(' ', $mylist[$m]);
    38                  $totaltime = ($totaltime + $seconds);
    39                  $totalsize = ($totalsize + $size);
    40          }
    41          if ($totaltime==0) { $totaltime=1; }
    42          if ($totalsize==0) { $totalsize=1; }
    43          $avgtr = (($totalsize/$totaltime)/1024);
    44          $gtotal=($totalsize+$gtotal);
    45          $finale[$j]= join ' ', ($totalsize/(1024*1024)), $username, ($x), $totaltime, $avgtr;
    46  #       print $finale[$j];
    47          $j++;
    48  }
</PRE>
<P>
26 lines is too much for one block. A 26-line block should be rewritten if
possible, and if not, its guts should be scooped out and made into a
subroutine.

<P>
We can reduce this to about fifteen lines, so I won't use a subroutine
here. A lot of that reduction is simply elimination of unnecessary code. We
can scrap lines 23 and 24, which are never used. Line 25 is an unnecessary
initialization of <CODE>$j</CODE> whose only purpose is to track the length
of the <CODE>@finale</CODE> array; we can eliminate <code>$j</code>
entirely by changing this:

<P>
<PRE>    45          $finale[$j]= join ' ', ($totalsize/(1024*1024)), $username, ($x), $totaltime, $avgtr;
    46  #       print $finale[$j];
    47          $j++;
</PRE>
<P>
to say this instead:

<P>
<PRE>        push @finale, join ' ', ($totalsize/(1024*1024)), $username, ($x), $totaltime, $avgtr;
        # print $finale[-1];
</PRE>
<P>
Now let's work on that inner loop:

<P>
<PRE>    35          for ($m = 0 ; $m &lt; ($x); $m++)
    36          {
    37                  ( $seconds, $size, $file, $user, $group) = split(' ', $mylist[$m]);
    38                  $totaltime = ($totaltime + $seconds);
    39                  $totalsize = ($totalsize + $size);
    40          }
</PRE>
<P>
Any time you have a C-like <CODE>for</CODE> loop that loops over the indices of an array, you're probably making a
mistake. Perl has a <CODE>foreach</CODE>
construction that iterates over an array in a much simpler way:

<P>
<PRE>        for $item (@{$table{$username}}) {
          $totaltime += $item-&gt;{time};
          $totalsize += $item-&gt;{size};
        }
</PRE>
<P>
Here we reap the benefit of the anonymous hash introduced above. To get the
time and size we need only extract the hash values <CODE>time</CODE> and
<CODE>size</CODE>. In the original code, we had to do another <CODE>split</CODE>.

<P>
This allows us to eliminate the superfluous variables <code>$m</code>, <CODE>$x</CODE>
and <code>@mylist</code>, so we can remove lines 28, 29, 33, and 34. We've also used the
<code>+=</code> operator here to save extra mentions of the variable names on the
right-hand side of the <code>=</code>.

<P>
The modified code now looks like:

<P>
<PRE>
        foreach  $username ( sort keys %table ) {
          $totalsize=0;
          $totaltime=0;
          $gtotal=0;
          for $item (@{$table{$username}}) {
            $totaltime += $item-&gt;{time};
            $totalsize += $item-&gt;{size};
          }
          if ($totaltime==0) { $totaltime=1; }
          if ($totalsize==0) { $totalsize=1; }
          $avgtr = (($totalsize/$totaltime)/1024);
          $gtotal=($totalsize+$gtotal);

          push @finale, join ' ', ($totalsize/(1024*1024)), $username, ($x), $totaltime, $avgtr;
          #     print $finale[-1];
        }
</PRE>
<P>
This is already only half as large. But we can make it smaller and cleaner
yet. <CODE>$totalsize</CODE> and <CODE>$totaltime</CODE> are related, so
they should go on the same line. <CODE>$gtotal</CODE> is incorrectly set to
0 here. It is a grand total size of all the files downloaded, and any
initialization of it should be <EM>outside</EM> the loop. The check for <CODE>$totaltime==0</CODE>
is to prevent a divide-by-zero error in the computation of <code>$avgtr</code>, but no
such computation is performed for <code>$totalsize</code>, so the corresponding check is
wasted and should be eliminated:

<P>
<PRE>
        my  $gtotal=0;

        foreach  $username ( sort keys %table ) {
          my ($totalsize, $totaltime) = (0, 0);
          for $item (@{$table{$username}}) {
            $totaltime += $item-&gt;{time};
            $totalsize += $item-&gt;{size};
          }
          if ($totaltime==0) { $totaltime=1; }
          $avgtr = ($totalsize/$totaltime)/1024;
          $gtotal += $totalsize;
          push @finale, join ' ', ($totalsize/(1024*1024)), $username, ($x), $totaltime, $avgtr;
          #     print $finale[-1];
        }
</PRE>
<P>
For the computation of <code>$avgtr</code>, we can do better. The previous line has a
special case for when <CODE>$totaltime</CODE> is zero and the average is
undefined. In this case, <CODE>$avgtr</CODE> is set to an arbitrary and
bizarre value; if we sort by <CODE>$avgtr</CODE> later, these arbitrary
values will appear scattered throughout the rest of the data. It's better
to handle this exceptional condition explicitly, by replacing

<P>
<PRE>
          if ($totaltime==0) { $totaltime=1; }
          $avgtr = ($totalsize/$totaltime)/1024;
</PRE>
<P>
with

<P>
<PRE>
          if ($totaltime==0) { $avgtr = '---' }
          else { $avgtr = ($totalsize/$totaltime)/1024 }
</PRE>
<P>
Finally, the <CODE>join</CODE> here is committing the same error as the one we eliminated before. There's
no point in <CODE>join</CODE>ing when we're just going to have to <CODE>split</CODE> it again later anyway; the data are separate now so we might as well keep
them separate. The solution is similar; instead of joining the five data
items into a string, we parcel them into an anonymous hash so that we can
extract them by name when we need to. The final version of the loop looks
like this:

<P>
<PRE>
        foreach  $username ( sort keys %table ) {
          my ($totalsize, $totaltime) = (0, 0);
          for $item (@{$table{$username}}) {
            $totaltime += $item-&gt;{time};
            $totalsize += $item-&gt;{size};
          }

          if ($totaltime==0) { $avgtr = '---' } 
          else { $avgtr = ($totalsize/$totaltime)/1024 }
          $gtotal += $totalsize;

          push @finale, {size =&gt; $totalsize/(1024*1024),
                         username =&gt; $username, 
                         num_items =&gt; scalar @{$table{$username}}, 
                         totaltime =&gt; $totaltime,
                         avgtr =&gt; $avgtr,
                        };
          #     print $finale[-1];
        }
</PRE>
<P>
<HR>
<H2><A NAME="Sort_Order">Sort Order</A></H2>
<P>
Line 49 is the one that I was originally asked to change:

<P>
<PRE>    49  @realfinal =  sort @finale;
</PRE>
<P>
Now that <CODE>@finale</CODE> contains structured records, the change is
straightforward:

<P>
<PRE>        @realfinal = sort {$a-&gt;{size} &lt;=&gt; $b-&gt;{size}} @finale;
</PRE>
<P>
If you want to sort the final report by username instead, it's equally
straightforward: <CODE>@realfinal = sort {$a-&gt;{username}
cmp $b-&gt;{username}} @finale;</code>

<P>
<HR>
<H2><A NAME="Printing_the_Report">Printing the Report</A></H2>
<P>
Now we're into the home stretch:

<P>
<PRE>
    51  $p=0;
    52  $w=0;
    53  $w=@realfinal;
    54  #print $w;
    55  for ($p=($w-1) ; $p&gt;=0; $p--)
    56  {
    57          ($Size, $User, $Files, $Time, $AvgSpeed)= split &quot; &quot;, $realfinal[$p];
    58          $position= ($w-$p);
    59          $percent=(($Size/($gtotal/(1024*1024)))*100);
    60          printf (&quot;$position. $User $Files files &quot;);
    61          printf(&quot;%.2fMB&quot;, $Size) ;
    62          printf &quot; $Time(s) &quot;;
    63          printf (&quot;%.2f% &quot;, $percent);
    64          printf(&quot;%.2fK/s&quot;, $AvgSpeed);
    65          print &quot; &quot;;
    66  }
    67          
</PRE>
<P>
Here we have another C-style <CODE>for</CODE> loop that should be replaced by a simple <CODE>foreach</CODE> loop; this allows us to eliminate <CODE>$p</CODE> and <code>$w</code>. We can loop over
the reversed list if we want, or simply adjust the <CODE>sort</CODE> line above so that the items are sorted into the right (reversed) order to
begin with, which is probably better.

<P>
The percentage here is the only place in the program that we use <code>$gtotal</code>,
which needs to be converted to megabytes to match the <CODE>size</CODE>
fields in <code>@realfinal</code>. We may as well do this conversion up front. Making
these changes, and eliminating the <CODE>split</CODE> because the <CODE>@realfinal</CODE> data is structured, yields:

<P>
<PRE>
        $gtotal /= (1024*1024);  # In megabytes
        #print @finale;
        my $position = 1;
        for $user (@realfinal) {
                printf (&quot;$position. $user-&gt;{username} $user-&gt;{num_items} files &quot;);
                printf(&quot;%.2fMB&quot;, $user-&gt;{size}) ;
                printf &quot; $user-&gt;{totaltime}(s) &quot;;
                printf (&quot;%.2f% &quot;, ($user-&gt;{size}/$gtotal)*100); # percentage
                printf(&quot;%.2fK/s&quot;, $user-&gt;{avgtr});
                print &quot;\n&quot;;
                ++$position;
        }
</PRE>
<P>
It's probably a little cleaner to merge the many <CODE>printf</CODE>s into a single print;
another upside of this is that it's easier to see
what the format of the output will be:

<P>
<PRE>
        $gtotal /= (1024*1024);  # In megabytes
        #print @finale;
        my $position = 1;
        for $user (@realfinal) {
          printf (&quot;%d. %s %s files %.2fMB %.2f%% %.2fK/s\n&quot; , 
            $position, $user-&gt;{username}, $user-&gt;{num_items}        
            $user-&gt;{size}, ($user-&gt;{size}/$gtotal)*100, $user-&gt;{avgtr}
          );
          ++$position;
        }
</PRE>
<P>
That's enough. The new program is 33 lines long, not counting comments,
blank lines, and lines that have only a close brace. The original program
was 51 lines, so we've reduced the length of the program by more than
one-third. The original program had 41 scalar variables, 8 arrays, and 2
hashes, for a total of 51 named variables. The new program has 11 scalars,
3 arrays, and 1 hash, for a total of 14; we have eliminated more than
two-thirds of the variables. 15 of these were the silly <CODE>$Fld3</CODE>
variables, and another 22 weren't.

<P>
<HR>
<H1><A NAME="Red_Flags">Red Flags</A></H1>
<P>
A red flag is a warning sign that something is wrong. When you see a red
flag, you should immediately consider whether you have an opportunity to
make the code cleaner. I liked this program because it raised many red
flags:

<P>
<HR>
<H2><A NAME="Get_Rid_of_Array_Size_Variables">Get Rid of Array Size Variables</A></H2>
<P>
A variable whose only purpose is to track the number of items in an array
is a red flag; it should usually be eliminated. For example:

<P>
<PRE>
        while (...) {
          $array[$n] = SOMETHING;
          ++$n;
        }
</PRE>
<P>
should be replaced with

<P>
<PRE>
        while (...) {
          push @array, SOMETHING;
        }
</PRE>
<P>
eliminating <code>$n</code>.  

<P>
Notice that although the <CODE>$position</CODE> variable in the final
version of the program looks like it might be an index variable, it
actually serves a more important purpose than that: It appears in the final
output as a ranking.

<P>
<HR>
<H2><A NAME="Use_Compound_Data_Structures_Ins">Use Compound Data Structures Instead of Variable Families</A></H2>
<P>
A series of variables named <code>$f1</code>, <code>$f2</code>, etc., should always be replaced with
an array. For example:

<P>
<PRE>    ($Fld1,$Fld2,$Fld3,$Fld4,$Fld5,$Fld6) = split(' ',$line);
</PRE>
<P>
should be replaced with

<P>
<PRE>
    @Fld = split(' ',$line);
</PRE>
<P>
A similar statement can be made about hashes. If you have <CODE>$user_name</code>,
<code>$user_weight</code>, and <code>$user_login_date</code>, consider using one structure called
<CODE>%user</CODE> with keys <CODE>name</CODE>, <CODE>weight</CODE>, and <CODE>login_date</CODE>.

<P>
<HR>
<H2><A NAME="Use_C_foreach_to_Loop_Over_Arra">Use <code>foreach</code> to Loop Over Arrays</A></H2>
<P>
C-style <CODE>for</CODE> loops should be avoided. In particular,

<P>
<PRE>
        for ($i=0; $i &lt; @array; $i++) {
          SOMETHING($array[$i]);
        }
</PRE>
<P>
should be replaced with 

<P>
<PRE>
        foreach $item (@array) {
          SOMETHING($item);
        }
</PRE>
</BODY>

</HTML>

                                    </div>


                                </div>
                                <div class="asset-footer">


                                    <div class="entry-tags">
                                        <h4>Tags<span class="delimiter">:</span></h4>
                                        <ul>
                                            <li><a href="javascript:void(0)" onclick="location.href='http://www.perl.com/mt-search.cgi?IncludeBlogs=2&amp;tag=briandfoy&amp;limit=20';return false;" rel="tag">briandfoy</a><span class="delimiter">,</span></li> <li><a href="javascript:void(0)" onclick="location.href='http://www.perl.com/mt-search.cgi?IncludeBlogs=2&amp;tag=Perl%20Conference&amp;limit=20';return false;" rel="tag">Perl Conference</a></li>
                                        </ul>
                                    </div>

                                </div>
                            </div>


                    
                    


                        </div>
                    </div>


                    <div id="beta">
    <div id="beta-inner">


    
    <div class="widget-what-is-perl widget">
    <div class="widget-content widget-content-what-is-perl">
       Visit the home of the  Perl programming language: <a href="http://www.perl.org/">Perl.org</a
    </div>
</div>
<div class="widget-find-out-more widget-archives widget">
    <div class="widget-content">
        <ul>
            <li><a href="http://www.perl.org/get.html">Download</a></li>
            <li><a href="http://perldoc.perl.org/">Documentation</a></li>
            <li><a href="http://blogs.perl.org/">Perl Bloggers</a></li>
            <li><a href="http://news.perlfoundation.org/">Foundation News</a></li>
        </ul>
    </div>
</div><div class="widget-tcpc widget">
<h3 class="widget-header">Sponsored by</h3>
    <div class="widget-content">
        <a href="http://training.perl.com/" alt="Perl Training" target="_blank"><img src="/i/tcpc.png" width="150" height="50"></a>
    </div>
</div>

<div class="widget-syndication widget">
    <div class="widget-content">
        <ul>
            <li><img src="/mt-static/images/status_icons/feed.gif" alt="Subscribe to feed" width="9" height="9" /> <a href="/pub/atom.xml">Subscribe to this website's feed</a></li>

        </ul>
    </div>
</div>
<div class="widget-archive-monthly widget-archive widget">
    <h3 class="widget-header">Monthly <a href="/pub/archives.html">Archives</a></h3>
    <div class="widget-content">
        <ul>
        
            <li><a href="/pub/2014/02/">February 2014 (1)</a></li>
        
    
        
            <li><a href="/pub/2014/01/">January 2014 (1)</a></li>
        
    
        
            <li><a href="/pub/2013/10/">October 2013 (1)</a></li>
        
    
        
            <li><a href="/pub/2013/01/">January 2013 (1)</a></li>
        
    
        
            <li><a href="/pub/2012/12/">December 2012 (1)</a></li>
        
    
        
            <li><a href="/pub/2012/11/">November 2012 (1)</a></li>
        
    
        
            <li><a href="/pub/2012/10/">October 2012 (2)</a></li>
        
    
        
            <li><a href="/pub/2012/08/">August 2012 (2)</a></li>
        
    
        
            <li><a href="/pub/2012/06/">June 2012 (11)</a></li>
        
    
        
            <li><a href="/pub/2012/05/">May 2012 (18)</a></li>
        
    
        
            <li><a href="/pub/2012/04/">April 2012 (17)</a></li>
        
    
        
            <li><a href="/pub/2012/02/">February 2012 (1)</a></li>
        
    
        
            <li><a href="/pub/2011/12/">December 2011 (1)</a></li>
        
    
        
            <li><a href="/pub/2011/09/">September 2011 (1)</a></li>
        
    
        
            <li><a href="/pub/2011/08/">August 2011 (2)</a></li>
        
    
        
            <li><a href="/pub/2011/06/">June 2011 (1)</a></li>
        
    
        
            <li><a href="/pub/2011/05/">May 2011 (3)</a></li>
        
    
        
            <li><a href="/pub/2011/04/">April 2011 (1)</a></li>
        
    
        
            <li><a href="/pub/2011/03/">March 2011 (1)</a></li>
        
    
        
            <li><a href="/pub/2011/02/">February 2011 (1)</a></li>
        
    
        
            <li><a href="/pub/2011/01/">January 2011 (1)</a></li>
        
    
        
            <li><a href="/pub/2010/11/">November 2010 (1)</a></li>
        
    
        
            <li><a href="/pub/2010/10/">October 2010 (2)</a></li>
        
    
        
            <li><a href="/pub/2010/09/">September 2010 (1)</a></li>
        
    
        
            <li><a href="/pub/2010/08/">August 2010 (3)</a></li>
        
    
        
            <li><a href="/pub/2010/07/">July 2010 (2)</a></li>
        
    
        
            <li><a href="/pub/2010/04/">April 2010 (2)</a></li>
        
    
        
            <li><a href="/pub/2010/03/">March 2010 (4)</a></li>
        
    
        
            <li><a href="/pub/2008/05/">May 2008 (1)</a></li>
        
    
        
            <li><a href="/pub/2008/04/">April 2008 (2)</a></li>
        
    
        
            <li><a href="/pub/2008/03/">March 2008 (1)</a></li>
        
    
        
            <li><a href="/pub/2008/02/">February 2008 (1)</a></li>
        
    
        
            <li><a href="/pub/2008/01/">January 2008 (1)</a></li>
        
    
        
            <li><a href="/pub/2007/12/">December 2007 (2)</a></li>
        
    
        
            <li><a href="/pub/2007/09/">September 2007 (1)</a></li>
        
    
        
            <li><a href="/pub/2007/08/">August 2007 (1)</a></li>
        
    
        
            <li><a href="/pub/2007/07/">July 2007 (1)</a></li>
        
    
        
            <li><a href="/pub/2007/06/">June 2007 (1)</a></li>
        
    
        
            <li><a href="/pub/2007/05/">May 2007 (1)</a></li>
        
    
        
            <li><a href="/pub/2007/04/">April 2007 (1)</a></li>
        
    
        
            <li><a href="/pub/2007/03/">March 2007 (1)</a></li>
        
    
        
            <li><a href="/pub/2007/02/">February 2007 (1)</a></li>
        
    
        
            <li><a href="/pub/2007/01/">January 2007 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/12/">December 2006 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/11/">November 2006 (2)</a></li>
        
    
        
            <li><a href="/pub/2006/10/">October 2006 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/09/">September 2006 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/08/">August 2006 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/07/">July 2006 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/06/">June 2006 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/05/">May 2006 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/04/">April 2006 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/03/">March 2006 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/02/">February 2006 (4)</a></li>
        
    
        
            <li><a href="/pub/2006/01/">January 2006 (4)</a></li>
        
    
        
            <li><a href="/pub/2005/12/">December 2005 (4)</a></li>
        
    
        
            <li><a href="/pub/2005/11/">November 2005 (3)</a></li>
        
    
        
            <li><a href="/pub/2005/10/">October 2005 (2)</a></li>
        
    
        
            <li><a href="/pub/2005/09/">September 2005 (2)</a></li>
        
    
        
            <li><a href="/pub/2005/08/">August 2005 (9)</a></li>
        
    
        
            <li><a href="/pub/2005/07/">July 2005 (8)</a></li>
        
    
        
            <li><a href="/pub/2005/06/">June 2005 (9)</a></li>
        
    
        
            <li><a href="/pub/2005/05/">May 2005 (8)</a></li>
        
    
        
            <li><a href="/pub/2005/04/">April 2005 (7)</a></li>
        
    
        
            <li><a href="/pub/2005/03/">March 2005 (6)</a></li>
        
    
        
            <li><a href="/pub/2005/02/">February 2005 (7)</a></li>
        
    
        
            <li><a href="/pub/2005/01/">January 2005 (6)</a></li>
        
    
        
            <li><a href="/pub/2004/12/">December 2004 (8)</a></li>
        
    
        
            <li><a href="/pub/2004/11/">November 2004 (8)</a></li>
        
    
        
            <li><a href="/pub/2004/10/">October 2004 (5)</a></li>
        
    
        
            <li><a href="/pub/2004/09/">September 2004 (9)</a></li>
        
    
        
            <li><a href="/pub/2004/08/">August 2004 (6)</a></li>
        
    
        
            <li><a href="/pub/2004/07/">July 2004 (8)</a></li>
        
    
        
            <li><a href="/pub/2004/06/">June 2004 (6)</a></li>
        
    
        
            <li><a href="/pub/2004/05/">May 2004 (7)</a></li>
        
    
        
            <li><a href="/pub/2004/04/">April 2004 (8)</a></li>
        
    
        
            <li><a href="/pub/2004/03/">March 2004 (8)</a></li>
        
    
        
            <li><a href="/pub/2004/02/">February 2004 (9)</a></li>
        
    
        
            <li><a href="/pub/2004/01/">January 2004 (7)</a></li>
        
    
        
            <li><a href="/pub/2003/12/">December 2003 (4)</a></li>
        
    
        
            <li><a href="/pub/2003/11/">November 2003 (7)</a></li>
        
    
        
            <li><a href="/pub/2003/10/">October 2003 (8)</a></li>
        
    
        
            <li><a href="/pub/2003/09/">September 2003 (6)</a></li>
        
    
        
            <li><a href="/pub/2003/08/">August 2003 (7)</a></li>
        
    
        
            <li><a href="/pub/2003/07/">July 2003 (9)</a></li>
        
    
        
            <li><a href="/pub/2003/06/">June 2003 (9)</a></li>
        
    
        
            <li><a href="/pub/2003/05/">May 2003 (8)</a></li>
        
    
        
            <li><a href="/pub/2003/04/">April 2003 (8)</a></li>
        
    
        
            <li><a href="/pub/2003/03/">March 2003 (10)</a></li>
        
    
        
            <li><a href="/pub/2003/02/">February 2003 (8)</a></li>
        
    
        
            <li><a href="/pub/2003/01/">January 2003 (8)</a></li>
        
    
        
            <li><a href="/pub/2002/12/">December 2002 (5)</a></li>
        
    
        
            <li><a href="/pub/2002/11/">November 2002 (9)</a></li>
        
    
        
            <li><a href="/pub/2002/10/">October 2002 (7)</a></li>
        
    
        
            <li><a href="/pub/2002/09/">September 2002 (11)</a></li>
        
    
        
            <li><a href="/pub/2002/08/">August 2002 (8)</a></li>
        
    
        
            <li><a href="/pub/2002/07/">July 2002 (8)</a></li>
        
    
        
            <li><a href="/pub/2002/06/">June 2002 (4)</a></li>
        
    
        
            <li><a href="/pub/2002/05/">May 2002 (6)</a></li>
        
    
        
            <li><a href="/pub/2002/04/">April 2002 (6)</a></li>
        
    
        
            <li><a href="/pub/2002/03/">March 2002 (7)</a></li>
        
    
        
            <li><a href="/pub/2002/02/">February 2002 (5)</a></li>
        
    
        
            <li><a href="/pub/2002/01/">January 2002 (8)</a></li>
        
    
        
            <li><a href="/pub/2001/12/">December 2001 (7)</a></li>
        
    
        
            <li><a href="/pub/2001/11/">November 2001 (5)</a></li>
        
    
        
            <li><a href="/pub/2001/10/">October 2001 (9)</a></li>
        
    
        
            <li><a href="/pub/2001/09/">September 2001 (7)</a></li>
        
    
        
            <li><a href="/pub/2001/08/">August 2001 (13)</a></li>
        
    
        
            <li><a href="/pub/2001/07/">July 2001 (8)</a></li>
        
    
        
            <li><a href="/pub/2001/06/">June 2001 (13)</a></li>
        
    
        
            <li><a href="/pub/2001/05/">May 2001 (11)</a></li>
        
    
        
            <li><a href="/pub/2001/04/">April 2001 (9)</a></li>
        
    
        
            <li><a href="/pub/2001/03/">March 2001 (8)</a></li>
        
    
        
            <li><a href="/pub/2001/02/">February 2001 (8)</a></li>
        
    
        
            <li><a href="/pub/2001/01/">January 2001 (8)</a></li>
        
    
        
            <li><a href="/pub/2000/12/">December 2000 (6)</a></li>
        
    
        
            <li><a href="/pub/2000/11/">November 2000 (10)</a></li>
        
    
        
            <li><a href="/pub/2000/10/">October 2000 (10)</a></li>
        
    
        
            <li><a href="/pub/2000/09/">September 2000 (2)</a></li>
        
    
        
            <li><a href="/pub/2000/08/">August 2000 (2)</a></li>
        
    
        
            <li><a href="/pub/2000/07/">July 2000 (5)</a></li>
        
    
        
            <li><a href="/pub/2000/06/">June 2000 (7)</a></li>
        
    
        
            <li><a href="/pub/2000/05/">May 2000 (7)</a></li>
        
    
        
            <li><a href="/pub/2000/04/">April 2000 (3)</a></li>
        
    
        
            <li><a href="/pub/2000/03/">March 2000 (2)</a></li>
        
    
        
            <li><a href="/pub/2000/02/">February 2000 (2)</a></li>
        
    
        
            <li><a href="/pub/2000/01/">January 2000 (2)</a></li>
        
    
        
            <li><a href="/pub/1999/12/">December 1999 (6)</a></li>
        
    
        
            <li><a href="/pub/1999/11/">November 1999 (6)</a></li>
        
    
        
            <li><a href="/pub/1999/10/">October 1999 (5)</a></li>
        
    
        
            <li><a href="/pub/1999/09/">September 1999 (4)</a></li>
        
    
        
            <li><a href="/pub/1999/08/">August 1999 (3)</a></li>
        
    
        
            <li><a href="/pub/1999/07/">July 1999 (2)</a></li>
        
    
        
            <li><a href="/pub/1999/06/">June 1999 (3)</a></li>
        
    
        
            <li><a href="/pub/1999/04/">April 1999 (1)</a></li>
        
    
        
            <li><a href="/pub/1999/03/">March 1999 (1)</a></li>
        
    
        
            <li><a href="/pub/1999/01/">January 1999 (1)</a></li>
        
    
        
            <li><a href="/pub/1998/12/">December 1998 (1)</a></li>
        
    
        
            <li><a href="/pub/1998/11/">November 1998 (1)</a></li>
        
    
        
            <li><a href="/pub/1998/07/">July 1998 (2)</a></li>
        
    
        
            <li><a href="/pub/1998/06/">June 1998 (1)</a></li>
        
    
        
            <li><a href="/pub/1998/03/">March 1998 (1)</a></li>
        
        </ul>
    </div>
</div>
        
    

<div class="widget-powered widget">
    <div class="widget-content">
        <a href="http://www.movabletype.com/"><img src="/mt-static/images/bug-pbmt-white.png" alt="Powered by Movable Type 5.13-en" width="120" height="75" /></a>
    </div>
</div>



    </div>
</div>






                </div>
            </div>


            <div id="footer">
    <div id="footer-inner">
        <div id="footer-content">
            <div class="widget-powered widget">
                <div class="widget-content">
                    Powered by <a href="http://www.movabletype.com/" rel="generator">Movable Type Pro</a>
                </div>
            </div>

            <div class="widget-creative-commons widget">
                <div class="widget-content">
                    This blog is licensed under a <a href="http://creativecommons.org/licenses/by-nc-nd/3.0/">Creative Commons License</a>.
                </div>
            </div>

        </div>
    </div>
</div>



        </div>
    </div>
</body>
</html>
