<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" id="sixapart-standard">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="generator" content="Movable Type Pro 5.13-en" />
<link rel="stylesheet" href="/pub/styles.css" type="text/css" />
<link rel="start" href="/pub/" title="Home" />
<link rel="alternate" type="application/atom+xml" title="Recent Entries" href="/pub/atom.xml" />
<script type="text/javascript" src="/pub/mt.js"></script>
<!--
<rdf:RDF xmlns="http://web.resource.org/cc/"
         xmlns:dc="http://purl.org/dc/elements/1.1/"
         xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#">
<Work rdf:about="/pub/">
<dc:title>Perl.com</dc:title>
<dc:description>news and views of the Perl programming language</dc:description>
<license rdf:resource="http://creativecommons.org/licenses/by-nc-nd/3.0/" />
</Work>
<License rdf:about="http://creativecommons.org/licenses/by-nc-nd/3.0/">
</License>
</rdf:RDF>
-->

<script type="text/javascript">

 var _gaq = _gaq || [];
 _gaq.push(['_setAccount', 'UA-50555-22']);
 _gaq.push(['_trackPageview']);

 (function() {
   var ga = document.createElement('script'); ga.type =
   'text/javascript'; ga.async = true;
   ga.src = ('https:' == document.location.protocol ? 'https://ssl' :
   'http://www') + '.google-analytics.com/ga.js';
   var s = document.getElementsByTagName('script')[0];
   s.parentNode.insertBefore(ga, s);
 })();

</script>
<script type='text/javascript' src='http://partner.googleadservices.com/gampad/google_service.js'></script>
<script type='text/javascript'>
GS_googleAddAdSenseService("ca-pub-4136420132070439");
GS_googleEnableAllServices();
</script>
<script type='text/javascript'>
GA_googleAddSlot("ca-pub-4136420132070439", "Perl_728x90");
</script>
<script type='text/javascript'>GA_googleFetchAds();</script>
    <title>Perl.com: June 2005 Archives</title>


    <link rel="prev" href="/pub/2005/05/" title="May 2005" />
    <link rel="next" href="/pub/2005/07/" title="July 2005" />

</head>
<body id="perl-com" class="mt-archive-listing mt-datebased-monthly-archive layout-wt">
    <div id="container">
        <div id="container-inner">


            <div id="header">
    <div id="header-inner">
        <div id="header-content">
        <span id="top_advert"> 
<!-- Put any landscape advert in here -->
<!-- Perl_728x90 -->
<script type='text/javascript'>
GA_googleFillSlot("Perl_728x90");
</script>
        </span> 



            <div id="header-name"><a href="/pub/" accesskey="1">Perl.com</a></div>
            <div id="header-description">news and views of the Perl programming language</div>




        </div>
    </div>
</div>



            <div id="content">
                <div id="content-inner">


                    <div id="alpha">
                        <div id="alpha-inner">


                            <h1 id="page-title" class="archive-title">June 2005 Archives</h1>





                            
                            <div id="entry-794" class="entry-asset asset hentry">
    <div class="asset-header">
        <h2 class="asset-name entry-title"><a href="/pub/2005/06/p6pdigest/20050630.html" rel="bookmark">This Week in Perl 6, June 21-28, 2005</a></h2>
        <div class="asset-meta">
            <span class="byline">
    
                By <span class="vcard author">Matt Fowles</span> on <abbr class="published" title="2005-06-30T00:00:00-08:00">June 30, 2005 12:00 AM</abbr>
    
            </span>

            
            

        </div>
    </div>
    <div class="asset-content entry-content">

        <div class="asset-body">
            
<!-- sidebar begins -->
<!-- don't move sidebars-->
<!-- sidebar ends -->
<br clear="all" />
<p>All--</p>

<p>Long time no see ... err, write ... uh, read ... um ... this. Yeah, long time no
this. As Piers hinted, two weeks ago I moved. Moving sucks. For those of you
who care, I am still in Cambridge; for those of you who care more, I think you
misunderstand the summarizer/summary reader relationship.  Essentially it
revolves around summaries; the summary of my move is Cambridge to
Cambridge.</p>

<p>As Piers noted last week, this is a low-volume, high-action week, in no
small part due to the hack-a-thons. Last week's was in Austria, this week's is
near Toronto. Perhaps some nice soul who was actually at these hack-a-thons
will summarize them when it is over.</p>

<h3>Perl 6 Compiler</h3>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.compiler/browse_frm/thread/abfc8d43c0030ae2/db08ca00d5df5bad#db08ca00d5df5bad">PGE
Announcements</a></h4>

<p>Patrick announced that PGE now supports grammars and more built-in rules. He
even offered to field requests for built-in rules (although he would prefer
patches).</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.compiler/browse_frm/thread/f26c2b6b94f58bec/4f9964a9246294c5#4f9964a9246294c5">Caller's
Context</a></h4>

<p>Gerd Pokorra wanted to know how to determine if his sub is called in void
context. He conjectured that <code>want</code> might fill his wants. There is
no response yet.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.compiler/browse_frm/thread/a7006466f65ed918/649a0c2ebdc39551#649a0c2ebdc39551">Self-Hosting Goals</a></h4>

<p>Millsa Erlas explained that one good reason for Perl 6 to be self-hosting is
that it would allow the people who love it most (Perl hackers) to hack on it.
The theory is that low-level languages like C unnecessarily narrow the field of
contributors (especially those that only know Perl).  People expressed some
concerns expressed over confusion about the language Ponie should be written
in. No one disputes that this is C.</p>

<h3>Parrot</h3>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/47fabb48ef7956e8/b0617764c7f5cf9d#b0617764c7f5cf9d">Indexing
Hashtables</a></h4>

<p>Klaas-Jan Stol asked for a clue bat with respect to indexing hash tables in
PIR. Joshua Juran and Leo each took a swing.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/1d557b9589f65929/f387af585e3cea74#f387af585e3cea74">Parrot
Loses with Fedora Core 4</a></h4>

<p>Patrick reported that Fedora Core 4 and Parrot don't get along well. Leo
suggested a possible solution.  Patrick has posted no response.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/95280ad597d4790d/d5dc071ccab92032#d5dc071ccab92032">Default
Method Resolution Order</a></h4>

<p>Roger Browne wondered what the default MRO order is. Leo provided the
answer: left-to-right, depth-first, discard all but the last occurrence of
duplicates, divine intervention.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/30bae80d039db434/38e92b8e886cb1a9#38e92b8e886cb1a9">Win32
Tests Failing</a></h4>

<p>Craig the Last-Nameless-One posted a list of failing tests and problems on
Windows. Leo provided a few answers.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/a0dd2cb3fefa091b/1f5a59bc9780dd12#1f5a59bc9780dd12">Method
Inheritance Needs Perl Loving</a></h4>

<p>Leo announced a Perl job for the interested: method inheritance in the PMC
compiler. This naturally led to discussion of numerical hierarchies. I was a
little disappointed that quaternions appeared, but Hamiltonian and Surreal
Numbers did not. Honestly, where are our priorities?</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/63231fc4b4354b74/8308d6a82a7391ee#8308d6a82a7391ee">Tracing
and Debugging Pain</a></h4>

<p>Matt Diephouse posted a general description of the problems he was having
with tracing, debugging, and GC. Warnock might apply in a day or two.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/aac073aea211da64/3eb0faddd82cf78f#3eb0faddd82cf78f">Segmented
Context and Register Memory</a></h4>

<p>Chip posted a partial reply to Leo's context and register overhaul patch.
Andy Dougherty responded to some of Chip's finer points. If you find the
nuances of C's pointer pain interesting, this thread is for you.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/d9c6844fdd0370dd/89aeb7672bec78f4#89aeb7672bec78f4">Improving
Parrot's Test Framework</a></h4>

<p>Chromatic wants to improve Parrot's test framework by stealing ideas from
Test::Class. He wants to know if anyone else has an interest.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/aa53a7af485b291f/7063cd92d09e5fa0#7063cd92d09e5fa0"><code>setattribute</code> Fails with Multi-Level Inheritance</a></h4>

<p>Roger Browne opened a ticket describing an error with
<code>setattribute</code> when using several layers of inheritance.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/6c5863248089d19c/a86685a0a333ba85#a86685a0a333ba85">Register
Allocation Bug</a></h4>

<p>Leo opened a ticket for a problem with improper control flow tracking.  Bill
Coffman wondered whether the new register design is in place yet.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/a3e7c1a8234ed020/e249e566eb001b7b#e249e566eb001b7b">Pass
by Value PMCs</a></h4>

<p>Klaas-Jan Stol mused that the new calling conventions could work to allow
passing PMCs by value.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/a49d5b1ae8374fc1/844cb69766ad6b3e#844cb69766ad6b3e">Parrot
Fall Down Go Boom</a></h4>

<p>Matt Fowles reported a segfaulting Parrot that passes its tests. Sadly, no
one solved his problem in the four hours between his posting it and writing the
summary.</p>

<h3>Perl 6 Language</h3>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.language/browse_frm/thread/792e4adc208c9568/f4ca247b7b29cf04#f4ca247b7b29cf04">You
Know That, But You Go On</a></h4>

<p>As Piers noted, arguments about <code>./method</code> versus
<code>.method</code> continue. Like Piers, I don't like <code>./</code>. I
guess I was the only person who liked <code>$^</code> as the invocant. Ah well,
I guess I will just go on summarizing.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.language/browse_frm/thread/257b160616561992/d396c7a60a1d47a7#d396c7a60a1d47a7">Binding
Functions</a></h4>

<p>Piers wanted to use a Ruby idiom involving rebinding functions. Damian told
him that he could, but also pointed him to <code>wrap</code>.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.language/browse_frm/thread/caf03c9ef13ce6e5/8b7df20d9c8e6aab#8b7df20d9c8e6aab">OO
Questions</a></h4>

<p>B&Aacute;RTH&Aacute;ZI Andr&aacute;s posted a question about method calls in
Perl 6. Juerd and Piers provided answers.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.language/browse_frm/thread/69acf71fe3cc023e/01dcb95c7294c925#01dcb95c7294c925"><code>AUTOLOAD</code>
and <code>$_</code></a></h4>

<p>Last week's thread about <code>AUTOLOAD</code> continued. It still seems to
be fishing for some official decision.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.language/browse_frm/thread/5196c30a34c9d60a/87bf624ff2f251be#87bf624ff2f251be">Magic
Mutators and Proxies</a></h4>

<p>Sam Vilain wondered if he could make proxies behave like he wanted to.  Luke
Palmer explained, yes, but he would need to use binding instead of
assignment.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.language/browse_frm/thread/d1335f4b4c548a25/f4ab8859af6f2269#f4ab8859af6f2269">Quasiquoting
and PPI</a></h4>

<p>Brad Bowman asked how Quasiquoting and PPI would interact with the AST.
Autrijus posted some explanation and Adam Kennedy cleared up some terms.</p>

<h3>The Usual Footer</h3>

<p>To post to any of these mailing lists please subscribe by sending email to
<code>perl6-internals-subscribe@perl.org</code>,
<code>perl6-language-subscribe@perl.org</code>, or
<code>perl6-compiler-subscribe@perl.org</code>. If you find these summaries
useful or enjoyable, please consider contributing to the Perl Foundation to
help support the development of Perl. You might also like to send feedback to <csperl file="mailmunge" arg_email="ubermatt@gmail.com" arg_ending="." /></p>

<ul>

<li><a href="http://donate.perl-foundation.org/">The Perl Foundation</a></li>
<li><a href="http://dev.perl.org/perl6/">Perl 6 development site</a></li>
<li><a href="http://planet.parrotcode.org/">Parrot blog aggregator</a></li>

</ul>

<!-- sidebar begins -->
 <csperl file="grab" domain="on" record="b/1714" template="b/article_sidebar2.view">
<!-- sidebar ends -->

        </div>



    </div>
    <div class="asset-footer"></div>
</div>


                            
                            <div id="entry-786" class="entry-asset asset hentry">
    <div class="asset-header">
        <h2 class="asset-name entry-title"><a href="/pub/2005/06/30/annocpan.html" rel="bookmark">Annotating CPAN</a></h2>
        <div class="asset-meta">
            <span class="byline">
    
                By <span class="vcard author">Ivan Tubert-Brohman</span> on <abbr class="published" title="2005-06-30T00:00:00-08:00">June 30, 2005 12:00 AM</abbr>
    
            </span>

            
            

        </div>
    </div>
    <div class="asset-content entry-content">

        <div class="asset-body">
            
<!-- sidebar begins -->
<!-- don't move sidebars-->
<!-- sidebar ends -->
<br clear="all" />
<p><a href="http://annocpan.org/">AnnoCPAN</a> is a new website that shows the
documentation for every Perl module available on <a
href="http://www.cpan.org/">CPAN</a> and allows anyone to post annotations in
the margins of the documents. The notes are public, so everyone can read and
reuse them under the same terms as Perl itself (the entire note database is
available as an XML dump). The inspiration came from other open source
documentation websites such as those for PHP and MySQL, but the implementation has
adapted to the idiosyncrasies of Perl documentation regarding document length
and versioning. This article discusses the origins and the ideas behind this
project and how I implemented them.</p>

<h3>How it All Started</h3>

<p>People often complain about Perl documentation. This is not entirely fair,
given the prodigious amount of available documents. Although the quality of the
documentation for Perl modules outside of the core distribution ranges from
excellent to non-existent, I believe that it is, overall, pretty good. But
there will always be some minor niggling details, inaccuracies, or omissions in
the documents. I know that, as a programmer writing documentation, it is easy
to forget what should actually go in there for the benefit of the user, because
I have the advantage (or disadvantage?) of knowing too much about the product.
Often the users themselves are in the best position to point out the gaps in
the documentation.</p>

<p>A typical response when a user complains about the documentation of an open
source project is &quot;send a patch!&quot; However, this is often not practical,
whether because the user doesn't know how to do it or doesn't want to spend the
time, or the maintainer is unresponsive. Even under ideal conditions it often
takes too long for the patch to make it to the official documentation, and too
long a delay in gratification discourages further participation.  Several
projects allow users to modify the documentation directly, perhaps by using a
wiki or by letting the users post comments.  Notable examples include <a
href="http://dev.mysql.com/doc/mysql/en/">MySQL</a> and <a
href="http://www.php.net/manual/en/">PHP</a>. On more than one occasion, people
have asked why Perl didn't have something like that, and most agreed that it
would be good if <em>someone</em> did something about it. Well, I decided to
try to do the dirty job.</p>

<p>Note: While I was working on this project, <a
href="http://cpanforum.com/">CPAN::Forum</a> appeared. It shares some of the
goals of AnnoCPAN but has some differences, as well. Both have the goal of
providing a place for discussion about Perl modules that have no other
discussion venues, but only AnnoCPAN shows that discussion right next to the
relevant parts of the documentation.</p>

<!-- sidebar begins -->
 <csperl file="grab" domain="on" record="b/936" template="b/article_sidebar.view">
<!-- sidebar ends -->

<h3>Where to Put the Notes?</h3>

<p>One of the first things I noticed when analyzing the problem was that
documentation pages for PHP and MySQL are usually fairly small--the sites
have split the manual into small chunks, which allows the comments to remain
close to the relevant part of the documentation.  (It wouldn't be as helpful to
add a footnote at the end of a 50-page-long document saying &quot;By the way, the
first paragraph is wrong!&quot;). The problem is that Perl documentation usually
comes in fairly long documents--just look at the PODs for CGI, DBI, or
<code>perlfunc</code>! Splitting these documents into &quot;reasonably sized&quot; chunks is not
trivial, because there's little standardization of the organization of the
documents: for some documents I might find that <code>=head1</code> sections
are short enough, while for others I have to split at the <code>=head3</code>
or <code>=item</code> level. While this is an interesting and maybe even
tractable problem, I decided to take a different approach: rather than
splitting the document, I decided to attach the user comments to specific
paragraphs and show them right on the margin or between the paragraphs
(depending on a user-configurable stylesheet).</p>

<p>The decision of attaching the notes to specific paragraphs opened another
can of worms: if someone adds a note to paragraph 42 of My::Module version
0.10, where should that note go (if at all) in the documentation for My::Module
version 0.20?</p>

<p>To prepare the AnnoCPAN site, first I had to create a full CPAN mirror. That
wasn't hard, but it requires quite a bit of space (2.5GB). Then I pre-parsed
it using a module derived from <a
href="http://search.cpan.org/perldoc?Pod::Parser">Pod::Parser</a> (discussed
later) and loaded each paragraph into a database. The database schema underwent
several revisions, due to the difficulties in modeling CPAN.</p>

<h3>CPAN is a Wild Jungle!</h3>

<p>Something that anyone who tries to parse anything out of the full CPAN
archive quickly finds out is that it is a maze of exceptions and corner cases.
While most distributions, prepared with <a
href="http://search.cpan.org/perldoc?ExtUtils::MakeMaker">ExtUtils::MakeMaker</a>
or something similar, share certain structural and naming conventions, some
authors deviate from the convention and package their distribution in strange
ways. The first hurdle is how to figure out the distribution name and version
number from the distribution filename. Luckily, Graham Barr (from
<i>search.cpan.org</i>) has already worked on that, so I just used his module <a
href="http://search.cpan.org/perldoc?CPAN::DistnameInfo">CPAN::DistnameInfo</a>.</p>

<p>The next hurdle is the structure of the package itself. Most packages are
.tar.gz files that unwrap to a directory with the same name as the
distribution filename (sans the .tar.gz extension).  Some packages are
.zip files, and a few are .ppm files, or something else. Even for the .tar files
there are inconsistencies, depending on the version of the program used to
create them. I couldn't even open some of them correctly! Then there are files
that don't unwrap to a single directory. I decided to deal only with reasonably
clean .tar.gz and .zip packages and ignore everything
else.</p>

<p>After unwrapping the distribution, my program had to figure out which files
were significant for documentation purposes. I wanted to include only the
modules, scripts, and standalone POD documents, excluding test files, examples,
and bundled modules that belong to some other distribution. First the program
filters based on the filename, to exclude some obvious negatives such as
<em>MANIFEST</em> and <em>META.yml</em>, and include some likely positives such
as .pm and .pod files. In uncertain cases, it opens the file
and sees if it has some POD, such as a <code>=head1</code> line.</p>

<p>Having decided that a file has documentation in POD format and should be
included, the program has to figure out the title of the document. This is not
as easy as it seems. I decided to use this rule, which seems to work most of
the time: if the first POD paragraph is <code>=head1 NAME</code>, take the
first word from the second paragraph and use it as the title. If not, guess the
name from the pathname of the file. This is easy with &quot;modern-style&quot; packages;
for example, <em>My-Module-0.10/lib/My/Module.pm</em> turns into
<code>My::Module</code>.  &quot;Old-style&quot; distributions are a bit trickier:
<em>My-Module-0.10/Module.pm</em> also turns into <code>My::Module</code>. A
third option that I haven't used is to look for the first <code>package</code>
declaration in .pm files, but that wouldn't work for most .pod and
.pl files, and that's without even considering that some .pm
files have zero or more than one package declaration!</p>

<p>All of the above leads me to wish that, if someone were to start CPAN from
scratch again, it would be a bit more strict in the structure required for
distributions, especially with the filename of the distribution package. The
way things are now, it is impossible to know for sure if distribution A has a
&quot;higher&quot; version number than distribution B. (It's possible to compare the
dates, but what if there is more than one active branch?) Luckily, there is
already work in that direction; having a way of measuring <a
href="http://cpants.dev.zsi.at/kwalitee.html">kwalitee</a> may encourage
authors to pack their modules in standard ways.</p>

<h3>Ontological Questions</h3>

<p>OK, so my program has produced a nicely unwrapped distribution with some
PODs.  What is a distribution and what is a POD, though? These may seem silly
questions to ask, but they are very important.  Is this POD a different version
of some other POD? Is this distribution just a different version of some other
distribution, or is it a completely different distribution?  For distributions,
I've assumed that if it has the same filename, except for the version part,
they are indeed two different version of the same distribution (for example,
<em>DBI-1.47.tar.gz</em> and <em>DBI-1.48.tar.gz</em>). This is a reasonable
assumption, but unfortunately, there's no guarantee that it will always be true,
because anyone could upload a file called <em>DBI-1.49.tar.gz</em> with
completely unrelated contents (luckily, I haven't seen that happen yet). Note
that a distribution can have more than one author, with various versions in
each author's directory.</p>

<p>The problem becomes more complicated for modules, because unfortunately,
there are many known cases of modules that appear in more than one
distribution. The most common situation is when an author maintains a module as
a separate CPAN distribution that is also part of the Perl core (that is, the
<code>perl</code> distribution). A common example is the CGI module. However, there's no
guarantee that two documents with the same name are indeed versions of the same
module. The most dramatic example is the number of <em>Install</em> or
<em>Tutorial</em> documents that have no relationship to each other. Luckily,
this is not as common for real modules as it is for other documents, but I
decided to play it safe and assume by default that two documents are the same
only if they have the same name and belong to distributions with the same name.
There is a manual override, however.  For example, I can tell the system that
CGI in the <code>perl</code> distribution is the same as CGI in the <i>CGI.pm</i> distribution.</p>

<h3>Loading the Database</h3>

<p>Because I wanted to have paragraph granularity for attaching notes to
modules, I loaded all of the CPAN documentation into my database, one row per
paragraph. To parse the POD, I created a very simple subclass of <a
href="http://search.cpan.org/perldoc?Pod::Parser">Pod::Parser</a> (which comes
with <code>perl</code>). The subclass only overrides the paragraph-level methods and uses
them to store the POD in the database without any further processing.</p>

<pre><code>package AnnoCPAN::PodParser;

use base qw(Pod::Parser);

sub verbatim {
    my ($self, $text, $line_num, $pod_para) = @_;
    $self-&gt;store_section(VERBATIM, $text);
}

sub textblock {
    my ($self, $text, $line_num, $pod_para) = @_;
    $self-&gt;store_section(TEXTBLOCK, $text);
}

sub command {
    my ($self, $cmd, $text, $line_num, $pod_para)  = @_;
    $self-&gt;store_section(COMMAND, $pod_para-&gt;raw_text);
}

sub store_section {
    my ($self, $type, $content) = @_;
    # ... 
    # load $content into database 
    # ...
}</code></pre>

<p>Here again I encountered problems with some of the modules that exist in the
wild. Pod::Parser generally works very well, but it becomes extremely slow when
a document has a very long paragraph (with thousands of lines). Most modules
don't have paragraphs with more than a hundred lines, so the problem had likely
never surfaced before, but I found a few modules that appear to contain lots of
machine-generated data. They took about ten minutes each to parse. I went into
the code of Pod::Parser and found that by deleting one line (an apparently
unnecessary line!), the scaling problem goes away and parsing takes under a
second.</p>

<p>For the database access itself, I used <a
href="http://search.cpan.org/perldoc?Class::DBI">Class::DBI</a>, which
simplifies things enormously. For example, this is the code for creating a
section (i.e., a paragraph):</p>

<pre><code>$section = AnnoCPAN::DBI::Section-&gt;create({
    podver  =&gt; $podver,
    type    =&gt; $type,
    content =&gt; $content,
    pos     =&gt; $pos,
});</code></pre>

<h3>Translating the Notes</h3>

<p>By translating, I mean &quot;figuring out where the note goes in a different
version of the same document,&quot; not &quot;translating into a different language.&quot;
Suppose that someone adds a note next to some paragraph of My::Module 0.10. To
figure out where to put the note in the POD for My::Module 0.20, I decided to
place it next to the paragraph in 0.20 that is most &quot;similar&quot; to the reference
paragraph in 0.10. To decide which paragraph is most similar, I used the <a
href="http://search.cpan.org/perldoc?String::Similarity">String::Similarity</a>
module by Marc Lehmann. The essential code is something like:</p>

<pre><code>package AnnoCPAN::DBI::Note;
use String::Similarity 'similarity';

sub guess_section {
    my ($self, $podver) = @_;
    # $podver is a specific version of a pod

    my $ref_section = $self-&gt;section;
    my $orig_cont   = $ref_section-&gt;content;

    my $max_sim = AnnoCPAN::Config-&gt;option('min_similarity');
    my $best_sect;
    for my $sect ($podver-&gt;raw_sections) {
        # don't attach notes to commands
        next if $sect-&gt;{type} &amp; COMMAND;
        my $sim = similarity($orig_cont, 
            $sect-&gt;{content}, $max_sim);
        if ($sim &gt; $max_sim) {
            $max_sim   = $sim;
            $best_sect = $sect;
        }
    }
    if ($best_sect) {
        AnnoCPAN::DBI::NotePos-&gt;create({ note =&gt; $self, 
            section =&gt; $best_sect-&gt;{id}, 
            score =&gt; int($max_sim * SCALE),
            status =&gt; CALCULATED });
    }
}</code></pre>

<h3>Adding a Web Interface</h3>

<p>The web interface combines the strengths of Class::DBI and the <a
href="http://www.template-toolkit.org/">Template Toolkit</a>, using the methods
discussed in "<a href="/pub/a/2003/07/15/nocode.html">How to
Avoid Writing Code--Using Template Toolkit and Class::DBI</a>," by Kake Pugh.
The only thing remaining, besides writing the templates, was to provide a
controller module (called as a part of the <a
href="http://c2.com/cgi-bin/wiki?ModelViewController">Model-View-Controller</a>
(MVC) design pattern. The controller module has to parse the CGI parameters and
cookies, decide what to do with them, authenticate the user if necessary, fetch
something from the database, choose the template to use, and pass all of the
required information to the Template Toolkit rendering engine. Some people
advocate using modules such as <a
href="http://search.cpan.org/perldoc?CGI::Application">CGI::Application</a> as
a base class for the controller module, but I found that writing it by hand was
simple enough for my purposes.</p>

<h3>Conclusion</h3>

<p>In this article, I have discussed some of the logic and technical problems
behind the design and implementation of AnnoCPAN. What remains to be done is to
ensure that people use the site so that it becomes a valuable resource. That
depends on users (which means you!) adding helpful annotations. Please take a
look at <a href="http://annocpan.org/">annocpan.org</a>!</p>

<h3>Acknowledgments</h3>

<p>I thank <a href="http://www.perlfoundation.org">The Perl Foundation</a> for
a grant for working on this project and <a
href="http://perlmonks.org/index.pl?node_id=154315">BUU</a> for hosting the
website.</p>


        </div>



    </div>
    <div class="asset-footer"></div>
</div>


                            
                            <div id="entry-792" class="entry-asset asset hentry">
    <div class="asset-header">
        <h2 class="asset-name entry-title"><a href="/pub/2005/06/p6pdigest/20050623.html" rel="bookmark">This Week in Perl 6, June 8-21, 2005</a></h2>
        <div class="asset-meta">
            <span class="byline">
    
                By <span class="vcard author">Piers Cawley</span> on <abbr class="published" title="2005-06-23T00:00:00-08:00">June 23, 2005 12:00 AM</abbr>
    
            </span>

            
            

        </div>
    </div>
    <div class="asset-content entry-content">

        <div class="asset-body">
            
<!-- sidebar begins -->
<!-- don't move sidebars-->
<!-- sidebar ends -->
<br clear="all" />
<p>Surprise! It's me again. You may be wondering what happened to last week's
summary (I know I was) and where Matt had gone. Well, I'm not entirely sure
where exactly he is now, but last week was moving week for him.</p>

<p>Those of you reading this on the mailing lists may also be wondering why
this summary is so late. Um ... three words: <i>World of Warcraft</i>.</p>

<h3>This Week in <i>perl6-compiler</i></h3>

<p>As a summarizer, when you see the &quot;last fortnight&quot; view of a mailing list
containing 21 messages, several thoughts spring, unbidden, to your mind: "Is my
mail broken again?" "Has everyone given up?" "Phew, this group won't take long to
do."</p>

<p>It turns out that the answer to both of those questions is &quot;No.&quot; What
actually happened was that most of the stuff that normally happens in mail
happened at the Austrian Perl Workshop and Leo T&ouml;tsch's house, with a side
order of IRC conversation and a bunch of spinoff threads in <i>p6l</i> and <i>p6i</i>.</p>

<p>In the last fortnight, <a href="http://use.perl.org/~autrijus/journal/"> Pugs
reached the point where it has a (mostly) working Parrot back end, and </a>
B&Aacute;RTHAZI Andras wondered if we shouldn't <a
href="http://aspn.activestate.com/ASPN/Mail/Message/perl6-language/2622861">start
a <i>perl6-general</i> mailing list</a>.</p>

<h3>This Week in <i>perl6-internals</i></h3>

<p>140 messages in this one. <i>p6c</i> lulled me into a false sense of security.
Again, you may notice a bewilderingly fast rate of change this summary. It
turns out that they weren't just working on Pugs at Leo's house. Perl 6
Hackathons give great productivity.</p>

<h4>This Is Not Your Father's Parrot</h4>

<p>There's been some serious work going on under the Parrot hood in the last
two weeks. Leo and Chip have drastically reworked the calling conventions, which
now use four new opcodes: <code>set_args</code>, <code>set_returns</code>,
<code>get_params</code>, and <code>get_results</code>.  At the time of writing,
IMCC doesn't give you full syntactic help with them, but they're easy enough to
use explicitly for the time being and the help is getting there. Check out the
<a
href="http://svn.perl.org/parrot/trunk/docs/pdds/pdd03_calling_conventions.pod">Parrot
Calling Conventions PDD</a> for details.</p>

<p>Also getting rejigged is the continuation/register frame architecture.
Taking advantage of the fact that this is a <em>virtual</em> machine, we now
have an unlimited number of registers per register frame. Combine this with the
new calling conventions, in which arguments are passed outside of the register
frame, and all of a sudden a full continuation becomes a simple pointer to the
register frame and everything gets saved as if by magic, which opens up a whole
bunch of possibilities, which has interesting implications for the register
allocator.</p>

<p><a href="http://use.perl.org/~chip/journal/">Chip's design notes</a></p>

<h4><a
href="http://groups.google.com/groups?threadm=41b037ed050608072845298c13@mail.gmail.com">New
Generational GC Scheme</a></h4>

<p>Alexandre Buisse posted his outline for a Google Summer of Code project to
implement a shiny new Generational Garbage Collection scheme. Discussion of
tunability and threading issues followed.</p>

<h4><a
href="http://groups.google.com/groups?threadm=493A37523A8D17448240DA1DDDE924B4044D9040@MSGBOSCLD2WIN.DMN1.FMR.COM">Ordered
Hashes: More Thoughts</a></h4>

<p>Steve Tolkin helpfully provided a summary of his thoughts about ordered
hashes: &quot;An ordered hash that does not support deletes could cause a user-visible bug. At a minimum, it should support the special case of delete that is
supported by the Perl <code>each()</code> operator.&quot; Dan pointed out that
reusing the ordered hash code for anything other than the lexical pad it was
specifically implemented for was just looking for trouble.</p>

<h4><a
href="http://groups.google.com/groups?threadm=20050612111515.GA19372@tytlal.topaz.cx">The
Thread That I Really Hoped Matt Would Be Summarizing</a></h4>

<p>AKA &quot;Attack of the 50-foot register allocator vs. the undead continuation
monster.&quot; Piers Cawley and Chip had something of a disagreement about
interactions between continuations and the register allocator. After discussion
on IRC, it became apparent that they were talking past each other. The new &quot;the
register frame is the continuation&quot; means that yes, the register allocator
definitely can't rely on being able to reuse registers that persist over
function calls, but that's all right because you can always grab more
registers.</p>

<h4><a
href="http://groups.google.com/groups?threadm=20050612113805.GC19372@tytlal.topaz.cx">Missing
MMD Default Functions</a></h4>

<p>Remember the missing multimethod functions I mentioned last time? At the
time, Chip hadn't ruled on whether taking them out was the Right Thing or not.
He has since ruled that it was.</p>

<p>This is probably not quite the right place to suggest this, but what the
heck. Maybe in future when planning user visible changes of this sort, they
should spend at least one release period deprecated and throwing warnings when
used.</p>

<h4><a
href="http://groups.google.com/groups?threadm=42AA039B.8030000@coleda.com">PGE,
Namespaced Rules</a></h4>

<p>William Coleda worried that PGE subrules appear to be globally scoped.  It
turns out that Patrick worries, too, but is currently in the process of
thrashing out how to scope them. He outlined his current thinking.</p>

<h4><a
href="http://groups.google.com/groups?threadm=42AA13D4.1010201@home.nl">PMCs
and Objects Question</a></h4>

<p>Klaas-Jan Stol wondered about the possibilities of overriding PMC behavior
with Parrot classes. He outlined possibilities and wondered if he was correct.
Chip thought that it should be possible to implement (for instance) Perl's
datatypes in pure PIR, if only for debugging and fun. I'm still not entirely
sure if it's possible to make a <code>ParrotClass</code> that inherits from a
PMC, though.</p>

<h4><a
href="http://groups.google.com/groups?threadm=rt-3.0.11-36250-115576.12.1956142453591@perl.org">Software
Transactional Memory</a></h4>

<p>It seems the design team have drunk deeply of the Software Transaction
Memory (STM) Kool Aid. STM is, to quote Chip, a &quot;wicked cool&quot; way of doing
threading. Expect a more-fleshed-out design document eventually.</p>

<h4><a
href="http://groups.google.com/groups?threadm=1579101353.20050611234913@rblasch.org">Parrot
<code>bc</code></a></h4>

<p>According to the configuration scripts, Parrot looks for the GNU version of
<code>bc</code> solely for checking that Parrot <code>bc</code> is working.
This is all very well, but there is no Parrot implementation of <code>bc</code>
in the SVN repository. Apparently, there's a broken version of it sitting on
Bernhard Schmalhofer's local hard disk.</p>

<p>None of which addressed the issue of why, even with a &quot;working&quot; version, the
tests need to access GNU <code>bc</code>. Surely it's possible to write tests
statically. The only time you'd need an authoritative version would be when you
were adding tests. Oops, editorializing again.</p>

<h4><a
href="http://groups.google.com/groups?threadm=42ABB476.3030109@coleda.com">Substituting
for PGE</a></h4>

<p>Will Coleda wondered if it was possible to do substitutions with PGE yet.
&quot;Yes, sort of,&quot; Patrick replied.  You can substitute the first occurrence by
grabbing the match data and using <code>substr</code>. Everything else is for
another day.</p>

<h4><a
href="http://groups.google.com/groups?threadm=42AC11C4.9000501@home.nl">Unexpected
Behavior Calling Method</a></h4>

<p>Klaas-Jan Stol had some problems implementing delegated addition.
Apparently it's because the signatures of the <code>__add</code> methods caught
him out. Also, it's a really bad idea to delegate to a method called
<code>__add</code>, because Parrot expects some very particular behavior from
it. Think about calling it <code>add</code> instead.</p>

<h4><a
href="http://groups.google.com/groups?threadm=20050612103228.GI4954@tytlal.topaz.cx">Parrot
Goals and Priorities</a></h4>

<p>Chip's put the slides of his Austrian Perl Workshop talk on <a
href="http://feather.perl6.nl/~chip/Chip_APW.pdf">the Parrot project and its
priorities</a> up on feather. Check them out; they're good.</p>

<h4><a
href="http://rt.perl.org/rt3/Search/Listing.html?Bookmark=FrT%3B%404%7C%258%7C%242%7C10%242%7C11%241%7C7%241%7C9%258%7C%2411%7CDESCRIPTION%245%7CFIELD%248%7COPERATOR%245%7CVALUE%2418%7CStatus%20%21%3D%20resolved%246%7CStatus%242%7C%21%3D%248%7Cresolved%258%7C%2411%7CDESCRIPTION%245%7CFIELD%248%7COPERATOR%245%7CVALUE%2418%7CStatus%20%21%3D%20rejected%246%7CStatus%242%7C%21%3D%248%7Crejected%258%7C%2411%7CDESCRIPTION%245%7CFIELD%248%7COPERATOR%245%7CVALUE%2414%7CQueue%20%3D%20parrot%245%7CQueue%241%7C%3D%246%7Cparrot%258%7C%2411%7CDESCRIPTION%245%7CFIELD%248%7COPERATOR%245%7CVALUE%2417%7CSubject%20LIKE%20TODO%247%7CSubject%244%7CLIKE%244%7CTODO%242%7C12%241%7C0%241%7C0&TicketsSortBy=Created&TicketsSortOrder=DESC&RowsPerPage=50">New
TODOs</a></h4>

<p>Will Coleda's been busy injecting a bunch of handy TODO items in the Parrot
RT system. Check 'em out, you might be able to do some of them.</p>

<h4><a
href="http://groups.google.com/groups?threadm=Pine.LNX.4.62.0506122306160.11002@hydrogen.sabren.com">New
List for Pirate</a></h4>

<p>Michal Wallace announced the creation of <a
href="http://cornerhost.com/mailman/listinfo/pirate">a new list for work on
Pirate</a>, a Python compiler for Parrot. If Python on Parrot is your bag, I
suggest you sign up.</p>

<h4><a
href="http://groups.google.com/groups?threadm=20050615203833.GC7329@pmichaud.com">Adding
Methods to Existing Classes</a></h4>

<p>Patrick wondered how to add methods to existing classes. It turns out that
the trick is to use <code>find_type</code> instead of <code>findclass</code>.
According to Leo, <code>findclass</code> is deprecated.</p>

<h3>Meanwhile, in <i>perl6-language</i></h3>

<p>Hmm. 1242 GMT+1 on Thursday as I write this, and there are, oh, 246
messages in <i>perl6-language</i>. This could get sketchy.</p>

<h4>Reduce Metaoperator on an Empty List</h4>

<p>Wow! The &quot;Reduce metaoperator on an empty list&quot; discussion is still
going.</p>

<h4><a
href="http://aspn.activestate.com/ASPN/Mail/Message/perl6-language/2617767"><code>return()</code>
in Pointy Type Blocks</a></h4>

<p>Much to my personal chagrin, it looks like <code>return()</code> inside a
of pointy block will use an escape continuation and will probably be picky about
making sure that you can only invoke the pointy block from somewhere
dynamically &quot;below&quot; the block in which it was created. This means no cunning tricks
like:</p>

<pre><code>sub call_with_current_continuation(Code $code) {
  $code({ return $^cc })
}</code></pre>

<p>which is probably a good thing.</p>

<h4><a
href="http://aspn.activestate.com/ASPN/Mail/Message/perl6-language/2619348"><code>caller</code>
and <code>want</code></a></h4>

<p>Gaal Yahas asked for clarification about the behavior of the
<code>caller</code> builtin. Larry provided it.</p>

<h4><a
href="http://aspn.activestate.com/ASPN/Mail/Message/perl6-language/2619327">Musing
on Registerable Event Handlers for Some Specific Events</a></h4>

<p>Adam Kennedy hoped that Perl 6 would have some sort of minimal set of hooks
for handling events. (Personally, I'd like a maximal set of hooks for anything
that changes the runtime structure of Perl, but I'm greedy like that.) Larry
said that there would be such a thing, but that it wasn't designed yet. He
appeared to volunteer Adam as an initial designer.  Discussion ensued, but
there's no concrete design yet. Slightly tangentially, Dan discussed his <a
href="http://www.sidhe.org/~dan/blog/archives/000414.html">thoughts about a
Parrot notifications manager</a> on his blog, which might be useful to
some.</p>

<h4><a
href="http://aspn.activestate.com/ASPN/Mail/Message/perl6-language/2621258">Speed Bump
Placement</a></h4>

<p>In a thread discussing adding an <code>eval STRING</code>-type behavior to
the right-hand side of a substitution, Larry said that &quot;Deciding where (and
where not) to put the speed bumps is a pretty good description of my job. It's
impossible to have a language without bumps, so I reserve the right to put the
necessary bumps where I think they'll do the most good and/or least harm.&quot;</p>

<p>Well, I thought that was worth reading by more than just the list
subscribers.</p>

<h4><a
href="http://aspn.activestate.com/ASPN/Mail/Message/perl6-language/2622814">MMD
Vs. Anonymous Parameter Types Referencing Early Parameters</a></h4>

<p>Chip threw up his hands and despaired of ever efficiently implementing:</p>

<pre><code>  multi sub is_equal(Integer $a, Integer where { $_ == $a } $b: ) { 1 }</code></pre>

<p>Which is cute, but Chip claims you need Jedi mind powers if you want to make
it work.</p>

<p>Then Thomas Sandla&szlig; popped up to say that actually, there was already a
language called Cecil that allowed you to do precisely that sort of thing
(called Predicate Dispatch) and there were several efficient implementation
strategies. After a nudge from Chip, he even provided a link. Larry thought it
eminently doable, too, and sketched out a strategy.</p>

<p>That strategy (which applies almost everywhere in Perl, when you think about)
boils down to &quot;If you can't do it at compile time, do it at runtime (and
pretend you did it at runtime).&quot;</p>

<h4><a
href="http://aspn.activestate.com/ASPN/Mail/Message/perl6-language/2620863">State
of the Design Documents</a></h4>

<p>Joshua Gatcomb worries about the state of the synopses. He argued (quite
persuasively) that the thing to do would be to put the synopses into public
change control with global read access, but with write access limited to
@Larry. The community could then provide new documentation in the form of
patches, which @Larry would approve, reject, or modify as appropriate, which all
hangs on whether @Larry has sufficient tuits.</p>

<p>Patrick pointed out that this already exists and that he had volunteered as
gatekeeper and patch dispatcher, but that there were very few patches so far.
But now you all know about it, right?</p>

<p>Some discussion followed about how to flesh out things, but the important
thing is the <a href="http://svn.perl.org/perl6/doc/trunk">Perl 6 design
document repository</a> URL.</p>

<h4><a
href="http://aspn.activestate.com/ASPN/Mail/Message/perl6-language/2621742">How
Much Do We Close Over?</a></h4>

<p>Piers Cawley wants to be able to write code like:</p>

<pre><code>sub foo { my $x = 1; return sub { eval $^codestring } }
say foo().('$x'); # 1</code></pre>

<p>In Perl 5, this gives warnings about an undeclared variable. Chip maintained
that this is actually the Right Thing. Piers understood that it may not be the
right thing in all cases, but he wanted to be able to make it work when needed,
if necessarily, with predeclaration. There was some discussion, but nothing from
@Larry yet.</p>

<h4><a
href="http://aspn.activestate.com/ASPN/Mail/Message/perl6-language/2622126"><code>BEGIN
{...}</code> and IO</a></h4>

<p>Ingo Blechschmidt noted that that <code>BEGIN {...}</code> can be a little
scary when you want to compile to bytecode. Consider:</p>

<pre><code>my $fh = BEGIN { open &quot;some_file&quot; err ... }</code></pre>

<p>This is okay, until you have a version of Perl that compiles that to
bytecode. The response ran along the lines of &quot;Don't do that, then!&quot;</p>

<p>Personally I'd write that as:</p>

<pre><code>my $fh = INIT { open &quot;some_file&quot; err ... }</code></pre>

<p>Assuming that my recollection that <code>INIT</code> blocks happen after the
code is compiled but before it starts to run--or do I mean a
<code>CHECK</code> block?</p>

<h4><a
href="http://aspn.activestate.com/ASPN/Mail/Message/perl6-language/2622133">Anonymous
Macros</a></h4>

<p>Ingo also wondered if anonymous macros (at compile time) were allowed.
Larry had no problem with macros being first-class objects during the compile.
He also went on to wonder if they should be multidispatch, too.</p>

<h4><a
href="http://aspn.activestate.com/ASPN/Mail/Message/perl6-language/2622337">Perl Defined <code>Object</code>, <code>Array</code>, <code>Hash</code> Classes</a></h4>

<p>While toying with Pugs, Eric Hodges managed to overwrite the internal
definition of the <code>Object</code> class, which obviously caused him pain. Larry reckons
we'll have constructs like:</p>

<pre><code>class Object is augmented { ... };
class Object is replaced { ... };</code></pre>

<p>(names up for grabs). My personal preference is for making
<code>augmented</code> the default behavior, but I'll live if I can have a
pragma that makes it that way.</p>

<h4><code>%hash1 &raquo;...&laquo; %hash2</code></h4>

<p>David Formosa wondered about the behavior of hyperops when applied to a
pair of hashes. He wanted things arranged so that if you had a hash with keys
in common, then the hypering process would keep them together.  Luke agreed that
it would be useful (so do I, for that matter) and then everyone started talking
about inner and outer joins and my database comprehension head swapped out for
the moment.</p>

<h4>Binding Slices</h4>

<p>With a small correction for syntactical niceness, Piers wondered if:</p>

<pre><code>my @y := @foo[0...][1]</code></pre>

<p>would bind <code>@y</code> to a column of the two-dimensional matrix
represented by <code>@foo[][]</code>, so that writing to <code>@y</code> would
affect <code>@foo</code> and vice versa. @Larry hasn't said anything yet.</p>

<h4><a
href="http://aspn.activestate.com/ASPN/Mail/Message/perl6-language/2622775"><code>alias</code>
the RubyMeter</a></h4>

<p>B&Aacute;RTHAZI Andras wondered if Perl 6 would have something like Ruby's
rather lovely <code>alias</code>. Larry thought you should be able to write a
macro to do the job, but wasn't entirely sure how exactly it would be done.
Further discussion centered on whether the feature was a good idea and whether
it had the right name. One school of thought thinks it already exists as
<code>:=</code>, but I'm not quite so sure.</p>

<h4><a
href="http://aspn.activestate.com/ASPN/Mail/Message/perl6-language/2622877"><code>&amp;?CALLER::BLOCK</code>
Vs. Any Hope of Efficiency</a></h4>

<p>Chip hopes that using <code>&amp;?CALLER::BLOCK</code> as a general-purpose
block promoter will be disallowed unless the calling block has already marked
itself as callable. Larry thought that this would be okay, noting that he saw
<code>&amp;?CALLER::BLOCK</code> being mostly used for introspective
purposes.</p>

<h4><a
href="http://aspn.activestate.com/ASPN/Mail/Message/perl6-language/2622993">Creating
a Web Templating Engine</a></h4>

<p>Wow! Perl 6 isn't even finished, and already Andras is talking about writing
a web templating engine for it. He outlined his plan and wondered how to go
about implementing it. He and Ingo discussed it.</p>

<h4><a
href="http://aspn.activestate.com/ASPN/Mail/Message/perl6-language/2630895">Hyper
Concat</a></h4>

<p>Thomas Klausner has been playing with <code>&raquo;~&laquo;</code> and
uncovered some weirdness. Said weirdness lead to a discussion of <a
href="http://aspn.activestate.com/ASPN/Mail/Message/perl6-language/2658196">the
default strings/patterns in <code>split</code> and <code>join</code></a>.</p>

<h4><a
href="http://aspn.activestate.com/ASPN/Mail/Message/perl6-language/2710261"><code>sub
my_zip (...?) {}</code></a></h4>

<p>Autrijus worried that the current Pugs implementation of <code>zip</code>
was signatureless, which, among other things, makes it uncompilable to Parrot.
He wondered what its function signature should be.  Larry came up with the
(admittedly slightly weird) goods.</p>

<h4><a
href="http://aspn.activestate.com/ASPN/Mail/Message/perl6-language/2710606">Ignoring
Parameters</a></h4>

<p>Gaal Yahas wondered if he'd be able to write a class method as:</p>

<pre><code>method greet(Class undef:) {...}</code></pre>

<p>when his class methods made no references to the class object itself.
Damian thought that the syntax should actually be:</p>

<pre><code>method greet(FooClass ::class) {...}</code></pre>

<p>and that subs and methods should complain about unused non-optional
non-invocant parameters. There's more; see the sub for details.</p>

<h4><a
href="http://aspn.activestate.com/ASPN/Mail/Message/perl6-language/2710912">Scalar
Dereferencing</a></h4>

<p>Autrijus wondered about the semantics of a scalar reference in the face of
stringification and numification. He provided an example of Pugs' current
behavior that may or may not be correct. Larry described broken behavior
before thinking again and describing the really correct behavior, along with a
summary of his raccoon problems.</p>

<h4><a
href="http://aspn.activestate.com/ASPN/Mail/Message/perl6-language/2711310">Taking
<code>given</code> as Read</a></h4>

<p>Piers wondered how to write a function that would look like a
<code>given</code> block to any <code>when</code>s inside of it. It turns out that
you can't, yet. Damian thought that the right way to do it would be:</p>

<pre><code>sub factorial (Int $n is topic) {
  return 1 when 0;
  $n * factorial($n - 1);
}</code></pre>

<p>Reading this again, I find myself wondering if the <code>return</code> is
really necessary.</p>

<h4>
<code>./method</code>
</h4>

<p>People don't like <code>./method</code>. Other people don't like
<code>.method</code> in methods. I think we have what we have on the &quot;least
worst option&quot; principle--but I would say that I don't like
<code>./method</code>.</p>

<h4><a
href="http://aspn.activestate.com/ASPN/Mail/Message/perl6-language/2713984"><code>AUTOLOAD</code>
and <code>$_</code></a></h4>

<p>Sam Vilain wondered about the prototype of <code>AUTOLOAD</code>. In the
discussion that ensued, some people felt that whatever happened,
<code>AUTOLOAD</code> should return a code ref that <em>perl</em> would
call.</p>

<h3>Th-Th-The-That's All, Folks!</h3>

<p>I remember now why I gave up writing summaries in the first place. First, I
started missing weeks, which meant that there was so much to write up in the
fortnightly summaries, and then discussions grew interesting, which meant
writing them took so much longer because there were hard things to understand
first.</p>

<p>Still, once in a while is refreshing, but I really should stop putting
things off until the last minute.</p>

<p>Ahem.</p>

<p>If you find these summaries useful or enjoyable, please consider
contributing to the Perl Foundation to help support the development of
Perl.</p>

<ul>

<li><a href="http://donate.perl-foundation.org/">The Perl Foundation</a></li>
<li><a href="http://dev.perl.org/perl6/">Perl 6 Development site</a></li>

</ul>

<p>Or, you can check out <a href="http://www.bofh.org.uk/">my website</a>.
Maybe now I'm back writing stuff I'll start updating it.  There are also <a
href="http://www.flickr.com/photos/pdcawley">vaguely pretty photos by
me</a>.</p>

<!-- sidebar begins -->
 <csperl file="grab" domain="on" record="b/1714" template="b/article_sidebar2.view">
<!-- sidebar ends -->

        </div>



    </div>
    <div class="asset-footer"></div>
</div>


                            
                            <div id="entry-784" class="entry-asset asset hentry">
    <div class="asset-header">
        <h2 class="asset-name entry-title"><a href="/pub/2005/06/23/sprog.html" rel="bookmark">Data Munging with Sprog</a></h2>
        <div class="asset-meta">
            <span class="byline">
    
                By <span class="vcard author">Grant McLean</span> on <abbr class="published" title="2005-06-23T00:00:00-08:00">June 23, 2005 12:00 AM</abbr>
    
            </span>

            
            

        </div>
    </div>
    <div class="asset-content entry-content">

        <div class="asset-body">
            
<!-- sidebar begins -->
<!-- don't move sidebars-->
<!-- sidebar ends -->
<br clear="all" />
<p>We've all been there--a data translation problem rears its head and you
reach for your toolkit of Perl snippets. It might involve parsing a CSV file,
extracting MIME attachments, generating bulk SQL insert statements, or scraping
data from a web application. You know you have code lying around that'll take
you halfway there, if only you could find it. Then there's the problem of
pulling it all together.</p>

<p>Wouldn't it be great if there was a way to catalog your code snippets?
How about a way to browse or search by keyword, a way to modularize your code
for easy reuse, and a way to document it and easily access that documentation?
Wouldn't it be even better if you could pull the pieces together to assemble a
solution without having to actually write code at all?</p>

<p>Now there is. Now there's Sprog.</p>

<h3>The Assignment</h3>

<p>Picture yourself as a sysadmin at Example Corp. Your boss calls you in to
say he's setting up an LDAP server and he needs you to whip up an Lightweight Directory Interchange Format (LDIF) file, containing every employee's
name, phone number, and email account information. Oh, and he needs it this
afternoon, so you'd better get typing.</p>

<p>You sit back down at your desk to contemplate your fate. Who ya gonna call?
The answer hits you--the company phone list on the intranet! It has all of the
information you need (Figure 1); you just need to get it out.</p>

<p><img src="/pub/2005/06/23/graphics/phonelist.gif" width="500" height="367" alt="Phone List Web Page" /><br /><em>Figure 1. The
company phone list web page</em></p>

<h3>Getting Started</h3>

<p>With a second flash of inspiration, you download the latest version of <a
href="http://sprog.sourceforge.net/">Sprog</a>. You install the Perl Gtk
bindings and a few other modest prerequisites and before you know it, you're
looking at a clean green GUI (Figure 2).</p>

<p><img src="/pub/2005/06/23/graphics/01_workbench.gif" width="500" height="367" alt="The Sprog Workspace" /><br /><em>Figure 2.
The Sprog workspace</em></p>

<p>A quick scan of the palette on the left reveals something labeled Retrieve
URL, which sounds like a good start. Reading the instructions at the bottom of
the window, you learn that the thing is a gear and that you can drag it across
and drop it on the workspace.</p>

<p>Having dragged the gear onto the workspace, you right-click on it and select
Properties. Up pops a properties dialog (Figure 3), with a handy box where you
paste in the URL of the phone list.</p>

<p><img src="/pub/2005/06/23/graphics/02_properties.gif" width="500" height="368" alt="A properties dialog" /><br /><em>Figure 3.
A properties dialog</em></p>

<p>Next, you drag across the Text Window gear from the palette and drop it on
top of the Retrieve URL gear. It snaps reassuringly into position so that the
two gears' connectors fasten together securely (Figure 4).</p>

<p><img src="/pub/2005/06/23/graphics/03_interlocked.gif" width="250" height="94" alt="Two gears connected together" /><br
/><em>Figure 4. Two gears connected together</em></p>

<a href="http://conferences.oreillynet.com/os2005/"><img src="http://conferences.oreillynet.com/images/os2005/banners/120x240.gif" width="120" height="240" hspace="10" vspace="10" border="0" alt="O'Reilly Open Source Convention 2005." align="right" /></a>

<p>When you click the Run button on the toolbar, the machine leaps into life.
The gears turn, it retrieves data, and a text window appears to display the
HTML of the phone list page. Okay, great, you haven't written a line of code and
already you've replicated your browser's View Source function.</p>

<p>You save the machine to a file called <em>phonelist.sprog</em> and then look
for the next clue.</p>

<h3>Making Connections</h3>

<p>Returning to the palette, you find a gear labelled Parse HTML Table. It
looks promising, so you drag it onto the workbench. You pull apart the first
two gears and attempt to add the new one in between them. Unfortunately, the
new gear has a funny shaped output connector and the Text Window gear doesn't
seem to fit onto it.</p>

<p>You right-click on the new gear and select Help. From the help page you
learn that the output connector is a list connector. The gear takes a stream of
HTML text and outputs rows of data, where each row is a list of values plucked
from adjacent table cells.</p>

<p>Once more, back at the palette, you discover a List To CSV gear, which has an
input connector to match the table parser and an output connector to match the
text window gear. You drag it over and snap them all together (Figure 5).</p>

<p><img src="/pub/2005/06/23/graphics/04_to_csv.gif" width="250" height="152" alt="Machine to produce CSV" /><br /><em>Figure 5.
A machine to produce CSV</em></p>

<p>Now when you run the machine again, the text window fills with lovely CSV
data. It's not that you want CSV data, of course, but at least you can see that
the machine has parsed the relevant data out from the HTML page. Or has it?</p>

<p>On closer inspection, you realize that the machine has parsed the wrong
table from the HTML. In true 1998 style, the page designer used nested tables
to lay out the page. Even the list of navigation links is a table. Oh dear!</p>

<p>The properties dialog for the Parse HTML Table gear allows you to specify
which table you want to parse. The help page explains that you can enter just a
number (such as 2 for the second table) or an XPath expression. There's even an
example XPath expression which you can cut and paste to select a table based on
the contents of the first cell in the first row:</p>

<pre><code>//table[./tr[1]/th[1 and contains(text(), 'First Name')]]</code></pre>

<p>As it happens, a bit of trial and error reveals that the phone list data is
in the third table, so you set the selector to <code>3</code>.  Now when you run the
machine, you see exactly the data you want in beautiful CSV format (not that
you want CSV data, of course).</p>

<p>Hang on! The data still isn't quite right. The data values don't contain any
HTML tags, but they do seem to have lots of leading and trailing white space and
embedded newlines. Racing back to the palette, you grab the Strip Whitespace
gear, slot it into your machine and tweak its properties to specify exactly
which white space you want stripped. Now when you run the machine again, you do
get truly lovely CSV data (Figure 6).</p>

<p><img src="/pub/2005/06/23/graphics/05_lovely_csv.gif" width="491" height="266" alt="CSV output" /><br /><em>Figure 6. CSV
output</em></p>

<p>Of course, there's no getting away from the fact that you still don't want
CSV data.</p>

<h3>What Were You Trying To Do, Again?</h3>

<!-- sidebar begins -->
<table width="220" border="0" cellspacing="8" cellpadding="4" align="right">
<tr>
<td width="220" valign="top" bgcolor="#efefef">
<div class="secondary"><p>Did you know?  Your email client can import LDIF files into your address
book.</p>

<p>To import an LDIF file into your Thunderbird address book:</p>

<ol>

  <li>Open your address book.</li>

  <li>Select Tools -&gt; Import.</li>

  <li>Select Address Books and then Next.</li>

  <li>Select "Text file (LDIF ...)" and then Next.</li>

  <li>Select the LDIF file created from Sprog and then Open.</li>

  <li>Select Finish.</li>

</ol></div>
</td></tr></table>
<!-- sidebar ends -->


<p>Remembering your original orders, you do a bit of reading about LDIF files.
Your research shows that LDIF is a fairly simple text format. You need to
generate a text file with an entry for each person separated by blank lines and
formatted something like:</p>

<pre><code>dn: uid=cat,ou=Staff,ou=People,dc=example,dc=com
objectClass: person
objectClass: inetOrgPerson
cn: Catherine Trenton
uid: cat 
sn: Trenton
givenName: Catherine
mail: cat@example.com
organizationName: Example Corp
telephoneNumber: 555-2349
mobileTelephoneNumber: 555-9623</code></pre>

<p>This looks like a job for a template, and sure enough, you find a gear
entitled Apply Template (TT2) in the palette. The template gear's input
connector is unlike either the pipe or the list connectors you've encountered
so far. The help page tells you it's a record connector that passes data using
Perl hashes rather than arrays.</p>

<p>Back on the palette, you find a handy gear called "List to Record" that
automagically converts lists to records by assuming the first row contains
a column heading, which it uses for field names (hash keys). You remove the List
To CSV gear and replace it with "List to Record," followed by the Apply
Template (TT2) gears.  With a few clicks and drags, you reassemble your machine
into its &quot;almost final&quot; shape (Figure 7).</p>

<p><img src="/pub/2005/06/23/graphics/06_template_gear.gif" width="250" height="207" alt="Machine including template gear" /><br
/><em>Figure 7. Machine including template gear</em></p>

<p>In the properties dialog for the template gear, you add a template:</p>

<pre><code>dn: uid=[% email %],ou=Staff,ou=People,dc=example,dc=com
objectClass: person
objectClass: inetOrgPerson
cn: [% first_name %] [% surname %]
uid: [% email %]
sn: [% surname %]
givenName: [% first_name %]
mail: [% email %]
organizationName: Example Corp
telephoneNumber: [% phone %]
mobileTelephoneNumber: [% cell %]</code></pre>

<p>The results are almost exactly what you want, except that there are a couple
of places where you wanted a <code>uid</code> field and the closest you had available was
<code>email</code>. You need to strip out the <code>@example.com</code> from the <code>dn</code> and <code>uid</code>
lines. You unplug the Text Window gear and insert a "Find and Replace" gear to
fix the first occurrence (Figure 8):</p>

<p><img src="/pub/2005/06/23/graphics/07_fix_dn.gif" width="340" height="199" alt="Find/replace to fix dn" /><br /><em>Figure 8.
Adding a "Find and Replace" gear</em></p>

<p>and another one to fix the second (Figure 9):</p>

<p><img src="/pub/2005/06/23/graphics/08_fix_uid.gif" width="340" height="199" alt="Find/replace to fix uid" /><br />
<em>Figure 9. Adding another "Find and Replace" gear</em></p>

<p>and now the output is exactly like what you wanted (Figure 10).</p>

<p><img src="/pub/2005/06/23/graphics/09_final_output.gif" width="491" height="330" alt="Final output" /><br /><em>Figure 10.
Final output</em></p>

<p>You swap out the Text Window gear for a Write File gear, select a filename,
and run the machine one last time (Figure 11).</p>

<p><img src="/pub/2005/06/23/graphics/10_final_machine.gif" width="250" height="264" alt="Final machine" /><br /><em>Figure 11. The final machine</em></p>

<p>You've finished the job and you never had to touch your semicolon key
once.</p>

<h3>More About Sprog</h3>

<p>I hope this article has given you some idea of what's possible with Sprog.
It can be a useful addition to the toolbox of people who write scripts to
transform data. Beyond that, though, I intend it to be a useful tool for people
who don't write scripts--<em>scripting for the GUI guys</em>, if you will.
Anyone who's smart enough to drive a spreadsheet is smart enough to drive
Sprog.  It's just a different way of working with data. Even if the only thing
those people use it for is getting data into a form their spreadsheets can
handle, then that's surely useful.</p>

<p>Sprog is under active development, with the framework being extended and new
gears added all the time. Writing your own gears is easier than you might
imagine, and there is a mailing list to ask questions and share your ideas.</p>

<ul>
<li><a href="http://sprog.sourceforge.net">Sprog project</a></li>
<li><a href="http://lists.sourceforge.net/lists/listinfo/sprog-users">Sprog mailing
list</a></li>
<li><a href="/2005/06/23/examples/files.tar.gz">Article example files</a></li>

</ul>

        </div>



    </div>
    <div class="asset-footer"></div>
</div>


                            
                            <div id="entry-782" class="entry-asset asset hentry">
    <div class="asset-header">
        <h2 class="asset-name entry-title"><a href="/pub/2005/06/16/iterators.html" rel="bookmark">Understanding and Using Iterators</a></h2>
        <div class="asset-meta">
            <span class="byline">
    
                By <span class="vcard author">Joshua Gatcomb</span> on <abbr class="published" title="2005-06-16T00:00:00-08:00">June 16, 2005 12:00 AM</abbr>
    
            </span>

            
            

        </div>
    </div>
    <div class="asset-content entry-content">

        <div class="asset-body">
            
<!-- sidebar begins -->
<!-- don't move sidebars-->
<!-- sidebar ends -->
<p>The purpose of this tutorial is to give a general overview of what 
iterators are, why they are useful, how to build them, and things to consider to
avoid common pitfalls. I intend to give the reader enough information to
begin using iterators, though this article assumes some understanding of idiomatic Perl
programming. Please consult the "<a href="#see_also">See Also</a>" section if you
need supplemental information.</p>

<h3>What Is an Iterator?</h3>

<p>Iterators come in many forms, and you have probably used one without even
knowing it. The <code>readline</code> and <code>glob</code> functions, as well
as the flip-flop operator, are all iterators when used in scalar context. A user-defined iterator usually takes the form of a code reference that, when
executed, calculates the next item in a list and returns it.  When the iterator
reaches the end of the list, it returns an agreed-upon value.  While
implementations vary, a subroutine that creates a closure around any necessary
state variables and returns the code reference is common. This technique is
called a <i>factory</i> and facilitates code reuse.</p>

<h3>Why Are Iterators Useful?</h3>

<p>The most straightforward way to use a list is to define an algorithm to
generate the list and store the results in an array.  There are several reasons
why you might want to consider an iterator instead:</p>

<!-- sidebar begins -->
 <csperl file="grab" domain="on" record="b/1754" template="b/article_sidebar.view">
<!-- sidebar ends -->

<ul>

<li><p>The list in its entirety would use too much memory.</p>

<p>Iterators have tiny memory footprints, because they can store only the state
information necessary to calculate the next item.</p></li>

<li><p>The list is infinite.</p>

<p>Iterators return after each iteration, allowing the traversal of an infinite
list to stop at any point.</p></li>

<li><p>The list should be circular.</p>

<p>Iterators contain state information, as well as logic allowing a list to wrap
around.</p></li>

<li><p>The list is large but you only need a few items.</p>

<p>Iterators allow you to stop at any time, avoiding the need to calculate any
more items than is necessary.</p></li>

<li>The list needs to be duplicated, split, or variated.</p>

<p>Iterators are lightweight and have their own copies of state
variables.</p></li>

</ul>

<h3>How to Build an Iterator</h3>

<p>The basic structure of an iterator factory looks like this:</p>

<pre><code>sub gen_iterator {
    my @initial_info = @_;

    my ($current_state, $done);

    return sub {
        # code to calculate $next_state or $done;
        return undef if $done;
        return $current_state = $next_state;   
    };
}</code></pre>

<p>To make the factory more flexible, the factory may take arguments to decide
how to create the iterator. The factory declares all necessary state variables
and possibly initializes them.  It then returns a code reference--in the same
scope as the state variables--to the caller, completing the transaction. Upon
each execution of the code reference, the state variables are updated and the
next item is returned, until the iterator has exhausted the list.</p>

<p>The basic usage of an iterator looks like this:</p>

<pre><code>my $next = gen_iterator( 42 );
while ( my $item = $next-&gt;() ) {
    print &quot;$item\n&quot;;
}</code></pre>

<h4>Example: The List in Its Entirety Would Use Too Much Memory</h4>

<p>You work in genetics and you need every possible sequence of DNA strands of
lengths 1 to 14. Even if there were no memory overhead in using arrays, it would
still take nearly five gigabytes of memory to accommodate the full list. Iterators
come to the rescue:</p>

<pre><code>my @DNA = qw/A C T G/;
my $seq = gen_permutate(14, @DNA);
while ( my $strand = $seq-&gt;() ) {
    print &quot;$strand\n&quot;;
}

sub gen_permutate {
    my ($max, @list) = @_;
    my @curr;
    return sub {
        if ( (join '', map { $list[ $_ ] } @curr) eq $list[ -1 ] x @curr ) {
            @curr = (0) x (@curr + 1);
        }
        else {
            my $pos = @curr;
            while ( --$pos &gt; -1 ) {
                ++$curr[ $pos ], last if $curr[ $pos ] &lt; $#list;
                $curr[ $pos ] = 0;
            }
        }
        return undef if @curr &gt; $max;
        return join '', map { $list[ $_ ] } @curr;
    };
}</code></pre>

<h4>Example: The List Is Infinite</h4>

<p>You need to assign IDs to all current and future employees and ensure that
it is possible to determine if an ID is valid with nothing more than the number
itself. You have already taken care of persistence and number validation (using
the <a href="http://www.webopedia.com/TERM/L/Luhn_formula.html">LUHN
formula</a>).  Iterators take care of the rest:</p>

<pre><code>my $start = $ARGV[0] || 999999;
my $next_id = gen_id( $start );
print $next_id-&gt;(), &quot;\n&quot; for 1 .. 10;  # Next 10 IDs

sub gen_id {
    my $curr = shift;
    return sub {
        0 while ! is_valid( ++$curr );
        return $curr;
    };
}

sub is_valid {
    my ($num, $chk) = (shift, '');
    my $tot;
    for ( 0 .. length($num) - 1 ) {
        my $dig = substr($num, $_, 1);
        $_ % 2 ? ($chk .= $dig * 2) : ($tot += $dig);
    }

    $tot += $_ for split //, $chk;

    return $tot % 10 == 0 ? 1 : 0;
}</code></pre>

<h4>Example: The List Should Be Circular</h4>

<p>You need to support legacy apps with hardcoded filenames, but want to keep
logs for three days before overwriting them. You have everything you need
except a way to keep track of which file to write to:</p>

<pre><code>my $next_file = rotate( qw/FileA FileB FileC/ );
print $next_file-&gt;(), &quot;\n&quot; for 1 .. 10;

sub rotate {
    my @list  = @_;
    my $index = -1;

    return sub {
        $index++;
        $index = 0 if $index &gt; $#list;
        return $list[ $index ];
    };
}</code></pre>

<p>Adding one state variable and an additional check would provide the ability
to loop a user-defined number of times.</p>

<h4>Example: The List Is Large But Only a Few Items May Be Needed</h4>

<p>You have forgotten the password to your DSL modem and the vendor charges
more than the cost of a replacement to unlock it.  Fortunately, you remember 
that it was only four lowercase characters:</p>

<pre><code>while ( my $pass = $next_pw-&gt;() ) {
    if ( unlock( $pass ) ) {
        print &quot;$pass\n&quot;;
        last;
    }
}

sub fix_size_perm {

    my ($size, @list) = @_;
    my @curr          = (0) x ($size - 1);

    push @curr, -1;

    return sub {
        if ( (join '', map { $list[ $_ ] } @curr) eq $list[ -1 ] x @curr ) {
            @curr = (0) x (@curr + 1);
        }
        else {
            my $pos = @curr;
            while ( --$pos &gt; -1 ) {
                ++$curr[ $pos ], last if $curr[ $pos ] &lt; $#list;
                $curr[ $pos ] = 0;
            }
        }

        return undef if @curr &gt; $size;
        return join '', map { $list[ $_ ] } @curr;
    };
}

sub unlock { $_[0] eq 'john' }</code></pre>

<h4>Example: The List Needs To Be Duplicated, Split, or Modified into Multiple
Variants</h4>

<p>Duplicating the list is useful when each item of the list requires multiple
functions applied to it, if you can apply them in parallel. If there is only
one function, it may be advantageous to break the list up and run duplicate
copies of the function. In some cases, multiple variations are necessary, which
is why factories are so useful. For instance, multiple lists of different
letters might come in handy when writing a crossword solver.</p>

<p>The following example uses the idea of breaking up the list to enhance the
employee ID example.  Assigning ranges to departments adds additional meaning
to the ID.</p>

<pre><code>my %lookup;

@lookup{ qw/sales support security management/ }
    = map { { start =&gt; $_ * 10_000 } } 1..4;

$lookup{$_}{iter} = gen_id( $lookup{$_}{start} ) for keys %lookup;

# ....

my $dept = $employee-&gt;dept;
my $id   = $lookup{$dept}{id}();
$employee-&gt;id( $id );</code></pre>

<h3>Things To Consider</h3>

<h4>The iterator's <code>@_</code> is Different Than the Factory's</h4>

<p>The following code doesn't work as you might expect:</p>

<pre><code>sub gen_greeting {
    return sub { print &quot;Hello &quot;, $_[0] };
}

my $greeting = gen_greeting( 'world' );
$greeting-&gt;();</code></pre>

<p>It may seem obvious, but closures need lexicals to close over, as each
subroutine has its own <code>@_</code>. The fix is simple:</p>

<pre><code>sub gen_greeting {
    my $msg = shift;
    return sub { print &quot;Hello &quot;, $msg };
}</code></pre>

<h4>The Return Value Indicating Exhaustion Is Important</h4>

<p>Attempt to identify a value that will never occur in the list.
Using <em>undef</em> is usually safe, but not always. Document your choice
well, so calling code can behave correctly.  Using <code>while ( my $answer =
$next-&gt;() ) { ... }</code> would result in an infinite loop if 42 indicated
exhaustion.</p>

<p>If it is not possible to know in advance valid values in the list, allow
users to define their own values as an argument to the factory.</p>

<h4>References to External Variables for State May Cause Problems</h4>

<p>Problems can arise when factory arguments needed to maintain state are
references. This is because the variable being referred to can have its value
changed at any time during the course of iteration. A solution might be to
de-reference and make a copy of the result. In the case of large hashes or
arrays, this may be counterproductive to the ultimate goal. Document your
solution and your assumptions so that the caller knows what to expect.</p>

<h4>You May Need to Handle Edge Cases</h4>

<p>Sometimes, the first or the last item in a list requires more logic than the
others in the list.  Consider the following iterator for the Fibonacci
numbers:</p>

<pre><code>sub gen_fib {
    my ($low, $high) = (1, 0);

    return sub {
        ($low, $high) = ($high, $low + $high);
        return $high;
    };
}

my $fib = gen_fib();
print $fib-&gt;(), &quot;\n&quot; for 1 .. 20;</code></pre>

<p>Besides the funny initialization of <code>$low</code> being greater than
<code>$high</code>, it also misses <code>0</code>, which should be the first item returned.
Here is one way to handle it:</p>

<pre><code>sub gen_fib {

    my ($low, $high) = (1, 0);

    my $seen_edge;

    return sub {
        return 0 if ! $seen_edge++;
        ($low, $high) = ($high, $low + $high);
        return $high;
    };
}</code></pre>

<h4>State Variables Persist As Long As the Iterator</h4>

<p>Reaching the end of the list does not necessarily free the iterator and
state variables. Because Perl uses reference counting for its garbage
collection, the state variables will exist as long as the iterator does.</p>

<p>Though most iterators have a small memory footprint, this is not always the
case. Even if a single iterator doesn't consume a large amount of memory, it
isn't always possible to forsee how many iterators a program will create.  Be
sure to document how the caller can destroy the iterator when necessary.</p>

<p>In addition to documentation, you may also want to <code>undef</code> the state variables at
exhaustion, and perhaps warn the caller if the iterator is being called after
exhaustion.</p>

<pre><code>sub gen_countdown {
   my $curr = shift;

   return sub {
       return $curr++ || 'blast off';
   }
}

my $t = gen_countdown( -10 );
print $t-&gt;(), &quot;\n&quot; for 1..12; # off by 1 error</code></pre>

<p>Becomes:</p>

<pre><code>sub gen_countdown {
   my $curr = shift;

   return sub {
       if ( defined $curr &amp;&amp; $curr == 0 ) {
           undef $curr, return 'blast off';
       }

       warn 'List already exhausted' and return if ! $curr;

       return $curr++;
   }
}</code></pre>

<h3><a id="see_also">See Also</a></h3>

<ul>

<li>"<a href="http://perlmonks.org/?node_id=268891">Closure on Closures</a>," by
<a href="http://perlmonks.org/?node=broquaint">broquaint</a></li>

<li>"<a href="http://perlmonks.org/index.pl?node_id=458418">Recursively
Generated Iterators</a>," by <a
href="http://perlmonks.org/index.pl?node_id=300037">Roy Johnson</a></li>

<li><a href="http://perldoc.perl.org/perlsub.html"><code>perlsub</code></a> (<code>perldoc
perlsub</code>)</li>

<li><a href="http://perldoc.perl.org/functions/glob.html"><code>glob</code></a> (<code>perldoc
-f glob</code>)</li>

<li>"<a href="http://perldoc.perl.org/perlop.html#Range-Operators">Range
Operators</a>" (<code>perldoc perlop</code>)</li>

<li><a href="http://perl.plover.com/hop/">Higher Order Perl</a>, by <a
href="http://perlmonks.org/?node=Dominus">Dominus</a><br />
A great book that covers the concept of iterators and a whole
lot more.</li>

</ul>


        </div>



    </div>
    <div class="asset-footer"></div>
</div>


                            
                            <div id="entry-790" class="entry-asset asset hentry">
    <div class="asset-header">
        <h2 class="asset-name entry-title"><a href="/pub/2005/06/p6pdigest/20050608.html" rel="bookmark">This Week in Perl 6, June 1-7, 2005</a></h2>
        <div class="asset-meta">
            <span class="byline">
    
                By <span class="vcard author">Piers Cawley</span> on <abbr class="published" title="2005-06-09T00:00:00-08:00">June  9, 2005 12:00 AM</abbr>
    
            </span>

            
            

        </div>
    </div>
    <div class="asset-content entry-content">

        <div class="asset-body">
            
<!-- sidebar begins -->
<!-- don't move sidebars-->
<!-- sidebar ends -->
<p>Crumbs. I've remembered to write the summary this week. Now if I can just
remember to bill O'Reilly for, err, 2003's summaries. Heck, it's not like
waiting for the dollar to get stronger has paid off.</p>

<p>Ah well, no use crying over spilled milk. On with the show. Maybe, just maybe,
<code>darwinports</code> will work its magic and I'll have a working Haskell compiler by the
time I've finished writing.</p>

<h3>This Week in <i>perl6-compiler</i></h3>

<h4><a
href="http://groups.google.com/groups?threadm=20050601002444.GB32060@wall.org"><code>undef</code>
Issues</a></h4>

<p>I'd probably forgotten this, but Larry pointed out that in Perl 6 there will
no longer be a function <code>undef()</code> and a value <code>undef</code>.
Instead there'll be a function <code>undefine()</code> and a value
<code>undef</code>, but he thinks that we should usually <code>fail()</code> to
construct our undefined values.</p>

<h3>This Week in <i>perl6-internals</i></h3>

<h4><a
href="http://groups.google.com/groups?threadm=20050601021042.22209.qmail@web32914.mail.mud.yahoo.com">Keys</a></h4>

<p>I'm not sure I understood what TOGoS was driving at with a suggestion about
keys and properties. Luckily Leo, Dan, and Chip all seemed to. The discussion
continued through the week.</p>

<h4><a
href="http://groups.google.com/groups?threadm=45ec99fc050531202812aa4da9@mail.gmail.com">Loop
Improvements</a></h4>

<p>Oh no! It's the register allocator problems again. One of these days, I swear
I'm going to swot up on this stuff properly, work out whether it's really the
case that full continuations break any conceivable register allocator, and
summarize all of the issues for everyone in a nice white paper/summary.</p>

<h4><a
href="http://groups.google.com/groups?threadm=20050601114223.30367.qmail@lists.develooper.com">HP-UX
Build Notes</a></h4>

<p>Nick Glencross posted some of his issues with getting Parrot up on an HP-UX
machine. After a good deal of discussion and tool-chain fettling, he made things
build and posted a patch to fix the knowledge, which was promptly applied (r8280,
for those of you with the <code>svn</code> chops to know how to take advantage of that).</p>

<h4><a
href="http://groups.google.com/groups?threadm=Pine.LNX.4.44.0506011358160.20203-100000@booger.sixgeeks.org"><code>mod_pugs</code>
Status</a></h4>

<p>Jeff Horwitz announced that <code>mod_parrot</code> now comes bundled with <code>mod_pugs</code>,
which means that you can now write Apache extensions in Perl 6. I don't know
about you, but my mind is still boggling.</p>

<h4><a
href="http://groups.google.com/groups?threadm=42A18449.3060709@toetsch.at">Parrot
0.2.1</a></h4>

<p>Parrot spent most of the week in a feature freeze for the release of Parrot
0.2.1 &quot;APW,&quot; which went ahead as planned on the 4th of June.</p>

<h4><a
href="http://groups.google.com/groups?threadm=8C73533BEA34422-BD4-27EB1@mblk-r28.sysops.aol.com">Parrot
on Solaris</a></h4>

<p>Peter Sinnott reported problems with Parrot on Solaris. It turns out that
different implementations of <code>atan</code> behave slightly differently,
which isn't good. I believe the problem remains unresolved.</p>

<h4><a
href="http://groups.google.com/groups?threadm=ffcb1edd23308e83c738cd420c94e7c1@gmail.com">Parrot
on the Mac OS</a></h4>

<p>Joshua Juran's questions about getting Parrot running on Mac OS Classic went
Warnocked.</p>

<h4><a
href="http://groups.google.com/groups?threadm=1117736102.12568.25.camel@localhost">Parrot
Tests Get TODO</a></h4>

<p>Continuing the drive for consistent testing structures everywhere in Perl
land, Chromatic applied a patch to <code>Parrot::Test</code> that makes TODO
tests work in a way that <code>Test::Builder</code> understands. Hurrah!</p>

<h4><a
href="http://groups.google.com/groups?threadm=a06210200bec56c538a32@[192.168.0.8]">Missing
MMD Default Functions</a></h4>

<p>Dan was somewhat bemused to find that the MMD functions' defaults had
disappeared when he did a sync with <code>subversion</code>. He wondered whether this was
deliberate. Turns out that it was. I'm not sure whether Chip's ruled that it
was right, though.</p>

<h4><a
href="http://groups.google.com/groups?threadm=bbfd0f3e0506030500752b4585@mail.gmail.com">Google's
Summer of Code 2005</a></h4>

<p>Remember earlier when I talked about IMCC's register allocation?  Well,
Dheeraj Khumar Arora is looking at working on improving IMCC's optimizations as
part of Google's Summer of Code 2005. The usual thread ensued.</p>

<h4><a
href="http://groups.google.com/groups?threadm=20050603120906.10247.qmail@lists.develooper.com">Building
<em>nci/dynclasses</em> on HP-UX</a></h4>

<p>Not content with getting Parrot to build on HP-UX, Nick Glencross next set
his sights on making <em>nci/dynclasses</em> work on HP-UX. It sounds like
there'll be a patch forthcoming some time next week.</p>

<p><a
href="http://groups.google.com/groups?threadm=20050605160218.31074.qmail@lists.develooper.com">Nick
Paints the Big HP-UX Picture</a></p>

<h4><a
href="http://groups.google.com/groups?threadm=1118002708.9863.14.camel@eden">Announcing
Amber for Parrot 0.2.1</a></h4>

<p>Roger Browne announced another new language that targets Parrot: <a
href="http://xamber.org/">Amber</a>.  It borrows a good deal of syntax and
semantics from Eiffel, with a large sprinkling of Ruby for good measure.</p>

<h4><a
href="http://groups.google.com/groups?threadm=42A3F803.6040406@toetsch.at">A
note WRT exception handlers</a></h4>

<p>Leo posted a quick discussion of the correct use of exception handlers in
Parrot. Essentially, the rule is that your exception handler should jump back to
the point just after the exception handler block:</p>

<pre><code>    push_eh except_N
    # Code that might fail
    clear_eh
resume_N:
    ...
except_N:
    ...
    goto resume_N</code></pre>

<p>Easy, eh?</p>

<h3>Meanwhile in <i>perl6-language</i></h3>

<h4>The Reduce Metaoperator Thread</h4>

<p>Remember when I discussed this thread two weeks ago? It's still going
strong.</p>

<p>Larry ended up stating that there will be an optional property,
<code>identval</code>, on operators which will be set by default on all
operators with obvious identity values. Or it might be called
<code>initvalue</code>.</p>

<p><a
href="http://article.gmane.org/gmane.comp.lang.perl.perl6.language/3684">Larry
Makes Up His Mind</a></p>

<h4><a
href="http://article.gmane.org/gmane.comp.lang.perl.perl6.language/3551">Construction
Clarification</a></h4>

<p>Carl Franks wondered about how object constructors will work. It turned out
that the code he'd carefully written by hand pretty much described the default
behavior. Damian and Larry provided details. Hopefully, some keen p6porter has
already incorporated any new information into the appropriate Synopses.</p>

<h4><a
href="http://article.gmane.org/gmane.comp.lang.perl.perl6.language/3577">A
Comprehensive List of Perl 6 Rule Tokens</a></h4>

<p>Patrick responded to his own post last week to clarify some things about the
capturing behavior of various rule types. He, Japhy, and Thomas Sandla&szlig;
thrashed out the gory details.</p>

<h4><a
href="http://article.gmane.org/gmane.comp.lang.perl.perl6.language/3578">Default
Invocant of Methods</a></h4>

<p>Larry addressed Ingo Blechschmidt's questions about class methods.</p>

<p>Class is a role? My head hurts.</p>

<h4><a
href="http://article.gmane.org/gmane.comp.lang.perl.perl6.language/3579"><code>returns</code>
and Context</a></h4>

<p>Gaal Yahas wondered how to specify the signature of a context-sensitive
function. The consensus seems to be to use a junction, like so:</p>

<pre><code>sub foo() returns Str|Int {...}</code></pre>

<h4><a
href="http://article.gmane.org/gmane.comp.lang.perl.perl6.language/3556">Declarations
of Constants</a></h4>

<p>Adam Kennedy had wondered how much compile-time optimization of constants
would happen. Damian thought not as much as Adam thought, but suggested that he
could use macros to get more optimization if he needed it.</p>

<h4><a
href="http://article.gmane.org/gmane.comp.lang.perl.perl6.language/3558">Time
Functions</a></h4>

<p>The good thing about <code>localtime</code> et al. is that everyone knows
them. The bad thing about them is that they're at such a low level that you
either end up reinventing wheels, getting it wrong, or boggling at the size of
the library you need to install to get access to good time manipulation.  I
wonder what Perl 6 will end up with.</p>

<h4><a
href="http://article.gmane.org/gmane.comp.lang.perl.perl6.language/3600">Empty
Hash</a></h4>

<p>Luke wondered if <code>{}</code> should be an empty hash rather than empty
code, and why <code>{ %hash }</code> no longer makes a shallow copy of the
hash, but code that returns <code>%hash</code>. There was some discussion, but
no answers came from anyone else on the design team.</p>

<h4><a
href="http://article.gmane.org/gmane.comp.lang.perl.perl6.language/3631"><code>chars</code>
in a List Context</a></h4>

<p>Joshua Gatcomb revisited a long-Warnocked subject. He wants:</p>

<pre><code>@chars = 'hello'.chars; # &lt;h e l l o&gt;</code></pre>

<p>That is, in a list context, <code>chars</code> should return a list of the
characters in the string. Stuart Cook thought it was a good idea.</p>

<h4><a
href="http://article.gmane.org/gmane.comp.lang.perl.perl6.language/3517">Transparent/Opaque References</a></h4>

<p>Um ... I'm not sure what Thomas Sandla&szlig; and Juerd were talking about.
I'll tell you what, let's swap places: you read the thread and write me a
summary of it.</p>

<h4><a
href="http://article.gmane.org/gmane.comp.lang.perl.perl6.language/3645">Idea
for Making <code>@</code>, <code>%</code>, and <code>$</code> Optional</a></h4>

<p>Millsa Erlas wondered if it would be possible to make variable sigils
optional. The short answer is yes, with a pragma, and probably left for
CP6AN.</p>

<h4><a
href="http://article.gmane.org/gmane.comp.lang.perl.perl6.language/3647">Using
Rules</a></h4>

<p>B&Aacute;RTHAZI Andr&aacute;s wondered about using rules in a web templating
system he was working on. Aankhen supplied an answer.</p>

<p>(Look, it's two messages. Any summary I wrote that told you more than the
above sentence would be about as long as the original messages.)</p>

<h4><a
href="http://article.gmane.org/gmane.comp.lang.perl.perl6.language/3657">(Multi)Subroutine
Names</a></h4>

<p>Dakkar wondered how he could get at the long name of a multi sub. Rod Adams
thought it'd be:</p>

<pre><code>&amp;foo&lt;Array, Int&gt;
&amp;foo&lt;Hash, Int&gt;</code></pre>

<p>but also thought it might been changed. Thomas Sandla&szlig; agreed that it
had changed to:</p>

<pre><code>&amp;foo:(Array, Int)
&amp;foo:(Hash, Int)</code></pre>

<p>Easy.</p>

<h4><a
href="http://article.gmane.org/gmane.comp.lang.perl.perl6.language/3665">Flattening
Arguments</a></h4>

<p>B&Aacute;RTHAZI Andr&aacute;s wondered about the behavior of flattening
arguments in Pugs when compared to that described in <em>Perl 6 and Parrot
Essentials</em>.  Answer: The book's right, they're just not implemented in
Pugs.  Yet.</p>

<h4><a
href="http://article.gmane.org/gmane.comp.lang.perl.perl6.language/3685"><code>return()</code>
in Pointy Blocks</a></h4>

<p>Oh boy. Ingo Blechschmidt opened a can of worms when he asked about
<code>return</code> within pointy subs. However, because the worms were slow in
starting, you'll have to wait for Matt's summary next week when he
explains:</p>

<pre><code>sub callcc (Code $code) { $code(-&gt; $r {return $r}) }</code></pre>

<h3>Meanwhile, in Another Place</h3>

<p>Once upon a long time ago, Jon Orwant threw coffee cups and swore and Perl 6
was born. Later that afternoon, Dan Sugalski started doodling design sketches
for what was to become Parrot. Parrot's first <em>README</em> in CVS dates from
August 11th, 2001, and the first archived mailing list post is from August 1st, 2000, but that's a reply.</p>

<p>As well as being Parrot's original developer, Dan is also Parrot's first
commercial user.</p>

<p>Last week, he announced in his blog that, having already given up his
designer's hat earlier this year, <a
href="http://www.sidhe.org/~dan/blog/archives/000400.html">he's stopped doing
any Parrot development</a>.  The plan is that he'll be publishing a few design
documents and historical explanations of various bits of Parrot design on his
blog, but otherwise, that's all he wrote.</p>

<p>I'm not the first, and I'm sure I won't be the last to say this. Dan, thank
you very much for all the work you've put into Parrot over the years.  Good
luck with whatever you do next.</p>

<h3>The End ... for Now</h3>

<p>If you find these summaries useful or enjoyable, please consider
contributing to the Perl Foundation to help support the development of
Perl.</p>

<ul>

<li><a href="http://donate.perl-foundation.org/">The Perl Foundation</a></li>
<li><a href="http://dev.perl.org/perl6/">Perl 6 development site</a></li>

</ul>

<p>Or, you can check out <a href="http://www.bofh.org.uk/">my website</a>.
Maybe now I'm back writing stuff I'll start updating it.  There are also <a
href="http://www.flickr.com/photos/pdcawley"> vaguely pretty photos by
me</a>.</p>

<!-- sidebar begins -->
 <csperl file="grab" domain="on" record="b/1714" template="b/article_sidebar2.view">
<!-- sidebar ends -->

        </div>



    </div>
    <div class="asset-footer"></div>
</div>


                            
                            <div id="entry-780" class="entry-asset asset hentry">
    <div class="asset-header">
        <h2 class="asset-name entry-title"><a href="/pub/2005/06/09/ppi.html" rel="bookmark">Independently Parsing Perl</a></h2>
        <div class="asset-meta">
            <span class="byline">
    
                By <span class="vcard author">Adam Kennedy</span> on <abbr class="published" title="2005-06-09T00:00:00-08:00">June  9, 2005 12:00 AM</abbr>
    
            </span>

            
            

        </div>
    </div>
    <div class="asset-content entry-content">

        <div class="asset-body">
            
<!-- sidebar begins -->
<!-- don't move sidebars-->
<!-- sidebar ends -->
<br clear="all" />
<p>A few years into my programming career, I found myself involved in a
somewhat unusual web project for an enormous global IT company. Due to some odd
platform issues, we could  write the intranet half of the project
<em>only</em> in Perl and the almost-identical public internet half <em>only</em> in
Java.</p>

<p>In my efforts to pick up enough Java to help my Perl code interoperate with
the code from the Java guys, I stumbled on a relatively new editor with the
rather expansive name of JetBrains IntelliJ IDEA.</p>

<p>What a joy! It quite simply made learning Java an absolute pleasure, with
comprehensive tab completion, light and simple API docs, easy exploration of
the mountain of Java classes, and unobtrusive indicators showing me my mistakes
and offering to fix them. In short, it had lots of brains and a fast, clean
user interface.</p>

<h3>Where Is IntelliPerl?</h3>

<p>Although I only needed it heavily for a few months, it's been my gold
standard ever since, and my definition of what a &quot;great&quot; editor should be. I
install every new Perl editor and IDE I come across in the hope that Perl might
one day get an editor half as good as what Java has had for years.</p>

<!-- sidebar begins -->
 <csperl file="grab" domain="on" record="b/1714" template="b/article_sidebar.view">
<!-- sidebar ends -->

<p>These great editors are spreading. Java is now up to one and a half (Eclipse
is nearly great but still seems not quite &quot;effortless&quot; enough about what it
does). Dreamweaver gave HTML people their great editor years ago, and I've
heard that Python may now have something that qualifies.</p>

<p>Interestingly, these great editors seem to share one major thing in
common.</p>

<h3>How to Build a Great Editor</h3>

<p>Rather than relying on the language's parser to examine code, great editors
seem to implement special parsers of their own. These parsers treat a file less
like code and more like a generic document (that just also happens to be
code).</p>

<p>It's a key distinction, and one that provides two critical capabilities.</p>

<p>First, it creates a &quot;round-trip&quot; capability, parsing a file into an internal
model and back out again without moving a single white space character out of
place. Even if parts of a file are broken or badly formatted, you can still
change other parts of the file and save it correctly without it changing
anything you don't alter.</p>

<p>Second, it makes the parser extremely safe and error-tolerant. Any code open
in an editor is there for a reason--generally because it isn't finished yet,
is broken, or needs changing. A document parser can hit a problem, flag it,
stumble for a character or so until it finds something it recognizes, and then
continue on.</p>

<p>Parsing as code is an entirely different task, and one often unsuited to
these type of faults.</p>

<p>For example, take the following.</p>

<pre><code>print &quot;Hello World!\n&quot;;
  
}
  
MyModule-&gt;foobar;</code></pre>

<p>For an editor using Perl itself to understand this code, it's game over once
it hits the naked closing brace, because the code is invalid. Without knowledge
of what is below the brace, you lose all of the intelligence that needs the parser:
syntax highlighting, module checking, helpful tips, the lot.</p>

<p>It's just simply not a reasonable way to build an editor, where a file can
be both unfinished and have dozens of bugs.</p>

<h3>Building a Document Parser for Perl</h3>

<p>Even without an editor to put it in (yet), a document parser for Perl would
be extraordinarily useful for all sorts of tasks. At the time, though, all I
really wanted was a really accurate HTML syntax highlighter.</p>

<p>Some time in early 2002, I was bored one afternoon and had a first stab at
the problem. The result was pretty predictable, given patterns I've seen in
others trying the same thing. It was A) based on regular expressions, and B)
useless for anything even remotely interesting.</p>

<p>Between then and the start of The Perl Foundation grant in December 2004,
I've spent a day or so a month on the problem, rewriting and throwing away
code. I've junked two tokenizers, one lexer, an analysis package, three syntax
highlighters, an obfuscation package, a quote engine, and half of the classes
in the current object tree.</p>

<p>Now, finally, <a href="http://search.cpan.org/perldoc?PPI">PPI</a> is
complete, bar some minor features and testing. It is 100 percent round-trip safe, and
it's been stress tested against the 38,000 (non-Acme) modules in CPAN, handling
all but 28 of the most broken and bizarre.</p>

<h3>What Does It Do?</h3>

<p>PPI should be the basis for any task where you need to parse, analyze or
manipulate Perl, and it finally provides a platform for doing these tasks to
their full potential. This covers a huge range of possible tasks; far too many
to cover in any depth here.</p>

<p>For this article, I want to demonstrate how PPI can improve existing tools
that currently only do a very basic job, when there is the potential for so
much more.</p>

<p>One of these is part of the PAR application-packaging module. When PAR
bundles a module into the internal include directory, it tries to reduce the
size of the modules by stripping out POD. Of course, what would be better would
be to strip out <em>everything</em> that is excess and cut PAR file sizes even
more.</p>

<p>This is a form of compression, but given the potential confusion in using
something like "Compress::Perl" as a name, I'm picking my own term.
I hereby anoint the term &quot;Squish&quot;. A squished module occupies as little space
as possible, having had redundant characters removed. It will be extremely
small, although it might look a little &quot;squished&quot; to look at :)</p>

<h3>Perl::Squish</h3>

<p>Rather than showing you the final project, I prefer to show the process of
squishing a single module.</p>

<pre><code># Where is File::Spec on our system?
use Class::Inspector;
my $filename = Class::Inspector-&gt;resolved_filename( 'File::Spec' );

# Load File::Spec as a document
use PPI;
my $Document = PPI::Document-&gt;new( $filename );
</code></pre>

<p>Everything you do with PPI starts and finishes with <a
href="http://search.cpan.org/perldoc?PPI::Document">PPI::Document</a> objects.
If you find yourself using the lexer directly, you are probably doing
something wrong.</p>

<p>Where can I start cutting out the fat? For starters, many core modules
have an <code>__END__</code> section.</p>

<pre><code># Get the (one and only) __END__ section
my $End = $Document-&gt;find_first( 'Statement::End' );
  
# Delete it from the document
$End-&gt;delete if $End;</code></pre>

<p>PPI provides a set of search methods that you can use on any element that
has children. <code>find_first</code> is a safe guess, because there can only
be one <code>__END__</code> section. The search methods actually take
<code>&amp;wanted</code> functions like <a
href="http://search.cpan.org/perldoc?File::Find">File::Find</a>, so
<code>'Statement::End'</code> is really syntactic sugar for:</p>

<pre><code>sub wanted {
    my ($Document, $Element) = @_;
    $Element-&gt;isa('PPI::Statement::End');
}</code></pre>

<p>Of course, there's a faster way to do the same thing.  The
<code>prune</code> method finds and immediately deletes all elements that match
a particular condition.</p>

<pre><code># Delete all comments and POD
$Document-&gt;prune( 'Token::Pod' );
$Document-&gt;prune( 'Token::Comment' );</code></pre>

<p>For a more serious example, here's how to  strip the non-compulsory braces
from <code>-&gt;method()</code>:</p>

<pre><code># Remove useless braces
$Document-&gt;prune( sub {
    my $Braces = $_[1];
    $Braces-&gt;isa('PPI::Structure::List')      or return '';
    $Braces-&gt;children == 0                    or return '';
    my $Method = $Braces-&gt;sprevious_sibling   or return '';
    $Method-&gt;isa('PPI::Token::Word')          or return '';
    $Method-&gt;content !~ /:/                   or return '';
    my $Operator = $Method-&gt;sprevious_sibling or return '';
    $Operator-&gt;isa('PPI::Token::Operator')    or return '';
    $Operator-&gt;content eq '-&gt;'                or return '';
    return 1;
    } );</code></pre>

<p>It's a little bit wordy, but is relatively straightforward to write.  Just
add conditions and discard as you go. You can get other elements, calculate
anything or call sub-searches.</p>

<p>When you have finished, be sure to save the file.</p>

<pre><code># Save the file
$Document-&gt;save( &quot;$filename.squish&quot; );</code></pre>

<h3>Wrapping It All Up</h3>

<p>All you need to do now is is wrap it all up in some typical module
boilerplate.</p>

<pre><code>package Perl::Squish;
  
use strict;
use PPI;
  
our $VERSION = '0.01';
  
# Squish a file in place
# Perl::Squish-&gt;file( $filename )
sub file {
    my ($class, $file) = @_;
    my $Document = PPI::Document-&gt;new( $file ) or return undef;
    $class-&gt;document( $Document ) or return undef;
    $Document-&gt;save( $file );
}
  
# Squish a document object
# Perl::Squish-&gt;document( $Document );
sub document {
    my ($squish, $Document) = @_;
      
    # Remove the stuff we did earlier
    $Document-&gt;prune('Statement::End');
    $Document-&gt;prune('Token::Comment');
    $Document-&gt;prune('Token::Pod');
      
    $Document-&gt;prune( sub {
        my $Braces = $_[1];
        $Braces-&gt;isa('PPI::Structure::List')      or return '';
        $Braces-&gt;elements == 0                    or return '';
        my $Method = $Braces-&gt;sprevious_sibling   or return '';
        $Method-&gt;isa('PPI::Token::Word')          or return '';
        $Method-&gt;content !~ /:/                   or return '';
        my $Operator = $Method-&gt;sprevious_sibling or return '';
        $Operator-&gt;isa('PPI::Token::Operator')    or return '';
        $Operator-&gt;content eq '-&gt;'                or return '';
        return 1;
        } );

    # Let's also do some whitespace cleanup
    my @whitespace = $Document-&gt;find('Token::Whitespace');
    foreach ( @whitespace ) {
        $_-&gt;{content} = $_-&gt;{content} =~ /\n/ ? &quot;\n&quot; : &quot; &quot;;
    }
      
    1;
}
  
1;</code></pre>

<p>Finally, the last step is to wrap it all up as a proper module.  You can see
the finished product prettied up with PPI's syntax highlighter at <a
href="http://ali.as/CPAN/Squish.html">CPAN::Squish</a>.  I've added a few
additional small features to the basic code described above, but you get the
idea.  See also <a
href="http://search.cpan.org/perldoc?Perl::Squish">Perl::Squish</a> for more
details.</p>

<p>In 15 minutes, I've knocked together a pretty simple module that
dramatically improves on what you could do <em>without</em> something like PPI.
Now imagine the hard things it makes possible.</p>



        </div>



    </div>
    <div class="asset-footer"></div>
</div>


                            
                            <div id="entry-788" class="entry-asset asset hentry">
    <div class="asset-header">
        <h2 class="asset-name entry-title"><a href="/pub/2005/06/p6pdigest/20050602.html" rel="bookmark">This Week in Perl 6, May 25, 2005-May 31, 2005</a></h2>
        <div class="asset-meta">
            <span class="byline">
    
                By <span class="vcard author">Matt Fowles</span> on <abbr class="published" title="2005-06-02T00:00:00-08:00">June  2, 2005 12:00 AM</abbr>
    
            </span>

            
            

        </div>
    </div>
    <div class="asset-content entry-content">

        <div class="asset-body">
            
<!-- sidebar begins -->
<!-- don't move sidebars-->
<!-- sidebar ends -->
<p>All~</p>

<p>Welcome to another Perl 6 summary, brought to you by Aliya's new
friends, Masha Nannifer and Philippe, and my own secret running joke.
Without further ado, I bring you Perl 6 Compiler.</p>

<h3>Perl 6 Compiler</h3>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.compiler/browse_frm/thread/896e66b5cef6d677/e8f9ca07d7b1dc6f#e8f9ca07d7b1dc6f">Method
Chaining</a></h4>

<p>Alex Gutteridge discovered that he couldn't chain attribute access such as
<code>$bowl.fish.eyes.say;</code> in Pugs. Later he provided his example in
test form (in case anyone wanted to add it). Maybe someone added them, maybe
not; Warnock applies.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.compiler/browse_frm/thread/12735f0c524edb53/bdc3f08faf125f5f#bdc3f08faf125f5f">Pugs
Link Issues on Debian Sid</a></h4>

<p>B&Aacute;RTH&Aacute;ZI Andr&aacute;s had trouble making Pugs work on Debian
Sid with Perl 5 support. Autrijus provided helpful pointers. I assume from his
final silence that the final pointer worked.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.compiler/browse_frm/thread/70f338f3a2256f07/13d6ee45390ecb00#13d6ee45390ecb00"><code>Pugs.AST.*</code>
Compilation</a></h4>

<p>Samuel Bronson wanted to speed up the compilation of <code>Pugs.AST.*</code>
modules by turning off optimizations. Autrijus told him that this was a core
module that needed its speed, and optimizations would stay.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.compiler/browse_frm/thread/a13a6669f7555211/29fa93e63a1859e8#29fa93e63a1859e8"><code>Pugs.Types</code>
Export List</a></h4>

<p>Samuel Bronson added an export list to <code>Pugs.Types</code>. Autrijus
happily applied it and sent him a commit bit.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.compiler/browse_frm/thread/fb0bfd20062be074/89c3a26a58d0566a#89c3a26a58d0566a">Export
<code>withArgs</code> from <code>Main</code></a></h4>

<p>Samuel Bronson added an export to <code>Main</code>. Samuel Bronson happily
applied it himself this time.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.compiler/browse_frm/thread/473d55dfb23cb82b/dfb2bf1285cb5d68#dfb2bf1285cb5d68">Out-of-Date
hs-plugins</a></h4>

<p>Vadim had trouble compiling Pugs with Parrot support. Autrijus helped him
fix his problem, and there was much rejoicing.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.compiler/browse_frm/thread/146f4e62d950196a/b457fd0e6bac2224#b457fd0e6bac2224"><code>chomp</code>
Problem</a></h4>

<p>Jens Rieks found a problem with <code>chomp</code> and submitted a test.
Warnock applies.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.compiler/browse_frm/thread/e9da852ea30990fc/11806b69b57c9a53#11806b69b57c9a53">Pugs
<em>makefile</em> Issue</a></h4>

<p>Gr&eacute;goire P&eacute;an noticed that Pugs was creating a useless
<em>Pugs.exe.bat</em>.  Autrijus asked if he would be willing to investigate a
patch. He responded that he would put it in his queue.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.compiler/browse_frm/thread/43829f825c10b04e/80f020826b1ec28b#80f020826b1ec28b"><code>loop</code>
or <code>do</code></a></h4>

<p>Gerd Pokorra wondered why <code>do { ... }</code> was in Pugs, reasoning that
<code>loop { ... } while</code> was the correct thing.  Luke Palmer explained
that <code>do { ... }</code> was part of the with-or-without-a-postfix
<code>while</code>.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.compiler/browse_frm/thread/44797562829e45bf/0ec9118d0a5df14e#0ec9118d0a5df14e">PxPerl
5.8.6.2 with Pugs 6.2.5 and Parrot 0.2.0</a></h4>

<p>Gr&eacute;goire P&eacute;an announced the release of PxPerl 5.8.6.2,
which includes Pugs 6.2.5 and Parrot 0.2.0. This means that Windows folk can
test Pugs and Parrot without having to fight with compilers.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.compiler/browse_frm/thread/c8d85c57fa0cd9d7/e8d11297c80c534b#e8d11297c80c534b"><code>BUILD</code>
Errors</a></h4>

<p>Carl Franks found the handling of a named argument to a constructor
confusing. He asked for confirmation but no one provided it. Perhaps this poor
summary can save him.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.compiler/browse_frm/thread/2cd54cc42ccc7faf/e229eeb82b638977#e229eeb82b638977">White Space
and Function Calls</a></h4>

<p>David D. Zuhn didn't know about the forbidding of white space between a
function call and its parentheses. Carl told him that and about the
<code>.()</code> variant that allows white space.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.compiler/browse_frm/thread/0ad94f1b41e69ee1/1db579766f53aa86#1db579766f53aa86">Pug's
<code>make clean</code> Issues <i>Long</i> Commands</a></h4>

<p>Carl Franks noticed that <code>make clean</code> issued a command so long
that it broke his <code>nmake</code>. Fortunately he had a really old
<code>nmake</code> and updating fixed the problem.</p>

<h3>Parrot</h3>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/081cb54a4ed511fe/67a7f34afdf97217#67a7f34afdf97217"><em>thr_windows.h</em>
with MinGW</a></h4>

<p>Fran&ccedil;ois Perrad provided a patch fixing two compilation problems in
<em>thr_windows.h</em>. Warnock applies.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/42f822db3b2b4c7d/e40c457dca60a311#e40c457dca60a311">Parrot
Slides? </a></h4>

<p>Adam Preble posted a request for slides and notes on Parrot and Perl 6 for a
presentation he was working on. Many people provided links in various
languages. I usually steal from Dan's presentations when I need something like
this.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/e4f90647f62c3661/0a9baaa67250616b#0a9baaa67250616b">Problems
with Perl 5.6.1</a></h4>

<p>Fran&ccedil;ois Perrad had a problem building Parrot with MinGW and Perl
5.6.1,  related to Windows and its binary vs. text distinction.  This problem
will also crop up if you ever try to <code>seek</code> on files in Windows; not
that I have ever lost several days debugging that problem.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/86466b906c8e6e10/24a935c5c2c71aa8#24a935c5c2c71aa8">Ordered
Hash Thoughts</a></h4>

<p>Leo posted his thoughts on a modification to ordered hash, as adding a new
element by index breaks the string-hashing part of it. Dan suggested that the
ordered hash just pitch exceptions in the bad cases, as it was designed to be
lightweight and fast.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/c600922a3fcec692/759e9ee7e172f6ad#759e9ee7e172f6ad">Subrules
Tests</a></h4>

<p>Dino Morelli provided a patch adding tests for subrules to PGE. Warnock
applied, at least until Patrick read this summary.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/ea055b495d6878a2/23a59ac23ea8606d#23a59ac23ea8606d">Python
on Parrot</a></h4>

<p>Bloves inquired as to the state of Python on Parrot. The phrasing of the
question itself provided some confusion. Michal Wallace provided a link to
Pirate, hoping it would help.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/7c24021ab507253d/855d8042ec831341#855d8042ec831341"><code>Resizable*Array</code>
Defeats <em>list.c</em></a></h4>

<p>Slowly but steadily, my <code>{Fixed,Resizable}&lt;type&gt;Array</code> PMCs
are defeating the less consistent array implementations. Leo offered the job of
slaying <em>list.c</em> to any interested party. Jerry Gay expressed
interest.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/d71521e3e4e51418/b4da146647db3e6c#b4da146647db3e6c">Encodings
on "Char Constants"</a></h4>

<p>Bob Rogers wants to be able to supply an encoding for his character constants
that use <code>'</code>. He also wanted to find the integer that corresponds to
a character. Leo explained how he could do the former and that <code>ord</code>
is useful for the latter.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/01803083e71e519c/05c4703b1d5e89b4#05c4703b1d5e89b4">Broken
Links</a></h4>

<p>Fayland Lam pointed out that the links from the last summary were a little
broken. Hopefully this summary will be better.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/3f1726696d729ec9/c791d65ce745c731#c791d65ce745c731">Refcounts
and DOD</a></h4>

<p>Michal Wallace wondered how best to make Python's refcounts work for
embedding it in Parrot. Nicholas Clark pointed out that
<code>Parrot_[un]register_pmc</code> would work. Dan noted that if the Python
library were to become a Parrot extension, these could become no-ops as
Parrot's DOD would do the necessary work.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/c581e03e878f4d8a/d5f8daa08f078f3c#d5f8daa08f078f3c"><code>BigInt</code>
Fixes</a></h4>

<p>Kevin Tew added some tests and fixes to <em>BigInt.pmc</em>. Leo applied the
patch.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/a09a64c88328db95/b9c59f2722a5f595#b9c59f2722a5f595">MinGW
and GMP</a></h4>

<p>Fran&ccedil;ois Perrad provided a patch fixing GMP for MinGW. Leo provided a
slight correction, which Fran&ccedil;ois incorporated. Leo then applied the
patch.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/c81da92bc01890a5/6a6dd5a236cf22eb#6a6dd5a236cf22eb"><code>index</code>
Failures</a></h4>

<p>Roger Browne found a failure in the <code>index</code> opcode. Leo fixed it.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/33dfb7a365e4a083/fe4b4af306994134#fe4b4af306994134">MinGW
and GDBM</a></h4>

<p>Fran&ccedil;ois Perrad provided a patch fixing GDBMfor MinGW. Leo applied
the patch.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/8894e415b47b8d24/a2ed829260b2d8dc#a2ed829260b2d8dc"><code>mod</code>
Operation Fails with Negative Integers</a></h4>

<p>Roger Browne noticed that <code>mod</code>ing with or by negative integers could produce
negatives, such as <code>3 mod -3 = -3</code>. Leo fixed them to provide 0. I
hate that fact about C; not that I have ever lost several days debugging that
problem, either.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/f40aab493be196c2/5d73d39d325ac0df#5d73d39d325ac0df">Tracing
and Debugging</a></h4>

<p>Leo noted that debugging Parrot has grown more difficult, as the number of
abstractions has increased. Is your compiler, IMCC, your PMC, or Parrot broken?
Maybe two or three of them? To facilitate debugging, Leo suggested a
<code>debug_break</code> opcode and a <code>Debugger</code> PMC. It sounds
nifty. He also added support for lexically scoped trace and debug flags.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/72ffc881d1d75457/f85ac2dda841e70f#f85ac2dda841e70f">Adding
Unicode, Hex, and Octal Escapes</a></h4>

<p>Will Coleda added more complete escape sequence support to Tcl. Matt
Diephouse integrated the patch into his latest version.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/3bba0dbcc811c84d/ad2ff9ee718948b2#ad2ff9ee718948b2">the State
of ParTcl</a></h4>

<p>Will Coleda proudly noted that as of r8193, ParTcl passed all tests, even
with <code>gc-debug</code>. Much praise goes to Matt Diephouse for his cleanup of the Tcl
parser.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/0dcc4f1f752418ce/0c782ec5ad4c954e#0c782ec5ad4c954e">Strength
Reduction Optimization</a></h4>

<p>Curtis Rawls provided a flurry of patches improving Parrot's strength
reduction optimization. Leo applied the patches.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/82f5be5069a649b7/97de5fb125248fdc#97de5fb125248fdc">TODO:
<code>readline</code> Support</a></h4>

<p>Leo put out a request for adding <code>readline</code> support to Parrot.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/4533f856ba99f0ae/d00c8b88bcfbd51b#d00c8b88bcfbd51b"><code>get_mmd_dispatch_type</code>
Fix</a></h4>

<p>Vladimir Lipsky provided a patch that fixes a bug in <em>mmd.c</em>. Leo
applied it.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/2f5aa6c61a77aa58/40d686bdf7e7eee9#40d686bdf7e7eee9">Uninitialized
Variable</a></h4>

<p>Vladimir Lipsky fixed an uninitialized variable. Leo applied the patch.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/9491a345632a0111/0a09d861dccc0018#0a09d861dccc0018">Improved
<code>loadlib</code> Handling</a></h4>

<p>Bob Rogers improved <code>loadlib</code>'s handling of absolute paths.  Leo
applied the patch.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/b3bca2ddf30f69ce/17b19f2de2b3ecd2#17b19f2de2b3ecd2">DOD
Sweep Fix</a></h4>

<p>Vladimir Lipsky prevented the NULL <code>PMC_EXT</code> from being added to
the PMC <code>ext</code> pool during a DOD sweep. Leo applied the patch.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/3773a79fd720ee41/2cd1145fa93e777d#2cd1145fa93e777d">Packfile
Double Destroy</a></h4>

<p>Vladimir Lipsky fixed a problem with double destruction of nested packfiles.
Leo applied the patch.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/0182c9ebfb0736bb/d531fecfb9c449a5#d531fecfb9c449a5">Tcl
Autoconverts List &lt;-&gt; String</a></h4>

<p>Tcl can autoconvert between lists and strings. Will Coleda wondered how to
implement this behavior to best support language interoperability.  People
offered suggestions, but there was no real agreement on the best solution,
though.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/952a2970ad1a2aaa/64d83aa594a8438b#64d83aa594a8438b">TODO
Classification</a></h4>

<p>Chromatic, inspired by Pugs, added TODO classification to Parrot::Test.  He
threatened to apply the patch if there were no objections ... none yet.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/75ed82ed26e93acf/a3e9619005dbeba1#a3e9619005dbeba1">HLL
Group Support</a></h4>

<p>Leo added support for loading high-level language PMC groups dynamically
using the <code>.HLL</code> directive. This will load the lib dynamically and
change the return type of some ops to reflect the HLL's preferences. It is
nifty.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/56d66dd2f4202b8c/acea6702a7bdbeb4#acea6702a7bdbeb4">Pistol-Wielding Parrot</a></h4>

<p>Leo put out a request for PIR versions of the <a
href="http://shootout.alioth.debian.org/">Computer Language Shootout</a> tests. This will provide a means of gauging Parrot's performance against other
languages. Kinda nifty.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/7280549fef836ac0/8255877b03808230#8255877b03808230"><code>nmake</code>
v1.5 Issues</a></h4>

<p>Nigel Sandever also had trouble with overly long lines and
<code>nmake</code>.  Upgrading <code>nmake</code> fixed his problem, too.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/e7df5b27c42f22e6/8a84a8e385b74ec1#8a84a8e385b74ec1">Optimizer
Producing Bad Code</a></h4>

<p>Nick Glencross noticed that the optimizer was producing some bad code.  Leo
fixed one of the problems, but missed the other.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/0b09cf75ebded75b/a3ac293d1aaace86#a3ac293d1aaace86">Keys
Design</a></h4>

<p>Dan posted an explanation of his original design for keys.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/ef896a743922b55e/91db59b1a73aee04#91db59b1a73aee04">Loop
Improvements</a></h4>

<p>Curtis Rawls provided a patch to improve the loop struct in the IMCC
optimizer. Leo applied it and asked if he would take a whack at reducing the
resource consumption of Bill Coffman's register allocation patch. Dan and Bob
Rogers both expressed interested in speeding up the compiler.</p>

<h3>Perl 6 Language</h3>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.language/browse_frm/thread/fe42b63a7e74721b/04e18f0b56fb64b3#04e18f0b56fb64b3">Hash
Slices</a></h4>

<p>Carl Franks thought he was having trouble with hash slices. Actually he was
having trouble with the <code>s/-&gt;/./</code> in his Perl 5 conversion.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.language/browse_frm/thread/89fb02214da27797/0409dbac1ab2d41a#0409dbac1ab2d41a">Perl
6 and Refactoring Support</a></h4>

<p>Piers Cawley resurrected Matisse Enzer's thread about IDEs and tools for Perl
6. He observed that Perl 6 might provide a great deal of support for such
things. Deborah Pickett noted that it might not be theoretically possible to
parse Perl 6 safely. Luke Palmer felt that it would not be possible, given
<code>BEGIN</code> blocks and the like.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.language/browse_frm/thread/6f589edd45ffad1e/2eb118f67d19a368#2eb118f67d19a368"><code>$*OS
but OS::unix</code></a></h4>

<p>Rob Kinyon suggested that <code>$*OS</code> be a class that mixes in the
correct <code>OS::<em>class</em></code>. Then MMD could do the heavy lifting. I
like this idea.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.language/browse_frm/thread/35f6c8d0d9aa4371/5eaac5d52de792d6#5eaac5d52de792d6">Reduction
Junctions and Cribbage Scoring</a></h4>

<p>Rob Kinyon wanted to use junctions and reductions to score cribbage hands.
Unfortunately, he used junctions as a set. This led to discussions of the
correct implementation, and of a Set module that should be part of Perl 6. I
want such a set module to have a powerset function that returns the powerset
of a particular set (preferably lazily instantiated). Also, my cribbage scoring
algorithm is better: 1) lay down hand, 2) announce score, 3) peg.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.language/browse_frm/thread/8843447d9562a359/79007e1d5ba75d38#79007e1d5ba75d38">Syntax
for Using Perl 5</a></h4>

<p>Autrijus added support to Pugs for using Perl 5 modules. This led him to
wonder what the correct syntax for this actually was. Many suggestions, but no
decisions, arrived.</p>

<h4>
MMD and SMD Interaction
</h4>

<p>Yuval Kogman wondered how MMD and SMD would interact. Warnock applied.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.language/browse_frm/thread/3ba81c6b33ec5605/db8a961b884b69ae#db8a961b884b69ae">Making
Perl 6 Grammars Generative</a></h4>

<p>Aufrank wondered if Perl 6 grammars could be made generative. I would say
that this does not belong in the core simply because of its niche application;
however, if I were to do this, I would start by using the Perl 6 grammar grammar
and modify the way the parse tree is used. Sadly, aufrank posted to Google
Groups, so nobody else expressed opinions.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.language/browse_frm/thread/3d1ff082d4338b04/bd268cbd6f0eb52a#bd268cbd6f0eb52a">Links
and References</a></h4>

<p>Thomas Sandla&szlig; suggested a <code>Link</code> class to fill the role of
auto-dereferencing variables that Luke called &quot;transparent&quot; references.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.language/browse_frm/thread/b9b8fb5488a7da33/7e2fe8ee49ea4132#7e2fe8ee49ea4132">Use
Syntax</a></h4>

<p>Rob Kinyon wondered how exactly ranges of versions and multi-language
interoperability would work in Perl 6. Rod Adams provided a few answers.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.language/browse_frm/thread/a5c5cdb1a30742ce/fedb6c6b85ae2f0c#fedb6c6b85ae2f0c">Anonymous
Classes</a></h4>

<p>Simon Cozens announced that he was having a lot of fun converting Maypole to
Perl 6. Then he asked how make anonymous subclasses that inherit from other
classes and add new methods. Ingo Blechschmidt provided the answers.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.language/browse_frm/thread/fe1eb1f7887a4625/0a739544e951e569#0a739544e951e569">Introspectable
Code Objects</a></h4>

<p>Ingo Blechschmidt thought it would be nifty if code objects were fully
introspectable. Luke agreed, but felt that being able to access them at the
statement level might be problematic. I think most of what Ingo would want this
for is doable with macros that parse normally (or modify a block), but then
munge the resulting match object appropriately.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.language/browse_frm/thread/bf516a1c019f25b1/fad6bfc4f1650717#fad6bfc4f1650717">Signatures
As First-Class Types</a></h4>

<p>Yuval Kogman hoped that signatures would be available as first-class types
in Perl 6. Ingo Blechschmidt agreed.  Sam Vilain pointed to the start of such a
translation.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.language/browse_frm/thread/8f03c86d34ed66e2/4e33e251e46fa668#4e33e251e46fa668"><code>new</code>
and MMD</a></h4>

<p>Carl Franks wanted to create a specialized on arguments to <code>new</code>
using MMD.  Damian told him that his technique was a way to do it, and that
<code>bless</code> would still call <code>BUILDALL</code>.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.language/browse_frm/thread/b5bc2a3c0bec2d57/c0a0aa45d2cf43cd#c0a0aa45d2cf43cd">Code
Ownership and Debuggability</a></h4>

<p>Yuval Kogman posted his thoughts on code ownership and debuggability in the
age of frameworks and generated code.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.language/browse_frm/thread/99b61afd411441c3/5377eb7fe6083922#5377eb7fe6083922">Strongly
Typed Containers</a></h4>

<p>Yuval Kogman wondered how to make a strongly typed container class (similar
to C++ templates). Sam Villain provided a pointer to earlier threads and
mentioned Haskell's Generic Algebraic Data Types.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.language/browse_frm/thread/d60365097dfc4f24/55b6d56db611c9c6#55b6d56db611c9c6">Constants
and Optimizations</a></h4>

<p>Ingo Blechschmidt wondered how to create constants so that the optimizer
would be able to do as much as possible. Damian suggested that macros would be
one solution. This makes me wonder if there is a way to declare a function so
that the compiler can create a macro version for constants automatically. That
would be nifty.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.language/browse_frm/thread/9c02afd5621d8f36/065dacbad0d9ddcd#065dacbad0d9ddcd">Date/Time Formatting</a></h4>

<p>Nathan Gray wondered what sort of date/time formating Perl 6 would support.
Rob Kinyon suggested porting <code>DateTime</code>. This certainly sounds like something
that belongs in a module.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.language/browse_frm/thread/60859d989e786eec/130fd7a73ed5bb7d#130fd7a73ed5bb7d">And
Pow, I Found Illumination</a></h4>

<p>After much discussion, @Larry has weighed in on the thread I started about
reductions on empty lists. Damian feels that it should fail, as finding an
appropriate identity operator is no simple task.  Somehow a discussion of
modulus and division slipped in too.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.language/browse_frm/thread/952a0bb378deaa92/ecc8fdcafb41ff92#ecc8fdcafb41ff92">Sub
Call Versus MMD</a></h4>

<p>Luke Palmer wanted a sanity check on sub calls versus MMD. Larry provided an
answer, but did not weigh in on his sanity.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.language/browse_frm/thread/c5d553fa29733b95/d434d39327b75214#d434d39327b75214"><code>(1,(2,3),4)[2]</code></a></h4>

<p>People continue to feel very divided about <code>(1,(2,3),4)[2]</code> and
<code>@x = [1,2,3]</code>. There are strong opinions on both sides about
arrayrefs in array and scalar contexts. I appear to be allied with the losing
side. Hopefully things will change.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.language/browse_frm/thread/ef172220cda5a462/710cc944649b901a#710cc944649b901a">Unicode
Cheat Sheet</a></h4>

<p>Rob Kinyon posted a request for a Unicode cheat sheet so he could make his
own nifty symbols. Gaal Yahas and Sam Vilain provided pointers.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.language/browse_frm/thread/e9cfaffbe7ce5364/2335c47b32fa6af6#2335c47b32fa6af6">Comprehensive
List of Rules Tokens</a></h4>

<p>Jeff Pinyan wants a comprehensive list of Perl 6 rule tokens so he can
create a Perl 5 module to parse them. Much discussion ensued.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.language/browse_frm/thread/0d33ae0ce9a439fa/cb997504f9511ada#cb997504f9511ada">Default
Invocant of Methods</a></h4>

<p>Ingo Blechschmidt wondered if a method's <code>Class</code> could be a default invocant
or only instances of it. Somehow this led Larry to musing about <code>Class</code> as a role
than people can mixin instead of inherit from. He confuses me.</p>

<h3>The Usual Footer</h3>

<p>Posting via the Google Groups interface does not work. To post to any of
these mailing lists please subscribe by sending email to
<code>perl6-internals-subscribe@perl.org</code>,
<code>perl6-language-subscribe@perl.org</code>, or
<code>perl6-compiler-subscribe@perl.org</code>. If you find these summaries
useful or enjoyable, please consider contributing to the Perl Foundation to
help support the development of Perl. You might also like to send feedback to <csperl file="mailmunge" arg_email="ubermatt@gmail.com" arg_ending="." /></p>

<ul>

<li><a href="http://donate.perl-foundation.org/">The Perl Foundation</a></li>
<li><a href="http://dev.perl.org/perl6/">Perl 6 development site</a></li>
<li><a href="http://planet.parrotcode.org/">Parrot Blog aggregator</a></li>

</ul>
<!-- sidebar begins -->
 <csperl file="grab" domain="on" record="b/1714" template="b/article_sidebar2.view">
<!-- sidebar ends -->


        </div>



    </div>
    <div class="asset-footer"></div>
</div>


                            
                            <div id="entry-778" class="entry-asset asset hentry">
    <div class="asset-header">
        <h2 class="asset-name entry-title"><a href="/pub/2005/06/02/catalyst.html" rel="bookmark">Catalyst</a></h2>
        <div class="asset-meta">
            <span class="byline">
    
                By <span class="vcard author">Jesse Sheidlower</span> on <abbr class="published" title="2005-06-02T00:00:00-08:00">June  2, 2005 12:00 AM</abbr>
    
            </span>

            
            

        </div>
    </div>
    <div class="asset-content entry-content">

        <div class="asset-body">
            
<!-- sidebar begins -->
<!-- don't move sidebars-->
<!-- sidebar ends -->
<p>Web frameworks are an area of significant interest at the moment. Now that
we've all learned the basics of web programming, we're ready to get the
common stuff out of the way to concentrate on the task at hand; no one wants to
spend time rewriting the same bits of glue to handle parameter processing,
request dispatching, and the like.</p>

<p>A model currently favored for web applications is <em>MVC</em>, or
Model-View-Controller. This design pattern, originally from Smalltalk, supports
the separation of the three main areas of an application--handling application
flow (Controller), processing information (Model), and outputting results
(View)--so that it is possible to change or replace any one without affecting
the others.</p>

<p>Catalyst is a new MVC framework for Perl. It is currently under rapid
development, but the core API is now stable, and a growing number of projects
use it.  Catalyst borrows from other frameworks, such as Ruby on Rails and
Apache Struts, but its main goal is to be a flexible, powerful, and fast
framework for developing any type of web project in Perl. This article, the
first of a series of two, introduces Catalyst and shows a simple application; a later
article will demonstrate how to write a more complex project.</p>

<h4>Inspirations</h4>

<p>Catalyst grew out of Maypole, an MVC framework developed by Simon Cozens
(and discussed last year on Perl.com; see "<a
href="/pub/a/2004/04/15/maypole.html">Rapid Web Application
Development with Maypole</a>," for example). Maypole works well for typical CRUD (Create, Retrieve, Update, Delete)
databases on the Web. It includes a variety
of useful methods and prewritten templates and template macros that make it
very easy to set up a powerful web database.  However, it focuses so strongly
on CRUD that it is less flexible for other tasks. One of the goals of Catalyst
is to provide a framework well suited for any web-related project.</p>

<p><a href="http://www.rubyonrails.org/">Ruby on Rails</a> was another
inspiration; this popular system has done much to promote interest in the Ruby
programming language. Features we borrowed from RoR are the use of helper
scripts to generate application components and the ability to have multiple
controllers in a single application. Both RoR and Struts allow the use of
forwarding within applications, which also proved useful for Catalyst.</p>

<h4>Features</h4>

<h5>Speed</h5>
<p>We planned Catalyst as an enterprise-level framework, able to handle a significant
    load. It makes heavy use of caching. Catalyst applications register their actions
    in the dispatcher at compile time, making it possible to process runtime requests
    quickly, without needing elaborate checks. Regex dispatches are all precompiled.
    Catalyst builds only the structures it needs, so there are no delays to generate
    (for example) unused database relations.</p>
<h5>Simplicity</h5>
<p><em>Components</em></p>
<p>Catalyst has many prebuilt components and plugins for common modules and tasks.
          For example, there are <code>View</code> classes available for Template Toolkit, HTML::Template,
          Mason, Petal, and PSP. Plugins are available for dozens of applications and
          functions, including <a
href="http://search.cpan.org/perldoc?Data::FormValidator">Data::FormValidator</a>,
          authentication based on LDAP or <a
href="http://search.cpan.org/perldoc?Class::DBI">Class::DBI</a>, several caching
          modules, <a
href="http://search.cpan.org/perldoc?HTML::FillInForm">HTML::FillInForm</a>,
          and XML-RPC.</p>
<p>Catalyst supports component auto-discovery; if you put a component in the
    correct place, Catalyst will find and load it automagically. Just place a Catalog
    controller in <em>/AppName/Controller/Catalog.pm</em> (or, in practice, in the
    shortened <em>/AppName/C/Catalog.pm</em>); there's no need to <code>use</code> each
    item. You can also declare plugins in the application class with short names,
    so that:</p>
<pre><code>use Catalyst qw/Email Prototype Textile/;</code></pre>
<p>will load <code>Catalyst::Plugin::Email</code>, <code>Catalyst::Plugin::Prototype</code>,
    and <code>Catalyst::Plugin::Textile</code> in one shot.</p>
<p><em>Development</em></p>
<p>Catalyst comes with a built-in lightweight HTTP server for development purposes.
    This runs on any platform; you can quickly restart it to reload any changes.
    This server functions similarly to production-level servers, so you can use
    it throughout the testing process--or longer; it's a great choice if you want
    to deliver a self-contained desktop application. Scalability is simple, though:
    when you want to move on, it is trivial to switch the engine to use plain CGI,
    <code>mod_perl1</code>, <code>mod_perl2</code>, FastCGI, or even the Zeus web server.</p>
<p>Debugging (Figure 1) and logging (Figure 2) support is also built-in. With
    debugging enabled, Catalyst sends very detailed reports to the error log, including
    summaries of the loaded components, fine-grained timing of each action and
    request, argument listings for requests, and more. Logging works by using the
    the <code>Catalyst::Log</code> class; you can log any action for debugging
    or information purposes by adding lines like:</p>
<pre><code>$c-&gt;log-&gt;info(&quot;We made it past the for loop&quot;);
$c-&gt;log-&gt;debug( $sql_query );</code></pre>
<p><img src="/pub/2005/06/02/graphics/log-screenshot.gif" width="515" height="411" alt="Log screenshot" /><br />
  <em>Figure 1. Logging</em></p>
<p>Crashes will display a flashy debug screen showing details of relevant data
    structures, software and OS versions, and the line numbers of errors.</p>
<p><img src="/pub/2005/06/02/graphics/debug-screenshot.gif" width="515" height="376" alt="Debug screenshot" /><br />
  <em>Figure 2. Debugging</em></p>
<p>Helper scripts, generated with Template Toolkit, are available for the main
    application and most components. These allow you to quickly generate starter code (including
    basic unit tests) for the application framework. With a single line,
    you can create a <code>Model</code> class based on <code>Class::DBI</code> that pulls in
    the appropriate Catalyst base model class, sets up the pattern for the CDBI
    configuration hash, and generates a <code>perldoc</code> skeleton.</p>
<h5>Flexibility</h5>
Catalyst allows you to use multiple models, views, and controllers--not just
as an option when setting up an application, but as a totally flexible part of
an application's flow. You can mix and match different elements within the same
application or even within the same method. Want to use <code>Class::DBI</code> for
your database storage and LDAP for authentication? You can have two models. Want
to use Template Toolkit for web display and <a
href="http://search.cpan.org/perldoc?PDF::Template">PDF::Template</a> for print
output? No problem. Catalyst uses a simple building-block approach to its add-ins:
if you want to use a component, you say so, and if you don't say so, Catalyst
won't use it. With so many components and plugins available, based on CPAN modules,
it's easy to use what you want, but you don't have to use something you don't
need. Catalyst features advanced URL-to-action dispatching. There are multiple
ways to map a URL to an action (that is, a Catalyst method), depending on your
requirements. First, there is literal dispatching, which will match a specific
path:
<pre><code>package MyApp::C::Quux;

# matches only http://localhost:3000/foo/bar/yada
sub baz : Path('foo/bar/yada') { }</code></pre>

<p>A top-level, or global, dispatch matches the method name directly at the application
  base:</p>

<pre><code>package MyApp::C::Foo;

# matches only http://localhost:3000/bar
sub bar : Global { }</code></pre>

<p>A local, or namespace-prefixed, dispatch acts only in the namespace derived
  from the name of your Controller class:</p>
<pre><code>package MyApp::C::Catalog::Product;

# matches http://localhost:3000/catalog/product/buy
sub buy : Local { }

package MyApp::C::Catalog::Order;

# matches http://localhost:3000/catalog/order/review
sub review : Local { }</code></pre>

<p>The most flexible is a regex dispatch, which acts on a URL that matches the
  pattern in the key. If you use capturing parentheses, the matched values are
  available in the <code>$c-&gt;request-&gt;snippets</code> array.</p>

<pre><code>package MyApp::C::Catalog;

# will match http://localhost:3000/item23/order189
sub bar : Regex('^item(\d+)/order(\d+)$') { 
   my ( $self, $c ) = @_;
   my $item_number  = $c-&gt;request-&gt;snippets-&gt;[0];
   my $order_number = $c-&gt;request-&gt;snippets-&gt;[1];
   # ...    
}</code></pre>

<p>The regex will act globally; if you want it to act only on a namespace, use
  the name of the namespace in the body of the regex:</p>

<pre><code>sub foo : Regex('^catalog/item(\d+)$') { # ...</code></pre>

<p>Finally, you can have private methods, which are never available through URLs.
  You can only reach them from within the application, with a namespace-prefixed
  path:</p>

<pre><code>package MyApp::C::Foo;
# matches nothing, and is only available via $c-&gt;forward('/foo/bar').
sub bar : Private { }</code></pre>

<p>A single <code>Context</code> object (<code>$context</code>, or more usually as its alias <code>$c</code>)
  is available throughout the application, and is the primary way of interacting
  with other elements. Through this object, you can access the request object
  (<code>$c-&gt;request-&gt;params</code> will return or set parameters, <code>$c-&gt;request-&gt;cookies</code> will
  return or set cookies), share data among components, and control the flow of
  your application. A response object contains response-specific information
  (<code>$c-&gt;response-&gt;status(404)</code>) and the <code>Catalyst::Log</code> class
  is made directly available, as shown above. The <code>stash</code> is a universal hash
  for sharing data among application components:</p>
  
<pre><code>$c-&gt;stash-&gt;{error_message} = &quot;You must select an entry&quot;;

# then, in a TT template:
[% IF error_message %]
   &lt;h3&gt;[% error_message %]&lt;/h3&gt;
[% END %]</code></pre>

<p>Stash values go directly into the templates, but the entire context object
  is also available:</p>
<pre><code>&lt;h1&gt;[% c.config.name %]&lt;/h1&gt;</code></pre>

<p>To show a Mason example, if you want to use <code>Catalyst::View::Mason</code>:</p>
<pre><code>% foreach my $k (keys $c-&gt;req-&gt;params) {
  param: &lt;% $k %&gt;: value: &lt;% $c-&gt;req-&gt;params-&gt;{$k} %&gt;
% }</code></pre>













<h3>Sample Application: MiniMojo, an Ajax-Based Wiki in 30 Lines of Written
Code</h3>

<p>Now that you have a sense of what Catalyst is, it's time to look at what it
can do. The example application is MiniMojo, a wiki based on <a
href="http://www.adaptivepath.com/publications/essays/archives/000385.php">Ajax</a>,
which is a JavaScript framework that uses the <code>XMLHttpRequest</code> object to create
highly dynamic web pages without needing to send full pages back and forth
between the server and client.</p>

<p>Remember that from the Catalyst perspective, Ajax is just a case of sending
more text to the browser, except that this text is in the form of client-side
JavaScript that talks to the server, rather than a boilerplate copyright notice
or a navigation sidebar.  It makes no difference to Catalyst.</p>

<h4>Installation</h4>

<p>Catalyst has a relatively large number of requirements; most, however, are
easy to install, along with their dependencies, from CPAN. The following list
should take care of everything you need for this project:</p>

<ul>
<li><a href="http://search.cpan.org/perldoc?Catalyst">Catalyst</a></li> 
<li><a
href="http://search.cpan.org/perldoc?Catalyst::Model::CDBI">Catalyst::Model::CDBI</a></li>
<li><a
href="http://search.cpan.org/perldoc?Class::DBI::SQLite">Class::DBI::SQLite</a></li> 
<li><a
href="http://search.cpan.org/perldoc?Catalyst::View::TT">Catalyst::View::TT</a> </li>
<li><a
href="http://search.cpan.org/perldoc?Catalyst::Plugin::Textile">Catalyst::Plugin::Textile</a> </li>
<li><a
href="http://search.cpan.org/perldoc?Catalyst::Plugin::Prototype">Catalyst::Plugin::Prototype</a></li> 
<li><a href="http://www.sqlite.org/">SQLite</a> (the
binary, not the Perl module)</li>
</ul>

<h4>Generate the Application Skeleton</h4>

<p>Run this command:</p>

<pre><code>$ catalyst.pl MiniMojo
$ cd MiniMojo</code></pre>

<p>You've just created the skeleton for your entire application, complete with
a helper script keyed to MiniMojo to generate individual classes, basic test
scripts, and more.</p>

<p>Run the built-in server:</p>

<pre><code>$ script/minimojo_server.pl</code></pre>

<p>MiniMojo is already running, though it isn't doing much
just yet. (You should have received a web page consisting solely
of the text &quot;Congratulations, MiniMojo is on Catalyst!&quot;)  Press
<code>Ctrl</code>-<code>C</code> to stop the server.</p>

<h4>Add Basic Methods to Your Application Class</h4>

<p>Add a private <code>end</code> action to your application class,
<em>lib/MiniMojo.pm</em>, by editing the new file:</p>

<pre><code>sub end : Private {
    my ( $self, $c ) = @_;
    $c-&gt;forward('MiniMojo::V::TT') unless $c-&gt;res-&gt;output;
}</code></pre>

<p>Catalyst automatically calls the <code>end</code> action at the end of a
request cycle.  It's one of four built-in Private actions. It's a typical
pattern in Catalyst to use <code>end</code> to forward the application to the
View component for rendering, though if necessary you could do it yourself (for
example, if you want to use different Views in the same application--perhaps
one to generate web pages with Template Toolkit and another to generate PDFs
with PDF::Template).</p>

<p>Replace the existing, helper-generated <code>default</code>
action in the same class with:</p>

<pre><code>sub default : Private {
    my ( $self, $c ) = @_;
    $c-&gt;forward('/page/show');
}</code></pre>

<p>In case the client has specified no other appropriate action, this will
forward on to the page controller's <code>show</code> method. As Private
actions, nothing can call these from outside the application. Any method from
within the application can call them.  The <code>default</code> action is
another built-in Private action, along with <code>begin</code>,
<code>auto</code>, and <code>end</code>.  Again, Catalyst calls them
automatically at relevant points in the request cycle.</p>

<h4>Set Up the Model (SQLite Database) and Use the Helper to Create Model
Classes</h4>

<p>Next, create a file, <em>minimojo.sql</em>, that contains the SQL for setting
up your <code>page</code> table in SQLite.</p>

<pre><code>-- minimojo.sql
CREATE TABLE page (
    id INTEGER PRIMARY KEY,
    title TEXT,
    body TEXT
);</code></pre>

<p>Create a database from it, using the <code>sqlite</code> command-line
program:</p>

<pre><code>$ sqlite minimojo.db &lt; minimojo.sql</code></pre>

<p>Depending on your setup, it might be necessary to call this as <code>sqlite3</code>.</p>

<p>Use the helper to create model classes and basic unit tests (Figure 3 shows
the results):</p>

<pre><code>$ script/minimojo_create.pl model CDBI CDBI dbi:SQLite:/path/to/minimojo.db</code></pre>

<p><img src="/pub/2005/06/02/graphics/model-create-screenshot.gif" width="515" height="372" alt="Model-creation screenshot" /><br
/><em>Figure 3. Creating the model</em></p>

<p>The <em>minimojo_create.pl</em> script is a helper that uses Template
Toolkit to automate the creation of particular modules. The previous command
creates a model (in contrast to a controller or a view) called
<em>CDBI.pm</em>, using the CDBI helper, setting the connection string to
<code>dbi:SQLite:/path/to/minimojo.db</code>, the database you just created. (Use the appropriate path for
your system.) The helper will write the models into <em>lib/MiniMojo/M/</em>.
There are various options for the helper scripts; the only requirement is the
type and the name. (You can create your own modules from scratch, without using
the helper.)</p>

<h4>Set Up the View (<code>Template::Toolkit</code>) and Use the Helper to
Create View Classes</h4>

<p>Use the helper to create a view class:</p>

<pre><code>$ script/minimojo_create.pl view TT TT</code></pre>

<p>View classes go into <em>lib/MiniMojo/V/</em>.</p>

<h4>Set Up a Controller Class Using the Helper</h4>

<p>Create a controller class called <code>Page</code> with the helper:</p>

<pre><code>$ script/minimojo_create.pl controller Page</code></pre>

<p>Controller classes live in <em>lib/MiniMojo/C/</em>.</p>

<p>Add a <code>show</code> action to <em>lib/MiniMojo/C/Page.pm</em>:</p>

<pre><code>sub show : Regex('^(\w+)\.html$') {
    my ( $self, $c ) = @_;
    $c-&gt;stash-&gt;{template} = 'view.tt';
    # $c-&gt;forward('page');
}</code></pre>

<p>The <code>Regex</code> dispatch matches a page in <i><code>foo</code>.html</i>, where
<code>foo</code> is any sequence of word characters. This sequence is available
in the <code>$context-&gt;request-&gt;snippets</code> array, where the <code>page</code>
action uses it to display an existing page or to create a new one. The rest of
this action sets the appropriate template and sends the application to the
<code>page</code> action. (Leave the <code>forward</code> command commented out until you have written the <code>page</code> action.)</p>

<p>Restart the server with <code>$ script/minimojo_server.pl</code> and point a web browser to <i>http://localhost:3000/show/</i> to see
the debug screen (you don't yet have the template that <code>show</code> is
trying to send people to).</p>

<p>Create <em>root/view.tt</em>:</p>

<pre><code>&lt;html&gt;
    &lt;head&gt;&lt;title&gt;MiniMojo&lt;/title&gt;&lt;/head&gt;
    &lt;body&gt;
        &lt;h1&gt;MiniMojo is set up!&lt;/h1&gt;
    &lt;/body&gt;
&lt;/html&gt;</code></pre>

<p>Test again by killing the server with <code>Ctrl</code>-<code>C</code> and restarting it, and go to
<i>http://localhost:3000/show/</i>. You should see the page you just
defined.</p>

<h4>Add the Display and Edit Code</h4>

<p>Modify the application class <em>lib/MiniMojo.pm</em> to include the
<code>Prototype</code> and <code>Textile</code> plugins:</p>

<pre><code>use Catalyst qw/-Debug Prototype Textile/;</code></pre>

<p>Note that you can use the plugins by specifying their base names; Catalyst
figures out what you mean without making you use
<code>Catalyst::Plugin::Prototype</code>.</p>

<p>Modify the <code>page</code> controller, <em>lib/MiniMojo/C/Page.pm</em>, to
add page-view and editing code:</p>

<pre><code>sub page : Private {
    my ( $self, $c, $title ) = @_;
    $title ||= $c-&gt;req-&gt;snippets-&gt;[0] || 'Frontpage';
    my $query = { title =&gt; $title };
    $c-&gt;stash-&gt;{page} = MiniMojo::M::CDBI::Page-&gt;find_or_create($query);
}</code></pre>

<p>The private <code>page</code> method sets a title--whether passed in to it,
taken from the <code>snippets</code> array (that matches the regex in
<code>show</code>), or defaulting to &quot;Frontpage.&quot; The <code>$query</code>
variable holds a hashref used for <code>Class::DBI</code>'s
<code>find_or_create</code> method, seeding the stash for the <code>page</code>
variable with the result of this CDBI query. At the end of the method, control
flow returns to the calling method.</p>

<p>Now uncomment the <code>$c-&gt;forward('page');</code> line in the <code>show</code> action.</p>

<pre><code>sub edit : Local {
    my ( $self, $c, $title ) = @_;
    $c-&gt;forward('page');
    $c-&gt;stash-&gt;{page}-&gt;body( $c-&gt;req-&gt;params-&gt;{body} )
      if $c-&gt;req-&gt;params-&gt;{body};
    my $body = $c-&gt;stash-&gt;{page}-&gt;body || 'Just type something...';
    my $html = $c-&gt;textile-&gt;process($body);

    my $base = $c-&gt;req-&gt;base;
    $html    =~ s{(?&lt;![\?\\\/\[])(\b[A-Z][a-z]+[A-Z]\w*)}
                 {&lt;a href=&quot;$base$1.html&quot;&gt;$1&lt;/a&gt;}g;

    $c-&gt;res-&gt;output($html);
}</code></pre>

<p>The <code>edit</code> method first forwards the action off to
<code>page</code>, so that the stash's <code>page</code> object contains the
result of the CDBI query. If there is a value for <code>body</code>, it will
use this; otherwise &quot;Just type something...&quot; is the default. The code then
processes the body with Textile, which converts plain text to HTML, and then runs
the body through a regex to convert camel-case text into links, with the URL
base taken from the Catalyst request object. Finally, it outputs the HTML.</p>

<h4>Set Up the Wiki with Ajax</h4>

<p>Modify <em>root/view.tt</em> to include Ajax code:</p>

<pre><code>&lt;html&gt;
     &lt;head&gt;&lt;title&gt;MiniMojo&lt;/title&gt;&lt;/head&gt;
     [% c.prototype.define_javascript_functions %]
     [% url = base _ 'page/edit/' _ page.title %]
     &lt;body Onload=&quot;new Ajax.Updater( 'view',  '[% url %]' )&quot;&gt;
         &lt;h1&gt;[% page.title %]&lt;/h1&gt;
         &lt;div id=&quot;view&quot;&gt;&lt;/div&gt;
         &lt;textarea id=&quot;editor&quot; rows=&quot;24&quot; cols=&quot;80&quot;&gt;[% page.body %]&lt;/textarea&gt;
         [% c.prototype.observe_field( 'editor', {
             url =&gt; url,
             with =&gt; &quot;'body='+value&quot;,
             update =&gt; 'view' }
         ) %]
     &lt;/body&gt;
&lt;/html&gt;</code></pre>

<p>The line:</p>

<pre><code>[% c.prototype.define_javascript_functions %]</code></pre>

<p>includes the whole <em>prototype.js</em> library in a <code>script</code>
block. Note that the <code>prototype</code> plugin is available in the context
object.</p>

<p>The section</p>

<pre><code>[% url = base _ 'page/edit/' _ page.title %] 
&lt;body Onload=&quot;new Ajax.Updater( 'view',  '[% url %]' )&quot;&gt;
&lt;h1&gt;[% page.title %]&lt;/h1&gt;
&lt;div id=&quot;view&quot;&gt;&lt;/div&gt;</code></pre>

<p>constructs the Ajax URL and updates the view <code>div</code> when loading
the page.</p>

<p>Finally:</p>

<pre><code>&lt;textarea id=&quot;editor&quot; rows=&quot;24&quot; cols=&quot;80&quot;&gt;[% page.body %]&lt;/textarea&gt;
    [% c.prototype.observe_field( 'editor', {
        url =&gt; url,
        with =&gt; &quot;'body='+value&quot;,
        update =&gt; 'view' }
    ) %]</code></pre>

<p>periodically checks the <code>textarea</code> for changes and makes an Ajax
request on demand.</p>

<p>That's it! Now you can re-run the server and your wiki is up and running
(Figure 4). To use the wiki, simply start typing in the <code>textarea</code>.
As you type, the wiki will regularly echo your entry above, passing it through
the formatter.  When you type something in camel case, it will automatically
create a link you can click to go to the new page.</p>

<p><img src="/pub/2005/06/02/graphics/running-wiki-screenshot.gif" width="515" height="376" alt="screenshot of the running wiki"
/><br /><em>Figure 4. The running wiki</em></p>

<p>Enjoy your new Catalyst-powered Ajax wiki!</p>

<h3>Resources</h3>

<p>For more information, see the Catalyst documentation, in particular the <a
href="http://search.cpan.org/perldoc?Catalyst::Manual::Intro">Catalyst::Manual::Intro
module</a>, which gives a thorough introduction to the framework. There are two
<a href="http://lists.rawmode.org/mailman/listinfo">Catalyst mailing lists</a>,
a general list and a developer list.  The best place to discuss Catalyst,
though, is the <i>#catalyst</i> IRC channel at <a
href="http://irc.perl.org">irc.perl.org</a>. The <a
href="http://catalyst.perl.org/">Catalyst home page</a> is currently just a
collection of a few links, but we will extend it in the near future.</p>

<p>Thanks to Catalyst lead developer Sebastian Riedel for help with this
article and, of course, for Catalyst itself.</p>

<!-- sidebar begins -->
 <csperl file="grab" domain="on" record="b/1714" template="b/article_sidebar2.view">
<!-- sidebar ends -->


        </div>



    </div>
    <div class="asset-footer"></div>
</div>




                            <div class="content-nav">
                                <a href="/pub/2005/05/">&laquo; May 2005</a> |
                                <a href="/pub/">Main Index</a> |
                                <a href="/pub/archives.html">Archives</a>
                                | <a href="/pub/2005/07/">July 2005 &raquo;</a>
                            </div>


                        </div>
                    </div>


                    <div id="beta">
    <div id="beta-inner">


    
    <div class="widget-what-is-perl widget">
    <div class="widget-content widget-content-what-is-perl">
       Visit the home of the  Perl programming language: <a href="http://www.perl.org/">Perl.org</a
    </div>
</div>
<div class="widget-find-out-more widget-archives widget">
    <div class="widget-content">
        <ul>
            <li><a href="http://www.perl.org/get.html">Download</a></li>
            <li><a href="http://perldoc.perl.org/">Documentation</a></li>
            <li><a href="http://blogs.perl.org/">Perl Bloggers</a></li>
            <li><a href="http://news.perlfoundation.org/">Foundation News</a></li>
        </ul>
    </div>
</div><div class="widget-tcpc widget">
<h3 class="widget-header">Sponsored by</h3>
    <div class="widget-content">
        <a href="http://training.perl.com/" alt="Perl Training" target="_blank"><img src="/i/tcpc.png" width="150" height="50"></a>
    </div>
</div>

<div class="widget-syndication widget">
    <div class="widget-content">
        <ul>
            <li><img src="/mt-static/images/status_icons/feed.gif" alt="Subscribe to feed" width="9" height="9" /> <a href="/pub/atom.xml">Subscribe to this website's feed</a></li>

        </ul>
    </div>
</div>
<div class="widget-archive-monthly widget-archive widget">
    <h3 class="widget-header">Monthly <a href="/pub/archives.html">Archives</a></h3>
    <div class="widget-content">
        <ul>
        
            <li><a href="/pub/2014/02/">February 2014 (1)</a></li>
        
    
        
            <li><a href="/pub/2014/01/">January 2014 (1)</a></li>
        
    
        
            <li><a href="/pub/2013/10/">October 2013 (1)</a></li>
        
    
        
            <li><a href="/pub/2013/01/">January 2013 (1)</a></li>
        
    
        
            <li><a href="/pub/2012/12/">December 2012 (1)</a></li>
        
    
        
            <li><a href="/pub/2012/11/">November 2012 (1)</a></li>
        
    
        
            <li><a href="/pub/2012/10/">October 2012 (2)</a></li>
        
    
        
            <li><a href="/pub/2012/08/">August 2012 (2)</a></li>
        
    
        
            <li><a href="/pub/2012/06/">June 2012 (11)</a></li>
        
    
        
            <li><a href="/pub/2012/05/">May 2012 (18)</a></li>
        
    
        
            <li><a href="/pub/2012/04/">April 2012 (17)</a></li>
        
    
        
            <li><a href="/pub/2012/02/">February 2012 (1)</a></li>
        
    
        
            <li><a href="/pub/2011/12/">December 2011 (1)</a></li>
        
    
        
            <li><a href="/pub/2011/09/">September 2011 (1)</a></li>
        
    
        
            <li><a href="/pub/2011/08/">August 2011 (2)</a></li>
        
    
        
            <li><a href="/pub/2011/06/">June 2011 (1)</a></li>
        
    
        
            <li><a href="/pub/2011/05/">May 2011 (3)</a></li>
        
    
        
            <li><a href="/pub/2011/04/">April 2011 (1)</a></li>
        
    
        
            <li><a href="/pub/2011/03/">March 2011 (1)</a></li>
        
    
        
            <li><a href="/pub/2011/02/">February 2011 (1)</a></li>
        
    
        
            <li><a href="/pub/2011/01/">January 2011 (1)</a></li>
        
    
        
            <li><a href="/pub/2010/11/">November 2010 (1)</a></li>
        
    
        
            <li><a href="/pub/2010/10/">October 2010 (2)</a></li>
        
    
        
            <li><a href="/pub/2010/09/">September 2010 (1)</a></li>
        
    
        
            <li><a href="/pub/2010/08/">August 2010 (3)</a></li>
        
    
        
            <li><a href="/pub/2010/07/">July 2010 (2)</a></li>
        
    
        
            <li><a href="/pub/2010/04/">April 2010 (2)</a></li>
        
    
        
            <li><a href="/pub/2010/03/">March 2010 (4)</a></li>
        
    
        
            <li><a href="/pub/2008/05/">May 2008 (1)</a></li>
        
    
        
            <li><a href="/pub/2008/04/">April 2008 (2)</a></li>
        
    
        
            <li><a href="/pub/2008/03/">March 2008 (1)</a></li>
        
    
        
            <li><a href="/pub/2008/02/">February 2008 (1)</a></li>
        
    
        
            <li><a href="/pub/2008/01/">January 2008 (1)</a></li>
        
    
        
            <li><a href="/pub/2007/12/">December 2007 (2)</a></li>
        
    
        
            <li><a href="/pub/2007/09/">September 2007 (1)</a></li>
        
    
        
            <li><a href="/pub/2007/08/">August 2007 (1)</a></li>
        
    
        
            <li><a href="/pub/2007/07/">July 2007 (1)</a></li>
        
    
        
            <li><a href="/pub/2007/06/">June 2007 (1)</a></li>
        
    
        
            <li><a href="/pub/2007/05/">May 2007 (1)</a></li>
        
    
        
            <li><a href="/pub/2007/04/">April 2007 (1)</a></li>
        
    
        
            <li><a href="/pub/2007/03/">March 2007 (1)</a></li>
        
    
        
            <li><a href="/pub/2007/02/">February 2007 (1)</a></li>
        
    
        
            <li><a href="/pub/2007/01/">January 2007 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/12/">December 2006 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/11/">November 2006 (2)</a></li>
        
    
        
            <li><a href="/pub/2006/10/">October 2006 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/09/">September 2006 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/08/">August 2006 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/07/">July 2006 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/06/">June 2006 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/05/">May 2006 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/04/">April 2006 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/03/">March 2006 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/02/">February 2006 (4)</a></li>
        
    
        
            <li><a href="/pub/2006/01/">January 2006 (4)</a></li>
        
    
        
            <li><a href="/pub/2005/12/">December 2005 (4)</a></li>
        
    
        
            <li><a href="/pub/2005/11/">November 2005 (3)</a></li>
        
    
        
            <li><a href="/pub/2005/10/">October 2005 (2)</a></li>
        
    
        
            <li><a href="/pub/2005/09/">September 2005 (2)</a></li>
        
    
        
            <li><a href="/pub/2005/08/">August 2005 (9)</a></li>
        
    
        
            <li><a href="/pub/2005/07/">July 2005 (8)</a></li>
        
    
        
            <li><a href="/pub/2005/06/">June 2005 (9)</a></li>
        
    
        
            <li><a href="/pub/2005/05/">May 2005 (8)</a></li>
        
    
        
            <li><a href="/pub/2005/04/">April 2005 (7)</a></li>
        
    
        
            <li><a href="/pub/2005/03/">March 2005 (6)</a></li>
        
    
        
            <li><a href="/pub/2005/02/">February 2005 (7)</a></li>
        
    
        
            <li><a href="/pub/2005/01/">January 2005 (6)</a></li>
        
    
        
            <li><a href="/pub/2004/12/">December 2004 (8)</a></li>
        
    
        
            <li><a href="/pub/2004/11/">November 2004 (8)</a></li>
        
    
        
            <li><a href="/pub/2004/10/">October 2004 (5)</a></li>
        
    
        
            <li><a href="/pub/2004/09/">September 2004 (9)</a></li>
        
    
        
            <li><a href="/pub/2004/08/">August 2004 (6)</a></li>
        
    
        
            <li><a href="/pub/2004/07/">July 2004 (8)</a></li>
        
    
        
            <li><a href="/pub/2004/06/">June 2004 (6)</a></li>
        
    
        
            <li><a href="/pub/2004/05/">May 2004 (7)</a></li>
        
    
        
            <li><a href="/pub/2004/04/">April 2004 (8)</a></li>
        
    
        
            <li><a href="/pub/2004/03/">March 2004 (8)</a></li>
        
    
        
            <li><a href="/pub/2004/02/">February 2004 (9)</a></li>
        
    
        
            <li><a href="/pub/2004/01/">January 2004 (7)</a></li>
        
    
        
            <li><a href="/pub/2003/12/">December 2003 (4)</a></li>
        
    
        
            <li><a href="/pub/2003/11/">November 2003 (7)</a></li>
        
    
        
            <li><a href="/pub/2003/10/">October 2003 (8)</a></li>
        
    
        
            <li><a href="/pub/2003/09/">September 2003 (6)</a></li>
        
    
        
            <li><a href="/pub/2003/08/">August 2003 (7)</a></li>
        
    
        
            <li><a href="/pub/2003/07/">July 2003 (9)</a></li>
        
    
        
            <li><a href="/pub/2003/06/">June 2003 (9)</a></li>
        
    
        
            <li><a href="/pub/2003/05/">May 2003 (8)</a></li>
        
    
        
            <li><a href="/pub/2003/04/">April 2003 (8)</a></li>
        
    
        
            <li><a href="/pub/2003/03/">March 2003 (10)</a></li>
        
    
        
            <li><a href="/pub/2003/02/">February 2003 (8)</a></li>
        
    
        
            <li><a href="/pub/2003/01/">January 2003 (8)</a></li>
        
    
        
            <li><a href="/pub/2002/12/">December 2002 (5)</a></li>
        
    
        
            <li><a href="/pub/2002/11/">November 2002 (9)</a></li>
        
    
        
            <li><a href="/pub/2002/10/">October 2002 (7)</a></li>
        
    
        
            <li><a href="/pub/2002/09/">September 2002 (11)</a></li>
        
    
        
            <li><a href="/pub/2002/08/">August 2002 (8)</a></li>
        
    
        
            <li><a href="/pub/2002/07/">July 2002 (8)</a></li>
        
    
        
            <li><a href="/pub/2002/06/">June 2002 (4)</a></li>
        
    
        
            <li><a href="/pub/2002/05/">May 2002 (6)</a></li>
        
    
        
            <li><a href="/pub/2002/04/">April 2002 (6)</a></li>
        
    
        
            <li><a href="/pub/2002/03/">March 2002 (7)</a></li>
        
    
        
            <li><a href="/pub/2002/02/">February 2002 (5)</a></li>
        
    
        
            <li><a href="/pub/2002/01/">January 2002 (8)</a></li>
        
    
        
            <li><a href="/pub/2001/12/">December 2001 (7)</a></li>
        
    
        
            <li><a href="/pub/2001/11/">November 2001 (5)</a></li>
        
    
        
            <li><a href="/pub/2001/10/">October 2001 (9)</a></li>
        
    
        
            <li><a href="/pub/2001/09/">September 2001 (7)</a></li>
        
    
        
            <li><a href="/pub/2001/08/">August 2001 (13)</a></li>
        
    
        
            <li><a href="/pub/2001/07/">July 2001 (8)</a></li>
        
    
        
            <li><a href="/pub/2001/06/">June 2001 (13)</a></li>
        
    
        
            <li><a href="/pub/2001/05/">May 2001 (11)</a></li>
        
    
        
            <li><a href="/pub/2001/04/">April 2001 (9)</a></li>
        
    
        
            <li><a href="/pub/2001/03/">March 2001 (8)</a></li>
        
    
        
            <li><a href="/pub/2001/02/">February 2001 (8)</a></li>
        
    
        
            <li><a href="/pub/2001/01/">January 2001 (8)</a></li>
        
    
        
            <li><a href="/pub/2000/12/">December 2000 (6)</a></li>
        
    
        
            <li><a href="/pub/2000/11/">November 2000 (10)</a></li>
        
    
        
            <li><a href="/pub/2000/10/">October 2000 (10)</a></li>
        
    
        
            <li><a href="/pub/2000/09/">September 2000 (2)</a></li>
        
    
        
            <li><a href="/pub/2000/08/">August 2000 (2)</a></li>
        
    
        
            <li><a href="/pub/2000/07/">July 2000 (5)</a></li>
        
    
        
            <li><a href="/pub/2000/06/">June 2000 (7)</a></li>
        
    
        
            <li><a href="/pub/2000/05/">May 2000 (7)</a></li>
        
    
        
            <li><a href="/pub/2000/04/">April 2000 (3)</a></li>
        
    
        
            <li><a href="/pub/2000/03/">March 2000 (2)</a></li>
        
    
        
            <li><a href="/pub/2000/02/">February 2000 (2)</a></li>
        
    
        
            <li><a href="/pub/2000/01/">January 2000 (2)</a></li>
        
    
        
            <li><a href="/pub/1999/12/">December 1999 (6)</a></li>
        
    
        
            <li><a href="/pub/1999/11/">November 1999 (6)</a></li>
        
    
        
            <li><a href="/pub/1999/10/">October 1999 (5)</a></li>
        
    
        
            <li><a href="/pub/1999/09/">September 1999 (4)</a></li>
        
    
        
            <li><a href="/pub/1999/08/">August 1999 (3)</a></li>
        
    
        
            <li><a href="/pub/1999/07/">July 1999 (2)</a></li>
        
    
        
            <li><a href="/pub/1999/06/">June 1999 (3)</a></li>
        
    
        
            <li><a href="/pub/1999/04/">April 1999 (1)</a></li>
        
    
        
            <li><a href="/pub/1999/03/">March 1999 (1)</a></li>
        
    
        
            <li><a href="/pub/1999/01/">January 1999 (1)</a></li>
        
    
        
            <li><a href="/pub/1998/12/">December 1998 (1)</a></li>
        
    
        
            <li><a href="/pub/1998/11/">November 1998 (1)</a></li>
        
    
        
            <li><a href="/pub/1998/07/">July 1998 (2)</a></li>
        
    
        
            <li><a href="/pub/1998/06/">June 1998 (1)</a></li>
        
    
        
            <li><a href="/pub/1998/03/">March 1998 (1)</a></li>
        
        </ul>
    </div>
</div>
        
    

<div class="widget-powered widget">
    <div class="widget-content">
        <a href="http://www.movabletype.com/"><img src="/mt-static/images/bug-pbmt-white.png" alt="Powered by Movable Type 5.13-en" width="120" height="75" /></a>
    </div>
</div>



    </div>
</div>






                </div>
            </div>


            <div id="footer">
    <div id="footer-inner">
        <div id="footer-content">
            <div class="widget-powered widget">
                <div class="widget-content">
                    Powered by <a href="http://www.movabletype.com/" rel="generator">Movable Type Pro</a>
                </div>
            </div>

            <div class="widget-creative-commons widget">
                <div class="widget-content">
                    This blog is licensed under a <a href="http://creativecommons.org/licenses/by-nc-nd/3.0/">Creative Commons License</a>.
                </div>
            </div>

        </div>
    </div>
</div>



        </div>
    </div>
</body>
</html>
