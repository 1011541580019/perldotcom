<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" id="sixapart-standard">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="generator" content="Movable Type Pro 5.13-en" />
<link rel="stylesheet" href="/pub/styles.css" type="text/css" />
<link rel="start" href="/pub/" title="Home" />
<link rel="alternate" type="application/atom+xml" title="Recent Entries" href="/pub/atom.xml" />
<script type="text/javascript" src="/pub/mt.js"></script>
<!--
<rdf:RDF xmlns="http://web.resource.org/cc/"
         xmlns:dc="http://purl.org/dc/elements/1.1/"
         xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#">
<Work rdf:about="/pub/">
<dc:title>Perl.com</dc:title>
<dc:description>news and views of the Perl programming language</dc:description>
<license rdf:resource="http://creativecommons.org/licenses/by-nc-nd/3.0/" />
</Work>
<License rdf:about="http://creativecommons.org/licenses/by-nc-nd/3.0/">
</License>
</rdf:RDF>
-->

<script type="text/javascript">

 var _gaq = _gaq || [];
 _gaq.push(['_setAccount', 'UA-50555-22']);
 _gaq.push(['_trackPageview']);

 (function() {
   var ga = document.createElement('script'); ga.type =
   'text/javascript'; ga.async = true;
   ga.src = ('https:' == document.location.protocol ? 'https://ssl' :
   'http://www') + '.google-analytics.com/ga.js';
   var s = document.getElementsByTagName('script')[0];
   s.parentNode.insertBefore(ga, s);
 })();

</script>
<script type='text/javascript' src='http://partner.googleadservices.com/gampad/google_service.js'></script>
<script type='text/javascript'>
GS_googleAddAdSenseService("ca-pub-4136420132070439");
GS_googleEnableAllServices();
</script>
<script type='text/javascript'>
GA_googleAddSlot("ca-pub-4136420132070439", "Perl_728x90");
</script>
<script type='text/javascript'>GA_googleFetchAds();</script>
    <title>Perl.com: February 2005 Archives</title>


    <link rel="prev" href="/pub/2005/01/" title="January 2005" />
    <link rel="next" href="/pub/2005/03/" title="March 2005" />

</head>
<body id="perl-com" class="mt-archive-listing mt-datebased-monthly-archive layout-wt">
    <div id="container">
        <div id="container-inner">


            <div id="header">
    <div id="header-inner">
        <div id="header-content">
        <span id="top_advert"> 
<!-- Put any landscape advert in here -->
<!-- Perl_728x90 -->
<script type='text/javascript'>
GA_googleFillSlot("Perl_728x90");
</script>
        </span> 



            <div id="header-name"><a href="/pub/" accesskey="1">Perl.com</a></div>
            <div id="header-description">news and views of the Perl programming language</div>




        </div>
    </div>
</div>



            <div id="content">
                <div id="content-inner">


                    <div id="alpha">
                        <div id="alpha-inner">


                            <h1 id="page-title" class="archive-title">February 2005 Archives</h1>





                            
                            <div id="entry-732" class="entry-asset asset hentry">
    <div class="asset-header">
        <h2 class="asset-name entry-title"><a href="/pub/2005/02/p6pdigest/20050222.html" rel="bookmark">This Fortnight in Perl 6, Feb. 9-22, 2005</a></h2>
        <div class="asset-meta">
            <span class="byline">
    
                By <span class="vcard author">Matt Fowles</span> on <abbr class="published" title="2005-02-24T00:00:00-08:00">February 24, 2005 12:00 AM</abbr>
    
            </span>

            
            

        </div>
    </div>
    <div class="asset-content entry-content">

        <div class="asset-body">
            
<!-- sidebar begins -->
<!-- don't move sidebars-->
<!-- sidebar ends -->
<p>Welcome to yet another fortnight summary. Lately, p6l has outstripped p6i in
volume. While this used to be the norm, it has become a rare occurrence.
Strange. Anyway, this summary would be brought to you by cookies, but I ate
them all. So instead this summary is brought to you by the remaining chocolate
chips. In other news, Autrijus Tang has just officially received a promotion to
first-name-only status in these summaries, based on both his stellar work with
Pugs and his highly identifiable name.  He now joins the ranks of Larry, Dan,
Madonna, and Leo.</p>

<h3>Perl 6 Language</h3>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.language/browse_frm/thread/c9f1db8d113c08d7/027f23343c652443?_done=%2Fgroup%2Fperl.perl6.language%3F&amp;_doneTitle=Back+to+topics&amp;_doneTitle=Back&amp;&amp;d#027f23343c652443"><code>do
{ } while?</code></a></h4>

<p>David Storrs wanted to know the best way to say <code>do { }
while($foo);</code>. Larry told him that <code>s/do/loop/</code> would
suffice.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.language/browse_frm/thread/32db8717ba0e550d/ac779781875c86f0?_done=%2Fgroup%2Fperl.perl6.language%3F&amp;_doneTitle=Back+to+topics&amp;_doneTitle=Back&amp;&amp;d#ac779781875c86f0"><code>nest</code>
as a Primitive Looping Operation</a></h4>

<p>Timothy Nelson receives credit for resurrecting the oldest thread I have
seen brought back recently. Over two years ago, he mentioned a powerful looping
structure that allowed for recursion. Now he has found a use for it.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.language/browse_frm/thread/b35c605369380b56/f4fa6b3ece451d3a?_done=%2Fgroup%2Fperl.perl6.language%3F&amp;_doneTitle=Back+to+topics&amp;_doneTitle=Back&amp;&amp;d#f4fa6b3ece451d3a">Loop
Entry</a></h4>

<p>Joe Gottman wanted to execute a closure on every loop entrance, not upon
every iteration. He thought <code>ENTER</code> happened only once ever, but it
turns out that it will do what he wants.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.language/browse_frm/thread/5b644ba7bf32ee8b/2ef0d824408271ad?_done=%2Fgroup%2Fperl.perl6.language%3F&amp;_doneTitle=Back+to+topics&amp;_doneTitle=Back&amp;&amp;d#2ef0d824408271ad"><code>pop
%hash</code></a></h4>

<p>Rod Adams wants to be able to pop a key value pair out of a hash. Others
wondered what to use it for. Someone mentioned an OrderedHash.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.language/browse_frm/thread/1a81badb5e7d23e1/3350855574037772?_done=%2Fgroup%2Fperl.perl6.language%3F&amp;_doneTitle=Back+to+topics&amp;_doneTitle=Back&amp;&amp;d#3350855574037772">Higher
Order Operators</a></h4>

<!-- sidebar begins -->
 <csperl file="grab" domain="on" record="b/1424" template="b/article_sidebar.view">
<!-- sidebar ends -->

<p>Timothy Nelson wanted meta-operators. Larry gave him the full Unicode
character set with which to define them. Tim was happy.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.language/browse_frm/thread/f9fce475f19a5353/2b9ded586f3b69a4?_done=%2Fgroup%2Fperl.perl6.language%3F&amp;_doneTitle=Back+to+topics&amp;_doneTitle=Back&amp;&amp;d#2b9ded586f3b69a4">None
and Nor Delimiters</a></h4>

<p>Thomas Sandla&szlig; suggested using <code>\</code> as a none junction
delimiter. He then extended this idea to provide a logical nor,
<code>\\</code>. Autrijus suggested <code>!</code> for none. There was some
argument about whether nor deserved such Huffmanization. Also, I think that the
difference between <code>//</code> and <code>\\</code> would continually escape
me. I have enough trouble writing code to deal with Windows filesystems.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.language/browse_frm/thread/9e827e4150cbb3b6/204b4e76d72484ed?_done=%2Fgroup%2Fperl.perl6.language%3F&amp;_doneTitle=Back+to+topics&amp;_doneTitle=Back&amp;&amp;d#204b4e76d72484ed">Kudos
to Autrijus</a></h4>

<p>Damian proudly welcomed Autrijus to the ranks of the last-nameless-ones.  He
also lauded Autrijus' amazing work at forcing a lazy language to pull a lazier one. I
think we all agree.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.language/browse_frm/thread/2d48d854b9cbe1a8/6c319c910f835318?_done=%2Fgroup%2Fperl.perl6.language%3F&amp;_doneTitle=Back+to+topics&amp;_doneTitle=Back&amp;&amp;d#6c319c910f835318">Containers
vs. Object References</a></h4>

<p>Rod Adams wondered whether there was a litmus test that could determine if
something deserved its own sigil. The answer appears to be mostly history.
Larry suggested a simplistic way to create new sigils, although it would not
provide interpolation. I think a blessed method for defining new sigils which
do interpolate and provide some sort of type constraint and context would be
really nifty. Also I want a million dollars in small, non-consecutive, unmarked
bills. If you have either, please mail it to me.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.language/browse_frm/thread/a2a26b0100a72e7a/f34c506880675af8?_done=%2Fgroup%2Fperl.perl6.language%3F&amp;_doneTitle=Back+to+topics&amp;_doneTitle=Back&amp;&amp;d#f34c506880675af8">Printing
True</a></h4>

<p>Autrijus wondered about true and false. Are they just 1 and 0? #t and #f?
Larry answered <code>bool::true</code> and <code>bool::false</code>, but
<code>true</code> and <code>false</code> will suffice when there is no
ambiguity.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.language/browse_frm/thread/8ce3c96d680b43fd/c95c3599e4ec1bb5?_done=%2Fgroup%2Fperl.perl6.language%3F&amp;_doneTitle=Back+to+topics&amp;_doneTitle=Back&amp;&amp;d#c95c3599e4ec1bb5">Quoted
=&gt; LHS</a></h4>

<p>Juerd wondered if <code>=&gt;</code> auto-quotes its left hand side.  It
does.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.language/browse_frm/thread/ede7a284fa3de442/6846196d7b25e342?_done=%2Fgroup%2Fperl.perl6.language%3F&amp;_doneTitle=Back+to+topics&amp;_doneTitle=Back&amp;&amp;d#6846196d7b25e342"><code>"@"
x 75 ~ $zap =?= ("@" x 75) ~ $zap</code></a></h4>

<p>Juerd mistakenly thought that <code>~</code> bound more tightly than
<code>x</code>. Only unary <code>~</code> binds that tightly, so he is
safe.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.language/browse_frm/thread/15b8cd859be7f54f/b6a226dcb9efa426?_done=%2Fgroup%2Fperl.perl6.language%3F&amp;_doneTitle=Back+to+topics&amp;_doneTitle=Back&amp;&amp;d#b6a226dcb9efa426">Getting
the key|value of a Pair</a></h4>

<p>Steve Peters wondered how he could get the key or value from a pair. It
turns out that the <code>.key</code> and <code>.value</code> method does what
he wants until some twisted soul overrides them.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.language/browse_frm/thread/868ab2f20deb00d8/1036a84d6d4f1bc7?_done=%2Fgroup%2Fperl.perl6.language%3F&amp;_doneTitle=Back+to+topics&amp;_doneTitle=Back&amp;&amp;d#1036a84d6d4f1bc7">Junctions
and Auto-threading</a></h4>

<p>By far the longest topic this week was junctions. Some people worry that
their auto-threaded behavior will cause plagues to ravage the earth and novices
programmers to go blind. Others feel that without it Perl 6 will be a language
suitable only to pond scum and cobol programmers. While one side believes that
auto-threading repetition of sid effects will crash any database that interacts
with Perl 6, the other side believes that requiring extra pragmas to unlock
their full power will prevent junctions from curing cancer. Either way someone
will be unhappy. It looked like the pendulum was swinging towards
auto-threading, but its chief proponent will be away next week, so who knows if
it can survive undefended. My favorite suggestion in all of this was to make
Perl 6 a pure functional language and introduce monads.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.language/browse_frm/thread/d794435fc53aeeb4/3d546e5dcdcbcbe9?_done=%2Fgroup%2Fperl.perl6.language%3F&amp;_doneTitle=Back+to+topics&amp;_doneTitle=Back&amp;&amp;d#3d546e5dcdcbcbe9">Nullary
vs. Non-slurpy</a></h4>

<p>Autrijus found it distressing that he had to make an empty signature slurpy
to make his quicksort sort quickly. Larry assured him that it was okay.  This
also led to a question of MMD tie-breaking. Remember to attach an <code>is
default</code> if you want your ties broken!</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.language/browse_frm/thread/e375876af57e5ad7/17172a371838d9c7?_done=%2Fgroup%2Fperl.perl6.language%3F&amp;_doneTitle=Back+to+topics&amp;_doneTitle=Back&amp;&amp;d#17172a371838d9c7">Pairs</a></h4>

<p>Steve Peters had a few more questions about pairs, which made Osfameron
notice that he could use pairs like Lisp's dotted pairs. Larry admitted that he
could and had hoped that no one would notice.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.language/browse_frm/thread/3630972c1f5fe7c3/150340a8a903ede8?_done=%2Fgroup%2Fperl.perl6.language%3F&amp;_doneTitle=Back+to+topics&amp;_doneTitle=Back&amp;&amp;d#150340a8a903ede8">Octal
Strings</a></h4>

<p>Luke Palmer wondered which strings would change radix and to what. The
consensus was that something needed to change, but no one is sure what.</p>

<h3>Perl 6 Compilers</h3>

<h4>
Pugs 6.0.8
</h4>

<p>Pugs continues to approach 2 * &pi; with the release of 6.0.5. Later
Autrijus decided that he should release more stuff and put out 6.0.8. It has
many new features and a much improved test suite. You should contribute tests.
All the cool people are.</p>

<ul>

<li><a href="http://groups-beta.google.com/group/perl.perl6.compiler/browse_frm/thread/8edbef4e7c155c76/155ff69eab6c65ea?_done=%2Fgroup%2Fperl.perl6.compiler%3F&amp;_doneTitle=Back+to+topics&amp;_doneTitle=Back&amp;&amp;d#155ff69eab6c65ea">6.0.5</a></li>

<li><a href="http://groups-beta.google.com/group/perl.perl6.compiler/browse_frm/thread/160da4b6afe8cff6/b7b6510ff0759f7e?_done=%2Fgroup%2Fperl.perl6.compiler%3F&amp;_doneTitle=Back+to+topics&amp;_doneTitle=Back&amp;&amp;d#b7b6510ff0759f7e">6.0.8</a></li>

</ul>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.compiler/browse_frm/thread/fd1eab71f4989384/c4121f7ec106c925?_done=%2Fgroup%2Fperl.perl6.compiler%3F&amp;_doneTitle=Back+to+topics&amp;_doneTitle=Back&amp;&amp;d#c4121f7ec106c925">List
of builtins</a></h4>

<p>Autrijus wondered if there was a list of builtins anywhere. Patrick pointed
him to his start.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.compiler/browse_frm/thread/496f6f549a052253/67611a8b0bd750b5?_done=%2Fgroup%2Fperl.perl6.compiler%3F&amp;_doneTitle=Back+to+topics&amp;_doneTitle=Back&amp;&amp;d#67611a8b0bd750b5">Perl
6 Now</a></h4>

<p>Autrijus wondered if the unit tests for Perl 6 Now were available.  Scott
Walters told him that they were public domain. Autrijus gleefully sicced a
small, ugly dog on them.</p>

<h4>
Pugs tests
</h4>

<p>??? proved that he was cool by providing Pugs tests. So did Steve Peters,
Benjamin Smith, and Stevan Little. I bet you wish you were cool too.</p>

<ul>

<li><a
href="http://groups-beta.google.com/group/perl.perl6.compiler/browse_frm/thread/cf1fb64a97586be3/3e1cb81a3e282bf4?_done=%2Fgroup%2Fperl.perl6.compiler%3F&amp;_doneTitle=Back+to+topics&amp;_doneTitle=Back&amp;&amp;d#3e1cb81a3e282bf4">???</a></li>

<li><a
href="http://groups-beta.google.com/group/perl.perl6.compiler/browse_frm/thread/a02f28ad5a1a4109/781c0d6e092ad718?_done=%2Fgroup%2Fperl.perl6.compiler%3F&amp;_doneTitle=Back+to+topics&amp;_doneTitle=Back&amp;&amp;d#781c0d6e092ad718">Steve</a></li>

<li><a
href="http://groups-beta.google.com/group/perl.perl6.compiler/browse_frm/thread/ffb637727347a7ab/19f46916c942883e?_done=%2Fgroup%2Fperl.perl6.compiler%3F&amp;_doneTitle=Back+to+topics&amp;_doneTitle=Back&amp;&amp;d#19f46916c942883">Benjamin</a></li>


<li><a
href="http://groups-beta.google.com/group/perl.perl6.compiler/browse_frm/thread/83a37a5a08e90017/f4f98b978914173b?_done=%2Fgroup%2Fperl.perl6.compiler%3F&amp;_doneTitle=Back+to+topics&amp;_doneTitle=Back&amp;&amp;d#f4f98b978914173">Stevan</a></li>


</ul>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.compiler/browse_frm/thread/fda6e0e3d06d9b81/36168631eb11950d?_done=%2Fgroup%2Fperl.perl6.compiler%3F&amp;_doneTitle=Back+to+topics&amp;_doneTitle=Back&amp;&amp;d#36168631eb11950d">Pugscode.org</a></h4>

<p>Autrijus registered <a href="http://pugscode.org/">pugscode.org</a> and
populated it.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.compiler/browse_frm/thread/fa51e00fc3e32be7/54d4a42ff2abd895?_done=%2Fgroup%2Fperl.perl6.compiler%3F&amp;_doneTitle=Back+to+topics&amp;_doneTitle=Back&amp;&amp;d#54d4a42ff2abd895"><code>%*ENV</code>
in pugs</a></h4>

<p>Rafael Garcia-Suarez wanted access to <code>%*ENV</code>, so he added it
with tests.</p>

<h3>Parrot</h3>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/e0e9845d7619554f/797b41e7df0af799?_done=%2Fgroup%2Fperl.perl6.internals%3F&amp;_doneTitle=Back+to+topics&amp;_doneTitle=Back&amp;&amp;d#797b41e7df0af799">GNU
R</a></h4>

<p>Yves Breitmoser wants to improve the support for GNU R in Perl. Aaron
Sherman suggested using Parrot as a back-end for Parrot, which would allow any
language that targets Parrot to use R.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/6c14fd2b66c449d3/da930957ecaf740a?_done=%2Fgroup%2Fperl.perl6.internals%3F&amp;_doneTitle=Back+to+topics&amp;_doneTitle=Back&amp;&amp;d#da930957ecaf740a"><code>make
html</code></a></h4>

<p>Markus Amslser submitted a patch to fix <code>make html</code>. Leo applied
it.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/f21946c947860f10/e3f73f70cc579f81?_done=%2Fgroup%2Fperl.perl6.internals%3F&amp;_doneTitle=Back+to+topics&amp;_doneTitle=Back&amp;&amp;d#e3f73f70cc579f81">Win32
<code>bind(accept(listen()))</code></a></h4>

<p>Markus Amslser submitted a patch adding <code>bind</code>,
<code>listen</code>, and <code>accept</code> on Win32. Leo applied it.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/4d8c764063f50446/743fe0d97af8fb20?_done=%2Fgroup%2Fperl.perl6.internals%3F&amp;_doneTitle=Back+to+topics&amp;_doneTitle=Back&amp;&amp;d#743fe0d97af8fb20">Commit
Privileges</a></h4>

<p>Bernhard Schmalhofer received commit privileges in recognition of his many
high quality patches. Congrats Bernhard!</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/28d2209f38dd22a8/1f3c3a31d79b71f7?_done=%2Fgroup%2Fperl.perl6.internals%3F&amp;_doneTitle=Back+to+topics&amp;_doneTitle=Back&amp;&amp;d#1f3c3a31d79b71f7">Tiny
Webserver</a></h4>

<p>Markus Amslser also provided a patch to allow his tiny webserver to run on
Linux. Leo applied it.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/0249207572737092/dd04c9970791c4a0?_done=%2Fgroup%2Fperl.perl6.internals%3F&amp;_doneTitle=Back+to+topics&amp;_doneTitle=Back&amp;&amp;d#dd04c9970791c4a0">FreeBSD
Build Failure</a></h4>

<p>Adriano Ferreira fixed some problems with the FreeBSD build. Leo applied the
patch.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/f3fab2ac907655ca/217c973cc03ce324?_done=%2Fgroup%2Fperl.perl6.internals%3F&amp;_doneTitle=Back+to+topics&amp;_doneTitle=Back&amp;&amp;d#217c973cc03ce324">Parrot
0.1.2</a></h4>

<p>Will Coleda continued pushing for a 0.1.2 release. Leo told him that there
would be a release after the German Perl Workshop, which should be ending
soon.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/33d379077b32a52a/5b13e8374e061881?_done=%2Fgroup%2Fperl.perl6.internals%3F&amp;_doneTitle=Back+to+topics&amp;_doneTitle=Back&amp;&amp;d#5b13e8374e061881">Linux
PPC</a></h4>

<p>Leo attempted to fix the longstanding issues with Linux PPC configure.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/e7aaad0dcfe9205c/f4b32479194a9920?_done=%2Fgroup%2Fperl.perl6.internals%3F&amp;_doneTitle=Back+to+topics&amp;_doneTitle=Back&amp;&amp;d#f4b32479194a9920">Failing
Python Tests</a></h4>

<p>Andy Dougherty noticed failures on some of the <code>dynclasses/py*.t</code>
tests. He is working with Leo on providing enough information to solve the
problem.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/f27777feb08ea5aa/7a88d1ce65b07f90?_done=%2Fgroup%2Fperl.perl6.internals%3F&amp;_doneTitle=Back+to+topics&amp;_doneTitle=Back&amp;&amp;d#7a88d1ce65b07f90">PyPy</a></h4>

<p>Christian Tismer posted to the list informing everyone about the PyPy sprint
at Washington, DC's PyCon 2005. They are eager to compare notes with other
developers.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/113ba6bba4850f21/37c99776d01d9c17?_done=%2Fgroup%2Fperl.perl6.internals%3F&amp;_doneTitle=Back+to+topics&amp;_doneTitle=Back&amp;&amp;d#37c99776d01d9c17"><code>string_init</code>
and ICU data dir</a></h4>

<p>Ron Blaschke noticed that Parrot choked on an empty ICU data dir.  Leo fixed
it.</p>

<h4>
Win32 Parrot
</h4>

<p>Ron Blaschke wants to improve Parrot building on Win32. He has offered to
add the necessary <code>PARROT_API</code> macros and do other footwork.</p>

<ul>

<li><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/abac320f8dc6d90d/9130bd5912878379?_done=%2Fgroup%2Fperl.perl6.internals%3F&amp;_doneTitle=Back+to+topics&amp;_doneTitle=Back&amp;&amp;d#9130bd591287837">9
PARROT_API</a></li>

<li><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/b63bab9684650c32/c4bc15f10e8f7d60?_done=%2Fgroup%2Fperl.perl6.internals%3F&amp;_doneTitle=Back+to+topics&amp;_doneTitle=Back&amp;&amp;d#c4bc15f10e8f7d60">gdbm
Linkage</a></li>

<li><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/eda36ef909e84317/4db270db2ebb7561?_done=%2Fgroup%2Fperl.perl6.internals%3F&amp;_doneTitle=Back+to+topics&amp;_doneTitle=Back&amp;&amp;d#4db270db2ebb756">1
outdated rt ticket</a></li>

<li><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/eb464ab13c6dc054/eadab236b54d5de7?_done=%2Fgroup%2Fperl.perl6.internals%3F&amp;_doneTitle=Back+to+topics&amp;_doneTitle=Back&amp;&amp;d#eadab236b54d5de7">old
rt ticket</a></li>

<li><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/cee1de139ac3da71/d79538b415443c79?_done=%2Fgroup%2Fperl.perl6.internals%3F&amp;_doneTitle=Back+to+topics&amp;_doneTitle=Back&amp;&amp;d#d79538b415443c79">fix
libnci_test</a></li>

<li><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/c1cfed051524da21/fc47832e8ad8d9da?_done=%2Fgroup%2Fperl.perl6.internals%3F&amp;_doneTitle=Back+to+topics&amp;_doneTitle=Back&amp;&amp;d#fc47832e8ad8d9da">old
ticket</a></li>

<li><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/7af573280e794bd1/dbf4ab93a9b7d19c?_done=%2Fgroup%2Fperl.perl6.internals%3F&amp;_doneTitle=Back+to+topics&amp;_doneTitle=Back&amp;&amp;d#dbf4ab93a9b7d19c">out
of date ticket</a></li>

<li><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/3e814abbed111af7/4c67e51a63a4c90d?_done=%2Fgroup%2Fperl.perl6.internals%3F&amp;_doneTitle=Back+to+topics&amp;_doneTitle=Back&amp;&amp;d#4c67e51a63a4c90d">dbm
troubles</a></li>

</ul>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/f81a7fdd8efff573/ab739e5ea1d1cc0f?_done=%2Fgroup%2Fperl.perl6.internals%3F&amp;_doneTitle=Back+to+topics&amp;_doneTitle=Back&amp;&amp;d#ab739e5ea1d1cc0f">Tail Calls</a></h4>

<p>Bob Rogers wants to make tail calls without knowing the last call's return
values. Currently he just lies to IMCC to make it work. Leo pointed him to
<code>interpinfo .INTERPINFO_CURRENT_CONT</code> and also suggested 
adding a <code>tail_call</code> op.</p>

<h3>The Usual Footer</h3>

<p>Posting via the Google Groups interface does not work. To post to any of
these mailing lists please subscribe by sending email to <a
href="mailto:perl6-internals-subscribe@perl.org">perl6-internals-subscribe@perl.org</a>,
<a
href="mailto:perl6-language-subscribe@perl.org">perl6-language-subscribe@perl.org</a>,
or <a
href="mailto:perl6-compiler-subscribe@perl.org">perl6-compiler-subscribe@perl.org</a>.
If you find these summaries useful or enjoyable, please consider contributing
to the Perl Foundation to help support the development of Perl. You might also
like to send feedback to <a
href="mailto:ubermatt@gmail.com">ubermatt@gmail.com</a>.</p>

<ul>

<li><a href="http://donate.perl-foundation.org/">The Perl Foundation</a></li>
<li><a href="http://dev.perl.org/perl6/">Perl 6 Development site</a></li>
<li><a href="http://planet.parrotcode.org/">Parrot Blog aggregator</a></li>

</ul>


        </div>



    </div>
    <div class="asset-footer"></div>
</div>


                            
                            <div id="entry-728" class="entry-asset asset hentry">
    <div class="asset-header">
        <h2 class="asset-name entry-title"><a href="/pub/2005/02/24/mandrakelinux.html" rel="bookmark">Perl and Mandrakelinux</a></h2>
        <div class="asset-meta">
            <span class="byline">
    
                By <span class="vcard author">Mark Stosberg</span> on <abbr class="published" title="2005-02-24T00:00:00-08:00">February 24, 2005 12:00 AM</abbr>
    
            </span>

            
            

        </div>
    </div>
    <div class="asset-content entry-content">

        <div class="asset-body">
            
<!-- sidebar begins -->
<!-- don't move sidebars-->
<!-- sidebar ends -->
<p><em>Perl programmers have a special reason for choosing <a
href="http://www.mandrakelinux.com/">Mandrakelinux</a> as their desktop
operating system. Mandrakelinux uses Perl for dozens of the graphical "value
added" utilities included with the distribution, including much of the
Mandrakelinux Control Center. I asked Mandrakelinux for an interview with a top
Perl contributor and they sent <a href="http://rgarciasuarez.free.fr/">Rafael
Garcia-Suarez</a> my way. Besides being heavily involved with Perl at
Mandrakesoft, Rafael is also the pumpking for the Perl 5.10 release. Rafael
answered my questions about using Perl for GUI programming and how he balances
his day job with being pumpking.</em></p>

<p><strong>O'Reilly Network:</strong> Briefly tell us about the Perl work you
do for Mandrakelinux.</p>

<p><strong>Rafael:</strong> My main responsibility is to maintain and enhance
the command-line tool urpmi (and its GUI counterpart rpmdrake), which are the
Mandrakelinux equivalent of Debian's apt or Fedora's yum; that is, fetching
RPMs and their dependencies and installing or upgrading them.</p>

<!-- sidebar begins -->
 <csperl file="grab" domain="on" record="b/1430" template="b/article_sidebar.view">
<!-- sidebar ends -->

<p>This job extends to whatever pertains to installing RPMs; that means that I
also participate in enhancing Mandrakelinux's installer. All those tools are
written in Perl.</p>

<p>Besides this, I also maintain the RPM of perl itself and of a load of CPAN
modules for Mandrakelinux.</p>

<p><strong>ORN:</strong> Perl is uncommon choice for graphical programming, yet
Mandrakelinux has used Perl for over 50 graphical applications. Many of these
tools are specific to Mandrakelinux, adding value to the distribution. What can
you tell us about why Mandrakelinux uses Perl for this important role?</p>

<p><strong>Rafael:</strong> Not all tools were always written in Perl. However
using consistently a same language allows to share and reuse libraries across
all tools, be it the perl/rpmlib bindings or custom graphical toolboxes. Thus,
for example, the OS installer shares code with urpmi and rpmdrake. A scripting
language was preferred because of rapidity of development and ease of debug --
attempts at writing rpmdrake in C were painful, although that was before I was
hired by Mandrakesoft. Perl was a natural choice since there were already very
good in-house skills for it.</p>

<p><em>Editors note: Recently, the <a href="http://www.linspire.com/">Linspire</a> distributionexemplified the use of dynamic languages to bring a graphical application to market quickly.  Their <a href="http://info.linspire.com/lsongs/">Lsongs</a>  nd <a href="http://info.linspire.com/lphoto/">Lphoto</a> programs use Python.</em></p>

<p><strong>ORN:</strong> Could you give a specific example of where Perl has
made a noticeable difference in shortening development time?</p>

<p><strong>Rafael:</strong> I think that using a scripting language in general
shortens the development time, notably due to the shorter write code / compile
/ test / debug cycle. However perl is particularly useful due to the high
number of development modules available on CPAN. For example running the OS
installer under <a
href="http://search.cpan.org/perldoc?Devel::Trace">Devel::Trace</a> produces
lots of logs, but is tremendously helpful to trace obscure bugs. You can't do
this in C without adding <code>printf</code>s everywhere and recompiling the
whole stuff.</p>

<p><strong>ORN:</strong> What tools does Mandrakelinux use for automated
testing of graphical Perl applications?</p>

<p><strong>Rafael:</strong> Er, interns ?</p>

<p>More seriously, there is no automated testing for GUIs.  Automated testing
of such applications raises several difficult problems, since they often modify
a system's configuration or necessitate some specific hardware (and I'm not
even speaking of the OS installer GUI).</p>

<p>Writing more unit tests is definitively something I want to do in the
future, however; it would be very useful to have complete sets of regression
tests for the urpmi dependency solver, for example.</p>

<p><strong>ORN:</strong> What has been the response of the Perl community to
Mandrakelinux Perl-based tools, especially in terms of contributing patches
back to your organization?</p>

<p><strong>Rafael:</strong> The people who send patches for the tools are
mostly interested in improving the distribution they use; even if they might
belong to the Perl community as well, their point of view is the one of a
Mandrakelinux user. That's one of the reasons why the tools have little
visibility outside the MDK community.</p>

<p>Another reason is that there never was a strong motivation in Mandrakesoft
for splitting the libraries in what is and is not MDK-specific, and to write
clear and comprehensive documentation: both need efforts, don't pay immediately
and are likely to be postponed when you have deadlines.</p>

<p>However, the CVS repository in which the tools' source code is kept is
openly accessible; some contributors (i.e. non Mandrakesoft employees) have
been granted commit access to it. We now need to make the learning curve
softer.</p>

<p><strong>ORN:</strong>What advice do have for Perl programmers interested in
contributing to the Perl-based Mandrakelinux utilities? Any helpful hints for
getting started?</p>

<p><strong>Rafael:</strong> As with any open-source project, if you want to
learn how it's done and to contribute, use the latest version available. In the
case of Mandrakelinux, that would be "cooker", the development distribution.
Subscribe to the mailing list, become familiar with the tools, have a checkout
from the CVS repository, get yourself a Bugzilla account and don't be afraid to
ask questions. Learning to build RPMs, at least to be able to rebuild the RPMs
of the tools, would be helpful too. Those questions are covered in the wiki; a
good page to begin with is:</p>

<blockquote><a
href="http://qa.mandrakesoft.com/twiki/bin/view/Main/HowTo">http://qa.mandrakesoft.com/twiki/bin/view/Main/HowTo</a></blockquote>

<p><strong>ORN:</strong> What challenges have you faced maintaining Perl as a
core part of the operating system, with so many key utilities depending on
it?</p>

<p><strong>Rafael:</strong> There are two kinds of challenges: spatial and
temporal, would I say.</p>

<p>First, spatially, you have to devise how to split the standard Perl
distribution on smaller packages ("perl-base" for the essentials, "perl" for
the rest of modules, "perl-devel" for Perl development tools and "perl-doc"
for, well, perldoc itself and the standard documentation.) This split is not
arbitrary. When you maintain a core tool like urpmi, which is essential to
system administration, you don't want it to require too many Perl modules, or
even too many core modules. (The same goes for the installer, that must not
take all the space on the installation CDs). So perl-base contains the modules
used by urpmi, and urpmi doesn't use modules that are in perl but not in
perl-base.</p>

<p><strong>ORN:</strong> Perl has a reputation for being "slow" when used for
graphical programming. How is that addressed in Mandrakelinux applications?</p>

<p><strong>Rafael:</strong> I think that Perl doesn't deserve this reputation,
only some Perl programs do ! The MDK tools use the perl-Gtk2 bindings (mostly
for historical reasons, the Qt bindings weren't mature enough when the
development of those tools started); and since they're pretty close to the C
lib, performance is very acceptable.</p>

<p>Did you know that the game <a href="http://www.frozen-bubble.org/">Frozen
Bubble</a>, written by a former Mandrakesoft employee, is implemented in Perl ?
It's not anywhere near slow. Actually people are often surprised to learn that
Frozen Bubble or the MDK tools are written in Perl, since they don't give the
impression of slowness generally associated to scripted GUIs.</p>

<p>In fact, it appears that the speed bottlenecks of the MDK tools are, like in
other programs, data processing, not display.</p>

<p><strong>ORN:</strong> You've recently become the pumpking for Perl 5.10. How
does your this interact with your day job and how do you balance the two
positions?</p>

<p><strong>Rafael:</strong> I was deeply involved in the development of Perl 5
before that, taking time to review and apply patches and so on. So I was mostly
working on it on evenings and week-ends. I can now work on Perl 5 during my
dayjob, since Mandrakesoft allows its developers to work on free projects they
like part time. However, I'd point out that my day job is a bit special, since,
contrary to proprietary projects, I'm always in contact with its community of
users, via mail, IRC or other internet-based media (and even sometimes in real
life.) Thus I'm sometimes led to work during my free time as well... In other
words the frontier between day job and other open source development is
blurred. In both cases things have to be done. The only difference is that for
the day job thing, I have deadlines, and they pay me for it.</p>

<p><strong>ORN:</strong> Do you have a favorite Perl module that more people
should know about?</p>

<p><strong>Rafael:</strong> I don't really know, I learn new modules mostly by
hanging around in places where the cool kids discover them before me -- mailing
lists, mongers, <a href="http://use.perl.org/">use.perl</a>. I use <a
href="http://search.cpan.org/perldoc?B::Concise">B::Concise</a> all the time,
but I suspect it's not useful for people who are not familiar with the
internals of perl. Also, recently, I found <a
href="http://search.cpan.org/perldoc?encoding::warnings">encoding::warnings</a>
useful for debugging Unicode-related bugs.</p>


        </div>



    </div>
    <div class="asset-footer"></div>
</div>


                            
                            <div id="entry-726" class="entry-asset asset hentry">
    <div class="asset-header">
        <h2 class="asset-name entry-title"><a href="/pub/2005/02/17/3d_engine.html" rel="bookmark">Building a 3D Engine in Perl, Part 3</a></h2>
        <div class="asset-meta">
            <span class="byline">
    
                By <span class="vcard author">Geoff Broadwell</span> on <abbr class="published" title="2005-02-17T00:00:00-08:00">February 17, 2005 12:00 AM</abbr>
    
            </span>

            
            

        </div>
    </div>
    <div class="asset-content entry-content">

        <div class="asset-body">
            
<!-- sidebar begins -->
<!-- don't move sidebars-->
<!-- sidebar ends -->
<br clear="all">
<p>This article is the third in a series aimed at <a
href="/pub/au/Broadwell_Geoff">building a full 3D engine in Perl</a>.  The <a
href="/pub/a/2004/12/01/3d_engine.html">first article</a> started with basic
program structure and worked up to displaying a simple depth-buffered scene in
an OpenGL window.  The <a href="/pub/a/2004/12/29/3d_engine.html">second
article</a> followed with a discussion of time, view animation, SDL events,
keyboard handling, and a nice chunk of refactoring.</p>

<p><em>Editor's note: see also the next article in the series, <a href="/pub/a/2005/08/04/3d_engine.html">profiling your application</a>.</em></p>

<p>Later in this article, I'll discuss movement of the view position,
continue the refactoring work by cleaning up <code>draw_view</code>, and begin
to improve the look of our scene using OpenGL lighting and materials.
Before I cover that, your feedback to the previous articles has
included a couple of common requests: screenshots and help with porting
issues.  If you're having problems running SDL_Perl and the
<a href="/2005/02/17/examples/perl_opengl_3_examples.tar.gz">sample code</a>
from these articles on your system, or might be able to help
the Mac OS X and Win32 readers, take a look at the next section.
Otherwise, skip down to the <a href="#Screenshots">Screenshots</a> section, where the main
article begins.</p>

<h3>Known Porting Issues</h3>

<h4 id="General">General</h4>

<p>Some versions of SDL_Perl require that the program load SDL::Constants
to recognize <code>SDL_QUIT</code> and other constants.  As this change should
be transparent to other users, I have merged that into the latest
version of the sample code, retroactive to the first use of an SDL
constant.</p>

<h4>FreeBSD</h4>

<p>See the suggestions at the beginning of the
<a href="/pub/a/2004/12/29/3d_engine.html">second article</a>.</p>

<!-- sidebar begins -->
 <csperl file="grab" domain="on" record="b/911" template="b/article_sidebar.view">
<!-- sidebar ends -->

<h4>Mac OS X</h4>

<p>I spent some time research the porting issues on Mac OS X but am as yet unable
to figure out a simple procedure for building SDL_Perl from scratch.  Recent
emails on the <i>sdl-devel</i> mailing list seem to indicate that Mac OS X builds
for recent SDL_Perl sources are problematic right now, but older releases seem
to be even worse.  There have been some packaging attempts in the past, but none
that I have found so far install a fully configured set of SDL_Perl libraries
into the system <code>perl</code>.  I'm no Mac porting expert, so I appreciate any help on
this; please post a comment in this month's article discussion if you have a
suggestion or solution.</p>

<h4>Slackware</h4>

<p>According to comments by Federico (<code>ironfede</code>) in last month's
<a href="/pub/a/2004/12/29/3d_engine.html?page=last#thread">article discussion</a>,
Slackware ships with a version of SDL_Perl that requires
SDL::Constants.  This is not an issue for the current version
of the sample code, which I fixed as mentioned above in the
<a href="#General">General</a> issues paragraph.</p>

<h4>Win32</h4>

<p>Win32 porting went as did Mac OS X porting.  I was quite excited when chromatic
pointed me to some old Win32 PPM packages, but sadly they don't include a
working version of SDL::OpenGL.  Building manually was &quot;interesting&quot; at best, as
I have no access to a Microsoft compiler and precious little experience using
<code>gcc</code> under Win32.  As with the Mac folks, I appreciate any help from the
readers.  Please post a comment in this month's article discussion if you have
a suggestion or solution for your fellows.</p>

<h3 id="Screenshots">Screenshots</h3>

<p>Thankfully, screenshots are much easier to handle than porting issues.  I'd like
the user to be able to take a screenshot whenever desired.  The obvious way to
accomplish that is to bind the screenshot action to a key; I chose function key
<code>F4</code> at random.  First I added it to the <code>bind</code> hash:</p>

<pre><code>        bind   =&gt; {
            escape =&gt; 'quit',
            f4     =&gt; 'screenshot',
            left   =&gt; '+yaw_left',
            right  =&gt; '+yaw_right',
            tab    =&gt; '+look_behind',
        }</code></pre>

<p>The new key must have an action routine, so I altered that lookup hash as
well:</p>

<pre><code>    $self-&gt;{lookup}{command_action} = {
          quit         =&gt; \&amp;action_quit,
          screenshot   =&gt; \&amp;action_screenshot,
        '+yaw_left'    =&gt; \&amp;action_move,
        '+yaw_right'   =&gt; \&amp;action_move,
        '+look_behind' =&gt; \&amp;action_move,
    };</code></pre>

<p>I need to wait until drawing completes for the entire scene before I
can take a snapshot, but event processing happens before drawing begins.
To work around this, I set a state variable marking that the user has
requested a screenshot, rather than perform the screenshot immediately:</p>

<pre><code>sub action_screenshot
{
    my $self = shift;

    $self-&gt;{state}{need_screenshot} = 1;
}</code></pre>

<p>The code checks this state variable in a new line at the end of <code>end_frame</code>,
after the drawing has completed and it has synced the screen with the
image written into OpenGL's color buffer:</p>

<pre><code>sub end_frame
{
    my $self = shift;

    $self-&gt;{resource}{sdl_app}-&gt;sync;
    $self-&gt;screenshot if $self-&gt;{state}{need_screenshot};
}</code></pre>

<p>The <code>screenshot</code> routine is surprisingly short but dense:</p>

<pre><code>sub screenshot
{
    my $self = shift;

    my $file = 'screenshot.bmp';
    my $w    = $self-&gt;{conf}{width};
    my $h    = $self-&gt;{conf}{height};

    glReadBuffer(GL_FRONT);
    my $data = glReadPixels(0, 0, $w, $h, GL_BGR,
                            GL_UNSIGNED_BYTE);
    SDL::OpenGL::SaveBMP($file, $w, $h, 24, $data);

    $self-&gt;{state}{need_screenshot} = 0;
}</code></pre>

<p>The routine starts by specifying a filename for the screenshot and
gathering the width and height of the screen.  The real work begins
with the call to <code>glReadBuffer</code>.  Depending on the OpenGL driver, the
hardware, and a number of advanced settings, OpenGL may have provided
<em>several</em> color buffers in which to draw and read images.  In fact,
the default behavior on most systems is to draw onto one buffer, known
as the <em>back buffer</em>, and display a separate buffer, known as the
<em>front buffer</em>.  After completing the drawing for each frame, the
<code>SDL::App::sync</code> call moves the image from the back buffer to the
front buffer so the user can see it.  Behind the scenes, OpenGL
generally handles this in one of two different ways, depending on the
underlying implementation.  Software OpenGL implementations, such as
Mesa, copy the data from the back buffer to the front buffer.  Hardware-accelerated systems can swap internal pointers so that the
back buffer becomes the front buffer and vice versa.  As you can
imagine, this is much faster.</p>

<p>This extra work brings a great benefit.  Without double buffering, as
soon as one frame completes, the next frame immediately clears
the screen to black and starts drawing again from scratch.  Depending
on the relative speed difference between the user's monitor and the
application, this would probably appear to the user as a flickering,
dark, perpetually half-drawn scene.  With double buffering, this
problem is almost gone.  The front buffer shows a solid stable image
while all of the drawing is done on the back buffer.  Once the drawing
completes, it takes at most a few milliseconds to sync up and start
displaying the new frame.  To the human eye, the animation appears
solid, bright, and (hopefully) smooth.</p>

<p>In this case, I want to make sure that I take a screenshot of exactly
the same image the user sees, so I tell OpenGL that I want to read the
image in the front buffer (<code>GL_FRONT</code>).</p>

<p>At this point, it's safe to read the image data into a Perl buffer in
the proper format.  The first four arguments to <code>glReadPixels</code> specify
the lower-left corner and size of the sub-image to read.  The next two
arguments together tell OpenGL what format I would like for the data.
I specify that I want to read the entire window and that I want the
data in the correct format for a BMP file--one unsigned byte for
each of the red, green, and blue color channels for each pixel, but in
reverse order.</p>

<p>Once I have the data from OpenGL I use the SDL_Perl utility routine
<code>SaveBMP</code> to save the image into a file.  The arguments are the
filename, image width, image height, color depth (24 bits per pixel),
and data buffer.  Finally, the routine resets the <code>need_screenshot</code>
state flag and returns.</p>

<p>At this point you should be able to take a screenshot each time you press the
<code>F4</code> key.  Of course, I'd like to show several screenshots during this article as
the code progresses.  The current code overwrites the previous screenshot file
every time I request a new one.  Because I number each runnable version of the
code, I used a quick workaround resulting in a different screenshot filename
for each code step.  I first load one of the core Perl modules to strip
directories from a path:</p>

<pre><code>use File::Basename;</code></pre>

<p>Then I use the filename of the script itself as part of my screenshot
filename:</p>

<pre><code>    my $file = basename($0) . '.bmp';</code></pre>

<p>This may be all you need for your application, or you may want to
add some code to number each file uniquely.  This code is enough to
fix my problem, so I've left the more powerful version as an
exercise for the reader.</p>

<p>Here then is the first screenshot:</p>

<p><img src="/pub/2005/02/17/graphics/step042.png" width="400" height="400" alt=""  /></p>

<p>The observant reader will notice that this image is not a BMP file; it's a
PNG image, which is both much smaller than a BMP and more friendly to web
standards.  There are many tools available that can perform this conversion.
Any good image editor can do it. In this case that's overkill--I instead used
the <code>convert</code> program from the <a
href="http://www.imagemagick.org/">ImageMagick</a> suite of utilities:</p>

<pre><code>convert step042.bmp step042.png</code></pre>













<h3>Moving the Viewpoint</h3>

<p>That view is more than a tad overplayed.  The user can't even move the
viewpoint to see the back or sides of the scene.  It's time to
change that.  I started by defining some new key bindings:</p>

<pre><code>        bind   =&gt; {
            escape =&gt; 'quit',
            f4     =&gt; 'screenshot',
            a      =&gt; '+move_left',
            d      =&gt; '+move_right',
            w      =&gt; '+move_forward',
            s      =&gt; '+move_back',
            left   =&gt; '+yaw_left',
            right  =&gt; '+yaw_right',
            tab    =&gt; '+look_behind',
        }</code></pre>

<p>I then updated the <code>command_action</code> <code>lookup</code> hash to handle these as
movement keys:</p>

<pre><code>    $self-&gt;{lookup}{command_action} = {
          quit          =&gt; \&amp;action_quit,
          screenshot    =&gt; \&amp;action_screenshot,
        '+move_left'    =&gt; \&amp;action_move,
        '+move_right'   =&gt; \&amp;action_move,
        '+move_forward' =&gt; \&amp;action_move,
        '+move_back'    =&gt; \&amp;action_move,
        '+yaw_left'     =&gt; \&amp;action_move,
        '+yaw_right'    =&gt; \&amp;action_move,
        '+look_behind'  =&gt; \&amp;action_move,
    };</code></pre>

<p><code>init_view</code> needs to initialize two more velocity components and
matching deltas:</p>

<pre><code>    $self-&gt;{world}{view} = {
        position    =&gt; [6, 2, 10],
        orientation =&gt; [0, 0, 1, 0],
        d_yaw       =&gt; 0,
        v_yaw       =&gt; 0,
        v_forward   =&gt; 0,
        v_right     =&gt; 0,
        dv_yaw      =&gt; 0,
        dv_forward  =&gt; 0,
        dv_right    =&gt; 0,
    };</code></pre>

<p><code>action_move</code> needs a new movement speed to match the existing yaw
speed and some additions to <code>%move_update</code>:</p>

<pre><code>    my $speed_move       = 5;
    my %move_update      = (
        '+yaw_left'     =&gt; [dv_yaw     =&gt;  $speed_yaw ],
        '+yaw_right'    =&gt; [dv_yaw     =&gt; -$speed_yaw ],
        '+move_right'   =&gt; [dv_right   =&gt;  $speed_move],
        '+move_left'    =&gt; [dv_right   =&gt; -$speed_move],
        '+move_forward' =&gt; [dv_forward =&gt;  $speed_move],
        '+move_back'    =&gt; [dv_forward =&gt; -$speed_move],
        '+look_behind'  =&gt; [d_yaw      =&gt;  180        ],
    );</code></pre>

<p>So far, the changes are mostly hash updates instead of procedural code;
that's a good sign that the existing code design has some more life
left.  When conceptually simple changes require significant code
modification, especially special cases or repetitive blocks of code,
it's time to look for a refactoring opportunity.  Thankfully, these
changes are in initialization and configuration rather than special cases.</p>

<p>One routine that requires a good bit of new code is
<code>update_view</code>.  I added these lines to the end:</p>

<pre><code>    $view-&gt;{v_right}        += $view-&gt;{dv_right};
    $view-&gt;{dv_right}        = 0;
    $view-&gt;{v_forward}      += $view-&gt;{dv_forward};
    $view-&gt;{dv_forward}      = 0;

    my $vx                   =  $view-&gt;{v_right};
    my $vz                   = -$view-&gt;{v_forward};
    $view-&gt;{position}[0]    += $vx * $d_time;
    $view-&gt;{position}[2]    += $vz * $d_time;</code></pre>

<p>That routine is beginning to look a bit repetitious and has several
copies of very similar lines of code, so it goes on the list of places
to refactor in the future.  There are not yet enough cases
to make the best solution obvious, so I'll hold off for a bit.</p>

<p>The new code starts by applying the new velocity deltas in the same
way that it updates <code>v_yaw</code> earlier in the routine.  It converts the right and
forward velocities to velocities along the world axes by noting that
the view starts out with &quot;forward&quot; parallel to the negative Z axis and
&quot;right&quot; parallel to the positive X axis.  It then multiplies the X and Z
velocities by the time delta to arrive at a position change, which it
adds into the current view position.</p>

<p>This version of the code works fine as long as the user doesn't rotate
the view.  When the view rotates, &quot;forward&quot; and &quot;right&quot; don't match
the new view directions.  They still point down the -Z and +X axes
respectively, which can prove very disorienting for high rotations.
The solution is a bit of trigonometry.  The idea is treat the initial
X and Z velocities as components of the total velocity vector,
and rotate that vector through the same angle that the user rotated
the view:</p>

<pre><code>    my $vx                   =  $view-&gt;{v_right};
    my $vz                   = -$view-&gt;{v_forward};
    my $angle                = $view-&gt;{orientation}[0];
    ($vx, $vz)               = rotate_xz($angle, $vx, $vz);
    $view-&gt;{position}[0]    += $vx * $d_time;
    $view-&gt;{position}[2]    += $vz * $d_time;</code></pre>

<p>The two middle lines are the new ones.  They call <code>rotate_xz</code> to do
the vector rotation work and then set <code>$vx</code> and <code>$vz</code> to the returned
components of the rotated velocity vector.  <code>rotate_xz</code> is:</p>

<pre><code>sub rotate_xz
{
    my ($angle, $x, $z) = @_;

    my $radians = $angle * PI / 180;
    my $cos     = cos($radians);
    my $sin     = sin($radians);
    my $rot_x   =  $cos * $x + $sin * $z;
    my $rot_z   = -$sin * $x + $cos * $z;

    return ($rot_x, $rot_z);
}</code></pre>

<p>After converting the angle from degrees to radians, the code
calculates and saves the sine and cosine of the angle.  It then
calculates the rotated velocity components given the original
unrotated components.  Finally, it returns the rotated components to
the caller.</p>

<p>I'll skip the derivation here (you're welcome), but if you're curious
about how and why this calculation performs a rotation, there are
numerous books that explain the wonders of vector mathematics in
amazing detail.  O'Reilly's
<a href="http://www.oreilly.com/catalog/physicsgame/">Physics for Game Developers</a>,
by David M. Bourg, includes a high-level discussion of rotation.
Charles River Media's
<a href="http://www.charlesriver.com/titles/lengyelmath2.html">Mathematics for 3D Game Programming &amp; Computer Graphics</a>,
by Eric Lengyel, includes a deeper discussion though I, for one, have
college math flashbacks every time I read it.  Speaking of which, any
college textbook on linear algebra should include as much detail as
you desire.</p>

<p>This code requires a definition for <code>PI</code>, provided by the following
line near the top of the program, right after requesting warnings
from Perl:</p>

<pre><code>use constant PI =&gt; 4 * atan2(1, 1);</code></pre>

<p>The <code>constant</code> module evaluates possibly complex calculations during the
compile phase and then converts them into constants at runtime.  The
above calculation takes advantage of a standard trig identity to derive a
value for <code>PI</code> accurate to as many digits as the system can deliver.</p>

<p><code>update_view</code> now does the right thing, no matter what angle the view
is facing.  It doesn't take long to find a more interesting view:</p>

<p><img src="/pub/2005/02/17/graphics/step044.png" width="400" height="400" alt=""  /></p>













<h3>Let There Be Lighting!</h3>

<p>Okay, so maybe that's not <em>much</em> more interesting, admittedly. 
This scene needs a little mood lighting instead of the flat colors
I've used so far (especially because they make it hard to see the
shape of each object clearly).  As a first step, I turned on OpenGL's
lighting system with a new line at the end of <code>prep_frame</code>:</p>

<pre><code>    glEnable(GL_LIGHTING);</code></pre>

<p><img src="/pub/2005/02/17/graphics/step045.png" width="400" height="400" alt=""  /></p>

<p>Far from lighting the scene, the view is now almost black.  If you
look very carefully and your monitor and room lighting are forgiving,
you should be able to just make out the objects, which are very dark
gray on the black background.  In order to see anything, I must enable
both <code>GL_LIGHTING</code> and one or more lights to provide light to the
scene.  Without a light, the objects are dark gray instead of true
black because OpenGL, by default, applies a very small amount of light
to the entire scene, known as <em>ambient</em> light.  To show the objects
more brightly, I turned on the first OpenGL light with another new line
at the end of <code>prep_frame</code>:</p>

<pre><code>    glEnable(GL_LIGHT0);</code></pre>

<p><img src="/pub/2005/02/17/graphics/step046.png" width="400" height="400" alt=""  /></p>

<p>Now the objects are brighter, but they're still just gray.  When
calculating colors with lighting enabled, OpenGL uses a completely
different set of parameters from the colors used when lighting is
disabled.  Together these new parameters make up a <em>material</em>.
Complex interactions between the parameters that make up a material
can result in very interesting color effects, but in this case, I'm not
trying to create a complex effect.  I want my objects to have their
old colors back without worrying about the full complexity that
materials provide.  Thankfully, OpenGL provides a way to state that
the current material should default to the current color.  To do this,
I add yet another line to the end of <code>prep_frame</code>:</p>

<pre><code>    glEnable(GL_COLOR_MATERIAL);</code></pre>

<p><img src="/pub/2005/02/17/graphics/step047.png" width="400" height="400" alt=""  /></p>

<p>At this point, the objects once again have color, but each of the
faces is still the same shade rather than appearing to be lit by a
single light source somewhere.  The problem is that OpenGL does not
know whether each face points toward or away from the light and, if
so, by  how much.  The angle between the face and the light determines how
much light falls on the surface and, therefore, how bright it should
appear.  It is possible to calculate the angle of each face in my
scene from the location of its vertices, but this is not always the
right thing to do (especially when dealing with curved surfaces), so
OpenGL does not calculate this internally.  Instead, the program needs
to do the direction calculations and tell OpenGL the result, known as
the <em>normal vector</em>.</p>

<p>Luckily, in <code>draw_cube</code> the faces align with the coordinate axes so
that each face points down one of them (positive or negative
X, Y, or Z).  I don't have to do any calculation here, just tell
OpenGL which normal vector to associate with each face:</p>

<pre><code>sub draw_cube
{
    # A simple cube
    my @indices = qw( 4 5 6 7   1 2 6 5   0 1 5 4
                      0 3 2 1   0 4 7 3   2 3 7 6 );
    my @vertices = ([-1, -1, -1], [ 1, -1, -1],
                    [ 1,  1, -1], [-1,  1, -1],
                    [-1, -1,  1], [ 1, -1,  1],
                    [ 1,  1,  1], [-1,  1,  1]);
    my @normals = ([0, 0,  1], [ 1, 0, 0], [0, -1, 0],
                   [0, 0, -1], [-1, 0, 0], [0,  1, 0]);

    glBegin(GL_QUADS);

    foreach my $face (0 .. 5) {
        my $normal = $normals[$face];
        glNormal(@$normal);

        foreach my $vertex (0 .. 3) {
            my $index  = $indices[4 * $face + $vertex];
            my $coords = $vertices[$index];
            glVertex(@$coords);
        }
    }
    glEnd;
}</code></pre>

<p>The new lines are the definition of the <code>@normals</code> array and the two
lines at the top of the <code>$face</code> loop that select the correct normal
for each face and pass it to OpenGL using <code>glNormal</code>.</p>

<p>The boxes are now shaded reasonably and it's clear that the light
is coming from somewhere behind the viewer; the front faces are
brighter than the sides.  Unfortunately, the axes are now dark again:</p>

<p><img src="/pub/2005/02/17/graphics/step048.png" width="400" height="400" alt=""  /></p>

<p>I did not specify any normal for the axis lines because the concept
doesn't make a whole lot of sense for lines or points.  However,
with lighting enabled, OpenGL needs a set of normals for every lit
object, so it goes back to the current state and uses the most
recently defined normal.  For the very first frame this is the default
normal, which happens to point towards the default first light, but for
succeeding frames it will be the last normal set in <code>draw_cube</code>.
The latter definitely does not point toward the light, and the axes end
up dark.</p>

<p>I'd rather the axis lines didn't take part in lighting calculations at
all and kept their original bright colors, regardless of any lighting
(or lack thereof) in the scene.  To do this, I removed the line that
enables <code>GL_LIGHTING</code> in <code>prep_frame</code> and inserted two new
lines near the top of <code>draw_view</code>:</p>

<pre><code>sub draw_view
{
    glDisable(GL_LIGHTING);

    draw_axes();

    glEnable(GL_LIGHTING);</code></pre>

<p>Now lighting is off before drawing the axis lines and back on
afterward.  The axis lines have bright colors again, but rotating
the view exposes a new problem. When the view rotates, the direction of
the light changes as well:</p>

<p><img src="/pub/2005/02/17/graphics/step049.png" width="400" height="400" alt=""  /></p>

<p>Because of the way that OpenGL calculates light position and direction, any
lights defined before the view is set are fixed to the viewer like the light on
a miner's helmet.  To fix a light relative to the simulated world, define the
light instead after setting the view.  I removed the line enabling
<code>GL_LIGHT0</code> in <code>prep_frame</code> and moved it to the new
routine <code>set_world_lights</code>:</p>

<pre><code>sub set_world_lights
{
    glEnable(GL_LIGHT0);
}</code></pre>

<p>I then updated <code>draw_frame</code> to call the new routine after setting the
view:</p>

<pre><code>sub draw_frame
{
    my $self = shift;

    $self-&gt;set_projection_3d;
    $self-&gt;set_view_3d;
    $self-&gt;set_world_lights;
    $self-&gt;draw_view;
}</code></pre>

<p>Unfortunately, this doesn't work.  OpenGL only updates its internal
state with the light's position and direction when they 
change explicitly, not when the light is enabled or disabled.  I've
never set the light's parameters explicitly, so the original default
still stands.  This issue is easy to fix with another line in
<code>set_world_lights</code>:</p>

<pre><code>sub set_world_lights
{
    glLight(GL_LIGHT0, GL_POSITION, 0.0, 0.0, 1.0, 0.0);

    glEnable(GL_LIGHT0);
}</code></pre>

<p>In one of the few OpenGL interface decisions that actively annoys me,
the new line sets the <em>direction</em> of the light, not its position.
OpenGL defines all lights as one of two types: <em>directional</em> or
<em>positional</em>.  OpenGL assumes directional lights are very far away
so that anywhere in the scene the direction from the light to each
object is effectively the same.  Positional lights are nearer and
OpenGL must calculate the direction from the light to every vertex of
every object in the scene independently.  As you can imagine, this is
much slower, but produces more interesting lighting effects.</p>

<p>The key to choosing between these two types is the last parameter of
the <code>glLight</code> call above.  If this parameter is <code>0</code>, the light is
directional and the other three coordinates specify the direction
from which the light comes.  In this case, I've specified that the
light should come <em>from</em> the +Z direction.  If the last parameter is
<code>1</code>, then OpenGL makes the light positional and uses the other three
coordinates to set the light's position within the scene.  For now,
I'll skip the gory details of what happens when a value other than <code>0</code>
or <code>1</code> is used, but in short, the light will be positional and extra
calculations determine the actual position used.  Most of the time
it's best to ignore that case.</p>

<p>You may wonder why I explicitly specified <code>0.0</code> and
<code>1.0</code> instead of <code>0</code> and <code>1</code>.  This is a
workaround for a bug in <code>glLight</code> in some versions of SDL_Perl when it is
presented with integer arguments instead of floating-point arguments.</p>

<p>With this line added, the light now stays fixed in the world, even when
the user moves and rotates the view:</p>

<p><img src="/pub/2005/02/17/graphics/step051.png" width="400" height="400" alt=""  /></p>













<h3>A Lantern</h3>

<p>Of course, sometimes a light connected to the viewer is exactly the
intention.  For example, perhaps the desired effect is for the player
to hold a lantern or flashlight to light dark places.  Both of
these are localized light sources that light nearby objects quite a
bit, but distant objects only a little.  The primary difference between
them is that a flashlight and certain types of lanterns cast light
primarily in one direction, often in a cone.  Most
lanterns, torches, and similar light sources cast light in all
directions (barring shadows from handles, fuel tins, and the like).</p>

<p>Non-directed light is a little simpler to implement, so I'll start
with lantern light.  I wanted the light rooted at the viewer's
position, so I defined the light before setting the view:</p>

<pre><code>sub draw_frame
{
    my $self = shift;

    $self-&gt;set_projection_3d;
    $self-&gt;set_eye_lights;
    $self-&gt;set_view_3d;
    $self-&gt;set_world_lights;
    $self-&gt;draw_view;
}</code></pre>

<p>I refer to viewer-fixed lights as <em>eye lights</em> because OpenGL refers to
the coordinate system it uses for lights as <em>eye coordinates</em>, and a
light defined this way as maintaining a particular position &quot;relative
to the eye.&quot;  Here's <code>set_eye_lights</code>:</p>

<pre><code>sub set_eye_lights
{
    glLight(GL_LIGHT1, GL_POSITION, 0.0, 0.0, 1.0, 0.0);

    glEnable(GL_LIGHT1);
}</code></pre>

<p>Here I set the second light exactly the same way I set the first.
Note that it doesn't matter that I actually define the second light
in my program before the first.  Each OpenGL light is independently
numbered and always keeps the same number, rather than acting like a
stack or queue numbered by order of use.</p>

<p>Sadly, the new code doesn't seem to have any effect at all.  In
reality, there really is a new light shining on the scene--unlike
<code>GL_LIGHT0</code>, which defaults to shining bright white, all of the other
lights default to black and provide no new light to the scene.  The
solution is to set another parameter of the light:</p>

<pre><code>sub set_eye_lights
{
    glLight(GL_LIGHT1, GL_POSITION, 0.0, 0.0, 1.0, 0.0);
    glLight(GL_LIGHT1, GL_DIFFUSE,  1.0, 1.0, 1.0, 1.0);

    glEnable(GL_LIGHT1);
}</code></pre>

<p>The front faces of each object should appear considerably brighter.
Moving around the scene shows that the eye light brightens a
surface only dimly lit by the world light:</p>

<p><img src="/pub/2005/02/17/graphics/step053.png" width="400" height="400" alt=""  /></p>

<p>If you watch carefully, however, you'll notice that the lighting
varies by the view rotation--not position.  I defined the light as
directional with the light coming from behind the viewer, rather than
positional, with the light coming from the viewer directly.  I hinted
at the fix earlier--changing the <code>GL_POSITION</code> parameter as
follows:</p>

<pre><code>    glLight(GL_LIGHT1, GL_POSITION, 0.0, 0.0, 0.0, 1.0);</code></pre>

<p>The light now comes from <code>(0, 0, 0)</code> in eye coordinates, right at
the viewpoint.  Moving around and rotating shows that this version has
the intended effect.</p>

<p>The simulated lantern still shines as brightly on far-away objects as
it does on near ones.  A real lantern's light falls off rapidly with
distance from the lantern.  OpenGL can do this with another setting:</p>

<pre><code>sub set_eye_lights
{
    glLight(GL_LIGHT1, GL_POSITION, 0.0, 0.0, 0.0, 1.0);
    glLight(GL_LIGHT1, GL_DIFFUSE,  1.0, 1.0, 1.0, 1.0);
    glLight(GL_LIGHT1, GL_LINEAR_ATTENUATION, 0.5);

    glEnable(GL_LIGHT1);
}</code></pre>

<p>This case tells OpenGL to include a dimming term in its equations
proportional to the distance between the light and the object.
Physics-minded readers will point out that physically accurate dimming
is proportional to the square of the distance, and OpenGL does
allow this using <code>GL_QUADRATIC_ATTENUATION</code>.  However, a host of
factors (including the lighting equations that OpenGL uses and the
non-linear effects of the graphics hardware, monitor, and human eye)
make this more accurate dimming look rather odd.  Linear dimming turns
out to look better in many cases, so that's what I used here.  It is
also possible to combine different dimming types, so that the dimming
appears linear for nearby objects and quadratic for distant ones, which
you may find a better tradeoff.  The <code>0.5</code> setting tells OpenGL how
strong the linear dimming effect should be for my scene.</p>

<p>Moving around the scene, you should be able to see the relatively
subtle dimming effect in action.  Don't be afraid to leave it subtle
instead of turning the dimming effect way up.  Some moods call for
striking lighting effects, while others call for lighting effects that
the viewer notices only subconsciously.  In some visualization
applications, lighting subtlety is a great virtue, allowing the human
visual system's amazing processing power to come to grips with a
complex scene without being overwhelmed.</p>

<h3>A Flashlight</h3>

<p>I really happen to like the way a flashlight casts its cone of light,
so I converted the omnidirectional light of the lantern to a directed
cone.  OpenGL refers to this type of light as a <em>spotlight</em> and
includes several light parameters to define them.  The first change
is a new setting in <code>set_eye_lights</code>:</p>

<pre><code>    glLight(GL_LIGHT1, GL_SPOT_CUTOFF, 15.0);</code></pre>

<p>This sets the angle between the center of the light beam and the edges
of the cone.  OpenGL accepts either 180 degrees (omnidirectional) or
any value between 0 and 90 degrees (from a laser beam to a hemisphere
of light).  In this case, I chose a centerline-to-edge angle of 15
degrees, making a nice 30-degree-wide cone of light.</p>

<p>This change indeed limits the cone of light, but also reveals an ugly
artifact.  Move to a point just in front of the left front corner of
the white cube and rotate the view to pan the light across the yellow
box.  You'll see the light jump nastily from corner to corner, even
disappearing entirely in between.  Even when a corner is lit, the
shape of the light is not very conelike:</p>

<p><img src="/pub/2005/02/17/graphics/step056.png" width="400" height="400" alt=""  /></p>

<p>OpenGL's standard lighting model only performs the lighting calculations at
each vertex, interpolating the results in between.  For models that have many
small faces and a resulting high density of vertices, this works relatively
well.  It breaks down nastily in scenes containing objects with large faces and
few vertices, especially when a positional light is close to an object.
Spotlights make the problem even more apparent, as they can easily shine
<em>between</em> two vertices without lighting either of them; the polygon then
appears uniformly dark.</p>

<h3>Ode to Rush</h3>

<p>Advanced OpenGL functionality paired with recent hardware can solve this
problem with per-pixel lighting calculations.  Older hardware can fake it with
light maps and similar tricks.  Rather than using advanced functionality, I'll
use a simpler method for improving the lighting, known as <i>subdivisions</i>.  (Those
of you scratching your heads over the Rush reference can now breathe a
collective sigh of relief.) Subdivisions have their own problems, as I'll show
later, but those issues explain a lot about the design of graphics APIs, so
they're worth a look.</p>

<p>As the name implies, the basic idea is to subdivide each face into many
smaller faces, each with its own set of vertices.  For curved objects such as
spheres and cylinders, this is essential so that nearby objects appear to curve
smoothly.  For objects with large flat faces, such as boxes and pyramids, this
merely has the side effect of forcing the per-vertex lighting calculations to
be done many times across each face.</p>

<p>Before I can use subdivided faces, I need to prepare by refactoring
<code>draw_cube</code>:</p>

<pre><code>sub draw_cube
{
    # A simple cube
    my @indices = qw( 4 5 6 7   1 2 6 5   0 1 5 4
                      0 3 2 1   0 4 7 3   2 3 7 6 );
    my @vertices = ([-1, -1, -1], [ 1, -1, -1],
                    [ 1,  1, -1], [-1,  1, -1],
                    [-1, -1,  1], [ 1, -1,  1],
                    [ 1,  1,  1], [-1,  1,  1]);
    my @normals = ([0, 0,  1], [ 1, 0, 0], [0, -1, 0],
                   [0, 0, -1], [-1, 0, 0], [0,  1, 0]);

    foreach my $face (0 .. 5) {
        my $normal = $normals[$face];
        my @corners;

        foreach my $vertex (0 .. 3) {
            my $index  = $indices[4 * $face + $vertex];
            my $coords = $vertices[$index];
            push @corners, $coords;
        }
        draw_quad_face(normal    =&gt; $normal,
                       corners   =&gt; \@corners);
    }
}</code></pre>

<p>Instead of performing the OpenGL calls directly in <code>draw_cube</code>, it
now calls <code>draw_quad_face</code>.  For each large face it creates a new
<code>@corners</code> array filled with the vertex coordinates of the corners of
that face.  It then passes that array and the face normal to
<code>draw_quad_face</code>, defined as follows:</p>

<pre><code>sub draw_quad_face
{
    my %args    = @_;
    my $normal  = $args{normal};
    my $corners = $args{corners};

    glBegin(GL_QUADS);
    glNormal(@$normal);

    foreach my $coords (@$corners) {
        glVertex(@$coords);
    }
    glEnd;
}</code></pre>

<p>This function performs exactly the OpenGL operations that
<code>draw_cube</code> used to do.  I've also used a different argument-passing
style for this routine than I have previously.  In this case, I pass named
arguments because I know that I will add at least one more argument very soon
and that there's a pretty good chance I'll want to add more later.  When the
arguments to a routine are likely to change over time, and especially when
callers might want to specify only a few arguments and allow the rest to take
on reasonable defaults, named arguments are usually a better choice.  The
arguments can either be a hashref or a list stuffed into a hash.  This time, I
chose the latter method.</p>

<p>After refactoring comes testing, and a quick run showed that everything
worked as expected.  Safe in that knowledge, I rewrote
<code>draw_quad_face</code> to subdivide each face:</p>

<pre><code>sub draw_quad_face
{
    my %args    = @_;
    my $normal  = $args{normal};
    my $corners = $args{corners};
    my $div     = $args{divisions} || 10;
    my ($a, $b, $c, $d) = @$corners;

    # NOTE: ASSUMES FACE IS A PARALLELOGRAM

    my $s_ab = calc_vector_step($a, $b, $div);
    my $s_ad = calc_vector_step($a, $d, $div);

    glNormal(@$normal);
    for my $strip (0 .. $div - 1) {
        my @v = ($a-&gt;[0] + $strip * $s_ab-&gt;[0],
                 $a-&gt;[1] + $strip * $s_ab-&gt;[1],
                 $a-&gt;[2] + $strip * $s_ab-&gt;[2]);

        glBegin(GL_QUAD_STRIP);
        for my $quad (0 .. $div) {
            glVertex(@v);
            glVertex($v[0] + $s_ab-&gt;[0],
                     $v[1] + $s_ab-&gt;[1],
                     $v[2] + $s_ab-&gt;[2]);

            $v[0] += $s_ad-&gt;[0];
            $v[1] += $s_ad-&gt;[1];
            $v[2] += $s_ad-&gt;[2];
        }
        glEnd;
    }
}</code></pre>

<p>The new routine starts by adding the new optional argument <code>divisions</code>,
which defaults to 10.  This specifies how many subdivisions the face
should have both &quot;down&quot; and &quot;across&quot;; the actual number of sub-faces
is the square of this number.  For the default 10 divisions, that comes
to 100 sub-faces for each large face, so each cube has 600 sub-faces.</p>

<p>The next line labels the corners in counterclockwise order.  This puts
corner A diagonally across from corner C, with B on one side and D on
the other.</p>

<p>As the comment on the next line indicates, I've simplified the math
considerably by assuming that the face is at least a parallelogram.
With this simplification, I can calculate the steps for one division
along sides AB and AD and use these steps to position every sub-face
across the entire large face.</p>

<p>I can't just calculate the step as a simple distance to move, because I
have no idea which direction each edge is pointing and wouldn't know
which way to move for each step.  Instead, I calculate the vector
difference between the vertices at each end of the edge and divide
that by the number of divisions.  The code does the same calculation twice, so
I've extracted it into a separate routine:</p>

<pre><code>sub calc_vector_step
{
    my ($v1, $v2, $div) = @_;

    return [($v2-&gt;[0] - $v1-&gt;[0]) / $div,
            ($v2-&gt;[1] - $v1-&gt;[1]) / $div,
            ($v2-&gt;[2] - $v1-&gt;[2]) / $div];
}</code></pre>

<p>Returning to <code>draw_quad_face</code>, it stores the vector steps in
<code>$s_ab</code> (the step along the AB side) and <code>$s_ad</code> (the
step along the AD side).  Next it sets the current normal, which for a flat
face remains the same across its entirety.</p>

<p>Finally, I can begin to define the sub-faces themselves.  I've taken advantage
of the OpenGL quad strip primitive to draw the sub-faces as a series of parallel
strips extending from the AB edge to the CD edge.  For each strip, I first need
to calculate the location of its starting vertex.  I know this is on the AB
edge, so the code starts at A and adds an AB step for each completed strip.
For the first strip, this puts the starting vertex at A.  For the last strip,
the starting vertex will be one step (one strip width) away from B.  It
initializes the current vertex <code>@v</code> with the starting vertex and
will keep it updated as it moves along each strip.</p>

<p>It then begins a strip of quads with <code>glBegin(GL_QUAD_STRIP)</code>.  To
define the strip, I've specified the locations of each pair of vertices
across from each other along its length.  For each pair, it uses the
current vertex and a calculated vertex one step further along the
AB direction.  The code then moves the current vertex one step along the
length of the strip (the AD direction).  Once the strip is complete, it
ends it with <code>glEnd</code> and loops again for the next strip.</p>

<p>All of this complexity makes quite a visual difference:</p>

<p><img src="/pub/2005/02/17/graphics/step058.png" width="400" height="400" alt=""  /></p>

<p>It's clear that the light has a definite shape to it, but the lighting
is so jagged that it's distracting.  One way to fix this is to 
increase the number of divisions, making smaller sub-faces.  This
requires a simple addition to the <code>draw_quad_face</code> call in
<code>draw_cube</code>:</p>

<pre><code>        draw_quad_face(normal    =&gt; $normal,
                       corners   =&gt; \@corners,
                       divisions =&gt; 30);</code></pre>

<p>The result is quite a bit less jagged:</p>

<p><img src="/pub/2005/02/17/graphics/step059.png" width="400" height="400" alt=""  /></p>

<p>Unfortunately, the jaggies are smaller but still obviously there--and the closer the viewer is to an object the bigger they appear.
There are also nine times as many sub-faces to draw (30/10 squared)
and the program now runs considerably slower.  If you're lucky enough
to have a recent system with fast video hardware and don't notice the
slowdown, use 100 or so for the number of divisions.  You'll
probably see it.</p>













<h3>Softening the Edges</h3>

<p>Clearly, increasing the number of subdivisions only goes so far to
improve the rendering, while simultaneously costing dearly in
performance.  I'll try a different tack and go back to what I know
about a flashlight.  Most flashlights cast a beam that is brighter in
the center than at the edge.  (Some have a dark circle in the very
center, but I'm ignoring that for now.)  I can take advantage of this
to create a more accurate image and also soften the large
jaggies considerably.  First, I backed out my change to the
<code>draw_quad_face</code> call:</p>

<pre><code>        draw_quad_face(normal    =&gt; $normal,
                       corners   =&gt; \@corners);</code></pre>

<p>Then I changed one spotlight parameter for the flashlight in
<code>set_eye_lights</code> and added another:</p>

<pre><code>    glLight(GL_LIGHT1, GL_SPOT_CUTOFF,   30.0);
    glLight(GL_LIGHT1, GL_SPOT_EXPONENT, 80.0);</code></pre>

<p>With the change to <code>GL_SPOT_CUTOFF</code>, I've widened the beam to twice
its original angle.  At the same time, I've told OpenGL to make it
quite a bit dimmer at the edges using <code>GL_SPOT_EXPONENT</code>, hopefully
hiding any jaggies.  The new parameter has a somewhat confusing name
that refers to the details of the equation that determines the
strength of the off-center dimming effect.  In a theme seen throughout
the mathematics of computer graphics, the dimming is a function of the
cosine of the angle between the center line and the vertex being lit.
In fact, the dimming factor is the cosine raised to the exponent
specified by <code>GL_SPOT_EXPONENT</code>.  Why use the cosine of the angle?
It turns out to be cheap to calculate--cheaper than calculating the
angle itself--and also gives a nice smooth effect.</p>

<p>With luck, the new beam will appear about the same width to the eye as
the old one:</p>

<p><img src="/pub/2005/02/17/graphics/step060.png" width="400" height="400" alt=""  /></p>

<p>Good enough.  The image looks better without the massive performance
strain of high subdivision levels.</p>

<h3>Refactoring Drawing</h3>

<p>There's still something not right, but it will take a few more objects
in the scene to show it.  <code>draw_view</code> is already a repetitive
hardcoded mess and it's been on the &quot;to be refactored&quot; list for a
while, so now seems a good time to clean it up before I add to the
mess.</p>

<p><code>draw_view</code> performs a series of transformations and state settings
for each object drawn.  I want to move to a more data-driven design,
with each object in the simulated world represented by a data
structure specifying the needed transformations and settings.
Eventually, these structures may become full-fledged blessed objects,
but I'll start simple for now.</p>

<p>I initialized the data structures in <code>init_objects</code>:</p>

<pre><code>sub init_objects
{
    my $self = shift;

    my @objects = (
        {
            draw        =&gt; \&amp;draw_axes,
        },
        {
            lit         =&gt; 1,
            color       =&gt; [ 1, 1,  1],
            position    =&gt; [12, 0, -4],
            scale       =&gt; [ 2, 2,  2],
            draw        =&gt; \&amp;draw_cube,
        },
        {
            lit         =&gt; 1,
            color       =&gt; [ 1, 1, 0],
            position    =&gt; [ 4, 0, 0],
            orientation =&gt; [40, 0, 0, 1],
            scale       =&gt; [.2, 1, 2],
            draw        =&gt; \&amp;draw_cube,
        },
    );

    $self-&gt;{world}{objects} = \@objects;
}</code></pre>

<p>Each hash includes the arguments to the various transformations to
apply to it, along with a reference to the routine that actually
draws the object and a flag indicating whether the object should be
subject to OpenGL lighting.  The object array then becomes a new part
of the world hash for easy access later.</p>

<p>I called this routine at the end of <code>init</code> as usual:</p>

<pre><code>    $self-&gt;init_objects;</code></pre>

<p>I also replaced <code>draw_view</code> with a version that interprets the data
into a series of OpenGL calls:</p>

<pre><code>sub draw_view
{
    my $self    = shift;

    my $objects = $self-&gt;{world}{objects};

    foreach my $o (@$objects) {
        $o-&gt;{lit} ? glEnable (GL_LIGHTING)
                  : glDisable(GL_LIGHTING);

        glColor(@{$o-&gt;{color}})        if $o-&gt;{color};

        glPushMatrix;

        glTranslate(@{$o-&gt;{position}}) if $o-&gt;{position};
        glRotate(@{$o-&gt;{orientation}}) if $o-&gt;{orientation};
        glScale(@{$o-&gt;{scale}})        if $o-&gt;{scale};

        $o-&gt;{draw}-&gt;();

        glPopMatrix;
    }
}</code></pre>

<p>The new routine iterates over the world object array, performing each
requested operation.  It either skips or defaults any unspecified values.
First up is the choice to enable or disable <code>GL_LIGHTING</code>, followed
by setting the current color if requested.  The code next checks for and
applies the usual transformations and finally, calls the object draw
routine.</p>

<p>For simplicity and robustness, I've unconditionally wrapped the
transformations and draw routine in a matrix push/pop pair rather
than trying to detect whether they need the push and pop.  OpenGL
implementations tend to be highly optimized with native code, and any
detection I did would be Perl.  Chances are good that such an
&quot;optimization&quot; would instead slow things down.  This way, my code
stays cleaner and even a misbehaving draw routine that performed
transformations internally without cleaning up afterwards will not
affect the next object drawn.</p>

<p>A quick test showed that this refactored version still worked.  Now I
could add a few more objects to demonstrate the remaining lighting
issue.  I specified several more boxes programmatically by inserting a
new loop before the end of <code>init_objects</code>:</p>

<pre><code>    foreach my $num (1 .. 5) {
        my $scale =   $num * $num / 15;
        my $pos   = - $num * 2;
        push @objects, {
            lit         =&gt; 1,
            color       =&gt; [ 1, 1,  1],
            position    =&gt; [$pos, 2.5, 0],
            orientation =&gt; [30, 1, 0, 0],
            scale       =&gt; [1, 1, $scale],
            draw        =&gt; \&amp;draw_cube,
        };
    }

    $self-&gt;{world}{objects} = \@objects;
}</code></pre>

<p>For each box, just two parameters vary: position and Z scale.  I chose the
position to set each box next to the last, progressing along the -X axis.  The
scale is set so that the height and width of each box remains the same, but the
depths vary from very shallow for the first box to fairly deep for the
last.</p>

<p>The loop specifies five boxes in total and begins by calculating the X
position and Z scaling (depth) for the current box.  The next few
lines simply create a new hash for the new box and push it onto the
object array.</p>

<p>Finally, there was one last change--the bright world light overwhelms the
problematic effect from the flashlight.  This is an easy fix; I commented out
the line that enables it:</p>

<pre><code>sub set_world_lights
{
    glLight(GL_LIGHT0, GL_POSITION, 0.0, 0.0, 1.0, 0.0);

#     glEnable(GL_LIGHT0);
}</code></pre>

<p>By panning to the left across the scene until the viewpoint is in
front of the new boxes, the problem becomes obvious:</p>

<p><img src="/pub/2005/02/17/graphics/step062.png" width="400" height="400" alt=""  /></p>

<p>The brightness of the lighting varies immensely depending on the depth
of the box!  This rather unintuitive outcome is an unfortunate side
effect of how OpenGL must handle normals.  A normal specifies the
direction of the surface associated with a vertex.  If a rigid object
rotates, its surfaces rotate, so all of its normals must rotate as
well.  OpenGL handles this by transforming normal coordinates as it
would vertex coordinates.  This runs into trouble with any
transformations other than translation and rotation.  OpenGL
calculations assume that normals are normalized (have unit length).
Scaling the normal breaks this assumption and results in the effect
seen above.</p>

<p>To fix this, I told OpenGL that normals may not have unit length and that
OpenGL must normalize them before other calculations are performed.  This is
not the default behavior because of the performance cost of normalizing each
vector.  An application that can ensure normals are always unit length after
transformation can keep the default and run a little faster.  I want to allow
arbitrary scaling of objects, so I enabled automatic normalization with another
line at the end of <code>prep_frame</code>:</p>

<pre><code>    glEnable(GL_NORMALIZE);</code></pre>

<p>That fixed the problem:</p>

<p><img src="/pub/2005/02/17/graphics/step063.png" width="400" height="400" alt=""  /></p>

<p>With that bug killed, I reenabled the world light by uncommenting
the <code>glEnable</code> line in <code>set_world_lights</code>:</p>

<pre><code>sub set_world_lights
{
    glLight(GL_LIGHT0, GL_POSITION, 0.0, 0.0, 1.0, 0.0);

    glEnable(GL_LIGHT0);
}</code></pre>

<h3>Conclusion</h3>

<p>During this article I've moved pretty quickly, covering screenshots,
movement of the viewpoint, the beginnings of lighting in OpenGL, and
subdivided faces for the boxes.  Along the way, I took the chance to
refactor <code>draw_view</code> into a more data-driven design and made the
scene a little more interesting.</p>

<p>Unfortunately, these new changes have slowed things down quite a bit.  OpenGL
has several features that can improve performance considerably.  Next time, I'll
talk about one of the most powerful of these: display lists.  I'll also
introduce basic font handling and run with the performance theme by adding an
FPS display to the engine.</p>

<p>Until next time, have fun and keep hacking!</p>



        </div>



    </div>
    <div class="asset-footer"></div>
</div>


                            
                            <div id="entry-730" class="entry-asset asset hentry">
    <div class="asset-header">
        <h2 class="asset-name entry-title"><a href="/pub/2005/02/p6pdigest/20050208.html" rel="bookmark">This Week in Perl 6, Feb. 1 - 8, 2005</a></h2>
        <div class="asset-meta">
            <span class="byline">
    
                By <span class="vcard author">Matt Fowles</span> on <abbr class="published" title="2005-02-10T00:00:00-08:00">February 10, 2005 12:00 AM</abbr>
    
            </span>

            
            

        </div>
    </div>
    <div class="asset-content entry-content">

        <div class="asset-body">
            
<!-- sidebar begins -->
<!-- don't move sidebars-->
<!-- sidebar ends -->
<p>All~</p>

<p>Welcome to yet another summary in which I will undoubtedly confuse two
homophones -- probably more than a few this week as I am a little tired. But
perhaps the alien on my window or the vampire on my monitor will help
straighten it all out.</p>

<h3>Perl 6 Language</h3>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.language/browse_frm/thread/f64bc3b208a5cd06/fbc0152bfcef5d9b?_done=%2Fgroup%2Fperl.perl6.language%3F&amp;_doneTitle=Back+to+topics&amp;_doneTitle=Back&amp;&amp;d#fbc0152bfcef5d9b">Auto-threading
Generalization</a></h4>

<p>Luke Palmer's thread about auto-threading seems to have wound down without
much resolution, or at the very least without a syntax that I like.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.language/browse_frm/thread/5e4a1efa105db3c2/b1254f644f628355?_done=%2Fgroup%2Fperl.perl6.language%3F&amp;_doneTitle=Back+to+topics&amp;_doneTitle=Back&amp;&amp;d#b1254f644f628355">Featherweight
Perl 6</a></h4>

<p>Autrijus Tang introduced Featherweight Perl 6, a side-effect-free subset of
Perl 6. FP6 is the first step on a journey for Pugs to conquer the world.</p>

<h4>Value Types vs. Implementation Types</h4>

<p>Autrijus Tang became confused by types in his work on FP6. He asked some
questions about Types on perl6-language, which told him to go to
perl6-compiler. perl6-compiler told him that he should really be on
perl6-language. Sorry for the runaround. The proper place for questions about
language semantics is perl6-language, where he originally posted.  Eventually all
of that settled and someone even answered his question.</p>

<ul>

<li><a
href="http://groups-beta.google.com/group/perl.perl6.language/browse_frm/thread/38d11214f7fef336/40de97d505000d8a?_done=%2Fgroup%2Fperl.perl6.language%3F&amp;_doneTitle=Back+to+topics&amp;_doneTitle=Back&amp;&amp;d#40de97d505000d8a">Original
post</a></li>

<li><a
href="http://groups-beta.google.com/group/perl.perl6.language/browse_frm/thread/6f7f3835ecbd0d35/d0d2526bc839747e?_done=%2Fgroup%2Fperl.perl6.language%3F&amp;_doneTitle=Back+to+topics&amp;_doneTitle=Back&amp;&amp;d#d0d2526bc839747e">Retry
with less compiler speak</a></li>

</ul>

<!-- sidebar begins -->
 <csperl file="grab" domain="on" record="b/1424" template="b/article_sidebar.view">
<!-- sidebar ends -->

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.language/browse_frm/thread/05e3e963af533c66/556d922352badfe2?_done=%2Fgroup%2Fperl.perl6.language%3F&amp;_doneTitle=Back+to+topics&amp;_doneTitle=Back&amp;&amp;d#556d922352badfe2">Logic
Programming in Perl 6</a></h4>

<p>Ovid asked how logic programming in Perl 6 would look. No answer came, but I
suppose I can pick the low hanging fruit: as a limiting case you could always
back out the entire Perl 6 grammar and insert that of Prolog.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.language/browse_frm/thread/c17f00f2dfaaae75/c058273872964662?_done=%2Fgroup%2Fperl.perl6.language%3F&amp;_doneTitle=Back+to+topics&amp;_doneTitle=Back&amp;&amp;d#c058273872964662">The
Leaning Tower of Numbers</a></h4>

<p>Autrijus Tang asked what sort of number tower Perl 6 had. He was planning
(and implemented) that of Scheme until he received an answer otherwise.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.language/browse_frm/thread/9104105fcb8ce308/0f34dd175d56e95b?_done=%2Fgroup%2Fperl.perl6.language%3F&amp;_doneTitle=Back+to+topics&amp;_doneTitle=Back&amp;&amp;d#0f34dd175d56e95b">Some
Quick Questions</a></h4>

<p>Autrijus Tang asked a few questions about operators in specific contexts. He
received a few answers, although I don't think they covered everything.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.language/browse_frm/thread/d013231e60281c54/0f56b04b11e61c4b?_done=%2Fgroup%2Fperl.perl6.language%3F&amp;_doneTitle=Back+to+topics&amp;_doneTitle=Back&amp;&amp;d#0f56b04b11e61c4b">Getopt::Signature</a></h4>

<p>Juerd wants to be able to give his script a general signature that magically parses command-line arguments. Many people thought it was a cool idea
that should go in a module rather than in the core. This led to talk about
creating a signature object to pass to this module so that it doesn't need
macros. Sounds good to me.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.language/browse_frm/thread/1e04c404b2312e4f/5bb4241195ceba2d?_done=%2Fgroup%2Fperl.perl6.language%3F&amp;_doneTitle=Back+to+topics&amp;_doneTitle=Back&amp;&amp;d#5bb4241195ceba2d">S03
Inconsistency</a></h4>

<p>Juerd found a nit to pick. There were no comments about whether to pick the
first or second option, though...</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.language/browse_frm/thread/d7a6bbcadb6503d2/a01fa36ef116dd02?_done=%2Fgroup%2Fperl.perl6.language%3F&amp;_doneTitle=Back+to+topics&amp;_doneTitle=Back&amp;&amp;d#a01fa36ef116dd02">Regex
Precedence</a></h4>

<p>Nicholas Clark wondered about adding a little operator precedence to regexes
so that people could avoid a few common problems. It sounds like a good idea to
me.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.language/browse_frm/thread/c5bb4a6d5a6e6ed5/40ff805393136f1f?_done=%2Fgroup%2Fperl.perl6.language%3F&amp;_doneTitle=Back+to+topics&amp;_doneTitle=Back&amp;&amp;d#40ff805393136f1f"> Pipedreams </a></h4>

<p>Juerd wondered if he could mix <code>=</code> and <code>==&gt;</code> in a
sane way. The answer appears to be no. Once you bring in <code>==&gt;</code>
you should stick with it.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.language/browse_frm/thread/9b872c9ed83288e0/dee3c5ceaccf1882?_done=%2Fgroup%2Fperl.perl6.language%3F&amp;_doneTitle=Back+to+topics&amp;_doneTitle=Back&amp;&amp;d#dee3c5ceaccf1882"><code>4
&lt; $x &lt; 2 == true</code>?!? </a></h4>

<p>Autrijus Tang wondered how junctions and chained comparators work. He found
that under certain semantics, the answers can be very troubling.  Larry agreed
with Autrijus about the need to avoid unintuitive semantics.</p>

<h3>Perl 6 Compiler</h3>

<h4>
Pugs 6.0.0
</h4>

<p>Autrijus Tang released Pugs 6.0.0 after six days of creation. It has many
cool features, whether a testament to the power of Haskell or the caffeine
intake of Autrijus. (Although to be fair he skipped more version numbers then
Java did in its jump to 5.0.)</p>

<ul>

<li><a
href="http://groups-beta.google.com/group/perl.perl6.compiler/browse_frm/thread/1f0786afffad7622/78f4c85198dfc803?_done=%2Fgroup%2Fperl.perl6.compiler%3F&amp;_doneTitle=Back+to+topics&amp;_doneTitle=Back&amp;&amp;d#78f4c85198dfc803">Announcement</a></li>

<li><a href="http://autrijus.org/pugs/">Pugs website</a></li>

<li><a href="http://use.perl.org/~autrijus/journal/">Implementation journal</a></li>

</ul>

<h3>Parrot</h3>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/128cdb957dd589b9/91d9fe1e7bbeacbd?_done=%2Fgroup%2Fperl.perl6.internals%3F&amp;_doneTitle=Back+to+topics&amp;_doneTitle=Back&amp;&amp;d#91d9fe1e7bbeacbd">Gdbmhash
Warning</a></h4>

<p>Bernhard Schmalhofer fixed a problem where gdbmhash could make
<code>Configure</code> produce a warning. Leo applied it.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/2853a00850a9b11c/481de9502b44540e?_done=%2Fgroup%2Fperl.perl6.internals%3F&amp;_doneTitle=Back+to+topics&amp;_doneTitle=Back&amp;&amp;d#481de9502b44540e">PyNCI</a></h4>

<p>Sam and Leo worked out the correct way to create NCI methods for Python.
Leo ended by proposing a table to assist Parrot based on the current language,
but no answer came for that idea.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/b7a3db11e168f072/4db88267262c9915?_done=%2Fgroup%2Fperl.perl6.internals%3F&amp;_doneTitle=Back+to+topics&amp;_doneTitle=Back&amp;&amp;d#4db88267262c9915"><em>Makefile</em>
Cleanup</a></h4>

<p>Bernhard Schmalhofer cleaned up some of the makefiles and configure system.
Leo applied the patch.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/bc085b85c608b9f2/c40e41ff938107fa?_done=%2Fgroup%2Fperl.perl6.internals%3F&amp;_doneTitle=Back+to+topics&amp;_doneTitle=Back&amp;&amp;d#c40e41ff938107fa"><code>ParrotIOLayer*</code> Const or Not</a></h4>

<p>Fran&ccedil;ois Perrad provided a patch making the <code>ParrotIOLayer*</code> const in the API. Leo applied it, but Melvin warned
that while this may be safe now, the API intended to allow mutability. I think
for the moment it is still in though.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/e7d149e7e84eb21b/eabf6f6cf0804c47?_done=%2Fgroup%2Fperl.perl6.internals%3F&amp;_doneTitle=Back+to+topics&amp;_doneTitle=Back&amp;&amp;d#eabf6f6cf0804c47">Win32
Parrot</a></h4>

<p>Ron Blaschke helped Parrot back onto its feet in the Windows world.</p>

<p><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/b671ff734d8c1039/61a2dd6745de36b8?_done=%2Fgroup%2Fperl.perl6.internals%3F&amp;_doneTitle=Back+to+topics&amp;_doneTitle=Back&amp;&amp;d#61a2dd6745de36b8">Latest
results</a></p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/d0f4b900e21b38cf/caf7071ee6885084?_done=%2Fgroup%2Fperl.perl6.internals%3F&amp;_doneTitle=Back+to+topics&amp;_doneTitle=Back&amp;&amp;d#caf7071ee6885084"><code>Parrot_load_bytecode</code>
Failure? </a></h4>

<p>Ian Joyce wondered what would happen if <code>Parrot_load_bytecode</code>
failed. The answer: an exception.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/4c9d3f29c7ed75c8/30378cdaf40babc8?_done=%2Fgroup%2Fperl.perl6.internals%3F&amp;_doneTitle=Back+to+topics&amp;_doneTitle=Back&amp;&amp;d#30378cdaf40babc8">Reading
Past EOF</a></h4>

<p>Matt Diephouse found it annoying that reading past EOF gave an unhelpful
error message. Leo fixed it.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/0249207572737092/a8c5db31dbd75085?_done=%2Fgroup%2Fperl.perl6.internals%3F&amp;_doneTitle=Back+to+topics&amp;_doneTitle=Back&amp;&amp;d#a8c5db31dbd75085">FreeBSD
Build Problems</a></h4>

<p>Will Coleda found a build problem for Parrot on FreeBSD. Adriano Ferreira
provided a workaround, but the build system needs to be smarter, too. On a side
note, I want a picture of the BSD daemon (pitchfork included) with a pirate
hat, an eye patch, and a parrot on its shoulder.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/54c5ba8dfea4eb17/32322a16145c6bcc?_done=%2Fgroup%2Fperl.perl6.internals%3F&amp;_doneTitle=Back+to+topics&amp;_doneTitle=Back&amp;&amp;d#32322a16145c6bcc"><code>Gmake</code>
Requirement? </a></h4>

<p>There was some confusion about what does and does not require
<code>gmake</code> on FreeBSD. IMCC does not. ICU does. Fortunately, Dan's
string stuff will make ICU optional and Parrot won't require it.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/7f0e6a2425c000c3/50a89a6b9ff0df71?_done=%2Fgroup%2Fperl.perl6.internals%3F&amp;_doneTitle=Back+to+topics&amp;_doneTitle=Back&amp;&amp;d#50a89a6b9ff0df71"><code>Locate_runtime_file</code>
with Absolute Paths</a></h4>

<p>Jeff Horwitz noticed that <code>Parrot_locate_runtime_file</code> could
segfault when playing with an absolute path. He put some work in to fix it.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/072216c7d2041cc7/c0de5c250dfadc7a?_done=%2Fgroup%2Fperl.perl6.internals%3F&amp;_doneTitle=Back+to+topics&amp;_doneTitle=Back&amp;&amp;d#c0de5c250dfadc7a">Expected
<em>vpm.imc</em> Output Error</a></h4>

<p>Bernhard Schmalhofer fixed a failing benchmark test that just had slightly
wrong output expectations. chromatic (whose uncapitalized name does not bother
me) applied the patch.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/dfd9b5007b42705b/62c826e990b1e567?_done=%2Fgroup%2Fperl.perl6.internals%3F&amp;_doneTitle=Back+to+topics&amp;_doneTitle=Back&amp;&amp;d#62c826e990b1e567">Subversive
Parrot</a></h4>

<p>Ron Blaschke asked if there were plans to move Parrot to SVN. Many argued in
favor; few argued against. No word from the powers-that-be.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/f3fab2ac907655ca/ce1e479ab2605ae8?_done=%2Fgroup%2Fperl.perl6.internals%3F&amp;_doneTitle=Back+to+topics&amp;_doneTitle=Back&amp;&amp;d#ce1e479ab2605ae8">Parrot
0.1.2? </a></h4>

<p>Will Coleda wondered if the time for Parrot 0.1.2 was growing close. Leo
pointed out some things that need fixes. Honestly, the real impediment is that
we do not yet have a cool code name. I suggest kiwi, because everyone knows
they really want to be Parrots.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/95786368b7c49faf/bf845f0561fc65fd?_done=%2Fgroup%2Fperl.perl6.internals%3F&amp;_doneTitle=Back+to+topics&amp;_doneTitle=Back&amp;&amp;d#bf845f0561fc65fd">Making
an Array Out of an Undef</a></h4>

<p>Ron Blaschke was surprised when an operation quietly turned an Undef into an
array. Leo explained to him that this set of semantics was known and
expected.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/e7aaad0dcfe9205c/9f4ef8cbe4ee97a4?_done=%2Fgroup%2Fperl.perl6.internals%3F&amp;_doneTitle=Back+to+topics&amp;_doneTitle=Back&amp;&amp;d#9f4ef8cbe4ee97a4">Solaris
Issues</a></h4>

<p>Andy Dougherty noticed that Parrot was failing some tests on Solaris. He
tried to provide enough info for people to help him, but no one did.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/0ba5cee8ddebab21/63f81c98b5107480?_done=%2Fgroup%2Fperl.perl6.internals%3F&amp;_doneTitle=Back+to+topics&amp;_doneTitle=Back&amp;&amp;d#63f81c98b5107480">Linux
PPC Issues</a></h4>

<p>Jeff Dik posted a patch that worked around a problem on Linux PPC.
chromatic pointed out that there was a more correct patch already in RT.  Jeff
Dik slapped himself on the forehead and reminded himself to check RT first.</p>

<h3>The Usual Footer</h3>

<p>Posting via the Google Groups interface does not work. To post to any of
these mailing lists please subscribe by sending email to <csperl file="mailmunge" arg_email="perl6-internals-subscribe@perl.org" arg_ending="," /> <csperl file="mailmunge" arg_email="perl6-compiler-subscribe@perl.org" />.
If you find these summaries useful or enjoyable, please consider contributing
to the Perl Foundation to help support the development of Perl. You might also
like to send feedback to <csperl file="mailmunge" arg_email="ubermatt@gmail.com" arg_ending="." /></p>

<ul>

<li><a href="http://donate.perl-foundation.org/">The Perl Foundation</a></li>
<li><a href="http://dev.perl.org/perl6/">Perl 6 Development site</a></li>
<li><a href="http://planet.parrotcode.org/">Parrot Blog aggregator</a></li>

</ul>





        </div>



    </div>
    <div class="asset-footer"></div>
</div>


                            
                            <div id="entry-724" class="entry-asset asset hentry">
    <div class="asset-header">
        <h2 class="asset-name entry-title"><a href="/pub/2005/02/10/database_kata.html" rel="bookmark">Perl Code Kata: Testing Databases</a></h2>
        <div class="asset-meta">
            <span class="byline">
    
                By <span class="vcard author">Stevan Little</span> on <abbr class="published" title="2005-02-10T00:00:00-08:00">February 10, 2005 12:00 AM</abbr>
    
            </span>

            
            

        </div>
    </div>
    <div class="asset-content entry-content">

        <div class="asset-body">
            
<!-- sidebar begins -->
<!-- don't move sidebars-->
<!-- sidebar ends -->
<p>Testing code that uses a database can be tricky. The most common solution
is to set up a test database with test data and run your tests against this.
This, of course, requires bookkeeping code to keep your test database in the
proper state for all your tests to run without adversely affecting one another.
This can range from dropping and recreating the test database for each test, to
a more granular adding and deleting at the row level.  Either way, you are
introducing non-test code into your tests that open up possibilities for
contamination. Ultimately, because you have control over the environment in
which your tests run, you can manage this despite the occasional headache.</p>

<p>The real fun only starts when you decide that you should release your
masterpiece unto the world at large. As any CPAN author will tell you, it is
absolutely impossible to control the environment other people will run your
code in once you release it. Testing database code in such a hostile
environment can be frustrating for both the module developer and the module
installer. A common approach is to allow the user to specify the specific
database connection information as either environment variables or command-line
arguments, skipping the tests unless those variables are present. Another
approach is to use the lightweight and very portable <a
href="http://www.sqlite.org/">SQLite</a> as your test database (of course,
testing first that the user has installed SQLite). While these solutions do
work, they can often be precarious, and in the end will increase the number of
possible installation problems you, as module author, could face.</p>

<p>What is a module author to do?</p>

<h3>DBD::Mock Testing Kata</h3>

<p>This code kata introduces an alternate approach to testing database code,
that of using mock-objects, and specifically of using the <a
href="http://search.cpan.org/perldoc?DBD::Mock">DBD::Mock</a> mock DBI driver.
Before showing off any code, I want to explain the basic philosophy of Mock
Objects as well as where DBD::Mock fits in.</p>

<!-- sidebar begins -->
 <csperl file="grab" domain="on" record="b/719" template="b/article_sidebar.view">
<!-- sidebar ends -->

<h4>What are Mock Objects?</h4>

<p>When writing unit tests, it is best to try to isolate what you are
testing as much as possible. You want to be sure that not only are you
<em>only</em> testing the code in question, but that a bug or issue in code
outside what you are testing will not introduce false negatives in your tests.
Unfortunately, this ideal of a completely decoupled design is just an ideal. In
real-world practice, code has dependencies that you cannot remove for testing.
This is where Mock Objects come in.</p>

<p>Mock Objects are exactly what they sound like; they are "mocked" or "fake"
objects. Good polymorphic thought says that you should be able to swap out one
object for another object implementing the same interface. Mock Objects take
advantage of this by allowing you to substitute the <em>most minimally mocked
implementation of an object possible</em> for the real one during testing. This
allows you to concentrate on the code being tested without worrying about silly
things, such as whether your database is still running or if there is a database
available to test against.</p>

<h4>Where Does DBD::Mock Fit In?</h4>

<p>DBD::Mock is a mock DBI Driver that allows you to test code which uses DBI
without needing to worry about the who, what, when, and where of a database.
DBD::Mock also helps to reduce the amount of database bookkeeping code by doing
away with the database entirely, instead keeping a detailed record of all the
actions performed by your code through DBI. Of course, database
interaction/communication is not only one way, so DBD::Mock also allows you to
seed the driver with mock record sets.  DBD::Mock makes it possible to fake
most (non-vendor specific) database interaction for the purpose of writing
tests.  For more detailed documentation I suggest reading the DBD::Mock POD
documentation itself.</p>

<h4>Sample DBI Code</h4>

<p>In the tradition of past Perl Code katas here is some simplified code to
write your tests against. This code should be simple enough to understand, but
also complex enough to show the real usefulness of DBD::Mock.</p>

<pre><code>package MyApp::Login;

use DBI;

my $MAX_LOGIN_FAILURES = 3;

sub login {
  my ($dbh, $u, $p) = @_;
  # look for the right username and password
  my ($user_id) = $dbh-&gt;selectrow_array(
      "SELECT user_id FROM users WHERE username = '$u' AND password = '$p'"
  );
  # if we find one, then ...
  if ($user_id) {
      # log the event and return success      
      $dbh-&gt;do(
          "INSERT INTO event_log (event) VALUES('User $user_id logged in')"
      );
      return 'LOGIN SUCCESSFUL';
  }
  # if we don't find one then ...
  else {
      # see if the username exists ...
      my ($user_id, $login_failures) = $dbh-&gt;selectrow_array(
          "SELECT user_id, login_failures FROM users WHERE username = '$u'"
      );
      # if we do have a username, and the password doesnt match then
      if ($user_id) {
          # if we have not reached the max allowable login failures then 
          if ($login_failures &lt; $MAX_LOGIN_FAILURES) {
              # update the login failures
              $dbh-&gt;do(qq{
                  UPDATE users 
                  SET login_failures = (login_failures + 1)
                  WHERE user_id = $user_id
              });
              return 'BAD PASSWORD';                  
          }
          # otherwise ...
          else {
              # we must update the login failures, and lock the account
              $dbh-&gt;do(
                  "UPDATE users SET login_failures = (login_failures + 1), " .
                  "locked = 1 WHERE user_id = $user_id"
              );                                                              
              return 'USER ACCOUNT LOCKED';
          }
      }
      else {
          return 'USERNAME NOT FOUND';
      }
  }
}</code></pre>

<p>There are four distinct paths through this code, each one resulting in one
of the four return messages; <code>LOGIN SUCCESSFUL</code>, <code>BAD
PASSWORD</code>, <code>USER ACCOUNT LOCKED</code>, and <code>USERNAME NOT
FOUND</code>. See if you can write tests enough to cover all four paths. Feel
free to use <a
href="http://search.cpan.org/~pjcj/Devel-Cover-0.52/lib/Devel/Cover.pm">Devel::Cover</a> to verify
this.</p>

<p>Armed with your knowledge of DBD::Mock, go forth and write tests!  The next
page describes DBD::Mock in more detail and gives some strategies for writing
the appropriate tests.  You should spend between 30 and 45 minutes writing the
tests before continuing.</p>













<h3>Tips, Tricks, and Suggestions</h3>

<p>Because DBD::Mock is an implementation of a DBD driver, its usage is
familiar to that of DBI.  DBD::Mock is unique in its ability to mock the
database interaction. The following is a short introduction to these features
of DBD::Mock.</p>

<p>Fortunately, connecting to the database is the only part of your regular DBI
code which needs to be DBD::Mock specific, because DBI chooses the driver based
upon the dsn string given it.  To do this with DBD::Mock:</p>

<pre><code>my $dbh = DBI-&gt;connect('dbi:Mock:', '', '');</code></pre>

<p>Because DBI will not actually connecting to a real database here, you need
no database name, username, or password. The next thing to do is to seed the
database driver with a result set. Do this through the
<code>mock_add_resultset</code> attribute of the <code>$dbh</code> handle.</p>

<pre><code>$dbh-&gt;{mock_add_resultset} = [
  [ 'user_id', 'username', 'password' ],
  [ 1, 'stvn', '****' ]
];</code></pre>

<p>DBD::Mock will return this particular result set the next time a statement
executes on this <code>$dbh</code>.  Note that the first row is the column
names, while all subsequent rows are data. Of course, in some cases, this is not
specific enough, and so DBD::Mock also allows the binding of a particular SQL
statement to a particular result set:</p>

<pre><code>$dbh-&gt;{mock_add_resultset} = {
  sql     =&gt; "SELECT * FROM user_table WHERE username = 'stvn'",
  results =&gt; [[ 'user_id', 'username', 'password' ],
              [ 1, 'stvn', '****' ]]
};</code></pre>

<p>Now whenever the statement <code>SELECT * FROM user_table WHERE username =
'stvn'</code> executes, DBD::Mock will return this result set  DBD::Mock can
also specify the number of rows affected for <code>UPDATE</code>,
<code>INSERT</code>, and <code>DELETE</code> statements using
<code>mock_add_resultset</code> as well.  For example, here DBI will see the
<code>DELETE</code> statement as having deleted 3 rows of data:</p>

<pre><code>$dbh-&gt;{mock_add_resultset} = {
  sql     =&gt; "DELETE FROM session_table WHERE active = 0",
  results =&gt; [[ 'rows' ], [], [], []]
};</code></pre>

<p>DBD::Mock version 0.18 introduced the DBD::Mock::Session object, which
allows the scripting of a <code>session</code> of database interaction -- and
DBD::Mock can verify that the session executes properly. Here is an example of
DBD::Mock::Session:</p>

<pre><code>$dbh-&gt;{mock_session} = DBD::Mock::Session-&gt;new('session_reaping' =&gt; (
  {
  statement =&gt; "UPDATE session_table SET active = 0 WHERE timeout &lt; NOW()",
  results  =&gt; [[ 'rows' ], [], [], []]
  },
  {
  statement =&gt; "DELETE FROM session_table WHERE active = 0",
  results  =&gt; [[ 'rows' ], [], [], []]
  }  
));</code></pre>

<p>The hash reference given for each statement block in the session should look
very similar to the values added with <code>mock_add_resultset</code>, with the
only difference in the substitution of the word <code>statement</code> for the
word <code>sql</code>. DBD::Mock will assure that the first statement run
matches the first statement in the session, raising an error (in the manner
specified by <code>PrintError</code> or <code>RaiseError</code>) if not.
DBD::Mock will then continue through the session until it reaches the last
statement, verifying that each statement run matches in the order specified.
You can also use regular expression references and code references in the
<code>statement</code> slots of DBD::Mock::Session for even more sophisticated
comparisons.  See the documentation for more details of how those features
work.</p>

<p>After you seed a <code>$dbh</code> with result sets, the next step is to run
the DBI code which will use those result sets.  This is just normal regular
everyday DBI code, with nothing unique to DBD::Mock.</p>

<p>After all the DBI code runs, it is possible to then go through all the
statements that have been executed and examine them using the array of
DBD::Mock::StatementTrack objects found in the <code>mock_all_history</code>
attribute of your <code>$dbh</code>. Here is a simple example of printing
information about each statement run and the bind parameters used:</p>

<pre><code>my $history = $dbh-&gt;{mock_all_history};
foreach my $s (@{$history}) {
  print "Statement  : " . $s-&gt;statement() . "\n" .
        "bind params: " . (join ', ', @{$s-&gt;bound_params()}) . "\n";
}</code></pre>

<p>DBD::Mock::StatementTrack also offers many other bits of statement
information. I refer you again to the DBD::Mock POD documentation for more
details.</p>

<p>Now, onto the tests.</p>

<h3>Solutions</h3>

<p>The saying goes of Perl, "there is more than one way to do it", and this is
true of DBD::Mock as well. The test code had four distinct paths through the
code, and the test solutions will use each one to demonstrate a different
technique for writing tests with DBD::Mock.</p>

<p>The first example is the <code>LOGIN SUCCESSFUL</code> path. The code uses
the array version of <code>mock_add_resultset</code> to seed the
<code>$dbh</code> and then examines the <code>mock_all_history</code> to be
sure all the statements ran in the correct order.</p>

<pre><code>use Test::More tests =&gt; 4;

use MyApp::Login;

my $dbh = DBI-&gt;connect('dbi:Mock:', '', '');
 
$dbh-&gt;{mock_add_resultset} = [[ 'user_id' ], [ 1 ]];
$dbh-&gt;{mock_add_resultset} = [[ 'rows' ], []];

is(MyApp::Login::login($dbh, 'user', '****'), 
   'LOGIN SUCCESSFUL', 
   '... logged in successfully');
 
my $history = $dbh-&gt;{mock_all_history};

cmp_ok(@{$history}, '==', 2, '... we ran 2 statements');

is($history-&gt;[0]-&gt;statement(), 
   "SELECT user_id FROM users WHERE username = 'user' AND password =
    '****'", '... the first statement is correct');

is($history-&gt;[1]-&gt;statement(), 
   "INSERT INTO event_log (event) VALUES('User 1 logged in')",
   '... the second statement is correct');</code></pre>

<p>This is the simplest and most direct use of DBD::Mock. Simply seed the
<code>$dbh</code> with an appropriate number of result sets, run the code, and
then test to verify it called the right SQL in the right order. It doesn't come
much simpler than that. This approach does have its drawbacks though, the most
obvious being that there is no means of associating the SQL directly with the
result sets (as would happen in a real database). However, DBD::Mock returns
result sets in the order added, so there is an implied sequence of events,
verifiable later with <code>mock_all_history</code>.</p>

<p>The next example is the <code>USERNAME NOT FOUND</code> path. The test code
uses the hash version of <code>mock_add_resultset</code> to seed the
<code>$dbh</code> and the <code>mock_all_history_iterator</code> to check the
statements afterwards.</p>

<pre><code>use Test::More tests =&gt; 4;

use MyApp::Login;

my $dbh = DBI-&gt;connect('dbi:Mock:', '', '');

$dbh-&gt;{mock_add_resultset} = {
  sql =&gt; "SELECT user_id FROM users WHERE username = 'user' 
       AND password = '****'", results =&gt; [[ 'user_id' ], 
	   [ undef ]]
};
$dbh-&gt;{mock_add_resultset} = {
  sql =&gt; "SELECT user_id, login_failures FROM users WHERE 
       username = 'user'", results =&gt; [[ 'user_id', 
	   'login_failures' ], [ undef, undef ]]
};

is(MyApp::Login::login($dbh, 'user', '****'), 
  'USERNAME NOT FOUND', 
  '... username is not found');

my $history_iterator = $dbh-&gt;{mock_all_history_iterator};

is($history_iterator-&gt;next()-&gt;statement(), 
   "SELECT user_id FROM users WHERE username = 'user' AND password = '****'",
   '... the first statement is correct');

is($history_iterator-&gt;next()-&gt;statement(), 
   "SELECT user_id, login_failures FROM users WHERE username = 'user'",
   '... the second statement is correct');

ok(!defined($history_iterator-&gt;next()), '... we have no more statements');</code></pre>

<p>This approach allows the association of a specific SQL statement with a
specific result sets. However, it loses the implied ordering of statements,
which is one of the benefits of the array version of
<code>mock_add_resultset</code>. You can check this manually using
<code>mock_all_history_iterator</code> (which simply iterates over the array
returned by <code>mock_all_history</code>). One of the nice things about using
<code>mock_all_history_iterator</code> is that if the need arises to add,
delete, or reorder your SQL statements, you don't need to change all the
<code>$history</code> array indices in your test. It is also a good idea to
check that only the two expected statements ran; do this by exploiting the fact
that the iterator returns undefined values when it exhausts its contents.</p>

<p>The next example is the <code>USER ACCOUNT LOCKED</code> path. The test code
uses the DBD::Mock::Session object to test this path. I recommend to set the
<code>$dbh</code> to <code>RaiseError</code> so that DBD::Mock::Session will
throw an exception if it runs into an issue.</p>

<pre><code>use Test::More tests =&gt; 2;
use Test::Exception;

use MyApp::Login;

my $dbh = DBI-&gt;connect('dbi:Mock:', '', '', { RaiseError =&gt; 1, PrintError =&gt; 0 });

my $lock_user_account = DBD::Mock::Session-&gt;new('lock_user_account' =&gt; (
  {
      statement =&gt; "SELECT user_id FROM users WHERE username = 'user' AND 
	       password = '****'", results   =&gt; [[ 'user_id' ], [ undef]]
  },
  {
      statement =&gt; "SELECT user_id, login_failures FROM users WHERE 
	       username = 'user'", results   =&gt; [[ 'user_id', 'login_failures' ], 
	       [ 1, 4 ]]
  },
  {
      statement =&gt; "UPDATE users SET login_failures = (login_failures + 1), 
	  locked = 1 WHERE user_id = 1", results   =&gt; [[ 'rows' ], []]
  }
));

$dbh-&gt;{mock_session} = $lock_user_account;
my $result;
lives_ok {
    $result = MyApp::Login::login($dbh, 'user', '****')
} '... our session ran smoothly';
is($result, 
  'USER ACCOUNT LOCKED', 
  '... username is found, but the password is wrong, 
       so we lock the the user account');</code></pre>

<p>The DBD::Mock::Session approach has several benefits.  First, the SQL
statements are associated with specific result sets (as with the hash version
of <code>mock_add_resultset</code>). Second, there is an explicit ordering of
statements (like the array version of <code>mock_add_resultset</code>).
DBD::Mock::Session will verify that the session has been followed properly, and
raise an error if it is not. The one drawback of this example is the use of
static strings to compare the SQL with. However, DBD::Mock::Session can use
other things, as illustrated in the next and final example.</p>

<p>The next and final example is the <code>BAD PASSWORD</code> path. The test
code demonstrates some of the more complex possibilities of the
DBD::Mock::Session object:</p>

<pre><code>use Test::More tests =&gt; 2;
use Test::Exception;

use SQL::Parser;
use Data::Dumper;

use MyApp::Login;

my $dbh = DBI-&gt;connect('dbi:Mock:', '', '', { RaiseError =&gt; 1, PrintError =&gt; 0 });

my $bad_password = DBD::Mock::Session-&gt;new('bad_password' =&gt; (
{
  statement =&gt; qr/SELECT user_id FROM users WHERE username = \'.*?\' AND 
       password = \'.*?\'/, results   =&gt; [[ 'user_id' ], [ undef]]
},
{
  statement =&gt; qr/SELECT user_id, login_failures FROM users WHERE username = 
  \'.*?\'/, results   =&gt; [[ 'user_id', 'login_failures' ], [ 1, 0 ]]
},
{
  statement =&gt; sub { 
      my $parser1 = SQL::Parser-&gt;new('ANSI');
      $parser1-&gt;parse(shift(@_)); 
      my $parsed_statement1 = $parser1-&gt;structure(); 
      delete $parsed_statement1-&gt;{original_string};
      
      my $parser2 = SQL::Parser-&gt;new('ANSI');
      $parser2-&gt;parse("UPDATE users SET login_failures = 
	       (login_failures + 1) WHERE user_id = 1");
      my $parsed_statement2 = $parser2-&gt;structure(); 
      delete $parsed_statement2-&gt;{original_string};      
      
      return Dumper($parsed_statement2) eq Dumper($parsed_statement1);
  },
  results   =&gt; [[ 'rows' ], []]
}
));

$dbh-&gt;{mock_session} = $bad_password;

my $result;
lives_ok {
    $result = MyApp::Login::login($dbh, 'user', '****')
} '... our session ran smoothly';
is($result, 'BAD PASSWORD', '... username is found, but the password is wrong');</code></pre>

<p>This approach uses DBD::Mock::Session's more flexible means of performing
SQL comparisons. The first and second statements are compared using
regular expressions, which alleviates the need to hardcode test data into the
statement. The third statement uses a subroutine reference to perform the SQL
comparison. As you may have noticed in the test code provided, the
<code>UPDATE</code> statement for the <code>BAD PASSWORD</code> path used
Perl's <code>qq()</code> quoting mechanism to format the SQL in a more freeform
manner. This can create complexities when trying to verify the SQL using
strings or regular expressions. The test here uses <a
href="http://search.cpan.org/perldoc?SQL::Parser">SQL::Parser</a> to determine
the <em>functional equivalence</em> of the test statement and the statement run
in the code.</p>

<h3>Conclusion</h3>

<p>I hope this kata has illustrated that unit-testing DBI code does not have to
be as difficult and dangerous as it might seem. Through the use of Mock Objects
in general and specifically the DBD::Mock DBI driver, it is possible to achieve
100% code coverage of your DBI-related code without ever having touched a real database. Here is the Devel::Cover output for the tests above:</p>

<pre><code> ---------------------------- ------ ------ ------ ------ ------ ------ ------
 File                           stmt branch   cond    sub    pod   time  total
 ---------------------------- ------ ------ ------ ------ ------ ------ ------
 lib/MyApp/Login.pm            100.0  100.0    n/a  100.0    n/a  100.0  100.0
 Total                         100.0  100.0    n/a  100.0    n/a  100.0  100.0
 ---------------------------- ------ ------ ------ ------ ------ ------ ------</code></pre>

<h3>See Also --</h3>

<ul>

<li><a href="http://www.mockobjects.com/">MockObjects Wiki</a></li>

<li><a href="/pub/a/2002/07/10/tmo.html">A Test::MockObject
Illustrated Example</a></li>

</ul>




        </div>



    </div>
    <div class="asset-footer"></div>
</div>


                            
                            <div id="entry-734" class="entry-asset asset hentry">
    <div class="asset-header">
        <h2 class="asset-name entry-title"><a href="/pub/2005/02/p6pdigest/2005031.html" rel="bookmark">This Fortnight in Perl 6, Jan. 19-31, 2005</a></h2>
        <div class="asset-meta">
            <span class="byline">
    
                By <span class="vcard author">Matt Fowles</span> on <abbr class="published" title="2005-02-03T00:00:00-08:00">February  3, 2005 12:00 AM</abbr>
    
            </span>

            
            

        </div>
    </div>
    <div class="asset-content entry-content">

        <div class="asset-body">
            
<!-- sidebar begins -->
<!-- don't move sidebars-->
<!-- sidebar ends -->
<p>All~</p>

<p>Welcome to another double feature summary. Sadly, this one was delayed
because of an argument that I was/am having with my connection.
Fortunately, a generous neighbor has allowed me to use his connection for
the time being. So, with that random act of kindness in mind, I bring
you �</p>

<h3>Perl 6 Language</h3>

<h4>Perl 6 on E</h4>

<p>Rich Morin wondered if Perl 6 would support the features of the language E.
Larry told him it would support many of them, and "as a limiting case, you can
always back out the entire Perl grammar and install the E grammar in its
place." He left this as an exercise for the reader.</p>

<ul>

<li><a
href="http://groups-beta.google.com/group/perl.perl6.language/browse_frm/thread/d7b5679b0c32a7c7/f1f8012e39225a1e?_done=%2Fgroup%2Fperl.perl6.language%3F&amp;_doneTitle=Back+to+topics&amp;_doneTitle=Back&amp;&amp;d#f1f8012e39225a1e">The
Thread</a></li>

<li><a href="http://www.erights.org/">E's Homepage</a></li>

</ul>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.language/browse_frm/thread/60003777d2b8df79/db70f9b005934bf8?_done=%2Fgroup%2Fperl.perl6.language%3F&amp;_doneTitle=Back+to+topics&amp;_doneTitle=Back&amp;&amp;d#db70f9b005934bf8">Challenge
the Palmer ...</a></h4>

<p>Luke Palmer produced answers to Austin Hastings's "How do I" questions.
Anyone else with such questions should send them to the list lest Luke's
learnedness loses luster.</p>

<h4>
Refactoring Perl automatically
</h4>

<p>Matisse Enzer re-re-raised the thread on refactoring Perl. This time he
posted a link to EPIC, an Eclipse plugin that uses <a
href="http://search.cpan.org/perldoc/Devel::Refactor">Devel::Refactor</a>.
Unfortunately, I think he is still using the Google Groups interface to
post the language. I repeat, emails posted via Google Groups do <em>not</em>
make it to the list itself.</p>

<ul>

<li><a
href=http://groups-beta.google.com/group/perl.perl6.language/browse_frm/thread/d31481c114e88a11/8fde39f7f7418669?_done=%2Fgroup%2Fperl.perl6.language%3F&amp;_doneTitle=Bac+to+topics&amp;_doneTitle=Back&amp;&amp;d#8fde39f7f7418669">Thread</a></li>

<li><a href="http://e-p-i-c.sourceforge.net/">EPIC</a></li>

</ul>

<h4><a
href=http://groups-beta.google.com/group/perl.perl6.language/browse_frm/thread/c9f1db8d113c08d7/ae57551677fee394?_done=%2Fgroup%2Fperl.perl6.language%3F&amp;_doneTitle=Bac+to+topics&amp;_doneTitle=Back&amp;&amp;d#ae57551677fee394">Loops,
Bare Blocks, and My Head Hurts</a></h4>

<p>Juerd wondered if <code>last</code>/<code>redo</code> would work outside
loops. Larry provided the long answer. The short answer is no, things act
basically rationally so that <code>return</code>, <code>next</code>, and
<code>last</code> all behave as expected.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.language/browse_frm/thread/4bcd12915cf71913/932c5f432a874044?_done=%2Fgroup%2Fperl.perl6.language%3F&amp;_doneTitle=Back+to+topics&amp;_doneTitle=Back&amp;&amp;d#932c5f432a874044">Where
Without Type</a></h4>

<p>Juerd wondered if he could use a where clause with a type. The answer is
yes, as it will useful to restrict values admitted to a multi-method. This led
me to the evil thought of putting side-effects in a where clause on several
multi-methods and watching the pain of resolution cause very difficult to find
bugs. Sometime I think that my mind looks for nasty ways to write bad code a
little too much.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.language/browse_frm/thread/f64bc3b208a5cd06/a3d89cf334c4bc3d?_done=%2Fgroup%2Fperl.perl6.language%3F&amp;_doneTitle=Back+to+topics&amp;_doneTitle=Back&amp;&amp;d#a3d89cf334c4bc3d">Auto-threading</a></h4>

<p>Luke Palmer posted his musing about auto-threading. I must say it looks
powerful enough to blow off your entire lower body if you shoot yourself in the
foot.</p>

<!-- sidebar begins -->
 <csperl file="grab" domain="on" record="b/1424" template="b/article_sidebar.view">
<!-- sidebar ends -->

<h3>Perl 6 Compiler</h3>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.compiler/browse_frm/thread/73a788c2ec58460a/5affb9601639f1dc?_done=%2Fgroup%2Fperl.perl6.compiler%3F&amp;_doneTitle=Back+to+topics&amp;_doneTitle=Back&amp;&amp;d#5affb9601639f1dc">Pugs</a></h4>

<p>Not just ugly dogs anymore, they are also P6 interpreters written in Haskel.
It sounds really cool to me.</p>

<h3>Parrot</h3>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/2a32fa21e2795b7f/fd10f5769fb8ed39?_done=%2Fgroup%2Fperl.perl6.internals%2Fthreads%3Fstart%3D30%26order%3Drecent%26&amp;_doneTitle=Back&amp;&amp;d#fd10f5769fb8ed39">MMD
and Meta-Stuff</a></h4>

<p>In a thread posted also to p6l (sorry about that), I attempt to explain how
parrot object system is already very close to the Common Lisp Object System and
why it should become even closer. I am not sure if I succeeded. My ability to
express really abstract thoughts without a whiteboard is poor.</p>

<h4>
RT Clean Up
</h4>

<p>Will Coleda has put an extensive amount of work into cleaning up Parrot for
public presentation with a focus on RT and organization.</p>

<ul>

<li><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/4c44bbf90d80f5be/d330d20d7fbb4f98?_done=%2Fgroup%2Fperl.perl6.internals%2Fthreads%3Fstart%3D30%26order%3Drecent%26&amp;_doneTitle=Back&amp;&amp;d#d330d20d7fbb4f98">Hall
of Shame 15308</a></li>

<li><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/d73ecb43144bf1c3/ef842bfe48337d56?_done=%2Fgroup%2Fperl.perl6.internals%2Fthreads%3Fstart%3D0%26order%3Drecent%26&amp;_doneTitle=Back&amp;&amp;d#ef842bfe48337d56">ROADMAP</a></li>

</ul>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/5ac3f1c5375d5da5/6f67663f2c6f1245?_done=%2Fgroup%2Fperl.perl6.internals%2Fthreads%3Fstart%3D0%26order%3Drecent%26&amp;_doneTitle=Back&amp;&amp;d#6f67663f2c6f1245"><code>argv[0]</code></a></h4>

<p>Wukk (who is Will when my fingers slip off key) wants the name of the
invoked executable. Dan upped the ante by offering the full and base name
variants of the interpreter, the program, and the invoked thing.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/f9ac71f8f3402597/46c18e5d2658e6cd?_done=%2Fgroup%2Fperl.perl6.internals%2Fthreads%3Fstart%3D0%26order%3Drecent%26&amp;_doneTitle=Back&amp;&amp;d#46c18e5d2658e6cd">OSCON</a></h4>

<p>Robert Spier put out a call for OSCON proposals.</p>

<h4>
<code>Read</code> and <code>Readline</code>
</h4>

<p>Matt Diephouse has been cleaning up <code>read</code> and
<code>readline</code>.</p>

<ul>

<li><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/e458ecc388f0b0a7/534af68d76a393ff?_done=%2Fgroup%2Fperl.perl6.internals%2Fthreads%3Fstart%3D0%26order%3Drecent%26&amp;_doneTitle=Back&amp;&amp;d#534af68d76a393ff">RT
Ticket</a></li>

<li><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/1725d504480fb0bf/ae8d0fcfbcef7b33?_done=%2Fgroup%2Fperl.perl6.internals%2Fthreads%3Fstart%3D0%26order%3Drecent%26&amp;_doneTitle=Back&amp;&amp;d#ae8d0fcfbcef7b33">Discussion</a></li>

<li><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/14124ddc27011622/0bc232a97c300571?_done=%2Fgroup%2Fperl.perl6.internals%2Fthreads%3Fstart%3D0%26order%3Drecent%26&amp;_doneTitle=Back&amp;&amp;d#0bc232a97c300571">Partial
Resolution</a></li>

<li><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/4c9d3f29c7ed75c8/ecd2934565627820?_done=%2Fgroup%2Fperl.perl6.internals%2Fthreads%3Fstart%3D0%26order%3Drecent%26&amp;_doneTitle=Back&amp;&amp;d#ecd2934565627820">An
Offered Patch</a></li>

</ul>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/358874c77dbe40f8/01806480a1ea7b6e?_done=%2Fgroup%2Fperl.perl6.internals%2Fthreads%3Fstart%3D0%26order%3Drecent%26&amp;_doneTitle=Back&amp;&amp;d#01806480a1ea7b6e"><em>Test_main.c</em></a></h4>

<p>Bloves posted a patch updating <em>test_main.c</em>. Unfortunately, it turns
out that this file is obsolete and needs removal.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/172d1adda7469e0d/95945ab76a0f38bf?_done=%2Fgroup%2Fperl.perl6.internals%2Fthreads%3Fstart%3D0%26order%3Drecent%26&amp;_doneTitle=Back&amp;&amp;d#95945ab76a0f38bf">MinGW
Support</a></h4>

<p>Fran&ccedil;ois Perrad provided a patch to improve MinGW support. Leo
applied it.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/7684b8c1d7e68372/ae4a0d585dd4dc48?_done=%2Fgroup%2Fperl.perl6.internals%2Fthreads%3Fstart%3D0%26order%3Drecent%26&amp;_doneTitle=Back&amp;&amp;d#ae4a0d585dd4dc48">Compile
Problems</a></h4>

<p>Will Coleda has a failing fresh build. Warnock applies.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/ab24fcf236379e61/438778ca1f18c3df?_done=%2Fgroup%2Fperl.perl6.internals%2Fthreads%3Fstart%3D0%26order%3Drecent%26&amp;_doneTitle=Back&amp;&amp;d#438778ca1f18c3df">NCI
Improvements</a></h4>

<p>Bernhard Schmalhofer provided a patch improving NCI stuff. Leo applied
it.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/dd3cb5e94f1eb835/74b248bf61c2f1f6?_done=%2Fgroup%2Fperl.perl6.internals%2Fthreads%3Fstart%3D0%26order%3Drecent%26&amp;_doneTitle=Back&amp;&amp;d#74b248bf61c2f1f6">VS.NET
2003</a></h4>

<p>Sriram Krishnan fought through a build on VS.NET 2003. He overcame problems
and even posted a summary. Unfortunately, he posted all of this to the Google
Groups interface, as none of it made it back to the list.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/b21ec6647812dbc0/6a4502bb3d5316a6?_done=%2Fgroup%2Fperl.perl6.internals%2Fthreads%3Fstart%3D0%26order%3Drecent%26&amp;_doneTitle=Back&amp;&amp;d#6a4502bb3d5316a6">Dynclasses
Missing Dependencies</a></h4>

<p>Leo put out a request for fixes to the problem with dynclasses missing
dependencies.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/50e56319b876b08c/7904e9a0baf710a7?_done=%2Fgroup%2Fperl.perl6.internals%2Fthreads%3Fstart%3D0%26order%3Drecent%26&amp;_doneTitle=Back&amp;&amp;d#7904e9a0baf710a7">Generational
GC</a></h4>

<p>Leo has put in the first part of his Generational GC system. It has bugs,
but it is also cool.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/4d41960215df55fc/59fc22020073e94b?_done=%2Fgroup%2Fperl.perl6.internals%2Fthreads%3Fstart%3D0%26order%3Drecent%26&amp;_doneTitle=Back&amp;&amp;d#59fc22020073e94b">Preemptive
Multi-tasking via Continuations</a></h4>

<p>Hugh Arnold wants to use timers and continuations to implement preemptive
multitasking in a single threaded application. He wants to know if Parrot will
support it. I think that the answer is yes.</p>

<h4><a
href=http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/c3549ba4ffce05e7/08173698a160df55?_done=%2Fgroup%2Fperl.perl6.internals%2Fthreads%3Fstart%3D0%26order%Drecent%26&amp;_doneTitle=Back&amp;&amp;d#08173698a160df55">Bound
Methods, Attribute Lookup, and Python</a></h4>

<p>Dan, Leo, and Sam have started to go around about how to implement method
lookup and currying. Best of luck to all.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/87cf2d202be97b9b/e109174d6f56dfc4?_done=%2Fgroup%2Fperl.perl6.internals%2Fthreads%3Fstart%3D0%26order%3Drecent%26&amp;_doneTitle=Back&amp;&amp;d#e109174d6f56dfc4">lib/Make.pm</a></h4>

<p>Matt Diephouse noticed that <em>lib/Make.pm</em> is out of date and
unneeded. He asked for its removal.</p>

<h3>Interacting with the Mailing Lists</h3>

<p>Someone suggested that I add a description of the preferred modality for
interacting with the mailing lists summarized herein. I think this is a good
idea and will add it to the standard footer.</p>

<h3>The Usual Footer</h3>

<p>To post to any of these mailing lists please subscribe by sending email to
<code>perl6-internals-subscribe@perl.org</code>,
<code>perl6-language-subscribe@perl.org</code>, or
<code>perl6-compiler-subscribe@perl.org</code>. If you find these summaries
useful or enjoyable, please consider contributing to the Perl Foundation to
help support the development of Perl. You might also like to send feedback to
<a href="mailto:ubermatt@gmail.com">ubermatt@gmail.com</a>.</p>

<ul>

<li><a href="http://donate.perl-foundation.org/">The Perl Foundation</a></li>
<li><a href="http://dev.perl.org/perl6/">Perl 6 Development site</a></li>
<li><a href="http://planet.parrotcode.org/">Parrot Blog aggregator</a></li>

</ul>




        </div>



    </div>
    <div class="asset-footer"></div>
</div>


                            
                            <div id="entry-722" class="entry-asset asset hentry">
    <div class="asset-header">
        <h2 class="asset-name entry-title"><a href="/pub/2005/02/03/rpc_design.html" rel="bookmark">Throwing Shapes</a></h2>
        <div class="asset-meta">
            <span class="byline">
    
                By <span class="vcard author">Vladi Belperchinov-Shabanski</span> on <abbr class="published" title="2005-02-03T00:00:00-08:00">February  3, 2005 12:00 AM</abbr>
    
            </span>

            
            

        </div>
    </div>
    <div class="asset-content entry-content">

        <div class="asset-body">
            
<!-- sidebar begins -->
<!-- don't move sidebars-->
<!-- sidebar ends -->
<br clear="all">

<p>Sometimes data processing is better when separated into different processes that may run on the same machine or even on different ones. This is the
well-known client-server technique. You can do it using a known protocol (such
as http) or by developing your own, specific protocol. This approach needs
implementation for constructor and parser procedures for each packet type
(request and response).  It's possible for different packets to have the same
structure so the constructor and parser will be always the same. Perhaps the
simplest solution is to have key/value pairs packed with newline characters or
with other separators inside a text block. Binary form with length encoding is
another solution.</p>

<p>In an attempt to simplify this client-server interaction, the <em>Remote
Procedure Call</em> (RPC) technique appeared. It tries to map functions inside
the client code to their counterparts inside the server. RPC hides all the
details between a client function call and the server function's response. This
includes argument serialization (to make data appropriate to transfer over the
net, also known as marshaling), transport, the server function call, and
returning response data back to the client (also serialized). In some
implementations, RPC also tries to remove requirements for the client and the
server to run on the same operating system or hardware, or to be written in the
same programming language.</p>

<p>In the Perl world there are several modules that offer different kinds of RPC,
including <a href="http://search.cpan.org/perldoc?RPC::Simple">RPC::Simple</a>,
<a href="http://search.cpan.org/perldoc?RPC::XML">RPC::XML</a>, <a
href="http://search.cpan.org/perldoc?DCE::RPC">DCE::RPC</a>, and more.</p>

<p>In this article I'll explain how to use Perl-specific features to develop a
compact RPC implementation that I will name <em>Perl-centric Remote Call</em>
(PerlRC). As the name suggests, it will run only with Perl clients and
servers.</p>

<h3>Shape</h3>

<p>PerlRC needs to simulate a function call environment that seems familiar to
the client. This requires handling the four key properties of a function
call:</p>

<ul>

<li>Function name</li>
<li>Function arguments</li>
<li>Calling context</li>
<li>Return data</li>

</ul>

<p>The design of the Perl language allows generic argument handling, which means
that it is possible to handle arguments without knowing them before the
function call. There are also ways to discover the calling context. Finally,
the caller can handle results in the same way as the called function's
arguments -- generically, without knowing their details until the function call
returns.</p>

<p>With this in mind, the PerlRC code must follow these steps:</p>

<ul>

<li><p><em>Creating Transport Containers</em></p>

<p>Essentially these are the request and response packets.  I'll use hashes for
both. Each one will be serialized to a scalar which the code will send to the
other side with a trailing newline terminator.</p>

<p>A request container resembles:</p>

<pre><code># request hash
  $req1 = {
            'ARGS' =&gt; [          # arguments list
                        2,
                        8
                      ],
            'NAME' =&gt; 'power',   # remote function name
            'WANTARRAY' =&gt; 0     # calling context
          };

  # result hash for scalar context
  $res1 = {
            'RET_SCALAR' =&gt; 256  # result scalar
          };

  # result hash for array context
  $res2 = {
            'RET_ARRAY' =&gt; [     # result array
                             12,
                             13,
                             14,
                             15,
                             16,
                             17,
                             18,
                           ]
          };

  # result hash for error
  $res3 = {
            # error description
            'ERROR' =&gt; 'No such function: test'
          };</code></pre></li>

<!-- sidebar begins -->
 <csperl file="grab" domain="on" record="b/390" template="b/article_sidebar.view">
<!-- sidebar ends -->

<li><p><em>Arguments</em></p>

<p>To keep things simple, the first argument will represent the remote function
name to call.  This server must remove this argument from the list before
passing on the rest to the remote function.  The request container holds the
name for the remote function and a separate reference to the argument
list.</p></li>

<li><p><em>Calling Context Discovery</em></p>

<p>Find the calling context with the built-in <code>wantarray</code> function
and put this value (0 for scalar and 1 for array context) in the request
hash.</p></li>

<li><p><em>Transfer Both to the Server</em></p>

<p>Serialize the request to scalar and escape newline chars with
<code>\n</code>.  Append the newline terminator and send it to the
server.</p></li>

<li><p><em>Unpack Request Data</em></p>

<p>The server takes the request scalar, removes the trailing newline
terminator, and unpacks the request data into a local hash that contains the
function name, the calling context, and the argument list.</p></li>

<li><p><em>Server-side Function Call</em></p>

<p>Find and call the required function in appropriate context. Take the result
data or the error. Create a result container with separate fields for scalar
and array contexts and one field for any error.</p></li>

<li><p><em>Pack Result Data</em></p>

<p>Serialize the result hash, escape newlines, append a terminating newline,
and send the result data to the client.</p></li>

<li><p><em>Client Unpack of the Result Data</em></p>

<p>When the client receives the result container, remove the trailing newline
char. Unescape any newline chars and unpack the data into a local result hash.
Depending on the calling context, return to the caller either the scalar or
array field from the result hash or die with an error description if such
exists.</p></li>

</ul>

<p>The implementation uses two modules:</p>

<ul>

<li><a href="http://search.cpan.org/perldoc?Storable"><code>Storable</code></a>
handles the serialization of arbitrary data. Serializing data converts it to a
string of characters suitable for saving or sending across the network and
unserializable later into the form of the original.  The rest of the article
will also refer to this process as packing and unpacking the data.</li>

<li><a
href="http://search.cpan.org/perldoc?IO::Socket::INET">IO::Socket::INET</a>
handles the creation of Internet domain sockets.</li>

</ul>

<p>Both modules are standard in the latest Perl distribution packages.</p>

<p>It is possible to use any serialization module including FreezeThaw,
XML::Dumper, or even Data::Dumper + <code>eval()</code> instead of
Storable.</p>













<h3>Point of No Return</h3>

<p>Enough background.  Here's the PerlRC implementation of the server:</p>

<pre><code>  use Storable qw( thaw nfreeze );
  use IO::Socket::INET;
  
  # function table, maps caller names to actual server subs
  our %FUNC_MAP = (
                  power =&gt; \&amp;power,
                  range =&gt; \&amp;range,
                  tree  =&gt; \&amp;tree,
                  );                                
  
  # create listen socket
  my $sr = IO::Socket::INET-&gt;new( Listen    =&gt; 5,
                                  LocalAddr =&gt; 'localhost:9999',
                                  ReuseAddr =&gt; 1 );
  
  while(4)
    {
    # awaiting connection
    my $cl = $sr-&gt;accept() or next; # accept new connection or loop on error
  
    while( my $req = &lt;$cl&gt; ) # read request data, exit loop on empty request
      {
      chomp( $req );
      my $thaw = thaw( r_unescape( $req ) ); # 'unpack' request data (\n unescape)
      my %req = %{ $thaw || {} };            # copy to local hash
      
      my %res;                                # result data
      my $func = $FUNC_MAP{ $req{ 'NAME' } }; # find required function
      if( ! $func ) # check if function exists
        {
        # function name is not found, return error
        $res{ 'ERROR' } = "No such function: " . $req{ 'NAME' };
        }
      else
        {
        # function exists, proceed with execution
        my @args = @{ $req{ 'ARGS' } }; # copy to local arguments hash
        if( $req{ 'WANTARRAY' } )       # depending on the required context...
          {
          my @ret = &amp;$func( @args );    # call function in array context
          $res{ 'RET_ARRAY' } = \@ret;  # return array
          }
        else
          {
          my $ret = &amp;$func( @args );    # call function in scalar context
          $res{ 'RET_SCALAR' } = $ret;  # return scalar
          }  
        }
      
      my $res = r_escape( nfreeze( \%res ) ); # 'pack' result data (\n escape)
      print $cl "$res\n";                     # send result data to the client
      }
    }</code></pre>

<p>The client side is also simple:</p>

<pre><code>  use Storable qw( thaw nfreeze );
  use IO::Socket::INET;
  
  # connect to the server
  my $cl = IO::Socket::INET-&gt;new(  PeerAddr =&gt; "localhost:9999" ) 
       or die "connect error\n";
  
  # this is interface sub to calling server
  sub r_call
  {
    my %req; # request data
    
    $req{ 'NAME' }      = shift;             # function name to call
    $req{ 'WANTARRAY' } = wantarray ? 1 : 0; # context hint
    $req{ 'ARGS' }      = \@_;               # arguments
    
    my $req = r_escape( nfreeze( \%req ) );  # 'pack' request data (\n escape)
    print $cl "$req\n";                      # send to the server
    my $res = &lt;$cl&gt;;                         # get result line
    chomp( $res );
      
    my $thaw = thaw( r_unescape( $res ) );   # 'unpack' result (\n unescape)
    my %res = %{ $thaw || {} };              # copy result data to local hash
    
    # server error -- break execution!
    die "r_call: server error: $res{'ERROR'}\n" if $res{ 'ERROR' };
    
    # finally return result in the required context
    return wantarray ? @{ $res{ 'RET_ARRAY' } } : $res{ 'RET_SCALAR' };
  }</code></pre>

<p>On both sides there are two very simple functions that escape and unescape
newline chars.  This is necessary to prevent serialized data that contains
newline chars from breaking the chosen packet terminator.  (A newline works
well there because it interacts well with the <code>readline()</code> operation
on the socket.)</p>

<pre><code>  sub r_escape
  {
    my $s = shift;
    # replace all newlines, CR and % with CGI-style encoded sequences
    $s =~ s/([%\r\n])/sprintf("%%%02X", ord($1))/ge;
    return $s;
  }
  
  sub r_unescape
  {
    my $s = shift;
    # convert back escapes to the original chars
    $s =~ s/%([0-9A-Fa-f]{2})/chr(hex($1))/ge;
    return $s;
  }</code></pre>


<h3>Waiting In The Wings</h3>

<p>That's the client and server.  Now they need to do something useful.  Here's
some code to run on the server from a client:</p>

<pre><code>  =head2 power()
   
   arguments: a number (n) and power (p)
     returns: the number powered (n**p)
     
  =cut
  
  sub power
  {
    my $n = shift;
    my $p = shift;
    return $n**$p;
  }
  
  =head2 range( f, t )
   
   arguments: lower (f) and upper indexes (t)
     returns: array with number elements between the lower and upper indexes
              ( f .. t )
  =cut         
  
  sub range
  {
    my $f = shift;
    my $t = shift;
    return $f .. $t;
  }
  
  =head2 tree()
   
   arguments: none
     returns: in scalar context: hash reference to data tree
              in array  context: hash (array) of data tree
       usage:
              $data = tree(); $data-&gt;{ ... }
              %data = tree(); $data{ ... }
  =cut
  
  sub tree
  {
    my $ret = {
              this =&gt; 'is test',
              nothing =&gt; [ qw( ever goes as planned ) ],
              number_is =&gt; 42,
              };
    return wantarray ? %$ret : $ret;
  }</code></pre>

<p>To make these available to clients, the server must have a map of functions.
It's easy:</p>

<pre><code>  # function table, maps caller names to actual server subs
  our %FUNC_MAP = (
                  power =&gt; \&amp;power,
                  range =&gt; \&amp;range,
                  tree  =&gt; \&amp;tree,
                  );</code></pre>

<p>That's all of the setup for the server.  Now you can start it.</p>

<p>The client side calls functions in this way:</p>

<pre><code>  r_call( 'test',  1, 2, 3, 'opa' );  # this will receive 'not found' error
  my $r = r_call( 'power',  2,  8 );  # $r = 256
  my @a = r_call( 'range', 12, 18 );  # @a = ( 12, 13, 14, 15, 16, 17, 18 )
  my %t = r_call( 'tree' );           # returns data as hash
  my $t = r_call( 'tree' );           # returns data as reference
  
  print( "Tree is:\n" . Dumper( \%t ) );
  # this will print:

  Tree is:
  $VAR1 = {
            'number_is' =&gt; 42,
            'nothing' =&gt; [
                           'ever',
                           'goes',
                           'as',
                           'planned'
                         ],
            'this' =&gt; 'is test'
          };
  
  # and will be the same as 
  print( "Tree is:\n" . Dumper( $t ) );</code></pre>
  












<h3>One Wish</h3>

<p>At this point everything works, but as usual, someone will want another
feature.  Suppose that the server and the client sides each had one wish.</p>

<p>The server side wish may be to have a built-in facility to find callable
functions so as to build the function map can be built automatically.</p>

<p>Automatic map discovery has one major flaw which is that all functions in
the current package are available to the client. This may not be always
desirable. There are simple solutions to the problem.  For example, all
functions that need external visibility within a package could have a specific
name prefix.  A map discovery procedure can filter the list of all functions
with this prefix and map those externally under the original names (without the
prefix).</p>

<p>The following code finds all defined functions in the current namespace (the
one that called <code>r_map_discover()</code>) and returns a hash with
function-name keys and function-code-reference values:</p>

<pre><code>  sub r_map_discover
  {
    my ( $package ) = caller(); # get the package name of the caller
    my $prefix = shift;         # optional prefix
    my %map;

    # disable check for symbolic references
    no strict 'refs';

    # loop over all entries in the caller package's namespace
    while( my ( $k, $v ) = each %{ $package . '::' } ) 
      {
      my $sym = $package . '::' . $k; # construct the full name of each symbol
      next unless $k =~ s/^$prefix//; # allow only entries starting with prefix
      my $r = *{ $sym }{ 'CODE' };    # take reference to the CODE in the glob
      next unless $r;  # reference is empty, no code under this name, skip
      $map{ $k } = $r; # reference points to CODE, assign it to the map
      }
    return %map;
  }</code></pre>

<p>To make the use automatic discovery instead of a static function map,
write:</p>

<pre><code>  # function table, maps caller names to actual server subs, initially empty
  our %FUNC_MAP;

  # run the automatic discovery function
  %FUNC_MAP = r_map_discover();</code></pre>

<p>Now <code>%FUNC_MAP</code> has all of the externally-visible functions in
the current package (namespace).  That means it's time to modify the names in
the module to work with automatic discovery.  Suppose the prefix is
<code>x_</code>:</p>

<pre><code>  sub x_power
  {
    ...
  }
  
  sub x_range
  {
    ...
  }</code></pre>

<p>The server will discover only those functions:</p>

<pre><code>%FUNC_MAP = r_map_discover( 'x_' );</code></pre>

<p>and the client will continue to call functions under their usual names:</p>

<pre><code>  my $r = r_call( 'power',  2,  8 );  # $r = 256
  my @a = r_call( 'range', 12, 18 );  # @a = ( 12, 13, 14, 15, 16, 17, 18 )</code></pre>

<p>That's it for the server's wish.  Now it's time to grant the client's
wish.</p>

<p>Call remote functions transparently might be most important client wish,
avoiding the use of <code>r_call()</code>.</p>

<p>Perl allows the creation of anonymous function references. It's also
possible to install that reference in a namespace under a real name.  The
result is a function created at run-time.  If the function definition takes
place in a specific lexical context, it will still have access to that context
even when called later from outside that context.  Those functions are closures
and they are one way to avoid using <code>r_call()</code>:</p>

<pre><code>  sub r_define_subs
  {
    my ( $package ) = caller(); # get the package name of the caller
    for my $fn ( @_ )           # loop over the specified function names
      {
      my $sym = $package . '::' . $fn;    # construct the full symbol name
      no strict;                          # turn off symbolic refs check
      *$sym = sub { r_call( $fn, @_ ); }; # construct and tie the closure
      use strict;                         # turn the check back on
      }
  }
  
  # define/import 'range' and 'tree' functions in the current package
  r_define_subs( 'range', 'tree' );
  
  # now call them as they are normal functions
  my @a = range( 12, 18 );      # @a = ( 12 .. 18 )
  my %t = tree();               # returns data as reference</code></pre>

<p>This approach hides the use of <code>r_call()</code> to only one place which
the client doesn't see. Wish granted.</p>

<h3>Limits</h3>

<p>The biggest limitations of PerlRC relate to serialization.</p>

<p>First of all, both the client and server must have compatible serialization
modules or versions. This is crucial! To avoid problems here, either you'll
have to write your own serialization code or perform some kind of version
check.  If you perform this check, be sure to do it before sending a request
and response, in plain text, without using serialization at all.</p>

<p>Another problem is in what data you can serialize in the argument or result
containers.  Holding references there to something outside the same container
may pull in more data than you want, if your serialization follows references,
or it may not pull in enough data if your serialization process is very simple.
Also there is no way to serialize file handles, compiled code, or objects
(which are not in the same container really). In some cases, serializing code
and objects may be possible if the serialization modules supports such features
(as do Storable and FreezeThaw), if you have the required class modules on both
sides, and if you trust code on either side.</p>

<p>The documentation of the serialization modules explain further limitations
and workarounds for both approaches.</p>

<h3>Conclusion</h3>

<p>There is a bit more work to do on PerlRC before using it in production, but
if you need simple RPC or you need to tweak the way RPC deals with data
or communication, you may have good experiences writing your own implementation
instead fitting your application around readymade modules. I hope this text
is a good starting point.</p>



        </div>



    </div>
    <div class="asset-footer"></div>
</div>




                            <div class="content-nav">
                                <a href="/pub/2005/01/">&laquo; January 2005</a> |
                                <a href="/pub/">Main Index</a> |
                                <a href="/pub/archives.html">Archives</a>
                                | <a href="/pub/2005/03/">March 2005 &raquo;</a>
                            </div>


                        </div>
                    </div>


                    <div id="beta">
    <div id="beta-inner">


    
    <div class="widget-what-is-perl widget">
    <div class="widget-content widget-content-what-is-perl">
       Visit the home of the  Perl programming language: <a href="http://www.perl.org/">Perl.org</a
    </div>
</div>
<div class="widget-find-out-more widget-archives widget">
    <div class="widget-content">
        <ul>
            <li><a href="http://www.perl.org/get.html">Download</a></li>
            <li><a href="http://perldoc.perl.org/">Documentation</a></li>
            <li><a href="http://blogs.perl.org/">Perl Bloggers</a></li>
            <li><a href="http://news.perlfoundation.org/">Foundation News</a></li>
        </ul>
    </div>
</div><div class="widget-tcpc widget">
<h3 class="widget-header">Sponsored by</h3>
    <div class="widget-content">
        <a href="http://training.perl.com/" alt="Perl Training" target="_blank"><img src="/i/tcpc.png" width="150" height="50"></a>
    </div>
</div>

<div class="widget-syndication widget">
    <div class="widget-content">
        <ul>
            <li><img src="/mt-static/images/status_icons/feed.gif" alt="Subscribe to feed" width="9" height="9" /> <a href="/pub/atom.xml">Subscribe to this website's feed</a></li>

        </ul>
    </div>
</div>
<div class="widget-archive-monthly widget-archive widget">
    <h3 class="widget-header">Monthly <a href="/pub/archives.html">Archives</a></h3>
    <div class="widget-content">
        <ul>
        
            <li><a href="/pub/2014/02/">February 2014 (1)</a></li>
        
    
        
            <li><a href="/pub/2014/01/">January 2014 (1)</a></li>
        
    
        
            <li><a href="/pub/2013/10/">October 2013 (1)</a></li>
        
    
        
            <li><a href="/pub/2013/01/">January 2013 (1)</a></li>
        
    
        
            <li><a href="/pub/2012/12/">December 2012 (1)</a></li>
        
    
        
            <li><a href="/pub/2012/11/">November 2012 (1)</a></li>
        
    
        
            <li><a href="/pub/2012/10/">October 2012 (2)</a></li>
        
    
        
            <li><a href="/pub/2012/08/">August 2012 (2)</a></li>
        
    
        
            <li><a href="/pub/2012/06/">June 2012 (11)</a></li>
        
    
        
            <li><a href="/pub/2012/05/">May 2012 (18)</a></li>
        
    
        
            <li><a href="/pub/2012/04/">April 2012 (17)</a></li>
        
    
        
            <li><a href="/pub/2012/02/">February 2012 (1)</a></li>
        
    
        
            <li><a href="/pub/2011/12/">December 2011 (1)</a></li>
        
    
        
            <li><a href="/pub/2011/09/">September 2011 (1)</a></li>
        
    
        
            <li><a href="/pub/2011/08/">August 2011 (2)</a></li>
        
    
        
            <li><a href="/pub/2011/06/">June 2011 (1)</a></li>
        
    
        
            <li><a href="/pub/2011/05/">May 2011 (3)</a></li>
        
    
        
            <li><a href="/pub/2011/04/">April 2011 (1)</a></li>
        
    
        
            <li><a href="/pub/2011/03/">March 2011 (1)</a></li>
        
    
        
            <li><a href="/pub/2011/02/">February 2011 (1)</a></li>
        
    
        
            <li><a href="/pub/2011/01/">January 2011 (1)</a></li>
        
    
        
            <li><a href="/pub/2010/11/">November 2010 (1)</a></li>
        
    
        
            <li><a href="/pub/2010/10/">October 2010 (2)</a></li>
        
    
        
            <li><a href="/pub/2010/09/">September 2010 (1)</a></li>
        
    
        
            <li><a href="/pub/2010/08/">August 2010 (3)</a></li>
        
    
        
            <li><a href="/pub/2010/07/">July 2010 (2)</a></li>
        
    
        
            <li><a href="/pub/2010/04/">April 2010 (2)</a></li>
        
    
        
            <li><a href="/pub/2010/03/">March 2010 (4)</a></li>
        
    
        
            <li><a href="/pub/2008/05/">May 2008 (1)</a></li>
        
    
        
            <li><a href="/pub/2008/04/">April 2008 (2)</a></li>
        
    
        
            <li><a href="/pub/2008/03/">March 2008 (1)</a></li>
        
    
        
            <li><a href="/pub/2008/02/">February 2008 (1)</a></li>
        
    
        
            <li><a href="/pub/2008/01/">January 2008 (1)</a></li>
        
    
        
            <li><a href="/pub/2007/12/">December 2007 (2)</a></li>
        
    
        
            <li><a href="/pub/2007/09/">September 2007 (1)</a></li>
        
    
        
            <li><a href="/pub/2007/08/">August 2007 (1)</a></li>
        
    
        
            <li><a href="/pub/2007/07/">July 2007 (1)</a></li>
        
    
        
            <li><a href="/pub/2007/06/">June 2007 (1)</a></li>
        
    
        
            <li><a href="/pub/2007/05/">May 2007 (1)</a></li>
        
    
        
            <li><a href="/pub/2007/04/">April 2007 (1)</a></li>
        
    
        
            <li><a href="/pub/2007/03/">March 2007 (1)</a></li>
        
    
        
            <li><a href="/pub/2007/02/">February 2007 (1)</a></li>
        
    
        
            <li><a href="/pub/2007/01/">January 2007 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/12/">December 2006 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/11/">November 2006 (2)</a></li>
        
    
        
            <li><a href="/pub/2006/10/">October 2006 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/09/">September 2006 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/08/">August 2006 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/07/">July 2006 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/06/">June 2006 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/05/">May 2006 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/04/">April 2006 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/03/">March 2006 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/02/">February 2006 (4)</a></li>
        
    
        
            <li><a href="/pub/2006/01/">January 2006 (4)</a></li>
        
    
        
            <li><a href="/pub/2005/12/">December 2005 (4)</a></li>
        
    
        
            <li><a href="/pub/2005/11/">November 2005 (3)</a></li>
        
    
        
            <li><a href="/pub/2005/10/">October 2005 (2)</a></li>
        
    
        
            <li><a href="/pub/2005/09/">September 2005 (2)</a></li>
        
    
        
            <li><a href="/pub/2005/08/">August 2005 (9)</a></li>
        
    
        
            <li><a href="/pub/2005/07/">July 2005 (8)</a></li>
        
    
        
            <li><a href="/pub/2005/06/">June 2005 (9)</a></li>
        
    
        
            <li><a href="/pub/2005/05/">May 2005 (8)</a></li>
        
    
        
            <li><a href="/pub/2005/04/">April 2005 (7)</a></li>
        
    
        
            <li><a href="/pub/2005/03/">March 2005 (6)</a></li>
        
    
        
            <li><a href="/pub/2005/02/">February 2005 (7)</a></li>
        
    
        
            <li><a href="/pub/2005/01/">January 2005 (6)</a></li>
        
    
        
            <li><a href="/pub/2004/12/">December 2004 (8)</a></li>
        
    
        
            <li><a href="/pub/2004/11/">November 2004 (8)</a></li>
        
    
        
            <li><a href="/pub/2004/10/">October 2004 (5)</a></li>
        
    
        
            <li><a href="/pub/2004/09/">September 2004 (9)</a></li>
        
    
        
            <li><a href="/pub/2004/08/">August 2004 (6)</a></li>
        
    
        
            <li><a href="/pub/2004/07/">July 2004 (8)</a></li>
        
    
        
            <li><a href="/pub/2004/06/">June 2004 (6)</a></li>
        
    
        
            <li><a href="/pub/2004/05/">May 2004 (7)</a></li>
        
    
        
            <li><a href="/pub/2004/04/">April 2004 (8)</a></li>
        
    
        
            <li><a href="/pub/2004/03/">March 2004 (8)</a></li>
        
    
        
            <li><a href="/pub/2004/02/">February 2004 (9)</a></li>
        
    
        
            <li><a href="/pub/2004/01/">January 2004 (7)</a></li>
        
    
        
            <li><a href="/pub/2003/12/">December 2003 (4)</a></li>
        
    
        
            <li><a href="/pub/2003/11/">November 2003 (7)</a></li>
        
    
        
            <li><a href="/pub/2003/10/">October 2003 (8)</a></li>
        
    
        
            <li><a href="/pub/2003/09/">September 2003 (6)</a></li>
        
    
        
            <li><a href="/pub/2003/08/">August 2003 (7)</a></li>
        
    
        
            <li><a href="/pub/2003/07/">July 2003 (9)</a></li>
        
    
        
            <li><a href="/pub/2003/06/">June 2003 (9)</a></li>
        
    
        
            <li><a href="/pub/2003/05/">May 2003 (8)</a></li>
        
    
        
            <li><a href="/pub/2003/04/">April 2003 (8)</a></li>
        
    
        
            <li><a href="/pub/2003/03/">March 2003 (10)</a></li>
        
    
        
            <li><a href="/pub/2003/02/">February 2003 (8)</a></li>
        
    
        
            <li><a href="/pub/2003/01/">January 2003 (8)</a></li>
        
    
        
            <li><a href="/pub/2002/12/">December 2002 (5)</a></li>
        
    
        
            <li><a href="/pub/2002/11/">November 2002 (9)</a></li>
        
    
        
            <li><a href="/pub/2002/10/">October 2002 (7)</a></li>
        
    
        
            <li><a href="/pub/2002/09/">September 2002 (11)</a></li>
        
    
        
            <li><a href="/pub/2002/08/">August 2002 (8)</a></li>
        
    
        
            <li><a href="/pub/2002/07/">July 2002 (8)</a></li>
        
    
        
            <li><a href="/pub/2002/06/">June 2002 (4)</a></li>
        
    
        
            <li><a href="/pub/2002/05/">May 2002 (6)</a></li>
        
    
        
            <li><a href="/pub/2002/04/">April 2002 (6)</a></li>
        
    
        
            <li><a href="/pub/2002/03/">March 2002 (7)</a></li>
        
    
        
            <li><a href="/pub/2002/02/">February 2002 (5)</a></li>
        
    
        
            <li><a href="/pub/2002/01/">January 2002 (8)</a></li>
        
    
        
            <li><a href="/pub/2001/12/">December 2001 (7)</a></li>
        
    
        
            <li><a href="/pub/2001/11/">November 2001 (5)</a></li>
        
    
        
            <li><a href="/pub/2001/10/">October 2001 (9)</a></li>
        
    
        
            <li><a href="/pub/2001/09/">September 2001 (7)</a></li>
        
    
        
            <li><a href="/pub/2001/08/">August 2001 (13)</a></li>
        
    
        
            <li><a href="/pub/2001/07/">July 2001 (8)</a></li>
        
    
        
            <li><a href="/pub/2001/06/">June 2001 (13)</a></li>
        
    
        
            <li><a href="/pub/2001/05/">May 2001 (11)</a></li>
        
    
        
            <li><a href="/pub/2001/04/">April 2001 (9)</a></li>
        
    
        
            <li><a href="/pub/2001/03/">March 2001 (8)</a></li>
        
    
        
            <li><a href="/pub/2001/02/">February 2001 (8)</a></li>
        
    
        
            <li><a href="/pub/2001/01/">January 2001 (8)</a></li>
        
    
        
            <li><a href="/pub/2000/12/">December 2000 (6)</a></li>
        
    
        
            <li><a href="/pub/2000/11/">November 2000 (10)</a></li>
        
    
        
            <li><a href="/pub/2000/10/">October 2000 (10)</a></li>
        
    
        
            <li><a href="/pub/2000/09/">September 2000 (2)</a></li>
        
    
        
            <li><a href="/pub/2000/08/">August 2000 (2)</a></li>
        
    
        
            <li><a href="/pub/2000/07/">July 2000 (5)</a></li>
        
    
        
            <li><a href="/pub/2000/06/">June 2000 (7)</a></li>
        
    
        
            <li><a href="/pub/2000/05/">May 2000 (7)</a></li>
        
    
        
            <li><a href="/pub/2000/04/">April 2000 (3)</a></li>
        
    
        
            <li><a href="/pub/2000/03/">March 2000 (2)</a></li>
        
    
        
            <li><a href="/pub/2000/02/">February 2000 (2)</a></li>
        
    
        
            <li><a href="/pub/2000/01/">January 2000 (2)</a></li>
        
    
        
            <li><a href="/pub/1999/12/">December 1999 (6)</a></li>
        
    
        
            <li><a href="/pub/1999/11/">November 1999 (6)</a></li>
        
    
        
            <li><a href="/pub/1999/10/">October 1999 (5)</a></li>
        
    
        
            <li><a href="/pub/1999/09/">September 1999 (4)</a></li>
        
    
        
            <li><a href="/pub/1999/08/">August 1999 (3)</a></li>
        
    
        
            <li><a href="/pub/1999/07/">July 1999 (2)</a></li>
        
    
        
            <li><a href="/pub/1999/06/">June 1999 (3)</a></li>
        
    
        
            <li><a href="/pub/1999/04/">April 1999 (1)</a></li>
        
    
        
            <li><a href="/pub/1999/03/">March 1999 (1)</a></li>
        
    
        
            <li><a href="/pub/1999/01/">January 1999 (1)</a></li>
        
    
        
            <li><a href="/pub/1998/12/">December 1998 (1)</a></li>
        
    
        
            <li><a href="/pub/1998/11/">November 1998 (1)</a></li>
        
    
        
            <li><a href="/pub/1998/07/">July 1998 (2)</a></li>
        
    
        
            <li><a href="/pub/1998/06/">June 1998 (1)</a></li>
        
    
        
            <li><a href="/pub/1998/03/">March 1998 (1)</a></li>
        
        </ul>
    </div>
</div>
        
    

<div class="widget-powered widget">
    <div class="widget-content">
        <a href="http://www.movabletype.com/"><img src="/mt-static/images/bug-pbmt-white.png" alt="Powered by Movable Type 5.13-en" width="120" height="75" /></a>
    </div>
</div>



    </div>
</div>






                </div>
            </div>


            <div id="footer">
    <div id="footer-inner">
        <div id="footer-content">
            <div class="widget-powered widget">
                <div class="widget-content">
                    Powered by <a href="http://www.movabletype.com/" rel="generator">Movable Type Pro</a>
                </div>
            </div>

            <div class="widget-creative-commons widget">
                <div class="widget-content">
                    This blog is licensed under a <a href="http://creativecommons.org/licenses/by-nc-nd/3.0/">Creative Commons License</a>.
                </div>
            </div>

        </div>
    </div>
</div>



        </div>
    </div>
</body>
</html>
